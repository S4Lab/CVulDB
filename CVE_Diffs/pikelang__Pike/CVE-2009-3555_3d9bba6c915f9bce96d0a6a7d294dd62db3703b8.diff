pikelang__Pike
commit 3d9bba6c915f9bce96d0a6a7d294dd62db3703b8
Author:     Martin Stjernholm <mast@lysator.liu.se>
AuthorDate: Mon Nov 16 15:13:20 2009 +0100
Commit:     Martin Stjernholm <mast@lysator.liu.se>
CommitDate: Mon Nov 16 15:13:20 2009 +0100

    Disabled renegotiation, to address the ssl/tls renegotiate MITM attack.
    
    See http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555.
    
    Secure renegotiation according to the tls extension remains to be
    implemented (the spec is still a draft at the time of this writing). Note
    that renegotiation often didn't work anyway due to a bug, so this change
    might not be much of a compatibility issue anyway.
    
    Rev: lib/modules/SSL.pmod/connection.pike:1.19
    Rev: lib/modules/SSL.pmod/constants.pike:1.9

diff --git a/lib/modules/SSL.pmod/connection.pike b/lib/modules/SSL.pmod/connection.pike
index a45fa9322c..62a65ef718 100644
--- a/lib/modules/SSL.pmod/connection.pike
+++ b/lib/modules/SSL.pmod/connection.pike
@@ -1,4 +1,4 @@
-/* $Id: connection.pike,v 1.18 2001/08/25 18:26:44 noy Exp $
+/* $Id: connection.pike,v 1.19 2009/11/16 14:13:20 mast Exp $
  *
  * SSL packet layer
  */
@@ -297,9 +297,24 @@ string|int got_data(string|int s)
        }
       case PACKET_handshake:
        {
+	 if (handshake_finished) {
+	   // Don't allow renegotiation at all for now, to address
+	   // http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555.
+	   send_packet (Alert (ALERT_warning, ALERT_no_renegotiation,
+			       version[1]));
+	   return -1;
+	 }
 	 if (expect_change_cipher)
 	 {
 	   /* No change_cipher message was recieved */
+	   // FIXME: There's a bug somewhere since expect_change_cipher often
+	   // remains set after the handshake is completed. The effect is that
+	   // renegotiation doesn't work all the time.
+	   //
+	   // A side effect is that we are partly invulnerable to the
+	   // renegotiation vulnerability mentioned above. It is however not
+	   // safe to assume that, since there might be routes past this,
+	   // maybe through the use of a version 2 hello message below.
 	   send_packet(Alert(ALERT_fatal, ALERT_unexpected_message,version[1]));
 	   return -1;
 	 }
@@ -334,6 +349,13 @@ string|int got_data(string|int s)
 	break;
       case PACKET_V2:
        {
+	 if (handshake_finished) {
+	   // Don't allow renegotiation at all for now, to address
+	   // http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555.
+	   send_packet (Alert (ALERT_warning, ALERT_no_renegotiation,
+			       version[1]));
+	   return -1;
+	 }
 	 mixed err = handle_handshake(HANDSHAKE_hello_v2,
 				      packet->fragment[1 .. ],
 				      packet->fragment);
diff --git a/lib/modules/SSL.pmod/constants.pike b/lib/modules/SSL.pmod/constants.pike
index bafda71090..3c14f95537 100644
--- a/lib/modules/SSL.pmod/constants.pike
+++ b/lib/modules/SSL.pmod/constants.pike
@@ -1,4 +1,4 @@
-/* $Id: constants.pike,v 1.8 2001/04/18 14:30:41 noy Exp $
+/* $Id: constants.pike,v 1.9 2009/11/16 14:13:20 mast Exp $
  *
  */
 
@@ -77,6 +77,7 @@ constant ALERT_certificate_revoked      = 44;
 constant ALERT_certificate_expired      = 45;
 constant ALERT_certificate_unknown      = 46;
 constant ALERT_illegal_parameter        = 47;
+constant ALERT_no_renegotiation         = 100;
 constant ALERT_descriptions = (< ALERT_close_notify,
  				 ALERT_unexpected_message,
  				 ALERT_bad_record_mac,
@@ -88,7 +89,9 @@ constant ALERT_descriptions = (< ALERT_close_notify,
  				 ALERT_certificate_revoked,
  				 ALERT_certificate_expired,
  				 ALERT_certificate_unknown,
- 				 ALERT_illegal_parameter >);
+				 ALERT_illegal_parameter,
+				 ALERT_no_renegotiation,
+			      >);
  			      
 constant CONNECTION_client 	= 0;
 constant CONNECTION_server 	= 1;
