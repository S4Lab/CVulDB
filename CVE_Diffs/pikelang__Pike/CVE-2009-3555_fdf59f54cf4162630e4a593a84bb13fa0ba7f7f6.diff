pikelang__Pike
commit fdf59f54cf4162630e4a593a84bb13fa0ba7f7f6
Author:     Martin Stjernholm <mast@lysator.liu.se>
AuthorDate: Mon Nov 16 15:13:20 2009 +0100
Commit:     Martin Stjernholm <mast@lysator.liu.se>
CommitDate: Mon Nov 16 15:13:20 2009 +0100

    Disabled renegotiation, to address the ssl/tls renegotiate MITM attack.
    
    See http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555.
    
    Secure renegotiation according to the tls extension remains to be
    implemented (the spec is still a draft at the time of this writing). Note
    that renegotiation often didn't work anyway due to a bug, so this change
    might not be much of a compatibility issue anyway.
    
    Rev: lib/modules/SSL.pmod/connection.pike:1.24
    Rev: lib/modules/SSL.pmod/constants.pike:1.11

diff --git a/lib/modules/SSL.pmod/connection.pike b/lib/modules/SSL.pmod/connection.pike
index fd15a1f2ec..9183e14903 100644
--- a/lib/modules/SSL.pmod/connection.pike
+++ b/lib/modules/SSL.pmod/connection.pike
@@ -1,6 +1,6 @@
 #pike __REAL_VERSION__
 
-/* $Id: connection.pike,v 1.23 2005/02/08 20:18:53 mast Exp $
+/* $Id: connection.pike,v 1.24 2009/11/16 14:13:20 mast Exp $
  *
  * SSL packet layer
  */
@@ -330,9 +330,24 @@ string|int got_data(string|int s)
        }
       case PACKET_handshake:
        {
+	 if (handshake_finished) {
+	   // Don't allow renegotiation at all for now, to address
+	   // http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555.
+	   send_packet (Alert (ALERT_warning, ALERT_no_renegotiation,
+			       version[1]));
+	   return -1;
+	 }
 	 if (expect_change_cipher)
 	 {
 	   /* No change_cipher message was received */
+	   // FIXME: There's a bug somewhere since expect_change_cipher often
+	   // remains set after the handshake is completed. The effect is that
+	   // renegotiation doesn't work all the time.
+	   //
+	   // A side effect is that we are partly invulnerable to the
+	   // renegotiation vulnerability mentioned above. It is however not
+	   // safe to assume that, since there might be routes past this,
+	   // maybe through the use of a version 2 hello message below.
 	   send_packet(Alert(ALERT_fatal, ALERT_unexpected_message,
 			     version[1]));
 	   return -1;
@@ -368,6 +383,13 @@ string|int got_data(string|int s)
 	break;
       case PACKET_V2:
        {
+	 if (handshake_finished) {
+	   // Don't allow renegotiation at all for now, to address
+	   // http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555.
+	   send_packet (Alert (ALERT_warning, ALERT_no_renegotiation,
+			       version[1]));
+	   return -1;
+	 }
 	 mixed err = handle_handshake(HANDSHAKE_hello_v2,
 				      packet->fragment[1 .. ],
 				      packet->fragment);
diff --git a/lib/modules/SSL.pmod/constants.pike b/lib/modules/SSL.pmod/constants.pike
index 7a2745d4a4..012d988a15 100644
--- a/lib/modules/SSL.pmod/constants.pike
+++ b/lib/modules/SSL.pmod/constants.pike
@@ -1,6 +1,6 @@
 #pike __REAL_VERSION__
 
-/* $Id: constants.pike,v 1.10 2002/03/20 16:40:01 nilsson Exp $
+/* $Id: constants.pike,v 1.11 2009/11/16 14:13:20 mast Exp $
  *
  */
 
@@ -81,6 +81,7 @@ constant ALERT_certificate_revoked      = 44;
 constant ALERT_certificate_expired      = 45;
 constant ALERT_certificate_unknown      = 46;
 constant ALERT_illegal_parameter        = 47;
+constant ALERT_no_renegotiation         = 100;
 constant ALERT_descriptions = (< ALERT_close_notify,
  				 ALERT_unexpected_message,
  				 ALERT_bad_record_mac,
@@ -92,7 +93,9 @@ constant ALERT_descriptions = (< ALERT_close_notify,
  				 ALERT_certificate_revoked,
  				 ALERT_certificate_expired,
  				 ALERT_certificate_unknown,
- 				 ALERT_illegal_parameter >);
+				 ALERT_illegal_parameter,
+				 ALERT_no_renegotiation,
+			      >);
  			      
 constant CONNECTION_client 	= 0;
 constant CONNECTION_server 	= 1;
