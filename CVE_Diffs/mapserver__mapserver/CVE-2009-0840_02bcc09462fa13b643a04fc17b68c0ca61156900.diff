mapserver__mapserver
commit 02bcc09462fa13b643a04fc17b68c0ca61156900
Author:     Daniel Morissette <dmorissette@mapgears.com>
AuthorDate: Mon Jul 13 21:02:54 2009 +0000
Commit:     Daniel Morissette <dmorissette@mapgears.com>
CommitDate: Mon Jul 13 21:02:54 2009 +0000

    New fix for incomplete CVE-2009-0840 security fix made in 4.10.4 (#2943)
    
    git-svn-id: http://svn.osgeo.org/mapserver/branches/branch-4-10@9175 7532c77e-422f-0410-93f4-f0b67bdd69e2

diff --git a/HISTORY.TXT b/HISTORY.TXT
index a9e850da..b3bcfdc0 100644
--- a/HISTORY.TXT
+++ b/HISTORY.TXT
@@ -10,6 +10,11 @@ the top of the list.)
 For a complete change history, please see the Subversion log comments.
 
 
+Current Version (SVN branch, may never be released):
+----------------------------------------------------
+
+- New fix for incomplete CVE-2009-0840 security fix made in 4.10.4 (#2943)
+
 Version 4.10.4 (2009-03-26)
 ---------------------------
 
diff --git a/cgiutil.c b/cgiutil.c
index ea9d72ae..70b0b697 100644
--- a/cgiutil.c
+++ b/cgiutil.c
@@ -69,7 +69,7 @@ MS_CVSID("$Id$")
 static char *readPostBody( cgiRequestObj *request ) 
 {
     char *data; 
-    unsigned int data_max, data_len;
+    size_t data_max, data_len;
     int chunk_size;
 
     msIO_needBinaryStdin();
@@ -80,7 +80,14 @@ static char *readPostBody( cgiRequestObj *request )
     if( getenv("CONTENT_LENGTH") != NULL )
     {
 
-        data_max = atoi(getenv("CONTENT_LENGTH"));
+        data_max = (size_t) atoi(getenv("CONTENT_LENGTH"));
+        /* Test for suspicious CONTENT_LENGTH (negative value or SIZE_MAX) */
+        if( data_max >= SIZE_MAX ) 
+        {
+            msIO_printf("Content-type: text/html%c%c",10,10);
+            msIO_printf("Suspicious Content-Length.\n");
+            exit( 1 );
+        }
         data = (char *) malloc(data_max+1);
         if( data == NULL )
         {
@@ -102,7 +109,9 @@ static char *readPostBody( cgiRequestObj *request )
 /* -------------------------------------------------------------------- */
 /*      Otherwise read in chunks to the end.                            */
 /* -------------------------------------------------------------------- */
-    data_max = 10000;
+#define DATA_ALLOC_SIZE 10000
+
+    data_max = DATA_ALLOC_SIZE;
     data_len = 0;
     data = (char *) malloc(data_max+1);
 
@@ -113,7 +122,15 @@ static char *readPostBody( cgiRequestObj *request )
 
         if( data_len == data_max )
         {
-            data_max = data_max + 10000;
+            /* Realloc buffer, making sure we check for possible size_t overflow */
+            if ( data_max > SIZE_MAX - (DATA_ALLOC_SIZE+1) ) 
+            {
+                msIO_printf("Content-type: text/html%c%c",10,10);
+                msIO_printf("Possible size_t overflow, cannot reallocate input buffer, POST body too large?\n" );
+                exit(1);
+            }
+
+            data_max = data_max + DATA_ALLOC_SIZE;
             data = (char *) realloc(data, data_max+1);
 
             if( data == NULL )
diff --git a/map.h b/map.h
index 5adc2a87..491adad9 100644
--- a/map.h
+++ b/map.h
@@ -48,6 +48,7 @@
 #include <malloc.h>
 #else
 #include <unistd.h>
+#include <stdint.h>
 #endif
 
 #ifndef DISABLE_CVSID
