mapserver__mapserver
commit 7bb3f56224a55b4769a0d207badc6363aff8b207
Author:     Daniel Morissette <dmorissette@mapgears.com>
AuthorDate: Mon Jul 13 20:34:07 2009 +0000
Commit:     Daniel Morissette <dmorissette@mapgears.com>
CommitDate: Mon Jul 13 20:34:07 2009 +0000

    New fix for incomplete CVE-2009-0840 security fix made in 5.2.2 (#2943)
    
    git-svn-id: http://svn.osgeo.org/mapserver/branches/branch-5-2@9173 7532c77e-422f-0410-93f4-f0b67bdd69e2

diff --git a/HISTORY.TXT b/HISTORY.TXT
index 2a0048f3..e9cdf6d1 100644
--- a/HISTORY.TXT
+++ b/HISTORY.TXT
@@ -12,6 +12,8 @@ For a complete change history, please see the Subversion log comments.
 Current Version:
 ----------------
 
+- New fix for incomplete CVE-2009-0840 security fix made in 5.2.2 (#2943)
+
 - Fixed seg fault if font not found with label ANGLE FOLLOW (#2973)
 
 Version 5.2.2 (2009-03-26):
diff --git a/cgiutil.c b/cgiutil.c
index 2838a067..7bb62f39 100644
--- a/cgiutil.c
+++ b/cgiutil.c
@@ -44,7 +44,7 @@ MS_CVSID("$Id$")
 static char *readPostBody( cgiRequestObj *request ) 
 {
   char *data; 
-  unsigned int data_max, data_len;
+  size_t data_max, data_len;
   int chunk_size;
 
   msIO_needBinaryStdin();
@@ -53,10 +53,11 @@ static char *readPostBody( cgiRequestObj *request )
   /*      If the length is provided, read in one gulp.                    */
   /* -------------------------------------------------------------------- */
   if( getenv("CONTENT_LENGTH") != NULL ) {
-    data_max = (unsigned int) atoi(getenv("CONTENT_LENGTH"));
-    if(data_max <= 0) {
+    data_max = (size_t) atoi(getenv("CONTENT_LENGTH"));
+    /* Test for suspicious CONTENT_LENGTH (negative value or SIZE_MAX) */
+    if( data_max >= SIZE_MAX ) {
       msIO_printf("Content-type: text/html%c%c",10,10);
-      msIO_printf("Content-Length too small.\n");
+      msIO_printf("Suspicious Content-Length.\n");
       exit( 1 );
     }
     data = (char *) malloc(data_max+1);
@@ -79,7 +80,9 @@ static char *readPostBody( cgiRequestObj *request )
   /* -------------------------------------------------------------------- */
   /*      Otherwise read in chunks to the end.                            */
   /* -------------------------------------------------------------------- */
-  data_max = 10000;
+#define DATA_ALLOC_SIZE 10000
+
+  data_max = DATA_ALLOC_SIZE;
   data_len = 0;
   data = (char *) malloc(data_max+1);
 
@@ -87,7 +90,14 @@ static char *readPostBody( cgiRequestObj *request )
     data_len += chunk_size;
 
     if( data_len == data_max ) {
-      data_max = data_max + 10000;
+      /* Realloc buffer, making sure we check for possible size_t overflow */
+        if ( data_max > SIZE_MAX - (DATA_ALLOC_SIZE+1) ) {
+        msIO_printf("Content-type: text/html%c%c",10,10);
+        msIO_printf("Possible size_t overflow, cannot reallocate input buffer, POST body too large?\n" );
+        exit(1);
+      }
+
+      data_max = data_max + DATA_ALLOC_SIZE;
       data = (char *) realloc(data, data_max+1);
 
       if( data == NULL ) {
diff --git a/mapserver.h b/mapserver.h
index 27f30d83..21be5bb8 100644
--- a/mapserver.h
+++ b/mapserver.h
@@ -65,6 +65,10 @@ static char *cvsid_aw(void) { return( cvsid_aw() ? ((char *) NULL) : ms_cvsid );
 
 /* definition of  ms_int32/ms_uint32 */
 #include <limits.h>
+#ifndef _WIN32
+#include <stdint.h>
+#endif
+
 #if ULONG_MAX == 0xffffffff
 typedef long            ms_int32;
 typedef unsigned long   ms_uint32;
@@ -72,7 +76,6 @@ typedef unsigned long   ms_uint32;
 typedef int             ms_int32;
 typedef unsigned int    ms_uint32;
 #else
-#include <stdint.h>
 typedef int32_t         ms_int32;
 typedef uint32_t        ms_uint32;
 #endif
