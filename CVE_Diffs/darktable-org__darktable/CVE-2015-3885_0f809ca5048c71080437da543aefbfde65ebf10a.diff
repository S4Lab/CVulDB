darktable-org__darktable
commit 0f809ca5048c71080437da543aefbfde65ebf10a
Author:     Roman Lebedev <lebedev.ri@gmail.com>
AuthorDate: Fri May 22 13:18:48 2015 +0300
Commit:     Roman Lebedev <lebedev.ri@gmail.com>
CommitDate: Fri May 22 13:18:48 2015 +0300

    LibRaw: address CVE-2015-3885: fix integer overflow in ljpeg_start()
    
    The fix is not tested.
    Based on ufraw.

diff --git a/src/external/LibRaw/dcraw/dcraw.c b/src/external/LibRaw/dcraw/dcraw.c
index 52ec7fc9d..b7e445e71 100644
--- a/src/external/LibRaw/dcraw/dcraw.c
+++ b/src/external/LibRaw/dcraw/dcraw.c
@@ -768,7 +768,8 @@ struct jhead {
 
 int CLASS ljpeg_start (struct jhead *jh, int info_only)
 {
-  int c, tag, len;
+  int c, tag;
+  ushort len;
   uchar data[0x10000];
   const uchar *dp;
 
@@ -779,8 +780,9 @@ int CLASS ljpeg_start (struct jhead *jh, int info_only)
   do {
     fread (data, 2, 2, ifp);
     tag =  data[0] << 8 | data[1];
-    len = (data[2] << 8 | data[3]) - 2;
-    if (tag <= 0xff00) return 0;
+    len = (data[2] << 8 | data[3]);
+    if (tag <= 0xff00 || len <= 2) return 0;
+    len -= 2;
     fread (data, 1, len, ifp);
     switch (tag) {
       case 0xffc3:
diff --git a/src/external/LibRaw/internal/dcraw_common.cpp b/src/external/LibRaw/internal/dcraw_common.cpp
index 26b137ff9..276fe56f2 100644
--- a/src/external/LibRaw/internal/dcraw_common.cpp
+++ b/src/external/LibRaw/internal/dcraw_common.cpp
@@ -630,7 +630,8 @@ void CLASS canon_compressed_load_raw()
 
 int CLASS ljpeg_start (struct jhead *jh, int info_only)
 {
-  int c, tag, len;
+  int c, tag;
+  ushort len;
   uchar data[0x10000];
   const uchar *dp;
 
@@ -641,8 +642,9 @@ int CLASS ljpeg_start (struct jhead *jh, int info_only)
   do {
     fread (data, 2, 2, ifp);
     tag =  data[0] << 8 | data[1];
-    len = (data[2] << 8 | data[3]) - 2;
-    if (tag <= 0xff00) return 0;
+    len = (data[2] << 8 | data[3]);
+    if (tag <= 0xff00 || len <= 2) return 0;
+    len -= 2;
     fread (data, 1, len, ifp);
     switch (tag) {
       case 0xffc3:
