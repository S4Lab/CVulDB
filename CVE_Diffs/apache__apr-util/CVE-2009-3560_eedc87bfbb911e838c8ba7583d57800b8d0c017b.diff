apache__apr-util
commit eedc87bfbb911e838c8ba7583d57800b8d0c017b
Author:     Joe Orton <jorton@apache.org>
AuthorDate: Wed Sep 29 13:45:51 2010 +0000
Commit:     Joe Orton <jorton@apache.org>
CommitDate: Wed Sep 29 13:45:51 2010 +0000

    Backport security fixes from expat CVS:
    
    * xml/expat/lib/xmlparse.c (doProlog): Add fix for CVE-2009-3560.
    
    * xml/expat/lib/xmltok_impl.c (updatePosition): Add fix for
      CVE-2009-3720.
    
    * test/testxml.c (test_CVE_2009_3720_beta, test_CVE_2009_3720_alpha):
      Add test cases for -3720.
    
    
    git-svn-id: https://svn.apache.org/repos/asf/apr/apr-util/branches/1.5.x@1002628 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/test/testxml.c b/test/testxml.c
index 1bab5618..927a17e2 100644
--- a/test/testxml.c
+++ b/test/testxml.c
@@ -165,12 +165,40 @@ static void test_billion_laughs(abts_case *tc, void *data)
     apr_file_close(fd);
 }
 
+static void test_CVE_2009_3720_alpha(abts_case *tc, void *data)
+{
+    apr_xml_parser *xp;
+    apr_xml_doc *doc;
+    apr_status_t rv;
+
+    xp = apr_xml_parser_create(p);
+    
+    rv = apr_xml_parser_feed(xp, "\0\r\n", 3);
+    if (rv == APR_SUCCESS)
+        apr_xml_parser_done(xp, &doc);
+}
+
+static void test_CVE_2009_3720_beta(abts_case *tc, void *data)
+{
+    apr_xml_parser *xp;
+    apr_xml_doc *doc;
+    apr_status_t rv;
+
+    xp = apr_xml_parser_create(p);
+    
+    rv = apr_xml_parser_feed(xp, "<?xml version\xc2\x85='1.0'?>\r\n", 25);
+    if (rv == APR_SUCCESS)
+        apr_xml_parser_done(xp, &doc);
+}
+
 abts_suite *testxml(abts_suite *suite)
 {
     suite = ADD_SUITE(suite);
 
     abts_run_test(suite, test_xml_parser, NULL);
     abts_run_test(suite, test_billion_laughs, NULL);
+    abts_run_test(suite, test_CVE_2009_3720_alpha, NULL);
+    abts_run_test(suite, test_CVE_2009_3720_beta, NULL);
 
     return suite;
 }
diff --git a/xml/expat/lib/xmlparse.c b/xml/expat/lib/xmlparse.c
index fc4adbb0..4a86edc3 100644
--- a/xml/expat/lib/xmlparse.c
+++ b/xml/expat/lib/xmlparse.c
@@ -3361,6 +3361,9 @@ doProlog(XML_Parser parser,
         return XML_ERROR_UNCLOSED_TOKEN;
       case XML_TOK_PARTIAL_CHAR:
         return XML_ERROR_PARTIAL_CHAR;
+      case -XML_TOK_PROLOG_S:
+        tok = -tok;
+        break;
       case XML_TOK_NONE:
 #ifdef XML_DTD
         if (enc != encoding)
diff --git a/xml/expat/lib/xmltok_impl.c b/xml/expat/lib/xmltok_impl.c
index 46569fe3..f3e0e522 100644
--- a/xml/expat/lib/xmltok_impl.c
+++ b/xml/expat/lib/xmltok_impl.c
@@ -1741,7 +1741,7 @@ PREFIX(updatePosition)(const ENCODING *enc,
                        const char *end,
                        POSITION *pos)
 {
-  while (ptr != end) {
+  while (ptr < end) {
     switch (BYTE_TYPE(enc, ptr)) {
 #define LEAD_CASE(n) \
     case BT_LEAD ## n: \
