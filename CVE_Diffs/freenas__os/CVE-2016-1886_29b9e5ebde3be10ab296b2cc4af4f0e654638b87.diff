freenas__os
commit 29b9e5ebde3be10ab296b2cc4af4f0e654638b87
Author:     glebius <glebius@FreeBSD.org>
AuthorDate: Tue May 17 22:28:27 2016 +0000
Commit:     Josh Paetzel <josh@ixsystems.com>
CommitDate: Thu May 19 11:13:27 2016 -0700

    - Use unsigned version of min() when handling arguments of SETFKEY ioctl.
    - Validate that user supplied control message length in sendmsg(2)
      is not negative.
    
    Security:       SA-16:18
    Security:       CVE-2016-1886
    Security:       SA-16:19
    Security:       CVE-2016-1887
    Submitted by:   C Turt <cturt hardenedbsd.org>
    Approved by:    so
    
    Ticket: #15429
    
    (cherry picked from commit 8a232783c3444677eb1faa3048123dda21767094)

diff --git a/UPDATING b/UPDATING
index f6a5f2a13c8..2a1249e1a82 100644
--- a/UPDATING
+++ b/UPDATING
@@ -16,6 +16,13 @@ from older versions of FreeBSD, try WITHOUT_CLANG to bootstrap to the tip of
 stable/10, and then rebuild without this option. The bootstrap process from
 older version of current is a bit fragile.
 
+20160517	p3	FreeBSD-SA-16:18.atkbd
+			FreeBSD-SA-16:19.sendmsg
+
+	Fix buffer overflow in keyboard driver. [SA-16:18]
+
+	Fix incorrect argument handling in sendmsg(2). [SA-16:19]
+
 20160504	p2	FreeBSD-SA-16:17.openssl
 			FreeBSD-EN-16:06.libc
 			FreeBSD-EN-16:07.ipi
diff --git a/sys/conf/newvers.sh b/sys/conf/newvers.sh
index 5ad43e3d5b4..142bd8a6115 100644
--- a/sys/conf/newvers.sh
+++ b/sys/conf/newvers.sh
@@ -32,7 +32,7 @@
 
 TYPE="FreeBSD"
 REVISION="10.3"
-BRANCH="RELEASE-p2"
+BRANCH="RELEASE-p3"
 if [ "X${BRANCH_OVERRIDE}" != "X" ]; then
 	BRANCH=${BRANCH_OVERRIDE}
 fi
diff --git a/sys/dev/kbd/kbd.c b/sys/dev/kbd/kbd.c
index 80367628888..f1a1b29ab22 100644
--- a/sys/dev/kbd/kbd.c
+++ b/sys/dev/kbd/kbd.c
@@ -996,7 +996,7 @@ genkbd_commonioctl(keyboard_t *kbd, u_long cmd, caddr_t arg)
 			splx(s);
 			return (error);
 		}
-		kbd->kb_fkeytab[fkeyp->keynum].len = imin(fkeyp->flen, MAXFK);
+		kbd->kb_fkeytab[fkeyp->keynum].len = min(fkeyp->flen, MAXFK);
 		bcopy(fkeyp->keydef, kbd->kb_fkeytab[fkeyp->keynum].str,
 		    kbd->kb_fkeytab[fkeyp->keynum].len);
 		break;
diff --git a/sys/kern/uipc_syscalls.c b/sys/kern/uipc_syscalls.c
index fa36849acd4..97ca1156acd 100644
--- a/sys/kern/uipc_syscalls.c
+++ b/sys/kern/uipc_syscalls.c
@@ -1787,6 +1787,9 @@ sockargs(mp, buf, buflen, type)
 	struct mbuf *m;
 	int error;
 
+	if (buflen < 0)
+		return (EINVAL);
+
 	if (buflen > MLEN) {
 #ifdef COMPAT_OLDSOCK
 		if (type == MT_SONAME && buflen <= 112)
