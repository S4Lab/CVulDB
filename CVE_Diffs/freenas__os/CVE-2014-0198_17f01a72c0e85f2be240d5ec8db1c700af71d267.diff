freenas__os
commit 17f01a72c0e85f2be240d5ec8db1c700af71d267
Author:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
AuthorDate: Tue May 13 23:17:24 2014 +0000
Commit:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
CommitDate: Tue May 13 23:17:24 2014 +0000

    Fix OpenSSL NULL pointer deference vulnerability.
    
    Obtained from:  OpenBSD
    Security:       FreeBSD-SA-14:09.openssl
    Security:       CVE-2014-0198
    
    
    git-svn-id: svn+ssh://svn.freebsd.org/base/head@265985 ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f

diff --git a/crypto/openssl/ssl/s3_pkt.c b/crypto/openssl/ssl/s3_pkt.c
index 8deeab3c9fb..1b1613e6c1c 100644
--- a/crypto/openssl/ssl/s3_pkt.c
+++ b/crypto/openssl/ssl/s3_pkt.c
@@ -657,6 +657,10 @@ static int do_ssl3_write(SSL *s, int type, const unsigned char *buf,
 		if (i <= 0)
 			return(i);
 		/* if it went, fall through and send more stuff */
+		/* we may have released our buffer, so get it again */
+		if (wb->buf == NULL)
+			if (!ssl3_setup_write_buffer(s))
+				return -1;
 		}
 
 	if (len == 0 && !create_empty_fragment)
