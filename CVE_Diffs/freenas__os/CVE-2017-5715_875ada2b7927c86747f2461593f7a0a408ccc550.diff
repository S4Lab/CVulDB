freenas__os
commit 875ada2b7927c86747f2461593f7a0a408ccc550
Author:     emaste <emaste@FreeBSD.org>
AuthorDate: Sun Apr 8 20:54:13 2018 +0000
Commit:     emaste <emaste@FreeBSD.org>
CommitDate: Sun Apr 8 20:54:13 2018 +0000

    MFC r330110: Add kernel retpoline option for amd64
    
    Retpoline is a compiler-based mitigation for CVE-2017-5715, also known
    as Spectre V2, that protects against speculative execution branch target
    injection attacks.
    
    In this commit it is disabled by default, but will be changed in a
    followup commit.
    
    MFC r330962: Remove KERNEL_RETPOLINE from BROKEN_OPTIONS on i386
    
    Clang will compile both amd64 and i386 with retpoline.
    
    Sponsored by:   The FreeBSD Foundation

diff --git a/sys/conf/kern.mk b/sys/conf/kern.mk
index a5e26f27018..2c6bf8792ed 100644
--- a/sys/conf/kern.mk
+++ b/sys/conf/kern.mk
@@ -192,7 +192,7 @@ CFLAGS+=	-ffreestanding
 # gcc and clang opimizers take advantage of this.  The kernel makes
 # use of signed integer wraparound mechanics so we need the compiler
 # to treat it as a wraparound and not take shortcuts.
-# 
+#
 CFLAGS+=	-fwrapv
 
 #
@@ -203,6 +203,14 @@ CFLAGS+=	-fwrapv
 CFLAGS+=	-fstack-protector
 .endif
 
+#
+# Retpoline speculative execution vulnerability mitigation (CVE-2017-5715)
+#
+.if defined(COMPILER_FEATURES) && ${COMPILER_FEATURES:Mretpoline} != "" && \
+    ${MK_KERNEL_RETPOLINE} != "no"
+CFLAGS+=	-mretpoline
+.endif
+
 #
 # Add -gdwarf-2 when compiling -g. The default starting in clang v3.4
 # and gcc 4.8 is to generate DWARF version 4. However, our tools don't
diff --git a/sys/conf/kern.opts.mk b/sys/conf/kern.opts.mk
index 0843f7fcc03..6d22d2eea5d 100644
--- a/sys/conf/kern.opts.mk
+++ b/sys/conf/kern.opts.mk
@@ -48,6 +48,7 @@ __DEFAULT_YES_OPTIONS = \
 __DEFAULT_NO_OPTIONS = \
     EISA \
     EXTRA_TCP_STACKS \
+    KERNEL_RETPOLINE \
     NAND \
     OFED \
     REPRODUCIBLE_BUILD
@@ -85,6 +86,11 @@ BROKEN_OPTIONS+= EISA
 BROKEN_OPTIONS+= OFED
 .endif
 
+# Things that don't work based on toolchain support.
+.if ${MACHINE} != "i386" && ${MACHINE} != "amd64"
+BROKEN_OPTIONS+= KERNEL_RETPOLINE
+.endif
+
 # expanded inline from bsd.mkopt.mk to avoid share/mk dependency
 
 # Those that default to yes
diff --git a/tools/build/options/WITHOUT_KERNEL_RETPOLINE b/tools/build/options/WITHOUT_KERNEL_RETPOLINE
new file mode 100644
index 00000000000..ca7bd77dd95
--- /dev/null
+++ b/tools/build/options/WITHOUT_KERNEL_RETPOLINE
@@ -0,0 +1,3 @@
+.\" $FreeBSD$
+Set to disable the "retpoline" mitigation for CVE-2017-5715 in the kernel
+build.
diff --git a/tools/build/options/WITH_KERNEL_RETPOLINE b/tools/build/options/WITH_KERNEL_RETPOLINE
new file mode 100644
index 00000000000..3a0ff6cd437
--- /dev/null
+++ b/tools/build/options/WITH_KERNEL_RETPOLINE
@@ -0,0 +1,3 @@
+.\" $FreeBSD$
+Set to enable the "retpoline" mitigation for CVE-2017-5715 in the kernel
+build.
