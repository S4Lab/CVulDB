freenas__os
commit 254f0ba7c191c1c3919cd666112db990abf05714
Author:     kib <kib@FreeBSD.org>
AuthorDate: Fri Nov 10 12:28:43 2017 +0000
Commit:     Alexander Motin <mav@FreeBSD.org>
CommitDate: Thu Nov 16 20:47:51 2017 +0200

    MFC r325567:
    Zero whole struct ptrace_lwpinfo to not leak kernel stack data.
    
    Security:       CVE-2017-1086
    (cherry picked from commit a9480512504618c725807232b538d3d03adb13c0)

diff --git a/sys/kern/sys_process.c b/sys/kern/sys_process.c
index 796354668d2..3d1ff62e343 100644
--- a/sys/kern/sys_process.c
+++ b/sys/kern/sys_process.c
@@ -518,6 +518,7 @@ ptrace_lwpinfo_to32(const struct ptrace_lwpinfo *pl,
     struct ptrace_lwpinfo32 *pl32)
 {
 
+	bzero(pl32, sizeof(*pl32));
 	pl32->pl_lwpid = pl->pl_lwpid;
 	pl32->pl_event = pl->pl_event;
 	pl32->pl_flags = pl->pl_flags;
@@ -1330,6 +1331,7 @@ kern_ptrace(struct thread *td, int req, pid_t pid, void *addr, int data)
 		} else
 #endif
 		pl = addr;
+		bzero(pl, sizeof(*pl));
 		pl->pl_lwpid = td2->td_tid;
 		pl->pl_event = PL_EVENT_NONE;
 		pl->pl_flags = 0;
@@ -1350,8 +1352,6 @@ kern_ptrace(struct thread *td, int req, pid_t pid, void *addr, int data)
 				pl->pl_siginfo = td2->td_dbgksi.ksi_info;
 			}
 		}
-		if ((pl->pl_flags & PL_FLAG_SI) == 0)
-			bzero(&pl->pl_siginfo, sizeof(pl->pl_siginfo));
 		if (td2->td_dbgflags & TDB_SCE)
 			pl->pl_flags |= PL_FLAG_SCE;
 		else if (td2->td_dbgflags & TDB_SCX)
