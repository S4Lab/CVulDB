freenas__os
commit 681f02be98dac5dbf1f9148d1f9a1c50d02e4186
Author:     des <des@FreeBSD.org>
AuthorDate: Tue Nov 14 10:48:30 2017 +0000
Commit:     Alexander Motin <mav@FreeBSD.org>
CommitDate: Thu Nov 16 20:47:52 2017 +0200

    MFH (r325010): don't bother verifying a password that we know is too long.
    
    Reported by:    jkim@
    Security:       CVE-2016-6210
    
    (cherry picked from commit b242fe393914310e50673eb62d480ce03706d745)

diff --git a/lib/libpam/modules/pam_unix/pam_unix.c b/lib/libpam/modules/pam_unix/pam_unix.c
index 5403d5d555e..2fd3b61970c 100644
--- a/lib/libpam/modules/pam_unix/pam_unix.c
+++ b/lib/libpam/modules/pam_unix/pam_unix.c
@@ -111,6 +111,7 @@ pam_sm_authenticate(pam_handle_t *pamh, int flags __unused,
 			if (!(flags & PAM_DISALLOW_NULL_AUTHTOK) &&
 			    openpam_get_option(pamh, PAM_OPT_NULLOK))
 				return (PAM_SUCCESS);
+			PAM_LOG("Password is empty, using fake password");
 			realpw = "*";
 		}
 		lc = login_getpwclass(pwd);
@@ -125,6 +126,10 @@ pam_sm_authenticate(pam_handle_t *pamh, int flags __unused,
 	if (retval != PAM_SUCCESS)
 		return (retval);
 	PAM_LOG("Got password");
+	if (strnlen(pass, _PASSWORD_LEN + 1) > _PASSWORD_LEN) {
+		PAM_LOG("Password is too long, using fake password");
+		realpw = "*";
+	}
 	if (strcmp(crypt(pass, realpw), realpw) == 0)
 		return (PAM_SUCCESS);
 
