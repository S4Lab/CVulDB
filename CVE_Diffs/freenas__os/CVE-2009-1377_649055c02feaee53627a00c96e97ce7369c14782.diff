freenas__os
commit 649055c02feaee53627a00c96e97ce7369c14782
Author:     simon <simon@FreeBSD.org>
AuthorDate: Sun Aug 23 13:58:25 2009 +0000
Commit:     simon <simon@FreeBSD.org>
CommitDate: Sun Aug 23 13:58:25 2009 +0000

    Import DTLS fix from upstream OpenSSL 0.9.8 branch:
    
    Fix memory consumption bug with "future epoch" DTLS records.
    
    Note that this will not get FreeBSD Security Advisory as DTLS is
    experimental in OpenSSL.
    
    Security:       CVE-2009-1377
    Obtained from:  OpenSSL CVS
                    http://cvs.openssl.org/chngview?cn=18187

diff --git a/crypto/pqueue/pqueue.c b/crypto/pqueue/pqueue.c
index 5cc18527f8d..6c89f06fb10 100644
--- a/crypto/pqueue/pqueue.c
+++ b/crypto/pqueue/pqueue.c
@@ -234,3 +234,17 @@ pqueue_next(pitem **item)
 
 	return ret;
 	}
+
+int
+pqueue_size(pqueue_s *pq)
+{
+	pitem *item = pq->items;
+	int count = 0;
+	
+	while(item != NULL)
+	{
+		count++;
+		item = item->next;
+	}
+	return count;
+}
diff --git a/crypto/pqueue/pqueue.h b/crypto/pqueue/pqueue.h
index 02386d130e9..16c4072681c 100644
--- a/crypto/pqueue/pqueue.h
+++ b/crypto/pqueue/pqueue.h
@@ -91,5 +91,6 @@ pitem *pqueue_iterator(pqueue pq);
 pitem *pqueue_next(piterator *iter);
 
 void   pqueue_print(pqueue pq);
+int    pqueue_size(pqueue pq);
 
 #endif /* ! HEADER_PQUEUE_H */
diff --git a/ssl/d1_pkt.c b/ssl/d1_pkt.c
index eb56cf987ba..4ae9be54ae6 100644
--- a/ssl/d1_pkt.c
+++ b/ssl/d1_pkt.c
@@ -167,6 +167,10 @@ dtls1_buffer_record(SSL *s, record_pqueue *queue, PQ_64BIT priority)
     DTLS1_RECORD_DATA *rdata;
 	pitem *item;
 
+	/* Limit the size of the queue to prevent DOS attacks */
+	if (pqueue_size(queue->q) >= 100)
+		return 0;
+		
 	rdata = OPENSSL_malloc(sizeof(DTLS1_RECORD_DATA));
 	item = pitem_new(priority, rdata);
 	if (rdata == NULL || item == NULL)
