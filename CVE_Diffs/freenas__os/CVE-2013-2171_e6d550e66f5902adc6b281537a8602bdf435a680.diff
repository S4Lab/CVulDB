freenas__os
commit e6d550e66f5902adc6b281537a8602bdf435a680
Author:     des <des@FreeBSD.org>
AuthorDate: Tue Jun 18 07:04:19 2013 +0000
Commit:     des <des@FreeBSD.org>
CommitDate: Tue Jun 18 07:04:19 2013 +0000

    Fix a bug that allowed a tracing process (e.g. gdb) to write
    to a memory-mapped file in the traced process's address space
    even if neither the traced process nor the tracing process had
    write access to that file.
    
    Security:       CVE-2013-2171
    Security:       FreeBSD-SA-13:06.mmap
    Approved by:    so

diff --git a/UPDATING b/UPDATING
index 21549c5f6a6..33c33b96b39 100644
--- a/UPDATING
+++ b/UPDATING
@@ -11,6 +11,12 @@ handbook:
 Items affecting the ports and packages system can be found in
 /usr/ports/UPDATING.  Please read that file before running portupgrade.
 
+20130618:
+        Fix a bug that allowed a tracing process (e.g. gdb) to write
+        to a memory-mapped file in the traced process's address space
+        even if neither the traced process nor the tracing process had
+        write access to that file.
+
 20130605:
 	Added ZFS TRIM support which is enabled by default. To disable
 	ZFS TRIM support set vfs.zfs.trim.enabled=0 in loader.conf.
diff --git a/sys/vm/vm_map.c b/sys/vm/vm_map.c
index 003c6792ba4..864aa7f82dc 100644
--- a/sys/vm/vm_map.c
+++ b/sys/vm/vm_map.c
@@ -3799,6 +3799,12 @@ RetryLookup:;
 		vm_map_unlock_read(map);
 		return (KERN_PROTECTION_FAILURE);
 	}
+	if ((fault_typea & VM_PROT_COPY) != 0 &&
+	    (entry->max_protection & VM_PROT_WRITE) == 0 &&
+	    (entry->eflags & MAP_ENTRY_COW) == 0) {
+		vm_map_unlock_read(map);
+		return (KERN_PROTECTION_FAILURE);
+	}
 
 	/*
 	 * If this page is not pageable, we have to get it for all possible
