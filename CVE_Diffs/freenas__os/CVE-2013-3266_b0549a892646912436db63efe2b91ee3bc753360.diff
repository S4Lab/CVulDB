freenas__os
commit b0549a892646912436db63efe2b91ee3bc753360
Author:     des <des@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
AuthorDate: Mon Apr 29 20:09:44 2013 +0000
Commit:     des <des@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
CommitDate: Mon Apr 29 20:09:44 2013 +0000

    Fix a bug that allows NFS clients to issue READDIR on files.
    
    PR:             kern/178016
    Security:       CVE-2013-3266
    Security:       FreeBSD-SA-13:05.nfsserver
    
    
    git-svn-id: svn+ssh://svn.freebsd.org/base/head@250055 ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f

diff --git a/sys/fs/nfsserver/nfs_nfsdport.c b/sys/fs/nfsserver/nfs_nfsdport.c
index 92c35b2c527..84addccb4c5 100644
--- a/sys/fs/nfsserver/nfs_nfsdport.c
+++ b/sys/fs/nfsserver/nfs_nfsdport.c
@@ -1574,6 +1574,8 @@ nfsrvd_readdir(struct nfsrv_descript *nd, int isdgram,
 			nd->nd_repstat = NFSERR_BAD_COOKIE;
 #endif
 	}
+	if (!nd->nd_repstat && vp->v_type != VDIR)
+		nd->nd_repstat = NFSERR_NOTDIR;
 	if (nd->nd_repstat == 0 && cnt == 0) {
 		if (nd->nd_flag & ND_NFSV2)
 			/* NFSv2 does not have NFSERR_TOOSMALL */
