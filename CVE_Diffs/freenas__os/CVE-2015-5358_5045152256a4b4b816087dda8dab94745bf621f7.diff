freenas__os
commit 5045152256a4b4b816087dda8dab94745bf621f7
Author:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
AuthorDate: Tue Jul 21 23:42:15 2015 +0000
Commit:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
CommitDate: Tue Jul 21 23:42:15 2015 +0000

    Fix resource exhaustion due to sessions stuck in LAST_ACK state.
    
    Submitted by:   Jonathan Looney (Juniper SIRT)
    Reviewed by:    lstewart
    Security:       CVE-2015-5358
    Security:       SA-15:13.tcp
    
    
    git-svn-id: svn+ssh://svn.freebsd.org/base/head@285777 ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f

diff --git a/sys/netinet/tcp_output.c b/sys/netinet/tcp_output.c
index 111f22e2edd..9413721624c 100644
--- a/sys/netinet/tcp_output.c
+++ b/sys/netinet/tcp_output.c
@@ -400,7 +400,7 @@ tcp_output(struct tcpcb *tp)
 		flags &= ~TH_FIN;
 	}
 
-	if (len < 0) {
+	if (len <= 0) {
 		/*
 		 * If FIN has been sent but not acked,
 		 * but we haven't been called to retransmit,
@@ -410,9 +410,16 @@ tcp_output(struct tcpcb *tp)
 		 * to (closed) window, and set the persist timer
 		 * if it isn't already going.  If the window didn't
 		 * close completely, just wait for an ACK.
+		 *
+		 * We also do a general check here to ensure that
+		 * we will set the persist timer when we have data
+		 * to send, but a 0-byte window. This makes sure
+		 * the persist timer is set even if the packet
+		 * hits one of the "goto send" lines below.
 		 */
 		len = 0;
-		if (sendwin == 0) {
+		if ((sendwin == 0) && (TCPS_HAVEESTABLISHED(tp->t_state)) &&
+			(off < (int) sbavail(&so->so_snd))) {
 			tcp_timer_activate(tp, TT_REXMT, 0);
 			tp->t_rxtshift = 0;
 			tp->snd_nxt = tp->snd_una;
