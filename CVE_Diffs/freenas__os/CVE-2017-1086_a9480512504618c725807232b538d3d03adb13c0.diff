freenas__os
commit a9480512504618c725807232b538d3d03adb13c0
Author:     kib <kib@FreeBSD.org>
AuthorDate: Fri Nov 10 12:28:43 2017 +0000
Commit:     kib <kib@FreeBSD.org>
CommitDate: Fri Nov 10 12:28:43 2017 +0000

    MFC r325567:
    Zero whole struct ptrace_lwpinfo to not leak kernel stack data.
    
    Security:       CVE-2017-1086

diff --git a/sys/kern/sys_process.c b/sys/kern/sys_process.c
index 2f59cb5e78b..856cdd3c319 100644
--- a/sys/kern/sys_process.c
+++ b/sys/kern/sys_process.c
@@ -504,6 +504,7 @@ ptrace_lwpinfo_to32(const struct ptrace_lwpinfo *pl,
     struct ptrace_lwpinfo32 *pl32)
 {
 
+	bzero(pl32, sizeof(*pl32));
 	pl32->pl_lwpid = pl->pl_lwpid;
 	pl32->pl_event = pl->pl_event;
 	pl32->pl_flags = pl->pl_flags;
@@ -1316,6 +1317,7 @@ kern_ptrace(struct thread *td, int req, pid_t pid, void *addr, int data)
 		} else
 #endif
 		pl = addr;
+		bzero(pl, sizeof(*pl));
 		pl->pl_lwpid = td2->td_tid;
 		pl->pl_event = PL_EVENT_NONE;
 		pl->pl_flags = 0;
@@ -1336,8 +1338,6 @@ kern_ptrace(struct thread *td, int req, pid_t pid, void *addr, int data)
 				pl->pl_siginfo = td2->td_si;
 			}
 		}
-		if ((pl->pl_flags & PL_FLAG_SI) == 0)
-			bzero(&pl->pl_siginfo, sizeof(pl->pl_siginfo));
 		if (td2->td_dbgflags & TDB_SCE)
 			pl->pl_flags |= PL_FLAG_SCE;
 		else if (td2->td_dbgflags & TDB_SCX)
