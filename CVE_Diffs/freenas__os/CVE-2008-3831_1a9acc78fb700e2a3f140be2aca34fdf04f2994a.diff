freenas__os
commit 1a9acc78fb700e2a3f140be2aca34fdf04f2994a
Author:     rnoland <rnoland@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
AuthorDate: Sat Oct 25 16:29:28 2008 +0000
Commit:     rnoland <rnoland@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
CommitDate: Sat Oct 25 16:29:28 2008 +0000

    drm/i915: fix ioremap of a user address for non-root (CVE-2008-3831)
    
    Olaf Kirch noticed that the i915_set_status_page() function of the i915
    kernel driver calls ioremap with an address offset that is supplied by
    userspace via ioctl. The function zeroes the mapped memory via memset
    and tells the hardware about the address. Turns out that access to that
    ioctl is not restricted to root so users could probably exploit that to
    do nasty things. We haven't tried to write actual exploit code though.
    
    It only affects the Intel G33 series and newer.
    
    Approved by:    bz (secteam)
    Obtained from:  Intel drm repo
    Security:       CVE-2008-3831
    
    
    git-svn-id: svn+ssh://svn.freebsd.org/base/head@184263 ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f

diff --git a/sys/dev/drm/i915_dma.c b/sys/dev/drm/i915_dma.c
index 39a0809c433..fb2bda59b0a 100644
--- a/sys/dev/drm/i915_dma.c
+++ b/sys/dev/drm/i915_dma.c
@@ -1228,7 +1228,7 @@ struct drm_ioctl_desc i915_ioctls[] = {
 	DRM_IOCTL_DEF(DRM_I915_GET_VBLANK_PIPE,  i915_vblank_pipe_get, DRM_AUTH ),
 	DRM_IOCTL_DEF(DRM_I915_VBLANK_SWAP, i915_vblank_swap, DRM_AUTH),
 	DRM_IOCTL_DEF(DRM_I915_MMIO, i915_mmio, DRM_AUTH),
-	DRM_IOCTL_DEF(DRM_I915_HWS_ADDR, i915_set_status_page, DRM_AUTH),
+	DRM_IOCTL_DEF(DRM_I915_HWS_ADDR, i915_set_status_page, DRM_AUTH|DRM_MASTER|DRM_ROOT_ONLY),
 #ifdef I915_HAVE_BUFFER
 	DRM_IOCTL_DEF(DRM_I915_EXECBUFFER, i915_execbuffer, DRM_AUTH),
 #endif
