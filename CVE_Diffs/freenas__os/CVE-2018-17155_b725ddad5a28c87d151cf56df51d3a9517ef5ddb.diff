freenas__os
commit b725ddad5a28c87d151cf56df51d3a9517ef5ddb
Author:     gordon <gordon@FreeBSD.org>
AuthorDate: Thu Sep 27 18:42:40 2018 +0000
Commit:     Alexander Motin <mav@FreeBSD.org>
CommitDate: Fri Sep 28 09:44:05 2018 -0400

    MFC r338982.
    
    Clear stack allocated data structure to prevent kernel memory leak.
    
    Reported by:    Thomas Barabosch, Fraunhofer FKIE
    Reviewed by:    wes@
    Approved by:    so
    Security:       FreeBSD-EN-18:12.mem
    Security:       CVE-2018-17155
    
    (cherry picked from commit 7d66fd1e932a68e0bd893f0a19724069d5c80ace)

diff --git a/sys/kern/kern_context.c b/sys/kern/kern_context.c
index 70751d02cba..acd3ded2a20 100644
--- a/sys/kern/kern_context.c
+++ b/sys/kern/kern_context.c
@@ -68,6 +68,7 @@ sys_getcontext(struct thread *td, struct getcontext_args *uap)
 	if (uap->ucp == NULL)
 		ret = EINVAL;
 	else {
+		bzero(&uc, sizeof(ucontext_t));
 		get_mcontext(td, &uc.uc_mcontext, GET_MC_CLEAR_RET);
 		PROC_LOCK(td->td_proc);
 		uc.uc_sigmask = td->td_sigmask;
@@ -108,6 +109,7 @@ sys_swapcontext(struct thread *td, struct swapcontext_args *uap)
 	if (uap->oucp == NULL || uap->ucp == NULL)
 		ret = EINVAL;
 	else {
+		bzero(&uc, sizeof(ucontext_t));
 		get_mcontext(td, &uc.uc_mcontext, GET_MC_CLEAR_RET);
 		bzero(uc.__spare__, sizeof(uc.__spare__));
 		PROC_LOCK(td->td_proc);
