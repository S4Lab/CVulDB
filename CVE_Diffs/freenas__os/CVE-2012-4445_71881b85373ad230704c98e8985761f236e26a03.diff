freenas__os
commit 71881b85373ad230704c98e8985761f236e26a03
Author:     cperciva <cperciva@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
AuthorDate: Fri Nov 23 01:48:31 2012 +0000
Commit:     cperciva <cperciva@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
CommitDate: Fri Nov 23 01:48:31 2012 +0000

    MFS security patches which seem to have accidentally not reached HEAD:
    
    Fix insufficient message length validation for EAP-TLS messages.
    
    Fix Linux compatibility layer input validation error.
    
    Security:       FreeBSD-SA-12:07.hostapd
    Security:       FreeBSD-SA-12:08.linux
    Security:       CVE-2012-4445, CVE-2012-4576
    With hat:       so@
    
    
    git-svn-id: svn+ssh://svn.freebsd.org/base/head@243419 ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f

diff --git a/contrib/wpa/src/eap_server/eap_server_tls_common.c b/contrib/wpa/src/eap_server/eap_server_tls_common.c
index 25ae683f066..625ff52a4c2 100644
--- a/contrib/wpa/src/eap_server/eap_server_tls_common.c
+++ b/contrib/wpa/src/eap_server/eap_server_tls_common.c
@@ -225,6 +225,14 @@ static int eap_server_tls_process_fragment(struct eap_ssl_data *data,
 			return -1;
 		}
 
+		if (len > message_length) {
+			wpa_printf(MSG_INFO, "SSL: Too much data (%d bytes) in "
+				   "first fragment of frame (TLS Message "
+				   "Length %d bytes)",
+				   (int) len, (int) message_length);
+			return -1;
+		}
+
 		data->tls_in = wpabuf_alloc(message_length);
 		if (data->tls_in == NULL) {
 			wpa_printf(MSG_DEBUG, "SSL: No memory for message");
diff --git a/sys/compat/linux/linux_ioctl.c b/sys/compat/linux/linux_ioctl.c
index 0a9cd274b01..868a4c697fb 100644
--- a/sys/compat/linux/linux_ioctl.c
+++ b/sys/compat/linux/linux_ioctl.c
@@ -2260,8 +2260,9 @@ linux_ifconf(struct thread *td, struct ifconf *uifc)
 
 	ifc.ifc_len = valid_len; 
 	sbuf_finish(sb);
-	memcpy(PTRIN(ifc.ifc_buf), sbuf_data(sb), ifc.ifc_len);
-	error = copyout(&ifc, uifc, sizeof(ifc));
+	error = copyout(sbuf_data(sb), PTRIN(ifc.ifc_buf), ifc.ifc_len);
+	if (error == 0)
+		error = copyout(&ifc, uifc, sizeof(ifc));
 	sbuf_delete(sb);
 	CURVNET_RESTORE();
 
