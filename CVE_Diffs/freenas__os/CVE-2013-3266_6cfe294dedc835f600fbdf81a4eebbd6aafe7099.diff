freenas__os
commit 6cfe294dedc835f600fbdf81a4eebbd6aafe7099
Author:     des <des@FreeBSD.org>
AuthorDate: Mon Apr 29 20:09:44 2013 +0000
Commit:     des <des@FreeBSD.org>
CommitDate: Mon Apr 29 20:09:44 2013 +0000

    Fix a bug that allows NFS clients to issue READDIR on files.
    
    PR:             kern/178016
    Security:       CVE-2013-3266
    Security:       FreeBSD-SA-13:05.nfsserver

diff --git a/sys/fs/nfsserver/nfs_nfsdport.c b/sys/fs/nfsserver/nfs_nfsdport.c
index 92c35b2c527..84addccb4c5 100644
--- a/sys/fs/nfsserver/nfs_nfsdport.c
+++ b/sys/fs/nfsserver/nfs_nfsdport.c
@@ -1574,6 +1574,8 @@ nfsrvd_readdir(struct nfsrv_descript *nd, int isdgram,
 			nd->nd_repstat = NFSERR_BAD_COOKIE;
 #endif
 	}
+	if (!nd->nd_repstat && vp->v_type != VDIR)
+		nd->nd_repstat = NFSERR_NOTDIR;
 	if (nd->nd_repstat == 0 && cnt == 0) {
 		if (nd->nd_flag & ND_NFSV2)
 			/* NFSv2 does not have NFSERR_TOOSMALL */
