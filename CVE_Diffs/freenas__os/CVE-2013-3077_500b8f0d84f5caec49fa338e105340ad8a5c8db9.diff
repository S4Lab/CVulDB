freenas__os
commit 500b8f0d84f5caec49fa338e105340ad8a5c8db9
Author:     delphij <delphij@FreeBSD.org>
AuthorDate: Thu Aug 22 00:51:37 2013 +0000
Commit:     delphij <delphij@FreeBSD.org>
CommitDate: Thu Aug 22 00:51:37 2013 +0000

    Fix an integer overflow in computing the size of a temporary buffer
    can result in a buffer which is too small for the requested
    operation.
    
    Security:       CVE-2013-3077
    Security:       FreeBSD-SA-13:09.ip_multicast

diff --git a/sys/netinet/in_mcast.c b/sys/netinet/in_mcast.c
index 812ca674c96..813fa3d57cf 100644
--- a/sys/netinet/in_mcast.c
+++ b/sys/netinet/in_mcast.c
@@ -1614,6 +1614,8 @@ inp_get_source_filters(struct inpcb *inp, struct sockopt *sopt)
 	 * has asked for, but we always tell userland how big the
 	 * buffer really needs to be.
 	 */
+	if (msfr.msfr_nsrcs > in_mcast_maxsocksrc)
+		msfr.msfr_nsrcs = in_mcast_maxsocksrc;
 	tss = NULL;
 	if (msfr.msfr_srcs != NULL && msfr.msfr_nsrcs > 0) {
 		tss = malloc(sizeof(struct sockaddr_storage) * msfr.msfr_nsrcs,
diff --git a/sys/netinet6/in6_mcast.c b/sys/netinet6/in6_mcast.c
index ce23aa8c34c..fca48b5c6d6 100644
--- a/sys/netinet6/in6_mcast.c
+++ b/sys/netinet6/in6_mcast.c
@@ -1625,6 +1625,8 @@ in6p_get_source_filters(struct inpcb *inp, struct sockopt *sopt)
 	 * has asked for, but we always tell userland how big the
 	 * buffer really needs to be.
 	 */
+	if (msfr.msfr_nsrcs > in6_mcast_maxsocksrc)
+		msfr.msfr_nsrcs = in6_mcast_maxsocksrc;
 	tss = NULL;
 	if (msfr.msfr_srcs != NULL && msfr.msfr_nsrcs > 0) {
 		tss = malloc(sizeof(struct sockaddr_storage) * msfr.msfr_nsrcs,
