freenas__os
commit b134b6da7c370138c41f4f3fff22ef1d9c12595d
Author:     gordon <gordon@FreeBSD.org>
AuthorDate: Wed Sep 12 05:02:11 2018 +0000
Commit:     Alexander Motin <mav@FreeBSD.org>
CommitDate: Wed Sep 12 14:39:09 2018 -0400

    MFC 338603:
    Correct ELF header parsing code to prevent invalid ELF sections from
    disclosing memory.
    
    Submitted by:   markj
    Reported by:    Thomas Barabosch, Fraunhofer FKIE
    Approved by:    so
    Security:       FreeBSD-SA-18:12.elf
    Security:       CVE-2018-6924
    Sponsored by:   The FreeBSD Foundation
    
    (cherry picked from commit 4bfdb79b43e74833a67eb9d7f2afcf632b136917)

diff --git a/sys/kern/imgact_elf.c b/sys/kern/imgact_elf.c
index f7bbdcf7152..01e3be5a339 100644
--- a/sys/kern/imgact_elf.c
+++ b/sys/kern/imgact_elf.c
@@ -834,7 +834,8 @@ __CONCAT(exec_, __elfN(imgact))(struct image_params *imgp)
 			break;
 		case PT_INTERP:
 			/* Path to interpreter */
-			if (phdr[i].p_filesz > MAXPATHLEN) {
+			if (phdr[i].p_filesz < 2 ||
+			    phdr[i].p_filesz > MAXPATHLEN) {
 				uprintf("Invalid PT_INTERP\n");
 				error = ENOEXEC;
 				goto ret;
@@ -864,6 +865,11 @@ __CONCAT(exec_, __elfN(imgact))(struct image_params *imgp)
 			} else {
 				interp = __DECONST(char *, imgp->image_header) +
 				    phdr[i].p_offset;
+				if (interp[interp_name_len - 1] != '\0') {
+					uprintf("Invalid PT_INTERP\n");
+					error = ENOEXEC;
+					goto ret;
+				}
 			}
 			break;
 		case PT_GNU_STACK:
diff --git a/sys/kern/vfs_vnops.c b/sys/kern/vfs_vnops.c
index 49af86d8040..fc98d83dd78 100644
--- a/sys/kern/vfs_vnops.c
+++ b/sys/kern/vfs_vnops.c
@@ -529,6 +529,8 @@ vn_rdwr(enum uio_rw rw, struct vnode *vp, void *base, int len, off_t offset,
 	struct vn_io_fault_args args;
 	int error, lock_flags;
 
+	if (offset < 0 && vp->v_type != VCHR)
+		return (EINVAL);
 	auio.uio_iov = &aiov;
 	auio.uio_iovcnt = 1;
 	aiov.iov_base = base;
