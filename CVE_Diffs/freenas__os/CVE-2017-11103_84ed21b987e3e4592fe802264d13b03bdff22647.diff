freenas__os
commit 84ed21b987e3e4592fe802264d13b03bdff22647
Author:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
AuthorDate: Wed Jul 12 07:19:06 2017 +0000
Commit:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
CommitDate: Wed Jul 12 07:19:06 2017 +0000

    MFV r320905: Import upstream fix for CVE-2017-11103.
    
    In _krb5_extract_ticket() the KDC-REP service name must be obtained from
    encrypted version stored in 'enc_part' instead of the unencrypted version
    stored in 'ticket'.  Use of the unecrypted version provides an
    opportunity for successful server impersonation and other attacks.
    
    Submitted by:   hrs
    Obtained from:  Heimdal
    Security:       FreeBSD-SA-17:05.heimdal
    Security:       CVE-2017-11103
    
    
    git-svn-id: svn+ssh://svn.freebsd.org/base/head@320906 ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f

diff --git a/crypto/heimdal/lib/krb5/ticket.c b/crypto/heimdal/lib/krb5/ticket.c
index 4845a93d944..5b6eabe2b0e 100644
--- a/crypto/heimdal/lib/krb5/ticket.c
+++ b/crypto/heimdal/lib/krb5/ticket.c
@@ -713,8 +713,8 @@ _krb5_extract_ticket(krb5_context context,
     /* check server referral and save principal */
     ret = _krb5_principalname2krb5_principal (context,
 					      &tmp_principal,
-					      rep->kdc_rep.ticket.sname,
-					      rep->kdc_rep.ticket.realm);
+					      rep->enc_part.sname,
+					      rep->enc_part.srealm);
     if (ret)
 	goto out;
     if((flags & EXTRACT_TICKET_ALLOW_SERVER_MISMATCH) == 0){
