freenas__os
commit b5aaf99026d074905ba398b12afe42e756579642
Author:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
AuthorDate: Wed Apr 30 04:02:36 2014 +0000
Commit:     delphij <delphij@ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f>
CommitDate: Wed Apr 30 04:02:36 2014 +0000

    Fix OpenSSL use-after-free vulnerability.
    
    Obtained from:  OpenBSD
    Security:       FreeBSD-SA-14:09.openssl
    Security:       CVE-2010-5298
    
    
    git-svn-id: svn+ssh://svn.freebsd.org/base/head@265120 ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f

diff --git a/crypto/openssl/ssl/s3_pkt.c b/crypto/openssl/ssl/s3_pkt.c
index 96ba63262e4..8deeab3c9fb 100644
--- a/crypto/openssl/ssl/s3_pkt.c
+++ b/crypto/openssl/ssl/s3_pkt.c
@@ -1055,7 +1055,7 @@ int ssl3_read_bytes(SSL *s, int type, unsigned char *buf, int len, int peek)
 				{
 				s->rstate=SSL_ST_READ_HEADER;
 				rr->off=0;
-				if (s->mode & SSL_MODE_RELEASE_BUFFERS)
+				if (s->mode & SSL_MODE_RELEASE_BUFFERS && s->s3->rbuf.left == 0)
 					ssl3_release_read_buffer(s);
 				}
 			}
