freenas__os
commit 9359dbab020da232fa5104036f1014d0fa879561
Author:     gordon <gordon@FreeBSD.org>
AuthorDate: Thu Sep 27 18:54:41 2018 +0000
Commit:     gordon <gordon@FreeBSD.org>
CommitDate: Thu Sep 27 18:54:41 2018 +0000

    Check to ensure the buffer returned is not NULL.
    
    Direct commit to the branch as this behavior is only seeing in stable/11.
    
    Reported by:    Thomas Barabosch, Fraunhofer FKIE
    Reviewed by:    wes@
    Approved by:    so
    Security:       FreeBSD-EN-18:10.syscall
    Security:       CVE-2018-17154

diff --git a/sys/kern/vfs_syscalls.c b/sys/kern/vfs_syscalls.c
index bea56037df5..0e957f5d596 100644
--- a/sys/kern/vfs_syscalls.c
+++ b/sys/kern/vfs_syscalls.c
@@ -601,6 +601,8 @@ freebsd4_getfsstat(struct thread *td, struct freebsd4_getfsstat_args *uap)
 	size = count * sizeof(struct statfs);
 	error = kern_getfsstat(td, &buf, size, &count, UIO_SYSSPACE,
 	    uap->mode);
+	if (buf == NULL)
+		return (EINVAL);
 	td->td_retval[0] = count;
 	if (size != 0) {
 		sp = buf;
