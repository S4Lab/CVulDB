freenas__os
commit 500d1d31a2ba53230b05a3d4bd90164e19c97628
Author:     cem <cem@FreeBSD.org>
AuthorDate: Sat Jul 28 00:59:59 2018 +0000
Commit:     cem <cem@FreeBSD.org>
CommitDate: Sat Jul 28 00:59:59 2018 +0000

    MFV r336800: libarchive: Cherry-pick upstream 2c8c83b9
    
    Relevant vendor changes:
      Fix issue #948: out-of-bounds read in lha_read_data_none()
    
    admbugs:        877
    MFC after:      3 days
    Security:       CVE-2017-14503

diff --git a/contrib/libarchive/libarchive/archive_read_support_format_lha.c b/contrib/libarchive/libarchive/archive_read_support_format_lha.c
index b8ef4ae10ec..95c99bb1f31 100644
--- a/contrib/libarchive/libarchive/archive_read_support_format_lha.c
+++ b/contrib/libarchive/libarchive/archive_read_support_format_lha.c
@@ -701,6 +701,12 @@ archive_read_format_lha_read_header(struct archive_read *a,
 	 * Prepare variables used to read a file content.
 	 */
 	lha->entry_bytes_remaining = lha->compsize;
+	if (lha->entry_bytes_remaining < 0) {
+		archive_set_error(&a->archive,
+		    ARCHIVE_ERRNO_FILE_FORMAT,
+		    "Invalid LHa entry size");
+		return (ARCHIVE_FATAL);
+	}
 	lha->entry_offset = 0;
 	lha->entry_crc_calculated = 0;
 
