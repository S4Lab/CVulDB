freenas__os
commit 25ca306958f47d2bcf719496b52d5b1d9d9571c2
Author:     delphij <delphij@FreeBSD.org>
AuthorDate: Wed Dec 10 08:24:02 2014 +0000
Commit:     delphij <delphij@FreeBSD.org>
CommitDate: Wed Dec 10 08:24:02 2014 +0000

    MFC r275665:
    
    Fix buffer overflow in stdio.
    
    Security:       FreeBSD-SA-14:27.stdio
    Security:       CVE-2014-8611

diff --git a/lib/libc/stdio/fflush.c b/lib/libc/stdio/fflush.c
index ef9b45b8b6f..123167a0912 100644
--- a/lib/libc/stdio/fflush.c
+++ b/lib/libc/stdio/fflush.c
@@ -124,11 +124,13 @@ __sflush(FILE *fp)
 		t = _swrite(fp, (char *)p, n);
 		if (t <= 0) {
 			/* Reset _p and _w. */
-			if (p > fp->_p)	/* Some was written. */
+			if (p > fp->_p) {
+				/* Some was written. */
 				memmove(fp->_p, p, n);
-			fp->_p += n;
-			if ((fp->_flags & (__SLBF | __SNBF)) == 0)
-				fp->_w -= n;
+				fp->_p += n;
+				if ((fp->_flags & (__SLBF | __SNBF)) == 0)
+					fp->_w -= n;
+			}
 			fp->_flags |= __SERR;
 			return (EOF);
 		}
