xenserver__xen-4.6
commit 365c95f7de789e1dca03f119eab7dc61fe0f77c9
Author:     Jan Beulich <jbeulich@suse.com>
AuthorDate: Tue Jun 4 09:29:07 2013 +0200
Commit:     Jan Beulich <jbeulich@suse.com>
CommitDate: Tue Jun 4 09:29:07 2013 +0200

    x86/xsave: properly check guest input to XSETBV
    
    Other than the HVM emulation path, the PV case so far failed to check
    that YMM state requires SSE state to be enabled, allowing for a #GP to
    occur upon passing the inputs to XSETBV inside the hypervisor.
    
    This is CVE-2013-2078 / XSA-54.
    
    Signed-off-by: Jan Beulich <jbeulich@suse.com>

diff --git a/xen/arch/x86/traps.c b/xen/arch/x86/traps.c
index 087bbebf5f..ef964c3e39 100644
--- a/xen/arch/x86/traps.c
+++ b/xen/arch/x86/traps.c
@@ -2205,6 +2205,11 @@ static int emulate_privileged_op(struct cpu_user_regs *regs)
                     if ( !(new_xfeature & XSTATE_FP) || (new_xfeature & ~xfeature_mask) )
                         goto fail;
 
+                    /* YMM state takes SSE state as prerequisite. */
+                    if ( (xfeature_mask & new_xfeature & XSTATE_YMM) &&
+                         !(new_xfeature & XSTATE_SSE) )
+                        goto fail;
+
                     v->arch.xcr0 = new_xfeature;
                     v->arch.xcr0_accum |= new_xfeature;
                     set_xcr0(new_xfeature);
