minipli__linux-grsec
commit 7cfe055fa0b70ee00220673e1b070a28c213fc3b
Author:     Eric Sandeen <sandeen@redhat.com>
AuthorDate: Mon Feb 20 17:53:01 2012 -0500
Commit:     Willy Tarreau <w@1wt.eu>
CommitDate: Sun Oct 7 23:37:02 2012 +0200

    jbd2: clear BH_Delay & BH_Unwritten in journal_unmap_buffer
    
    commit 15291164b22a357cb211b618adfef4fa82fc0de3 upstream.
    
    journal_unmap_buffer()'s zap_buffer: code clears a lot of buffer head
    state ala discard_buffer(), but does not touch _Delay or _Unwritten as
    discard_buffer() does.
    
    This can be problematic in some areas of the ext4 code which assume
    that if they have found a buffer marked unwritten or delay, then it's
    a live one.  Perhaps those spots should check whether it is mapped
    as well, but if jbd2 is going to tear down a buffer, let's really
    tear it down completely.
    
    Without this I get some fsx failures on sub-page-block filesystems
    up until v3.2, at which point 4e96b2dbbf1d7e81f22047a50f862555a6cb87cb
    and 189e868fa8fdca702eb9db9d8afc46b5cb9144c9 make the failures go
    away, because buried within that large change is some more flag
    clearing.  I still think it's worth doing in jbd2, since
    ->invalidatepage leads here directly, and it's the right place
    to clear away these flags.
    
    Signed-off-by: Eric Sandeen <sandeen@redhat.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Cc: stable@vger.kernel.org
    
    BugLink: http://bugs.launchpad.net/bugs/929781
    CVE-2011-4086
    
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

diff --git a/fs/jbd2/transaction.c b/fs/jbd2/transaction.c
index a0512700542f..5c156ad2d247 100644
--- a/fs/jbd2/transaction.c
+++ b/fs/jbd2/transaction.c
@@ -1822,6 +1822,8 @@ static int journal_unmap_buffer(journal_t *journal, struct buffer_head *bh)
 	clear_buffer_mapped(bh);
 	clear_buffer_req(bh);
 	clear_buffer_new(bh);
+	clear_buffer_delay(bh);
+	clear_buffer_unwritten(bh);
 	bh->b_bdev = NULL;
 	return may_free;
 }
