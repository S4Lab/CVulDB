minipli__linux-grsec
commit 00ec474c9bed7883f1b3e5f46e3bf09f7de69975
Author:     Hugh Dickins <hugh@veritas.com>
AuthorDate: Mon Apr 17 22:46:32 2006 +0100
Commit:     Greg Kroah-Hartman <gregkh@suse.de>
CommitDate: Mon Apr 17 14:52:57 2006 -0700

    [PATCH] fix MADV_REMOVE vulnerability (CVE-2006-1524 for real this time)
    
    madvise_remove needs to respect file and mmap protections.
    
    Signed-off-by: Hugh Dickins <hugh@veritas.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

diff --git a/mm/madvise.c b/mm/madvise.c
index af3d573b0141..4e196155a0c3 100644
--- a/mm/madvise.c
+++ b/mm/madvise.c
@@ -168,6 +168,9 @@ static long madvise_remove(struct vm_area_struct *vma,
 			return -EINVAL;
 	}
 
+	if ((vma->vm_flags & (VM_SHARED|VM_WRITE)) != (VM_SHARED|VM_WRITE))
+		return -EACCES;
+
 	mapping = vma->vm_file->f_mapping;
 
 	offset = (loff_t)(start - vma->vm_start)
