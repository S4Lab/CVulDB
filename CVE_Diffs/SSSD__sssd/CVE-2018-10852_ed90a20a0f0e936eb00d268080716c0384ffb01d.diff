SSSD__sssd
commit ed90a20a0f0e936eb00d268080716c0384ffb01d
Author:     Jakub Hrozek <jhrozek@redhat.com>
AuthorDate: Fri Jun 15 22:29:34 2018 +0200
Commit:     Jakub Hrozek <jhrozek@redhat.com>
CommitDate: Mon Jun 25 09:18:24 2018 +0200

    SUDO: Create the socket with stricter permissions
    
    This patch switches the sudo responder from being created as a public
    responder where the permissions are open and not checked by the sssd
    deaamon to a private socket. In this case, sssd creates the pipes with
    strict permissions (see the umask in the call to create_pipe_fd() in
    set_unix_socket()) and additionaly checks the permissions with every read
    via the tevent integrations (see accept_fd_handler()).
    
    Resolves:
    https://pagure.io/SSSD/sssd/issue/3766 (CVE-2018-10852)
    
    Reviewed-by: Sumit Bose <sbose@redhat.com>
    Reviewed-by: Pavel BÅ™ezina <pbrezina@redhat.com>

diff --git a/src/responder/sudo/sudosrv.c b/src/responder/sudo/sudosrv.c
index ac4258710..e87a24499 100644
--- a/src/responder/sudo/sudosrv.c
+++ b/src/responder/sudo/sudosrv.c
@@ -79,7 +79,8 @@ int sudo_process_init(TALLOC_CTX *mem_ctx,
     sudo_cmds = get_sudo_cmds();
     ret = sss_process_init(mem_ctx, ev, cdb,
                            sudo_cmds,
-                           SSS_SUDO_SOCKET_NAME, -1, NULL, -1,
+                           NULL, -1,                   /* No public socket */
+                           SSS_SUDO_SOCKET_NAME, -1,   /* Private socket only */
                            CONFDB_SUDO_CONF_ENTRY,
                            SSS_SUDO_SBUS_SERVICE_NAME,
                            SSS_SUDO_SBUS_SERVICE_VERSION,
diff --git a/src/sysv/systemd/sssd-sudo.socket.in b/src/sysv/systemd/sssd-sudo.socket.in
index c9abb875f..96a8b0327 100644
--- a/src/sysv/systemd/sssd-sudo.socket.in
+++ b/src/sysv/systemd/sssd-sudo.socket.in
@@ -11,6 +11,7 @@ ExecStartPre=@libexecdir@/sssd/sssd_check_socket_activated_responders -r sudo
 ListenStream=@pipepath@/sudo
 SocketUser=@SSSD_USER@
 SocketGroup=@SSSD_USER@
+SocketMode=0600
 
 [Install]
 WantedBy=sssd.service
