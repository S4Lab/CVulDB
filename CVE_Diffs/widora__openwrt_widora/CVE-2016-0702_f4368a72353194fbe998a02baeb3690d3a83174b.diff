widora__openwrt_widora
commit f4368a72353194fbe998a02baeb3690d3a83174b
Author:     jow <jow@3c298f89-4303-0410-b956-a3cf2f4a3e73>
AuthorDate: Tue Mar 1 15:18:24 2016 +0000
Commit:     jow <jow@3c298f89-4303-0410-b956-a3cf2f4a3e73>
CommitDate: Tue Mar 1 15:18:24 2016 +0000

    CC: openssl: update to 1.0.2g (8 CVEs)
    
    CVE-2016-0704
    
    s2_srvr.c overwrite the wrong bytes in the master-key when applying
    Bleichenbacher protection for export cipher suites. This provides a
    Bleichenbacher oracle, and could potentially allow more efficient variants of
    the DROWN attack.
    
    CVE-2016-0703
    
    s2_srvr.c did not enforce that clear-key-length is 0 for non-export ciphers.
    If clear-key bytes are present for these ciphers, they *displace* encrypted-key
    bytes. This leads to an efficient divide-and-conquer key recovery attack: if
    an eavesdropper has intercepted an SSLv2 handshake, they can use the server as
    an oracle to determine the SSLv2 master-key, using only 16 connections to the
    server and negligible computation. More importantly, this leads to a more
    efficient version of DROWN that is effective against non-export ciphersuites,
    and requires no significant computation.
    
    CVE-2016-0702
    
    A side-channel attack was found which makes use of cache-bank conflicts on
    the Intel Sandy-Bridge microarchitecture which could lead to the recovery of
    RSA keys. The ability to exploit this issue is limited as it relies on an
    attacker who has control of code in a thread running on the same hyper-
    threaded core as the victim thread which is performing decryptions.
    
    CVE-2016-0799
    
    The internal |fmtstr| function used in processing a "%s" format string in
    the BIO_*printf functions could overflow while calculating the length of a
    string and cause an OOB read when printing very long strings. Additionally
    the internal |doapr_outch| function can attempt to write to an OOB memory
    location (at an offset from the NULL pointer) in the event of a memory
    allocation failure. In 1.0.2 and below this could be caused where the size
    of a buffer to be allocated is greater than INT_MAX. E.g. this could be in
    processing a very long "%s" format string. Memory leaks can also occur.
    The first issue may mask the second issue dependent on compiler behaviour.
    These problems could enable attacks where large amounts of untrusted data is
    passed to the BIO_*printf functions. If applications use these functions in
    this way then they could be vulnerable. OpenSSL itself uses these functions
    when printing out human-readable dumps of ASN.1 data. Therefore applications
    that print this data could be vulnerable if the data is from untrusted sources.
    OpenSSL command line applications could also be vulnerable where they print out
    ASN.1 data, or if untrusted data is passed as command line arguments. Libssl is
    not considered directly vulnerable. Additionally certificates etc received via
    remote connections via libssl are also unlikely to be able to trigger these
    issues because of message size limits enforced within libssl.
    
    CVE-2016-0797
    
    In the BN_hex2bn function the number of hex digits is calculated using an int
    value |i|. Later |bn_expand| is called with a value of |i * 4|. For large
    values of |i| this can result in |bn_expand| not allocating any memory because
    |i * 4| is negative. This can leave the internal BIGNUM data field as NULL
    leading to a subsequent NULL ptr deref. For very large values of |i|, the
    calculation |i * 4| could be a positive value smaller than |i|. In this case
    memory is allocated to the internal BIGNUM data field, but it is insufficiently
    sized leading to heap corruption. A similar issue exists in BN_dec2bn. This
    could have security consequences if BN_hex2bn/BN_dec2bn is ever called by user
    applications with very large untrusted hex/dec data. This is anticipated to be
    a rare occurrence. All OpenSSL internal usage of these functions use data that
    is not expected to be untrusted, e.g. config file data or application command
    line arguments. If user developed applications generate config file data based
    on untrusted data then it is possible that this could also lead to security
    consequences. This is also anticipated to be rare.
    
    CVE-2016-0798
    
    The SRP user database lookup method SRP_VBASE_get_by_user had confusing memory
    management semantics; the returned pointer was sometimes newly allocated, and
    sometimes owned by the callee. The calling code has no way of distinguishing
    these two cases. Specifically, SRP servers that configure a secret seed to hide
    valid login information are vulnerable to a memory leak: an attacker connecting
    with an invalid username can cause a memory leak of around 300 bytes per
    connection. Servers that do not configure SRP, or configure SRP but do not
    configure a seed are not vulnerable. In Apache, the seed directive is known as
    SSLSRPUnknownUserSeed. To mitigate the memory leak, the seed handling in
    SRP_VBASE_get_by_user is now disabled even if the user has configured a seed.
    Applications are advised to migrate to SRP_VBASE_get1_by_user. However, note
    that OpenSSL makes no strong guarantees about the indistinguishability of valid
    and invalid logins. In particular, computations are currently not carried out
    in constant time.
    
    CVE-2016-0705
    
    A double free bug was discovered when OpenSSL parses malformed DSA private keys
    and could lead to a DoS attack or memory corruption for applications that
    receive DSA private keys from untrusted sources. This scenario is considered
    rare.
    
    CVE-2016-0800
    
    A cross-protocol attack was discovered that could lead to decryption of TLS
    sessions by using a server supporting SSLv2 and EXPORT cipher suites as a
    Bleichenbacher RSA padding oracle. Note that traffic between clients and non-
    vulnerable servers can be decrypted provided another server supporting SSLv2
    and EXPORT ciphers (even with a different protocol such as SMTP, IMAP or POP)
    shares the RSA keys of the non-vulnerable server. This vulnerability is known
    as DROWN (CVE-2016-0800). Recovering one session key requires the attacker to
    perform approximately 2^50 computation, as well as thousands of connections to
    the affected server. A more efficient variant of the DROWN attack exists
    against unpatched OpenSSL servers using versions that predate 1.0.2a, 1.0.1m,
    1.0.0r and 0.9.8zf released on 19/Mar/2015 (see CVE-2016-0703 below). Users can
    avoid this issue by disabling the SSLv2 protocol in all their SSL/TLS servers,
    if they've not done so already. Disabling all SSLv2 ciphers is also sufficient,
    provided the patches for CVE-2015-3197 (fixed in OpenSSL 1.0.1r and 1.0.2f)
    have been deployed. Servers that have not disabled the SSLv2 protocol, and are
    not patched for CVE-2015-3197 are vulnerable to DROWN even if all SSLv2
    ciphers are nominally disabled, because malicious clients can force the use of
    SSLv2 with EXPORT ciphers. OpenSSL 1.0.2g and 1.0.1s deploy the following
    mitigation against DROWN: SSLv2 is now by default disabled at build-time.
    Builds that are not configured with "enable-ssl2" will not support SSLv2.
    Even if "enable-ssl2" is used, users who want to negotiate SSLv2 via the
    version-flexible SSLv23_method() will need to explicitly call either of:
    SSL_CTX_clear_options(ctx, SSL_OP_NO_SSLv2); or SSL_clear_options(ssl,
    SSL_OP_NO_SSLv2); as appropriate. Even if either of those is used, or the
    application explicitly uses the version-specific SSLv2_method() or its client
    or server variants, SSLv2 ciphers vulnerable to exhaustive search key recovery
    have been removed. Specifically, the SSLv2 40-bit EXPORT ciphers, and SSLv2
    56-bit DES are no longer available. In addition, weak ciphers in SSLv3 and up
    are now disabled in default builds of OpenSSL. Builds that are not configured
    with "enable-weak-ssl-ciphers" will not provide any "EXPORT" or "LOW" strength
    ciphers.
    
    Signed-off-by: Jo-Philipp Wich <jow@openwrt.org>
    
    Backport of r48868.
    
    git-svn-id: svn://svn.openwrt.org/openwrt/branches/chaos_calmer@48869 3c298f89-4303-0410-b956-a3cf2f4a3e73

diff --git a/package/libs/openssl/Makefile b/package/libs/openssl/Makefile
index 8cd32a7..0b96557 100644
--- a/package/libs/openssl/Makefile
+++ b/package/libs/openssl/Makefile
@@ -1,5 +1,5 @@
 #
-# Copyright (C) 2006-2015 OpenWrt.org
+# Copyright (C) 2006-2016 OpenWrt.org
 #
 # This is free software, licensed under the GNU General Public License v2.
 # See /LICENSE for more information.
@@ -9,7 +9,7 @@ include $(TOPDIR)/rules.mk
 
 PKG_NAME:=openssl
 PKG_BASE:=1.0.2
-PKG_BUGFIX:=f
+PKG_BUGFIX:=g
 PKG_VERSION:=$(PKG_BASE)$(PKG_BUGFIX)
 PKG_RELEASE:=1
 PKG_USE_MIPS16:=0
@@ -21,7 +21,7 @@ PKG_SOURCE_URL:=http://www.openssl.org/source/ \
 	http://www.openssl.org/source/old/$(PKG_BASE)/ \
 	ftp://ftp.funet.fi/pub/crypt/mirrors/ftp.openssl.org/source \
 	ftp://ftp.sunet.se/pub/security/tools/net/openssl/source/
-PKG_MD5SUM:=b3bf73f507172be9292ea2a8c28b659d
+PKG_MD5SUM:=f3c710c045cdee5fd114feb69feba7aa
 
 PKG_LICENSE:=OpenSSL
 PKG_LICENSE_FILES:=LICENSE
diff --git a/package/libs/openssl/patches/110-optimize-for-size.patch b/package/libs/openssl/patches/110-optimize-for-size.patch
index 8145b6c..1721842 100644
--- a/package/libs/openssl/patches/110-optimize-for-size.patch
+++ b/package/libs/openssl/patches/110-optimize-for-size.patch
@@ -1,6 +1,6 @@
 --- a/Configure
 +++ b/Configure
-@@ -464,6 +464,12 @@ my %table=(
+@@ -468,6 +468,12 @@ my %table=(
  "linux-alpha-ccc","ccc:-fast -readonly_strings -DL_ENDIAN::-D_REENTRANT:::SIXTY_FOUR_BIT_LONG RC4_CHUNK DES_INT DES_PTR DES_RISC1 DES_UNROLL:${alpha_asm}",
  "linux-alpha+bwx-ccc","ccc:-fast -readonly_strings -DL_ENDIAN::-D_REENTRANT:::SIXTY_FOUR_BIT_LONG RC4_CHAR RC4_CHUNK DES_INT DES_PTR DES_RISC1 DES_UNROLL:${alpha_asm}",
  
diff --git a/package/libs/openssl/patches/150-no_engines.patch b/package/libs/openssl/patches/150-no_engines.patch
index e0c80e4..f509d28 100644
--- a/package/libs/openssl/patches/150-no_engines.patch
+++ b/package/libs/openssl/patches/150-no_engines.patch
@@ -1,6 +1,6 @@
 --- a/Configure
 +++ b/Configure
-@@ -2103,6 +2103,11 @@ EOF
+@@ -2109,6 +2109,11 @@ EOF
  	close(OUT);
    }
    
@@ -14,7 +14,7 @@
  Configured for $target.
 --- a/util/libeay.num
 +++ b/util/libeay.num
-@@ -2073,7 +2073,6 @@ PKCS7_ATTR_SIGN_it
+@@ -2075,7 +2075,6 @@ PKCS7_ATTR_SIGN_it
  UI_add_error_string                     2633	EXIST::FUNCTION:
  KRB5_CHECKSUM_free                      2634	EXIST::FUNCTION:
  OCSP_REQUEST_get_ext                    2635	EXIST::FUNCTION:
@@ -22,7 +22,7 @@
  ENGINE_register_all_digests             2637	EXIST::FUNCTION:ENGINE
  PKEY_USAGE_PERIOD_it                    2638	EXIST:!EXPORT_VAR_AS_FUNCTION:VARIABLE:
  PKEY_USAGE_PERIOD_it                    2638	EXIST:EXPORT_VAR_AS_FUNCTION:FUNCTION:
-@@ -2547,7 +2546,6 @@ OCSP_RESPONSE_new
+@@ -2549,7 +2548,6 @@ OCSP_RESPONSE_new
  AES_set_encrypt_key                     3024	EXIST::FUNCTION:AES
  OCSP_resp_count                         3025	EXIST::FUNCTION:
  KRB5_CHECKSUM_new                       3026	EXIST::FUNCTION:
@@ -30,7 +30,7 @@
  OCSP_onereq_get0_id                     3028	EXIST::FUNCTION:
  ENGINE_set_default_ciphers              3029	EXIST::FUNCTION:ENGINE
  NOTICEREF_it                            3030	EXIST:!EXPORT_VAR_AS_FUNCTION:VARIABLE:
-@@ -2578,7 +2576,6 @@ ASN1_primitive_free
+@@ -2580,7 +2578,6 @@ ASN1_primitive_free
  i2d_EXTENDED_KEY_USAGE                  3052	EXIST::FUNCTION:
  i2d_OCSP_SIGNATURE                      3053	EXIST::FUNCTION:
  asn1_enc_save                           3054	EXIST::FUNCTION:
@@ -38,7 +38,7 @@
  _ossl_old_des_pcbc_encrypt              3056	EXIST::FUNCTION:DES
  PKCS12_MAC_DATA_it                      3057	EXIST:!EXPORT_VAR_AS_FUNCTION:VARIABLE:
  PKCS12_MAC_DATA_it                      3057	EXIST:EXPORT_VAR_AS_FUNCTION:FUNCTION:
-@@ -2602,7 +2599,6 @@ asn1_get_choice_selector
+@@ -2604,7 +2601,6 @@ asn1_get_choice_selector
  i2d_KRB5_CHECKSUM                       3072	EXIST::FUNCTION:
  ENGINE_set_table_flags                  3073	EXIST::FUNCTION:ENGINE
  AES_options                             3074	EXIST::FUNCTION:AES
@@ -46,7 +46,7 @@
  OCSP_id_cmp                             3076	EXIST::FUNCTION:
  OCSP_BASICRESP_new                      3077	EXIST::FUNCTION:
  OCSP_REQUEST_get_ext_by_NID             3078	EXIST::FUNCTION:
-@@ -2669,7 +2665,6 @@ OCSP_CRLID_it
+@@ -2671,7 +2667,6 @@ OCSP_CRLID_it
  OCSP_CRLID_it                           3127	EXIST:EXPORT_VAR_AS_FUNCTION:FUNCTION:
  i2d_KRB5_AUTHENTBODY                    3128	EXIST::FUNCTION:
  OCSP_REQUEST_get_ext_count              3129	EXIST::FUNCTION:
@@ -54,7 +54,7 @@
  X509_NAME_it                            3131	EXIST:!EXPORT_VAR_AS_FUNCTION:VARIABLE:
  X509_NAME_it                            3131	EXIST:EXPORT_VAR_AS_FUNCTION:FUNCTION:
  USERNOTICE_it                           3132	EXIST:!EXPORT_VAR_AS_FUNCTION:VARIABLE:
-@@ -2764,8 +2759,6 @@ DES_read_2passwords
+@@ -2766,8 +2761,6 @@ DES_read_2passwords
  DES_read_password                       3207	EXIST::FUNCTION:DES
  UI_UTIL_read_pw                         3208	EXIST::FUNCTION:
  UI_UTIL_read_pw_string                  3209	EXIST::FUNCTION:
@@ -63,7 +63,7 @@
  OPENSSL_add_all_algorithms_noconf       3212	EXIST:!VMS:FUNCTION:
  OPENSSL_add_all_algo_noconf             3212	EXIST:VMS:FUNCTION:
  OPENSSL_add_all_algorithms_conf         3213	EXIST:!VMS:FUNCTION:
-@@ -2774,7 +2767,6 @@ OPENSSL_load_builtin_modules
+@@ -2776,7 +2769,6 @@ OPENSSL_load_builtin_modules
  AES_ofb128_encrypt                      3215	EXIST::FUNCTION:AES
  AES_ctr128_encrypt                      3216	EXIST::FUNCTION:AES
  AES_cfb128_encrypt                      3217	EXIST::FUNCTION:AES
@@ -71,7 +71,7 @@
  _ossl_096_des_random_seed               3219	EXIST::FUNCTION:DES
  EVP_aes_256_ofb                         3220	EXIST::FUNCTION:AES
  EVP_aes_192_ofb                         3221	EXIST::FUNCTION:AES
-@@ -3109,7 +3101,6 @@ EC_GFp_nist_method
+@@ -3111,7 +3103,6 @@ EC_GFp_nist_method
  STORE_meth_set_modify_fn                3530	NOEXIST::FUNCTION:
  STORE_method_set_modify_function        3530	NOEXIST::FUNCTION:
  STORE_parse_attrs_next                  3531	NOEXIST::FUNCTION:
diff --git a/package/libs/openssl/patches/200-parallel_build.patch b/package/libs/openssl/patches/200-parallel_build.patch
index 66e6d6b..e3a0bb2 100644
--- a/package/libs/openssl/patches/200-parallel_build.patch
+++ b/package/libs/openssl/patches/200-parallel_build.patch
@@ -164,7 +164,7 @@
  	ctags $(SRC)
 --- a/test/Makefile
 +++ b/test/Makefile
-@@ -138,7 +138,7 @@ install:
+@@ -139,7 +139,7 @@ install:
  tags:
  	ctags $(SRC)
  
@@ -173,7 +173,7 @@
  
  apps:
  	@(cd ..; $(MAKE) DIRS=apps all)
-@@ -549,7 +549,7 @@ $(CLIENTHELLOTEST)$(EXE_EXT): $(CLIENTHE
+@@ -557,7 +557,7 @@ $(SSLV2CONFTEST)$(EXE_EXT): $(SSLV2CONFT
  #	fi
  
  dummytest$(EXE_EXT): dummytest.o $(DLIBCRYPTO)
