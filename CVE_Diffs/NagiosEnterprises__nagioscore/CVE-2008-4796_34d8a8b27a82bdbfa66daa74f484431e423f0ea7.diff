NagiosEnterprises__nagioscore
commit 34d8a8b27a82bdbfa66daa74f484431e423f0ea7
Author:     John C. Frickson <jfrickson@nagios.com>
AuthorDate: Tue Aug 25 15:49:18 2015 -0500
Commit:     John C. Frickson <jfrickson@nagios.com>
CommitDate: Tue Aug 25 15:49:18 2015 -0500

    Incorrect shell escaping in nagios/html/includes/rss/extlib/Snoopy.class.inc
    
    For for issue http://tracker.nagios.org/view.php?id=449
    Reference CVE-2008-4796

diff --git a/Changelog b/Changelog
index f5bc283d..a1f5b723 100644
--- a/Changelog
+++ b/Changelog
@@ -16,6 +16,7 @@ FIXES
 * Can't send big buffer - wproc: Core Worker seems to be choked (velripn / John Frickson)
 * Too big CPU load on FreeBSD and other systems using poll() interface (cejkar)
 * Flexible downtime recorded as unscheduled downtime (John Frickson)
+* Service Flexible downtimes produce 1 notification before entering (John Frickson)
 
 4.1.1 - 08/19/2015
 ------------------
diff --git a/html/includes/rss/extlib/Snoopy.class.inc b/html/includes/rss/extlib/Snoopy.class.inc
index 3ddecbab..4703d1a5 100644
--- a/html/includes/rss/extlib/Snoopy.class.inc
+++ b/html/includes/rss/extlib/Snoopy.class.inc
@@ -640,7 +640,8 @@ class Snoopy
 			$headers[] = "Authorization: BASIC ".base64_encode($this->user.":".$this->pass);
 			
 		for($curr_header = 0; $curr_header < count($headers); $curr_header++) {
-			$cmdline_params .= " -H \"".$headers[$curr_header]."\"";
+			$safer_header = strtr( $headers[$curr_header], "\"", " " );
+			$cmdline_params .= " -H \"".$safer_header."\"";
 		}
 			  	                         
 		if(!empty($body))
@@ -649,11 +650,11 @@ class Snoopy
 		if($this->read_timeout > 0)
 			$cmdline_params .= " -m ".$this->read_timeout;
 		
-		$headerfile = uniqid(time());
+		$headerfile = tempnam("/tmp", "sno");
 		
 		# accept self-signed certs
 		$cmdline_params .= " -k"; 
-		exec($this->curl_path." -D \"/tmp/$headerfile\"".escapeshellcmd($cmdline_params)." ".escapeshellcmd($URI),$results,$return);
+		exec($this->curl_path." -D \"/tmp/$headerfile\"".$cmdline_params." \"".escapeshellcmd($URI)."\"",$results,$return);
 		
 		if($return)
 		{
