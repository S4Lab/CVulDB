balabit__syslog-ng
commit 3cc8403d03f1e1125f69f17fb0969779af776f59
Author:     Balazs Scheidler <bazsi@balabit.hu>
AuthorDate: Tue Nov 18 10:25:41 2008 +0100
Commit:     Balazs Scheidler <bazsi@balabit.hu>
CommitDate: Tue Nov 18 10:25:41 2008 +0100

    added chdir call after chroot, fixes CVE-2008-5110
    
            syslog-ng did not change the current directory after
            restricting itself to a chroot jail, which makes it
            possible to break out of the jail.
    
            Please NOTE that this does not constitute an exploitable
            vulnerability on its own. It only means that _if_ there'd
            be a vulnerability, it'd be easier to break out of the
            chroot jail.
    
            Please also NOTE that if syslog-ng is running in the chroot
            as root, the same vulnerability still exists. Please use
            --user and --group command line options in combination with
            --chroot.

diff --git a/src/gprocess.c b/src/gprocess.c
index 32b675b28..a6ae18b21 100644
--- a/src/gprocess.c
+++ b/src/gprocess.c
@@ -645,6 +645,11 @@ g_process_change_root(void)
           g_process_message("Error in chroot(); chroot='%s', error='%s'\n", process_opts.chroot_dir, g_strerror(errno));
           return FALSE;
         }
+      if (chdir("/") < 0)
+        {
+          g_process_message("Error in chdir() after chroot; chroot='%s', error='%s'\n", process_opts.chroot_dir, g_strerror(errno));
+          return FALSE;
+        }
     }
   return TRUE;
 }
