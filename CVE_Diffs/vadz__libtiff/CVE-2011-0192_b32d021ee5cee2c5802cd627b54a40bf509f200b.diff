vadz__libtiff
commit b32d021ee5cee2c5802cd627b54a40bf509f200b
Author:     fwarmerdam <fwarmerdam>
AuthorDate: Thu Mar 3 01:36:10 2011 +0000
Commit:     fwarmerdam <fwarmerdam>
CommitDate: Thu Mar 3 01:36:10 2011 +0000

    incorporate a fix for possible fax3 decoding overflow (CVE-2011-0192)

diff --git a/ChangeLog b/ChangeLog
index 6f1e8ec9..4ed5e0e5 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,14 @@
+2011-03-02  Frank Warmerdam  <warmerdam@pobox.com>
+
+	* libtiff/tif_fax3.h: Protect against a fax VL(n) codeword commanding 
+	a move left.  Without this, a malicious input file can generate an 
+	indefinitely large series of runs without a0 ever reaching the right 
+	margin, thus overrunning our buffer of run lengths.  Per CVE-2011-0192.
+	This is a modified version of a patch proposed by Drew Yao of Apple 
+	Product Security.  It adds an unexpected() report, and disallows the 
+	equality case, since emitting a run without increasing a0 still allows 
+	buffer overrun.
+
 2011-02-25  Andrey Kiselev  <dron@ak4719.spb.edu>
 
 	* libtiff/tif_dirwrite.c: Avoid undefined behaviour when casting from
diff --git a/libtiff/tif_fax3.h b/libtiff/tif_fax3.h
index a38ab85c..44e659fa 100644
--- a/libtiff/tif_fax3.h
+++ b/libtiff/tif_fax3.h
@@ -478,6 +478,10 @@ done1d:									\
 	    break;							\
 	case S_VL:							\
 	    CHECK_b1;							\
+	    if (b1 <= (int) (a0 + TabEnt->Param)) {			\
+		unexpected("VL", a0);					\
+		goto eol2d;						\
+	    }								\
 	    SETVALUE(b1 - a0 - TabEnt->Param);				\
 	    b1 -= *--pb;						\
 	    break;							\
