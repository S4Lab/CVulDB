vadz__libtiff
commit 3f89cc420720500c2f5732cc59edcd1b63eafed4
Author:     faxguy <faxguy>
AuthorDate: Tue Dec 14 02:23:09 2010 +0000
Commit:     faxguy <faxguy>
CommitDate: Tue Dec 14 02:23:09 2010 +0000

            * libtiff/tif_color.c: prevent crash in handling bad TIFFs
            resolves CVE-2010-2595
            http://bugzilla.maptools.org/show_bug.cgi?id=2208

diff --git a/ChangeLog b/ChangeLog
index c2fa93ed..cc1b9790 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,9 @@
+2010-12-13  Lee Howard <faxguy@howardsilvan.com>
+
+	* libtiff/tif_color.c: prevent crash in handling bad TIFFs
+	resolves CVE-2010-2595
+	http://bugzilla.maptools.org/show_bug.cgi?id=2208
+
 2010-12-13  Lee Howard <faxguy@howardsilvan.com>
 
 	* tools/tiffcrop.c: new release by Richard Nolde
diff --git a/libtiff/tif_color.c b/libtiff/tif_color.c
index 2174fbdb..451098e0 100644
--- a/libtiff/tif_color.c
+++ b/libtiff/tif_color.c
@@ -183,13 +183,18 @@ void
 TIFFYCbCrtoRGB(TIFFYCbCrToRGB *ycbcr, uint32 Y, int32 Cb, int32 Cr,
 	       uint32 *r, uint32 *g, uint32 *b)
 {
+	int32 i;
+
 	/* XXX: Only 8-bit YCbCr input supported for now */
 	Y = HICLAMP(Y, 255), Cb = CLAMP(Cb, 0, 255), Cr = CLAMP(Cr, 0, 255);
 
-	*r = ycbcr->clamptab[ycbcr->Y_tab[Y] + ycbcr->Cr_r_tab[Cr]];
-	*g = ycbcr->clamptab[ycbcr->Y_tab[Y]
-	    + (int)((ycbcr->Cb_g_tab[Cb] + ycbcr->Cr_g_tab[Cr]) >> SHIFT)];
-	*b = ycbcr->clamptab[ycbcr->Y_tab[Y] + ycbcr->Cb_b_tab[Cb]];
+	i = ycbcr->Y_tab[Y] + ycbcr->Cr_r_tab[Cr];
+	*r = CLAMP(i, 0, 255);
+	i = ycbcr->Y_tab[Y]
+	    + (int)((ycbcr->Cb_g_tab[Cb] + ycbcr->Cr_g_tab[Cr]) >> SHIFT);
+	*g = CLAMP(i, 0, 255);
+	i = ycbcr->Y_tab[Y] + ycbcr->Cb_b_tab[Cb];
+	*b = CLAMP(i, 0, 255);
 }
 
 /*
