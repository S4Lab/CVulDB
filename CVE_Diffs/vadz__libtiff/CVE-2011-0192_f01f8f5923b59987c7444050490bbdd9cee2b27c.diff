vadz__libtiff
commit f01f8f5923b59987c7444050490bbdd9cee2b27c
Author:     fwarmerdam <fwarmerdam>
AuthorDate: Thu Mar 3 01:38:25 2011 +0000
Commit:     fwarmerdam <fwarmerdam>
CommitDate: Thu Mar 3 01:38:25 2011 +0000

    incorporate a fix for possible fax3 decoding overflow (CVE-2011-0192)

diff --git a/ChangeLog b/ChangeLog
index 354dbc06..761bb550 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,14 @@
+2011-03-02  Frank Warmerdam  <warmerdam@pobox.com>
+
+	* libtiff/tif_fax3.h: Protect against a fax VL(n) codeword commanding 
+	a move left.  Without this, a malicious input file can generate an 
+	indefinitely large series of runs without a0 ever reaching the right 
+	margin, thus overrunning our buffer of run lengths.  Per CVE-2011-0192.
+	This is a modified version of a patch proposed by Drew Yao of Apple 
+	Product Security.  It adds an unexpected() report, and disallows the 
+	equality case, since emitting a run without increasing a0 still allows 
+	buffer overrun.
+
 2011-02-23  Frank Warmerdam  <warmerdam@pobox.com>
 
 	* libtiff/tif_jpeg.c: avoid divide by zero in degenerate case (#2296)
diff --git a/libtiff/tif_fax3.h b/libtiff/tif_fax3.h
index aeb45cf0..972780f1 100644
--- a/libtiff/tif_fax3.h
+++ b/libtiff/tif_fax3.h
@@ -478,6 +478,10 @@ done1d:									\
 	    break;							\
 	case S_VL:							\
 	    CHECK_b1;							\
+	    if (b1 <= (int) (a0 + TabEnt->Param)) {			\
+		unexpected("VL", a0);					\
+		goto eol2d;						\
+	    }								\
 	    SETVALUE(b1 - a0 - TabEnt->Param);				\
 	    b1 -= *--pb;						\
 	    break;							\
