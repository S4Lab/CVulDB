libreswan__libreswan
commit 0b0ce1116a9cbf0a7b7b6c838553af49f7dd6b41
Author:     Paul Wouters <pwouters@redhat.com>
AuthorDate: Sun Aug 23 13:27:36 2015 -0400
Commit:     Paul Wouters <pwouters@redhat.com>
CommitDate: Sun Aug 23 13:27:36 2015 -0400

    testing: Added ikev2-45-impair-gx to test for CVE-2015-3240

diff --git a/testing/pluto/TESTLIST b/testing/pluto/TESTLIST
index ad986ad2bc..5a08e7b89c 100644
--- a/testing/pluto/TESTLIST
+++ b/testing/pluto/TESTLIST
@@ -57,6 +57,7 @@ kvmplutotest	ikev2-18-x509-alias			good
 kvmplutotest	ikev2-19-x509-auto-start		good
 kvmplutotest	ikev2-41-rw-replace			good
 kvmplutotest	ikev2-42-rw-replace-responder		good
+kvmplutotest	ikev2-45-impair-gx			good
 kvmplutotest	ikev2-46-basic-psk-netkey		good
 kvmplutotest	ikev2-47-priority			wip
 
diff --git a/testing/pluto/ikev2-45-impair-gx/description.txt b/testing/pluto/ikev2-45-impair-gx/description.txt
new file mode 100644
index 0000000000..5f2dc175da
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/description.txt
@@ -0,0 +1,4 @@
+IKEv2 test where west is impaired to send a g^x ==0 DH compontent
+
+likely all openswan and libreswan up to 3.13 are vulnerable to this
+
diff --git a/testing/pluto/ikev2-45-impair-gx/east.conf b/testing/pluto/ikev2-45-impair-gx/east.conf
new file mode 100644
index 0000000000..508f8c4228
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/east.conf
@@ -0,0 +1,22 @@
+# /etc/ipsec.conf - Libreswan IPsec configuration file
+
+version 2.0
+
+config setup
+	# put the logs in /tmp for the UMLs, so that we can operate
+	# without syslogd, which seems to break on UMLs
+	logfile=/tmp/pluto.log
+	logtime=no
+	logappend=no
+	plutodebug=all
+	plutorestartoncrash=false
+	dumpdir=/tmp
+	protostack=netkey
+	nat_traversal=yes
+	virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:!192.0.2.0/24,%v6:!2001:db8:0:2::/64
+
+conn westnet-eastnet-ipv4-psk-ikev2
+	also=westnet-eastnet-ipv4-psk
+	ikev2=insist
+
+include	/testing/baseconfigs/all/etc/ipsec.d/ipsec.conf.common
diff --git a/testing/pluto/ikev2-45-impair-gx/east.console.txt b/testing/pluto/ikev2-45-impair-gx/east.console.txt
new file mode 100644
index 0000000000..c7eba42019
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/east.console.txt
@@ -0,0 +1,69 @@
+/testing/guestbin/swan-prep
+east #
+ ipsec setup start
+Redirecting to: systemctl start ipsec.service
+east #
+ /testing/pluto/bin/wait-until-pluto-started
+east #
+ ipsec whack --debug-all --impair-send-zero-gx --impair-retransmits
+east #
+ ipsec auto --add westnet-eastnet-ipv4-psk-ikev2
+002 added connection description "westnet-eastnet-ipv4-psk-ikev2"
+east #
+ echo "initdone"
+initdone
+east #
+ ipsec look
+east NOW
+XFRM state:
+XFRM policy:
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+XFRM done
+IPSEC mangle TABLES
+NEW_IPSEC_CONN mangle TABLES
+ROUTING TABLES
+default via 192.1.2.254 dev eth1 
+192.0.1.0/24 via 192.1.2.45 dev eth1 
+192.0.2.0/24 dev eth0  proto kernel  scope link  src 192.0.2.254 
+192.1.2.0/24 dev eth1  proto kernel  scope link  src 192.1.2.23 
+192.9.2.0/24 dev eth2  proto kernel  scope link  src 192.9.2.23 
+NSS_CERTIFICATES
+Certificate Nickname                                         Trust Attributes
+                                                             SSL,S/MIME,JAR/XPI
+east #
+east #
+ if [ -n "`ls /tmp/core* 2>/dev/null`" ]; then echo CORE FOUND; mv /tmp/core* OUTPUT/; fi
+east #
+ if [ -f /sbin/ausearch ]; then ausearch -r -m avc -ts recent ; fi
+
diff --git a/testing/pluto/ikev2-45-impair-gx/east.secrets b/testing/pluto/ikev2-45-impair-gx/east.secrets
new file mode 100644
index 0000000000..be2e4f133b
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/east.secrets
@@ -0,0 +1 @@
+@east @west : PSK "ABCDEFGHIJ12345"
diff --git a/testing/pluto/ikev2-45-impair-gx/eastinit.sh b/testing/pluto/ikev2-45-impair-gx/eastinit.sh
new file mode 100644
index 0000000000..8e672bd42f
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/eastinit.sh
@@ -0,0 +1,6 @@
+/testing/guestbin/swan-prep
+ipsec setup start
+/testing/pluto/bin/wait-until-pluto-started
+ipsec whack --debug-all --impair-send-zero-gx --impair-retransmits
+ipsec auto --add westnet-eastnet-ipv4-psk-ikev2
+echo "initdone"
diff --git a/testing/pluto/ikev2-45-impair-gx/final.sh b/testing/pluto/ikev2-45-impair-gx/final.sh
new file mode 100644
index 0000000000..1f2f5b28b6
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/final.sh
@@ -0,0 +1,7 @@
+ipsec look
+: ==== cut ====
+ipsec auto --status
+: ==== tuc ====
+if [ -n "`ls /tmp/core* 2>/dev/null`" ]; then echo CORE FOUND; mv /tmp/core* OUTPUT/; fi
+if [ -f /sbin/ausearch ]; then ausearch -r -m avc -ts recent ; fi
+: ==== end ====
diff --git a/testing/pluto/ikev2-45-impair-gx/west.conf b/testing/pluto/ikev2-45-impair-gx/west.conf
new file mode 100644
index 0000000000..250bb173b2
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/west.conf
@@ -0,0 +1,23 @@
+# /etc/ipsec.conf - Libreswan IPsec configuration file
+
+version 2.0
+
+config setup
+	# put the logs in /tmp for the UMLs, so that we can operate
+	# without syslogd, which seems to break on UMLs
+	logfile=/tmp/pluto.log
+	logtime=no
+	logappend=no
+	plutodebug=all
+	plutorestartoncrash=false
+	dumpdir=/tmp
+	nat_traversal=yes
+	virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:!192.0.1.0/24,%v6:!2001:db8:0:1::/64
+	protostack=netkey
+
+conn westnet-eastnet-ipv4-psk-ikev2
+	also=westnet-eastnet-ipv4-psk
+	ikev2=insist
+
+include	/testing/baseconfigs/all/etc/ipsec.d/ipsec.conf.common
+
diff --git a/testing/pluto/ikev2-45-impair-gx/west.console.txt b/testing/pluto/ikev2-45-impair-gx/west.console.txt
new file mode 100644
index 0000000000..b83e8ea99d
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/west.console.txt
@@ -0,0 +1,81 @@
+/testing/guestbin/swan-prep
+west #
+ ipsec setup start
+Redirecting to: systemctl start ipsec.service
+west #
+ /testing/pluto/bin/wait-until-pluto-started
+west #
+ ipsec whack --debug-all --impair-send-zero-gx --impair-retransmits
+west #
+ ipsec auto --add westnet-eastnet-ipv4-psk-ikev2
+002 added connection description "westnet-eastnet-ipv4-psk-ikev2"
+west #
+ echo "initdone"
+initdone
+west #
+ ipsec auto --up  westnet-eastnet-ipv4-psk-ikev2
+002 "westnet-eastnet-ipv4-psk-ikev2" #1: initiating v2 parent SA
+133 "westnet-eastnet-ipv4-psk-ikev2" #1: STATE_PARENT_I1: initiate
+002 "westnet-eastnet-ipv4-psk-ikev2" #1: sending bogus g^x == 0 value to break DH calculations because impair-send-zero-gx was set
+133 "westnet-eastnet-ipv4-psk-ikev2" #1: STATE_PARENT_I1: sent v2I1, expected v2R1
+002 "westnet-eastnet-ipv4-psk-ikev2" #1: supressing retransmit because IMPAIR_RETRANSMITS is set.
+217 "westnet-eastnet-ipv4-psk-ikev2" #1: STATE_PARENT_I1: v2N_INVALID_KE_PAYLOAD
+003 "westnet-eastnet-ipv4-psk-ikev2" #1: EXPECTATION FAILED at /source/programs/pluto/ikev2.c:1823: st != NULL && st->st_event != NULL && st->st_event->ev_type == EVENT_v2_RETRANSMIT
+west #
+ echo done
+done
+west #
+ ipsec look
+west NOW
+XFRM state:
+XFRM policy:
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+XFRM done
+IPSEC mangle TABLES
+NEW_IPSEC_CONN mangle TABLES
+ROUTING TABLES
+default via 192.1.2.254 dev eth1 
+192.0.1.0/24 dev eth0  proto kernel  scope link  src 192.0.1.254 
+192.0.2.0/24 via 192.1.2.23 dev eth1 
+192.1.2.0/24 dev eth1  proto kernel  scope link  src 192.1.2.45 
+192.9.4.0/24 dev eth2  proto kernel  scope link  src 192.9.4.45 
+NSS_CERTIFICATES
+Certificate Nickname                                         Trust Attributes
+                                                             SSL,S/MIME,JAR/XPI
+west #
+west #
+ if [ -n "`ls /tmp/core* 2>/dev/null`" ]; then echo CORE FOUND; mv /tmp/core* OUTPUT/; fi
+west #
+ if [ -f /sbin/ausearch ]; then ausearch -r -m avc -ts recent ; fi
+
diff --git a/testing/pluto/ikev2-45-impair-gx/west.secrets b/testing/pluto/ikev2-45-impair-gx/west.secrets
new file mode 100644
index 0000000000..f729a7ad98
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/west.secrets
@@ -0,0 +1 @@
+@west @east : PSK "ABCDEFGHIJ12345"
diff --git a/testing/pluto/ikev2-45-impair-gx/westinit.sh b/testing/pluto/ikev2-45-impair-gx/westinit.sh
new file mode 100644
index 0000000000..8e672bd42f
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/westinit.sh
@@ -0,0 +1,6 @@
+/testing/guestbin/swan-prep
+ipsec setup start
+/testing/pluto/bin/wait-until-pluto-started
+ipsec whack --debug-all --impair-send-zero-gx --impair-retransmits
+ipsec auto --add westnet-eastnet-ipv4-psk-ikev2
+echo "initdone"
diff --git a/testing/pluto/ikev2-45-impair-gx/westrun.sh b/testing/pluto/ikev2-45-impair-gx/westrun.sh
new file mode 100644
index 0000000000..8e56f02723
--- /dev/null
+++ b/testing/pluto/ikev2-45-impair-gx/westrun.sh
@@ -0,0 +1,2 @@
+ipsec auto --up  westnet-eastnet-ipv4-psk-ikev2
+echo done
