libreswan__libreswan
commit 654b796f18f49e39147c75d8a2fed51a5ab32ee3
Author:     Paul Wouters <paul@xelerance.com>
AuthorDate: Fri Jun 19 17:29:45 2009 -0400
Commit:     Paul Wouters <paul@xelerance.com>
CommitDate: Fri Jun 19 17:29:45 2009 -0400

    port of commit 3b7011d017a
    
    Author: Paul Wouters <paul@xelerance.com>
    Date:   Mon Mar 30 09:11:06 2009 -0400
    
    Fix for a deadly 1 packet crasher in the DPD processing code. This bug
    is severe and has been assigned CVE-2009-0790. All versions of Openswan,
    Superfreeswan and Strongswan to date suffered from this bug. If the
    icookie/rcookie did not match for a DPD R_U_THERE or R_U_THERE_ACK, the
    pluto daemon would crash (and restart). This can be abused in a denial of
    service attack.

diff --git a/programs/pluto/demux.c b/programs/pluto/demux.c
index 3c9c369a7d..eb0bdf7f2f 100644
--- a/programs/pluto/demux.c
+++ b/programs/pluto/demux.c
@@ -1069,9 +1069,17 @@ informational(struct msg_digest *md)
         switch (n->isan_type)
         {
         case R_U_THERE:
+	   if(st==NULL) {
+		loglog(RC_LOG_SERIOUS, "received bogus  R_U_THERE informational message");
+		return STF_IGNORE;
+	   }
             return dpd_inI_outR(st, n, n_pbs);
 
         case R_U_THERE_ACK:
+	   if(st==NULL) {
+		loglog(RC_LOG_SERIOUS, "received bogus  R_U_THERE informational message");
+		return STF_IGNORE;
+	   }
             return dpd_inR(st, n, n_pbs);
 
 	case PAYLOAD_MALFORMED:
