rsyslog__rsyslog
commit 7b87f9143689c8c2cec3864258c7356490119e7f
Author:     Rainer Gerhards <rgerhards@adiscon.com>
AuthorDate: Tue Sep 16 10:19:38 2014 +0200
Commit:     Rainer Gerhards <rgerhards@adiscon.com>
CommitDate: Tue Sep 16 10:19:38 2014 +0200

    bugfix: improper handling of invalid PRI values
    
    references: CVE-2014-3634

diff --git a/ChangeLog b/ChangeLog
index cc7181416..f55a2e834 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -8,6 +8,8 @@ Version 3.22.4 [v3-stable] (rgerhards), 2010-??-??
   closes: http://bugzilla.adiscon.com/show_bug.cgi?id=271
 - improved some code based on clang static analyzer results
 - bugfix: potential misadressing in property replacer
+- bugfix: improper handling of invalid PRI values
+  references: CVE-2014-3634
 ---------------------------------------------------------------------------
 Version 3.22.3 [v3-stable] (rgerhards), 2010-11-24
 - bugfix(important): problem in TLS handling could cause rsyslog to loop
diff --git a/runtime/rsyslog.h b/runtime/rsyslog.h
index 9ce582105..87962be0f 100644
--- a/runtime/rsyslog.h
+++ b/runtime/rsyslog.h
@@ -3,7 +3,7 @@
  *
  * Begun 2005-09-15 RGerhards
  *
- * Copyright (C) 2005-2008 by Rainer Gerhards and Adiscon GmbH
+ * Copyright (C) 2005-2014 by Rainer Gerhards and Adiscon GmbH
  *
  * This file is part of the rsyslog runtime library.
  *
@@ -53,9 +53,14 @@
 #ifndef LOG_PRI
 #	define	LOG_PRI(p)	((p) & LOG_PRIMASK)
 #endif
-#ifndef LOG_FAC
-#	define	LOG_FAC(p)	(((p) & LOG_FACMASK) >> 3)
-#endif
+#undef LOG_FAC
+/* we need to use a function to avoid side-effects. This MUST guard
+ * against invalid facility values. rgerhards, 2014-09-16
+inline int LOG_FAC(int pri)
+{
+	int fac = pri >> 3;
+	return (fac > 23) ? 23 : fac;
+}
 
 
 /* define some base data types */
