bitrig__bitrig-xenocara
commit 0af569d6d547420e8039b0c69cc8ae7529ecc7a7
Author:     matthieu <matthieu@cvs.openbsd.org>
AuthorDate: Tue Oct 18 14:58:37 2011 +0000
Commit:     matthieu <matthieu@cvs.openbsd.org>
CommitDate: Tue Oct 18 14:58:37 2011 +0000

    Fix CVE-2011-4028: File disclosure vulnerability.
    use O_NOFOLLOW to open the existing lock file, so symbolic links
    aren't followed, thus avoid revealing if it point to an existing file.
    
    Note that xserver on OpenBSD isn't affected by CVE-2011-4029.

diff --git a/xserver/os/utils.c b/xserver/os/utils.c
index f45f9b4a4..c22828521 100644
--- a/xserver/os/utils.c
+++ b/xserver/os/utils.c
@@ -337,7 +337,7 @@ LockServer(void)
       /*
        * Read the pid from the existing file
        */
-      lfd = open(LockFile, O_RDONLY);
+      lfd = open(LockFile, O_RDONLY|O_NOFOLLOW);
       if (lfd < 0) {
         unlink(tmp);
         FatalError("Can't read lock file %s\n", LockFile);
