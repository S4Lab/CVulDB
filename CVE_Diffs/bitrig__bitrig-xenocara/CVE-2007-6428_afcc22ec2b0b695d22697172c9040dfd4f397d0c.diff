bitrig__bitrig-xenocara
commit afcc22ec2b0b695d22697172c9040dfd4f397d0c
Author:     matthieu <matthieu@cvs.openbsd.org>
AuthorDate: Thu Jan 17 15:43:07 2008 +0000
Commit:     matthieu <matthieu@cvs.openbsd.org>
CommitDate: Thu Jan 17 15:43:07 2008 +0000

    Fix from X.Org for CVE-2007-6428 - TOG-cup extension memory corruption.

diff --git a/xserver/Xext/cup.c b/xserver/Xext/cup.c
index 10d13bae0..781b9ce2b 100644
--- a/xserver/Xext/cup.c
+++ b/xserver/Xext/cup.c
@@ -196,6 +196,9 @@ int ProcGetReservedColormapEntries(
 
     REQUEST_SIZE_MATCH (xXcupGetReservedColormapEntriesReq);
 
+    if (stuff->screen >= screenInfo.numScreens)
+	return BadValue;
+
 #ifndef HAVE_SPECIAL_DESKTOP_COLORS
     citems[CUP_BLACK_PIXEL].pixel = 
 	screenInfo.screens[stuff->screen]->blackPixel;
@@ -227,7 +230,7 @@ int ProcStoreColors(
 
     REQUEST_AT_LEAST_SIZE (xXcupStoreColorsReq);
     pcmp = (ColormapPtr) SecurityLookupIDByType (client, stuff->cmap,
-						 RT_COLORMAP, SecurityWriteAccess);
+						 RT_COLORMAP, DixWriteAccess);
 
     if (pcmp) {
 	int ncolors, n;
