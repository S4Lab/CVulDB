bitrig__bitrig-xenocara
commit 65bed49a44d76ec97602605716f978ae15eba35b
Author:     matthieu <matthieu@cvs.openbsd.org>
AuthorDate: Tue Jan 6 20:10:22 2009 +0000
Commit:     matthieu <matthieu@cvs.openbsd.org>
CommitDate: Tue Jan 6 20:10:22 2009 +0000

    xterm 238. includes fix for CVE-2008-2383.

diff --git a/app/xterm/INSTALL b/app/xterm/INSTALL
index 4be14a52a..1485bfb16 100644
--- a/app/xterm/INSTALL
+++ b/app/xterm/INSTALL
@@ -1,7 +1,6 @@
--- $XTermId: INSTALL,v 1.107 2006/07/15 12:10:28 tom Exp $
--- $XFree86: xc/programs/xterm/INSTALL,v 3.42 2006/02/13 01:14:57 dickey Exp $
+-- $XTermId: INSTALL,v 1.118 2008/12/30 11:43:45 tom Exp $
 -------------------------------------------------------------------------------
--- Copyright 1997-2005,2006 by Thomas E. Dickey
+-- Copyright 1997-2007,2008 by Thomas E. Dickey
 --
 --                         All Rights Reserved
 --
@@ -127,6 +126,15 @@ The options (in alphabetic order):
   	Do not compile-in code that sets the default value of the colorMode
 	resource to ``true''.
 
+  --disable-desktop       disable install of xterm desktop files
+
+	Do not install the xterm desktop files, used in menus.
+	These use the icons installed in the --with-icondir option.
+	Use the environment variable $DESKTOP_FLAGS to supply options
+	required by desktop-file-install.
+
+	Note: If desktop-utils is not found they will not be installed anyway.
+
   --disable-doublechars   disable support for double-size chars
 
   	Do not compile-in code that supports font-manipulation needed to
@@ -213,12 +221,23 @@ The options (in alphabetic order):
 
 	(The same ifdef controls the metaSendsEscape support).
 
+  --disable-paste64       disable support for bracketed paste mode
+
+	Do not compile-in code to support experimental bracketed paste mode,
+	i.e., provide functions for setting/getting the selection data.
+
+	(see ctlseqs.ms description of OSC 52).
+
   --disable-pty-handshake disable support for pty handshakes
 
 	This feature is used to ensure that the child process's terminal modes
 	match the parent's.  In particular, it addresses a problem where the
 	terminal size is not defined in the stty settings.
 
+  --disable-rectangles    disable VT420 rectangle support
+
+	Do not compile-in code to support VT420 rectangle control-sequences.
+
   --disable-regex         disable regular-expression selections
 
 	Do not compile-in code to support the "regex" option for multiple
@@ -240,17 +259,36 @@ The options (in alphabetic order):
 
   --disable-session-mgt   enable support for session management
 
-	Do not compile-in code which adds simple session management hooks which
-	are used when closing an xterm.  Normally the code is compiled-in,
-	except for systems which do not support it.
+	Do not compile-in code which adds simple session management hooks
+	which are used when closing an xterm.  Normally the code is
+	compiled-in, except for systems which do not support it.
+
+  --disable-setgid        disable setgid
 
-  --disable-setuid        disable setuid/setgid
+	Do not install xterm using setuid/setgid permissions.  Drop setgid
+	permissions on startup.
 
-	Do not install xterm using setuid or setgid permissions.  Drop setuid
-	and setgid permissions on startup.  This is done if you have linked
-	xterm with the utempter library, but may also be useful for systems
-	where the pseudoterminal and utmp interfaces are wrapped so that xterm
-	does not require these permissions.
+  --disable-setuid        disable setuid
+
+	Do not install xterm using setuid/setgid permissions.  Drop setuid
+	permissions on startup.
+
+  --disable-sun-fkeys
+
+  	Do not compile-in code to support Sun-style function keys.
+
+  --disable-tcap-fkeys    disable termcap function-keys
+
+	Do not compile-in code to support feature which allows xterm to use the
+	function-key definitions from the termcap/terminfo entry which it used
+	to set the $TERM variable on startup.
+
+  --disable-tcap-query    disable termcap query/report
+
+	Do not compile-in code to support DCS '+' control sequence, which
+	allows an application to ask xterm what control sequences it would
+	transmit for specified function keys, given the termcap or terminfo
+	names.
 
   --disable-tek4014       disable tek4014 emulation
 
@@ -313,6 +351,14 @@ The options (in alphabetic order):
 	This allows the xterm mouse to be used with applications that use the
 	DEC Locator sequences, such as VAX Tpu, or SMG$ based applications.
 
+  --enable-exec-xterm     enable "spawn-new-terminal" action
+
+  	If your platform supports the process filesystem "cwd" link,
+	compile-in support for the "spawn-new-terminal" action, which
+	allows you to define a key translation that runs a new xterm
+	using the same working directory as the current process within
+	xterm.
+
   --enable-hp-fkeys       enable support for HP-style function keys
 
   	Compile-in code to support HP-style function keys.
@@ -367,13 +413,6 @@ The options (in alphabetic order):
 
 		configure --disable-imake --disable-narrowproto
 
-  --enable-paste64        enable support for bracketed paste mode
-
-	Compile-in code to support experimental bracketed paste mode, i.e.,
-	provide functions for setting/getting the selection data.
-
-	(see ctlseqs.ms description of OSC 52).
-
   --enable-readline-mouse enable support for mouse in readline applications
 
 	Compile-in code to support experimental bracketed paste mode, i.e.,
@@ -391,13 +430,6 @@ The options (in alphabetic order):
 
   	Compile-in code to support Sun-style function keys.
 
-  --enable-tcap-query     enable termcap query/report
-
-	Compile-in code to support experimental DCS '+' control sequence, which
-	allows an application to ask xterm what control sequences it would
-	transmit for specified function keys, given the termcap or terminfo
-	names.
-
   --enable-toolbar        enable pulldown menus on toolbar
 
   	Compile-in code that builds a toolbar with pulldown menus.  The
@@ -467,6 +499,9 @@ The options (in alphabetic order):
 	/usr/local, you should use this option to customize the location to
 	match your system configuration.
 
+	Use --without-app-defaults or --with-app-defaults=no to disable the
+	feature.
+
   --with-freetype-cflags  -D/-I options for compiling with FreeType library
 
 	Override options provided by xft-config or freetype-config.
@@ -475,6 +510,19 @@ The options (in alphabetic order):
 
 	Override options provided by xft-config or freetype-config.
 
+  --with-icondir=DIR directory in which to install icon files (default: EPREFIX/share/pixmaps)
+
+	The X libraries may automatically search these locations:
+
+	$HOME/.icons
+	$XDG_DATA_DIRS/icons
+	/usr/share/pixmaps
+
+	See also
+	http://standards.freedesktop.org/icon-theme-spec/icon-theme-spec-latest.html
+
+	Use --without-icondir or --with-icondir=no to disable the feature.
+
   --with-neXtaw           link with neXT Athena library
 
   	Look for, compile and link with the neXT Athena widget library.
@@ -577,7 +625,7 @@ The options (in alphabetic order):
 	On systems with Unix98 pty's, xterm can use this library when
 	available so it need not be installed set-uid.
 
-  --with-utmp-setgid      use setgid for access to utmp
+  --with-utmp-setgid=XXX  use setgid for access to utmp
 
 	The option value specifies a group to use when installing.
 	xterm will be installed with setgid privilege to this group.
@@ -585,3 +633,5 @@ The options (in alphabetic order):
 	after opening the pseudo-terminal, and will have only the
 	group privilege needed to access the utmp file.  This relies
 	on having POSIX setuid behavior.
+
+-- vile:txtmode
diff --git a/app/xterm/MANIFEST b/app/xterm/MANIFEST
index 255c8b02d..f8d132ad8 100644
--- a/app/xterm/MANIFEST
+++ b/app/xterm/MANIFEST
@@ -1,4 +1,4 @@
-MANIFEST for xterm-237, version xterm-237
+MANIFEST for xterm-238, version xterm-238
 --------------------------------------------------------------------------------
 MANIFEST                        this file
 256colres.h                     resource-definitions for 256-color mode
diff --git a/app/xterm/aclocal.m4 b/app/xterm/aclocal.m4
index e4152999f..f75e048d0 100644
--- a/app/xterm/aclocal.m4
+++ b/app/xterm/aclocal.m4
@@ -1,4 +1,4 @@
-dnl $XTermId: aclocal.m4,v 1.253 2008/07/27 15:28:15 tom Exp $
+dnl $XTermId: aclocal.m4,v 1.254 2008/12/30 17:01:41 tom Exp $
 dnl
 dnl $XFree86: xc/programs/xterm/aclocal.m4,v 3.65 2006/06/19 00:36:50 dickey Exp $
 dnl
@@ -276,13 +276,14 @@ AC_TRY_LINK([#include <stdio.h>],[printf("Hello world");],,
 fi
 ])dnl
 dnl ---------------------------------------------------------------------------
-dnl CF_CHECK_ERRNO version: 9 updated: 2001/12/30 18:03:23
+dnl CF_CHECK_ERRNO version: 10 updated: 2008/08/22 16:33:22
 dnl --------------
 dnl Check for data that is usually declared in <stdio.h> or <errno.h>, e.g.,
 dnl the 'errno' variable.  Define a DECL_xxx symbol if we must declare it
 dnl ourselves.
 dnl
 dnl $1 = the name to check
+dnl $2 = the assumed type
 AC_DEFUN([CF_CHECK_ERRNO],
 [
 AC_CACHE_CHECK(if external $1 is declared, cf_cv_dcl_$1,[
@@ -293,7 +294,7 @@ AC_CACHE_CHECK(if external $1 is declared, cf_cv_dcl_$1,[
 #include <stdio.h>
 #include <sys/types.h>
 #include <errno.h> ],
-    [long x = (long) $1],
+    ifelse($2,,int,$2) x = (ifelse($2,,int,$2)) $1,
     [cf_cv_dcl_$1=yes],
     [cf_cv_dcl_$1=no])
 ])
@@ -304,7 +305,7 @@ if test "$cf_cv_dcl_$1" = no ; then
 fi
 
 # It's possible (for near-UNIX clones) that the data doesn't exist
-CF_CHECK_EXTERN_DATA($1,int)
+CF_CHECK_EXTERN_DATA($1,ifelse($2,,int,$2))
 ])dnl
 dnl ---------------------------------------------------------------------------
 dnl CF_CHECK_EXTERN_DATA version: 3 updated: 2001/12/30 18:03:23
@@ -2320,7 +2321,7 @@ int x = XkbBI_Info
 test "$cf_cv_xkb_bell_ext" = yes && AC_DEFINE(HAVE_XKB_BELL_EXT)
 ])
 dnl ---------------------------------------------------------------------------
-dnl CF_XOPEN_SOURCE version: 26 updated: 2008/07/27 11:26:57
+dnl CF_XOPEN_SOURCE version: 28 updated: 2008/12/27 12:30:03
 dnl ---------------
 dnl Try to get _XOPEN_SOURCE defined properly that we can use POSIX functions,
 dnl or adapt to the vendor's definitions to get equivalent functionality,
@@ -2337,7 +2338,7 @@ cf_XOPEN_SOURCE=ifelse($1,,500,$1)
 cf_POSIX_C_SOURCE=ifelse($2,,199506L,$2)
 
 case $host_os in #(vi
-aix[[45]]*) #(vi
+aix[[456]]*) #(vi
 	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
 	;;
 freebsd*|dragonfly*) #(vi
@@ -2354,7 +2355,7 @@ hpux*) #(vi
 irix[[56]].*) #(vi
 	CPPFLAGS="$CPPFLAGS -D_SGI_SOURCE"
 	;;
-linux*|gnu*|k*bsd*-gnu) #(vi
+linux*|gnu*|mint*|k*bsd*-gnu) #(vi
 	CF_GNU_SOURCE
 	;;
 mirbsd*) #(vi
diff --git a/app/xterm/button.c b/app/xterm/button.c
index 3cc179860..6f5f3b1c4 100644
--- a/app/xterm/button.c
+++ b/app/xterm/button.c
@@ -1,4 +1,4 @@
-/* $XTermId: button.c,v 1.288 2008/07/27 19:36:37 tom Exp $ */
+/* $XTermId: button.c,v 1.297 2008/10/05 23:32:52 tom Exp $ */
 
 /*
  * Copyright 1999-2007,2008 by Thomas E. Dickey
@@ -106,7 +106,8 @@ button.c	Handles button events in the terminal emulator.
 
 #define KeyModifiers (event->xbutton.state & OurModifiers)
 
-#define KeyState(x) (((x) & (ShiftMask|ControlMask)) + (((x) & Mod1Mask) ? 2 : 0))
+#define KeyState(x) (((int) ((x) & (ShiftMask|ControlMask))) \
+			  + (((x) & Mod1Mask) ? 2 : 0))
     /* adds together the bits:
        shift key -> 1
        meta key  -> 2
@@ -204,6 +205,9 @@ SendMousePosition(XtermWidget xw, XEvent * event)
     case BTN_EVENT_MOUSE:
     case ANY_EVENT_MOUSE:
 	if (KeyModifiers == 0 || KeyModifiers == ControlMask) {
+	    if (event->type == MotionNotify) {
+		((XButtonEvent *) event)->button = 0;
+	    }
 	    EditorButton(xw, (XButtonEvent *) event);
 	    return True;
 	}
@@ -249,7 +253,7 @@ SendLocatorPosition(XtermWidget xw, XEvent * event)
     int row, col;
     Bool oor;
     int button;
-    int state;
+    unsigned state;
 
     /* Make sure the event is an appropriate type */
     if ((event->type != ButtonPress &&
@@ -311,10 +315,10 @@ SendLocatorPosition(XtermWidget xw, XEvent * event)
     reply.a_nparam = 4;
     switch (event->type) {
     case ButtonPress:
-	reply.a_param[0] = 2 + (button << 1);
+	reply.a_param[0] = (ParmType) (2 + (button << 1));
 	break;
     case ButtonRelease:
-	reply.a_param[0] = 3 + (button << 1);
+	reply.a_param[0] = (ParmType) (3 + (button << 1));
 	break;
     default:
 	return (True);
@@ -333,9 +337,9 @@ SendLocatorPosition(XtermWidget xw, XEvent * event)
     state ^= 1 << button;	/* update mask to "after" state */
     state = (state & ~(4 | 1)) | ((state & 1) ? 4 : 0) | ((state & 4) ? 1 : 0);		/* swap Button1 & Button3 */
 
-    reply.a_param[1] = state;
-    reply.a_param[2] = row;
-    reply.a_param[3] = col;
+    reply.a_param[1] = (ParmType) state;
+    reply.a_param[2] = (ParmType) row;
+    reply.a_param[3] = (ParmType) col;
     reply.a_inters = '&';
     reply.a_final = 'w';
 
@@ -425,9 +429,9 @@ GetLocatorPosition(XtermWidget xw)
 
     reply.a_nparam = 4;
     reply.a_param[0] = 1;	/* Event - 1 = response to locator request */
-    reply.a_param[1] = state;
-    reply.a_param[2] = row;
-    reply.a_param[3] = col;
+    reply.a_param[1] = (ParmType) state;
+    reply.a_param[2] = (ParmType) row;
+    reply.a_param[3] = (ParmType) col;
     reply.a_inters = '&';
     reply.a_final = 'w';
     unparseseq(xw, &reply);
@@ -537,9 +541,9 @@ InitLocatorFilter(XtermWidget xw)
 	reply.a_type = ANSI_CSI;
 	reply.a_nparam = 4;
 	reply.a_param[0] = 10;	/* Event - 10 = locator outside filter */
-	reply.a_param[1] = state;
-	reply.a_param[2] = row;
-	reply.a_param[3] = col;
+	reply.a_param[1] = (ParmType) state;
+	reply.a_param[2] = (ParmType) row;
+	reply.a_param[3] = (ParmType) col;
 	reply.a_inters = '&';
 	reply.a_final = 'w';
 	unparseseq(xw, &reply);
@@ -594,9 +598,9 @@ CheckLocatorPosition(XtermWidget xw, XEvent * event)
 
 	    reply.a_nparam = 4;
 	    reply.a_param[0] = 10;	/* Event - 10 = locator outside filter */
-	    reply.a_param[1] = state;
-	    reply.a_param[2] = row;
-	    reply.a_param[3] = col;
+	    reply.a_param[1] = (ParmType) state;
+	    reply.a_param[2] = (ParmType) row;
+	    reply.a_param[3] = (ParmType) col;
 	}
 
 	reply.a_inters = '&';
@@ -807,9 +811,13 @@ DiredButton(Widget w,
 	Char Line[6];
 	unsigned line, col;
 
-	if (event->type == ButtonPress || event->type == ButtonRelease) {
-	    line = (event->xbutton.y - screen->border) / FontHeight(screen);
-	    col = (event->xbutton.x - OriginX(screen)) / FontWidth(screen);
+	if ((event->type == ButtonPress || event->type == ButtonRelease)
+	    && (event->xbutton.y >= screen->border)
+	    && (event->xbutton.x >= OriginX(screen))) {
+	    line = ((unsigned) (event->xbutton.y - screen->border)
+		    / FontHeight(screen));
+	    col = ((unsigned) (event->xbutton.x - OriginX(screen))
+		   / FontWidth(screen));
 	    Line[0] = CONTROL('X');
 	    Line[1] = ANSI_ESC;
 	    Line[2] = 'G';
@@ -1080,19 +1088,19 @@ UTF8toLatin1(Char * s, unsigned len, unsigned long *result)
 	    } else {
 		unsigned eqv = ucs2dec(value);
 		if (xtermIsDecGraphic(eqv)) {
-		    *q++ = DECtoASCII(eqv);
+		    *q++ = (Char) DECtoASCII(eqv);
 		} else {
 		    eqv = AsciiEquivs(value);
 		    if (eqv == value)
 			eqv = '#';
-		    *q++ = eqv;
+		    *q++ = (Char) eqv;
 		    if (iswide((wchar_t) value))
 			*q++ = ' ';
 		}
 	    }
 	}
 	*q = 0;
-	*result = q - buffer;
+	*result = (unsigned long) (q - buffer);
     } else {
 	*result = 0;
     }
@@ -1437,18 +1445,20 @@ _qWriteSelectionData(TScreen * screen, Char * lag, unsigned length)
 	    switch (screen->base64_count) {
 	    case 0:
 		buf[x++] = CharOf(base64_code[*p >> 2]);
-		screen->base64_accu = (*p & 0x3);
+		screen->base64_accu = (unsigned) (*p & 0x3);
 		screen->base64_count = 2;
 		++p;
 		break;
 	    case 2:
-		buf[x++] = CharOf(base64_code[(screen->base64_accu << 4) + (*p >> 4)]);
-		screen->base64_accu = (*p & 0xF);
+		buf[x++] = CharOf(base64_code[(screen->base64_accu << 4) +
+					      (*p >> 4)]);
+		screen->base64_accu = (unsigned) (*p & 0xF);
 		screen->base64_count = 4;
 		++p;
 		break;
 	    case 4:
-		buf[x++] = CharOf(base64_code[(screen->base64_accu << 2) + (*p >> 6)]);
+		buf[x++] = CharOf(base64_code[(screen->base64_accu << 2) +
+					      (*p >> 6)]);
 		buf[x++] = CharOf(base64_code[*p & 0x3F]);
 		screen->base64_accu = 0;
 		screen->base64_count = 0;
@@ -1480,7 +1490,7 @@ _qWriteSelectionData(TScreen * screen, Char * lag, unsigned length)
 }
 
 static void
-_WriteSelectionData(TScreen * screen, Char * line, int length)
+_WriteSelectionData(TScreen * screen, Char * line, unsigned length)
 {
     /* Write data to pty a line at a time. */
     /* Doing this one line at a time may no longer be necessary
@@ -1634,7 +1644,7 @@ SelectionReceived(Widget w,
 			new_size += size + 1;
 		    }
 		    new_text_list =
-			(char **) XtMalloc(sizeof(char *) * text_list_count);
+			(char **) XtMalloc(sizeof(char *) * (unsigned) text_list_count);
 		    new_text_list[0] = tmp = XtMalloc(new_size);
 		    for (i = 0; i < text_list_count; ++i) {
 			data = (Char *) text_list[i];
@@ -1678,7 +1688,7 @@ SelectionReceived(Widget w,
 	}
 #endif
 	for (i = 0; i < text_list_count; i++) {
-	    int len = strlen(text_list[i]);
+	    unsigned len = strlen(text_list[i]);
 	    _WriteSelectionData(screen, (Char *) text_list[i], len);
 	}
 #if OPT_PASTE64
@@ -2621,7 +2631,7 @@ do_select_regex(TScreen * screen, CELL * startc, CELL * endc)
 						firstRow,
 						size,
 						indexed)) != 0) {
-		    int len = strlen(search);
+		    int len = (int) strlen(search);
 		    int col;
 		    int best_col = -1;
 		    int best_len = -1;
@@ -3036,7 +3046,7 @@ SaltTextAway(XtermWidget xw,
     TRACE(("Salted TEXT:%d:%s\n", lp - line,
 	   visibleChars(PAIRED_CHARS(line, 0), (unsigned) (lp - line))));
 
-    screen->selection_length = (lp - line);
+    screen->selection_length = (unsigned long) (lp - line);
     _OwnSelection(xw, params, num_params);
 }
 
@@ -3052,7 +3062,7 @@ static void
 AppendStrToSelectionBuffer(TScreen * screen, Char * text, unsigned len)
 {
     if (len != 0) {
-	int j = screen->selection_length + len;		/* New length */
+	int j = (int) (screen->selection_length + len);		/* New length */
 	int k = j + (j >> 2) + 80;	/* New size if we grow buffer: grow by ~50% */
 	if (j + 1 >= screen->selection_size) {
 	    if (!screen->selection_length) {
@@ -3081,7 +3091,7 @@ AppendStrToSelectionBuffer(TScreen * screen, Char * text, unsigned len)
 void
 AppendToSelectionBuffer(TScreen * screen, unsigned c)
 {
-    int six;
+    unsigned six;
     Char ch;
 
     /* Decode base64 character */
@@ -3167,6 +3177,29 @@ _ConvertSelectionHelper(Widget w,
     return False;
 }
 
+static Boolean
+SaveConvertedLength(XtPointer *target, unsigned long source)
+{
+    Boolean result = False;
+
+    *target = XtMalloc(4);
+    if (*target != 0) {
+	result = True;
+	if (sizeof(unsigned long) == 4) {
+	    *(unsigned long *) *target = source;
+	} else if (sizeof(unsigned) == 4) {
+	    *(unsigned *) *target = source;
+	} else if (sizeof(unsigned short) == 4) {
+	    *(unsigned short *) *target = (unsigned short) source;
+	} else {
+	    /* FIXME - does this depend on byte-order? */
+	    unsigned long temp = source;
+	    memcpy((char *) *target, ((char *) &temp) + sizeof(temp) - 4, 4);
+	}
+    }
+    return result;
+}
+
 static Boolean
 ConvertSelection(Widget w,
 		 Atom * selection,
@@ -3222,7 +3255,7 @@ ConvertSelection(Widget w,
 	    *targetP++ = XA_LENGTH(dpy);
 	    *targetP++ = XA_LIST_LENGTH(dpy);
 
-	    *length = std_length + (targetP - allocP);
+	    *length = std_length + (unsigned long) (targetP - allocP);
 
 	    memcpy(targetP, std_targets, sizeof(Atom) * std_length);
 	    XtFree((char *) std_targets);
@@ -3303,31 +3336,17 @@ ConvertSelection(Widget w,
 #endif
     else if (*target == XA_LIST_LENGTH(dpy)) {
 	TRACE(("ConvertSelection XA_LIST_LENGTH(dpy)\n"));
-	*value = XtMalloc(4);
-	if (sizeof(long) == 4)
-	     *(long *) *value = 1;
-	else {
-	    long temp = 1;
-	    memcpy((char *) *value, ((char *) &temp) + sizeof(long) - 4, 4);
-	}
+	result = SaveConvertedLength(value, 1);
 	*type = XA_INTEGER;
 	*length = 1;
 	*format = 32;
-	result = True;
     } else if (*target == XA_LENGTH(dpy)) {
 	TRACE(("ConvertSelection XA_LENGTH(dpy)\n"));
 	/* This value is wrong if we have UTF-8 text */
-	*value = XtMalloc(4);
-	if (sizeof(long) == 4) {
-	    *(long *) *value = screen->selection_length;
-	} else {
-	    long temp = screen->selection_length;
-	    memcpy((char *) *value, ((char *) &temp) + sizeof(long) - 4, 4);
-	}
+	result = SaveConvertedLength(value, screen->selection_length);
 	*type = XA_INTEGER;
 	*length = 1;
 	*format = 32;
-	result = True;
     } else if (XmuConvertStandardSelection(w,
 					   screen->selection_time, selection,
 					   target, type, (XPointer *) value,
@@ -3337,7 +3356,7 @@ ConvertSelection(Widget w,
     }
 
     /* else */
-    return result;
+    return (Boolean) result;
 }
 
 static void
@@ -3396,7 +3415,7 @@ _OwnSelection(XtermWidget xw,
     Cardinal i;
     Bool have_selection = False;
 
-    if (screen->selection_length < 0)
+    if (screen->selection_length == 0)
 	return;
 
     TRACE(("_OwnSelection\n"));
@@ -3412,10 +3431,11 @@ _OwnSelection(XtermWidget xw,
     for (i = 0; i < count; i++) {
 	int cutbuffer = CutBuffer(atoms[i]);
 	if (cutbuffer >= 0) {
-	    if (screen->selection_length >
-		4 * XMaxRequestSize(XtDisplay((Widget) xw)) - 32) {
+	    unsigned long limit =
+	    (unsigned long) (4 * XMaxRequestSize(XtDisplay((Widget) xw)) - 32);
+	    if (screen->selection_length > limit) {
 		fprintf(stderr,
-			"%s: selection too big (%d bytes), not storing in CUT_BUFFER%d\n",
+			"%s: selection too big (%ld bytes), not storing in CUT_BUFFER%d\n",
 			xterm_name, screen->selection_length, cutbuffer);
 	    } else {
 		/* This used to just use the UTF-8 data, which was totally
@@ -3536,7 +3556,7 @@ SaveText(TScreen * screen,
     unsigned c;
     Char *result = lp;
 #if OPT_WIDE_CHARS
-    int previous = 0;
+    unsigned previous = 0;
 #endif
 
     i = Length(screen, row, scol, ecol);
@@ -3554,7 +3574,7 @@ SaveText(TScreen * screen,
 	/* We want to strip out every occurrence of HIDDEN_CHAR AFTER a
 	 * wide character.
 	 */
-	if (c == HIDDEN_CHAR && iswide(previous)) {
+	if (c == HIDDEN_CHAR && iswide((int) previous)) {
 	    previous = c;
 	    /* Combining characters attached to double-width characters
 	       are in memory attached to the HIDDEN_CHAR */
@@ -3624,7 +3644,7 @@ SaveText(TScreen * screen,
 static Char
 BtnCode(XButtonEvent * event, int button)
 {
-    int result = 32 + (KeyState(event->state) << 2);
+    int result = (int) (32 + (KeyState(event->state) << 2));
 
     if (button < 0 || button > 5) {
 	result += 3;
@@ -3652,7 +3672,7 @@ EditorButton(XtermWidget xw, XButtonEvent * event)
     Boolean changed = True;
 
     /* If button event, get button # adjusted for DEC compatibility */
-    button = event->button - 1;
+    button = (int) (event->button - 1);
     if (button >= 3)
 	button++;
 
diff --git a/app/xterm/cachedGCs.c b/app/xterm/cachedGCs.c
index a72ef3f46..70dac4a78 100644
--- a/app/xterm/cachedGCs.c
+++ b/app/xterm/cachedGCs.c
@@ -1,4 +1,4 @@
-/* $XTermId: cachedGCs.c,v 1.48 2008/02/20 20:54:54 Julien.Cristau Exp $ */
+/* $XTermId: cachedGCs.c,v 1.49 2008/12/30 17:33:30 tom Exp $ */
 
 /************************************************************
 
@@ -396,16 +396,16 @@ newCache(XtermWidget xw, VTwin * cgsWin, CgsEnum cgsId, CgsCache * me)
 static Boolean
 HaveFont(XTermFonts * a)
 {
-    return (a != 0 && a->fs != 0);
+    return (Boolean) (a != 0 && a->fs != 0);
 }
 
 static Boolean
 SameFont(XTermFonts * a, XTermFonts * b)
 {
-    return (HaveFont(a)
-	    && HaveFont(b)
-	    && ((a->fs == b->fs)
-		|| !memcmp(a->fs, b->fs, sizeof(*(a->fs)))));
+    return (Boolean) (HaveFont(a)
+		      && HaveFont(b)
+		      && ((a->fs == b->fs)
+			  || !memcmp(a->fs, b->fs, sizeof(*(a->fs)))));
 }
 
 #define SameColor(a,b) ((a) == (b))
diff --git a/app/xterm/charclass.c b/app/xterm/charclass.c
index 33e27562a..8452842f8 100644
--- a/app/xterm/charclass.c
+++ b/app/xterm/charclass.c
@@ -1,4 +1,4 @@
-/* $XTermId: charclass.c,v 1.14 2006/02/13 01:14:58 tom Exp $ */
+/* $XTermId: charclass.c,v 1.21 2008/12/30 17:35:09 tom Exp $ */
 
 /*
  * Compact and efficient reimplementation of the
@@ -6,23 +6,23 @@
  *
  * Markus Kuhn -- mkuhn@acm.org -- 2000-07-03
  *
- * Xterm allows users to select entire words with a double-click on
- * the left mouse button. Opinions might differ on what type of
- * characters are part of separate words, therefore xterm allows users
- * to configure a class code for each 8-bit character. Words are
- * maximum length sequences of neighboring characters with identical
- * class code. Extending this mechanism to Unicode naively would
- * create an at least 2^16 entries (128 kB) long class code table.
- * Instead, we transform the character class table into a list
- * of intervals, that will be accessed via a linear search.
- * Changes made to the table by the user will be appended. A special
- * class code -1 (default) marks characters who have their code number
- * as the class code. We could alternatively use a sorted table of
- * non-overlapping intervals that can be accessed via binary search,
- * but merging in new intervals is significantly more hassle and
- * not worth the effort here.
+ * Xterm allows users to select entire words with a double-click on the left
+ * mouse button.  Opinions might differ on what type of characters are part of
+ * separate words, therefore xterm allows users to configure a class code for
+ * each 8-bit character.  Words are maximum length sequences of neighboring
+ * characters with identical class code.  Extending this mechanism to Unicode
+ * naively would create an at least 2^16 entries (128 kB) long class code
+ * table.
+ *
+ * Instead, we transform the character class table into a list of intervals,
+ * that will be accessed via a linear search.  Changes made to the table by the
+ * user will be appended.  A special class code IDENT (default) marks
+ * characters who have their code number as the class code.
+ *
+ * We could alternatively use a sorted table of non-overlapping intervals that
+ * can be accessed via binary search, but merging in new intervals is
+ * significantly more hassle and not worth the effort here.
  */
-/* $XFree86: xc/programs/xterm/charclass.c,v 1.7 2006/02/13 01:14:58 dickey Exp $ */
 
 #include <xterm.h>
 #include <charclass.h>
@@ -51,7 +51,7 @@ SetCharacterClassRange(int low, int high, int value)
     /* make sure we have at least one free entry left at table end */
     if (classtab[0].last > classtab[0].cclass - 2) {
 	classtab[0].cclass += 5 + classtab[0].cclass / 4;
-	classtab = TypeRealloc(struct classentry, classtab[0].cclass, classtab);
+	classtab = TypeRealloc(struct classentry, (unsigned) classtab[0].cclass, classtab);
 	if (!classtab)
 	    abort();
     }
@@ -65,6 +65,13 @@ SetCharacterClassRange(int low, int high, int value)
     return 0;
 }
 
+typedef enum {
+    IDENT = -1,
+    ALNUM = 48,
+    CNTRL = 1,
+    BLANK = 32
+} Classes;
+
 void
 init_classtab(void)
 {
@@ -78,48 +85,48 @@ init_classtab(void)
     classtab[0].last = 0;
 
     /* old xterm default classes */
-    SetCharacterClassRange(0, 0, 32);
-    SetCharacterClassRange(1, 31, 1);
-    SetCharacterClassRange('\t', '\t', 32);
-    SetCharacterClassRange('0', '9', 48);
-    SetCharacterClassRange('A', 'Z', 48);
-    SetCharacterClassRange('_', '_', 48);
-    SetCharacterClassRange('a', 'z', 48);
-    SetCharacterClassRange(127, 159, 1);
-    SetCharacterClassRange(160, 191, -1);
-    SetCharacterClassRange(192, 255, 48);
-    SetCharacterClassRange(215, 215, 216);
-    SetCharacterClassRange(247, 247, 248);
+    SetCharacterClassRange(0, 0, BLANK);
+    SetCharacterClassRange(1, 31, CNTRL);
+    SetCharacterClassRange('\t', '\t', BLANK);
+    SetCharacterClassRange('0', '9', ALNUM);
+    SetCharacterClassRange('A', 'Z', ALNUM);
+    SetCharacterClassRange('_', '_', ALNUM);
+    SetCharacterClassRange('a', 'z', ALNUM);
+    SetCharacterClassRange(127, 159, CNTRL);
+    SetCharacterClassRange(160, 191, IDENT);
+    SetCharacterClassRange(192, 255, ALNUM);
+    SetCharacterClassRange(215, 215, IDENT);
+    SetCharacterClassRange(247, 247, IDENT);
 
     /* added Unicode classes */
-    SetCharacterClassRange(0x0100, 0xffdf, 48);		/* mostly characters */
-    SetCharacterClassRange(0x037e, 0x037e, -1);		/* Greek question mark */
-    SetCharacterClassRange(0x0387, 0x0387, -1);		/* Greek ano teleia */
-    SetCharacterClassRange(0x055a, 0x055f, -1);		/* Armenian punctuation */
-    SetCharacterClassRange(0x0589, 0x0589, -1);		/* Armenian full stop */
-    SetCharacterClassRange(0x0700, 0x070d, -1);		/* Syriac punctuation */
-    SetCharacterClassRange(0x104a, 0x104f, -1);		/* Myanmar punctuation */
-    SetCharacterClassRange(0x10fb, 0x10fb, -1);		/* Georgian punctuation */
-    SetCharacterClassRange(0x1361, 0x1368, -1);		/* Ethiopic punctuation */
-    SetCharacterClassRange(0x166d, 0x166e, -1);		/* Canadian Syl. punctuation */
-    SetCharacterClassRange(0x17d4, 0x17dc, -1);		/* Khmer punctuation */
-    SetCharacterClassRange(0x1800, 0x180a, -1);		/* Mongolian punctuation */
-    SetCharacterClassRange(0x2000, 0x200a, 32);		/* spaces */
-    SetCharacterClassRange(0x200b, 0x27ff, -1);		/* punctuation and symbols */
+    SetCharacterClassRange(0x0100, 0xffdf, ALNUM);	/* mostly characters */
+    SetCharacterClassRange(0x037e, 0x037e, IDENT);	/* Greek question mark */
+    SetCharacterClassRange(0x0387, 0x0387, IDENT);	/* Greek ano teleia */
+    SetCharacterClassRange(0x055a, 0x055f, IDENT);	/* Armenian punctuation */
+    SetCharacterClassRange(0x0589, 0x0589, IDENT);	/* Armenian full stop */
+    SetCharacterClassRange(0x0700, 0x070d, IDENT);	/* Syriac punctuation */
+    SetCharacterClassRange(0x104a, 0x104f, IDENT);	/* Myanmar punctuation */
+    SetCharacterClassRange(0x10fb, 0x10fb, IDENT);	/* Georgian punctuation */
+    SetCharacterClassRange(0x1361, 0x1368, IDENT);	/* Ethiopic punctuation */
+    SetCharacterClassRange(0x166d, 0x166e, IDENT);	/* Canadian Syl. punctuation */
+    SetCharacterClassRange(0x17d4, 0x17dc, IDENT);	/* Khmer punctuation */
+    SetCharacterClassRange(0x1800, 0x180a, IDENT);	/* Mongolian punctuation */
+    SetCharacterClassRange(0x2000, 0x200a, BLANK);	/* spaces */
+    SetCharacterClassRange(0x200b, 0x27ff, IDENT);	/* punctuation and symbols */
     SetCharacterClassRange(0x2070, 0x207f, 0x2070);	/* superscript */
     SetCharacterClassRange(0x2080, 0x208f, 0x2080);	/* subscript */
-    SetCharacterClassRange(0x3000, 0x3000, 32);		/* ideographic space */
-    SetCharacterClassRange(0x3001, 0x3020, -1);		/* ideographic punctuation */
+    SetCharacterClassRange(0x3000, 0x3000, BLANK);	/* ideographic space */
+    SetCharacterClassRange(0x3001, 0x3020, IDENT);	/* ideographic punctuation */
     SetCharacterClassRange(0x3040, 0x309f, 0x3040);	/* Hiragana */
     SetCharacterClassRange(0x30a0, 0x30ff, 0x30a0);	/* Katakana */
     SetCharacterClassRange(0x3300, 0x9fff, 0x4e00);	/* CJK Ideographs */
     SetCharacterClassRange(0xac00, 0xd7a3, 0xac00);	/* Hangul Syllables */
     SetCharacterClassRange(0xf900, 0xfaff, 0x4e00);	/* CJK Ideographs */
-    SetCharacterClassRange(0xfe30, 0xfe6b, -1);		/* punctuation forms */
-    SetCharacterClassRange(0xff00, 0xff0f, -1);		/* half/fullwidth ASCII */
-    SetCharacterClassRange(0xff1a, 0xff20, -1);		/* half/fullwidth ASCII */
-    SetCharacterClassRange(0xff3b, 0xff40, -1);		/* half/fullwidth ASCII */
-    SetCharacterClassRange(0xff5b, 0xff64, -1);		/* half/fullwidth ASCII */
+    SetCharacterClassRange(0xfe30, 0xfe6b, IDENT);	/* punctuation forms */
+    SetCharacterClassRange(0xff00, 0xff0f, IDENT);	/* half/fullwidth ASCII */
+    SetCharacterClassRange(0xff1a, 0xff20, IDENT);	/* half/fullwidth ASCII */
+    SetCharacterClassRange(0xff3b, 0xff40, IDENT);	/* half/fullwidth ASCII */
+    SetCharacterClassRange(0xff5b, 0xff64, IDENT);	/* half/fullwidth ASCII */
 
     return;
 }
@@ -127,7 +134,7 @@ init_classtab(void)
 int
 CharacterClass(int c)
 {
-    int i, cclass = -1;
+    int i, cclass = IDENT;
 
     for (i = classtab[0].first; i <= classtab[0].last; i++)
 	if (classtab[i].first <= c && classtab[i].last >= c)
diff --git a/app/xterm/charproc.c b/app/xterm/charproc.c
index be9408a1f..ee592f481 100644
--- a/app/xterm/charproc.c
+++ b/app/xterm/charproc.c
@@ -1,4 +1,4 @@
-/* $XTermId: charproc.c,v 1.852 2008/09/14 21:27:54 tom Exp $ */
+/* $XTermId: charproc.c,v 1.865 2008/12/30 14:45:41 tom Exp $ */
 
 /*
 
@@ -389,6 +389,8 @@ static XtActionsRec actionsList[] = {
 static XtResource resources[] =
 {
     Bres(XtNallowSendEvents, XtCAllowSendEvents, screen.allowSendEvent0, False),
+    Bres(XtNallowFontOps, XtCAllowFontOps, screen.allowFontOp0, True),
+    Bres(XtNallowTcapOps, XtCAllowTcapOps, screen.allowTcapOp0, True),
     Bres(XtNallowTitleOps, XtCAllowTitleOps, screen.allowTitleOp0, True),
     Bres(XtNallowWindowOps, XtCAllowWindowOps, screen.allowWindowOp0, True),
     Bres(XtNaltIsNotMeta, XtCAltIsNotMeta, screen.alt_is_not_meta, False),
@@ -1236,8 +1238,8 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 
 	    WriteNow();
 
-	    prev = XTERM_CELL(screen->last_written_row,
-			      screen->last_written_col);
+	    prev = (int) XTERM_CELL(screen->last_written_row,
+				    screen->last_written_col);
 	    precomposed = do_precomposition(prev, (int) c);
 	    TRACE(("do_precomposition (U+%04X [%d], U+%04X [%d]) -> U+%04X [%d]\n",
 		   prev, my_wcwidth(prev),
@@ -1267,7 +1269,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 
 	/* Intercept characters for printer controller mode */
 	if (screen->printer_controlmode == 2) {
-	    if ((c = xtermPrinterControl((int) c)) == 0)
+	    if ((c = (unsigned) xtermPrinterControl((int) c)) == 0)
 		continue;
 	}
 
@@ -1279,7 +1281,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 #if OPT_VT52_MODE
 	if (sp->vt52_cup) {
 	    if (nparam < NPARAM)
-		param[nparam++] = (c & 0x7f) - 32;
+		param[nparam++] = (int) (c & 0x7f) - 32;
 	    if (nparam < 2)
 		continue;
 	    sp->vt52_cup = False;
@@ -1447,7 +1449,8 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 #endif
 	    print_area = new_string;
 	    print_size = new_length;
-	    print_area[print_used++] = sp->lastchar = thischar = c;
+	    print_area[print_used++] = c;
+	    sp->lastchar = thischar = (int) c;
 #if OPT_WIDE_CHARS
 	    sp->last_was_wide = iswide((int) c);
 #endif
@@ -1486,7 +1489,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 #endif
 	    string_area = new_string;
 	    string_size = new_length;
-	    string_area[string_used++] = c;
+	    string_area[string_used++] = CharOf(c);
 	} else if (sp->parsestate != esc_table) {
 	    /* if we were accumulating, we're not any more */
 	    sp->string_mode = 0;
@@ -1673,7 +1676,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 	    /* digit in csi or dec mode */
 	    if ((row = param[nparam - 1]) == DEFAULT)
 		row = 0;
-	    param[nparam - 1] = 10 * row + (c - '0');
+	    param[nparam - 1] = (10 * row) + ((int) c - '0');
 	    if (param[nparam - 1] > 65535)
 		param[nparam - 1] = 65535;
 	    if (sp->parsestate == csi_table)
@@ -1896,7 +1899,9 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 			break;
 		    }
 		} else {
-		    reply.a_param[count++] = 60 + screen->terminal_id / 100;
+		    reply.a_param[count++] = (ParmType) (60
+							 + screen->terminal_id
+							 / 100);
 		    reply.a_param[count++] = 1;		/* 132-columns */
 		    reply.a_param[count++] = 2;		/* printer */
 		    reply.a_param[count++] = 6;		/* selective-erase */
@@ -1913,7 +1918,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 		    reply.a_param[count++] = 29;	/* ANSI text locator */
 #endif
 		}
-		reply.a_nparam = count;
+		reply.a_nparam = (ParmType) count;
 		reply.a_inters = 0;
 		reply.a_final = 'c';
 		unparseseq(xw, &reply);
@@ -1934,7 +1939,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 		    reply.a_param[count++] = 0;		/* VT100 (nonstandard) */
 		reply.a_param[count++] = XTERM_PATCH;	/* Version */
 		reply.a_param[count++] = 0;	/* options (none) */
-		reply.a_nparam = count;
+		reply.a_nparam = (ParmType) count;
 		reply.a_inters = 0;
 		reply.a_final = 'c';
 		unparseseq(xw, &reply);
@@ -2177,7 +2182,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 	    TRACE(("CASE_CPR - cursor position\n"));
 	    count = 0;
 	    reply.a_type = ANSI_CSI;
-	    reply.a_pintro = sp->private_function ? '?' : 0;
+	    reply.a_pintro = CharOf(sp->private_function ? '?' : 0);
 	    reply.a_inters = 0;
 	    reply.a_final = 'n';
 
@@ -2189,38 +2194,48 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 	    case 6:
 		/* CPR */
 		/* DECXCPR (with page=0) */
-		reply.a_param[count++] = screen->cur_row + 1;
-		reply.a_param[count++] = screen->cur_col + 1;
+		reply.a_param[count++] = (ParmType) (screen->cur_row + 1);
+		reply.a_param[count++] = (ParmType) (screen->cur_col + 1);
 		reply.a_final = 'R';
 		break;
 	    case 15:
 		/* printer status */
-		reply.a_param[count++] = 13;	/* implement printer */
+		if (screen->terminal_id >= 200) {	/* VT220 */
+		    reply.a_param[count++] = 13;	/* implement printer */
+		}
 		break;
 	    case 25:
 		/* UDK status */
-		reply.a_param[count++] = 20;	/* UDK always unlocked */
+		if (screen->terminal_id >= 200) {	/* VT220 */
+		    reply.a_param[count++] = 20;	/* UDK always unlocked */
+		}
 		break;
 	    case 26:
 		/* keyboard status */
-		reply.a_param[count++] = 27;
-		reply.a_param[count++] = 1;	/* North American */
-		if (screen->terminal_id >= 400) {
-		    reply.a_param[count++] = 0;		/* ready */
-		    reply.a_param[count++] = 0;		/* LK201 */
+		if (screen->terminal_id >= 200) {	/* VT220 */
+		    reply.a_param[count++] = 27;
+		    reply.a_param[count++] = 1;		/* North American */
+		    if (screen->terminal_id >= 400) {
+			reply.a_param[count++] = 0;	/* ready */
+			reply.a_param[count++] = 0;	/* LK201 */
+		    }
 		}
 		break;
 	    case 53:
 		/* Locator status */
+		if (screen->terminal_id >= 200) {	/* VT220 */
 #if OPT_DEC_LOCATOR
-		reply.a_param[count++] = 50;	/* locator ready */
+		    reply.a_param[count++] = 50;	/* locator ready */
 #else
-		reply.a_param[count++] = 53;	/* no locator */
+		    reply.a_param[count++] = 53;	/* no locator */
 #endif
+		}
+		break;
+	    default:
 		break;
 	    }
 
-	    if ((reply.a_nparam = count) != 0)
+	    if ((reply.a_nparam = (ParmType) count) != 0)
 		unparseseq(xw, &reply);
 
 	    sp->parsestate = sp->groundtable;
@@ -2279,7 +2294,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 		    reply.a_type = ANSI_CSI;
 		    reply.a_pintro = 0;
 		    reply.a_nparam = 7;
-		    reply.a_param[0] = row + 2;
+		    reply.a_param[0] = (ParmType) (row + 2);
 		    reply.a_param[1] = 1;	/* no parity */
 		    reply.a_param[2] = 1;	/* eight bits */
 		    reply.a_param[3] = 128;	/* transmit 38.4k baud */
@@ -2328,7 +2343,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 	case CASE_GSETS:
 	    TRACE(("CASE_GSETS(%d) = '%c'\n", sp->scstype, c));
 	    if (screen->vtXX_level != 0)
-		screen->gsets[sp->scstype] = c;
+		screen->gsets[sp->scstype] = CharOf(c);
 	    sp->parsestate = sp->groundtable;
 	    break;
 
@@ -2785,7 +2800,7 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
 		sp->groundtable[E2A(sp->lastchar)] == CASE_PRINT) {
 		IChar repeated[2];
 		count = (param[0] < 1) ? 1 : param[0];
-		repeated[0] = sp->lastchar;
+		repeated[0] = (IChar) sp->lastchar;
 		while (count-- > 0) {
 		    dotext(xw,
 			   screen->gsets[(int) (screen->curgl)],
@@ -2907,8 +2922,8 @@ doparsing(XtermWidget xw, unsigned c, struct ParseState *sp)
     } while (0);
 
 #if OPT_WIDE_CHARS
-    screen->utf8_inparse = (screen->utf8_mode != uFalse
-			    && sp->parsestate != sos_table);
+    screen->utf8_inparse = (Boolean) ((screen->utf8_mode != uFalse)
+				      && (sp->parsestate != sos_table));
 #endif
 
     return True;
@@ -3001,7 +3016,7 @@ v_write(int f, Char * data, unsigned len)
 	    if (v_bufend < v_bufptr + len) {
 		/* still won't fit: get more space */
 		/* Don't use XtRealloc because an error is not fatal. */
-		int size = v_bufptr - v_buffer;		/* save across realloc */
+		unsigned size = (unsigned) (v_bufptr - v_buffer);
 		v_buffer = TypeRealloc(Char, size + len, v_buffer);
 		if (v_buffer) {
 #ifdef DEBUG
@@ -3102,7 +3117,7 @@ v_write(int f, Char * data, unsigned len)
 	    v_buffer = v_bufstr - start;	/* restore clobbered pointer */
 	}
     }
-    return (c);
+    return ((int) c);
 }
 
 #ifdef VMS
@@ -3376,8 +3391,8 @@ PreeditPosition(TScreen * screen)
 
     if (!screen->xic)
 	return;
-    spot.x = CurCursorX(screen, screen->cur_row, screen->cur_col);
-    spot.y = CursorY(screen, screen->cur_row) + screen->fs_ascent;
+    spot.x = (short) CurCursorX(screen, screen->cur_row, screen->cur_col);
+    spot.y = (short) (CursorY(screen, screen->cur_row) + screen->fs_ascent);
     list = XVaCreateNestedList(0,
 			       XNSpotLocation, &spot,
 			       XNForeground, T_COLOR(screen, TEXT_FG),
@@ -3445,12 +3460,12 @@ dotext(XtermWidget xw,
 	 offset += chars_chomped) {
 	int width_available = MaxCols(screen) - screen->cur_col;
 	int width_here = 0;
-	int need_wrap = 0;
+	Boolean need_wrap = False;
 	int last_chomp = 0;
 	chars_chomped = 0;
 
 	if (screen->do_wrap) {
-	    screen->do_wrap = 0;
+	    screen->do_wrap = False;
 	    if ((xw->flags & WRAPAROUND)) {
 		WrapLine(xw);
 		width_available = MaxCols(screen) - screen->cur_col;
@@ -3474,12 +3489,12 @@ dotext(XtermWidget xw,
 	    chars_chomped--;
 	    width_here -= last_chomp;
 	    if (chars_chomped > 0) {
-		need_wrap = 1;
+		need_wrap = True;
 	    }
 	} else if (width_here == width_available) {
-	    need_wrap = 1;
+	    need_wrap = True;
 	} else if (chars_chomped != (len - offset)) {
-	    need_wrap = 1;
+	    need_wrap = True;
 	}
 
 	/*
@@ -3537,7 +3552,7 @@ dotext(XtermWidget xw,
 	this_col = last_col - screen->cur_col + 1;
 	if (this_col <= 1) {
 	    if (screen->do_wrap) {
-		screen->do_wrap = 0;
+		screen->do_wrap = False;
 		if ((xw->flags & WRAPAROUND)) {
 		    WrapLine(xw);
 		}
@@ -3570,7 +3585,7 @@ visual_width(PAIRED_CHARS(Char * str, Char * str2), Cardinal len)
 {
     /* returns the visual width of a string (doublewide characters count
        as 2, normalwide characters count as 1) */
-    int my_len = 0;
+    unsigned my_len = 0;
     while (len) {
 	int ch = *str;
 	if (str2)
@@ -3673,9 +3688,9 @@ HandleStructNotify(Widget w GCC_UNUSED,
 			 */
 			REQ_RESIZE((Widget) xw,
 				   screen->fullVwin.fullwidth,
-				   info->menu_height
-				   - save.menu_height
-				   + screen->fullVwin.fullheight,
+				   (Dimension) (info->menu_height
+						- save.menu_height
+						+ screen->fullVwin.fullheight),
 				   NULL, NULL);
 			repairSizeHints();
 		    }
@@ -3700,7 +3715,7 @@ HandleStructNotify(Widget w GCC_UNUSED,
 
 #if OPT_BLINK_CURS
 static void
-SetCursorBlink(TScreen * screen, int enable)
+SetCursorBlink(TScreen * screen, Boolean enable)
 {
     screen->cursor_blink = enable;
     if (DoStartBlinking(screen)) {
@@ -3716,7 +3731,7 @@ SetCursorBlink(TScreen * screen, int enable)
 void
 ToggleCursorBlink(TScreen * screen)
 {
-    SetCursorBlink(screen, !(screen->cursor_blink));
+    SetCursorBlink(screen, (Boolean) (!(screen->cursor_blink)));
 }
 #endif
 
@@ -3754,12 +3769,12 @@ ansi_modes(XtermWidget xw,
 #define IsSM() (func == bitset)
 
 #define set_bool_mode(flag) \
-	flag = (IsSM()) ? ON : OFF
+	flag = (Boolean) IsSM()
 
 static void
 really_set_mousemode(XtermWidget xw,
 		     Bool enabled,
-		     unsigned mode)
+		     XtermMouseModes mode)
 {
     xw->screen.send_mouse_pos = enabled ? mode : MOUSE_OFF;
     if (xw->screen.send_mouse_pos != MOUSE_OFF)
@@ -3784,6 +3799,7 @@ dpmodes(XtermWidget xw,
 {
     TScreen *screen = &xw->screen;
     int i, j;
+    unsigned myflags;
 
     for (i = 0; i < nparam; ++i) {
 	TRACE(("%s %d\n", IsSM()? "DECSET" : "DECRST", param[i]));
@@ -3838,9 +3854,9 @@ dpmodes(XtermWidget xw,
 	    update_jumpscroll();
 	    break;
 	case 5:		/* DECSCNM                      */
-	    j = xw->flags;
+	    myflags = xw->flags;
 	    (*func) (&xw->flags, REVERSE_VIDEO);
-	    if ((xw->flags ^ j) & REVERSE_VIDEO)
+	    if ((xw->flags ^ myflags) & REVERSE_VIDEO)
 		ReverseVideo(xw);
 	    /* update_reversevideo done in RevVid */
 	    break;
@@ -4302,7 +4318,7 @@ restoremodes(XtermWidget xw)
 	    /* ignore autorepeat */
 	    break;
 	case SET_X10_MOUSE:	/* MIT bogus sequence           */
-	    DoRM(DP_X_X10MSE, screen->send_mouse_pos);
+	    DoRM0(DP_X_X10MSE, screen->send_mouse_pos);
 	    break;
 #if OPT_TOOLBAR
 	case 10:		/* rxvt */
@@ -4374,7 +4390,7 @@ restoremodes(XtermWidget xw)
 	case SET_VT200_HIGHLIGHT_MOUSE:
 	case SET_BTN_EVENT_MOUSE:
 	case SET_ANY_EVENT_MOUSE:
-	    DoRM(DP_X_MOUSE, screen->send_mouse_pos);
+	    DoRM0(DP_X_MOUSE, screen->send_mouse_pos);
 	    break;
 #if OPT_FOCUS_EVENT
 	case SET_FOCUS_EVENT_MOUSE:
@@ -4521,7 +4537,9 @@ window_ops(XtermWidget xw)
 	reply.a_type = ANSI_CSI;
 	reply.a_pintro = 0;
 	reply.a_nparam = 1;
-	reply.a_param[0] = (win_attrs.map_state == IsViewable) ? 1 : 2;
+	reply.a_param[0] = (ParmType) ((win_attrs.map_state == IsViewable)
+				       ? 1
+				       : 2);
 	reply.a_inters = 0;
 	reply.a_final = 't';
 	unparseseq(xw, &reply);
@@ -4535,8 +4553,8 @@ window_ops(XtermWidget xw)
 	reply.a_pintro = 0;
 	reply.a_nparam = 3;
 	reply.a_param[0] = 3;
-	reply.a_param[1] = win_attrs.x;
-	reply.a_param[2] = win_attrs.y;
+	reply.a_param[1] = (ParmType) win_attrs.x;
+	reply.a_param[2] = (ParmType) win_attrs.y;
 	reply.a_inters = 0;
 	reply.a_final = 't';
 	unparseseq(xw, &reply);
@@ -4554,8 +4572,8 @@ window_ops(XtermWidget xw)
 	 *    win_attrs.height or Height
 	 *      win_attrs.width  or Width
 	 */
-	reply.a_param[1] = Height(screen);
-	reply.a_param[2] = Width(screen);
+	reply.a_param[1] = (ParmType) Height(screen);
+	reply.a_param[2] = (ParmType) Width(screen);
 	reply.a_inters = 0;
 	reply.a_final = 't';
 	unparseseq(xw, &reply);
@@ -4566,8 +4584,8 @@ window_ops(XtermWidget xw)
 	reply.a_pintro = 0;
 	reply.a_nparam = 3;
 	reply.a_param[0] = 8;
-	reply.a_param[1] = MaxRows(screen);
-	reply.a_param[2] = MaxCols(screen);
+	reply.a_param[1] = (ParmType) MaxRows(screen);
+	reply.a_param[2] = (ParmType) MaxCols(screen);
 	reply.a_inters = 0;
 	reply.a_final = 't';
 	unparseseq(xw, &reply);
@@ -4583,8 +4601,8 @@ window_ops(XtermWidget xw)
 	reply.a_pintro = 0;
 	reply.a_nparam = 3;
 	reply.a_param[0] = 9;
-	reply.a_param[1] = root_height / FontHeight(screen);
-	reply.a_param[2] = root_width / FontWidth(screen);
+	reply.a_param[1] = (ParmType) (root_height / FontHeight(screen));
+	reply.a_param[2] = (ParmType) (root_width / FontWidth(screen));
 	reply.a_inters = 0;
 	reply.a_final = 't';
 	unparseseq(xw, &reply);
@@ -4721,11 +4739,11 @@ unparseputc(XtermWidget xw, int c)
     if (xw->screen.tc_query_code >= 0) {
 	char tmp[3];
 	sprintf(tmp, "%02X", c & 0xFF);
-	buf[len++] = tmp[0];
-	buf[len++] = tmp[1];
+	buf[len++] = CharOf(tmp[0]);
+	buf[len++] = CharOf(tmp[1]);
     } else
 #endif
-    if ((buf[len++] = c) == '\r' && (xw->flags & LINEFEED)) {
+    if ((buf[len++] = (IChar) c) == '\r' && (xw->flags & LINEFEED)) {
 	buf[len++] = '\n';
     }
 
@@ -4810,7 +4828,7 @@ SwitchBufs(XtermWidget xw)
 		   (int) OriginX(screen),
 		   (int) top * FontHeight(screen) + screen->border,
 		   (unsigned) Width(screen),
-		   (unsigned) (rows - top) * FontHeight(screen),
+		   (unsigned) ((rows - top) * FontHeight(screen)),
 		   False);
     }
     ScrnUpdate(xw, 0, 0, rows, MaxCols(screen), False);
@@ -4943,7 +4961,8 @@ VTResize(Widget w)
     }
 }
 
-#define okDimension(src,dst) ((src <= 32767) && ((dst = src) == src))
+#define okDimension(src,dst) ((src <= 32767) \
+			  && ((dst = (Dimension) src) == src))
 
 static void
 RequestResize(XtermWidget xw, int rows, int cols, Bool text)
@@ -4957,8 +4976,8 @@ RequestResize(XtermWidget xw, int rows, int cols, Bool text)
 
     TRACE(("RequestResize(rows=%d, cols=%d, text=%d)\n", rows, cols, text));
 
-    if ((askedWidth = cols) < cols
-	|| (askedHeight = rows) < rows)
+    if ((askedWidth = (Dimension) cols) < cols
+	|| (askedHeight = (Dimension) rows) < rows)
 	return;
 
     if (askedHeight == 0
@@ -4969,20 +4988,21 @@ RequestResize(XtermWidget xw, int rows, int cols, Bool text)
     }
 
     if (text) {
-	if ((value = rows) != 0) {
+	if ((value = (unsigned long) rows) != 0) {
 	    if (rows < 0)
-		value = MaxRows(screen);
-	    value *= FontHeight(screen);
-	    value += (2 * screen->border);
+		value = (unsigned long) MaxRows(screen);
+	    value *= (unsigned long) FontHeight(screen);
+	    value += (unsigned long) (2 * screen->border);
 	    if (!okDimension(value, askedHeight))
 		return;
 	}
 
-	if ((value = cols) != 0) {
+	if ((value = (unsigned long) cols) != 0) {
 	    if (cols < 0)
-		value = MaxCols(screen);
-	    value *= FontWidth(screen);
-	    value += (2 * screen->border) + ScrollbarWidth(screen);
+		value = (unsigned long) MaxCols(screen);
+	    value *= (unsigned long) FontWidth(screen);
+	    value += (unsigned long) ((2 * screen->border)
+				      + ScrollbarWidth(screen));
 	    if (!okDimension(value, askedWidth))
 		return;
 	}
@@ -4995,19 +5015,19 @@ RequestResize(XtermWidget xw, int rows, int cols, Bool text)
     }
 
     if (rows == 0)
-	askedHeight = attrs.height;
+	askedHeight = (Dimension) attrs.height;
     if (cols == 0)
-	askedWidth = attrs.width;
+	askedWidth = (Dimension) attrs.width;
 
     if (xw->misc.limit_resize > 0) {
-	Dimension high = xw->misc.limit_resize * attrs.height;
-	Dimension wide = xw->misc.limit_resize * attrs.width;
+	Dimension high = (Dimension) (xw->misc.limit_resize * attrs.height);
+	Dimension wide = (Dimension) (xw->misc.limit_resize * attrs.width);
 	if (high < attrs.height)
-	    high = attrs.height;
+	    high = (Dimension) attrs.height;
 	if (askedHeight > high)
 	    askedHeight = high;
 	if (wide < attrs.width)
-	    wide = attrs.width;
+	    wide = (Dimension) attrs.width;
 	if (askedWidth > wide)
 	    askedWidth = wide;
     }
@@ -5212,7 +5232,7 @@ VTInitialize_locale(XtermWidget request)
 #if OPT_MINI_LUIT
     if (x_strcasecmp(request->misc.locale_str, "CHECKFONT") == 0) {
 	int fl = (request->misc.default_font.f_n
-		  ? strlen(request->misc.default_font.f_n)
+		  ? (int) strlen(request->misc.default_font.f_n)
 		  : 0);
 	if (fl > 11
 	    && x_strcasecmp(request->misc.default_font.f_n + fl - 11,
@@ -5229,7 +5249,7 @@ VTInitialize_locale(XtermWidget request)
 		    request->screen.utf8_mode = uFalse;
 		request->screen.latin9_mode = 1;
 	    } else {
-		request->misc.callfilter = is_utf8 ? 0 : 1;
+		request->misc.callfilter = (Boolean) (is_utf8 ? 0 : 1);
 		request->screen.utf8_mode = uAlways;
 	    }
 #else
@@ -5250,7 +5270,7 @@ VTInitialize_locale(XtermWidget request)
 	    x_strcasecmp(request->misc.locale_str, "AUTO") == 0 ||
 	    strcmp(request->misc.locale_str, "1") == 0) {
 	/* when true ... fully obeying LC_CTYPE locale */
-	request->misc.callfilter = is_utf8 ? 0 : 1;
+	request->misc.callfilter = (Boolean) (is_utf8 ? 0 : 1);
 	request->screen.utf8_mode = uAlways;
     } else if (x_strcasecmp(request->misc.locale_str, "FALSE") == 0 ||
 	       x_strcasecmp(request->misc.locale_str, "OFF") == 0 ||
@@ -5298,7 +5318,7 @@ VTInitialize_locale(XtermWidget request)
     }
 #endif /* OPT_LUIT_PROG */
 
-    request->screen.utf8_inparse = (request->screen.utf8_mode != uFalse);
+    request->screen.utf8_inparse = (Boolean) (request->screen.utf8_mode != uFalse);
 
     TRACE(("... updated screen.utf8_mode = %d\n", request->screen.utf8_mode));
     TRACE(("...VTInitialize_locale done\n"));
@@ -5561,11 +5581,15 @@ VTInitialize(Widget wrequest,
     init_Bres(screen.meta_sends_esc);
 
     init_Bres(screen.allowSendEvent0);
+    init_Bres(screen.allowFontOp0);
+    init_Bres(screen.allowTcapOp0);
     init_Bres(screen.allowTitleOp0);
     init_Bres(screen.allowWindowOp0);
 
     /* make a copy so that editres cannot change the resource after startup */
     wnew->screen.allowSendEvents = wnew->screen.allowSendEvent0;
+    wnew->screen.allowFontOps = wnew->screen.allowFontOp0;
+    wnew->screen.allowTcapOps = wnew->screen.allowTcapOp0;
     wnew->screen.allowTitleOps = wnew->screen.allowTitleOp0;
     wnew->screen.allowWindowOps = wnew->screen.allowWindowOp0;
 
@@ -6034,8 +6058,10 @@ VTDestroy(Widget w GCC_UNUSED)
 
     StopBlinking(screen);
 
-    if (screen->scrollWidget)
+    if (screen->scrollWidget) {
+	XtUninstallTranslations(screen->scrollWidget);
 	XtDestroyWidget(screen->scrollWidget);
+    }
 
     TRACE_FREE_LEAK(screen->save_ptr);
     TRACE_FREE_LEAK(screen->sbuf_address);
@@ -6063,7 +6089,6 @@ VTDestroy(Widget w GCC_UNUSED)
     releaseWindowGCs(xw, &(screen->iconVwin));
 #endif
     XtUninstallTranslations((Widget) xw);
-    XtUninstallTranslations(screen->scrollWidget);
 #if OPT_TOOLBAR
     XtUninstallTranslations((Widget) XtParent(xw));
 #endif
@@ -6213,12 +6238,14 @@ VTRealize(Widget w,
 	   BorderWidth(SHELL_OF(xw))));
 
     if ((pr & XValue) && (XNegative & pr)) {
-	xpos += DisplayWidth(screen->display, DefaultScreen(screen->display))
-	    - width - (BorderWidth(XtParent(xw)) * 2);
+	xpos += (DisplayWidth(screen->display, DefaultScreen(screen->display))
+		 - (int) width
+		 - (BorderWidth(XtParent(xw)) * 2));
     }
     if ((pr & YValue) && (YNegative & pr)) {
-	ypos += DisplayHeight(screen->display, DefaultScreen(screen->display))
-	    - height - (BorderWidth(XtParent(xw)) * 2);
+	ypos += (DisplayHeight(screen->display, DefaultScreen(screen->display))
+		 - (int) height
+		 - (BorderWidth(XtParent(xw)) * 2));
     }
 
     /* set up size hints for window manager; min 1 char by 1 char */
@@ -6406,14 +6433,14 @@ VTRealize(Widget w,
 #endif
 	screen->visbuf = screen->allbuf = NULL;
 
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
     screen->scrolls = screen->incopy = 0;
     xtermSetCursorBox(screen);
 
     screen->savedlines = 0;
 
     for (i = 0; i < 2; ++i) {
-	screen->alternate = !screen->alternate;
+	screen->alternate = (Boolean) (!screen->alternate);
 	CursorSave(xw);
     }
 
@@ -6638,7 +6665,7 @@ xim_real_init(void)
 	    return;
 	}
 	(void) XExtentsOfFontSet(term->screen.fs);
-	j = XFontsOfFontSet(term->screen.fs, &fonts, &font_name_list);
+	j = (unsigned) XFontsOfFontSet(term->screen.fs, &fonts, &font_name_list);
 	for (i = 0, term->screen.fs_ascent = 0; i < j; i++) {
 	    if (term->screen.fs_ascent < (*fonts)->ascent)
 		term->screen.fs_ascent = (*fonts)->ascent;
@@ -6704,8 +6731,8 @@ VTSetValues(Widget cur,
 {
     XtermWidget curvt = (XtermWidget) cur;
     XtermWidget newvt = (XtermWidget) wnew;
-    Bool refresh_needed = False;
-    Bool fonts_redone = False;
+    Boolean refresh_needed = False;
+    Boolean fonts_redone = False;
 
     if ((T_COLOR(&(curvt->screen), TEXT_BG) !=
 	 T_COLOR(&(newvt->screen), TEXT_BG)) ||
@@ -6734,7 +6761,8 @@ VTSetValues(Widget cur,
     if (curvt->misc.re_verse != newvt->misc.re_verse) {
 	newvt->flags ^= REVERSE_VIDEO;
 	ReverseVideo(newvt);
-	newvt->misc.re_verse = !newvt->misc.re_verse;	/* ReverseVideo toggles */
+	/* ReverseVideo toggles */
+	newvt->misc.re_verse = (Boolean) (!newvt->misc.re_verse);
 	refresh_needed = True;
     }
     if ((T_COLOR(&(curvt->screen), MOUSE_FG) !=
@@ -6871,8 +6899,7 @@ ShowCursor(void)
      */
     (void) fg_bg;
     if_OPT_EXT_COLORS(screen, {
-	fg_bg = (SCRN_BUF_FGRND(screen, screen->cursorp.row)[cursor_col] << 8)
-	    | (SCRN_BUF_BGRND(screen, screen->cursorp.row)[cursor_col]);
+	fg_bg = PACK_FGBG(screen, screen->cursorp.row, cursor_col);
     });
     if_OPT_ISO_TRADITIONAL_COLORS(screen, {
 	fg_bg = SCRN_BUF_COLOR(screen, screen->cursorp.row)[cursor_col];
@@ -7011,11 +7038,11 @@ ShowCursor(void)
 	    if (outlineGC == 0)
 		outlineGC = currentGC;
 
-	    screen->box->x = x;
+	    screen->box->x = (short) x;
 	    if (!screen->cursor_underline)
-		screen->box->y = y;
+		screen->box->y = (short) y;
 	    else
-		screen->box->y = y + FontHeight(screen) - 2;
+		screen->box->y = (short) (y + FontHeight(screen) - 2);
 	    XDrawLines(screen->display, VWindow(screen), outlineGC,
 		       screen->box, NBOX, CoordModePrevious);
 	}
@@ -7082,8 +7109,7 @@ HideCursor(void)
     });
 
     if_OPT_EXT_COLORS(screen, {
-	fg_bg = (SCRN_BUF_FGRND(screen, screen->cursorp.row)[cursor_col] << 8)
-	    | (SCRN_BUF_BGRND(screen, screen->cursorp.row)[cursor_col]);
+	fg_bg = PACK_FGBG(screen, screen->cursorp.row, cursor_col);
     });
     if_OPT_ISO_TRADITIONAL_COLORS(screen, {
 	fg_bg = SCRN_BUF_COLOR(screen, screen->cursorp.row)[cursor_col];
@@ -7135,8 +7161,9 @@ static void
 StartBlinking(TScreen * screen)
 {
     if (screen->blink_timer == 0) {
-	unsigned long interval = (screen->cursor_state == ON ?
-				  screen->blink_on : screen->blink_off);
+	unsigned long interval = (unsigned long) ((screen->cursor_state == ON)
+						  ? screen->blink_on
+						  : screen->blink_off);
 	if (interval == 0)	/* wow! */
 	    interval = 1;	/* let's humor him anyway */
 	screen->blink_timer = XtAppAddTimeOut(app_con,
@@ -7341,14 +7368,16 @@ VTReset(XtermWidget xw, Bool full, Bool saved)
 	update_reversewrap();
 	update_autolinefeed();
 
-	screen->jumpscroll = !(xw->flags & SMOOTHSCROLL);
+	screen->jumpscroll = (Boolean) (!(xw->flags & SMOOTHSCROLL));
 	update_jumpscroll();
 
 	if (screen->c132 && (xw->flags & IN132COLUMNS)) {
-	    Dimension reqWidth = (80 * FontWidth(screen)
-				  + 2 * screen->border + ScrollbarWidth(screen));
-	    Dimension reqHeight = (FontHeight(screen)
-				   * MaxRows(screen) + 2 * screen->border);
+	    Dimension reqWidth = (Dimension) (80 * FontWidth(screen)
+					      + 2 * screen->border
+					      + ScrollbarWidth(screen));
+	    Dimension reqHeight = (Dimension) (FontHeight(screen)
+					       * MaxRows(screen)
+					       + 2 * screen->border);
 	    Dimension replyWidth;
 	    Dimension replyHeight;
 
@@ -7414,9 +7443,9 @@ set_character_class(char *s)
     base = 10;			/* in case we ever add octal, hex */
     low = high = -1;		/* out of range */
 
-    for (i = 0, len = strlen(s), acc = 0, numbers = digits = 0;
+    for (i = 0, len = (int) strlen(s), acc = 0, numbers = digits = 0;
 	 i < len; i++) {
-	Char c = s[i];
+	Char c = CharOf(s[i]);
 
 	if (isspace(c)) {
 	    continue;
@@ -7535,7 +7564,7 @@ HandleKeymapChange(Widget w,
     (void) sprintf(pmapName, "%sKeymap", params[0]);
     (void) strcpy(pmapClass, pmapName);
     if (islower(CharOf(pmapClass[0])))
-	pmapClass[0] = toupper(CharOf(pmapClass[0]));
+	pmapClass[0] = x_toupper(pmapClass[0]);
     XtGetSubresources(w, (XtPointer) &keymap, pmapName, pmapClass,
 		      key_resources, (Cardinal) 1, NULL, (Cardinal) 0);
     if (keymap != NULL)
@@ -7655,9 +7684,9 @@ void
 FindFontSelection(XtermWidget xw, const char *atom_name, Bool justprobe)
 {
     static AtomPtr *atoms;
-    static int atomCount = 0;
+    unsigned int atomCount = 0;
     AtomPtr *pAtom;
-    int a;
+    unsigned a;
     Atom target;
 
     if (!atom_name)
diff --git a/app/xterm/configure b/app/xterm/configure
index e7f6cc513..f942f1117 100644
--- a/app/xterm/configure
+++ b/app/xterm/configure
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by Autoconf 2.52.20061216.
+# Generated by Autoconf 2.52.20081225.
 #
 # Copyright 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001
 # Free Software Foundation, Inc.
@@ -735,7 +735,7 @@ Optional Features:
   --enable-logfile-exec   enable exec'd logfile filter
   --disable-maximize      disable actions for iconify/deiconify/maximize/restore
   --disable-num-lock      disable NumLock keypad support
-  --enable-paste64        enable get/set base64 selection data
+  --disable-paste64       disable get/set base64 selection data
   --disable-pty-handshake disable pty-handshake support
   --enable-readline-mouse enable support for mouse in readline applications
   --disable-regex         disable regular-expression selections
@@ -744,7 +744,7 @@ Optional Features:
   --disable-samename      disable check for redundant name-change
   --disable-session-mgt   disable support for session management
   --disable-tcap-fkeys    disable termcap function-keys support
-  --enable-tcap-query     compile-in termcap-query support
+  --disable-tcap-query    disable compiled-in termcap-query support
   --disable-tek4014       disable tek4014 emulation
   --enable-toolbar        compile-in toolbar for pulldown menus
   --disable-vt52          disable VT52 emulation
@@ -830,7 +830,7 @@ This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
 It was created by $as_me, which was
-generated by GNU Autoconf 2.52.20061216.  Invocation command line was
+generated by GNU Autoconf 2.52.20081225.  Invocation command line was
 
   $ $0 $@
 
@@ -1523,7 +1523,7 @@ for ac_file in `ls a.exe conftest.exe 2>/dev/null;
                 ls a.out conftest 2>/dev/null;
                 ls a.* conftest.* 2>/dev/null`; do
   case $ac_file in
-    *.$ac_ext | *.o | *.obj | *.xcoff | *.tds | *.d | *.pdb ) ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.dbg | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.o | *.obj ) ;;
     a.out ) # We found the default executable, but exeext='' is most
             # certainly right.
             break;;
@@ -1597,7 +1597,7 @@ if { (eval echo "$as_me:1589: \"$ac_link\"") >&5
 # `rm'.
 for ac_file in `(ls conftest.exe; ls conftest; ls conftest.*) 2>/dev/null`; do
   case $ac_file in
-    *.$ac_ext | *.o | *.obj | *.xcoff | *.tds | *.d | *.pdb ) ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.dbg | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.o | *.obj ) ;;
     *.* ) ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
           export ac_cv_exeext
           break;;
@@ -1642,7 +1642,7 @@ if { (eval echo "$as_me:1638: \"$ac_compile\"") >&5
   (exit $ac_status); }; then
   for ac_file in `(ls conftest.o conftest.obj; ls conftest.*) 2>/dev/null`; do
   case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb ) ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.dbg | *.pdb | *.xSYM | *.map | *.inf ) ;;
     *) ac_cv_objext=`expr "$ac_file" : '.*\.\(.*\)'`
        break;;
   esac
@@ -2820,10 +2820,10 @@ cf_XOPEN_SOURCE=500
 cf_POSIX_C_SOURCE=199506L
 
 case $host_os in #(vi
-aix[45]*) #(vi
+aix[456]*) #(vi
 	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
 	;;
-freebsd*) #(vi
+freebsd*|dragonfly*) #(vi
 	# 5.x headers associate
 	#	_XOPEN_SOURCE=600 with _POSIX_C_SOURCE=200112L
 	#	_XOPEN_SOURCE=500 with _POSIX_C_SOURCE=199506L
@@ -2837,7 +2837,7 @@ hpux*) #(vi
 irix[56].*) #(vi
 	CPPFLAGS="$CPPFLAGS -D_SGI_SOURCE"
 	;;
-linux*|gnu*|k*bsd*-gnu) #(vi
+linux*|gnu*|mint*|k*bsd*-gnu) #(vi
 
 echo "$as_me:2842: checking if we must define _GNU_SOURCE" >&5
 echo $ECHO_N "checking if we must define _GNU_SOURCE... $ECHO_C" >&6
@@ -6067,7 +6067,7 @@ else
 int
 main ()
 {
-long x = (long) errno
+int x = (int) errno
   ;
   return 0;
 }
@@ -6463,7 +6463,7 @@ else
 int
 main ()
 {
-long x = (long) sys_nerr
+int x = (int) sys_nerr
   ;
   return 0;
 }
@@ -6578,7 +6578,7 @@ else
 int
 main ()
 {
-long x = (long) sys_errlist
+int x = (int) sys_errlist
   ;
   return 0;
 }
@@ -6950,7 +6950,7 @@ EOF
     # GNU make sometimes prints "make[1]: Entering...", which would confuse us.
     eval `${MAKE-make} acfindx 2>/dev/null | grep -v make`
     # Open Windows xmkmf reportedly sets LIBDIR instead of USRLIBDIR.
-    for ac_extension in a so sl; do
+    for ac_extension in a so sl dylib dll; do
       if test ! -f $ac_im_usrlibdir/libX11.$ac_extension &&
          test -f $ac_im_libdir/libX11.$ac_extension; then
         ac_im_usrlibdir=$ac_im_libdir; break
@@ -7089,7 +7089,7 @@ LIBS=$ac_save_LIBS
 for ac_dir in `echo "$ac_x_includes $ac_x_header_dirs" | sed s/include/lib/g`
 do
   # Don't even attempt the hair of trying to link an X program!
-  for ac_extension in a so sl; do
+  for ac_extension in a so sl dylib dll; do
     if test -r $ac_dir/libXt.$ac_extension; then
       ac_x_libraries=$ac_dir
       break 2
@@ -8687,14 +8687,64 @@ cat >>confdefs.h <<EOF
 #define $cf_x_athena_LIBS 1
 EOF
 
-echo "$as_me:8690: checking for declaration of fd_set" >&5
+for ac_header in X11/Xpoll.h
+do
+as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
+echo "$as_me:8693: checking for $ac_header" >&5
+echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
+if eval "test \"\${$as_ac_Header+set}\" = set"; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  cat >conftest.$ac_ext <<_ACEOF
+#line 8699 "configure"
+#include "confdefs.h"
+#include <$ac_header>
+_ACEOF
+if { (eval echo "$as_me:8703: \"$ac_cpp conftest.$ac_ext\"") >&5
+  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+  ac_status=$?
+  egrep -v '^ *\+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:8709: \$? = $ac_status" >&5
+  (exit $ac_status); } >/dev/null; then
+  if test -s conftest.err; then
+    ac_cpp_err=$ac_c_preproc_warn_flag
+  else
+    ac_cpp_err=
+  fi
+else
+  ac_cpp_err=yes
+fi
+if test -z "$ac_cpp_err"; then
+  eval "$as_ac_Header=yes"
+else
+  echo "$as_me: failed program was:" >&5
+  cat conftest.$ac_ext >&5
+  eval "$as_ac_Header=no"
+fi
+rm -f conftest.err conftest.$ac_ext
+fi
+echo "$as_me:8728: result: `eval echo '${'$as_ac_Header'}'`" >&5
+echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
+if test `eval echo '${'$as_ac_Header'}'` = yes; then
+  cat >>confdefs.h <<EOF
+#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
+EOF
+
+fi
+done
+
+echo "$as_me:8738: checking for declaration of fd_set" >&5
 echo $ECHO_N "checking for declaration of fd_set... $ECHO_C" >&6
 if test "${cf_cv_type_fd_set+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
-  echo "trying sys/types alone" 1>&5
+
+echo "${as_me-configure}:8744: testing sys/types alone ..." 1>&5
+
 cat >conftest.$ac_ext <<_ACEOF
-#line 8697 "configure"
+#line 8747 "configure"
 #include "confdefs.h"
 
 #include <sys/types.h>
@@ -8707,24 +8757,26 @@ fd_set x
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:8710: \"$ac_compile\"") >&5
+if { (eval echo "$as_me:8760: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:8713: \$? = $ac_status" >&5
+  echo "$as_me:8763: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:8716: \"$ac_try\"") >&5
+  { (eval echo "$as_me:8766: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:8719: \$? = $ac_status" >&5
+  echo "$as_me:8769: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_type_fd_set=sys/types.h
 else
   echo "$as_me: failed program was:" >&5
 cat conftest.$ac_ext >&5
-echo "trying X11/Xpoll.h" 1>&5
+
+echo "${as_me-configure}:8776: testing X11/Xpoll.h ..." 1>&5
+
 cat >conftest.$ac_ext <<_ACEOF
-#line 8727 "configure"
+#line 8779 "configure"
 #include "confdefs.h"
 
 #ifdef HAVE_X11_XPOLL_H
@@ -8739,24 +8791,26 @@ fd_set x
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:8742: \"$ac_compile\"") >&5
+if { (eval echo "$as_me:8794: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:8745: \$? = $ac_status" >&5
+  echo "$as_me:8797: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:8748: \"$ac_try\"") >&5
+  { (eval echo "$as_me:8800: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:8751: \$? = $ac_status" >&5
+  echo "$as_me:8803: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_type_fd_set=X11/Xpoll.h
 else
   echo "$as_me: failed program was:" >&5
 cat conftest.$ac_ext >&5
-echo "trying sys/select.h" 1>&5
+
+echo "${as_me-configure}:8810: testing sys/select.h ..." 1>&5
+
 cat >conftest.$ac_ext <<_ACEOF
-#line 8759 "configure"
+#line 8813 "configure"
 #include "confdefs.h"
 
 #include <sys/types.h>
@@ -8770,16 +8824,16 @@ fd_set x
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:8773: \"$ac_compile\"") >&5
+if { (eval echo "$as_me:8827: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:8776: \$? = $ac_status" >&5
+  echo "$as_me:8830: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:8779: \"$ac_try\"") >&5
+  { (eval echo "$as_me:8833: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:8782: \$? = $ac_status" >&5
+  echo "$as_me:8836: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_type_fd_set=sys/select.h
 else
@@ -8793,7 +8847,7 @@ rm -f conftest.$ac_objext conftest.$ac_ext
 fi
 rm -f conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:8796: result: $cf_cv_type_fd_set" >&5
+echo "$as_me:8850: result: $cf_cv_type_fd_set" >&5
 echo "${ECHO_T}$cf_cv_type_fd_set" >&6
 if test $cf_cv_type_fd_set = sys/select.h ; then
 	cat >>confdefs.h <<\EOF
@@ -8802,14 +8856,102 @@ EOF
 
 fi
 
-echo "$as_me:8805: checking for IRIX 6.5 baud-rate redefinitions" >&5
+echo "$as_me:8859: checking for declaration of fd_mask" >&5
+echo $ECHO_N "checking for declaration of fd_mask... $ECHO_C" >&6
+if test "${cf_cv_type_fd_mask+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+
+    if test x$cf_cv_type_fd_set = xX11/Xpoll.h ; then
+        cat >conftest.$ac_ext <<_ACEOF
+#line 8867 "configure"
+#include "confdefs.h"
+
+#include <X11/Xpoll.h>
+int
+main ()
+{
+fd_mask x
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext
+if { (eval echo "$as_me:8880: \"$ac_compile\"") >&5
+  (eval $ac_compile) 2>&5
+  ac_status=$?
+  echo "$as_me:8883: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+         { ac_try='test -s conftest.$ac_objext'
+  { (eval echo "$as_me:8886: \"$ac_try\"") >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  echo "$as_me:8889: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  :
+else
+  echo "$as_me: failed program was:" >&5
+cat conftest.$ac_ext >&5
+
+echo "${as_me-configure}:8896: testing if we must define CSRG_BASED ..." 1>&5
+
+# Xosdefs.h on Mac OS X may not define this (but it should).
+            cat >conftest.$ac_ext <<_ACEOF
+#line 8900 "configure"
+#include "confdefs.h"
+
+#define CSRG_BASED
+#include <X11/Xpoll.h>
+int
+main ()
+{
+fd_mask x
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext
+if { (eval echo "$as_me:8914: \"$ac_compile\"") >&5
+  (eval $ac_compile) 2>&5
+  ac_status=$?
+  echo "$as_me:8917: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+         { ac_try='test -s conftest.$ac_objext'
+  { (eval echo "$as_me:8920: \"$ac_try\"") >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  echo "$as_me:8923: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  cf_cv_type_fd_mask=CSRG_BASED
+else
+  echo "$as_me: failed program was:" >&5
+cat conftest.$ac_ext >&5
+fi
+rm -f conftest.$ac_objext conftest.$ac_ext
+fi
+rm -f conftest.$ac_objext conftest.$ac_ext
+    else
+        cf_cv_type_fd_mask=$cf_cv_type_fd_set
+    fi
+
+fi
+echo "$as_me:8938: result: $cf_cv_type_fd_mask" >&5
+echo "${ECHO_T}$cf_cv_type_fd_mask" >&6
+if test x$cf_cv_type_fd_mask = xCSRG_BASED ; then
+    cat >>confdefs.h <<\EOF
+#define CSRG_BASED 1
+EOF
+
+fi
+
+echo "$as_me:8947: checking for IRIX 6.5 baud-rate redefinitions" >&5
 echo $ECHO_N "checking for IRIX 6.5 baud-rate redefinitions... $ECHO_C" >&6
 if test "${cf_cv_termio_c_ispeed+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 cat >conftest.$ac_ext <<_ACEOF
-#line 8812 "configure"
+#line 8954 "configure"
 #include "confdefs.h"
 
 #include <sys/types.h>
@@ -8827,16 +8969,16 @@ foo.c_ospeed = B9600;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:8830: \"$ac_compile\"") >&5
+if { (eval echo "$as_me:8972: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:8833: \$? = $ac_status" >&5
+  echo "$as_me:8975: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:8836: \"$ac_try\"") >&5
+  { (eval echo "$as_me:8978: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:8839: \$? = $ac_status" >&5
+  echo "$as_me:8981: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_termio_c_ispeed=yes
 
@@ -8848,7 +8990,7 @@ fi
 rm -f conftest.$ac_objext conftest.$ac_ext
 
 fi
-echo "$as_me:8851: result: $cf_cv_termio_c_ispeed" >&5
+echo "$as_me:8993: result: $cf_cv_termio_c_ispeed" >&5
 echo "${ECHO_T}$cf_cv_termio_c_ispeed" >&6
 test "$cf_cv_termio_c_ispeed" = yes && cat >>confdefs.h <<\EOF
 #define HAVE_TERMIO_C_ISPEED 1
@@ -8861,7 +9003,7 @@ LIBS="$LIBS $X_EXTRA_LIBS"
 case $host_os in #(vi
 freebsd*|netbsd*)	# 2004/8/15 - revisit this if/when grantpt is known to work.
 
-echo "$as_me:8864: checking for openpty in -lutil" >&5
+echo "$as_me:9006: checking for openpty in -lutil" >&5
 echo $ECHO_N "checking for openpty in -lutil... $ECHO_C" >&6
 if test "${ac_cv_lib_util_openpty+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -8869,7 +9011,7 @@ else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lutil  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
-#line 8872 "configure"
+#line 9014 "configure"
 #include "confdefs.h"
 
 /* Override any gcc2 internal prototype to avoid an error.  */
@@ -8888,16 +9030,16 @@ openpty ();
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:8891: \"$ac_link\"") >&5
+if { (eval echo "$as_me:9033: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:8894: \$? = $ac_status" >&5
+  echo "$as_me:9036: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:8897: \"$ac_try\"") >&5
+  { (eval echo "$as_me:9039: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:8900: \$? = $ac_status" >&5
+  echo "$as_me:9042: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_util_openpty=yes
 else
@@ -8908,7 +9050,7 @@ fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:8911: result: $ac_cv_lib_util_openpty" >&5
+echo "$as_me:9053: result: $ac_cv_lib_util_openpty" >&5
 echo "${ECHO_T}$ac_cv_lib_util_openpty" >&6
 if test $ac_cv_lib_util_openpty = yes; then
   cat >>confdefs.h <<EOF
@@ -8925,13 +9067,13 @@ fi
 for ac_func in grantpt
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:8928: checking for $ac_func" >&5
+echo "$as_me:9070: checking for $ac_func" >&5
 echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
 if eval "test \"\${$as_ac_var+set}\" = set"; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line 8934 "configure"
+#line 9076 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func (); below.  */
@@ -8962,16 +9104,16 @@ f = $ac_func;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:8965: \"$ac_link\"") >&5
+if { (eval echo "$as_me:9107: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:8968: \$? = $ac_status" >&5
+  echo "$as_me:9110: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:8971: \"$ac_try\"") >&5
+  { (eval echo "$as_me:9113: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:8974: \$? = $ac_status" >&5
+  echo "$as_me:9116: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
@@ -8981,7 +9123,7 @@ eval "$as_ac_var=no"
 fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:8984: result: `eval echo '${'$as_ac_var'}'`" >&5
+echo "$as_me:9126: result: `eval echo '${'$as_ac_var'}'`" >&5
 echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<EOF
@@ -8990,7 +9132,7 @@ EOF
 
 else
 
-echo "$as_me:8993: checking for openpty in -lutil" >&5
+echo "$as_me:9135: checking for openpty in -lutil" >&5
 echo $ECHO_N "checking for openpty in -lutil... $ECHO_C" >&6
 if test "${ac_cv_lib_util_openpty+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -8998,7 +9140,7 @@ else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lutil  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
-#line 9001 "configure"
+#line 9143 "configure"
 #include "confdefs.h"
 
 /* Override any gcc2 internal prototype to avoid an error.  */
@@ -9017,16 +9159,16 @@ openpty ();
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:9020: \"$ac_link\"") >&5
+if { (eval echo "$as_me:9162: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:9023: \$? = $ac_status" >&5
+  echo "$as_me:9165: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:9026: \"$ac_try\"") >&5
+  { (eval echo "$as_me:9168: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:9029: \$? = $ac_status" >&5
+  echo "$as_me:9171: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_util_openpty=yes
 else
@@ -9037,7 +9179,7 @@ fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:9040: result: $ac_cv_lib_util_openpty" >&5
+echo "$as_me:9182: result: $ac_cv_lib_util_openpty" >&5
 echo "${ECHO_T}$ac_cv_lib_util_openpty" >&6
 if test $ac_cv_lib_util_openpty = yes; then
   cat >>confdefs.h <<EOF
@@ -9054,14 +9196,14 @@ done
 	;;
 esac
 
-echo "$as_me:9057: checking for XKB Bell extension" >&5
+echo "$as_me:9199: checking for XKB Bell extension" >&5
 echo $ECHO_N "checking for XKB Bell extension... $ECHO_C" >&6
 if test "${cf_cv_xkb_bell_ext+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 cat >conftest.$ac_ext <<_ACEOF
-#line 9064 "configure"
+#line 9206 "configure"
 #include "confdefs.h"
 
 #include <X11/XKBlib.h>		/* has the prototype */
@@ -9082,16 +9224,16 @@ int x = XkbBI_Info
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:9085: \"$ac_link\"") >&5
+if { (eval echo "$as_me:9227: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:9088: \$? = $ac_status" >&5
+  echo "$as_me:9230: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:9091: \"$ac_try\"") >&5
+  { (eval echo "$as_me:9233: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:9094: \$? = $ac_status" >&5
+  echo "$as_me:9236: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_xkb_bell_ext=yes
 else
@@ -9102,7 +9244,7 @@ fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 
 fi
-echo "$as_me:9105: result: $cf_cv_xkb_bell_ext" >&5
+echo "$as_me:9247: result: $cf_cv_xkb_bell_ext" >&5
 echo "${ECHO_T}$cf_cv_xkb_bell_ext" >&6
 
 test "$cf_cv_xkb_bell_ext" = yes && cat >>confdefs.h <<\EOF
@@ -9112,13 +9254,13 @@ EOF
 for ac_func in Xutf8LookupString
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:9115: checking for $ac_func" >&5
+echo "$as_me:9257: checking for $ac_func" >&5
 echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
 if eval "test \"\${$as_ac_var+set}\" = set"; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line 9121 "configure"
+#line 9263 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func (); below.  */
@@ -9149,16 +9291,16 @@ f = $ac_func;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:9152: \"$ac_link\"") >&5
+if { (eval echo "$as_me:9294: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:9155: \$? = $ac_status" >&5
+  echo "$as_me:9297: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:9158: \"$ac_try\"") >&5
+  { (eval echo "$as_me:9300: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:9161: \$? = $ac_status" >&5
+  echo "$as_me:9303: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
@@ -9168,7 +9310,7 @@ eval "$as_ac_var=no"
 fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:9171: result: `eval echo '${'$as_ac_var'}'`" >&5
+echo "$as_me:9313: result: `eval echo '${'$as_ac_var'}'`" >&5
 echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<EOF
@@ -9184,7 +9326,7 @@ else
 fi
 done
 
-echo "$as_me:9187: checking if you want narrow prototypes for X libraries" >&5
+echo "$as_me:9329: checking if you want narrow prototypes for X libraries" >&5
 echo $ECHO_N "checking if you want narrow prototypes for X libraries... $ECHO_C" >&6
 
 case `$ac_config_guess` in #(vi
@@ -9210,10 +9352,10 @@ else
   enable_narrowproto=$cf_default_narrowproto
 
 fi;
-echo "$as_me:9213: result: $enable_narrowproto" >&5
+echo "$as_me:9355: result: $enable_narrowproto" >&5
 echo "${ECHO_T}$enable_narrowproto" >&6
 
-echo "$as_me:9216: checking if we should use imake to help" >&5
+echo "$as_me:9358: checking if we should use imake to help" >&5
 echo $ECHO_N "checking if we should use imake to help... $ECHO_C" >&6
 
 # Check whether --enable-imake or --disable-imake was given.
@@ -9230,7 +9372,7 @@ else
   enable_imake=yes
 
 fi;
-echo "$as_me:9233: result: $enable_imake" >&5
+echo "$as_me:9375: result: $enable_imake" >&5
 echo "${ECHO_T}$enable_imake" >&6
 
 if test "$enable_imake" = yes ; then
@@ -9239,7 +9381,7 @@ for ac_prog in xmkmf imake
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
-echo "$as_me:9242: checking for $ac_word" >&5
+echo "$as_me:9384: checking for $ac_word" >&5
 echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
 if test "${ac_cv_path_IMAKE+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -9256,7 +9398,7 @@ for ac_dir in $ac_dummy; do
   test -z "$ac_dir" && ac_dir=.
   if $as_executable_p "$ac_dir/$ac_word"; then
    ac_cv_path_IMAKE="$ac_dir/$ac_word"
-   echo "$as_me:9259: found $ac_dir/$ac_word" >&5
+   echo "$as_me:9401: found $ac_dir/$ac_word" >&5
    break
 fi
 done
@@ -9267,10 +9409,10 @@ fi
 IMAKE=$ac_cv_path_IMAKE
 
 if test -n "$IMAKE"; then
-  echo "$as_me:9270: result: $IMAKE" >&5
+  echo "$as_me:9412: result: $IMAKE" >&5
 echo "${ECHO_T}$IMAKE" >&6
 else
-  echo "$as_me:9273: result: no" >&5
+  echo "$as_me:9415: result: no" >&5
 echo "${ECHO_T}no" >&6
 fi
 
@@ -9330,7 +9472,7 @@ CF_EOF
 	then
 		test -n "$verbose" && echo "	Using $IMAKE $cf_imake_opts" 1>&6
 
-echo "${as_me-configure}:9333: testing Using $IMAKE $cf_imake_opts ..." 1>&5
+echo "${as_me-configure}:9475: testing Using $IMAKE $cf_imake_opts ..." 1>&5
 
 	else
 		# sometimes imake doesn't have the config path compiled in.  Find it.
@@ -9348,7 +9490,7 @@ echo "${as_me-configure}:9333: testing Using $IMAKE $cf_imake_opts ..." 1>&5
 			esac
 		done
 		if test -z "$cf_config" ; then
-			{ echo "$as_me:9351: WARNING: Could not find imake config-directory" >&5
+			{ echo "$as_me:9493: WARNING: Could not find imake config-directory" >&5
 echo "$as_me: WARNING: Could not find imake config-directory" >&2;}
 		else
 			cf_imake_opts="$cf_imake_opts -I$cf_config"
@@ -9356,10 +9498,10 @@ echo "$as_me: WARNING: Could not find imake config-directory" >&2;}
 			then
 				test -n "$verbose" && echo "	Using $IMAKE $cf_config" 1>&6
 
-echo "${as_me-configure}:9359: testing Using $IMAKE $cf_config ..." 1>&5
+echo "${as_me-configure}:9501: testing Using $IMAKE $cf_config ..." 1>&5
 
 			else
-				{ echo "$as_me:9362: WARNING: Cannot run $IMAKE" >&5
+				{ echo "$as_me:9504: WARNING: Cannot run $IMAKE" >&5
 echo "$as_me: WARNING: Cannot run $IMAKE" >&2;}
 			fi
 		fi
@@ -9403,7 +9545,7 @@ echo "$as_me: WARNING: Cannot run $IMAKE" >&2;}
 		else
 		    test -n "$verbose" && echo "	suppressed \"$cf_nostdinc\" and \"$cf_std_incl\"" 1>&6
 
-echo "${as_me-configure}:9406: testing suppressed \"$cf_nostdinc\" and \"$cf_std_incl\" ..." 1>&5
+echo "${as_me-configure}:9548: testing suppressed \"$cf_nostdinc\" and \"$cf_std_incl\" ..." 1>&5
 
 		    IMAKE_CFLAGS="$cf_cpp_opts"
 		fi
@@ -9425,11 +9567,11 @@ fi
 
 test -n "$verbose" && echo "	IMAKE_CFLAGS $IMAKE_CFLAGS" 1>&6
 
-echo "${as_me-configure}:9428: testing IMAKE_CFLAGS $IMAKE_CFLAGS ..." 1>&5
+echo "${as_me-configure}:9570: testing IMAKE_CFLAGS $IMAKE_CFLAGS ..." 1>&5
 
 test -n "$verbose" && echo "	IMAKE_LOADFLAGS $IMAKE_LOADFLAGS" 1>&6
 
-echo "${as_me-configure}:9432: testing IMAKE_LOADFLAGS $IMAKE_LOADFLAGS ..." 1>&5
+echo "${as_me-configure}:9574: testing IMAKE_LOADFLAGS $IMAKE_LOADFLAGS ..." 1>&5
 
 fi
 
@@ -9508,7 +9650,7 @@ else
 	IMAKE_LOADFLAGS=
 	test -n "$verbose" && echo "	make fallback definitions" 1>&6
 
-echo "${as_me-configure}:9511: testing make fallback definitions ..." 1>&5
+echo "${as_me-configure}:9653: testing make fallback definitions ..." 1>&5
 
 	# We prefer config.guess' values when we can get them, to avoid
 	# inconsistent results with uname (AIX for instance).  However,
@@ -9623,7 +9765,7 @@ fi
 
 fi
 
-echo "$as_me:9626: checking for default terminal-id" >&5
+echo "$as_me:9768: checking for default terminal-id" >&5
 echo $ECHO_N "checking for default terminal-id... $ECHO_C" >&6
 
 # Check whether --with-terminal-id or --without-terminal-id was given.
@@ -9633,7 +9775,7 @@ if test "${with_terminal_id+set}" = set; then
 else
   default_termid=vt100
 fi;
-echo "$as_me:9636: result: $default_termid" >&5
+echo "$as_me:9778: result: $default_termid" >&5
 echo "${ECHO_T}$default_termid" >&6
 case $default_termid in
 vt*)	default_termid=`echo $default_termid | sed -e 's/^..//'`
@@ -9643,7 +9785,7 @@ cat >>confdefs.h <<EOF
 #define DFT_DECID "$default_termid"
 EOF
 
-echo "$as_me:9646: checking for default terminal-type" >&5
+echo "$as_me:9788: checking for default terminal-type" >&5
 echo $ECHO_N "checking for default terminal-type... $ECHO_C" >&6
 
 # Check whether --with-terminal-type or --without-terminal-type was given.
@@ -9653,13 +9795,13 @@ if test "${with_terminal_type+set}" = set; then
 else
   default_TERM=xterm
 fi;
-echo "$as_me:9656: result: $default_TERM" >&5
+echo "$as_me:9798: result: $default_TERM" >&5
 echo "${ECHO_T}$default_TERM" >&6
 cat >>confdefs.h <<EOF
 #define DFT_TERMTYPE "$default_TERM"
 EOF
 
-echo "$as_me:9662: checking for private terminfo-directory" >&5
+echo "$as_me:9804: checking for private terminfo-directory" >&5
 echo $ECHO_N "checking for private terminfo-directory... $ECHO_C" >&6
 
 # Check whether --with-own-terminfo or --without-own-terminfo was given.
@@ -9669,10 +9811,10 @@ if test "${with_own_terminfo+set}" = set; then
 else
   TERMINFO_DIR=${TERMINFO-none}
 fi;
-echo "$as_me:9672: result: $TERMINFO_DIR" >&5
+echo "$as_me:9814: result: $TERMINFO_DIR" >&5
 echo "${ECHO_T}$TERMINFO_DIR" >&6
 if test "$TERMINFO_DIR" = yes ; then
-	{ echo "$as_me:9675: WARNING: no value given" >&5
+	{ echo "$as_me:9817: WARNING: no value given" >&5
 echo "$as_me: WARNING: no value given" >&2;}
 elif test "$TERMINFO_DIR" != none ; then
 	if test -d $TERMINFO_DIR ; then
@@ -9681,7 +9823,7 @@ elif test "$TERMINFO_DIR" != none ; then
 EOF
 
 	else
-		{ echo "$as_me:9684: WARNING: not a directory" >&5
+		{ echo "$as_me:9826: WARNING: not a directory" >&5
 echo "$as_me: WARNING: not a directory" >&2;}
 	fi
 elif test "$prefix" != NONE ; then
@@ -9699,7 +9841,7 @@ fi
 
 ###############################################################################
 
-echo "$as_me:9702: checking if you want active-icons" >&5
+echo "$as_me:9844: checking if you want active-icons" >&5
 echo $ECHO_N "checking if you want active-icons... $ECHO_C" >&6
 
 # Check whether --enable-active-icon or --disable-active-icon was given.
@@ -9716,7 +9858,7 @@ else
   enable_active_icon=yes
 
 fi;
-echo "$as_me:9719: result: $enable_active_icon" >&5
+echo "$as_me:9861: result: $enable_active_icon" >&5
 echo "${ECHO_T}$enable_active_icon" >&6
 if test "$enable_active_icon" = no ; then
 	cat >>confdefs.h <<\EOF
@@ -9725,7 +9867,7 @@ EOF
 
 fi
 
-echo "$as_me:9728: checking if you want ANSI color" >&5
+echo "$as_me:9870: checking if you want ANSI color" >&5
 echo $ECHO_N "checking if you want ANSI color... $ECHO_C" >&6
 
 # Check whether --enable-ansi-color or --disable-ansi-color was given.
@@ -9742,7 +9884,7 @@ else
   enable_ansi_color=yes
 
 fi;
-echo "$as_me:9745: result: $enable_ansi_color" >&5
+echo "$as_me:9887: result: $enable_ansi_color" >&5
 echo "${ECHO_T}$enable_ansi_color" >&6
 test "$enable_ansi_color" = no && cat >>confdefs.h <<\EOF
 #define OPT_ISO_COLORS 0
@@ -9750,7 +9892,7 @@ EOF
 
 if test "$enable_ansi_color" = yes ; then
 
-	echo "$as_me:9753: checking if you want 16 colors like aixterm" >&5
+	echo "$as_me:9895: checking if you want 16 colors like aixterm" >&5
 echo $ECHO_N "checking if you want 16 colors like aixterm... $ECHO_C" >&6
 
 # Check whether --enable-16-color or --disable-16-color was given.
@@ -9767,13 +9909,13 @@ else
   enable_16_color=yes
 
 fi;
-	echo "$as_me:9770: result: $enable_16_color" >&5
+	echo "$as_me:9912: result: $enable_16_color" >&5
 echo "${ECHO_T}$enable_16_color" >&6
 	test "$enable_16_color" = no && cat >>confdefs.h <<\EOF
 #define OPT_AIX_COLORS 0
 EOF
 
-	echo "$as_me:9776: checking if you want 256 colors" >&5
+	echo "$as_me:9918: checking if you want 256 colors" >&5
 echo $ECHO_N "checking if you want 256 colors... $ECHO_C" >&6
 
 # Check whether --enable-256-color or --disable-256-color was given.
@@ -9790,7 +9932,7 @@ else
   enable_256_color=no
 
 fi;
-	echo "$as_me:9793: result: $enable_256_color" >&5
+	echo "$as_me:9935: result: $enable_256_color" >&5
 echo "${ECHO_T}$enable_256_color" >&6
 	if test "$enable_256_color" = yes ; then
 		CHARPROC_DEPS="$CHARPROC_DEPS 256colres.h"
@@ -9800,7 +9942,7 @@ echo "${ECHO_T}$enable_256_color" >&6
 EOF
 
 	else
-	echo "$as_me:9803: checking if you want 88 colors" >&5
+	echo "$as_me:9945: checking if you want 88 colors" >&5
 echo $ECHO_N "checking if you want 88 colors... $ECHO_C" >&6
 
 # Check whether --enable-88-color or --disable-88-color was given.
@@ -9817,7 +9959,7 @@ else
   enable_88_color=no
 
 fi;
-	echo "$as_me:9820: result: $enable_88_color" >&5
+	echo "$as_me:9962: result: $enable_88_color" >&5
 echo "${ECHO_T}$enable_88_color" >&6
 	if test "$enable_88_color" = yes ; then
 		CHARPROC_DEPS="$CHARPROC_DEPS 88colres.h"
@@ -9831,7 +9973,7 @@ EOF
 
 fi
 
-echo "$as_me:9834: checking if you want blinking cursor" >&5
+echo "$as_me:9976: checking if you want blinking cursor" >&5
 echo $ECHO_N "checking if you want blinking cursor... $ECHO_C" >&6
 
 # Check whether --enable-blink-cursor or --disable-blink-cursor was given.
@@ -9848,13 +9990,13 @@ else
   enable_blink_curs=yes
 
 fi;
-echo "$as_me:9851: result: $enable_blink_curs" >&5
+echo "$as_me:9993: result: $enable_blink_curs" >&5
 echo "${ECHO_T}$enable_blink_curs" >&6
 test "$enable_blink_curs" = no && cat >>confdefs.h <<\EOF
 #define OPT_BLINK_CURS 0
 EOF
 
-echo "$as_me:9857: checking if you want to ignore Linux's broken palette-strings" >&5
+echo "$as_me:9999: checking if you want to ignore Linux's broken palette-strings" >&5
 echo $ECHO_N "checking if you want to ignore Linux's broken palette-strings... $ECHO_C" >&6
 
 case $host_os in #(vi
@@ -9878,7 +10020,7 @@ else
   enable_broken_osc=$enableval
 
 fi;
-echo "$as_me:9881: result: $enable_broken_osc" >&5
+echo "$as_me:10023: result: $enable_broken_osc" >&5
 echo "${ECHO_T}$enable_broken_osc" >&6
 if test "$enable_broken_osc" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -9892,7 +10034,7 @@ EOF
 
 fi
 
-echo "$as_me:9895: checking if you want to allow broken string-terminators" >&5
+echo "$as_me:10037: checking if you want to allow broken string-terminators" >&5
 echo $ECHO_N "checking if you want to allow broken string-terminators... $ECHO_C" >&6
 
 # Check whether --enable-broken-st or --disable-broken-st was given.
@@ -9909,13 +10051,13 @@ else
   enable_broken_st=no
 
 fi;
-echo "$as_me:9912: result: $enable_broken_st" >&5
+echo "$as_me:10054: result: $enable_broken_st" >&5
 echo "${ECHO_T}$enable_broken_st" >&6
 test "$enable_broken_st" = no && cat >>confdefs.h <<\EOF
 #define OPT_BROKEN_ST 0
 EOF
 
-echo "$as_me:9918: checking if you want printable 128-159" >&5
+echo "$as_me:10060: checking if you want printable 128-159" >&5
 echo $ECHO_N "checking if you want printable 128-159... $ECHO_C" >&6
 
 # Check whether --enable-c1-print or --disable-c1-print was given.
@@ -9932,7 +10074,7 @@ else
   enable_c1_print=yes
 
 fi;
-echo "$as_me:9935: result: $enable_c1_print" >&5
+echo "$as_me:10077: result: $enable_c1_print" >&5
 echo "${ECHO_T}$enable_c1_print" >&6
 test "$enable_c1_print" = no && cat >>confdefs.h <<\EOF
 #define OPT_C1_PRINT 0
@@ -9940,7 +10082,7 @@ EOF
 
 if test "$enable_ansi_color" = yes ; then
 
-	echo "$as_me:9943: checking if you want bold colors mapped like IBM PC" >&5
+	echo "$as_me:10085: checking if you want bold colors mapped like IBM PC" >&5
 echo $ECHO_N "checking if you want bold colors mapped like IBM PC... $ECHO_C" >&6
 
 # Check whether --enable-bold-color or --disable-bold-color was given.
@@ -9957,13 +10099,13 @@ else
   enable_pc_color=yes
 
 fi;
-	echo "$as_me:9960: result: $enable_pc_color" >&5
+	echo "$as_me:10102: result: $enable_pc_color" >&5
 echo "${ECHO_T}$enable_pc_color" >&6
 	test "$enable_pc_color" = no && cat >>confdefs.h <<\EOF
 #define OPT_PC_COLORS 0
 EOF
 
-	echo "$as_me:9966: checking if you want separate color-classes" >&5
+	echo "$as_me:10108: checking if you want separate color-classes" >&5
 echo $ECHO_N "checking if you want separate color-classes... $ECHO_C" >&6
 
 # Check whether --enable-color-class or --disable-color-class was given.
@@ -9980,13 +10122,13 @@ else
   enable_color_class=yes
 
 fi;
-	echo "$as_me:9983: result: $enable_color_class" >&5
+	echo "$as_me:10125: result: $enable_color_class" >&5
 echo "${ECHO_T}$enable_color_class" >&6
 	test "$enable_color_class" = no && cat >>confdefs.h <<\EOF
 #define OPT_COLOR_CLASS FALSE
 EOF
 
-	echo "$as_me:9989: checking if you want color-mode enabled by default" >&5
+	echo "$as_me:10131: checking if you want color-mode enabled by default" >&5
 echo $ECHO_N "checking if you want color-mode enabled by default... $ECHO_C" >&6
 
 # Check whether --enable-color-mode or --disable-color-mode was given.
@@ -10003,7 +10145,7 @@ else
   default_colormode=yes
 
 fi;
-	echo "$as_me:10006: result: $default_colormode" >&5
+	echo "$as_me:10148: result: $default_colormode" >&5
 echo "${ECHO_T}$default_colormode" >&6
 	test "$default_colormode" = no && cat >>confdefs.h <<\EOF
 #define DFT_COLORMODE FALSE
@@ -10011,7 +10153,7 @@ EOF
 
 fi
 
-echo "$as_me:10014: checking if you want support for color highlighting" >&5
+echo "$as_me:10156: checking if you want support for color highlighting" >&5
 echo $ECHO_N "checking if you want support for color highlighting... $ECHO_C" >&6
 
 # Check whether --enable-highlighting or --disable-highlighting was given.
@@ -10028,13 +10170,13 @@ else
   default_highlight=yes
 
 fi;
-echo "$as_me:10031: result: $default_highlight" >&5
+echo "$as_me:10173: result: $default_highlight" >&5
 echo "${ECHO_T}$default_highlight" >&6
 test "$default_highlight" = no && cat >>confdefs.h <<\EOF
 #define OPT_HIGHLIGHT_COLOR 0
 EOF
 
-echo "$as_me:10037: checking if you want support for doublesize characters" >&5
+echo "$as_me:10179: checking if you want support for doublesize characters" >&5
 echo $ECHO_N "checking if you want support for doublesize characters... $ECHO_C" >&6
 
 # Check whether --enable-doublechars or --disable-doublechars was given.
@@ -10051,13 +10193,13 @@ else
   enable_doublechars=yes
 
 fi;
-echo "$as_me:10054: result: $enable_doublechars" >&5
+echo "$as_me:10196: result: $enable_doublechars" >&5
 echo "${ECHO_T}$enable_doublechars" >&6
 test "$enable_doublechars" = no && cat >>confdefs.h <<\EOF
 #define OPT_DEC_CHRSET 0
 EOF
 
-echo "$as_me:10060: checking if you want fallback-support for box characters" >&5
+echo "$as_me:10202: checking if you want fallback-support for box characters" >&5
 echo $ECHO_N "checking if you want fallback-support for box characters... $ECHO_C" >&6
 
 # Check whether --enable-boxchars or --disable-boxchars was given.
@@ -10074,13 +10216,13 @@ else
   enable_boxchars=yes
 
 fi;
-echo "$as_me:10077: result: $enable_boxchars" >&5
+echo "$as_me:10219: result: $enable_boxchars" >&5
 echo "${ECHO_T}$enable_boxchars" >&6
 test "$enable_boxchars" = no && cat >>confdefs.h <<\EOF
 #define OPT_BOX_CHARS 0
 EOF
 
-echo "$as_me:10083: checking if you want to allow spawning new xterms" >&5
+echo "$as_me:10225: checking if you want to allow spawning new xterms" >&5
 echo $ECHO_N "checking if you want to allow spawning new xterms... $ECHO_C" >&6
 
 # Check whether --enable-exec-xterm or --disable-exec-xterm was given.
@@ -10097,11 +10239,11 @@ else
   enable_exec_xterm=no
 
 fi;
-echo "$as_me:10100: result: $enable_exec_xterm" >&5
+echo "$as_me:10242: result: $enable_exec_xterm" >&5
 echo "${ECHO_T}$enable_exec_xterm" >&6
 if test "$enable_exec_xterm" = yes ; then
 
-echo "$as_me:10104: checking for proc tree with cwd-support" >&5
+echo "$as_me:10246: checking for proc tree with cwd-support" >&5
 echo $ECHO_N "checking for proc tree with cwd-support... $ECHO_C" >&6
 if test "${cf_cv_procfs_cwd+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -10120,11 +10262,11 @@ do
 done
 
 fi
-echo "$as_me:10123: result: $cf_cv_procfs_cwd" >&5
+echo "$as_me:10265: result: $cf_cv_procfs_cwd" >&5
 echo "${ECHO_T}$cf_cv_procfs_cwd" >&6
 
 	if test "$cf_cv_procfs_cwd" = no ; then
-		{ echo "$as_me:10127: WARNING: no suitable proc filesystem found" >&5
+		{ echo "$as_me:10269: WARNING: no suitable proc filesystem found" >&5
 echo "$as_me: WARNING: no suitable proc filesystem found" >&2;}
 	else
 		cat >>confdefs.h <<EOF
@@ -10138,7 +10280,7 @@ EOF
 	fi
 fi
 
-echo "$as_me:10141: checking if you want to use FreeType library" >&5
+echo "$as_me:10283: checking if you want to use FreeType library" >&5
 echo $ECHO_N "checking if you want to use FreeType library... $ECHO_C" >&6
 
 # Check whether --enable-freetype or --disable-freetype was given.
@@ -10155,7 +10297,7 @@ else
   enable_freetype=yes
 
 fi;
-echo "$as_me:10158: result: $enable_freetype" >&5
+echo "$as_me:10300: result: $enable_freetype" >&5
 echo "${ECHO_T}$enable_freetype" >&6
 if test "$enable_freetype" = yes ; then
 
@@ -10163,7 +10305,7 @@ cf_extra_freetype_libs=
 FREETYPE_CONFIG=
 FREETYPE_PARAMS=
 
-echo "$as_me:10166: checking if you specified -D/-I options for FreeType" >&5
+echo "$as_me:10308: checking if you specified -D/-I options for FreeType" >&5
 echo $ECHO_N "checking if you specified -D/-I options for FreeType... $ECHO_C" >&6
 
 # Check whether --with-freetype-cflags or --without-freetype-cflags was given.
@@ -10173,10 +10315,10 @@ if test "${with_freetype_cflags+set}" = set; then
 else
   cf_cv_x_freetype_incs=no
 fi;
-echo "$as_me:10176: result: $cf_cv_x_freetype_incs" >&5
+echo "$as_me:10318: result: $cf_cv_x_freetype_incs" >&5
 echo "${ECHO_T}$cf_cv_x_freetype_incs" >&6
 
-echo "$as_me:10179: checking if you specified -L/-l options for FreeType" >&5
+echo "$as_me:10321: checking if you specified -L/-l options for FreeType" >&5
 echo $ECHO_N "checking if you specified -L/-l options for FreeType... $ECHO_C" >&6
 
 # Check whether --with-freetype-libs or --without-freetype-libs was given.
@@ -10186,12 +10328,12 @@ if test "${with_freetype_libs+set}" = set; then
 else
   cf_cv_x_freetype_libs=no
 fi;
-echo "$as_me:10189: result: $cf_cv_x_freetype_libs" >&5
+echo "$as_me:10331: result: $cf_cv_x_freetype_libs" >&5
 echo "${ECHO_T}$cf_cv_x_freetype_libs" >&6
 
 # Extract the first word of "pkg-config", so it can be a program name with args.
 set dummy pkg-config; ac_word=$2
-echo "$as_me:10194: checking for $ac_word" >&5
+echo "$as_me:10336: checking for $ac_word" >&5
 echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
 if test "${ac_cv_path_FREETYPE_PKG_CONFIG+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -10208,7 +10350,7 @@ for ac_dir in $ac_dummy; do
   test -z "$ac_dir" && ac_dir=.
   if $as_executable_p "$ac_dir/$ac_word"; then
    ac_cv_path_FREETYPE_PKG_CONFIG="$ac_dir/$ac_word"
-   echo "$as_me:10211: found $ac_dir/$ac_word" >&5
+   echo "$as_me:10353: found $ac_dir/$ac_word" >&5
    break
 fi
 done
@@ -10220,10 +10362,10 @@ fi
 FREETYPE_PKG_CONFIG=$ac_cv_path_FREETYPE_PKG_CONFIG
 
 if test -n "$FREETYPE_PKG_CONFIG"; then
-  echo "$as_me:10223: result: $FREETYPE_PKG_CONFIG" >&5
+  echo "$as_me:10365: result: $FREETYPE_PKG_CONFIG" >&5
 echo "${ECHO_T}$FREETYPE_PKG_CONFIG" >&6
 else
-  echo "$as_me:10226: result: no" >&5
+  echo "$as_me:10368: result: no" >&5
 echo "${ECHO_T}no" >&6
 fi
 
@@ -10233,7 +10375,7 @@ if test "$FREETYPE_PKG_CONFIG" != none && "$FREETYPE_PKG_CONFIG" --exists xft; t
 else
 	# Extract the first word of "xft-config", so it can be a program name with args.
 set dummy xft-config; ac_word=$2
-echo "$as_me:10236: checking for $ac_word" >&5
+echo "$as_me:10378: checking for $ac_word" >&5
 echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
 if test "${ac_cv_path_FREETYPE_XFT_CONFIG+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -10250,7 +10392,7 @@ for ac_dir in $ac_dummy; do
   test -z "$ac_dir" && ac_dir=.
   if $as_executable_p "$ac_dir/$ac_word"; then
    ac_cv_path_FREETYPE_XFT_CONFIG="$ac_dir/$ac_word"
-   echo "$as_me:10253: found $ac_dir/$ac_word" >&5
+   echo "$as_me:10395: found $ac_dir/$ac_word" >&5
    break
 fi
 done
@@ -10262,10 +10404,10 @@ fi
 FREETYPE_XFT_CONFIG=$ac_cv_path_FREETYPE_XFT_CONFIG
 
 if test -n "$FREETYPE_XFT_CONFIG"; then
-  echo "$as_me:10265: result: $FREETYPE_XFT_CONFIG" >&5
+  echo "$as_me:10407: result: $FREETYPE_XFT_CONFIG" >&5
 echo "${ECHO_T}$FREETYPE_XFT_CONFIG" >&6
 else
-  echo "$as_me:10268: result: no" >&5
+  echo "$as_me:10410: result: no" >&5
 echo "${ECHO_T}no" >&6
 fi
 
@@ -10275,7 +10417,7 @@ fi
 		cf_extra_freetype_libs="-lXft"
 		# Extract the first word of "freetype-config", so it can be a program name with args.
 set dummy freetype-config; ac_word=$2
-echo "$as_me:10278: checking for $ac_word" >&5
+echo "$as_me:10420: checking for $ac_word" >&5
 echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
 if test "${ac_cv_path_FREETYPE_OLD_CONFIG+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -10292,7 +10434,7 @@ for ac_dir in $ac_dummy; do
   test -z "$ac_dir" && ac_dir=.
   if $as_executable_p "$ac_dir/$ac_word"; then
    ac_cv_path_FREETYPE_OLD_CONFIG="$ac_dir/$ac_word"
-   echo "$as_me:10295: found $ac_dir/$ac_word" >&5
+   echo "$as_me:10437: found $ac_dir/$ac_word" >&5
    break
 fi
 done
@@ -10304,10 +10446,10 @@ fi
 FREETYPE_OLD_CONFIG=$ac_cv_path_FREETYPE_OLD_CONFIG
 
 if test -n "$FREETYPE_OLD_CONFIG"; then
-  echo "$as_me:10307: result: $FREETYPE_OLD_CONFIG" >&5
+  echo "$as_me:10449: result: $FREETYPE_OLD_CONFIG" >&5
 echo "${ECHO_T}$FREETYPE_OLD_CONFIG" >&6
 else
-  echo "$as_me:10310: result: no" >&5
+  echo "$as_me:10452: result: no" >&5
 echo "${ECHO_T}no" >&6
 fi
 
@@ -10320,18 +10462,18 @@ fi
 if test -n "$FREETYPE_CONFIG" ; then
 
 if test "$cf_cv_x_freetype_incs" = no ; then
-echo "$as_me:10323: checking for $FREETYPE_CONFIG cflags" >&5
+echo "$as_me:10465: checking for $FREETYPE_CONFIG cflags" >&5
 echo $ECHO_N "checking for $FREETYPE_CONFIG cflags... $ECHO_C" >&6
 cf_cv_x_freetype_incs="`$FREETYPE_CONFIG $FREETYPE_PARAMS --cflags 2>/dev/null`"
-echo "$as_me:10326: result: $cf_cv_x_freetype_incs" >&5
+echo "$as_me:10468: result: $cf_cv_x_freetype_incs" >&5
 echo "${ECHO_T}$cf_cv_x_freetype_incs" >&6
 fi
 
 if test "$cf_cv_x_freetype_libs" = no ; then
-echo "$as_me:10331: checking for $FREETYPE_CONFIG libs" >&5
+echo "$as_me:10473: checking for $FREETYPE_CONFIG libs" >&5
 echo $ECHO_N "checking for $FREETYPE_CONFIG libs... $ECHO_C" >&6
 cf_cv_x_freetype_libs="$cf_extra_freetype_libs `$FREETYPE_CONFIG $FREETYPE_PARAMS --libs 2>/dev/null`"
-echo "$as_me:10334: result: $cf_cv_x_freetype_libs" >&5
+echo "$as_me:10476: result: $cf_cv_x_freetype_libs" >&5
 echo "${ECHO_T}$cf_cv_x_freetype_libs" >&6
 fi
 
@@ -10345,7 +10487,7 @@ if test "$cf_cv_x_freetype_libs" = no ; then
 	cf_cv_x_freetype_libs=-lXft
 fi
 
-echo "$as_me:10348: checking if we can link with FreeType libraries" >&5
+echo "$as_me:10490: checking if we can link with FreeType libraries" >&5
 echo $ECHO_N "checking if we can link with FreeType libraries... $ECHO_C" >&6
 
 cf_save_LIBS="$LIBS"
@@ -10355,7 +10497,7 @@ LIBS="$cf_cv_x_freetype_libs $LIBS"
 CPPFLAGS="$cf_cv_x_freetype_incs $CPPFLAGS"
 
 cat >conftest.$ac_ext <<_ACEOF
-#line 10358 "configure"
+#line 10500 "configure"
 #include "confdefs.h"
 
 #include <X11/Xlib.h>
@@ -10371,16 +10513,16 @@ main ()
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:10374: \"$ac_link\"") >&5
+if { (eval echo "$as_me:10516: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:10377: \$? = $ac_status" >&5
+  echo "$as_me:10519: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:10380: \"$ac_try\"") >&5
+  { (eval echo "$as_me:10522: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:10383: \$? = $ac_status" >&5
+  echo "$as_me:10525: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_found_freetype=yes
 else
@@ -10389,7 +10531,7 @@ cat conftest.$ac_ext >&5
 cf_cv_found_freetype=no
 fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
-echo "$as_me:10392: result: $cf_cv_found_freetype" >&5
+echo "$as_me:10534: result: $cf_cv_found_freetype" >&5
 echo "${ECHO_T}$cf_cv_found_freetype" >&6
 
 LIBS="$cf_save_LIBS"
@@ -10477,13 +10619,13 @@ for ac_func in \
 
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:10480: checking for $ac_func" >&5
+echo "$as_me:10622: checking for $ac_func" >&5
 echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
 if eval "test \"\${$as_ac_var+set}\" = set"; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line 10486 "configure"
+#line 10628 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func (); below.  */
@@ -10514,16 +10656,16 @@ f = $ac_func;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:10517: \"$ac_link\"") >&5
+if { (eval echo "$as_me:10659: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:10520: \$? = $ac_status" >&5
+  echo "$as_me:10662: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:10523: \"$ac_try\"") >&5
+  { (eval echo "$as_me:10665: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:10526: \$? = $ac_status" >&5
+  echo "$as_me:10668: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
@@ -10533,7 +10675,7 @@ eval "$as_ac_var=no"
 fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:10536: result: `eval echo '${'$as_ac_var'}'`" >&5
+echo "$as_me:10678: result: `eval echo '${'$as_ac_var'}'`" >&5
 echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<EOF
@@ -10544,7 +10686,7 @@ fi
 done
 
 else
-	{ echo "$as_me:10547: WARNING: No libraries found for FreeType" >&5
+	{ echo "$as_me:10689: WARNING: No libraries found for FreeType" >&5
 echo "$as_me: WARNING: No libraries found for FreeType" >&2;}
 	CPPFLAGS=`echo "$CPPFLAGS" | sed -e s/-DXRENDERFONT//`
 fi
@@ -10555,7 +10697,7 @@ else
 	CPPFLAGS=`echo "$CPPFLAGS" | sed -e s/-DXRENDERFONT//`
 fi
 
-echo "$as_me:10558: checking if you want support for HP-style function keys" >&5
+echo "$as_me:10700: checking if you want support for HP-style function keys" >&5
 echo $ECHO_N "checking if you want support for HP-style function keys... $ECHO_C" >&6
 
 # Check whether --enable-hp-fkeys or --disable-hp-fkeys was given.
@@ -10572,7 +10714,7 @@ else
   enable_hp_fkeys=no
 
 fi;
-echo "$as_me:10575: result: $enable_hp_fkeys" >&5
+echo "$as_me:10717: result: $enable_hp_fkeys" >&5
 echo "${ECHO_T}$enable_hp_fkeys" >&6
 if test "$enable_hp_fkeys" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -10581,7 +10723,7 @@ EOF
 
 fi
 
-echo "$as_me:10584: checking if you want support for SCO-style function keys" >&5
+echo "$as_me:10726: checking if you want support for SCO-style function keys" >&5
 echo $ECHO_N "checking if you want support for SCO-style function keys... $ECHO_C" >&6
 
 # Check whether --enable-sco-fkeys or --disable-sco-fkeys was given.
@@ -10598,7 +10740,7 @@ else
   enable_sco_fkeys=no
 
 fi;
-echo "$as_me:10601: result: $enable_sco_fkeys" >&5
+echo "$as_me:10743: result: $enable_sco_fkeys" >&5
 echo "${ECHO_T}$enable_sco_fkeys" >&6
 if test "$enable_sco_fkeys" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -10607,7 +10749,7 @@ EOF
 
 fi
 
-echo "$as_me:10610: checking if you want support for Sun-style function keys" >&5
+echo "$as_me:10752: checking if you want support for Sun-style function keys" >&5
 echo $ECHO_N "checking if you want support for Sun-style function keys... $ECHO_C" >&6
 
 # Check whether --enable-sun-fkeys or --disable-sun-fkeys was given.
@@ -10624,7 +10766,7 @@ else
   enable_sun_fkeys=yes
 
 fi;
-echo "$as_me:10627: result: $enable_sun_fkeys" >&5
+echo "$as_me:10769: result: $enable_sun_fkeys" >&5
 echo "${ECHO_T}$enable_sun_fkeys" >&6
 if test "$enable_sun_fkeys" = no ; then
 	cat >>confdefs.h <<\EOF
@@ -10633,7 +10775,7 @@ EOF
 
 fi
 
-echo "$as_me:10636: checking if you want support for internationalization" >&5
+echo "$as_me:10778: checking if you want support for internationalization" >&5
 echo $ECHO_N "checking if you want support for internationalization... $ECHO_C" >&6
 
 # Check whether --enable-i18n or --disable-i18n was given.
@@ -10650,7 +10792,7 @@ else
   enable_i18n=yes
 
 fi;
-echo "$as_me:10653: result: $enable_i18n" >&5
+echo "$as_me:10795: result: $enable_i18n" >&5
 echo "${ECHO_T}$enable_i18n" >&6
 if test "$enable_i18n" = no ; then
 	cat >>confdefs.h <<\EOF
@@ -10659,7 +10801,7 @@ EOF
 
 fi
 
-echo "$as_me:10662: checking if you want support for initial-erase setup" >&5
+echo "$as_me:10804: checking if you want support for initial-erase setup" >&5
 echo $ECHO_N "checking if you want support for initial-erase setup... $ECHO_C" >&6
 
 # Check whether --enable-initial-erase or --disable-initial-erase was given.
@@ -10676,7 +10818,7 @@ else
   enable_ie=yes
 
 fi;
-echo "$as_me:10679: result: $enable_ie" >&5
+echo "$as_me:10821: result: $enable_ie" >&5
 echo "${ECHO_T}$enable_ie" >&6
 if test "$enable_ie" = no ; then
 	cat >>confdefs.h <<\EOF
@@ -10685,7 +10827,7 @@ EOF
 
 fi
 
-echo "$as_me:10688: checking if you want support for input-method" >&5
+echo "$as_me:10830: checking if you want support for input-method" >&5
 echo $ECHO_N "checking if you want support for input-method... $ECHO_C" >&6
 
 # Check whether --enable-input-method or --disable-input-method was given.
@@ -10702,17 +10844,17 @@ else
   enable_ximp=yes
 
 fi;
-echo "$as_me:10705: result: $enable_ximp" >&5
+echo "$as_me:10847: result: $enable_ximp" >&5
 echo "${ECHO_T}$enable_ximp" >&6
 
-echo "$as_me:10708: checking if X libraries support input-method" >&5
+echo "$as_me:10850: checking if X libraries support input-method" >&5
 echo $ECHO_N "checking if X libraries support input-method... $ECHO_C" >&6
 if test "${cf_cv_input_method+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 cat >conftest.$ac_ext <<_ACEOF
-#line 10715 "configure"
+#line 10857 "configure"
 #include "confdefs.h"
 
 #include <X11/IntrinsicP.h>
@@ -10744,16 +10886,16 @@ main ()
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:10747: \"$ac_link\"") >&5
+if { (eval echo "$as_me:10889: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:10750: \$? = $ac_status" >&5
+  echo "$as_me:10892: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:10753: \"$ac_try\"") >&5
+  { (eval echo "$as_me:10895: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:10756: \$? = $ac_status" >&5
+  echo "$as_me:10898: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_input_method=yes
 else
@@ -10763,7 +10905,7 @@ cf_cv_input_method=no
 fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:10766: result: $cf_cv_input_method" >&5
+echo "$as_me:10908: result: $cf_cv_input_method" >&5
 echo "${ECHO_T}$cf_cv_input_method" >&6
 
 test "$cf_cv_input_method" = no && enable_ximp=no
@@ -10774,7 +10916,7 @@ EOF
 
 fi
 
-echo "$as_me:10777: checking if you want support for load-vt-fonts" >&5
+echo "$as_me:10919: checking if you want support for load-vt-fonts" >&5
 echo $ECHO_N "checking if you want support for load-vt-fonts... $ECHO_C" >&6
 
 # Check whether --enable-load-vt-fonts or --disable-load-vt-fonts was given.
@@ -10791,7 +10933,7 @@ else
   enable_load_vt_fonts=no
 
 fi;
-echo "$as_me:10794: result: $enable_load_vt_fonts" >&5
+echo "$as_me:10936: result: $enable_load_vt_fonts" >&5
 echo "${ECHO_T}$enable_load_vt_fonts" >&6
 if test "$enable_load_vt_fonts" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -10800,7 +10942,7 @@ EOF
 
 fi
 
-echo "$as_me:10803: checking if you want support for logging" >&5
+echo "$as_me:10945: checking if you want support for logging" >&5
 echo $ECHO_N "checking if you want support for logging... $ECHO_C" >&6
 
 # Check whether --enable-logging or --disable-logging was given.
@@ -10817,14 +10959,14 @@ else
   enable_logging=no
 
 fi;
-echo "$as_me:10820: result: $enable_logging" >&5
+echo "$as_me:10962: result: $enable_logging" >&5
 echo "${ECHO_T}$enable_logging" >&6
 if test "$enable_logging" = yes ; then
 	cat >>confdefs.h <<\EOF
 #define ALLOWLOGGING 1
 EOF
 
-	echo "$as_me:10827: checking if you want to allow logging via a pipe" >&5
+	echo "$as_me:10969: checking if you want to allow logging via a pipe" >&5
 echo $ECHO_N "checking if you want to allow logging via a pipe... $ECHO_C" >&6
 
 # Check whether --enable-logfile-exec or --disable-logfile-exec was given.
@@ -10841,7 +10983,7 @@ else
   enable_log_exec=no
 
 fi;
-	echo "$as_me:10844: result: $enable_log_exec" >&5
+	echo "$as_me:10986: result: $enable_log_exec" >&5
 echo "${ECHO_T}$enable_log_exec" >&6
 	if test "$enable_log_exec" = yes ; then
 		cat >>confdefs.h <<\EOF
@@ -10851,7 +10993,7 @@ EOF
 	fi
 fi
 
-echo "$as_me:10854: checking if you want support for iconify/maximize translations" >&5
+echo "$as_me:10996: checking if you want support for iconify/maximize translations" >&5
 echo $ECHO_N "checking if you want support for iconify/maximize translations... $ECHO_C" >&6
 
 # Check whether --enable-maximize or --disable-maximize was given.
@@ -10868,13 +11010,13 @@ else
   enable_maximize=yes
 
 fi;
-echo "$as_me:10871: result: $enable_maximize" >&5
+echo "$as_me:11013: result: $enable_maximize" >&5
 echo "${ECHO_T}$enable_maximize" >&6
 test "$enable_maximize" = no && cat >>confdefs.h <<\EOF
 #define OPT_MAXIMIZE 0
 EOF
 
-echo "$as_me:10877: checking if you want NumLock to override keyboard tables" >&5
+echo "$as_me:11019: checking if you want NumLock to override keyboard tables" >&5
 echo $ECHO_N "checking if you want NumLock to override keyboard tables... $ECHO_C" >&6
 
 # Check whether --enable-num-lock or --disable-num-lock was given.
@@ -10891,30 +11033,30 @@ else
   enable_numlock=yes
 
 fi;
-echo "$as_me:10894: result: $enable_numlock" >&5
+echo "$as_me:11036: result: $enable_numlock" >&5
 echo "${ECHO_T}$enable_numlock" >&6
 test "$enable_numlock" = no && cat >>confdefs.h <<\EOF
 #define OPT_NUM_LOCK 0
 EOF
 
-echo "$as_me:10900: checking if you want support for get/set of base64 selection data" >&5
+echo "$as_me:11042: checking if you want support for get/set of base64 selection data" >&5
 echo $ECHO_N "checking if you want support for get/set of base64 selection data... $ECHO_C" >&6
 
 # Check whether --enable-paste64 or --disable-paste64 was given.
 if test "${enable_paste64+set}" = set; then
   enableval="$enable_paste64"
-  test "$enableval" != yes && enableval=no
-  if test "$enableval" != "no" ; then
-    enable_paste64=yes
-  else
+  test "$enableval" != no && enableval=yes
+  if test "$enableval" != "yes" ; then
     enable_paste64=no
+  else
+    enable_paste64=yes
   fi
 else
-  enableval=no
-  enable_paste64=no
+  enableval=yes
+  enable_paste64=yes
 
 fi;
-echo "$as_me:10917: result: $enable_paste64" >&5
+echo "$as_me:11059: result: $enable_paste64" >&5
 echo "${ECHO_T}$enable_paste64" >&6
 if test "$enable_paste64" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -10928,7 +11070,7 @@ EOF
 
 fi
 
-echo "$as_me:10931: checking if you want support for pty-handshaking" >&5
+echo "$as_me:11073: checking if you want support for pty-handshaking" >&5
 echo $ECHO_N "checking if you want support for pty-handshaking... $ECHO_C" >&6
 
 # Check whether --enable-pty-handshake or --disable-pty-handshake was given.
@@ -10945,7 +11087,7 @@ else
   enable_pty_handshake=yes
 
 fi;
-echo "$as_me:10948: result: $enable_pty_handshake" >&5
+echo "$as_me:11090: result: $enable_pty_handshake" >&5
 echo "${ECHO_T}$enable_pty_handshake" >&6
 if test "$enable_pty_handshake" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -10959,7 +11101,7 @@ EOF
 
 fi
 
-echo "$as_me:10962: checking if you want support for mouse in readline applications" >&5
+echo "$as_me:11104: checking if you want support for mouse in readline applications" >&5
 echo $ECHO_N "checking if you want support for mouse in readline applications... $ECHO_C" >&6
 
 # Check whether --enable-readline-mouse or --disable-readline-mouse was given.
@@ -10976,7 +11118,7 @@ else
   enable_readline_mouse=no
 
 fi;
-echo "$as_me:10979: result: $enable_readline_mouse" >&5
+echo "$as_me:11121: result: $enable_readline_mouse" >&5
 echo "${ECHO_T}$enable_readline_mouse" >&6
 if test "$enable_readline_mouse" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -10985,7 +11127,7 @@ EOF
 
 fi
 
-echo "$as_me:10988: checking if you want support for regular-expression selections" >&5
+echo "$as_me:11130: checking if you want support for regular-expression selections" >&5
 echo $ECHO_N "checking if you want support for regular-expression selections... $ECHO_C" >&6
 
 # Check whether --enable-regex or --disable-regex was given.
@@ -11002,11 +11144,11 @@ else
   enable_regex=yes
 
 fi;
-echo "$as_me:11005: result: $enable_regex" >&5
+echo "$as_me:11147: result: $enable_regex" >&5
 echo "${ECHO_T}$enable_regex" >&6
 if test "$enable_regex" = yes ; then
 
-echo "$as_me:11009: checking if you want to use PCRE for regular-expressions" >&5
+echo "$as_me:11151: checking if you want to use PCRE for regular-expressions" >&5
 echo $ECHO_N "checking if you want to use PCRE for regular-expressions... $ECHO_C" >&6
 
 # Check whether --with-pcre or --without-pcre was given.
@@ -11015,11 +11157,11 @@ if test "${with_pcre+set}" = set; then
 
 fi;
 test -z "$with_pcre" && with_pcre=no
-echo "$as_me:11018: result: $with_pcre" >&5
+echo "$as_me:11160: result: $with_pcre" >&5
 echo "${ECHO_T}$with_pcre" >&6
 
 if test "$with_pcre" != no ; then
-	echo "$as_me:11022: checking for pcre_compile in -lpcre" >&5
+	echo "$as_me:11164: checking for pcre_compile in -lpcre" >&5
 echo $ECHO_N "checking for pcre_compile in -lpcre... $ECHO_C" >&6
 if test "${ac_cv_lib_pcre_pcre_compile+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -11027,7 +11169,7 @@ else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lpcre  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
-#line 11030 "configure"
+#line 11172 "configure"
 #include "confdefs.h"
 
 /* Override any gcc2 internal prototype to avoid an error.  */
@@ -11046,16 +11188,16 @@ pcre_compile ();
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:11049: \"$ac_link\"") >&5
+if { (eval echo "$as_me:11191: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:11052: \$? = $ac_status" >&5
+  echo "$as_me:11194: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:11055: \"$ac_try\"") >&5
+  { (eval echo "$as_me:11197: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:11058: \$? = $ac_status" >&5
+  echo "$as_me:11200: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_pcre_pcre_compile=yes
 else
@@ -11066,26 +11208,26 @@ fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:11069: result: $ac_cv_lib_pcre_pcre_compile" >&5
+echo "$as_me:11211: result: $ac_cv_lib_pcre_pcre_compile" >&5
 echo "${ECHO_T}$ac_cv_lib_pcre_pcre_compile" >&6
 if test $ac_cv_lib_pcre_pcre_compile = yes; then
-  echo "$as_me:11072: checking for pcreposix.h" >&5
+  echo "$as_me:11214: checking for pcreposix.h" >&5
 echo $ECHO_N "checking for pcreposix.h... $ECHO_C" >&6
 if test "${ac_cv_header_pcreposix_h+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line 11078 "configure"
+#line 11220 "configure"
 #include "confdefs.h"
 #include <pcreposix.h>
 _ACEOF
-if { (eval echo "$as_me:11082: \"$ac_cpp conftest.$ac_ext\"") >&5
+if { (eval echo "$as_me:11224: \"$ac_cpp conftest.$ac_ext\"") >&5
   (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
   ac_status=$?
   egrep -v '^ *\+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
-  echo "$as_me:11088: \$? = $ac_status" >&5
+  echo "$as_me:11230: \$? = $ac_status" >&5
   (exit $ac_status); } >/dev/null; then
   if test -s conftest.err; then
     ac_cpp_err=$ac_c_preproc_warn_flag
@@ -11104,10 +11246,10 @@ else
 fi
 rm -f conftest.err conftest.$ac_ext
 fi
-echo "$as_me:11107: result: $ac_cv_header_pcreposix_h" >&5
+echo "$as_me:11249: result: $ac_cv_header_pcreposix_h" >&5
 echo "${ECHO_T}$ac_cv_header_pcreposix_h" >&6
 if test $ac_cv_header_pcreposix_h = yes; then
-  echo "$as_me:11110: checking for pcreposix_regcomp in -lpcreposix" >&5
+  echo "$as_me:11252: checking for pcreposix_regcomp in -lpcreposix" >&5
 echo $ECHO_N "checking for pcreposix_regcomp in -lpcreposix... $ECHO_C" >&6
 if test "${ac_cv_lib_pcreposix_pcreposix_regcomp+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -11115,7 +11257,7 @@ else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lpcreposix "-lpcre" $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
-#line 11118 "configure"
+#line 11260 "configure"
 #include "confdefs.h"
 
 /* Override any gcc2 internal prototype to avoid an error.  */
@@ -11134,16 +11276,16 @@ pcreposix_regcomp ();
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:11137: \"$ac_link\"") >&5
+if { (eval echo "$as_me:11279: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:11140: \$? = $ac_status" >&5
+  echo "$as_me:11282: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:11143: \"$ac_try\"") >&5
+  { (eval echo "$as_me:11285: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:11146: \$? = $ac_status" >&5
+  echo "$as_me:11288: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   ac_cv_lib_pcreposix_pcreposix_regcomp=yes
 else
@@ -11154,7 +11296,7 @@ fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:11157: result: $ac_cv_lib_pcreposix_pcreposix_regcomp" >&5
+echo "$as_me:11299: result: $ac_cv_lib_pcreposix_pcreposix_regcomp" >&5
 echo "${ECHO_T}$ac_cv_lib_pcreposix_pcreposix_regcomp" >&6
 if test $ac_cv_lib_pcreposix_pcreposix_regcomp = yes; then
   cat >>confdefs.h <<\EOF
@@ -11167,19 +11309,19 @@ EOF
 
 				 LIBS="-lpcreposix -lpcre $LIBS"
 else
-  { { echo "$as_me:11170: error: Cannot find PCRE POSIX library" >&5
+  { { echo "$as_me:11312: error: Cannot find PCRE POSIX library" >&5
 echo "$as_me: error: Cannot find PCRE POSIX library" >&2;}
    { (exit 1); exit 1; }; }
 fi
 
 else
-  { { echo "$as_me:11176: error: Cannot find PCRE POSIX header" >&5
+  { { echo "$as_me:11318: error: Cannot find PCRE POSIX header" >&5
 echo "$as_me: error: Cannot find PCRE POSIX header" >&2;}
    { (exit 1); exit 1; }; }
 fi
 
 else
-  { { echo "$as_me:11182: error: Cannot find PCRE library" >&5
+  { { echo "$as_me:11324: error: Cannot find PCRE library" >&5
 echo "$as_me: error: Cannot find PCRE library" >&2;}
    { (exit 1); exit 1; }; }
 fi
@@ -11188,14 +11330,14 @@ fi
 
 	if test "$with_pcre" = no ; then
 
-echo "$as_me:11191: checking for regular-expression headers" >&5
+echo "$as_me:11333: checking for regular-expression headers" >&5
 echo $ECHO_N "checking for regular-expression headers... $ECHO_C" >&6
 if test "${cf_cv_regex+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
 
 cat >conftest.$ac_ext <<_ACEOF
-#line 11198 "configure"
+#line 11340 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <regex.h>
@@ -11213,16 +11355,16 @@ main ()
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:11216: \"$ac_link\"") >&5
+if { (eval echo "$as_me:11358: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:11219: \$? = $ac_status" >&5
+  echo "$as_me:11361: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:11222: \"$ac_try\"") >&5
+  { (eval echo "$as_me:11364: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:11225: \$? = $ac_status" >&5
+  echo "$as_me:11367: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_regex="regex.h"
 else
@@ -11230,7 +11372,7 @@ else
 cat conftest.$ac_ext >&5
 
 	cat >conftest.$ac_ext <<_ACEOF
-#line 11233 "configure"
+#line 11375 "configure"
 #include "confdefs.h"
 #include <regexp.h>
 int
@@ -11245,16 +11387,16 @@ main ()
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:11248: \"$ac_link\"") >&5
+if { (eval echo "$as_me:11390: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:11251: \$? = $ac_status" >&5
+  echo "$as_me:11393: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:11254: \"$ac_try\"") >&5
+  { (eval echo "$as_me:11396: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:11257: \$? = $ac_status" >&5
+  echo "$as_me:11399: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_regex="regexp.h"
 else
@@ -11264,7 +11406,7 @@ cat conftest.$ac_ext >&5
 		cf_save_LIBS="$LIBS"
 		LIBS="-lgen $LIBS"
 		cat >conftest.$ac_ext <<_ACEOF
-#line 11267 "configure"
+#line 11409 "configure"
 #include "confdefs.h"
 #include <regexpr.h>
 int
@@ -11279,16 +11421,16 @@ main ()
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:11282: \"$ac_link\"") >&5
+if { (eval echo "$as_me:11424: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:11285: \$? = $ac_status" >&5
+  echo "$as_me:11427: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:11288: \"$ac_try\"") >&5
+  { (eval echo "$as_me:11430: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:11291: \$? = $ac_status" >&5
+  echo "$as_me:11433: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   cf_cv_regex="regexpr.h"
 else
@@ -11304,7 +11446,7 @@ rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 
 fi
 
-echo "$as_me:11307: result: $cf_cv_regex" >&5
+echo "$as_me:11449: result: $cf_cv_regex" >&5
 echo "${ECHO_T}$cf_cv_regex" >&6
 case $cf_cv_regex in
 	regex.h)   cat >>confdefs.h <<\EOF
@@ -11322,7 +11464,7 @@ EOF
 esac
 
 		if test "X$cf_cv_regex" != "Xregex.h" ; then
-			{ { echo "$as_me:11325: error: Only POSIX or PCRE regular expressions are supported" >&5
+			{ { echo "$as_me:11467: error: Only POSIX or PCRE regular expressions are supported" >&5
 echo "$as_me: error: Only POSIX or PCRE regular expressions are supported" >&2;}
    { (exit 1); exit 1; }; }
 		fi
@@ -11333,7 +11475,7 @@ EOF
 
 fi
 
-echo "$as_me:11336: checking if you want support for right-scrollbar" >&5
+echo "$as_me:11478: checking if you want support for right-scrollbar" >&5
 echo $ECHO_N "checking if you want support for right-scrollbar... $ECHO_C" >&6
 
 # Check whether --enable-rightbar or --disable-rightbar was given.
@@ -11350,7 +11492,7 @@ else
   enable_rightbar=yes
 
 fi;
-echo "$as_me:11353: result: $enable_rightbar" >&5
+echo "$as_me:11495: result: $enable_rightbar" >&5
 echo "${ECHO_T}$enable_rightbar" >&6
 if test "$enable_rightbar" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11359,7 +11501,7 @@ EOF
 
 fi
 
-echo "$as_me:11362: checking if you want check for redundant name-change" >&5
+echo "$as_me:11504: checking if you want check for redundant name-change" >&5
 echo $ECHO_N "checking if you want check for redundant name-change... $ECHO_C" >&6
 
 # Check whether --enable-samename or --disable-samename was given.
@@ -11376,13 +11518,13 @@ else
   enable_samename=yes
 
 fi;
-echo "$as_me:11379: result: $enable_samename" >&5
+echo "$as_me:11521: result: $enable_samename" >&5
 echo "${ECHO_T}$enable_samename" >&6
 test "$enable_samename" = no && cat >>confdefs.h <<\EOF
 #define OPT_SAME_NAME 0
 EOF
 
-echo "$as_me:11385: checking if you want support for session management" >&5
+echo "$as_me:11527: checking if you want support for session management" >&5
 echo $ECHO_N "checking if you want support for session management... $ECHO_C" >&6
 
 # Check whether --enable-session-mgt or --disable-session-mgt was given.
@@ -11399,13 +11541,13 @@ else
   enable_session_mgt=yes
 
 fi;
-echo "$as_me:11402: result: $enable_session_mgt" >&5
+echo "$as_me:11544: result: $enable_session_mgt" >&5
 echo "${ECHO_T}$enable_session_mgt" >&6
 test "$enable_session_mgt" = no && cat >>confdefs.h <<\EOF
 #define OPT_SESSION_MGT 0
 EOF
 
-echo "$as_me:11408: checking if you want to use termcap function-keys" >&5
+echo "$as_me:11550: checking if you want to use termcap function-keys" >&5
 echo $ECHO_N "checking if you want to use termcap function-keys... $ECHO_C" >&6
 
 # Check whether --enable-tcap-fkeys or --disable-tcap-fkeys was given.
@@ -11422,36 +11564,36 @@ else
   enable_tcap_fkeys=yes
 
 fi;
-echo "$as_me:11425: result: $enable_tcap_fkeys" >&5
+echo "$as_me:11567: result: $enable_tcap_fkeys" >&5
 echo "${ECHO_T}$enable_tcap_fkeys" >&6
 test "$enable_tcap_fkeys" = yes && cat >>confdefs.h <<\EOF
 #define OPT_TCAP_FKEYS 1
 EOF
 
-echo "$as_me:11431: checking if you want to use termcap-query/report" >&5
+echo "$as_me:11573: checking if you want to use termcap-query/report" >&5
 echo $ECHO_N "checking if you want to use termcap-query/report... $ECHO_C" >&6
 
 # Check whether --enable-tcap-query or --disable-tcap-query was given.
 if test "${enable_tcap_query+set}" = set; then
   enableval="$enable_tcap_query"
-  test "$enableval" != yes && enableval=no
-  if test "$enableval" != "no" ; then
-    enable_tcap_query=yes
-  else
+  test "$enableval" != no && enableval=yes
+  if test "$enableval" != "yes" ; then
     enable_tcap_query=no
+  else
+    enable_tcap_query=yes
   fi
 else
-  enableval=no
-  enable_tcap_query=no
+  enableval=yes
+  enable_tcap_query=yes
 
 fi;
-echo "$as_me:11448: result: $enable_tcap_query" >&5
+echo "$as_me:11590: result: $enable_tcap_query" >&5
 echo "${ECHO_T}$enable_tcap_query" >&6
 test "$enable_tcap_query" = yes && cat >>confdefs.h <<\EOF
 #define OPT_TCAP_QUERY 1
 EOF
 
-echo "$as_me:11454: checking if you want support for tek4014" >&5
+echo "$as_me:11596: checking if you want support for tek4014" >&5
 echo $ECHO_N "checking if you want support for tek4014... $ECHO_C" >&6
 
 # Check whether --enable-tek4014 or --disable-tek4014 was given.
@@ -11468,7 +11610,7 @@ else
   enable_tek4014=yes
 
 fi;
-echo "$as_me:11471: result: $enable_tek4014" >&5
+echo "$as_me:11613: result: $enable_tek4014" >&5
 echo "${ECHO_T}$enable_tek4014" >&6
 if test "$enable_tek4014" = no ; then
 	cat >>confdefs.h <<\EOF
@@ -11481,7 +11623,7 @@ else
 	EXTRAOBJS="$EXTRAOBJS TekPrsTbl.o Tekproc.o"
 fi
 
-echo "$as_me:11484: checking if you want pulldown menus with a toolbar" >&5
+echo "$as_me:11626: checking if you want pulldown menus with a toolbar" >&5
 echo $ECHO_N "checking if you want pulldown menus with a toolbar... $ECHO_C" >&6
 
 # Check whether --enable-toolbar or --disable-toolbar was given.
@@ -11498,7 +11640,7 @@ else
   enable_toolbar=no
 
 fi;
-echo "$as_me:11501: result: $enable_toolbar" >&5
+echo "$as_me:11643: result: $enable_toolbar" >&5
 echo "${ECHO_T}$enable_toolbar" >&6
 if test "$enable_toolbar" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11507,7 +11649,7 @@ EOF
 
 fi
 
-echo "$as_me:11510: checking if you want VT52 emulation" >&5
+echo "$as_me:11652: checking if you want VT52 emulation" >&5
 echo $ECHO_N "checking if you want VT52 emulation... $ECHO_C" >&6
 
 # Check whether --enable-vt52 or --disable-vt52 was given.
@@ -11524,13 +11666,13 @@ else
   enable_vt52=yes
 
 fi;
-echo "$as_me:11527: result: $enable_vt52" >&5
+echo "$as_me:11669: result: $enable_vt52" >&5
 echo "${ECHO_T}$enable_vt52" >&6
 test "$enable_vt52" = no && cat >>confdefs.h <<\EOF
 #define OPT_VT52_MODE 0
 EOF
 
-echo "$as_me:11533: checking if you want to use mini-luit/Latin9 built-in support" >&5
+echo "$as_me:11675: checking if you want to use mini-luit/Latin9 built-in support" >&5
 echo $ECHO_N "checking if you want to use mini-luit/Latin9 built-in support... $ECHO_C" >&6
 
 # Check whether --enable-mini-luit or --disable-mini-luit was given.
@@ -11547,7 +11689,7 @@ else
   enable_mini_luit=no
 
 fi;
-echo "$as_me:11550: result: $enable_mini_luit" >&5
+echo "$as_me:11692: result: $enable_mini_luit" >&5
 echo "${ECHO_T}$enable_mini_luit" >&6
 if test "$enable_mini_luit" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11556,7 +11698,7 @@ EOF
 
 fi
 
-echo "$as_me:11559: checking if you want to use luit" >&5
+echo "$as_me:11701: checking if you want to use luit" >&5
 echo $ECHO_N "checking if you want to use luit... $ECHO_C" >&6
 
 # Check whether --enable-luit or --disable-luit was given.
@@ -11573,7 +11715,7 @@ else
   enable_luit=$enable_mini_luit
 
 fi;
-echo "$as_me:11576: result: $enable_luit" >&5
+echo "$as_me:11718: result: $enable_luit" >&5
 echo "${ECHO_T}$enable_luit" >&6
 if test "$enable_luit" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11585,7 +11727,7 @@ for ac_prog in $LUIT luit
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
-echo "$as_me:11588: checking for $ac_word" >&5
+echo "$as_me:11730: checking for $ac_word" >&5
 echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
 if test "${ac_cv_path_LUIT+set}" = set; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
@@ -11602,7 +11744,7 @@ for ac_dir in $ac_dummy; do
   test -z "$ac_dir" && ac_dir=.
   if $as_executable_p "$ac_dir/$ac_word"; then
    ac_cv_path_LUIT="$ac_dir/$ac_word"
-   echo "$as_me:11605: found $ac_dir/$ac_word" >&5
+   echo "$as_me:11747: found $ac_dir/$ac_word" >&5
    break
 fi
 done
@@ -11613,10 +11755,10 @@ fi
 LUIT=$ac_cv_path_LUIT
 
 if test -n "$LUIT"; then
-  echo "$as_me:11616: result: $LUIT" >&5
+  echo "$as_me:11758: result: $LUIT" >&5
 echo "${ECHO_T}$LUIT" >&6
 else
-  echo "$as_me:11619: result: no" >&5
+  echo "$as_me:11761: result: no" >&5
 echo "${ECHO_T}no" >&6
 fi
 
@@ -11684,7 +11826,7 @@ IFS="$cf_save_ifs"
 
 if test -n "$cf_path_prog" ; then
 
-echo "${as_me-configure}:11687: testing defining path for ${cf_path_prog} ..." 1>&5
+echo "${as_me-configure}:11829: testing defining path for ${cf_path_prog} ..." 1>&5
 
 	cat >>confdefs.h <<EOF
 #define LUIT_PATH "$cf_path_prog"
@@ -11698,7 +11840,7 @@ fi
 
 fi
 
-echo "$as_me:11701: checking if you want wide-character support" >&5
+echo "$as_me:11843: checking if you want wide-character support" >&5
 echo $ECHO_N "checking if you want wide-character support... $ECHO_C" >&6
 
 # Check whether --enable-wide-chars or --disable-wide-chars was given.
@@ -11715,7 +11857,7 @@ else
   enable_wchar=$enable_luit
 
 fi;
-echo "$as_me:11718: result: $enable_wchar" >&5
+echo "$as_me:11860: result: $enable_wchar" >&5
 echo "${ECHO_T}$enable_wchar" >&6
 if test "$enable_wchar" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11727,7 +11869,7 @@ EOF
 	EXTRAOBJS="$EXTRAOBJS charclass.o precompose.o wcwidth.o"
 fi
 
-echo "$as_me:11730: checking if you want dynamic-abbreviation support" >&5
+echo "$as_me:11872: checking if you want dynamic-abbreviation support" >&5
 echo $ECHO_N "checking if you want dynamic-abbreviation support... $ECHO_C" >&6
 
 # Check whether --enable-dabbrev or --disable-dabbrev was given.
@@ -11744,7 +11886,7 @@ else
   enable_dabbrev=no
 
 fi;
-echo "$as_me:11747: result: $enable_dabbrev" >&5
+echo "$as_me:11889: result: $enable_dabbrev" >&5
 echo "${ECHO_T}$enable_dabbrev" >&6
 if test "$enable_dabbrev" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11753,7 +11895,7 @@ EOF
 
 fi
 
-echo "$as_me:11756: checking if you want DECterm Locator support" >&5
+echo "$as_me:11898: checking if you want DECterm Locator support" >&5
 echo $ECHO_N "checking if you want DECterm Locator support... $ECHO_C" >&6
 
 # Check whether --enable-dec-locator or --disable-dec-locator was given.
@@ -11770,7 +11912,7 @@ else
   enable_dec_locator=no
 
 fi;
-echo "$as_me:11773: result: $enable_dec_locator" >&5
+echo "$as_me:11915: result: $enable_dec_locator" >&5
 echo "${ECHO_T}$enable_dec_locator" >&6
 if test "$enable_dec_locator" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11779,7 +11921,7 @@ EOF
 
 fi
 
-echo "$as_me:11782: checking if you want VT420 rectangle support" >&5
+echo "$as_me:11924: checking if you want VT420 rectangle support" >&5
 echo $ECHO_N "checking if you want VT420 rectangle support... $ECHO_C" >&6
 
 # Check whether --enable-rectangles or --disable-rectangles was given.
@@ -11796,7 +11938,7 @@ else
   enable_rectangles=yes
 
 fi;
-echo "$as_me:11799: result: $enable_rectangles" >&5
+echo "$as_me:11941: result: $enable_rectangles" >&5
 echo "${ECHO_T}$enable_rectangles" >&6
 if test "$enable_rectangles" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11805,7 +11947,7 @@ EOF
 
 fi
 
-echo "$as_me:11808: checking if you want -ziconbeep option" >&5
+echo "$as_me:11950: checking if you want -ziconbeep option" >&5
 echo $ECHO_N "checking if you want -ziconbeep option... $ECHO_C" >&6
 
 # Check whether --enable-ziconbeep or --disable-ziconbeep was given.
@@ -11822,7 +11964,7 @@ else
   enable_ziconbeep=yes
 
 fi;
-echo "$as_me:11825: result: $enable_ziconbeep" >&5
+echo "$as_me:11967: result: $enable_ziconbeep" >&5
 echo "${ECHO_T}$enable_ziconbeep" >&6
 test "$enable_ziconbeep" = no && cat >>confdefs.h <<\EOF
 #define OPT_ZICONBEEP 0
@@ -11830,7 +11972,7 @@ EOF
 
 ###############################################################################
 
-echo "$as_me:11833: checking if you want debugging traces" >&5
+echo "$as_me:11975: checking if you want debugging traces" >&5
 echo $ECHO_N "checking if you want debugging traces... $ECHO_C" >&6
 
 # Check whether --enable-trace or --disable-trace was given.
@@ -11847,7 +11989,7 @@ else
   enable_trace=no
 
 fi;
-echo "$as_me:11850: result: $enable_trace" >&5
+echo "$as_me:11992: result: $enable_trace" >&5
 echo "${ECHO_T}$enable_trace" >&6
 if test "$enable_trace" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11858,7 +12000,7 @@ EOF
 	EXTRAOBJS="$EXTRAOBJS trace.o"
 fi
 
-echo "$as_me:11861: checking if you want to test memory leaks" >&5
+echo "$as_me:12003: checking if you want to test memory leaks" >&5
 echo $ECHO_N "checking if you want to test memory leaks... $ECHO_C" >&6
 
 # Check whether --enable-leaks or --disable-leaks was given.
@@ -11875,7 +12017,7 @@ else
   disable_leaks=no
 
 fi;
-echo "$as_me:11878: result: $disable_leaks" >&5
+echo "$as_me:12020: result: $disable_leaks" >&5
 echo "${ECHO_T}$disable_leaks" >&6
 if test "$disable_leaks" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11884,7 +12026,7 @@ EOF
 
 fi
 
-echo "$as_me:11887: checking if you want to see long compiling messages" >&5
+echo "$as_me:12029: checking if you want to see long compiling messages" >&5
 echo $ECHO_N "checking if you want to see long compiling messages... $ECHO_C" >&6
 
 # Check whether --enable-echo or --disable-echo was given.
@@ -11918,10 +12060,10 @@ else
     ECHO_CC=''
 
 fi;
-echo "$as_me:11921: result: $enableval" >&5
+echo "$as_me:12063: result: $enableval" >&5
 echo "${ECHO_T}$enableval" >&6
 
-echo "$as_me:11924: checking if you want magic cookie emulation" >&5
+echo "$as_me:12066: checking if you want magic cookie emulation" >&5
 echo $ECHO_N "checking if you want magic cookie emulation... $ECHO_C" >&6
 
 # Check whether --enable-xmc-glitch or --disable-xmc-glitch was given.
@@ -11938,7 +12080,7 @@ else
   enable_xmc=no
 
 fi;
-echo "$as_me:11941: result: $enable_xmc" >&5
+echo "$as_me:12083: result: $enable_xmc" >&5
 echo "${ECHO_T}$enable_xmc" >&6
 if test "$enable_xmc" = yes ; then
 	cat >>confdefs.h <<\EOF
@@ -11952,13 +12094,84 @@ fi
 for ac_func in tigetstr
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
-echo "$as_me:11955: checking for $ac_func" >&5
+echo "$as_me:12097: checking for $ac_func" >&5
+echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
+if eval "test \"\${$as_ac_var+set}\" = set"; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  cat >conftest.$ac_ext <<_ACEOF
+#line 12103 "configure"
+#include "confdefs.h"
+/* System header to define __stub macros and hopefully few prototypes,
+    which can conflict with char $ac_func (); below.  */
+#include <assert.h>
+/* Override any gcc2 internal prototype to avoid an error.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+/* We use char because int might match the return type of a gcc2
+   builtin and then its argument prototype would still apply.  */
+char $ac_func ();
+char (*f) ();
+
+int
+main ()
+{
+/* The GNU C library defines this for functions which it implements
+    to always fail with ENOSYS.  Some functions are actually named
+    something starting with __ and the normal name is an alias.  */
+#if defined (__stub_$ac_func) || defined (__stub___$ac_func)
+choke me
+#else
+f = $ac_func;
+#endif
+
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext conftest$ac_exeext
+if { (eval echo "$as_me:12134: \"$ac_link\"") >&5
+  (eval $ac_link) 2>&5
+  ac_status=$?
+  echo "$as_me:12137: \$? = $ac_status" >&5
+  (exit $ac_status); } &&
+         { ac_try='test -s conftest$ac_exeext'
+  { (eval echo "$as_me:12140: \"$ac_try\"") >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  echo "$as_me:12143: \$? = $ac_status" >&5
+  (exit $ac_status); }; }; then
+  eval "$as_ac_var=yes"
+else
+  echo "$as_me: failed program was:" >&5
+cat conftest.$ac_ext >&5
+eval "$as_ac_var=no"
+fi
+rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
+fi
+echo "$as_me:12153: result: `eval echo '${'$as_ac_var'}'`" >&5
+echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
+if test `eval echo '${'$as_ac_var'}'` = yes; then
+  cat >>confdefs.h <<EOF
+#define `echo "HAVE_$ac_func" | $as_tr_cpp` 1
+EOF
+
+fi
+done
+
+if test -n "$cf_cv_lib_part_tgetent"; then
+
+for ac_func in use_extended_names
+do
+as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
+echo "$as_me:12168: checking for $ac_func" >&5
 echo $ECHO_N "checking for $ac_func... $ECHO_C" >&6
 if eval "test \"\${$as_ac_var+set}\" = set"; then
   echo $ECHO_N "(cached) $ECHO_C" >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line 11961 "configure"
+#line 12174 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func (); below.  */
@@ -11989,16 +12202,16 @@ f = $ac_func;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:11992: \"$ac_link\"") >&5
+if { (eval echo "$as_me:12205: \"$ac_link\"") >&5
   (eval $ac_link) 2>&5
   ac_status=$?
-  echo "$as_me:11995: \$? = $ac_status" >&5
+  echo "$as_me:12208: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:11998: \"$ac_try\"") >&5
+  { (eval echo "$as_me:12211: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:12001: \$? = $ac_status" >&5
+  echo "$as_me:12214: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   eval "$as_ac_var=yes"
 else
@@ -12008,7 +12221,7 @@ eval "$as_ac_var=no"
 fi
 rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
 fi
-echo "$as_me:12011: result: `eval echo '${'$as_ac_var'}'`" >&5
+echo "$as_me:12224: result: `eval echo '${'$as_ac_var'}'`" >&5
 echo "${ECHO_T}`eval echo '${'$as_ac_var'}'`" >&6
 if test `eval echo '${'$as_ac_var'}'` = yes; then
   cat >>confdefs.h <<EOF
@@ -12018,8 +12231,10 @@ EOF
 fi
 done
 
+fi
+
 if test -n "$GCC" ; then
-echo "$as_me:12022: checking if you want to turn on gcc warnings" >&5
+echo "$as_me:12237: checking if you want to turn on gcc warnings" >&5
 echo $ECHO_N "checking if you want to turn on gcc warnings... $ECHO_C" >&6
 
 # Check whether --enable-warnings or --disable-warnings was given.
@@ -12036,7 +12251,7 @@ else
   with_warnings=no
 
 fi;
-echo "$as_me:12039: result: $with_warnings" >&5
+echo "$as_me:12254: result: $with_warnings" >&5
 echo "${ECHO_T}$with_warnings" >&6
 if test "$with_warnings" = yes
 then
@@ -12059,10 +12274,10 @@ cat > conftest.i <<EOF
 EOF
 if test "$GCC" = yes
 then
-	{ echo "$as_me:12062: checking for $CC __attribute__ directives..." >&5
+	{ echo "$as_me:12277: checking for $CC __attribute__ directives..." >&5
 echo "$as_me: checking for $CC __attribute__ directives..." >&6;}
 cat > conftest.$ac_ext <<EOF
-#line 12065 "${as_me-configure}"
+#line 12280 "${as_me-configure}"
 #include "confdefs.h"
 #include "conftest.h"
 #include "conftest.i"
@@ -12100,12 +12315,12 @@ EOF
 EOF
 			;;
 		esac
-		if { (eval echo "$as_me:12103: \"$ac_compile\"") >&5
+		if { (eval echo "$as_me:12318: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:12106: \$? = $ac_status" >&5
+  echo "$as_me:12321: \$? = $ac_status" >&5
   (exit $ac_status); }; then
-			test -n "$verbose" && echo "$as_me:12108: result: ... $cf_attribute" >&5
+			test -n "$verbose" && echo "$as_me:12323: result: ... $cf_attribute" >&5
 echo "${ECHO_T}... $cf_attribute" >&6
 			cat conftest.h >>confdefs.h
 		fi
@@ -12118,11 +12333,11 @@ fi
 
 GCC_VERSION=none
 if test "$GCC" = yes ; then
-	echo "$as_me:12121: checking version of $CC" >&5
+	echo "$as_me:12336: checking version of $CC" >&5
 echo $ECHO_N "checking version of $CC... $ECHO_C" >&6
 	GCC_VERSION="`${CC} --version| sed -e '2,$d' -e 's/^.*(GCC) //' -e 's/^[^0-9.]*//' -e 's/[^0-9.].*//'`"
 	test -z "$GCC_VERSION" && GCC_VERSION=unknown
-	echo "$as_me:12125: result: $GCC_VERSION" >&5
+	echo "$as_me:12340: result: $GCC_VERSION" >&5
 echo "${ECHO_T}$GCC_VERSION" >&6
 fi
 
@@ -12131,12 +12346,12 @@ INTEL_COMPILER=no
 if test "$GCC" = yes ; then
 	case $host_os in
 	linux*|gnu*)
-		echo "$as_me:12134: checking if this is really Intel C compiler" >&5
+		echo "$as_me:12349: checking if this is really Intel C compiler" >&5
 echo $ECHO_N "checking if this is really Intel C compiler... $ECHO_C" >&6
 		cf_save_CFLAGS="$CFLAGS"
 		CFLAGS="$CFLAGS -no-gcc"
 		cat >conftest.$ac_ext <<_ACEOF
-#line 12139 "configure"
+#line 12354 "configure"
 #include "confdefs.h"
 
 int
@@ -12153,16 +12368,16 @@ make an error
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:12156: \"$ac_compile\"") >&5
+if { (eval echo "$as_me:12371: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:12159: \$? = $ac_status" >&5
+  echo "$as_me:12374: \$? = $ac_status" >&5
   (exit $ac_status); } &&
          { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:12162: \"$ac_try\"") >&5
+  { (eval echo "$as_me:12377: \"$ac_try\"") >&5
   (eval $ac_try) 2>&5
   ac_status=$?
-  echo "$as_me:12165: \$? = $ac_status" >&5
+  echo "$as_me:12380: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   INTEL_COMPILER=yes
 cf_save_CFLAGS="$cf_save_CFLAGS -we147 -no-gcc"
@@ -12173,14 +12388,14 @@ cat conftest.$ac_ext >&5
 fi
 rm -f conftest.$ac_objext conftest.$ac_ext
 		CFLAGS="$cf_save_CFLAGS"
-		echo "$as_me:12176: result: $INTEL_COMPILER" >&5
+		echo "$as_me:12391: result: $INTEL_COMPILER" >&5
 echo "${ECHO_T}$INTEL_COMPILER" >&6
 		;;
 	esac
 fi
 
 cat > conftest.$ac_ext <<EOF
-#line 12183 "${as_me-configure}"
+#line 12398 "${as_me-configure}"
 int main(int argc, char *argv[]) { return (argv[argc-1] == 0) ; }
 EOF
 
@@ -12198,7 +12413,7 @@ then
 # remark #981: operands are evaluated in unspecified order
 # warning #269: invalid format string conversion
 
-	{ echo "$as_me:12201: checking for $CC warning options..." >&5
+	{ echo "$as_me:12416: checking for $CC warning options..." >&5
 echo "$as_me: checking for $CC warning options..." >&6;}
 	cf_save_CFLAGS="$CFLAGS"
 	EXTRA_CFLAGS="-Wall"
@@ -12215,12 +12430,12 @@ echo "$as_me: checking for $CC warning options..." >&6;}
 		wd981
 	do
 		CFLAGS="$cf_save_CFLAGS $EXTRA_CFLAGS -$cf_opt"
-		if { (eval echo "$as_me:12218: \"$ac_compile\"") >&5
+		if { (eval echo "$as_me:12433: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:12221: \$? = $ac_status" >&5
+  echo "$as_me:12436: \$? = $ac_status" >&5
   (exit $ac_status); }; then
-			test -n "$verbose" && echo "$as_me:12223: result: ... -$cf_opt" >&5
+			test -n "$verbose" && echo "$as_me:12438: result: ... -$cf_opt" >&5
 echo "${ECHO_T}... -$cf_opt" >&6
 			EXTRA_CFLAGS="$EXTRA_CFLAGS -$cf_opt"
 		fi
@@ -12229,7 +12444,7 @@ echo "${ECHO_T}... -$cf_opt" >&6
 
 elif test "$GCC" = yes
 then
-	{ echo "$as_me:12232: checking for $CC warning options..." >&5
+	{ echo "$as_me:12447: checking for $CC warning options..." >&5
 echo "$as_me: checking for $CC warning options..." >&6;}
 	cf_save_CFLAGS="$CFLAGS"
 	EXTRA_CFLAGS="-W -Wall"
@@ -12249,12 +12464,12 @@ echo "$as_me: checking for $CC warning options..." >&6;}
 		Wundef $cf_warn_CONST Wdeclaration-after-statement Wextra Wno-unknown-pragmas Wswitch-enum
 	do
 		CFLAGS="$cf_save_CFLAGS $EXTRA_CFLAGS -$cf_opt"
-		if { (eval echo "$as_me:12252: \"$ac_compile\"") >&5
+		if { (eval echo "$as_me:12467: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
-  echo "$as_me:12255: \$? = $ac_status" >&5
+  echo "$as_me:12470: \$? = $ac_status" >&5
   (exit $ac_status); }; then
-			test -n "$verbose" && echo "$as_me:12257: result: ... -$cf_opt" >&5
+			test -n "$verbose" && echo "$as_me:12472: result: ... -$cf_opt" >&5
 echo "${ECHO_T}... -$cf_opt" >&6
 			case $cf_opt in #(vi
 			Wcast-qual) #(vi
@@ -12262,10 +12477,10 @@ echo "${ECHO_T}... -$cf_opt" >&6
 				;;
 			Winline) #(vi
 				case $GCC_VERSION in
-				3.3*)
+				[34].*)
 					test -n "$verbose" && echo "	feature is broken in gcc $GCC_VERSION" 1>&6
 
-echo "${as_me-configure}:12268: testing feature is broken in gcc $GCC_VERSION ..." 1>&5
+echo "${as_me-configure}:12483: testing feature is broken in gcc $GCC_VERSION ..." 1>&5
 
 					continue;;
 				esac
@@ -12397,7 +12612,7 @@ DEFS=-DHAVE_CONFIG_H
 : ${CONFIG_STATUS=./config.status}
 ac_clean_files_save=$ac_clean_files
 ac_clean_files="$ac_clean_files $CONFIG_STATUS"
-{ echo "$as_me:12400: creating $CONFIG_STATUS" >&5
+{ echo "$as_me:12615: creating $CONFIG_STATUS" >&5
 echo "$as_me: creating $CONFIG_STATUS" >&6;}
 cat >$CONFIG_STATUS <<_ACEOF
 #! $SHELL
@@ -12526,7 +12741,7 @@ EOF
 cat >>$CONFIG_STATUS <<EOF
 ac_cs_version="\\
 config.status
-configured by $0, generated by GNU Autoconf 2.52.20061216,
+configured by $0, generated by GNU Autoconf 2.52.20081225,
   with options \\"`echo "$ac_configure_args" | sed 's/[\\""\`\$]/\\\\&/g'`\\"
 
 Copyright 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001
@@ -12570,7 +12785,7 @@ cat >>$CONFIG_STATUS <<\EOF
     echo "$ac_cs_version"; exit 0 ;;
   --he | --h)
     # Conflict between --help and --header
-    { { echo "$as_me:12573: error: ambiguous option: $1
+    { { echo "$as_me:12788: error: ambiguous option: $1
 Try \`$0 --help' for more information." >&5
 echo "$as_me: error: ambiguous option: $1
 Try \`$0 --help' for more information." >&2;}
@@ -12589,7 +12804,7 @@ Try \`$0 --help' for more information." >&2;}
     ac_need_defaults=false;;
 
   # This is an error.
-  -*) { { echo "$as_me:12592: error: unrecognized option: $1
+  -*) { { echo "$as_me:12807: error: unrecognized option: $1
 Try \`$0 --help' for more information." >&5
 echo "$as_me: error: unrecognized option: $1
 Try \`$0 --help' for more information." >&2;}
@@ -12608,7 +12823,7 @@ cat >&5 << _ACEOF
 ## Running config.status.  ##
 ## ----------------------- ##
 
-This file was extended by $as_me 2.52.20061216, executed with
+This file was extended by $as_me 2.52.20081225, executed with
   CONFIG_FILES    = $CONFIG_FILES
   CONFIG_HEADERS  = $CONFIG_HEADERS
   CONFIG_LINKS    = $CONFIG_LINKS
@@ -12626,7 +12841,7 @@ do
   # Handling of arguments.
   "Makefile" ) CONFIG_FILES="$CONFIG_FILES Makefile" ;;
   "xtermcfg.h" ) CONFIG_HEADERS="$CONFIG_HEADERS xtermcfg.h:xtermcfg.hin" ;;
-  *) { { echo "$as_me:12629: error: invalid argument: $ac_config_target" >&5
+  *) { { echo "$as_me:12844: error: invalid argument: $ac_config_target" >&5
 echo "$as_me: error: invalid argument: $ac_config_target" >&2;}
    { (exit 1); exit 1; }; };;
   esac
@@ -12882,7 +13097,7 @@ done; }
   esac
 
   if test x"$ac_file" != x-; then
-    { echo "$as_me:12885: creating $ac_file" >&5
+    { echo "$as_me:13100: creating $ac_file" >&5
 echo "$as_me: creating $ac_file" >&6;}
     rm -f "$ac_file"
   fi
@@ -12900,7 +13115,7 @@ echo "$as_me: creating $ac_file" >&6;}
       -) echo $tmp/stdin ;;
       [\\/$]*)
          # Absolute (can't be DOS-style, as IFS=:)
-         test -f "$f" || { { echo "$as_me:12903: error: cannot find input file: $f" >&5
+         test -f "$f" || { { echo "$as_me:13118: error: cannot find input file: $f" >&5
 echo "$as_me: error: cannot find input file: $f" >&2;}
    { (exit 1); exit 1; }; }
          echo $f;;
@@ -12913,7 +13128,7 @@ echo "$as_me: error: cannot find input file: $f" >&2;}
            echo $srcdir/$f
          else
            # /dev/null tree
-           { { echo "$as_me:12916: error: cannot find input file: $f" >&5
+           { { echo "$as_me:13131: error: cannot find input file: $f" >&5
 echo "$as_me: error: cannot find input file: $f" >&2;}
    { (exit 1); exit 1; }; }
          fi;;
@@ -12979,7 +13194,7 @@ for ac_file in : $CONFIG_HEADERS; do test "x$ac_file" = x: && continue
   * )   ac_file_in=$ac_file.in ;;
   esac
 
-  test x"$ac_file" != x- && { echo "$as_me:12982: creating $ac_file" >&5
+  test x"$ac_file" != x- && { echo "$as_me:13197: creating $ac_file" >&5
 echo "$as_me: creating $ac_file" >&6;}
 
   # First look for the input files in the build tree, otherwise in the
@@ -12990,7 +13205,7 @@ echo "$as_me: creating $ac_file" >&6;}
       -) echo $tmp/stdin ;;
       [\\/$]*)
          # Absolute (can't be DOS-style, as IFS=:)
-         test -f "$f" || { { echo "$as_me:12993: error: cannot find input file: $f" >&5
+         test -f "$f" || { { echo "$as_me:13208: error: cannot find input file: $f" >&5
 echo "$as_me: error: cannot find input file: $f" >&2;}
    { (exit 1); exit 1; }; }
          echo $f;;
@@ -13003,7 +13218,7 @@ echo "$as_me: error: cannot find input file: $f" >&2;}
            echo $srcdir/$f
          else
            # /dev/null tree
-           { { echo "$as_me:13006: error: cannot find input file: $f" >&5
+           { { echo "$as_me:13221: error: cannot find input file: $f" >&5
 echo "$as_me: error: cannot find input file: $f" >&2;}
    { (exit 1); exit 1; }; }
          fi;;
@@ -13121,7 +13336,7 @@ cat >>$CONFIG_STATUS <<\EOF
   rm -f $tmp/in
   if test x"$ac_file" != x-; then
     if cmp -s $ac_file $tmp/config.h 2>/dev/null; then
-      { echo "$as_me:13124: $ac_file is unchanged" >&5
+      { echo "$as_me:13339: $ac_file is unchanged" >&5
 echo "$as_me: $ac_file is unchanged" >&6;}
     else
       ac_dir=`$as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
diff --git a/app/xterm/configure.in b/app/xterm/configure.in
index 620820b89..bf21ad426 100644
--- a/app/xterm/configure.in
+++ b/app/xterm/configure.in
@@ -1,4 +1,4 @@
-dnl $XTermId: configure.in,v 1.245 2008/07/27 15:03:56 tom Exp $
+dnl $XTermId: configure.in,v 1.246 2008/12/30 11:30:48 tom Exp $
 dnl
 dnl ---------------------------------------------------------------------------
 dnl
@@ -644,10 +644,10 @@ test "$enable_numlock" = no && AC_DEFINE(OPT_NUM_LOCK,0)
 
 AC_MSG_CHECKING(if you want support for get/set of base64 selection data)
 
-CF_ARG_ENABLE(paste64,
-	[  --enable-paste64        enable get/set base64 selection data],
-	[enable_paste64=yes],
-	[enable_paste64=no])
+CF_ARG_DISABLE(paste64,
+	[  --disable-paste64       disable get/set base64 selection data],
+	[enable_paste64=no],
+	[enable_paste64=yes])
 AC_MSG_RESULT($enable_paste64)
 if test "$enable_paste64" = yes ; then
 	AC_DEFINE(OPT_PASTE64,1)
@@ -730,10 +730,10 @@ AC_MSG_RESULT($enable_tcap_fkeys)
 test "$enable_tcap_fkeys" = yes && AC_DEFINE(OPT_TCAP_FKEYS,1)
 
 AC_MSG_CHECKING(if you want to use termcap-query/report)
-CF_ARG_ENABLE(tcap-query,
-	[  --enable-tcap-query     compile-in termcap-query support],
-	[enable_tcap_query=yes],
-	[enable_tcap_query=no])
+CF_ARG_DISABLE(tcap-query,
+	[  --disable-tcap-query    disable compiled-in termcap-query support],
+	[enable_tcap_query=no],
+	[enable_tcap_query=yes])
 AC_MSG_RESULT($enable_tcap_query)
 test "$enable_tcap_query" = yes && AC_DEFINE(OPT_TCAP_QUERY,1)
 
diff --git a/app/xterm/cursor.c b/app/xterm/cursor.c
index 3a7ddb875..49c51ea58 100644
--- a/app/xterm/cursor.c
+++ b/app/xterm/cursor.c
@@ -1,4 +1,4 @@
-/* $XTermId: cursor.c,v 1.45 2008/04/20 21:06:22 tom Exp $ */
+/* $XTermId: cursor.c,v 1.46 2008/10/05 20:12:16 tom Exp $ */
 
 /* $XFree86: xc/programs/xterm/cursor.c,v 3.20 2006/02/13 01:14:58 dickey Exp $ */
 
@@ -81,7 +81,7 @@ CursorSet(TScreen * screen, int row, int col, unsigned flags)
     }
     use_row = (use_row < 0 ? 0 : use_row);
     set_cur_row(screen, (use_row <= max_row ? use_row : max_row));
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 
     TRACE(("CursorSet(%d,%d) margins [%d..%d] -> %d,%d %s\n",
 	   row, col,
@@ -119,7 +119,7 @@ CursorBack(XtermWidget xw, int n)
 	    set_cur_col(screen, 0);
 	}
     }
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 }
 
 /*
@@ -135,7 +135,7 @@ CursorForward(TScreen * screen, int n)
 	next = max;
 
     set_cur_col(screen, next);
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 }
 
 /*
@@ -156,7 +156,7 @@ CursorDown(TScreen * screen, int n)
 	next = screen->max_row;
 
     set_cur_row(screen, next);
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 }
 
 /*
@@ -178,7 +178,7 @@ CursorUp(TScreen * screen, int n)
 	next = 0;
 
     set_cur_row(screen, next);
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 }
 
 /*
@@ -236,7 +236,7 @@ void
 CarriageReturn(TScreen * screen)
 {
     set_cur_col(screen, 0);
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
     do_xevents();
 }
 
diff --git a/app/xterm/fontutils.c b/app/xterm/fontutils.c
index 1c2e11917..4e401f15b 100644
--- a/app/xterm/fontutils.c
+++ b/app/xterm/fontutils.c
@@ -1,4 +1,4 @@
-/* $XTermId: fontutils.c,v 1.275 2008/09/14 22:21:14 tom Exp $ */
+/* $XTermId: fontutils.c,v 1.278 2008/12/30 17:32:06 tom Exp $ */
 
 /************************************************************
 
@@ -119,7 +119,7 @@ static void lookupOneFontSize(XtermWidget, int);
 #endif
 
 #if OPT_WIDE_CHARS
-static Bool
+static unsigned
 countGlyphs(XFontStruct * fp)
 {
     unsigned count = 0;
@@ -505,8 +505,8 @@ same_font_name(char *pattern, char *match)
 		return False;
 	    }
 	} else {
-	    int p = char2lower(*pattern++);
-	    int m = char2lower(*match++);
+	    int p = x_toupper(*pattern++);
+	    int m = x_toupper(*match++);
 	    if (p != m)
 		return False;
 	}
@@ -1301,9 +1301,8 @@ HandleLoadVTFonts(Widget w,
 
 	TRACE(("HandleLoadVTFonts(%d)\n", *param_count));
 	strcpy(myClass, convert);
-	if (*param_count == 1
-	    && islower(CharOf(myClass[0])))
-	    myClass[0] = toupper(CharOf(myClass[0]));
+	if (*param_count == 1)
+	    myClass[0] = x_toupper(myClass[0]);
 
 	if (xtermLoadVTFonts(xw, myName, myClass)) {
 	    /*
@@ -1340,10 +1339,10 @@ xtermSetCursorBox(TScreen * screen)
     int hh = screen->cursor_underline ? 1 : fh;
 
     vp = &VTbox[1];
-    (vp++)->x = fw;
-    (vp++)->y = hh;
-    (vp++)->x = -fw;
-    vp->y = -hh;
+    (vp++)->x = (short) fw;
+    (vp++)->y = (short) hh;
+    (vp++)->x = (short) -fw;
+    vp->y = (short) -hh;
 
     screen->box = VTbox;
 }
@@ -2150,7 +2149,7 @@ xtermDrawBoxChar(XtermWidget xw,
 		 360 * 64);
     } else if (ch < (sizeof(lines) / sizeof(lines[0]))
 	       && (p = lines[ch]) != 0) {
-	int coord[4];
+	unsigned coord[4];
 	int n = 0;
 	while (*p >= 0) {
 	    coord[n++] = *p++;
diff --git a/app/xterm/input.c b/app/xterm/input.c
index 3883a227c..eed8ea675 100644
--- a/app/xterm/input.c
+++ b/app/xterm/input.c
@@ -1,4 +1,4 @@
-/* $XTermId: input.c,v 1.300 2008/09/14 16:37:25 Ted.Phelps Exp $ */
+/* $XTermId: input.c,v 1.302 2008/12/30 17:20:39 tom Exp $ */
 
 /*
  * Copyright 1999-2007,2008 by Thomas E. Dickey
@@ -82,6 +82,7 @@
 
 #include <data.h>
 #include <fontutils.h>
+#include <xstrings.h>
 #include <xtermcap.h>
 
 /*
@@ -825,7 +826,7 @@ Input(XtermWidget xw,
     kd.is_fkey = False;
 #if OPT_TCAP_QUERY
     if (screen->tc_query_code >= 0) {
-	kd.keysym = screen->tc_query_code;
+	kd.keysym = (KeySym) screen->tc_query_code;
 	kd.is_fkey = screen->tc_query_fkey;
 	if (kd.keysym != XK_BackSpace) {
 	    kd.nbytes = 0;
@@ -862,7 +863,7 @@ Input(XtermWidget xw,
 		&& (keyboard->modify_now.other_keys > 1)
 		&& !IsControlInput(&kd)) {
 		kd.nbytes = 1;
-		kd.strbuf[0] = kd.keysym;
+		kd.strbuf[0] = (char) kd.keysym;
 	    }
 #endif /* OPT_MOD_FKEYS */
 	} else
@@ -983,7 +984,7 @@ Input(XtermWidget xw,
 #ifdef XK_KP_Home
 	if (kd.keysym >= XK_KP_Home && kd.keysym <= XK_KP_Begin) {
 	    TRACE(("...Input keypad before was " KEYSYM_FMT "\n", kd.keysym));
-	    kd.keysym += XK_Home - XK_KP_Home;
+	    kd.keysym += (unsigned) (XK_Home - XK_KP_Home);
 	    TRACE(("...Input keypad changed to " KEYSYM_FMT "\n", kd.keysym));
 	}
 #endif
@@ -1028,7 +1029,7 @@ Input(XtermWidget xw,
 
 	    TRACE(("...map XK_F%ld", kd.keysym - XK_Fn(1) + 1));
 	    if (evt_state & ControlMask) {
-		kd.keysym += xw->misc.ctrl_fkeys;
+		kd.keysym += (KeySym) xw->misc.ctrl_fkeys;
 		evt_state &= ~ControlMask;
 	    }
 	    TRACE((" to XK_F%ld\n", kd.keysym - XK_Fn(1) + 1));
@@ -1039,11 +1040,11 @@ Input(XtermWidget xw,
 
 	    TRACE(("...map XK_F%ld", kd.keysym - XK_Fn(1) + 1));
 	    if (evt_state & ShiftMask) {
-		kd.keysym += xw->misc.ctrl_fkeys * 1;
+		kd.keysym += (KeySym) (xw->misc.ctrl_fkeys * 1);
 		evt_state &= ~ShiftMask;
 	    }
 	    if (evt_state & ControlMask) {
-		kd.keysym += xw->misc.ctrl_fkeys * 2;
+		kd.keysym += (KeySym) (xw->misc.ctrl_fkeys * 2);
 		evt_state &= ~ControlMask;
 	    }
 	    TRACE((" to XK_F%ld\n", kd.keysym - XK_Fn(1) + 1));
@@ -1124,7 +1125,7 @@ Input(XtermWidget xw,
 		 && (dec_code >= 11 && dec_code <= 14)) {
 	    reply.a_type = ANSI_SS3;
 	    VT52_CURSOR_KEYS;
-	    reply.a_final = A2E(dec_code - 11 + E2A('P'));
+	    reply.a_final = (Char) A2E(dec_code - 11 + E2A('P'));
 	    modifyCursorKey(&reply,
 			    keyboard->modify_now.function_keys,
 			    &modify_parm);
@@ -1167,7 +1168,7 @@ Input(XtermWidget xw,
 	key = True;
     } else if (IsPFKey(kd.keysym)) {
 	reply.a_type = ANSI_SS3;
-	reply.a_final = kd.keysym - XK_KP_F1 + 'P';
+	reply.a_final = (Char) ((kd.keysym - XK_KP_F1) + 'P');
 	VT52_CURSOR_KEYS;
 	MODIFIER_PARM;
 	unparseseq(xw, &reply);
@@ -1175,7 +1176,7 @@ Input(XtermWidget xw,
     } else if (IsKeypadKey(kd.keysym)) {
 	if (keypad_mode) {
 	    reply.a_type = ANSI_SS3;
-	    reply.a_final = kypd_apl[kd.keysym - XK_KP_Space];
+	    reply.a_final = (Char) (kypd_apl[kd.keysym - XK_KP_Space]);
 	    VT52_KEYPAD;
 	    MODIFIER_PARM;
 	    unparseseq(xw, &reply);
@@ -1190,7 +1191,7 @@ Input(XtermWidget xw,
 	    reply.a_type = ANSI_CSI;
 	}
 	modifyCursorKey(&reply, keyboard->modify_now.cursor_keys, &modify_parm);
-	reply.a_final = curfinal[kd.keysym - XK_Home];
+	reply.a_final = (Char) (curfinal[kd.keysym - XK_Home]);
 	VT52_CURSOR_KEYS;
 	MODIFIER_PARM;
 	unparseseq(xw, &reply);
@@ -1286,7 +1287,7 @@ Input(XtermWidget xw,
 	    if (eightbit && (kd.nbytes == 1) && screen->input_eight_bits) {
 		IChar ch = CharOf(kd.strbuf[0]);
 		if (ch < 128) {
-		    kd.strbuf[0] |= 0x80;
+		    kd.strbuf[0] |= (char) 0x80;
 		    TRACE(("...input shift from %d to %d (%#x to %#x)\n",
 			   ch, CharOf(kd.strbuf[0]),
 			   ch, CharOf(kd.strbuf[0])));
@@ -1299,8 +1300,8 @@ Input(XtermWidget xw,
 			 */
 			ch = CharOf(kd.strbuf[0]);
 			kd.nbytes = 2;
-			kd.strbuf[0] = 0xc0 | ((ch >> 6) & 0x3);
-			kd.strbuf[1] = 0x80 | (ch & 0x3f);
+			kd.strbuf[0] = (char) (0xc0 | ((ch >> 6) & 0x3));
+			kd.strbuf[1] = (char) (0x80 | (ch & 0x3f));
 			TRACE(("...encoded %#x in UTF-8 as %#x,%#x\n",
 			       ch, CharOf(kd.strbuf[0]), CharOf(kd.strbuf[1])));
 		    }
@@ -1314,15 +1315,15 @@ Input(XtermWidget xw,
 	    {
 		/* VT220 & up: National Replacement Characters */
 		if ((xw->flags & NATIONAL) != 0) {
-		    int cmp = xtermCharSetIn(CharOf(kd.strbuf[0]),
-					     screen->keyboard_dialect[0]);
+		    unsigned cmp = xtermCharSetIn(CharOf(kd.strbuf[0]),
+						  screen->keyboard_dialect[0]);
 		    TRACE(("...input NRC %d, %s %d\n",
 			   CharOf(kd.strbuf[0]),
 			   (CharOf(kd.strbuf[0]) == cmp)
 			   ? "unchanged"
 			   : "changed to",
 			   CharOf(cmp)));
-		    kd.strbuf[0] = cmp;
+		    kd.strbuf[0] = (char) cmp;
 		} else if (eightbit) {
 		    prefix = ANSI_ESC;
 		} else if (kd.strbuf[0] == '?'
@@ -1399,7 +1400,7 @@ decfuncvalue(KEY_DATA * kd)
 	    /* after F20 the codes are made up and do not correspond to any
 	     * real terminal.  So they are simply numbered sequentially.
 	     */
-	    result = 42 + (kd->keysym - XK_Fn(21));
+	    result = 42 + (int) (kd->keysym - XK_Fn(21));
 	    break;
 	}
     } else {
@@ -1479,7 +1480,7 @@ hpfuncvalue(ANSI * reply, KEY_DATA * kd)
     }
     if (result > 0) {
 	reply->a_type = ANSI_ESC;
-	reply->a_final = result;
+	reply->a_final = (Char) result;
     }
 #else
     (void) reply;
@@ -1569,7 +1570,7 @@ scofuncvalue(ANSI * reply, KEY_DATA * kd)
     }
     if (result > 0) {
 	reply->a_type = ANSI_CSI;
-	reply->a_final = result;
+	reply->a_final = (Char) result;
     }
 #else
     (void) reply;
@@ -1666,7 +1667,7 @@ sunfuncvalue(ANSI * reply, KEY_DATA * kd)
 	reply->a_final = 'z';
     } else if (IsCursorKey(kd->keysym)) {
 	reply->a_type = ANSI_SS3;
-	reply->a_final = curfinal[kd->keysym - XK_Home];
+	reply->a_final = (Char) curfinal[kd->keysym - XK_Home];
     }
 #else
     (void) reply;
@@ -1678,7 +1679,7 @@ sunfuncvalue(ANSI * reply, KEY_DATA * kd)
 #define isName(c) ((c) == '_' || isalnum(CharOf(c)))
 
 /*
- * Strip unneeded whitespace from a translations resource, lowercasing and
+ * Strip unneeded whitespace from a translations resource, mono-casing and
  * returning a malloc'd copy of the result.
  */
 static char *
@@ -1700,7 +1701,7 @@ stripTranslations(const char *s)
 		ch = *s++;
 		if (ch == '\n') {
 		    if (d != dst)
-			*d++ = ch;
+			*d++ = (char) ch;
 		    state = 0;
 		} else if (strchr(":!#", ch) != 0) {
 		    while (d != dst && isspace(CharOf(d[-1])))
@@ -1714,7 +1715,7 @@ stripTranslations(const char *s)
 			while (d != dst && isspace(CharOf(d[-1])))
 			    --d;
 		    }
-		    *d++ = char2lower(ch);
+		    *d++ = x_toupper(ch);
 		    ++state;
 		}
 		prv = ch;
diff --git a/app/xterm/misc.c b/app/xterm/misc.c
index 63408aadc..77b57ab38 100644
--- a/app/xterm/misc.c
+++ b/app/xterm/misc.c
@@ -1,4 +1,4 @@
-/* $XTermId: misc.c,v 1.384 2008/07/27 15:38:05 tom Exp $ */
+/* $XTermId: misc.c,v 1.391 2008/12/30 17:44:50 tom Exp $ */
 
 /*
  *
@@ -552,22 +552,27 @@ HandleStringEvent(Widget w GCC_UNUSED,
 	return;
 
     if ((*params)[0] == '0' && (*params)[1] == 'x' && (*params)[2] != '\0') {
+	const char *abcdef = "ABCDEF";
+	const char *xxxxxx;
 	Char c, *p;
-	Char hexval[2];
-	hexval[0] = hexval[1] = 0;
-	for (p = (Char *) (*params + 2); (c = *p); p++) {
-	    hexval[0] *= 16;
-	    if (isupper(c))
-		c = tolower(c);
+	unsigned value = 0;
+
+	for (p = (Char *) (*params + 2); (c = CharOf(x_toupper(*p))) !=
+	     '\0'; p++) {
+	    value *= 16;
 	    if (c >= '0' && c <= '9')
-		hexval[0] += c - '0';
-	    else if (c >= 'a' && c <= 'f')
-		hexval[0] += c - 'a' + 10;
+		value += (unsigned) (c - '0');
+	    else if ((xxxxxx = strchr(abcdef, c)) != 0)
+		value += (unsigned) (xxxxxx - abcdef) + 10;
 	    else
 		break;
 	}
-	if (c == '\0')
+	if (c == '\0') {
+	    Char hexval[2];
+	    hexval[0] = (Char) value;
+	    hexval[1] = 0;
 	    StringInput(term, hexval, 1);
+	}
     } else {
 	StringInput(term, (Char *) * params, strlen(*params));
     }
@@ -635,9 +640,9 @@ HandleSpawnTerminal(Widget w GCC_UNUSED,
 	    || setgid(screen->gid) == -1) {
 	    fprintf(stderr, "Cannot reset uid/gid\n");
 	} else {
-	    int myargc = *nparams + 1;
+	    unsigned myargc = *nparams + 1;
 	    char **myargv = TypeMallocN(char *, myargc + 1);
-	    int n = 0;
+	    unsigned n = 0;
 
 	    myargv[n++] = child_exe;
 
@@ -1676,10 +1681,10 @@ ReportAnsiColorRequest(XtermWidget xw, int colornum, int final)
     unparse_end(xw);
 }
 
-static int
+static unsigned
 getColormapSize(Display * display)
 {
-    int result;
+    unsigned result;
     int numFound;
     XVisualInfo myTemplate, *visInfoPtr;
 
@@ -1687,7 +1692,7 @@ getColormapSize(Display * display)
 							    XDefaultScreen(display)));
     visInfoPtr = XGetVisualInfo(display, (long) VisualIDMask,
 				&myTemplate, &numFound);
-    result = (numFound >= 1) ? visInfoPtr->colormap_size : 0;
+    result = (numFound >= 1) ? (unsigned) visInfoPtr->colormap_size : 0;
 
     XFree((char *) visInfoPtr);
     return result;
@@ -2330,8 +2335,10 @@ do_osc(XtermWidget xw, Char * oscbuf, unsigned len GCC_UNUSED, int final)
 	    }
 	}
     }
-    if (buf == 0)
+    if (buf == 0) {
+	TRACE(("do_osc found no data\n"));
 	return;
+    }
 
     switch (mode) {
     case 0:			/* new icon name and title */
@@ -2348,7 +2355,8 @@ do_osc(XtermWidget xw, Char * oscbuf, unsigned len GCC_UNUSED, int final)
 	break;
 
     case 3:			/* change X property */
-	ChangeXprop(buf);
+	if (screen->allowWindowOps)
+	    ChangeXprop(buf);
 	break;
 #if OPT_ISO_COLORS
     case 4:
@@ -2401,7 +2409,9 @@ do_osc(XtermWidget xw, Char * oscbuf, unsigned len GCC_UNUSED, int final)
 
     case 50:
 #if OPT_SHIFT_FONTS
-	if (buf != 0 && !strcmp(buf, "?")) {
+	if (!screen->allowFontOps && xw->misc.shift_fonts) {
+	    ;			/* disabled via resource or control-sequence */
+	} else if (buf != 0 && !strcmp(buf, "?")) {
 	    int num = screen->menu_font_number;
 
 	    unparseputc1(xw, ANSI_OSC);
@@ -2472,7 +2482,7 @@ do_osc(XtermWidget xw, Char * oscbuf, unsigned len GCC_UNUSED, int final)
 
 #if OPT_PASTE64
     case 52:
-	if (screen->allowWindowOps && (buf != 0))
+	if (screen->allowWindowOps)
 	    ManipulateSelectionData(xw, screen, buf, final);
 	break;
 #endif
@@ -2546,12 +2556,12 @@ parse_decudk(char *cp)
 	int len = 0;
 
 	while (isdigit(CharOf(*cp)))
-	    key = (key * 10) + (*cp++ - '0');
+	    key = (key * 10) + (unsigned) (*cp++ - '0');
 	if (*cp == '/') {
 	    cp++;
 	    while ((hi = udk_value(&cp)) >= 0
 		   && (lo = udk_value(&cp)) >= 0) {
-		str[len++] = (hi << 4) | lo;
+		str[len++] = (char) ((hi << 4) | lo);
 	    }
 	}
 	if (len > 0 && key < MAX_UDK) {
@@ -2813,14 +2823,17 @@ do_dcs(XtermWidget xw, Char * dcsbuf, size_t dcslen)
 	    } else
 		okay = False;
 
-	    unparseputc1(xw, ANSI_DCS);
-	    unparseputc(xw, okay ? '1' : '0');
-	    unparseputc(xw, '$');
-	    unparseputc(xw, 'r');
-	    if (okay)
+	    if (okay) {
+		unparseputc1(xw, ANSI_DCS);
+		unparseputc(xw, okay ? '1' : '0');
+		unparseputc(xw, '$');
+		unparseputc(xw, 'r');
 		cp = reply;
-	    unparseputs(xw, cp);
-	    unparseputc1(xw, ANSI_ST);
+		unparseputs(xw, cp);
+		unparseputc1(xw, ANSI_ST);
+	    } else {
+		unparseputc(xw, ANSI_CAN);
+	    }
 	} else {
 	    unparseputc(xw, ANSI_CAN);
 	}
@@ -2828,7 +2841,7 @@ do_dcs(XtermWidget xw, Char * dcsbuf, size_t dcslen)
 #if OPT_TCAP_QUERY
     case '+':
 	cp++;
-	if (*cp == 'q') {
+	if ((*cp == 'q') && screen->allowTcapOps) {
 	    Bool fkey;
 	    unsigned state;
 	    int code;
@@ -2892,16 +2905,18 @@ do_dcs(XtermWidget xw, Char * dcsbuf, size_t dcslen)
 	break;
 #endif
     default:
-	parse_ansi_params(&params, &cp);
-	switch (params.a_final) {
-	case '|':		/* DECUDK */
-	    if (params.a_param[0] == 0)
-		reset_decudk();
-	    parse_decudk(cp);
-	    break;
-	case '{':		/* DECDLD (no '}' case though) */
-	    parse_decdld(&params, cp);
-	    break;
+	if (screen->terminal_id >= 200) {	/* VT220 */
+	    parse_ansi_params(&params, &cp);
+	    switch (params.a_final) {
+	    case '|':		/* DECUDK */
+		if (params.a_param[0] == 0)
+		    reset_decudk();
+		parse_decudk(cp);
+		break;
+	    case '{':		/* DECDLD (no '}' case though) */
+		parse_decdld(&params, cp);
+		break;
+	    }
 	}
 	break;
     }
@@ -3351,7 +3366,7 @@ xtermFindShell(char *leaf, Bool warning)
 }
 #endif /* VMS */
 
-#define ENV_HUNK(n)	((((n) + 1) | 31) + 1)
+#define ENV_HUNK(n)	(unsigned) ((((n) + 1) | 31) + 1)
 
 /*
  * copy the environment before Setenv'ing.
diff --git a/app/xterm/ptyx.h b/app/xterm/ptyx.h
index cf9276092..6e0e26cfa 100644
--- a/app/xterm/ptyx.h
+++ b/app/xterm/ptyx.h
@@ -1,4 +1,4 @@
-/* $XTermId: ptyx.h,v 1.518 2008/09/14 15:16:20 Paul.Lampert Exp $ */
+/* $XTermId: ptyx.h,v 1.536 2008/12/30 17:22:55 tom Exp $ */
 
 /*
  * Copyright 1999-2007,2008 by Thomas E. Dickey
@@ -339,13 +339,15 @@ typedef struct {
 	char *desc;
 } OptionHelp;
 
+typedef short ParmType;
+
 typedef struct {
-	unsigned char	a_type;		/* CSI, etc., see unparseq()	*/
-	unsigned char	a_pintro;	/* private-mode char, if any	*/
-	unsigned char	a_inters;	/* special (before final-char)	*/
-	unsigned char	a_final;	/* final-char			*/
-	short	a_nparam;		/* # of parameters		*/
-	short	a_param[NPARAM];	/* Parameters			*/
+	Char		a_type;		/* CSI, etc., see unparseq()	*/
+	Char		a_pintro;	/* private-mode char, if any	*/
+	Char		a_inters;	/* special (before final-char)	*/
+	Char		a_final;	/* final-char			*/
+	ParmType	a_nparam;	/* # of parameters		*/
+	ParmType	a_param[NPARAM]; /* Parameters			*/
 } ANSI;
 
 #define TEK_FONT_LARGE 0
@@ -1010,8 +1012,12 @@ extern int A2E(int);
 
 /***====================================================================***/
 
-#define LO_BYTE(ch) ((ch) & 0xff)
-#define HI_BYTE(ch) ((ch) >> 8)
+#define LO_BYTE(ch) CharOf((ch) & 0xff)
+#define HI_BYTE(ch) CharOf((ch) >> 8)
+
+#define PACK_FGBG(screen, row, col) \
+	    (unsigned) ((SCRN_BUF_FGRND(screen, row)[col] << 8) \
+		      | (SCRN_BUF_BGRND(screen, row)[col]))
 
 #if OPT_WIDE_CHARS
 #define if_OPT_WIDE_CHARS(screen, code) if(screen->wide_chars) code
@@ -1200,8 +1206,9 @@ typedef enum {
 	DP_LAST
 } SaveModes;
 
-#define DoSM(code,value) screen->save_modes[code] = value
-#define DoRM(code,value) value = screen->save_modes[code]
+#define DoSM(code,value)  screen->save_modes[code] = (unsigned) (value)
+#define DoRM(code,value)  value = (Boolean) screen->save_modes[code]
+#define DoRM0(code,value) value = screen->save_modes[code]
 
 	/* index into vt_shell[] or tek_shell[] */
 typedef enum {
@@ -1235,9 +1242,9 @@ typedef struct {
 	int		row;
 	int		col;
 	unsigned	flags;		/* VTxxx saves graphics rendition */
-	char		curgl;
-	char		curgr;
-	char		gsets[4];
+	Char		curgl;
+	Char		curgr;
+	Char		gsets[4];
 #if OPT_ISO_COLORS
 	int		cur_foreground; /* current foreground color	*/
 	int		cur_background; /* current background color	*/
@@ -1366,8 +1373,8 @@ typedef struct {
 #endif
 	int		border;		/* inner border			*/
 	int		scrollBarBorder; /* scrollBar border		*/
-	unsigned long	event_mask;
-	unsigned short	send_mouse_pos;	/* user wants mouse transition  */
+	long		event_mask;
+	unsigned	send_mouse_pos;	/* user wants mouse transition  */
 					/* and position information	*/
 	Boolean		send_focus_pos; /* user wants focus in/out info */
 	Boolean		quiet_grab;	/* true if no cursor change on focus */
@@ -1378,8 +1385,8 @@ typedef struct {
 	 * base64_flush() is the last step of the conversion, it clears these
 	 * variables.
 	 */
-	int		base64_accu;
-	int		base64_count;
+	unsigned	base64_accu;
+	unsigned	base64_count;
 	unsigned	base64_pad;
 #endif
 #if OPT_READLINE
@@ -1394,7 +1401,7 @@ typedef struct {
 	Boolean		locator_reset;	/* turn mouse off after 1 report? */
 	Boolean		locator_pixels;	/* report in pixels?		*/
 					/* if false, report in cells	*/
-	unsigned short	locator_events;	/* what events to report	*/
+	unsigned	locator_events;	/* what events to report	*/
 	Boolean		loc_filter;	/* is filter rectangle active?	*/
 	int		loc_filter_top;	/* filter rectangle for DEC Locator */
 	int		loc_filter_left;
@@ -1408,12 +1415,19 @@ typedef struct {
 	Boolean		bellOnReset;	/* bellOnReset			*/
 	Boolean		visualbell;	/* visual bell mode		*/
 	Boolean		poponbell;	/* pop on bell mode		*/
+
+	Boolean		allowFontOps;	/* FontOps mode			*/
 	Boolean		allowSendEvents;/* SendEvent mode		*/
+	Boolean		allowTcapOps;	/* TcapOps mode			*/
 	Boolean		allowTitleOps;	/* TitleOps mode		*/
 	Boolean		allowWindowOps;	/* WindowOps mode		*/
+
+	Boolean		allowFontOp0;	/* initial FontOps mode		*/
 	Boolean		allowSendEvent0;/* initial SendEvent mode	*/
+	Boolean		allowTcapOp0;	/* initial TcapOps mode		*/
 	Boolean		allowTitleOp0;	/* initial TitleOps mode	*/
 	Boolean		allowWindowOp0;	/* initial WindowOps mode	*/
+
 	Boolean		awaitInput;	/* select-timeout mode		*/
 	Boolean		grabbedKbd;	/* keyboard is grabbed		*/
 #ifdef ALLOWLOGGING
@@ -1529,7 +1543,7 @@ typedef struct {
 	Boolean		scrollkey;	/* scroll to bottom on key	*/
 	Boolean		cursor_moved;	/* scrolling makes cursor move	*/
 
-	unsigned short	do_wrap;	/* true if cursor in last column
+	Boolean		do_wrap;	/* true if cursor in last column
 					    and character just output    */
 
 	int		incopy;		/* 0 idle; 1 XCopyArea issued;
@@ -1552,11 +1566,11 @@ typedef struct {
 	int		scrolls;	/* outstanding scroll count,
 					    used only with multiscroll	*/
 	SavedCursor	sc[SAVED_CURSORS]; /* data for restore cursor	*/
-	unsigned char	save_modes[DP_LAST]; /* save dec/xterm private modes */
+	unsigned 	save_modes[DP_LAST]; /* save dec/xterm private modes */
 
 	/* Improved VT100 emulation stuff.				*/
 	String		keyboard_dialect; /* default keyboard dialect	*/
-	char		gsets[4];	/* G0 through G3.		*/
+	Char		gsets[4];	/* G0 through G3.		*/
 	Char		curgl;		/* Current GL setting.		*/
 	Char		curgr;		/* Current GR setting.		*/
 	Char		curss;		/* Current single shift.	*/
@@ -1583,10 +1597,10 @@ typedef struct {
 
 #if OPT_VT52_MODE
 	int		vt52_save_level; /* save-area for DECANM	*/
-	char		vt52_save_curgl;
-	char		vt52_save_curgr;
-	char		vt52_save_curss;
-	char		vt52_save_gsets[4];
+	Char		vt52_save_curgl;
+	Char		vt52_save_curgr;
+	Char		vt52_save_curss;
+	Char		vt52_save_gsets[4];
 #endif
 	/* Testing */
 #if OPT_XMC_GLITCH
@@ -1628,7 +1642,7 @@ typedef struct {
 	Boolean		replyToEmacs;	/* Send emacs escape code when done selecting or extending? */
 	Char		*selection_data; /* the current selection */
 	int		selection_size; /* size of allocated buffer */
-	int		selection_length; /* number of significant bytes */
+	unsigned long	selection_length; /* number of significant bytes */
 	EventMode	eventMode;
 	Time		selection_time;	/* latest event timestamp */
 	Time		lastButtonUpTime;
diff --git a/app/xterm/resize.c b/app/xterm/resize.c
index 30b7ce714..7fb91804e 100644
--- a/app/xterm/resize.c
+++ b/app/xterm/resize.c
@@ -1,9 +1,7 @@
-/* $XTermId: resize.c,v 1.99 2006/02/13 01:14:59 tom Exp $ */
-
-/* $XFree86: xc/programs/xterm/resize.c,v 3.62 2006/02/13 01:14:59 dickey Exp $ */
+/* $XTermId: resize.c,v 1.107 2008/12/30 17:07:56 tom Exp $ */
 
 /*
- * Copyright 2003-2005,2006 by Thomas E. Dickey
+ * Copyright 2003-2007,2008 by Thomas E. Dickey
  *
  *                         All Rights Reserved
  *
@@ -60,6 +58,7 @@
 #include <stdio.h>
 #include <ctype.h>
 #include <xstrings.h>
+#include <xtermcap.h>
 #include <xterm_io.h>
 
 #ifdef APOLLO_SR9
@@ -193,34 +192,6 @@ static int checkdigits(char *str);
 static void Usage(void);
 static void readstring(FILE *fp, char *buf, char *str);
 
-#undef US			/* may conflict with curses.h */
-
-#ifdef USE_TERMCAP
-#ifdef HAVE_TERMCAP_H
-#include <termcap.h>
-#if defined(NCURSES_VERSION)
-	/* The tgetent emulation function in SVr4-style curses implementations
-	 * (e.g., ncurses) ignores the buffer, so TERMCAP can't be set from it.
-	 * Instead, just use terminfo.
-	 */
-#undef USE_TERMCAP
-#include <curses.h>
-#endif
-#else
-#undef ERR			/* workaround for glibc 2.1.3 */
-#include <curses.h>
-#ifdef NCURSES_VERSION
-#ifdef HAVE_NCURSES_TERM_H
-#include <ncurses/term.h>
-#else
-#include <term.h>		/* tgetent() */
-#endif /*CYGWIN */
-#endif
-#endif /* HAVE_TERMCAP_H  */
-#endif
-
-#define TERMCAP_SIZE 1500	/* 1023 is standard; 'screen' exceeds */
-
 #ifdef USE_TERMCAP
 static void
 print_termcap(const char *termcap)
@@ -253,8 +224,11 @@ print_termcap(const char *termcap)
 int
 main(int argc, char **argv ENVP_ARG)
 {
-    register char *ptr, *env;
-    register int emu = VT100;
+#ifdef USE_TERMCAP
+    char *env;
+#endif
+    char *ptr;
+    int emu = VT100;
     char *shell;
     struct passwd *pw;
     int i;
@@ -305,7 +279,7 @@ main(int argc, char **argv ENVP_ARG)
 	/* Find out what kind of shell this user is running.
 	 * This is the same algorithm that xterm uses.
 	 */
-	if (((ptr = getenv("SHELL")) == NULL || *ptr == 0) &&
+	if (((ptr = x_getenv("SHELL")) == NULL) &&
 	    (((pw = getpwuid(getuid())) == NULL) ||
 	     *(ptr = pw->pw_shell) == 0))
 	    /* this is the same default that xterm uses */
@@ -344,24 +318,23 @@ main(int argc, char **argv ENVP_ARG)
     }
     tty = fileno(ttyfp);
 #ifdef USE_TERMCAP
-    if (!(env = getenv("TERM")) || !*env) {
+    if ((env = x_getenv("TERM")) == 0) {
 	env = DFT_TERMTYPE;
 	if (SHELL_BOURNE == shell_type)
-	    setname = "TERM=xterm;\nexport TERM;\n";
+	    setname = "TERM=" DFT_TERMTYPE ";\nexport TERM;\n";
 	else
-	    setname = "setenv TERM xterm;\n";
+	    setname = "setenv TERM " DFT_TERMTYPE ";\n";
     }
     termcap[0] = 0;		/* ...just in case we've accidentally gotten terminfo */
     if (tgetent(termcap, env) <= 0 || termcap[0] == 0)
 	ok_tcap = 0;
 #endif /* USE_TERMCAP */
 #ifdef USE_TERMINFO
-    if (!(env = getenv("TERM")) || !*env) {
-	env = DFT_TERMTYPE;
+    if (x_getenv("TERM") == 0) {
 	if (SHELL_BOURNE == shell_type)
-	    setname = "TERM=xterm;\nexport TERM;\n";
+	    setname = "TERM=" DFT_TERMTYPE ";\nexport TERM;\n";
 	else
-	    setname = "setenv TERM xterm;\n";
+	    setname = "setenv TERM " DFT_TERMTYPE ";\n";
     }
 #endif /* USE_TERMINFO */
 
@@ -399,8 +372,18 @@ main(int argc, char **argv ENVP_ARG)
 #endif /* USE_ANY_SYSV_TERMIO/USE_TERMIOS */
 
     if (argc == 2) {
-	sprintf(buf, setsize[emu], argv[0], argv[1]);
-	write(tty, buf, strlen(buf));
+	char *tmpbuf = TypeMallocN(char,
+				   strlen(setsize[emu]) +
+				   strlen(argv[0]) +
+				   strlen(argv[1]) +
+				   1);
+	if (tmpbuf == 0) {
+	    fprintf(stderr, "%s: Cannot query size\n", myname);
+	    onintr(0);
+	}
+	sprintf(tmpbuf, setsize[emu], argv[0], argv[1]);
+	write(tty, tmpbuf, strlen(tmpbuf));
+	free(tmpbuf);
     }
     write(tty, getsize[emu], strlen(getsize[emu]));
     readstring(ttyfp, buf, size[emu]);
@@ -517,7 +500,7 @@ main(int argc, char **argv ENVP_ARG)
 }
 
 static int
-checkdigits(register char *str)
+checkdigits(char *str)
 {
     while (*str) {
 	if (!isdigit(CharOf(*str)))
@@ -528,9 +511,9 @@ checkdigits(register char *str)
 }
 
 static void
-readstring(register FILE *fp, register char *buf, char *str)
+readstring(FILE *fp, char *buf, char *str)
 {
-    register int last, c;
+    int last, c;
 #if !defined(USG) && !defined(__UNIXOS2__)
     /* What is the advantage of setitimer() over alarm()? */
     struct itimerval it;
@@ -545,17 +528,20 @@ readstring(register FILE *fp, register char *buf, char *str)
     setitimer(ITIMER_REAL, &it, (struct itimerval *) NULL);
 #endif
     if ((c = getc(fp)) == 0233) {	/* meta-escape, CSI */
-	*buf++ = c = ESCAPE("")[0];
+	c = ESCAPE("")[0];
+	*buf++ = (char) c;
 	*buf++ = '[';
     } else {
-	*buf++ = c;
+	*buf++ = (char) c;
     }
     if (c != *str) {
 	fprintf(stderr, "%s: unknown character, exiting.\r\n", myname);
 	onintr(0);
     }
     last = str[strlen(str) - 1];
-    while ((*buf++ = getc(fp)) != last) ;
+    while ((*buf++ = (char) getc(fp)) != last) {
+	;
+    }
 #if defined(USG) || defined(__UNIXOS2__)
     alarm(0);
 #else
diff --git a/app/xterm/scrollbar.c b/app/xterm/scrollbar.c
index 3f9ddad4c..8de6cf7e9 100644
--- a/app/xterm/scrollbar.c
+++ b/app/xterm/scrollbar.c
@@ -1,4 +1,4 @@
-/* $XTermId: scrollbar.c,v 1.136 2008/06/03 20:55:33 tom Exp $ */
+/* $XTermId: scrollbar.c,v 1.137 2008/12/30 15:40:13 tom Exp $ */
 
 /* $XFree86: xc/programs/xterm/scrollbar.c,v 3.48 2006/02/13 01:14:59 dickey Exp $ */
 
@@ -72,6 +72,7 @@
 #include <error.h>
 #include <menu.h>
 #include <xcharmouse.h>
+#include <xstrings.h>
 
 /*
  * The scrollbar's border overlaps the border of the vt100 window.  If there
@@ -593,11 +594,12 @@ ScrollTextUpDownBy(
 }
 
 /*
- * assume that b is lower case and allow plural
+ * assume that b is alphabetic and allow plural
  */
 static int
-specialcmplowerwiths(char *a, char *b, int *modifier)
+CompareWidths(char *a, char *b, int *modifier)
 {
+    int result;
     char ca, cb;
 
     *modifier = 0;
@@ -605,8 +607,8 @@ specialcmplowerwiths(char *a, char *b, int *modifier)
 	return 0;
 
     while (1) {
-	ca = char2lower(*a);
-	cb = *b;
+	ca = x_toupper(*a);
+	cb = x_toupper(*b);
 	if (ca != cb || ca == '\0')
 	    break;		/* if not eq else both nul */
 	a++, b++;
@@ -614,21 +616,25 @@ specialcmplowerwiths(char *a, char *b, int *modifier)
     if (cb != '\0')
 	return 0;
 
-    if (ca == 's')
+    if (ca == 'S')
 	ca = *++a;
 
     switch (ca) {
     case '+':
     case '-':
 	*modifier = (ca == '-' ? -1 : 1) * atoi(a + 1);
-	return 1;
+	result = 1;
+	break;
 
     case '\0':
-	return 1;
+	result = 1;
+	break;
 
     default:
-	return 0;
+	result = 0;
+	break;
     }
+    return result;
 }
 
 static long
@@ -641,11 +647,11 @@ params_to_pixels(TScreen * screen, String * params, Cardinal n)
     switch (n > 2 ? 2 : n) {
     case 2:
 	s = params[1];
-	if (specialcmplowerwiths(s, "page", &modifier)) {
+	if (CompareWidths(s, "PAGE", &modifier)) {
 	    mult = (MaxRows(screen) + modifier) * FontHeight(screen);
-	} else if (specialcmplowerwiths(s, "halfpage", &modifier)) {
+	} else if (CompareWidths(s, "HALFPAGE", &modifier)) {
 	    mult = ((MaxRows(screen) + modifier) * FontHeight(screen)) / 2;
-	} else if (specialcmplowerwiths(s, "pixel", &modifier)) {
+	} else if (CompareWidths(s, "PIXEL", &modifier)) {
 	    mult = 1;
 	} else {
 	    /* else assume that it is Line */
diff --git a/app/xterm/tabs.c b/app/xterm/tabs.c
index 28880ec3e..d4186e127 100644
--- a/app/xterm/tabs.c
+++ b/app/xterm/tabs.c
@@ -1,4 +1,4 @@
-/* $XTermId: tabs.c,v 1.31 2008/02/24 17:35:03 Nemeth Exp $ */
+/* $XTermId: tabs.c,v 1.33 2008/12/30 10:18:14 tom Exp $ */
 
 /*
  *	$XFree86: xc/programs/xterm/tabs.c,v 3.14 2006/02/13 01:14:59 dickey Exp $
@@ -116,7 +116,8 @@ TabNext(XtermWidget xw, Tabs tabs, int col)
     if (screen->curses && screen->do_wrap && (xw->flags & WRAPAROUND)) {
 	xtermIndex(xw, 1);
 	set_cur_col(screen, 0);
-	col = screen->do_wrap = 0;
+	col = 0;
+	screen->do_wrap = False;
     }
     for (++col; col < MAX_TABS; ++col)
 	if (TST_TAB(tabs, col))
@@ -134,7 +135,7 @@ static int
 TabPrev(Tabs tabs, int col)
 {
     for (--col; col >= 0; --col)
-	if (TST_TAB(tabs, col))
+	if ((col < MAX_TABS) && TST_TAB(tabs, col))
 	    return (col);
 
     return (0);
diff --git a/app/xterm/util.c b/app/xterm/util.c
index 05860261a..8e046f1b2 100644
--- a/app/xterm/util.c
+++ b/app/xterm/util.c
@@ -1,4 +1,4 @@
-/* $XTermId: util.c,v 1.407 2008/02/21 20:29:01 tom Exp $ */
+/* $XTermId: util.c,v 1.410 2008/12/30 16:43:46 tom Exp $ */
 
 /*
  * Copyright 1999-2007,2008 by Thomas E. Dickey
@@ -769,7 +769,7 @@ InsertLine(XtermWidget xw, int n)
 	ScrnDisownSelection(xw);
     }
 
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
     if (n > (i = screen->bot_marg - screen->cur_row + 1))
 	n = i;
     if (screen->jumpscroll) {
@@ -841,7 +841,7 @@ DeleteLine(XtermWidget xw, int n)
 	ScrnDisownSelection(xw);
     }
 
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
     if (n > (i = screen->bot_marg - screen->cur_row + 1))
 	n = i;
     if (screen->jumpscroll) {
@@ -930,7 +930,7 @@ InsertChar(XtermWidget xw, unsigned n)
 	&& ScrnIsLineInSelection(screen, row)) {
 	ScrnDisownSelection(xw);
     }
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 
     assert(screen->cur_col <= screen->max_col);
     limit = MaxCols(screen) - screen->cur_col;
@@ -1006,7 +1006,7 @@ DeleteChar(XtermWidget xw, unsigned n)
 	&& ScrnIsLineInSelection(screen, row)) {
 	ScrnDisownSelection(xw);
     }
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 
     assert(screen->cur_col <= screen->max_col);
     limit = MaxCols(screen) - screen->cur_col;
@@ -1193,7 +1193,7 @@ ClearInLine2(XtermWidget xw, int flags, int row, int col, unsigned len)
 
     if (screen->cursor_state)
 	HideCursor();
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
 
     if (AddToVisible(xw)) {
 	ClearCurBackground(xw,
@@ -1274,6 +1274,7 @@ ClearRight(XtermWidget xw, int n)
 
     /* with the right part cleared, we can't be wrapping */
     ScrnClrWrapped(screen, screen->cur_row);
+    screen->do_wrap = False;
 }
 
 /*
@@ -1324,7 +1325,7 @@ ClearScreen(XtermWidget xw)
 	HideCursor();
 
     ScrnDisownSelection(xw);
-    screen->do_wrap = 0;
+    screen->do_wrap = False;
     if ((top = INX2ROW(screen, 0)) <= screen->max_row) {
 	if (screen->scroll_amt)
 	    FlushScroll(xw);
@@ -3598,19 +3599,6 @@ my_strerror(int n)
 #endif
 #endif
 
-int
-char2lower(int ch)
-{
-    if (isascii(ch) && isupper(ch)) {	/* lowercasify */
-#ifdef _tolower
-	ch = _tolower(ch);
-#else
-	ch = tolower(ch);
-#endif
-    }
-    return ch;
-}
-
 void
 update_keyboard_type(void)
 {
diff --git a/app/xterm/version.h b/app/xterm/version.h
index 66f3268a8..496296104 100644
--- a/app/xterm/version.h
+++ b/app/xterm/version.h
@@ -1,4 +1,4 @@
-/* $XTermId: version.h,v 1.293 2008/09/14 13:45:26 tom Exp $ */
+/* $XTermId: version.h,v 1.294 2008/10/05 16:46:50 tom Exp $ */
 
 /*
  * These definitions are used to build the string that's printed in response to
@@ -6,7 +6,7 @@
  * version of X to which this version of xterm has been built.  The number in
  * parentheses is my patch number (Thomas E. Dickey).
  */
-#define XTERM_PATCH   237
+#define XTERM_PATCH   238
 
 #ifndef __vendorversion__
 #define __vendorversion__ "XTerm/OpenBSD"
diff --git a/app/xterm/vttests/tcapquery.pl b/app/xterm/vttests/tcapquery.pl
index a96a74ca1..54de5d08d 100644
--- a/app/xterm/vttests/tcapquery.pl
+++ b/app/xterm/vttests/tcapquery.pl
@@ -1,14 +1,37 @@
 #!/usr/bin/perl -w
-# $XTermId: tcapquery.pl,v 1.10 2006/07/20 00:37:00 tom Exp $
-# $XFree86: xc/programs/xterm/vttests/tcapquery.pl,v 1.3 2006/03/13 01:28:02 dickey Exp $
+# $XTermId: tcapquery.pl,v 1.13 2008/10/05 16:20:14 tom Exp $
 #
 # -- Thomas Dickey (2004/3/3)
 # Test the tcap-query option of xterm.
 
 use strict;
 
+use Getopt::Std;
 use IO::Handle;
 
+our ($opt_a, $opt_b, $opt_c, $opt_e, $opt_f, $opt_i, $opt_k, $opt_m, $opt_x);
+&getopts('abcefikmx:') || die("Usage: $0 [options]\n
+Options:\n
+  -a     (same as -c -e -f -k -m)
+  -b     use both terminfo and termcap (default is termcap)
+  -c     cursor-keys
+  -e     editing keypad-keys
+  -f     function-keys
+  -i     use terminfo rather than termcap names
+  -k     numeric keypad-keys
+  -m     miscellaneous (none of -c, -e, -f, -k)
+  -x KEY extended cursor/editing key (terminfo only)
+");
+
+if ( not ( defined($opt_c)
+	or defined($opt_e)
+	or defined($opt_f)
+	or defined($opt_k)
+	or defined($opt_m)
+	or defined($opt_x) ) ) {
+	$opt_a=1;
+}
+
 sub get_reply($) {
 	open TTY, "+</dev/tty" or die("Cannot open /dev/tty\n");
 	autoflush TTY 1;
@@ -19,6 +42,9 @@ sub get_reply($) {
 	my $reply=<TTY>;
 	close TTY;
 	system "stty $old";
+	if ( defined $reply ) {
+		die("^C received\n") if ( "$reply" eq "\003" );
+	}
 	return $reply;
 }
 
@@ -38,10 +64,16 @@ sub query_tcap($$) {
 	my $tinfo = $_[1];
 	my $param1 = hexified($tcap);
 	my $param2 = hexified($tinfo);
+	my $reply;
 
 	# uncomment one of the following lines
-	my $reply=get_reply("\x1bP+q" . $param1 . ";" . $param2 . "\x1b\\");
-	#my $reply=get_reply("\x1bP+q" . $param2 . "\x1b\\");
+	if ( defined($opt_b) ) {
+		$reply=get_reply("\x1bP+q" . $param1 . ";" . $param2 . "\x1b\\");
+	} elsif ( defined($opt_i) ) {
+		$reply=get_reply("\x1bP+q" . $param2 . "\x1b\\");
+	} else {
+		$reply=get_reply("\x1bP+q" . $param1 . "\x1b\\");
+	}
 
 	return unless defined $reply;
 	if ( $reply =~ /\x1bP1\+r[[:xdigit:]]+=[[:xdigit:]]*.*/ ) {
@@ -82,28 +114,52 @@ sub query_tcap($$) {
 	}
 }
 
+sub query_extended($) {
+	my $name = $_[0];
+	my $n;
+
+	$name = "k" . $name if ( $name !~ /^k/ );
+
+	for ( $n = 2; $n <= 7; ++$n) {
+		my $test = $name;
+		$test = $test . $n if ( $n > 2 );
+		query_tcap( $name, $test );
+	}
+}
+
 # See xtermcapKeycode()
-query_tcap(	"#2",	"kHOM");
-query_tcap(	"*7",	"kEND");
+if ( defined($opt_a) || defined($opt_c) ) {
+query_tcap(	"kl",	"kcub1");
+query_tcap(	"kd",	"kcud1");
+query_tcap(	"ku",	"kcuu1");
+query_tcap(	"kr",	"kcuf1");
+
 query_tcap(	"#4",	"kLFT");
 query_tcap(	"%c",	"kNXT");
 query_tcap(	"%e",	"kPRV");
 query_tcap(	"%i",	"kRIT");
 
+}
+
+if ( defined($opt_a) || defined($opt_e) ) {
+query_tcap(	"kD",	"kdch1");
+query_tcap(	"kI",	"kich1");
+
 query_tcap(	"kh",	"khome");
 query_tcap(	"\@7",	"kend");
-query_tcap(	"kl",	"kcub1");
-query_tcap(	"kd",	"kcud1");
-query_tcap(	"ku",	"kcuu1");
-query_tcap(	"kr",	"kcuf1");
+query_tcap(	"#2",	"kHOM");
+query_tcap(	"*7",	"kEND");
 
-query_tcap(	"%1",	"khlp");
-query_tcap(	"#1",	"kHLP");
 query_tcap(	"*6",	"kslt");
 query_tcap(	"#6",	"kSLT");
 query_tcap(	"\@0",	"kfnd");
 query_tcap(	"*0",	"kFND");
 
+query_tcap(	"kN",	"knp");
+query_tcap(	"kP",	"kpp");
+}
+
+if ( defined($opt_a) || defined($opt_f) ) {
 query_tcap(	"k1",	"kf1");
 query_tcap(	"k2",	"kf2");
 query_tcap(	"k3",	"kf3");
@@ -167,19 +223,28 @@ query_tcap(	"Fo",	"kf60");
 query_tcap(	"Fp",	"kf61");
 query_tcap(	"Fq",	"kf62");
 query_tcap(	"Fr",	"kf63");
+}
 
+if ( defined($opt_a) || defined($opt_k) ) {
 query_tcap(	"K1",	"ka1");
+query_tcap(	"K3",	"ka3");
 query_tcap(	"K4",	"kc1");
+query_tcap(	"K5",	"kc3");
+}
 
+if ( defined($opt_a) || defined($opt_m) ) {
 query_tcap(	"kB",	"kcbt");
 query_tcap(	"kC",	"kclr");
-
-query_tcap(	"kD",	"kdch1");
-query_tcap(	"kI",	"kich1");
-
-query_tcap(	"kN",	"knp");
-query_tcap(	"kP",	"kpp");
+query_tcap(	"&8",	"kund");
 
 query_tcap(	"kb",	"kbs");
 
+query_tcap(	"%1",	"khlp");
+query_tcap(	"#1",	"kHLP");
+
 query_tcap(	"Co",	"colors");
+}
+
+if ( defined ($opt_x) ) {
+	query_extended($opt_x);
+}
diff --git a/app/xterm/xcharmouse.h b/app/xterm/xcharmouse.h
index c1f257e96..695bbc336 100644
--- a/app/xterm/xcharmouse.h
+++ b/app/xterm/xcharmouse.h
@@ -1,6 +1,4 @@
-/*
- * $XFree86: xc/programs/xterm/xcharmouse.h,v 1.3 2002/08/24 18:54:39 dickey Exp $
- */
+/* $XTermId: xcharmouse.h,v 1.11 2008/10/05 21:18:49 tom Exp $ */
 
 /************************************************************
 
@@ -44,6 +42,10 @@ OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 #define SET_BTN_EVENT_MOUSE         1002
 #define SET_ANY_EVENT_MOUSE         1003
 
+#if OPT_FOCUS_EVENT
+#define SET_FOCUS_EVENT_MOUSE       1004 /* can be combined with above */
+#endif
+
 #define SET_BUTTON1_MOVE_POINT      2001 /* click1 emit Esc seq to move point*/
 #define SET_BUTTON2_MOVE_POINT      2002 /* press2 emit Esc seq to move point*/
 #define SET_DBUTTON3_DELETE         2003 /* Double click-3 deletes */
@@ -63,7 +65,7 @@ OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 #endif /* OPT_DEC_LOCATOR */
 
 /* Values for screen->send_mouse_pos */
-enum {
+typedef enum {
     MOUSE_OFF
     ,X10_MOUSE
     ,VT200_MOUSE
@@ -71,6 +73,6 @@ enum {
     ,BTN_EVENT_MOUSE
     ,ANY_EVENT_MOUSE
     ,DEC_LOCATOR
-};
+} XtermMouseModes;
 
 #endif /* included_xcharmouse_h */
diff --git a/app/xterm/xstrings.c b/app/xterm/xstrings.c
index 746955315..1c141383b 100644
--- a/app/xterm/xstrings.c
+++ b/app/xterm/xstrings.c
@@ -1,10 +1,10 @@
-/* $XTermId: xstrings.c,v 1.25 2006/02/13 01:14:59 tom Exp $ */
+/* $XTermId: xstrings.c,v 1.28 2008/12/30 17:10:37 tom Exp $ */
 
 /* $XFree86: xc/programs/xterm/xstrings.c,v 1.10 2006/02/13 01:14:59 dickey Exp $ */
 
 /************************************************************
 
-Copyright 2000-2005,2006 by Thomas E. Dickey
+Copyright 2000-2007,2008 by Thomas E. Dickey
 
                         All Rights Reserved
 
@@ -55,6 +55,31 @@ x_basename(char *name)
     return (cp ? cp + 1 : name);
 }
 
+char *
+x_getenv(const char *name)
+{
+    return x_nonempty(getenv(name));
+}
+
+/*
+ * Check if the given string is nonnull/nonempty.  If so, return a pointer
+ * to the beginning of its content, otherwise return null.
+ */
+char *
+x_nonempty(char *s)
+{
+    if (s != 0) {
+	if (*s == '\0') {
+	    s = 0;
+	} else {
+	    s = x_skip_blanks(s);
+	    if (*s == '\0')
+		s = 0;
+	}
+    }
+    return s;
+}
+
 char *
 x_skip_blanks(char *s)
 {
@@ -86,8 +111,8 @@ int
 x_strncasecmp(const char *s1, const char *s2, unsigned n)
 {
     while (n-- != 0) {
-	int c1 = toupper(CharOf(*s1));
-	int c2 = toupper(CharOf(*s2));
+	char c1 = x_toupper(*s1);
+	char c2 = x_toupper(*s2);
 	if (c1 != c2)
 	    return 1;
 	if (c1 == 0)
@@ -161,3 +186,29 @@ x_strtrim(char *s)
     }
     return base;
 }
+
+/*
+ * Avoid using system locale for upper/lowercase conversion, since there are
+ * a few locales where toupper(tolower(c)) != c.
+ */
+char
+x_toupper(int ch)
+{
+    static char table[256];
+    char result = table[CharOf(ch)];
+
+    if (result == '\0') {
+	unsigned n;
+	const char *s = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
+
+	for (n = 0; n < sizeof(table); ++n) {
+	    table[n] = (char) n;
+	}
+	for (n = 0; s[n] != '\0'; ++n) {
+	    table[CharOf(s[n])] = s[n % 26];
+	}
+	result = table[CharOf(ch)];
+    }
+
+    return result;
+}
diff --git a/app/xterm/xstrings.h b/app/xterm/xstrings.h
index b542f5fba..56cfab3b3 100644
--- a/app/xterm/xstrings.h
+++ b/app/xterm/xstrings.h
@@ -1,10 +1,10 @@
-/* $XTermId: xstrings.h,v 1.11 2006/02/13 01:14:59 tom Exp $ */
+/* $XTermId: xstrings.h,v 1.14 2008/12/30 17:10:43 tom Exp $ */
 
 /* $XFree86: xc/programs/xterm/xstrings.h,v 1.5 2006/02/13 01:14:59 dickey Exp $ */
 
 /************************************************************
 
-Copyright 2000-2002,2005 by Thomas E. Dickey
+Copyright 2000-2007,2008 by Thomas E. Dickey
 
                         All Rights Reserved
 
@@ -37,13 +37,16 @@ authorization.
 #ifndef included_xstrings_h
 #define included_xstrings_h 1
 
-extern char *x_basename(char *name);
-extern char *x_skip_blanks(char *s);
-extern char *x_skip_nonblanks(char *s);
-extern char *x_strdup(const char *s);
-extern char *x_strindex(char *s1, char *s2);
-extern char *x_strtrim(char *s);
-extern int x_strcasecmp(const char *s1, const char *s2);
-extern int x_strncasecmp(const char *s1, const char *s2, unsigned n);
+extern char *x_basename(char * /* name */);
+extern char *x_getenv(const char * /* name */);
+extern char *x_nonempty(char * /* s */);
+extern char *x_skip_blanks(char * /* s */);
+extern char *x_skip_nonblanks(char * /* s */);
+extern char *x_strdup(const char * /* s */);
+extern char *x_strindex(char * /* s1 */, char * /* s2 */);
+extern char *x_strtrim(char * /* s */);
+extern char x_toupper(int /* ch */);
+extern int x_strcasecmp(const char * /* s1 */, const char * /* s2 */);
+extern int x_strncasecmp(const char * /* s1 */, const char * /* s2 */, unsigned  /* n */);
 
 #endif /* included_xstrings_h */
diff --git a/app/xterm/xterm.h b/app/xterm/xterm.h
index d5e81b9ad..4c4bb9619 100644
--- a/app/xterm/xterm.h
+++ b/app/xterm/xterm.h
@@ -1,4 +1,4 @@
-/* $XTermId: xterm.h,v 1.503 2008/09/14 15:18:39 Paul.Lampert Exp $ */
+/* $XTermId: xterm.h,v 1.507 2008/12/30 15:46:41 tom Exp $ */
 
 /************************************************************
 
@@ -337,7 +337,9 @@ extern char **environ;
 /***====================================================================***/
 
 #define XtNallowC1Printable	"allowC1Printable"
+#define XtNallowFontOps		"allowFontOps"
 #define XtNallowSendEvents	"allowSendEvents"
+#define XtNallowTcapOps		"allowTcapOps"
 #define XtNallowTitleOps	"allowTitleOps"
 #define XtNallowWindowOps	"allowWindowOps"
 #define XtNaltIsNotMeta		"altIsNotMeta"
@@ -492,7 +494,9 @@ extern char **environ;
 #define XtNxmcMoveSGR		"xmcMoveSGR"
 
 #define XtCAllowC1Printable	"AllowC1Printable"
+#define XtCAllowFontOps		"AllowFontOps"
 #define XtCAllowSendEvents	"AllowSendEvents"
+#define XtCAllowTcapOps		"AllowTcapOps"
 #define XtCAllowTitleOps	"AllowTitleOps"
 #define XtCAllowWindowOps	"AllowWindowOps"
 #define XtCAltIsNotMeta		"AltIsNotMeta"
@@ -1105,7 +1109,6 @@ extern GC updatedXtermGC (XtermWidget /* xw */, unsigned  /* flags */, unsigned
 extern int AddToRefresh (XtermWidget /* xw */);
 extern int ClearInLine (XtermWidget /* xw */, int /* row */, int /* col */, unsigned /* len */);
 extern int HandleExposure (XtermWidget /* xw */, XEvent * /* event */);
-extern int char2lower (int  /* ch */);
 extern int drawXtermText (XtermWidget /* xw */, unsigned  /* flags */, GC  /* gc */, int  /* x */, int  /* y */, int  /* chrset */, PAIRED_CHARS(Char * /* text */, Char * /* text2 */), Cardinal  /* len */, int  /* on_wide */);
 extern void ChangeColors (XtermWidget  /* xw */, ScrnColors * /* pNew */);
 extern void ClearRight (XtermWidget /* xw */, int /* n */);
@@ -1229,15 +1232,15 @@ extern void putXtermCell (TScreen * /* screen */, int  /* row */, int  /* col */
 
 #if OPT_HIGHLIGHT_COLOR
 #define isNotForeground(xw, fg, bg, sel) \
-		((sel) != T_COLOR(&((xw)->screen), TEXT_FG) \
-		 && (sel) != (fg) \
-		 && (sel) != (bg) \
-		 && (sel) != (xw)->dft_foreground)
+		(Boolean) ((sel) != T_COLOR(&((xw)->screen), TEXT_FG) \
+			   && (sel) != (fg) \
+			   && (sel) != (bg) \
+			   && (sel) != (xw)->dft_foreground)
 #define isNotBackground(xw, fg, bg, sel) \
-		((sel) != T_COLOR(&((xw)->screen), TEXT_BG) \
-		 && (sel) != (fg) \
-		 && (sel) != (bg) \
-		 && (sel) != (xw)->dft_background)
+		(Boolean) ((sel) != T_COLOR(&((xw)->screen), TEXT_BG) \
+			   && (sel) != (fg) \
+			   && (sel) != (bg) \
+			   && (sel) != (xw)->dft_background)
 #endif
 
 #if OPT_WIDE_CHARS
diff --git a/app/xterm/xterm.log.html b/app/xterm/xterm.log.html
index 7502e8691..d1fad6cf8 100644
--- a/app/xterm/xterm.log.html
+++ b/app/xterm/xterm.log.html
@@ -20,7 +20,7 @@
  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF   *
  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.            *
  *****************************************************************************
-  $XTermId: xterm.log.html,v 1.690 2008/09/14 23:43:15 tom Exp $
+  $XTermId: xterm.log.html,v 1.703 2008/12/30 19:09:49 tom Exp $
   -->
 <HTML>
 <HEAD>
@@ -45,6 +45,7 @@ Most of these are summarized in the XFree86 CHANGELOG
 is the latest version of this file.
 
 <UL>
+<LI><A HREF="#xterm_238">Patch #238 - 2008/12/30</A>
 <LI><A HREF="#xterm_237">Patch #237 - 2008/09/14</A>
 <LI><A HREF="#xterm_236">Patch #236 - 2008/07/27</A>
 <LI><A HREF="#xterm_235">Patch #235 - 2008/04/20</A>
@@ -285,6 +286,53 @@ is the latest version of this file.
 <LI><A HREF="#xterm_01">Patch #1 - 1996/1/6</A>
 </UL>
 
+<H1><A NAME="xterm_238">Patch #238 - 2008/12/30</A></H1>
+<ul>
+	<li>update configure macro CF_XOPEN_SOURCE for AIX 6.x and Mint
+	    platforms.
+
+	<li>reset the screen wrapping-flag at the end of
+	    <code>ClearRight</code> to fix an occasional case where the last
+	    character of a scrolled and wrapped line would be cleared (patch by
+	    Joe Peterson).
+
+	<li>modify to use POSIX coding for comparing resource settings such
+	    as <code>locale</code>, to work with locales such as Turkish
+	    (report by M Vefa Bicakci).
+
+	<li>turn on configure <code>paste64</code> feature by default
+	    (request by Jean-Philippe Bernardy).
+	    It is runtime enabled/disabled with <code>allowWindowOps</code>.
+
+	<li>turn on configure <code>tcap-query</code> feature by default,
+	    add resource <code>allowTcapOps</code>
+	    to make this runtime enabled/disabled.
+
+	<li>make <code>OSC 3</code> (change X property, from
+	    <a href="#xterm_110">patch #110</a>)
+	    subject to <code>allowWindowOps</code> resource.
+
+	<li>make VT220 <code>DSR</code> responses inactive in VT100-mode.
+
+	<li>make <code>DECUDK</code> feature inactive in VT100-mode.
+
+	<li>respond to incorrectly formatted <code>DECRQSS</code> with a
+	    cancel.
+
+	<li>add <code>allowFontOps</code> 
+	    resource to allow the fontsize-switching and font query/set
+	    control sequences to be enabled/disabled
+	    (prompted by Debian #510030).
+
+	<li>some code cleanup based on gcc 4.x <code>-Wconversion</code>
+	    warnings in button.c and charproc.c
+
+	<li>modify <code>tcap-query</code> feature to not return data for
+	    shifted cursor-keys when the keyboard type is set to vt220,
+	    since returning the same string for shifted/unshifted keys may
+	    confuse some applications (GenToo #212546).
+</ul>
+
 <H1><A NAME="xterm_237">Patch #237 - 2008/09/14</A></H1>
 <ul>
 	<li>improve usability of TrueType fonts by making the font-size
diff --git a/app/xterm/xterm.man b/app/xterm/xterm.man
index 5e8974f26..d99a686de 100644
--- a/app/xterm/xterm.man
+++ b/app/xterm/xterm.man
@@ -1,5 +1,5 @@
 '\" t
-.\" $XTermId: xterm.man,v 1.411 2008/09/14 23:06:19 tom Exp $
+.\" $XTermId: xterm.man,v 1.413 2008/12/30 11:23:59 tom Exp $
 .\"
 .\" Copyright 1996-2007,2008 by Thomas E. Dickey
 .\"
@@ -1445,6 +1445,10 @@ as if they were printable characters.
 Although this corresponds to no particular standard,
 some users insist it is a VT100.
 The default is ``false.''
+.TP
+.B "allowFontOps (\fPclass\fB AllowFontOps)"
+Specifies whether control sequences that set/query the font should be allowed.
+The default is ``true.''
 .TP 8
 .B "allowSendEvents (\fPclass\fB AllowSendEvents)"
 Specifies whether or not synthetic key and button events (generated using
@@ -1454,6 +1458,12 @@ Note that allowing
 such events creates a very large security hole.
 The default is ``false.''
 .TP
+.B "allowTcapOps (\fPclass\fB AllowTcapOps)"
+Specifies whether control sequences that query the terminal's
+notion of its function-key strings, as termcap or terminfo capabilities
+should be allowed.
+The default is ``true.''
+.TP
 .B "allowTitleOps (\fPclass\fB AllowTitleOps)"
 Specifies whether control sequences that modify the window title or icon name
 should be allowed.
@@ -5090,6 +5100,9 @@ Thomas Dickey (invisible-island.net).
 .SH OPENBSD SPECIFICS
 On OpenBSD, the following resources have different default values: 
 .TP 8
+.B allowWindowOps: false
+Extended window control sequences are disabled.
+.TP 8
 .B deleteIsDEL: true
 The Delete key generates \fB^?\fP. 
 .TP 8
diff --git a/app/xterm/xtermcap.c b/app/xterm/xtermcap.c
index e337b5dcd..415b61578 100644
--- a/app/xterm/xtermcap.c
+++ b/app/xterm/xtermcap.c
@@ -1,7 +1,7 @@
-/* $XTermId: xtermcap.c,v 1.13 2008/07/27 15:18:56 tom Exp $ */
+/* $XTermId: xtermcap.c,v 1.14 2008/10/05 16:43:36 tom Exp $ */
 
 /*
- * Copyright 2007 by Thomas E. Dickey
+ * Copyright 2007,2008 by Thomas E. Dickey
  *
  *                         All Rights Reserved
  *
@@ -156,6 +156,8 @@ static TCAPINFO table[] = {
 
 	DATA(	"K1",	"ka1",		XK_KP_Home,	0	),
 	DATA(	"K4",	"kc1",		XK_KP_End,	0	),
+	DATA(	"K3",	"ka3",		XK_KP_Prior,	0	),
+	DATA(	"K5",	"kc3",		XK_KP_Next,	0	),
 
 #ifdef XK_ISO_Left_Tab
 	DATA(	"kB",	"kcbt",		XK_ISO_Left_Tab, 0	),
@@ -165,6 +167,7 @@ static TCAPINFO table[] = {
 	DATA(	"kI",	"kich1",	XK_Insert,	0	),
 	DATA(	"kN",	"knp",		XK_Next,	0	),
 	DATA(	"kP",	"kpp",		XK_Prior,	0	),
+	DATA(	"&8",	"kund",		XK_Undo,	0	),
 	DATA(	"kb",	"kbs",		XK_BackSpace,	0	),
 # if OPT_TCAP_QUERY && OPT_ISO_COLORS
 	/* XK_COLORS is a fake code. */
@@ -213,7 +216,7 @@ hex2int(int c)
 }
 
 static TCAPINFO *
-lookupTcapByName(const char *name)
+lookupTcapByName(XtermWidget xw, const char *name)
 {
     TCAPINFO *result = 0;
     Cardinal n;
@@ -226,6 +229,24 @@ lookupTcapByName(const char *name)
 	    }
 	}
     }
+
+    /*
+     * The vt220-keyboard will not return distinct key sequences for shifted
+     * cursor-keys.  Just pretend they do not exist, since some programs may
+     * be confused if we return the same data for shifted/unshifted keys.
+     */
+    if (xw->keyboard.type == keyboardIsVT220
+	&& result != 0
+	&& result->state == 2) {
+	result = 0;
+    }
+
+    if (result != 0) {
+	TRACE(("lookupTcapByName(%s) tc=%s, ti=%s code %#x, state %#x\n",
+	       name, result->tc, result->ti, result->code, result->state));
+    } else {
+	TRACE(("lookupTcapByName(%s) FAIL\n", name));
+    }
     return result;
 }
 
@@ -263,7 +284,7 @@ xtermcapKeycode(XtermWidget xw, char **params, unsigned *state, Bool * fkey)
     *fkey = False;
 
     if (*p == 0 || *p == ';') {
-	if ((data = lookupTcapByName(name)) != 0) {
+	if ((data = lookupTcapByName(xw, name)) != 0) {
 	    code = data->code;
 	    *state = xtermParamToState(xw, data->state);
 	    if (IsFunctionKey(code)) {
