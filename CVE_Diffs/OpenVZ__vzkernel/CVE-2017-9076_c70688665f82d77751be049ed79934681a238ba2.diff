OpenVZ__vzkernel
commit c70688665f82d77751be049ed79934681a238ba2
Author:     WANG Cong <xiyou.wangcong@gmail.com>
AuthorDate: Tue May 9 16:59:54 2017 -0700
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Thu Jun 29 19:32:33 2017 +0400

    ms/ipv6/dccp: do not inherit ipv6_mc_list from parent
    
    Like commit 657831ffc38e ("dccp/tcp: do not inherit mc_list from parent")
    we should clear ipv6_mc_list etc. for IPv6 sockets too.
    
    Cc: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
    Acked-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit 83eaddab4378db256d00d295bda6ca997cd13a52)
    
    Conflicts:
            net/dccp/ipv6.c
    
    https://jira.sw.ru/browse/PSBM-66671
    https://jira.sw.ru/browse/PSBM-66674
    
    fixes CVE-2017-9076 net: IPv6 DCCP implementation mishandles inheritance
    and CVE-2017-9077 net: tcp_v6_syn_recv_sock function mishandles inheritance
    
    Signed-off-by: Evgenii Shatokhin <eshatokhin@virtuozzo.com>
    Signed-off-by: Konstantin Khorenko <khorenko@virtuozzo.com>

diff --git a/net/dccp/ipv6.c b/net/dccp/ipv6.c
index b3f91c110974..34e362959646 100644
--- a/net/dccp/ipv6.c
+++ b/net/dccp/ipv6.c
@@ -488,6 +488,9 @@ static struct sock *dccp_v6_request_recv_sock(struct sock *sk,
 		newsk->sk_backlog_rcv = dccp_v4_do_rcv;
 		newnp->pktoptions  = NULL;
 		newnp->opt	   = NULL;
+		newnp->ipv6_mc_list = NULL;
+		newnp->ipv6_ac_list = NULL;
+		newnp->ipv6_fl_list = NULL;
 		newnp->mcast_oif   = inet6_iif(skb);
 		newnp->mcast_hops  = ipv6_hdr(skb)->hop_limit;
 
@@ -565,6 +568,10 @@ static struct sock *dccp_v6_request_recv_sock(struct sock *sk,
 	/* Clone RX bits */
 	newnp->rxopt.all = np->rxopt.all;
 
+	newnp->ipv6_mc_list = NULL;
+	newnp->ipv6_ac_list = NULL;
+	newnp->ipv6_fl_list = NULL;
+
 	/* Clone pktoptions received with SYN */
 	newnp->pktoptions = NULL;
 	if (ireq->pktopts != NULL) {
diff --git a/net/ipv6/tcp_ipv6.c b/net/ipv6/tcp_ipv6.c
index 038ca3e5b6cc..7d52a3a0c194 100644
--- a/net/ipv6/tcp_ipv6.c
+++ b/net/ipv6/tcp_ipv6.c
@@ -1089,6 +1089,7 @@ static struct sock *tcp_v6_syn_recv_sock(struct sock *sk, struct sk_buff *skb,
 		newtp->af_specific = &tcp_sock_ipv6_mapped_specific;
 #endif
 
+		newnp->ipv6_mc_list = NULL;
 		newnp->ipv6_ac_list = NULL;
 		newnp->ipv6_fl_list = NULL;
 		newnp->pktoptions  = NULL;
@@ -1158,6 +1159,7 @@ static struct sock *tcp_v6_syn_recv_sock(struct sock *sk, struct sk_buff *skb,
 	   First: no IPv4 options.
 	 */
 	newinet->inet_opt = NULL;
+	newnp->ipv6_mc_list = NULL;
 	newnp->ipv6_ac_list = NULL;
 	newnp->ipv6_fl_list = NULL;
 
