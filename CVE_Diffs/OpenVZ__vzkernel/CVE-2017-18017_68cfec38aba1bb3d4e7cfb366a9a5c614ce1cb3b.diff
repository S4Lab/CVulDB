OpenVZ__vzkernel
commit 68cfec38aba1bb3d4e7cfb366a9a5c614ce1cb3b
Author:     Eric Dumazet <edumazet@google.com>
AuthorDate: Mon Apr 3 10:55:11 2017 -0700
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Fri Jan 12 14:51:32 2018 +0300

    ms/netfilter: xt_TCPMSS: add more sanity tests on tcph->doff
    
    Denys provided an awesome KASAN report pointing to an use
    after free in xt_TCPMSS
    
    I have provided three patches to fix this issue, either in xt_TCPMSS or
    in xt_tcpudp.c. It seems xt_TCPMSS patch has the smallest possible
    impact.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Denys Fedoryshchenko <nuclearcat@nuclearcat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    
    (cherry picked from commit 2638fd0f92d4397884fd991d8f4925cb3f081901)
    
    CVE-2017-18017: kernel: netfilter: User-after-free in tcpmss_mangle_packet
    function in net/netfilter/xt_TCPMSS.c
    
    https://jira.sw.ru/browse/PSBM-80346
    
    Signed-off-by: Evgenii Shatokhin <eshatokhin@virtuozzo.com>

diff --git a/net/netfilter/xt_TCPMSS.c b/net/netfilter/xt_TCPMSS.c
index 666c5f3e8a90..f7e103ec9be5 100644
--- a/net/netfilter/xt_TCPMSS.c
+++ b/net/netfilter/xt_TCPMSS.c
@@ -104,7 +104,7 @@ tcpmss_mangle_packet(struct sk_buff *skb,
 	tcph = (struct tcphdr *)(skb_network_header(skb) + tcphoff);
 	tcp_hdrlen = tcph->doff * 4;
 
-	if (len < tcp_hdrlen)
+	if (len < tcp_hdrlen || tcp_hdrlen < sizeof(struct tcphdr))
 		return -1;
 
 	if (info->mss == XT_TCPMSS_CLAMP_PMTU) {
@@ -156,6 +156,10 @@ tcpmss_mangle_packet(struct sk_buff *skb,
 	if (len > tcp_hdrlen)
 		return 0;
 
+	/* tcph->doff has 4 bits, do not wrap it to 0 */
+	if (tcp_hdrlen >= 15 * 4)
+		return 0;
+
 	/*
 	 * MSS Option not found ?! add it..
 	 */
