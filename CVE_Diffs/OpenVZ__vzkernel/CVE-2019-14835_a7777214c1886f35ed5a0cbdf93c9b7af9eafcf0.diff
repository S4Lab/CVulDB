OpenVZ__vzkernel
commit a7777214c1886f35ed5a0cbdf93c9b7af9eafcf0
Author:     yongduan <yongduan@tencent.com>
AuthorDate: Wed Sep 11 17:44:24 2019 +0800
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Thu Sep 19 12:45:09 2019 +0300

    ms/vhost: make sure log_num < in_num
    
    The code assumes log_num < in_num everywhere, and that is true as long as
    in_num is incremented by descriptor iov count, and log_num by 1. However
    this breaks if there's a zero sized descriptor.
    
    As a result, if a malicious guest creates a vring desc with desc.len = 0,
    it may cause the host kernel to crash by overflowing the log array. This
    bug can be triggered during the VM migration.
    
    There's no need to log when desc.len = 0, so just don't increment log_num
    in this case.
    
    Fixes: 3a4d5c94e959 ("vhost_net: a kernel-level virtio server")
    Cc: stable@vger.kernel.org
    Reviewed-by: Lidong Chen <lidongchen@tencent.com>
    Signed-off-by: ruippan <ruippan@tencent.com>
    Signed-off-by: yongduan <yongduan@tencent.com>
    Acked-by: Michael S. Tsirkin <mst@redhat.com>
    Reviewed-by: Tyler Hicks <tyhicks@canonical.com>
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
    
    CVE-2019-14835 kernel: vhost-net: guest to host kernel escape during
    migration
    
    https://jira.sw.ru/browse/PSBM-97958
    
    https://access.redhat.com/security/vulnerabilities/kernel-vhost
    https://www.openwall.com/lists/oss-security/2019/09/17/1
    http://www.opennet.ru/opennews/art.shtml?num=51520
    
    (cherry picked from commit 060423bfdee3f8bc6e2c1bac97de24d5415e2bc4)
    Signed-off-by: Konstantin Khorenko <khorenko@virtuozzo.com>

diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.c
index 7f54402ff674..e6f3a4eb7724 100644
--- a/drivers/vhost/vhost.c
+++ b/drivers/vhost/vhost.c
@@ -1942,7 +1942,7 @@ static int get_indirect(struct vhost_virtqueue *vq,
 		/* If this is an input descriptor, increment that count. */
 		if (access == VHOST_ACCESS_WO) {
 			*in_num += ret;
-			if (unlikely(log)) {
+			if (unlikely(log && ret)) {
 				log[*log_num].addr = vhost64_to_cpu(vq, desc.addr);
 				log[*log_num].len = vhost32_to_cpu(vq, desc.len);
 				++*log_num;
@@ -2078,7 +2078,7 @@ int vhost_get_vq_desc(struct vhost_virtqueue *vq,
 			/* If this is an input descriptor,
 			 * increment that count. */
 			*in_num += ret;
-			if (unlikely(log)) {
+			if (unlikely(log && ret)) {
 				log[*log_num].addr = vhost64_to_cpu(vq, desc.addr);
 				log[*log_num].len = vhost32_to_cpu(vq, desc.len);
 				++*log_num;
