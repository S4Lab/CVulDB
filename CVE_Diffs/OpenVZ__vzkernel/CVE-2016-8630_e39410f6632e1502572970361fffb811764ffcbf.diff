OpenVZ__vzkernel
commit e39410f6632e1502572970361fffb811764ffcbf
Author:     Owen Hofmann <osh@google.com>
AuthorDate: Thu Oct 27 11:25:52 2016 -0700
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Mon Nov 28 18:38:37 2016 +0400

    ms/kvm: x86: Check memopp before dereference (CVE-2016-8630)
    
    Commit 41061cdb98 ("KVM: emulate: do not initialize memopp") removes a
    check for non-NULL under incorrect assumptions. An undefined instruction
    with a ModR/M byte with Mod=0 and R/M-5 (e.g. 0xc7 0x15) will attempt
    to dereference a null pointer here.
    
    Fixes: 41061cdb98a0bec464278b4db8e894a3121671f5
    Message-Id: <1477592752-126650-2-git-send-email-osh@google.com>
    Signed-off-by: Owen Hofmann <osh@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    
    https://bugzilla.redhat.com/show_bug.cgi?id=1393350
    
    Null pointer dereference that occurs during instruction decode in
    x86_decode_insn was found.
    
    Vulnerable code:
    
    emulate_instruction
     -> x86_emulate_instruction
      -> x86_decode_insn
         ...
         ctxt->memopp = NULL;
         ...
         rc = decode_operand(ctxt, , (ctxt->d >> SrcShift) & OpMask)
         rc = decode_operand(ctxt, , (ctxt->d >> Src2Shift) & OpMask)
         rc = decode_operand(ctxt, , (ctxt->d >> DstShift) & OpMask)
         if (ctxt->rip_relative)
            ctxt->memopp->addr.mem.ea = address_mask(ctxt,
                     ctxt->memopp->addr.mem.ea + ctxt->_eip);  <== NULL deref
    
    ms commit: d9092f52d7e61dd1557f2db2400ddb430e85937e

diff --git a/arch/x86/kvm/emulate.c b/arch/x86/kvm/emulate.c
index 7f2e20f28081..0e8f462d3f17 100644
--- a/arch/x86/kvm/emulate.c
+++ b/arch/x86/kvm/emulate.c
@@ -4934,7 +4934,7 @@ done_prefixes:
 	/* Decode and fetch the destination operand: register or memory. */
 	rc = decode_operand(ctxt, &ctxt->dst, (ctxt->d >> DstShift) & OpMask);
 
-	if (ctxt->rip_relative)
+	if (ctxt->rip_relative && likely(ctxt->memopp))
 		ctxt->memopp->addr.mem.ea = address_mask(ctxt,
 					ctxt->memopp->addr.mem.ea + ctxt->_eip);
 
