OpenVZ__vzkernel
commit 03d72317487bdba8b5efe736978fea9f4c6b125a
Author:     Andy Whitcroft <apw@canonical.com>
AuthorDate: Thu Mar 23 07:45:44 2017 +0000
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Thu Sep 27 17:26:41 2018 +0300

    ms/xfrm_user: validate XFRM_MSG_NEWAE incoming ESN size harder
    
    Kees Cook has pointed out that xfrm_replay_state_esn_len() is subject to
    wrapping issues.  To ensure we are correctly ensuring that the two ESN
    structures are the same size compare both the overall size as reported
    by xfrm_replay_state_esn_len() and the internal length are the same.
    
    CVE-2017-7184
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Steffen Klassert <steffen.klassert@secunet.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    
    (cherry picked from commit f843ee6dd019bcece3e74e76ad9df0155655d0df)
    
    https://jira.sw.ru/browse/PSBM-63199
    
    Signed-off-by: Konstantin Khorenko <khorenko@virtuozzo.com>

diff --git a/net/xfrm/xfrm_user.c b/net/xfrm/xfrm_user.c
index 56aab8fd0777..ecc90e55764a 100644
--- a/net/xfrm/xfrm_user.c
+++ b/net/xfrm/xfrm_user.c
@@ -397,9 +397,6 @@ static inline int xfrm_replay_verify_len(struct xfrm_replay_state_esn *replay_es
 	if (up->replay_window > up->bmp_len * sizeof(__u32) * 8)
 		return -EINVAL;
 
-	if (up->replay_window > up->bmp_len * sizeof(__u32) * 8)
-		return -EINVAL;
-
 	return 0;
 }
 
