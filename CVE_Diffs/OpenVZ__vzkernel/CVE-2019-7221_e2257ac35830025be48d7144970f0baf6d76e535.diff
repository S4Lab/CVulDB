OpenVZ__vzkernel
commit e2257ac35830025be48d7144970f0baf6d76e535
Author:     Peter Shier <pshier@google.com>
AuthorDate: Wed Apr 3 14:25:27 2019 +0300
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Wed Apr 3 14:37:34 2019 +0300

    ms/KVM: nVMX: unconditionally cancel preemption timer in free_nested (CVE-2019-7221)
    
    Bugzilla: 1671904
    
    There are multiple code paths where an hrtimer may have been started to
    emulate an L1 VMX preemption timer that can result in a call to free_nested
    without an intervening L2 exit where the hrtimer is normally
    cancelled. Unconditionally cancel in free_nested to cover all cases.
    
    Embargoed until Feb 7th 2019.
    
    Signed-off-by: Peter Shier <pshier@google.com>
    Reported-by: Jim Mattson <jmattson@google.com>
    Reviewed-by: Jim Mattson <jmattson@google.com>
    Reported-by: Felix Wilhelm <fwilhelm@google.com>
    Cc: stable@kernel.org
    Message-Id: <20181011184646.154065-1-pshier@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    
    Commit ecec76885bcfe3294685dc363fd1273df0d5d65f in the mainline kernel.
    In vzkernel vz7.85.x, the code of interest is in arch/x86/kvm/vmx.c,
    while the mainline has it in arch/x86/kvm/vmx/nested.c.
    
    https://jira.sw.ru/browse/PSBM-93359
    
    Signed-off-by: Evgenii Shatokhin <eshatokhin@virtuozzo.com>

diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index 197151e8832f..0fe9feefbe39 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -7330,6 +7330,7 @@ static void free_nested(struct vcpu_vmx *vmx)
 	if (!vmx->nested.vmxon && !vmx->nested.smm.vmxon)
 		return;
 
+	hrtimer_cancel(&vmx->nested.preemption_timer);
 	vmx->nested.vmxon = false;
 	vmx->nested.smm.vmxon = false;
 	free_vpid(vmx->nested.vpid02);
