OpenVZ__vzkernel
commit af4730807e4a634729a509474b3966f2313e6c32
Author:     Vasily Averin <vvs@virtuozzo.com>
AuthorDate: Fri Nov 25 17:26:48 2016 +0400
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Fri Nov 25 17:26:48 2016 +0400

    rh/trace/aio: NULL pointer dereference in trace_writeback_dirty_page()
    
    Fix for CVE-2016-3070:
    
    A security flaw was found in the Linux kernel that an attempt to move page
    mapped by AIO ring buffer to the other node triggers NULL pointer dereference
    at trace_writeback_dirty_page(), because aio_fs_backing_dev_info.dev is 0.
    
    The patch just adds the check to prevent crash in described situation.
    
    taken from RHEL7.3 kernel 2.6.32-514.el7
    
    https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-3070
    
    https://jira.sw.ru/browse/PSBM-55317
    
    Signed-off-by:  Vasily Averin <vvs@virtuozzo.com>

diff --git a/include/trace/events/writeback.h b/include/trace/events/writeback.h
index 5ecb4c234625..6ef3d6c150e6 100644
--- a/include/trace/events/writeback.h
+++ b/include/trace/events/writeback.h
@@ -49,7 +49,8 @@ TRACE_EVENT(writeback_dirty_page,
 
 	TP_fast_assign(
 		strncpy(__entry->name,
-			mapping ? dev_name(mapping->backing_dev_info->dev) : "(unknown)", 32);
+			mapping && mapping->backing_dev_info->dev
+			? dev_name(mapping->backing_dev_info->dev) : "(unknown)", 32);
 		__entry->ino = mapping ? mapping->host->i_ino : 0;
 		__entry->index = page->index;
 	),
