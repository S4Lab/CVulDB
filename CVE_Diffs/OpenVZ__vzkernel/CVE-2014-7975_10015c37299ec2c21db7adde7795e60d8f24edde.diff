OpenVZ__vzkernel
commit 10015c37299ec2c21db7adde7795e60d8f24edde
Author:     Pavel Tikhomirov <ptikhomirov@virtuozzo.com>
AuthorDate: Tue Mar 15 20:04:12 2016 +0400
Commit:     Vasily Averin <vvs@virtuozzo.com>
CommitDate: Tue Oct 22 11:12:24 2019 +0300

    ms/fs: Add a missing permission check to do_umount
    
    ms commit a1480dcc3c70 ("fs: Add a missing permission check to do_umount")
    
    Accessing do_remount_sb should require global CAP_SYS_ADMIN, but
    only one of the two call sites was appropriately protected.
    
    Fixes CVE-2014-7975.
    
    Signed-off-by: Andy Lutomirski <luto@amacapital.net>
    Signed-off-by: Pavel Tikhomirov <ptikhomirov@virtuozzo.com>
    
    Found during investigation of
    https://jira.sw.ru/browse/PSBM-43294
    
    Rebase to RHEL7.4 note: capable() -> ve_capable()

diff --git a/fs/namespace.c b/fs/namespace.c
index de386782586d..08de68c8aad6 100644
--- a/fs/namespace.c
+++ b/fs/namespace.c
@@ -1652,7 +1652,7 @@ static int do_umount(struct mount *mnt, int flags)
 		 * Special case for "unmounting" root ...
 		 * we just try to remount it readonly.
 		 */
-		if (!capable(CAP_SYS_ADMIN))
+		if (!ve_capable(CAP_SYS_ADMIN))
 			return -EPERM;
 		down_write(&sb->s_umount);
 		if (!(sb->s_flags & MS_RDONLY))
