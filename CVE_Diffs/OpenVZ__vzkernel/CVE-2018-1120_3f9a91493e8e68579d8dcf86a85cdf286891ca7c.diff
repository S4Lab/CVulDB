OpenVZ__vzkernel
commit 3f9a91493e8e68579d8dcf86a85cdf286891ca7c
Author:     Willy Tarreau <w@1wt.eu>
AuthorDate: Thu Jul 5 11:02:42 2018 +0300
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Wed Jun 5 13:42:46 2019 +0300

    ms/proc: do not access cmdline nor environ from file-backed areas
    
    This is a backport of ML commit 7f7ccc2ccc2e70c6054685f5e3522efa81556830.
    
    proc_pid_cmdline_read() and environ_read() directly access the target
    process' VM to retrieve the command line and environment. If this
    process remaps these areas onto a file via mmap(), the requesting
    process may experience various issues such as extra delays if the
    underlying device is slow to respond.
    
    Let's simply refuse to access file-backed areas in these functions.
    For this we add a new FOLL_ANON gup flag that is passed to all calls
    to access_remote_vm(). The code already takes care of such failures
    (including unmapped areas). Accesses via /proc/pid/mem were not
    changed though.
    
    This was assigned CVE-2018-1120.
    
    Note for stable backports: the patch may apply to kernels prior to 4.11
    but silently miss one location; it must be checked that no call to
    access_remote_vm() keeps zero as the last argument.
    
    Reported-by: Qualys Security Advisory <qsa@qualys.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Oleg Nesterov <oleg@redhat.com>
    Cc: stable@vger.kernel.org
    Signed-off-by: Willy Tarreau <w@1wt.eu>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    
    https://jira.sw.ru/browse/PSBM-86221
    
    Signed-off-by: Evgenii Shatokhin <eshatokhin@virtuozzo.com>
    Reviewed-by: Andrey Ryabinin <aryabinin@virtuozzo.com>
    
    ==========================================
    Patchset description:
    A user in the CT with support for FUSE can make some commands on the host
    hang if these commands read /proc/*/cmdline of the processes in that CT,
    e.g., ps aux. This is CVE-2018-1120
    
    The second patch of the series is a backport of the fix from mainline,
    7f7ccc2ccc2e ("proc: do not access cmdline nor environ from file-backed areas").
    
    That fix has prerequisites (mainline: https://lkml.org/lkml/2016/10/12/659),
    however, they are quite invasive. So, instead, a more lightweight
    approach is used in the first patch of this series. Unlike mainline, it
    provides get_user_pages_remote_flags() to keep other components using
    get_user_pages_remote() unchanged, it does not meddle with FOLL_FORCE either.

diff --git a/mm/gup.c b/mm/gup.c
index 66feba9c2921..5490a979424a 100644
--- a/mm/gup.c
+++ b/mm/gup.c
@@ -489,7 +489,8 @@ long __get_user_pages(struct task_struct *tsk, struct mm_struct *mm,
 
 		if (!vma ||
 		    (vma->vm_flags & (VM_IO | VM_PFNMAP)) ||
-		    !(vm_flags & vma->vm_flags))
+		    !(vm_flags & vma->vm_flags) ||
+		    ((gup_flags & FOLL_ANON) && !vma_is_anonymous(vma)))
 			return i ? : -EFAULT;
 
 		if (gup_flags & FOLL_ANON && !vma_is_anonymous(vma))
