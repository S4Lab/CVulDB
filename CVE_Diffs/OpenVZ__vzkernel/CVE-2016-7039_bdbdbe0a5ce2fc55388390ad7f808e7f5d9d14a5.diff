OpenVZ__vzkernel
commit bdbdbe0a5ce2fc55388390ad7f808e7f5d9d14a5
Author:     sd@queasysnail <sd@queasysnail>
AuthorDate: Tue Oct 11 16:24:32 2016 +0400
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Wed Jun 5 13:32:29 2019 +0300

    rh/net: add recursion limit to GRO
    
    This patch is taken from RHEL7 3.10.0-327.36.2.el7 kernel.
    https://rhn.redhat.com/errata/RHSA-2016-2047.html
    https://access.redhat.com/security/cve/CVE-2016-7039
    
    RHEL7 issue description:
    
    CVE-2016-7039 kernel: remotely triggerable unbounded recursion in the vlan gro
    code leading to a kernel crash
    
    * Linux kernel built with the 802.1Q/802.1ad VLAN(CONFIG_VLAN_8021Q) OR
    Virtual eXtensible Local Area Network(CONFIG_VXLAN) with Transparent
    Ethernet Bridging(TEB) GRO support, is vulnerable to a stack overflow
    issue. It could occur while receiving large packets via GRO path as an
    unlimited recursion could unfold in both VLAN and TEB modules leading to a
    stack corruption in the kernel. (CVE-2016-7039, Important)
    
    ============================================================================
    
    Patch description taken from upstream patch (not committed yet to ms kernel):
    http://seclists.org/oss-sec/2016/q4/91
    
    Currently, GRO can do unlimited recursion through the gro_receive
    handlers.  This was fixed for tunneling protocols by limiting tunnel GRO
    to one level with encap_mark, but both VLAN and TEB still have this
    problem.  Thus, the kernel is vulnerable to a stack overflow, if we
    receive a packet composed entirely of VLAN headers.
    
    This patch adds a recursion counter to the GRO layer to prevent stack
    overflow.  When a gro_receive function hits the recursion limit, GRO is
    aborted for this skb and it is processed normally.
    
    Fixes: 9b174d88c257 ("net: Add Transparent Ethernet Bridging GRO support.")
    Fixes: 66e5133f19e9 ("vlan: Add GRO support for non hardware accelerated vlan")
    Signed-off-by: Sabrina Dubroca <sd@queasysnail net>
    Reviewed-by: Jiri Benc <jbenc@redhat com>
    Acked-by: Hannes Frederic Sowa <hannes@stressinduktion org>
    
    Patch has been extracted from RHEL7 kernel by
            Evgenii Shatokhin <eshatokhin@virtuozzo.com>
    
    https://jira.sw.ru/browse/PSBM-53507

diff --git a/net/core/dev.c b/net/core/dev.c
index 04cfe72a1d2b..6d3b32befb9c 100644
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -4504,6 +4504,7 @@ static enum gro_result dev_gro_receive(struct napi_struct *napi, struct sk_buff
 		NAPI_GRO_CB(skb)->recursion_counter = 0;
 		NAPI_GRO_CB(skb)->is_atomic = 1;
 		NAPI_GRO_CB(skb)->gro_remcsum_start = 0;
+		NAPI_GRO_CB(skb)->recursion_counter = 0;
 
 		/* Setup for GRO checksum validation */
 		switch (skb->ip_summed) {
