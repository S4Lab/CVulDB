OpenVZ__vzkernel
commit 9f694ba874bf276f626181128872d70e76435b53
Author:     Jim Mattson <jmattson@google.com>
AuthorDate: Mon Sep 18 17:07:53 2017 +0300
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Wed Dec 13 12:48:15 2017 +0300

    ms/kvm: nVMX: Don't allow L2 to access the hardware CR8
    
    If L1 does not specify the "use TPR shadow" VM-execution control in
    vmcs12, then L0 must specify the "CR8-load exiting" and "CR8-store
    exiting" VM-execution controls in vmcs02. Failure to do so will give
    the L2 VM unrestricted read/write access to the hardware CR8.
    
    This fixes CVE-2017-12154.
    
    Signed-off-by: Jim Mattson <jmattson@google.com>
    Reviewed-by: David Hildenbrand <david@redhat.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    
    (cherry picked from commit 51aa68e7d57e3217192d88ce90fd5b8ef29ec94f)
    
    CVE-2017-12154 Kernel: kvm: nVMX: L2 guest could access hardware(L0) CR8
    register
    
    https://jira.sw.ru/browse/PSBM-72332
    https://bugzilla.redhat.com/show_bug.cgi?id=1491224
    https://www.spinics.net/lists/kvm/msg155414.html
    
    Signed-off-by: Denis Plotnikov <dplotnikov@virtuozzo.com>

diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index 09b18518933f..534b561bff07 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -9689,6 +9689,11 @@ static int prepare_vmcs02(struct kvm_vcpu *vcpu, struct vmcs12 *vmcs12,
 		vmcs_write64(VIRTUAL_APIC_PAGE_ADDR,
 				page_to_phys(vmx->nested.virtual_apic_page));
 		vmcs_write32(TPR_THRESHOLD, vmcs12->tpr_threshold);
+	} else {
+#ifdef CONFIG_X86_64
+		exec_control |= CPU_BASED_CR8_LOAD_EXITING |
+				CPU_BASED_CR8_STORE_EXITING;
+#endif
 	}
 
 	if (cpu_has_vmx_msr_bitmap() &&
