OpenVZ__vzkernel
commit f299d5aa283f7659e83f9675bad3ca05272ef794
Author:     Scott Bauer <sbauer@plzdonthack.me>
AuthorDate: Fri Nov 25 17:26:47 2016 +0400
Commit:     Konstantin Khorenko <khorenko@virtuozzo.com>
CommitDate: Fri Nov 25 17:26:47 2016 +0400

    ms/hiddev: validate num_values for HIDIOCGUSAGES, HIDIOCSUSAGES commands
    
        This patch validates the num_values parameter from userland during the
        HIDIOCGUSAGES and HIDIOCSUSAGES commands. Previously, if the report id was set
        to HID_REPORT_ID_UNKNOWN, we would fail to validate the num_values parameter
        leading to a heap overflow.
    
        Cc: stable@vger.kernel.org
        Signed-off-by: Scott Bauer <sbauer@plzdonthack.me>
        Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    
    ms commit: 93a2001bd (HID: hiddev: validate num_values for HIDIOCGUSAGES,
    HIDIOCSUSAGES commands)
    
    Fixes CVE-2016-5829:
    A heap-based buffer overflow vulnerability was found in the Linux kernel's
    hiddev driver. This flaw could allow a local attacker to corrupt kernel memory,
    possible privilege escalation or crashing the system.
    
    https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-5829
    
    https://jira.sw.ru/browse/PSBM-55317
    
    Signed-off-by:  Vasily Averin <vvs@virtuozzo.com>

diff --git a/drivers/hid/usbhid/hiddev.c b/drivers/hid/usbhid/hiddev.c
index 2f1ddca6f2e0..700145b15088 100644
--- a/drivers/hid/usbhid/hiddev.c
+++ b/drivers/hid/usbhid/hiddev.c
@@ -516,13 +516,13 @@ static noinline int hiddev_ioctl_usage(struct hiddev *hiddev, unsigned int cmd,
 					goto inval;
 			} else if (uref->usage_index >= field->report_count)
 				goto inval;
-
-			else if ((cmd == HIDIOCGUSAGES || cmd == HIDIOCSUSAGES) &&
-				 (uref_multi->num_values > HID_MAX_MULTI_USAGES ||
-				  uref->usage_index + uref_multi->num_values > field->report_count))
-				goto inval;
 		}
 
+		if ((cmd == HIDIOCGUSAGES || cmd == HIDIOCSUSAGES) &&
+		    (uref_multi->num_values > HID_MAX_MULTI_USAGES ||
+		     uref->usage_index + uref_multi->num_values > field->report_count))
+			goto inval;
+
 		switch (cmd) {
 		case HIDIOCGUSAGE:
 			uref->value = field->value[uref->usage_index];
