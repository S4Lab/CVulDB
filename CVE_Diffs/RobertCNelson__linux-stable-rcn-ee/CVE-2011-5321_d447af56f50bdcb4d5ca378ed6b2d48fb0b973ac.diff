RobertCNelson__linux-stable-rcn-ee
commit d447af56f50bdcb4d5ca378ed6b2d48fb0b973ac
Author:     Jiri Slaby <jslaby@suse.cz>
AuthorDate: Wed Oct 12 11:32:42 2011 +0200
Commit:     Willy Tarreau <w@1wt.eu>
CommitDate: Fri Sep 18 13:51:52 2015 +0200

    TTY: drop driver reference in tty_open fail path
    
    commit c290f8358acaeffd8e0c551ddcc24d1206143376 upstream.
    
    When tty_driver_lookup_tty fails in tty_open, we forget to drop a
    reference to the tty driver. This was added by commit 4a2b5fddd5 (Move
    tty lookup/reopen to caller).
    
    Fix that by adding tty_driver_kref_put to the fail path.
    
    I will refactor the code later. This is for the ease of backporting to
    stable.
    
    Introduced-in: v2.6.28-rc2
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>
    Cc: Alan Cox <alan@lxorguk.ukuu.org.uk>
    Acked-by: Sukadev Bhattiprolu <sukadev@linux.vnet.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    [bwh: Backported to 2.6.32: adjust filename]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    
    CVE-2011-5321
    
    Signed-off-by: Willy Tarreau <w@1wt.eu>

diff --git a/drivers/char/tty_io.c b/drivers/char/tty_io.c
index cbdd1698c07b..6c7153438514 100644
--- a/drivers/char/tty_io.c
+++ b/drivers/char/tty_io.c
@@ -1779,6 +1779,7 @@ static int __tty_open(struct inode *inode, struct file *filp)
 
 		if (IS_ERR(tty)) {
 			mutex_unlock(&tty_mutex);
+			tty_driver_kref_put(driver);
 			return PTR_ERR(tty);
 		}
 	}
