01org__qemu-lite
commit e1c120a9c54872f8a538ff9129d928de4e865cbd
Author:     Stefan Hajnoczi <stefanha@redhat.com>
AuthorDate: Wed Jul 15 14:30:37 2015 +0100
Commit:     Stefan Hajnoczi <stefanha@redhat.com>
CommitDate: Mon Aug 3 13:08:00 2015 +0100

    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    
    Transmit offload features access Ethernet and IP headers the packet.  If
    the packet is too short we must not attempt to access header fields:
    
      int proto = be16_to_cpu(*(uint16_t *)(saved_buffer + 12));
      ...
      eth_payload_data = saved_buffer + ETH_HLEN;
      ...
      ip = (ip_header*)eth_payload_data;
      if (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) {
    
    Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
    Reviewed-by: Jason Wang <jasowang@redhat.com>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>

diff --git a/hw/net/rtl8139.c b/hw/net/rtl8139.c
index db36b65249..1c620763d8 100644
--- a/hw/net/rtl8139.c
+++ b/hw/net/rtl8139.c
@@ -2150,6 +2150,11 @@ static int rtl8139_cplus_transmit_one(RTL8139State *s)
         {
             DPRINTF("+++ C+ mode offloaded task checksum\n");
 
+            /* Large enough for Ethernet and IP headers? */
+            if (saved_size < ETH_HLEN + sizeof(ip_header)) {
+                goto skip_offload;
+            }
+
             /* ip packet header */
             ip_header *ip = NULL;
             int hlen = 0;
