01org__qemu-lite
commit 1ba1f2e319afdcb485963cd3f426fdffd1b725f2
Author:     Paolo Bonzini <pbonzini@redhat.com>
AuthorDate: Fri Dec 23 15:39:03 2011 +0100
Commit:     Anthony Liguori <aliguori@us.ibm.com>
CommitDate: Fri Jan 13 10:20:51 2012 -0600

    virtio-blk: refuse SG_IO requests with scsi=off
    
    QEMU does have a "scsi" option (to be used like -device
    virtio-blk-pci,drive=foo,scsi=off).  However, it only
    masks the feature bit, and does not reject the command
    if a malicious guest disregards the feature bits and
    issues a request.
    
    Without this patch, using scsi=off does not protect you
    from CVE-2011-4127.
    
    Reviewed-by: Stefan Hajnoczi <stefanha@linux.vnet.ibm.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Anthony Liguori <aliguori@us.ibm.com>

diff --git a/hw/virtio-blk.c b/hw/virtio-blk.c
index 5e81f53e14..5b416c36ee 100644
--- a/hw/virtio-blk.c
+++ b/hw/virtio-blk.c
@@ -153,6 +153,12 @@ static void virtio_blk_handle_scsi(VirtIOBlockReq *req)
     int status;
     int i;
 
+    if ((req->dev->vdev.guest_features & (1 << VIRTIO_BLK_F_SCSI)) == 0) {
+        virtio_blk_req_complete(req, VIRTIO_BLK_S_UNSUPP);
+        g_free(req);
+        return;
+    }
+
     /*
      * We require at least one output segment each for the virtio_blk_outhdr
      * and the SCSI command block.
