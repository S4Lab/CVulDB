bfabiszewski__libmobi
commit b5657d7e2357782147a80a4d63a4b5fb7c05305f
Author:     Bartek Fabiszewski <github@fabiszewski.net>
AuthorDate: Wed Jun 20 12:08:32 2018 +0200
Commit:     Bartek Fabiszewski <github@fabiszewski.net>
CommitDate: Wed Jun 20 12:08:32 2018 +0200

    Fix: buffer overflow (CVE-2018-11724)

diff --git a/src/util.c b/src/util.c
index f874404..0fc370a 100644
--- a/src/util.c
+++ b/src/util.c
@@ -1717,6 +1717,12 @@ static MOBI_RET mobi_decompress_content(const MOBIData *m, char *text, FILE *fil
                 }
             }
             const size_t decrypt_size = curr->size - extra_size;
+            if (decrypt_size > decompressed_size) {
+                debug_print("Record too large: %zu\n", decrypt_size);
+                mobi_free_huffcdic(huffcdic);
+                free(decompressed);
+                return MOBI_DATA_CORRUPT;
+            }
             if (decrypt_size) {
                 ret = mobi_drm_decrypt_buffer(decompressed, curr->data, decrypt_size, m);
                 if (ret != MOBI_SUCCESS) {
