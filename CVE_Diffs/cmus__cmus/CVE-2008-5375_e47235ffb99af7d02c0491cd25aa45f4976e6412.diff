cmus__cmus
commit e47235ffb99af7d02c0491cd25aa45f4976e6412
Author:     Johannes Wei√ül <jargon@molb.org>
AuthorDate: Tue Mar 9 21:16:53 2010 +0100
Commit:     Gregory Petrosyan <gregory.petrosyan@gmail.com>
CommitDate: Wed Mar 10 00:16:19 2010 +0300

    replace insecure use of /tmp in cmus
    
    cmus shouldn't write to predictable files in /tmp, although not running
    as root.
    /tmp/cmus-debug is now in $CMUS_HOME/cmus-debug.txt or, if CMUS_HOME
    is not set, $HOME/cmus-debug.txt. This way it is also possible to debug
    multiple versions of cmus at the same time.
    
    Debian Bug report #509277
    CVE-2008-5375: insecure temp file handling

diff --git a/Doc/cmus-remote.txt b/Doc/cmus-remote.txt
index 5b0bc0d..2db8dea 100644
--- a/Doc/cmus-remote.txt
+++ b/Doc/cmus-remote.txt
@@ -27,7 +27,7 @@ When *-C* is given all command line arguments are treated as raw commands.
 @h1 OPTIONS
 
 --server SOCKET
-	Connect using socket *SOCKET* instead of `/tmp/cmus-$USER`.
+	Connect using socket *SOCKET* instead of `~/.cmus/socket`.
 
 --help
 	Display usage information and exit.
diff --git a/Doc/cmus.txt b/Doc/cmus.txt
index d6e706c..50770c3 100644
--- a/Doc/cmus.txt
+++ b/Doc/cmus.txt
@@ -19,7 +19,7 @@ it can be controlled from the outside via *cmus-remote*(1).
 @h1 OPTIONS
 
 --listen ADDR
-	Listen to ADDR (UNIX socket) instead of `/tmp/cmus-$USER`.
+	Listen to ADDR (UNIX socket) instead of `~/.cmus/socket`.
 	ADDR is either a UNIX socket or host[:port].
 
 	*WARNING*: Using host[:port] is insecure even with password!
@@ -1126,7 +1126,7 @@ found in `/usr/share/doc/cmus/examples`.
 
 @h1 BUGS
 
-After a crash last lines of `/tmp/cmus-debug` (or $TMPDIR/cmus-debug) might
+After a crash last lines of `~/cmus-debug.txt` might
 contain useful information.  The file exists only if you configured cmus with
 maximum debug level (*./configure DEBUG=2*).
 
diff --git a/README b/README
index 911a08b..a025738 100644
--- a/README
+++ b/README
@@ -57,7 +57,7 @@ Installation
 
 Or to install to a temporary directory:
 
-  $ make install DESTDIR=/tmp/cmus
+  $ make install DESTDIR=~/tmp/cmus
 
 This is useful when creating binary packages.
 
@@ -89,10 +89,9 @@ form non-subscribed users).  Traffic of the list is low.
 Reporting Bugs
 --------------
 
-After a crash send bug report with last lines of /tmp/cmus-debug (or
-$TMPDIR/cmus-debug) to cmus-devel@lists.sourceforge.net.  The file
-exists only if you configured cmus with maximum debug level
-(./configure DEBUG=2).
+After a crash send bug report with last lines of ~/cmus-debug.txt to
+cmus-devel@lists.sourceforge.net.  The file exists only if you
+configured cmus with maximum debug level (./configure DEBUG=2).
 
 
 Git Repository
diff --git a/cmus-status-display b/cmus-status-display
index 12b8977..bfa5a90 100755
--- a/cmus-status-display
+++ b/cmus-status-display
@@ -18,8 +18,8 @@
 
 output()
 {
-	# write status to /tmp/cmus-status (not very useful though)
-	echo "$*" >> /tmp/cmus-status 2>&1
+	# write status to ~/cmus-status.txt (not very useful though)
+	echo "$*" >> ~/cmus-status.txt 2>&1
 
 	# WMI (http://wmi.modprobe.de/)
 	#wmiremote -t "$*" &> /dev/null
diff --git a/debug.c b/debug.c
index 89fb7ef..6ab501c 100644
--- a/debug.c
+++ b/debug.c
@@ -18,12 +18,15 @@ void debug_init(void)
 {
 #if DEBUG > 1
 	char filename[512];
-	const char *tmp = getenv("TMPDIR");
+	const char *dir = getenv("CMUS_HOME");
 
-	if (!tmp || !tmp[0])
-		tmp = "/tmp";
+	if (!dir || !dir[0]) {
+		dir = getenv("HOME");
+		if (!dir)
+			die("error: environment variable HOME not set\n");
+	}
+	snprintf(filename, sizeof(filename), "%s/cmus-debug.txt", dir);
 
-	snprintf(filename, sizeof(filename), "%s/cmus-debug", tmp);
 	debug_stream = fopen(filename, "w");
 	if (debug_stream == NULL)
 		die_errno("error opening `%s' for writing", filename);
