vyos__vyatta-quagga
commit 26957ff2f752ee9b3df2ce12cd1c9c95337f8cc2
Author:     Susheela Vaidya <susheela@debiansv.vyatta.com>
AuthorDate: Mon Jun 18 14:56:03 2012 -0700
Commit:     Susheela Vaidya <susheela@debiansv.vyatta.com>
CommitDate: Mon Jun 18 14:56:03 2012 -0700

    Bug 8149 - Patch for CVE-2012-1820

diff --git a/bgpd/bgp_open.c b/bgpd/bgp_open.c
index 37595817..fa670d08 100644
--- a/bgpd/bgp_open.c
+++ b/bgpd/bgp_open.c
@@ -244,7 +244,7 @@ bgp_capability_orf_entry (struct peer *peer, struct capability_header *hdr)
     }
   
   /* validate number field */
-  if (sizeof (struct capability_orf_entry) + (entry.num * 2) > hdr->length)
+  if (sizeof (struct capability_orf_entry) + (entry.num * 2) != hdr->length)
     {
       zlog_info ("%s ORF Capability entry length error,"
                  " Cap length %u, num %u",
@@ -347,28 +347,6 @@ bgp_capability_orf_entry (struct peer *peer, struct capability_header *hdr)
   return 0;
 }
 
-static int
-bgp_capability_orf (struct peer *peer, struct capability_header *hdr)
-{
-  struct stream *s = BGP_INPUT (peer);
-  size_t end = stream_get_getp (s) + hdr->length;
-  
-  assert (stream_get_getp(s) + sizeof(struct capability_orf_entry) <= end);
-  
-  /* We must have at least one ORF entry, as the caller has already done
-   * minimum length validation for the capability code - for ORF there must
-   * at least one ORF entry (header and unknown number of pairs of bytes).
-   */
-  do
-    {
-      if (bgp_capability_orf_entry (peer, hdr) == -1)
-        return -1;
-    } 
-  while (stream_get_getp(s) + sizeof(struct capability_orf_entry) < end);
-  
-  return 0;
-}
-
 static int
 bgp_capability_restart (struct peer *peer, struct capability_header *caphdr)
 {
@@ -573,7 +551,7 @@ bgp_capability_parse (struct peer *peer, size_t length, u_char **error)
             break;
           case CAPABILITY_CODE_ORF:
           case CAPABILITY_CODE_ORF_OLD:
-            if (bgp_capability_orf (peer, &caphdr))
+            if (bgp_capability_orf_entry (peer, &caphdr))
               return -1;
             break;
           case CAPABILITY_CODE_RESTART:
