openbsd__xenocara
commit 2f2a50b99bf3baea2b1c9a9dda433094a8c94157
Author:     matthieu <matthieu@openbsd.org>
AuthorDate: Sat Oct 14 09:06:06 2017 +0000
Commit:     matthieu <matthieu@openbsd.org>
CommitDate: Sat Oct 14 09:06:06 2017 +0000

    MFC: Xext/shm: Validate shmseg resource id (CVE-2017-13721)
    
    Otherwise it can belong to a non-existing client and abort X server with
    FatalError "client not in use", or overwrite existing segment of another
    existing client.

diff --git a/xserver/Xext/shm.c b/xserver/Xext/shm.c
index a57356d4b..3201e8d71 100644
--- a/xserver/Xext/shm.c
+++ b/xserver/Xext/shm.c
@@ -1238,6 +1238,7 @@ ProcShmCreateSegment(ClientPtr client)
     };
 
     REQUEST_SIZE_MATCH(xShmCreateSegmentReq);
+    LEGAL_NEW_RESOURCE(stuff->shmseg, client);
     if ((stuff->readOnly != xTrue) && (stuff->readOnly != xFalse)) {
         client->errorValue = stuff->readOnly;
         return BadValue;
