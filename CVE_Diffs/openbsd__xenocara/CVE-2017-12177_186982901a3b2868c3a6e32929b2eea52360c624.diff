openbsd__xenocara
commit 186982901a3b2868c3a6e32929b2eea52360c624
Author:     matthieu <matthieu@openbsd.org>
AuthorDate: Sat Oct 14 09:33:48 2017 +0000
Commit:     matthieu <matthieu@openbsd.org>
CommitDate: Sat Oct 14 09:33:48 2017 +0000

    MFC: dbe: Unvalidated variable-length request in
    ProcDbeGetVisualInfo (CVE-2017-12177)
    
    v2: Protect against integer overflow (Alan Coopersmith)

diff --git a/xserver/dbe/dbe.c b/xserver/dbe/dbe.c
index 23f7e164d..f31766f31 100644
--- a/xserver/dbe/dbe.c
+++ b/xserver/dbe/dbe.c
@@ -574,6 +574,9 @@ ProcDbeGetVisualInfo(ClientPtr client)
     XdbeScreenVisualInfo *pScrVisInfo;
 
     REQUEST_AT_LEAST_SIZE(xDbeGetVisualInfoReq);
+    if (stuff->n > UINT32_MAX / sizeof(CARD32))
+        return BadLength;
+    REQUEST_FIXED_SIZE(xDbeGetVisualInfoReq, stuff->n * sizeof(CARD32));
 
     if (stuff->n > UINT32_MAX / sizeof(DrawablePtr))
         return BadAlloc;
@@ -924,7 +927,7 @@ SProcDbeSwapBuffers(ClientPtr client)
 
     swapl(&stuff->n);
     if (stuff->n > UINT32_MAX / sizeof(DbeSwapInfoRec))
-        return BadAlloc;
+        return BadLength;
     REQUEST_FIXED_SIZE(xDbeSwapBuffersReq, stuff->n * sizeof(xDbeSwapInfo));
 
     if (stuff->n != 0) {
