openbsd__xenocara
commit dadc83bba7277a7da872cf61808f3a8600a5a220
Author:     matthieu <matthieu@openbsd.org>
AuthorDate: Sat Oct 14 09:02:08 2017 +0000
Commit:     matthieu <matthieu@openbsd.org>
CommitDate: Sat Oct 14 09:02:08 2017 +0000

    MFC: Check for end of string in PatternMatch (CVE-2017-13720)
    
    If a pattern contains '?' character, any character in the string is skipped,
    even if it is '\0'. The rest of the matching then reads invalid memory.

diff --git a/lib/libXfont/src/fontfile/fontdir.c b/lib/libXfont/src/fontfile/fontdir.c
index 7271603ec..511c96f3f 100644
--- a/lib/libXfont/src/fontfile/fontdir.c
+++ b/lib/libXfont/src/fontfile/fontdir.c
@@ -399,8 +399,10 @@ PatternMatch(char *pat, int patdashes, char *string, int stringdashes)
 		}
 	    }
 	case '?':
-	    if (*string++ == XK_minus)
+	    if ((t = *string++) == XK_minus)
 		stringdashes--;
+	    if (!t)
+		return 0;
 	    break;
 	case '\0':
 	    return (*string == '\0');
