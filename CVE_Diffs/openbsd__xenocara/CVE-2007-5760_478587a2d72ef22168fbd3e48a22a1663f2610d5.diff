openbsd__xenocara
commit 478587a2d72ef22168fbd3e48a22a1663f2610d5
Author:     matthieu <matthieu@openbsd.org>
AuthorDate: Thu Jan 17 15:41:18 2008 +0000
Commit:     matthieu <matthieu@openbsd.org>
CommitDate: Thu Jan 17 15:41:18 2008 +0000

    Fix from X.Org for CVE-2007-5760 - XFree86 Misc extension out of
    bounds array index.

diff --git a/xserver/hw/xfree86/common/xf86MiscExt.c b/xserver/hw/xfree86/common/xf86MiscExt.c
index c1b9c60fc..40c196a3e 100644
--- a/xserver/hw/xfree86/common/xf86MiscExt.c
+++ b/xserver/hw/xfree86/common/xf86MiscExt.c
@@ -548,6 +548,10 @@ MiscExtPassMessage(int scrnIndex, const char *msgtype, const char *msgval,
 {
     ScrnInfoPtr pScr = xf86Screens[scrnIndex];
 
+    /* should check this in the protocol, but xf86NumScreens isn't exported */
+    if (scrnIndex >= xf86NumScreens)
+	return BadValue;
+
     if (*pScr->HandleMessage == NULL)
 	    return BadImplementation;
     return (*pScr->HandleMessage)(scrnIndex, msgtype, msgval, retstr);
