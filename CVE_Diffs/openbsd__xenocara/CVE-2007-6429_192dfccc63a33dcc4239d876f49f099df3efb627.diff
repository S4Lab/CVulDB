openbsd__xenocara
commit 192dfccc63a33dcc4239d876f49f099df3efb627
Author:     matthieu <matthieu@openbsd.org>
AuthorDate: Mon Jan 21 21:38:22 2008 +0000
Commit:     matthieu <matthieu@openbsd.org>
CommitDate: Mon Jan 21 21:38:22 2008 +0000

    3rd try... CVE-2007-6429: Always test for size+offset wrapping. From X.Org.

diff --git a/xserver/Xext/shm.c b/xserver/Xext/shm.c
index 6f99e9064..376f12348 100644
--- a/xserver/Xext/shm.c
+++ b/xserver/Xext/shm.c
@@ -753,10 +753,10 @@ CreatePmap:
     if (sizeof(size) == 4 && BitsPerPixel(depth) > 8) {
         if (size < width * height)
             return BadAlloc;
-        /* thankfully, offset is unsigned */
-        if (stuff->offset + size < size)
-            return BadAlloc;
     }
+    /* thankfully, offset is unsigned */
+    if (stuff->offset + size < size)
+	return BadAlloc;
 
     VERIFY_SHMSIZE(shmdesc, stuff->offset, size, client);
 
@@ -1098,10 +1098,10 @@ CreatePmap:
     if (sizeof(size) == 4 && BitsPerPixel(depth) > 8) {
 	if (size < width * height)
 	    return BadAlloc;
-	/* thankfully, offset is unsigned */
-	if (stuff->offset + size < size)
-	    return BadAlloc;
     }
+    /* thankfully, offset is unsigned */
+    if (stuff->offset + size < size)
+	return BadAlloc;
 
     VERIFY_SHMSIZE(shmdesc, stuff->offset, size, client);
     pMap = (*shmFuncs[pDraw->pScreen->myNum]->CreatePixmap)(
