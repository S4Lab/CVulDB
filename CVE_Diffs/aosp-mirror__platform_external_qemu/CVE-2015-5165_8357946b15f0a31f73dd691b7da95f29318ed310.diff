aosp-mirror__platform_external_qemu
commit 8357946b15f0a31f73dd691b7da95f29318ed310
Author:     Stefan Hajnoczi <stefanha@redhat.com>
AuthorDate: Wed Jul 15 17:39:29 2015 +0100
Commit:     Stefan Hajnoczi <stefanha@redhat.com>
CommitDate: Mon Aug 3 13:08:10 2015 +0100

    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    
    The TCP Data Offset field contains the length of the header.  Make sure
    it is valid and does not exceed the IP data length.
    
    Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
    Reviewed-by: Jason Wang <jasowang@redhat.com>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>

diff --git a/hw/net/rtl8139.c b/hw/net/rtl8139.c
index fa0193403e..edbb61ccf3 100644
--- a/hw/net/rtl8139.c
+++ b/hw/net/rtl8139.c
@@ -2239,6 +2239,11 @@ static int rtl8139_cplus_transmit_one(RTL8139State *s)
 
                 int tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);
 
+                /* Invalid TCP data offset? */
+                if (tcp_hlen < sizeof(tcp_header) || tcp_hlen > ip_data_len) {
+                    goto skip_offload;
+                }
+
                 /* ETH_MTU = ip header len + tcp header len + payload */
                 int tcp_data_len = ip_data_len - tcp_hlen;
                 int tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;
