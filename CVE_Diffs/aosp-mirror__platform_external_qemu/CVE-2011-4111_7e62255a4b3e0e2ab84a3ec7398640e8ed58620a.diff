aosp-mirror__platform_external_qemu
commit 7e62255a4b3e0e2ab84a3ec7398640e8ed58620a
Author:     Markus Armbruster <armbru@redhat.com>
AuthorDate: Mon Nov 28 20:27:37 2011 +0100
Commit:     Anthony Liguori <aliguori@us.ibm.com>
CommitDate: Mon Nov 28 16:20:53 2011 -0600

    ccid: Fix buffer overrun in handling of VSC_ATR message
    
    ATR size exceeding the limit is diagnosed, but then we merrily use it
    anyway, overrunning card->atr[].
    
    The message is read from a character device.  Obvious security
    implications unless the other end of the character device is trusted.
    
    Spotted by Coverity.  CVE-2011-4111.
    
    Signed-off-by: Markus Armbruster <armbru@redhat.com>
    Signed-off-by: Anthony Liguori <aliguori@us.ibm.com>

diff --git a/hw/ccid-card-passthru.c b/hw/ccid-card-passthru.c
index 2cbc81b9f4..9f51c6cb05 100644
--- a/hw/ccid-card-passthru.c
+++ b/hw/ccid-card-passthru.c
@@ -150,6 +150,7 @@ static void ccid_card_vscard_handle_message(PassthruState *card,
             error_report("ATR size exceeds spec, ignoring");
             ccid_card_vscard_send_error(card, scr_msg_header->reader_id,
                                         VSC_GENERAL_ERROR);
+            break;
         }
         memcpy(card->atr, data, scr_msg_header->length);
         card->atr_length = scr_msg_header->length;
