aosp-mirror__platform_external_qemu
commit c52d46e041b42bb1ee6f692e00a0abe37a9659f6
Author:     Gerd Hoffmann <kraxel@redhat.com>
AuthorDate: Mon Dec 3 11:10:45 2018 +0100
Commit:     Gerd Hoffmann <kraxel@redhat.com>
CommitDate: Mon Dec 3 19:40:17 2018 +0100

    usb-mtp: outlaw slashes in filenames
    
    Slash is unix directory separator, so they are not allowed in filenames.
    Note this also stops the classic escape via "../".
    
    Fixes: CVE-2018-16867
    Reported-by: Michael Hanselmann <public@hansmi.ch>
    Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>
    Reviewed-by: Philippe Mathieu-Daud√© <philmd@redhat.com>
    Message-id: 20181203101045.27976-3-kraxel@redhat.com

diff --git a/hw/usb/dev-mtp.c b/hw/usb/dev-mtp.c
index 0f6a9702ef..100b7171f4 100644
--- a/hw/usb/dev-mtp.c
+++ b/hw/usb/dev-mtp.c
@@ -1719,6 +1719,12 @@ static void usb_mtp_write_metadata(MTPState *s)
 
     filename = utf16_to_str(dataset->length, dataset->filename);
 
+    if (strchr(filename, '/')) {
+        usb_mtp_queue_result(s, RES_PARAMETER_NOT_SUPPORTED, d->trans,
+                             0, 0, 0, 0);
+        return;
+    }
+
     o = usb_mtp_object_lookup_name(p, filename, dataset->length);
     if (o != NULL) {
         next_handle = o->handle;
