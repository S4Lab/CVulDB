xen-project__xen
commit 830a1b9c82d7dd4c4dd62c01ffb4e10251bc275a
Author:     Ian Campbell <ian.campbell@citrix.com>
AuthorDate: Wed Jan 23 11:52:44 2013 +0100
Commit:     Ian Campbell <ian.campbell@citrix.com>
CommitDate: Wed Jan 23 11:52:44 2013 +0100

    xen: Do not allow guests to enable nested HVM on themselves
    
    There is no reason for this and doing so exposes a memory leak to
    guests. Only toolstacks need write access to this HVM param.
    
    This is XSA-35 / CVE-2013-0152.
    
    Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
    Acked-by: Jan Beulich <JBeulich@suse.com>
    xen-unstable changeset: 26444:621b1a889e9b
    xen-unstable date: Wed Jan 23 10:47:24 UTC 2013

diff --git a/xen/arch/x86/hvm/hvm.c b/xen/arch/x86/hvm/hvm.c
index adbe079390..2d4acb1ef0 100644
--- a/xen/arch/x86/hvm/hvm.c
+++ b/xen/arch/x86/hvm/hvm.c
@@ -3862,6 +3862,11 @@ long do_hvm_op(unsigned long op, XEN_GUEST_HANDLE(void) arg)
                     rc = -EINVAL;
                 break;
             case HVM_PARAM_NESTEDHVM:
+                if ( !IS_PRIV(current->domain) )
+                {
+                    rc = -EPERM;
+                    break;
+                }
 #ifdef __i386__
                 if ( a.value )
                     rc = -EINVAL;
