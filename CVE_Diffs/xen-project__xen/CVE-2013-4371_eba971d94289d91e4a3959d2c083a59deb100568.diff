xen-project__xen
commit eba971d94289d91e4a3959d2c083a59deb100568
Author:     Matthew Daley <mattjd@gmail.com>
AuthorDate: Tue Sep 10 22:18:46 2013 +1200
Commit:     Ian Jackson <Ian.Jackson@eu.citrix.com>
CommitDate: Thu Oct 10 16:59:45 2013 +0100

    libxl: fix out-of-memory error handling in libxl_list_cpupool
    
    ...otherwise it will return freed memory. All the current users of this
    function check already for a NULL return, so use that.
    
    Coverity-ID: 1056194
    
    This is CVE-2013-4371 / XSA-70
    
    Signed-off-by: Matthew Daley <mattjd@gmail.com>
    Acked-by: Ian Campbell <ian.campbell@citrix.com>
    (cherry picked from commit 4c37ed562224295c0f8b00211287d57cae629782)
    (cherry picked from commit 2350e70ee06c903a927340f7a0bf9ca25acce3f3)

diff --git a/tools/libxl/libxl.c b/tools/libxl/libxl.c
index 32d788abdb..e8d798e247 100644
--- a/tools/libxl/libxl.c
+++ b/tools/libxl/libxl.c
@@ -648,6 +648,7 @@ libxl_cpupoolinfo * libxl_list_cpupool(libxl_ctx *ctx, int *nb_pool_out)
         if (!tmp) {
             LIBXL__LOG_ERRNO(ctx, LIBXL__LOG_ERROR, "allocating cpupool info");
             libxl_cpupoolinfo_list_free(ptr, i);
+            ptr = NULL;
             goto out;
         }
         ptr = tmp;
