xen-project__xen
commit e4292c5aac41b80f33d4877104348d5ee7c95aa4
Author:     Jan Beulich <jbeulich@suse.com>
AuthorDate: Tue Nov 18 14:15:21 2014 +0100
Commit:     Jan Beulich <jbeulich@suse.com>
CommitDate: Tue Nov 18 14:15:21 2014 +0100

    x86: don't allow page table updates on non-PV page tables in do_mmu_update()
    
    paging_write_guest_entry() and paging_cmpxchg_guest_entry() aren't
    consistently supported for non-PV guests (they'd deref NULL for PVH or
    non-HAP HVM ones). Don't allow respective MMU_* operations on the
    page tables of such domains.
    
    This is CVE-2014-8594 / XSA-109.
    
    Signed-off-by: Jan Beulich <jbeulich@suse.com>
    Acked-by: Tim Deegan <tim@xen.org>

diff --git a/xen/arch/x86/mm.c b/xen/arch/x86/mm.c
index edd1923b1c..8ee9938061 100644
--- a/xen/arch/x86/mm.c
+++ b/xen/arch/x86/mm.c
@@ -3493,6 +3493,10 @@ long do_mmu_update(
         {
             p2m_type_t p2mt;
 
+            rc = -EOPNOTSUPP;
+            if ( unlikely(paging_mode_refcounts(pt_owner)) )
+                break;
+
             xsm_needed |= XSM_MMU_NORMAL_UPDATE;
             if ( get_pte_flags(req.val) & _PAGE_PRESENT )
             {
