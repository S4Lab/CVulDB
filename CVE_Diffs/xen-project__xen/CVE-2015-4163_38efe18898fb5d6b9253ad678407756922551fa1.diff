xen-project__xen
commit 38efe18898fb5d6b9253ad678407756922551fa1
Author:     Jan Beulich <jbeulich@suse.com>
AuthorDate: Thu Jun 11 15:03:58 2015 +0200
Commit:     Jan Beulich <jbeulich@suse.com>
CommitDate: Thu Jun 11 15:03:58 2015 +0200

    gnttab: add missing version check to GNTTABOP_swap_grant_ref handling
    
    ... avoiding NULL derefs when the version to use wasn't set yet (via
    GNTTABOP_setup_table or GNTTABOP_set_version).
    
    This is CVE-2015-4163 / XSA-134.
    
    Signed-off-by: Jan Beulich <jbeulich@suse.com>
    Acked-by: Ian Campbell <ian.campbell@citrix.com>
    master commit: 5d5c09d853d3f212861f70c577c65d1703f752ae
    master date: 2015-06-11 14:44:12 +0200

diff --git a/xen/common/grant_table.c b/xen/common/grant_table.c
index 07d80c1489..a92aa10d38 100644
--- a/xen/common/grant_table.c
+++ b/xen/common/grant_table.c
@@ -2372,6 +2372,9 @@ __gnttab_swap_grant_ref(grant_ref_t ref_a, grant_ref_t ref_b)
 
     spin_lock(&gt->lock);
 
+    if ( gt->gt_version == 0 )
+        PIN_FAIL(out, GNTST_general_error, "grant table not yet set up\n");
+
     /* Bounds check on the grant refs */
     if ( unlikely(ref_a >= nr_grant_entries(d->grant_table)))
         PIN_FAIL(out, GNTST_bad_gntref, "Bad ref-a (%d).\n", ref_a);
