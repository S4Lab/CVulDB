xen-project__xen
commit 650ed2cef3284bfa6918924bc6a7ac8662ce2807
Author:     Ian Campbell <ian.campbell@citrix.com>
AuthorDate: Mon Mar 30 12:12:34 2015 +0100
Commit:     Ian Campbell <ian.campbell@citrix.com>
CommitDate: Tue Mar 31 09:42:53 2015 +0100

    xen: arm: Allow traps from 32 bit userspace on 64 bit hypervisors again
    
    This removes the unconditional #undef injected in response to such
    traps which was added by the fixes to CVE-2014-5147 / XSA-102 in
    c0020e099702 "xen: arm: Handle traps from 32-bit userspace on 64-bit
    kernel as undef", we now handle such traps correctly.
    
    Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
    Reviewed-by: Julien Grall <julien.grall@linaro.org>

diff --git a/xen/arch/arm/traps.c b/xen/arch/arm/traps.c
index cf7a2fd8b4..7af527cd6b 100644
--- a/xen/arch/arm/traps.c
+++ b/xen/arch/arm/traps.c
@@ -2070,18 +2070,6 @@ asmlinkage void do_trap_hypervisor(struct cpu_user_regs *regs)
 
     enter_hypervisor_head(regs);
 
-    /*
-     * We currently do not handle 32-bit userspace on 64-bit kernels
-     * correctly (See XSA-102). Until that is resolved we treat any
-     * trap from 32-bit userspace on 64-bit kernel as undefined.
-     */
-    if ( !hyp_mode(regs) && is_64bit_domain(current->domain) &&
-         psr_mode_is_32bit(regs->cpsr) )
-    {
-        inject_undef_exception(regs, hsr.len);
-        return;
-    }
-
     switch (hsr.ec) {
     case HSR_EC_WFI_WFE:
         if ( !check_conditional_instr(regs, hsr) )
