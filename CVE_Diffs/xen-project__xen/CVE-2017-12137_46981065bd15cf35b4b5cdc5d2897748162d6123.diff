xen-project__xen
commit 46981065bd15cf35b4b5cdc5d2897748162d6123
Author:     Andrew Cooper <andrew.cooper3@citrix.com>
AuthorDate: Tue Aug 15 15:12:41 2017 +0200
Commit:     Jan Beulich <jbeulich@suse.com>
CommitDate: Tue Aug 15 15:12:41 2017 +0200

    x86/grant: disallow misaligned PTEs
    
    Pagetable entries must be aligned to function correctly.  Disallow attempts
    from the guest to have a grant PTE created at a misaligned address, which
    would result in corruption of the L1 table with largely-guest-controlled
    values.
    
    This is CVE-2017-12137 / XSA-227.
    
    Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
    Reviewed-by: Jan Beulich <jbeulich@suse.com>
    master commit: ce442926c2530da9376199dcc769436376ad2386
    master date: 2017-08-15 15:06:45 +0200

diff --git a/xen/arch/x86/mm.c b/xen/arch/x86/mm.c
index 2dc7db91a6..39b5c174bd 100644
--- a/xen/arch/x86/mm.c
+++ b/xen/arch/x86/mm.c
@@ -4006,6 +4006,9 @@ static int create_grant_pte_mapping(
     l1_pgentry_t ol1e;
     struct domain *d = v->domain;
 
+    if ( !IS_ALIGNED(pte_addr, sizeof(nl1e)) )
+        return GNTST_general_error;
+
     adjust_guest_l1e(nl1e, d);
 
     gmfn = pte_addr >> PAGE_SHIFT;
@@ -4063,6 +4066,16 @@ static int destroy_grant_pte_mapping(
     struct page_info *page;
     l1_pgentry_t ol1e;
 
+    /*
+     * addr comes from Xen's active_entry tracking so isn't guest controlled,
+     * but it had still better be PTE-aligned.
+     */
+    if ( !IS_ALIGNED(addr, sizeof(ol1e)) )
+    {
+        ASSERT_UNREACHABLE();
+        return GNTST_general_error;
+    }
+
     gmfn = addr >> PAGE_SHIFT;
     page = get_page_from_gfn(d, gmfn, NULL, P2M_ALLOC);
 
