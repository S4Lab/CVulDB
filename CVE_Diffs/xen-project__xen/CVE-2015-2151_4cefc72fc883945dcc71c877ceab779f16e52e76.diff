xen-project__xen
commit 4cefc72fc883945dcc71c877ceab779f16e52e76
Author:     Jan Beulich <jbeulich@suse.com>
AuthorDate: Tue Mar 10 13:58:00 2015 +0100
Commit:     Jan Beulich <jbeulich@suse.com>
CommitDate: Tue Mar 10 13:58:00 2015 +0100

    x86emul: fully ignore segment override for register-only operations
    
    For ModRM encoded instructions with register operands we must not
    overwrite ea.mem.seg (if a - bogus in that case - segment override was
    present) as it aliases with ea.reg.
    
    This is CVE-2015-2151 / XSA-123.
    
    Reported-by: Felix Wilhelm <fwilhelm@ernw.de>
    Signed-off-by: Jan Beulich <jbeulich@suse.com>
    Reviewed-by: Tim Deegan <tim@xen.org>
    Reviewed-by: Keir Fraser <keir@xen.org>
    master commit: bcf92a5382b75fd964c1f8678b2d9a3abe6dec39
    master date: 2015-03-10 13:45:51 +0100

diff --git a/xen/arch/x86/x86_emulate/x86_emulate.c b/xen/arch/x86/x86_emulate/x86_emulate.c
index cb172e9e46..66560721ad 100644
--- a/xen/arch/x86/x86_emulate/x86_emulate.c
+++ b/xen/arch/x86/x86_emulate/x86_emulate.c
@@ -1641,7 +1641,7 @@ x86_emulate(
         }
     }
 
-    if ( override_seg != -1 )
+    if ( override_seg != -1 && ea.type == OP_MEM )
         ea.mem.seg = override_seg;
 
     /* Early operand adjustments. */
