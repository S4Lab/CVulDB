linux-scraping__linux-grsecurity
commit cae28d36073422989aec457df579358ac19475ed
Author:     Brad Spengler <spender@grsecurity.net>
AuthorDate: Mon Feb 2 18:55:27 2015 -0500
Commit:     Mickaël Salaün <mic@digikod.net>
CommitDate: Mon Feb 2 18:55:27 2015 -0500

    grsec: Apply grsecurity-3.0-3.2.66-201502021851.patch
    
    commit d14bff6a2ee562e886a34069980ae2c6956fdd24
    Author: Florian Westphal <fw@strlen.de>
    Date:   Wed Jan 28 10:56:04 2015 +0100
    
        ppp: deflate: never return len larger than output buffer
    
        When we've run out of space in the output buffer to store more data, we
        will call zlib_deflate with a NULL output buffer until we've consumed
        remaining input.
    
        When this happens, olen contains the size the output buffer would have
        consumed iff we'd have had enough room.
    
        This can later cause skb_over_panic when ppp_generic skb_put()s
        the returned length.
    
        Reported-by: Iain Douglas <centos@1n6.org.uk>
        Signed-off-by: Florian Westphal <fw@strlen.de>
        Signed-off-by: David S. Miller <davem@davemloft.net>
    
     drivers/net/ppp/ppp_deflate.c |    2 +-
     1 files changed, 1 insertions(+), 1 deletions(-)
    
    commit 8dbb050410cd847d7e34cb058f71ce30f8b91310
    Author: Brad Spengler <spender@grsecurity.net>
    Date:   Mon Feb 2 17:43:03 2015 -0500
    
        Backport fix for CVE-2015-1420:
        http://marc.info/?l=linux-kernel&m=142247707318982&w=2
    
        Though it requires CAP_DAC_READ_SEARCH and (additionally in grsec)
        cannot be performed in a chroot
    
     fs/fhandle.c |    5 +++--
     1 files changed, 3 insertions(+), 2 deletions(-)
    
    commit bea8d87e4fd8c70bd96aeaa09378fde6852efe44
    Author: Brad Spengler <spender@grsecurity.net>
    Date:   Mon Feb 2 16:57:54 2015 -0500
    
        Backport from PaX patch:
        - fixed cc-ldoption to work with the HJL fork of binutils, reported by Rogelio M. Serrano Jr.
    
     scripts/Kbuild.include |    2 +-
     1 files changed, 1 insertions(+), 1 deletions(-)
    
    Signature-tree: 4362269ff507d9e7da351ee103110436db5249a2

diff --git a/drivers/net/ppp/ppp_deflate.c b/drivers/net/ppp/ppp_deflate.c
index 1dbdf82a6dfd..43764cca8dac 100644
--- a/drivers/net/ppp/ppp_deflate.c
+++ b/drivers/net/ppp/ppp_deflate.c
@@ -268,7 +268,7 @@ static int z_compress(void *arg, unsigned char *rptr, unsigned char *obuf,
 	/*
 	 * See if we managed to reduce the size of the packet.
 	 */
-	if (olen < isize) {
+	if (olen < isize && olen <= osize) {
 		state->stats.comp_bytes += olen;
 		state->stats.comp_packets++;
 	} else {
diff --git a/fs/fhandle.c b/fs/fhandle.c
index 4b42b2d95e98..030db71f4e5e 100644
--- a/fs/fhandle.c
+++ b/fs/fhandle.c
@@ -197,8 +197,9 @@ static int handle_to_path(int mountdirfd, struct file_handle __user *ufh,
 		goto out_err;
 	}
 	/* copy the full handle */
-	if (copy_from_user(handle, ufh,
-			   sizeof(struct file_handle) +
+	*handle = f_handle;
+	if (copy_from_user(&handle->f_handle,
+			   &ufh->f_handle,
 			   f_handle.handle_bytes)) {
 		retval = -EFAULT;
 		goto out_handle;
diff --git a/scripts/Kbuild.include b/scripts/Kbuild.include
index 978416dd31ca..a1c341e366ca 100644
--- a/scripts/Kbuild.include
+++ b/scripts/Kbuild.include
@@ -143,7 +143,7 @@ cc-ifversion = $(shell [ $(call cc-version, $(CC)) $(1) $(2) ] && echo $(3))
 # cc-ldoption
 # Usage: ldflags += $(call cc-ldoption, -Wl$(comma)--hash-style=both)
 cc-ldoption = $(call try-run,\
-	$(CC) $(1) -nostdlib -x c /dev/null -o "$$TMP",$(1),$(2))
+	$(CC) $(1) -Wl,-r -nostdlib -x c /dev/null -o "$$TMP",$(1),$(2))
 
 # ld-option
 # Usage: LDFLAGS += $(call ld-option, -X)
