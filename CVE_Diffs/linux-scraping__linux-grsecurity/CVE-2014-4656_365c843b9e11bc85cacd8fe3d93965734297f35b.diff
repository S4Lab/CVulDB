linux-scraping__linux-grsecurity
commit 365c843b9e11bc85cacd8fe3d93965734297f35b
Author:     Lars-Peter Clausen <lars@metafoo.de>
AuthorDate: Wed Jun 18 13:32:35 2014 +0200
Commit:     Willy Tarreau <w@1wt.eu>
CommitDate: Sun Nov 23 10:55:34 2014 +0100

    ALSA: control: Make sure that id->index does not overflow
    
    The ALSA control code expects that the range of assigned indices to a control is
    continuous and does not overflow. Currently there are no checks to enforce this.
    If a control with a overflowing index range is created that control becomes
    effectively inaccessible and unremovable since snd_ctl_find_id() will not be
    able to find it. This patch adds a check that makes sure that controls with a
    overflowing index range can not be created.
    
    Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
    Acked-by: Jaroslav Kysela <perex@perex.cz>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    (cherry picked from commit 883a1d49f0d77d30012f114b2e19fc141beb3e8e)
    [wt: part 1 of CVE-2014-4656 fix]
    Signed-off-by: Willy Tarreau <w@1wt.eu>

diff --git a/sound/core/control.c b/sound/core/control.c
index 7834a5438f75..80bb3ed7c548 100644
--- a/sound/core/control.c
+++ b/sound/core/control.c
@@ -328,6 +328,9 @@ int snd_ctl_add(struct snd_card *card, struct snd_kcontrol *kcontrol)
 	if (snd_BUG_ON(!card || !kcontrol->info))
 		goto error;
 	id = kcontrol->id;
+	if (id.index > UINT_MAX - kcontrol->count)
+		goto error;
+
 	down_write(&card->controls_rwsem);
 	if (snd_ctl_find_id(card, &id)) {
 		up_write(&card->controls_rwsem);
