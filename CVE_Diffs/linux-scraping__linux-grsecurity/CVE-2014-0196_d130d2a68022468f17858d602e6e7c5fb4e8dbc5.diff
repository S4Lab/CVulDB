linux-scraping__linux-grsecurity
commit d130d2a68022468f17858d602e6e7c5fb4e8dbc5
Author:     Brad Spengler <spender@grsecurity.net>
AuthorDate: Mon May 5 18:41:59 2014 -0400
Commit:     Mickaël Salaün <mic@digikod.net>
CommitDate: Mon May 5 18:41:59 2014 -0400

    grsec: Apply grsecurity-3.0-3.14.2-201405051841.patch
    
    commit 4f0228bf02504dc03b8230f0463677e23fdf1978
    Author: Brad Spengler <spender@grsecurity.net>
    Date:   Mon May 5 18:12:30 2014 -0400
    
        Backport fix for heap overflow in the tty layer, CVE-2014-0196
        http://bugzillafiles.novell.org/attachment.cgi?id=588355
    
     drivers/tty/n_tty.c |   10 ++++++++++
     1 files changed, 10 insertions(+), 0 deletions(-)
    
    Signature-tree: d13f6bbe3f1e099d49aa6921f326f4e1d8df0014

diff --git a/drivers/tty/n_tty.c b/drivers/tty/n_tty.c
index e512bdbaa77c..bd628c6e3249 100644
--- a/drivers/tty/n_tty.c
+++ b/drivers/tty/n_tty.c
@@ -2356,10 +2356,18 @@ static ssize_t n_tty_write(struct tty_struct *tty, struct file *file,
 			if (tty->ops->flush_chars)
 				tty->ops->flush_chars(tty);
 		} else {
+			struct n_tty_data *ldata = tty->disc_data;
+			bool lock;
+
+			lock = L_ECHO(tty) || (ldata->icanon & L_ECHONL(tty));
+			if (lock)
+				mutex_lock(&ldata->output_lock);
 			while (nr > 0) {
 				c = tty->ops->write(tty, b, nr);
 				if (c < 0) {
 					retval = c;
+					if (lock)
+						mutex_unlock(&ldata->output_lock);
 					goto break_out;
 				}
 				if (!c)
@@ -2367,6 +2375,8 @@ static ssize_t n_tty_write(struct tty_struct *tty, struct file *file,
 				b += c;
 				nr -= c;
 			}
+			if (lock)
+				mutex_unlock(&ldata->output_lock);
 		}
 		if (!nr)
 			break;
