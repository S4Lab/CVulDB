libressl__libressl
commit 7d2fc8af7a88b11902db7c19c46949f354f4de76
Author:     jasper <jasper>
AuthorDate: Wed Apr 14 12:41:05 2010 +0000
Commit:     jasper <jasper>
CommitDate: Wed Apr 14 12:41:05 2010 +0000

    Security fix for CVE-2010-0740
    
    "In TLS connections, certain incorrectly formatted records can cause an OpenSSL
    client or server to crash due to a read attempt at NULL."
    
    http://openssl.org/news/secadv_20100324.txt
    
    ok deraadt@ djm@ sthen@

diff --git a/src/ssl/s3_pkt.c b/src/ssl/s3_pkt.c
index b98b8404..515739c0 100644
--- a/src/ssl/s3_pkt.c
+++ b/src/ssl/s3_pkt.c
@@ -282,9 +282,10 @@ again:
 			if (version != s->version)
 				{
 				SSLerr(SSL_F_SSL3_GET_RECORD,SSL_R_WRONG_VERSION_NUMBER);
-				/* Send back error using their
-				 * version number :-) */
-				s->version=version;
+                                if ((s->version & 0xFF00) == (version & 0xFF00))
+                                	/* Send back error using their
+					 * minor version number :-) */
+					s->version = (unsigned short)version;
 				al=SSL_AD_PROTOCOL_VERSION;
 				goto f_err;
 				}
