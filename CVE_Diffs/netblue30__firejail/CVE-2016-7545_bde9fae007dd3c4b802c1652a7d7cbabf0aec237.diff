netblue30__firejail
commit bde9fae007dd3c4b802c1652a7d7cbabf0aec237
Author:     Aleksey Manevich <manevich.aleksey@gmail.com>
AuthorDate: Mon Sep 26 21:33:39 2016 +0300
Commit:     Aleksey Manevich <manevich.aleksey@gmail.com>
CommitDate: Mon Sep 26 21:33:39 2016 +0300

    CVE-2016-7545

diff --git a/src/firejail/main.c b/src/firejail/main.c
index 135ff17d..81765e3f 100644
--- a/src/firejail/main.c
+++ b/src/firejail/main.c
@@ -143,7 +143,17 @@ static void myexit(int rv) {
 	EUID_ROOT();
 	clear_run_files(sandbox_pid);
 	appimage_clear();
-	ioctl(0, TCFLSH, TCIFLUSH);
+
+	int fd = open("/dev/tty", O_RDWR);
+	if (fd != -1) {
+		ioctl(fd, TCFLSH, TCIFLUSH);
+		close(fd);
+	} else {
+		fprintf(stderr, "Warning: can't open /dev/tty, flushing stdin, stdout and stderr file descriptors instead\n");
+		ioctl(0, TCFLSH, TCIFLUSH);
+		ioctl(1, TCFLSH, TCIFLUSH);
+		ioctl(2, TCFLSH, TCIFLUSH);
+	}
 		
 	exit(rv); 
 }
diff --git a/src/firejail/sandbox.c b/src/firejail/sandbox.c
index 08296d82..272737c0 100644
--- a/src/firejail/sandbox.c
+++ b/src/firejail/sandbox.c
@@ -30,6 +30,7 @@
 #include <errno.h>
 #include <sys/ioctl.h>
 #include <termios.h>
+#include <fcntl.h>
 
 #include <sched.h>
 #ifndef CLONE_NEWUSER
@@ -85,7 +86,16 @@ static void sandbox_handler(int sig){
 
 	// broadcast a SIGKILL
 	kill(-1, SIGKILL);
-	ioctl(0, TCFLSH, TCIFLUSH);
+	int fd = open("/dev/tty", O_RDWR);
+	if (fd != -1) {
+		ioctl(fd, TCFLSH, TCIFLUSH);
+		close(fd);
+	} else {
+		fprintf(stderr, "Warning: can't open /dev/tty, flushing stdin, stdout and stderr file descriptors instead\n");
+		ioctl(0, TCFLSH, TCIFLUSH);
+		ioctl(1, TCFLSH, TCIFLUSH);
+		ioctl(2, TCFLSH, TCIFLUSH);
+	}
 	exit(sig);
 }
 
@@ -896,7 +906,16 @@ int sandbox(void* sandbox_arg) {
 	}
 
 	int status = monitor_application(app_pid);	// monitor application
-	ioctl(0, TCFLSH, TCIFLUSH);
+	int fd = open("/dev/tty", O_RDWR);
+	if (fd != -1) {
+		ioctl(fd, TCFLSH, TCIFLUSH);
+		close(fd);
+	} else {
+		fprintf(stderr, "Warning: can't open /dev/tty, flushing stdin, stdout and stderr file descriptors instead\n");
+		ioctl(0, TCFLSH, TCIFLUSH);
+		ioctl(1, TCFLSH, TCIFLUSH);
+		ioctl(2, TCFLSH, TCIFLUSH);
+	}
 
 	if (WIFEXITED(status)) {
 		// if we had a proper exit, return that exit status
