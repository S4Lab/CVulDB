bq__aquaris-E5
commit 1261ddb733ab18926874c3d6a5dfac10c2605fc6
Author:     Andy Honig <ahonig@google.com>
AuthorDate: Wed Aug 27 14:42:54 2014 -0700
Commit:     John McAleely <john.mcaleely@canonical.com>
CommitDate: Fri Dec 18 21:44:53 2015 +0000

    KVM: x86: Improve thread safety in pit
    
    There's a race condition in the PIT emulation code in KVM.  In
    __kvm_migrate_pit_timer the pit_timer object is accessed without
    synchronization.  If the race condition occurs at the wrong time this
    can crash the host kernel.
    
    This fixes CVE-2014-3611.
    
    Cc: stable@vger.kernel.org
    Signed-off-by: Andrew Honig <ahonig@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    (backported from commit 2febc839133280d5a5e8e1179c94ea674489dae2)
    Signed-off-by: AceLan Kao <acelan.kao@canonical.com>
    
    Change-Id: I51def10aab476bd908f967d6d5b279cf27a3552c

diff --git a/kernel/arch/x86/kvm/i8254.c b/kernel/arch/x86/kvm/i8254.c
index d68f99df6..db336f9f2 100644
--- a/kernel/arch/x86/kvm/i8254.c
+++ b/kernel/arch/x86/kvm/i8254.c
@@ -263,8 +263,10 @@ void __kvm_migrate_pit_timer(struct kvm_vcpu *vcpu)
 		return;
 
 	timer = &pit->pit_state.pit_timer.timer;
+	mutex_lock(&pit->pit_state.lock);
 	if (hrtimer_cancel(timer))
 		hrtimer_start_expires(timer, HRTIMER_MODE_ABS);
+	mutex_unlock(&pit->pit_state.lock);
 }
 
 static void destroy_pit_timer(struct kvm_pit *pit)
