ruby__openssl
commit f653cfa43f0f20e8c440122ea982382b6228e7f5
Author:     Kazuki Yamaguchi <k@rhe.jp>
AuthorDate: Fri Jul 27 17:01:04 2018 +0900
Commit:     Kazuki Yamaguchi <k@rhe.jp>
CommitDate: Wed Oct 17 16:42:36 2018 +0900

    x509name: fix OpenSSL::X509::Name#{cmp,<=>}
    
    Fix wrong use of X509_NAME_cmp() return value. OpenSSL::X509::Name#<=>
    could return 0 when the two objects aren't identical.
    
    Reported by Tyler Eckstein. CVE-2018-16395.
    
    Reference: https://hackerone.com/reports/387250

diff --git a/ext/openssl/ossl_x509name.c b/ext/openssl/ossl_x509name.c
index ac98c1b..4753fa4 100644
--- a/ext/openssl/ossl_x509name.c
+++ b/ext/openssl/ossl_x509name.c
@@ -358,7 +358,7 @@ ossl_x509name_cmp(VALUE self, VALUE other)
 
     result = ossl_x509name_cmp0(self, other);
     if (result < 0) return INT2FIX(-1);
-    if (result > 1) return INT2FIX(1);
+    if (result > 0) return INT2FIX(1);
 
     return INT2FIX(0);
 }
diff --git a/test/test_x509name.rb b/test/test_x509name.rb
index c1dacf4..6c8fa61 100644
--- a/test/test_x509name.rb
+++ b/test/test_x509name.rb
@@ -330,10 +330,16 @@ class OpenSSL::TestX509Name < OpenSSL::TestCase
   end
 
   def test_spaceship
-    n1 = OpenSSL::X509::Name.parse 'CN=a'
-    n2 = OpenSSL::X509::Name.parse 'CN=b'
-
-    assert_equal(-1, n1 <=> n2)
+    n1 = OpenSSL::X509::Name.new([["CN", "a"]])
+    n2 = OpenSSL::X509::Name.new([["CN", "a"]])
+    n3 = OpenSSL::X509::Name.new([["CN", "ab"]])
+
+    assert_equal 0, n1 <=> n2
+    assert_equal -1, n1 <=> n3
+    assert_equal 0, n2 <=> n1
+    assert_equal -1, n2 <=> n3
+    assert_equal 1, n3 <=> n1
+    assert_equal 1, n3 <=> n2
   end
 
   def name_hash(name)
