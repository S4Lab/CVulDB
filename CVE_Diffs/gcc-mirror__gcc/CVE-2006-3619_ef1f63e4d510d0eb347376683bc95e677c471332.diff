gcc-mirror__gcc
commit ef1f63e4d510d0eb347376683bc95e677c471332
Author:     doko <doko@138bc75d-0d04-0410-961f-82ee72b054a4>
AuthorDate: Sat Aug 5 09:27:11 2006 +0000
Commit:     doko <doko@138bc75d-0d04-0410-961f-82ee72b054a4>
CommitDate: Sat Aug 5 09:27:11 2006 +0000

            PR fastjar/28359 / CVE-2006-3619
    
            2006-07-17  Richard Guenther  <rguenther@suse.de>
            * jartool.c (extract_jar): Do not allow directory traversal
            to parents of the extraction root.
    
    
    git-svn-id: svn+ssh://gcc.gnu.org/svn/gcc/branches/gcc-4_1-branch@115945 138bc75d-0d04-0410-961f-82ee72b054a4

diff --git a/fastjar/ChangeLog b/fastjar/ChangeLog
index 9776019ecbc..1b776355eef 100644
--- a/fastjar/ChangeLog
+++ b/fastjar/ChangeLog
@@ -1,3 +1,11 @@
+2006-08-04  Matthias Klose  <doko@debian.org>
+
+	PR fastjar/28359 / CVE-2006-3619
+
+	2006-07-17  Richard Guenther  <rguenther@suse.de>
+	* jartool.c (extract_jar): Do not allow directory traversal
+	to parents of the extraction root.
+
 2006-05-24  Release Manager
 
 	* GCC 4.1.1 released.
diff --git a/fastjar/jartool.c b/fastjar/jartool.c
index 1295c01dbd2..d8903c9c7d9 100644
--- a/fastjar/jartool.c
+++ b/fastjar/jartool.c
@@ -1736,6 +1736,7 @@ int extract_jar(int fd, char **files, int file_num){
       const ub1 *start = filename;
       char *tmp_buff;
       struct stat sbuf;
+      int depth = 0;
 
       tmp_buff = malloc(sizeof(char) * strlen((const char *)filename));
 
@@ -1756,7 +1757,14 @@ int extract_jar(int fd, char **files, int file_num){
 #ifdef DEBUG    
         printf("checking the existance of %s\n", tmp_buff);
 #endif
-
+	if(strcmp(tmp_buff, "..") == 0){
+	  --depth;
+	  if (depth < 0){
+	    fprintf(stderr, "Traversal to parent directories during unpacking!\n");
+	    exit(1);
+	  }
+	} else if (strcmp(tmp_buff, ".") != 0)
+	  ++depth;
         if(stat(tmp_buff, &sbuf) < 0){
           if(errno != ENOENT){
             perror("stat");
