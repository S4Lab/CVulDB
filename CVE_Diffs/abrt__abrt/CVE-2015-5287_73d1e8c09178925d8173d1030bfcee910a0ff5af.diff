abrt__abrt
commit 73d1e8c09178925d8173d1030bfcee910a0ff5af
Author:     Jakub Filak <jfilak@redhat.com>
AuthorDate: Wed Sep 30 12:24:32 2015 +0200
Commit:     Jakub Filak <jfilak@redhat.com>
CommitDate: Mon Nov 23 14:36:31 2015 +0100

    ccpp: save abrt core files only to new files
    
    Prior this commit abrt-hook-ccpp saved a core file generated by a
    process running a program whose name starts with "abrt" in
    DUMP_LOCATION/$(basename program)-coredump. If the file was a symlink,
    the hook followed and wrote core file to the symlink's target.
    
    This commit addresses CVE-2015-5287
    Related: #1262252
    
    Signed-off-by: Jakub Filak <jfilak@redhat.com>

diff --git a/src/hooks/abrt-hook-ccpp.c b/src/hooks/abrt-hook-ccpp.c
index 7a19cc2a..9648b160 100644
--- a/src/hooks/abrt-hook-ccpp.c
+++ b/src/hooks/abrt-hook-ccpp.c
@@ -857,7 +857,8 @@ int main(int argc, char** argv)
         if (snprintf(path, sizeof(path), "%s/%s-coredump", g_settings_dump_location, last_slash) >= sizeof(path))
             error_msg_and_die("Error saving '%s': truncated long file path", path);
 
-        int abrt_core_fd = xopen3(path, O_WRONLY | O_CREAT | O_TRUNC, 0600);
+        unlink(path);
+        int abrt_core_fd = xopen3(path, O_WRONLY | O_CREAT | O_EXCL, 0600);
         off_t core_size = copyfd_eof(STDIN_FILENO, abrt_core_fd, COPYFD_SPARSE);
         if (core_size < 0 || fsync(abrt_core_fd) != 0)
         {
