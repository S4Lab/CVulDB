abrt__abrt
commit fdad51147d38e3648b53b0353379d8fa9bf2f812
Author:     Matej Habrnal <mhabrnal@redhat.com>
AuthorDate: Thu Oct 13 10:13:02 2016 +0200
Commit:     Matej Habrnal <mhabrnal@redhat.com>
CommitDate: Thu Oct 13 10:19:57 2016 +0200

    conf: introduce DebugLevel
    
    ABRT should ignore problems caused by ABRT tools if DebugLevel == 0.
    DebugLevel is set to 0 by default.
    
    Related to CVE-2015-5287
    
    Signed-off-by: Matej Habrnal <mhabrnal@redhat.com>

diff --git a/doc/abrt.conf.txt b/doc/abrt.conf.txt
index 66265963..1276f550 100644
--- a/doc/abrt.conf.txt
+++ b/doc/abrt.conf.txt
@@ -36,6 +36,14 @@ DeleteUploaded = 'yes/no'::
    or not.
    The default value is 'no'.
 
+DebugLevel = '0-100':
+   Allows ABRT tools to detect problems in ABRT itself. By increasing the value
+   you can force ABRT to detect, process and report problems in ABRT. You have
+   to bare in mind that ABRT might fall into an infinite loop when handling
+   problems caused by itself.
+   The default is 0 (non debug mode).
+
+
 SEE ALSO
 --------
 abrtd(8)
diff --git a/src/daemon/abrt.conf b/src/daemon/abrt.conf
index d20e8dfd..19d041ad 100644
--- a/src/daemon/abrt.conf
+++ b/src/daemon/abrt.conf
@@ -44,3 +44,11 @@ AutoreportingEnabled = no
 # data GENERATED BY abrtd UNDER THE USER root.
 #
 PrivateReports = yes
+
+# Allows ABRT tools to detect problems in ABRT itself. By increasing the value
+# you can force ABRT to detect, process and report problems in ABRT. You have
+# to bare in mind that ABRT might fall into an infinite loop when handling
+# problems caused by itself.
+# The default is 0 (non debug mode).
+#
+# DebugLevel = 0
diff --git a/src/include/libabrt.h b/src/include/libabrt.h
index b9160be8..38c9db94 100644
--- a/src/include/libabrt.h
+++ b/src/include/libabrt.h
@@ -67,6 +67,8 @@ extern bool          g_settings_autoreporting;
 extern char *        g_settings_autoreporting_event;
 #define g_settings_privatereports abrt_g_settings_privatereports
 extern bool          g_settings_privatereports;
+#define g_settings_debug_level abrt_g_settings_debug_level
+extern unsigned int  g_settings_debug_level;
 
 
 #define load_abrt_conf abrt_load_abrt_conf
diff --git a/src/lib/abrt_conf.c b/src/lib/abrt_conf.c
index e941f38c..0f4df114 100644
--- a/src/lib/abrt_conf.c
+++ b/src/lib/abrt_conf.c
@@ -27,6 +27,7 @@ bool          g_settings_delete_uploaded = 0;
 bool          g_settings_autoreporting = 0;
 char *        g_settings_autoreporting_event = NULL;
 bool          g_settings_privatereports = true;
+unsigned int  g_settings_debug_level = 0;
 
 void free_abrt_conf_data()
 {
@@ -100,6 +101,19 @@ static void ParseCommon(map_string_t *settings, const char *conf_filename)
         remove_map_string_item(settings, "PrivateReports");
     }
 
+    value = get_map_string_item_or_NULL(settings, "DebugLevel");
+    if (value)
+    {
+        char *end;
+        errno = 0;
+        unsigned long ul = strtoul(value, &end, 10);
+        if (errno || end == value || *end != '\0' || ul > INT_MAX)
+            error_msg("Error parsing %s setting: '%s'", "DebugLevel", value);
+        else
+            g_settings_debug_level = ul;
+        remove_map_string_item(settings, "DebugLevel");
+    }
+
     GHashTableIter iter;
     const char *name;
     /*char *value; - already declared */
