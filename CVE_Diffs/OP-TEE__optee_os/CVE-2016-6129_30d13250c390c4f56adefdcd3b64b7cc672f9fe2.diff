OP-TEE__optee_os
commit 30d13250c390c4f56adefdcd3b64b7cc672f9fe2
Author:     Steffen Jaeckel <s@jaeckel.eu>
AuthorDate: Wed Aug 6 15:03:46 2014 +0200
Commit:     Jens Wiklander <jens.wiklander@linaro.org>
CommitDate: Fri Aug 26 08:59:32 2016 +0200

    rsa_verify_hash: fix possible bleichenbacher signature attack
    
    Fixes CVE-2016-6129
    
    cherry-picked from:
    https://github.com/libtom/libtomcrypt/commit/5eb9743410ce4657e9d54fef26a2ee31a1b5dd09
    
    Acked-by: Jerome Forissier <jerome.forissier@linaro.org>
    Tested-by: Jens Wiklander <jens.wiklander@linaro.org> (QEMU)
    Signed-off-by: Joakim Bech <joakim.bech@linaro.org>

diff --git a/core/lib/libtomcrypt/src/pk/rsa/rsa_verify_hash.c b/core/lib/libtomcrypt/src/pk/rsa/rsa_verify_hash.c
index cf6e58d8..74afea9b 100644
--- a/core/lib/libtomcrypt/src/pk/rsa/rsa_verify_hash.c
+++ b/core/lib/libtomcrypt/src/pk/rsa/rsa_verify_hash.c
@@ -123,7 +123,7 @@ int rsa_verify_hash_ex(const unsigned char *sig,      unsigned long siglen,
   } else {
     /* LTC_PKCS #1 v1.5 decode it */
     unsigned char *out;
-    unsigned long outlen, loid[16];
+    unsigned long outlen, loid[16], reallen;
     int           decoded;
     ltc_asn1_list digestinfo[2], siginfo[2];
 
@@ -165,8 +165,14 @@ int rsa_verify_hash_ex(const unsigned char *sig,      unsigned long siglen,
        goto bail_2;
     }
 
+    if ((err = der_length_sequence(siginfo, 2, &reallen)) != CRYPT_OK) {
+	    XFREE(out);
+	    goto bail_2;
+    }
+
     /* test OID */
-    if ((digestinfo[0].size == hash_descriptor[hash_idx]->OIDlen) &&
+    if ((reallen == outlen) &&
+        (digestinfo[0].size == hash_descriptor[hash_idx]->OIDlen) &&
         (XMEMCMP(digestinfo[0].data, hash_descriptor[hash_idx]->OID, sizeof(unsigned long) * hash_descriptor[hash_idx]->OIDlen) == 0) &&
         (siginfo[1].size == hashlen) &&
         (XMEMCMP(siginfo[1].data, hash, hashlen) == 0)) {
