OP-TEE__optee_os
commit cdcba4f3de3d44f0f4109ea0f186b1e48944c8b9
Author:     Jens Wiklander <jens.wiklander@linaro.org>
AuthorDate: Mon Jan 15 19:25:57 2018 +0100
Commit:     Jérôme Forissier <jerome.forissier@linaro.org>
CommitDate: Tue Jan 16 12:55:22 2018 +0100

    arm32: enable ACTLR_CA15_ENABLE_INVALIDATE_BTB
    
    Enables ACTLR_CA15_ENABLE_INVALIDATE_BTB (ACTLR[0]) in generic boot if
    compiled with CFG_CORE_WORKAROUND_SPECTRE_BP or
    CFG_CORE_WORKAROUND_SPECTRE_BP_SEC and the cpu is discovered to be
    Cortex-A15.
    
    Fixes CVE-2017-5715
    
    Acked-by: Andrew Davis <andrew.davis@linaro.org>
    Reviewed-by: Etienne Carriere <etienne.carriere@linaro.org>
    Signed-off-by: Jens Wiklander <jens.wiklander@linaro.org>

diff --git a/core/arch/arm/kernel/generic_entry_a32.S b/core/arch/arm/kernel/generic_entry_a32.S
index 51567e7d..c7ba0f50 100644
--- a/core/arch/arm/kernel/generic_entry_a32.S
+++ b/core/arch/arm/kernel/generic_entry_a32.S
@@ -208,6 +208,27 @@ END_FUNC reset_vect_table
 	mov	r7, r1
 	.endm
 
+	.macro maybe_init_ca15_spectre_workaround
+#if !defined(CFG_WITH_ARM_TRUSTED_FW) && \
+    (defined(CFG_CORE_WORKAROUND_SPECTRE_BP) || \
+     defined(CFG_CORE_WORKAROUND_SPECTRE_BP_SEC))
+	read_midr r0
+	ubfx	r1, r0, #MIDR_IMPLEMENTER_SHIFT, #MIDR_IMPLEMENTER_WIDTH
+	cmp	r1, #MIDR_IMPLEMENTER_ARM
+	bne	1f
+	ubfx	r1, r0, #MIDR_PRIMARY_PART_NUM_SHIFT, \
+			#MIDR_PRIMARY_PART_NUM_WIDTH
+	movw	r2, #CORTEX_A15_PART_NUM
+	cmp	r1, r2
+	bne	1f
+	read_actlr r0
+	orr	r0, r0, #ACTLR_CA15_ENABLE_INVALIDATE_BTB
+	write_actlr r0
+	isb
+1:
+#endif
+	.endm
+
 FUNC _start , :
 UNWIND(	.fnstart)
 UNWIND(	.cantunwind)
@@ -216,6 +237,7 @@ UNWIND(	.cantunwind)
 
 	/* Early ARM secure MP specific configuration */
 	bl	plat_cpu_reset_early
+	maybe_init_ca15_spectre_workaround
 
 	set_sctlr
 	isb
