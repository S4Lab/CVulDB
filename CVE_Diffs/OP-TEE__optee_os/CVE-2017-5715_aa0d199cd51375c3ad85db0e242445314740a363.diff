OP-TEE__optee_os
commit aa0d199cd51375c3ad85db0e242445314740a363
Author:     Jens Wiklander <jens.wiklander@linaro.org>
AuthorDate: Mon Jan 15 12:37:52 2018 +0100
Commit:     Jérôme Forissier <jerome.forissier@linaro.org>
CommitDate: Tue Jan 16 12:55:22 2018 +0100

    plat-sunxi: ACTLR_CA15_ENABLE_INVALIDATE_BTB
    
    Enables ACTLR_CA15_ENABLE_INVALIDATE_BTB (ACTLR[0]) if compiled with
    CFG_CORE_WORKAROUND_SPECTRE_BP or CFG_CORE_WORKAROUND_SPECTRE_BP_SEC.
    
    Fixes CVE-2017-5715
    
    Reviewed-by: Etienne Carriere <etienne.carriere@linaro.org>
    Signed-off-by: Jens Wiklander <jens.wiklander@linaro.org>

diff --git a/core/arch/arm/plat-sunxi/entry.S b/core/arch/arm/plat-sunxi/entry.S
index d7cc6975..9e03974a 100644
--- a/core/arch/arm/plat-sunxi/entry.S
+++ b/core/arch/arm/plat-sunxi/entry.S
@@ -82,6 +82,10 @@ UNWIND(	.cantunwind)
 	/* Enable SMP bit */
 	read_actlr  r0
 	orr     r0, r0, #ACTLR_SMP
+#if defined(CFG_CORE_WORKAROUND_SPECTRE_BP) || \
+    defined(CFG_CORE_WORKAROUND_SPECTRE_BP_SEC)
+	orr     r0, r0, #ACTLR_CA15_ENABLE_INVALIDATE_BTB
+#endif
 	write_actlr  r0
 
 	/* init BSS section */
diff --git a/core/arch/arm/plat-sunxi/smp_boot.S b/core/arch/arm/plat-sunxi/smp_boot.S
index 2e8ce86f..58995c42 100644
--- a/core/arch/arm/plat-sunxi/smp_boot.S
+++ b/core/arch/arm/plat-sunxi/smp_boot.S
@@ -82,6 +82,10 @@ UNWIND(	.cantunwind)
 	/* Enable SMP bit */
     	read_actlr  r0
 	orr     r0, r0, #ACTLR_SMP
+#if defined(CFG_CORE_WORKAROUND_SPECTRE_BP) || \
+     defined(CFG_CORE_WORKAROUND_SPECTRE_BP_SEC)
+	orr	r0, r0, #ACTLR_CA15_ENABLE_INVALIDATE_BTB
+#endif
     	write_actlr r0
 	
 	/* fixup some platform limits */
