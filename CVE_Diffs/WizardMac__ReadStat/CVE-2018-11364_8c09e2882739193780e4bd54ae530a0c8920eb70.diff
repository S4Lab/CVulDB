WizardMac__ReadStat
commit 8c09e2882739193780e4bd54ae530a0c8920eb70
Author:     Evan Miller <emmiller@gmail.com>
AuthorDate: Wed May 30 12:04:25 2018 -0700
Commit:     Evan Miller <emmiller@gmail.com>
CommitDate: Wed May 30 12:04:25 2018 -0700

    SAV reader: fix memory leak. Fixes #130
    
    Memory leaked (in the form of iconv allocations) when an SAV file
    contained multiple integer information records. Thanks to Google
    Autofuzz project.
    
    See also CVE-2018-11364

diff --git a/src/spss/readstat_sav.c b/src/spss/readstat_sav.c
index f8c9d12..54bfa85 100644
--- a/src/spss/readstat_sav.c
+++ b/src/spss/readstat_sav.c
@@ -81,9 +81,8 @@ void sav_ctx_free(sav_ctx_t *ctx) {
         free(ctx->raw_string);
     if (ctx->utf8_string)
         free(ctx->utf8_string);
-    if (ctx->converter) {
+    if (ctx->converter)
         iconv_close(ctx->converter);
-    }
     if (ctx->variable_display_values) {
         free(ctx->variable_display_values);
     }
diff --git a/src/spss/readstat_sav_read.c b/src/spss/readstat_sav_read.c
index 41092ee..3dcb057 100644
--- a/src/spss/readstat_sav_read.c
+++ b/src/spss/readstat_sav_read.c
@@ -895,6 +895,9 @@ static readstat_error_t sav_parse_machine_integer_info_record(const void *data,
         if (converter == (iconv_t)-1) {
             return READSTAT_ERROR_UNSUPPORTED_CHARSET;
         }
+        if (ctx->converter) {
+            iconv_close(ctx->converter);
+        }
         ctx->converter = converter;
     }
     return READSTAT_OK;
