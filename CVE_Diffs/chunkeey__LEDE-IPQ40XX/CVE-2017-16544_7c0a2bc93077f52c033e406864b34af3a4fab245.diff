chunkeey__LEDE-IPQ40XX
commit 7c0a2bc93077f52c033e406864b34af3a4fab245
Author:     John Crispin <john@phrozen.org>
AuthorDate: Mon Jan 1 11:46:03 2018 +0100
Commit:     John Crispin <john@phrozen.org>
CommitDate: Tue Jan 2 07:14:08 2018 +0100

    busybox: backport cve-2017-16544 fix
    
    In the add_match function in libbb/lineedit.c in BusyBox through 1.27.2,
    the tab autocomplete feature of the shell, used to get a list of filenames
    in a directory, does not sanitize filenames and results in executing any
    escape sequence in the terminal. This could potentially result in code
    execution, arbitrary file writes, or other attacks.
    
    Fixes: FS#1181 - CVE-2017-16544:
    
    Backport the patch from:
    https://git.busybox.net/busybox/commit/?id=c3797d40a1c57352192c6106cc0f435e7d9c11e8
    https://nvd.nist.gov/vuln/detail/CVE-2017-16544
    
    Signed-off-by: Derek Werthmuller <thewerthfam@gmail.com>
    Signed-off-by: John Crispin <john@phrozen.org>

diff --git a/package/utils/busybox/patches/600-cve-2017-16544.patch b/package/utils/busybox/patches/600-cve-2017-16544.patch
new file mode 100644
index 0000000000..cbbdd53e9f
--- /dev/null
+++ b/package/utils/busybox/patches/600-cve-2017-16544.patch
@@ -0,0 +1,40 @@
+From c3797d40a1c57352192c6106cc0f435e7d9c11e8 Mon Sep 17 00:00:00 2001
+From: Denys Vlasenko <vda.linux@googlemail.com>
+Date: Tue, 7 Nov 2017 18:09:29 +0100
+Subject: lineedit: do not tab-complete any strings which have control
+ characters
+
+function                                             old     new   delta
+add_match                                             41      68     +27
+
+Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>
+---
+ libbb/lineedit.c | 12 ++++++++++++
+ 1 file changed, 12 insertions(+)
+
+diff --git a/libbb/lineedit.c b/libbb/lineedit.c
+index c0e35bb..56e8140 100644
+--- a/libbb/lineedit.c
++++ b/libbb/lineedit.c
+@@ -645,6 +645,18 @@ static void free_tab_completion_data(void)
+ 
+ static void add_match(char *matched)
+ {
++	unsigned char *p = (unsigned char*)matched;
++	while (*p) {
++		/* ESC attack fix: drop any string with control chars */
++		if (*p < ' '
++		 || (!ENABLE_UNICODE_SUPPORT && *p >= 0x7f)
++		 || (ENABLE_UNICODE_SUPPORT && *p == 0x7f)
++		) {
++			free(matched);
++			return;
++		}
++		p++;
++	}
+ 	matches = xrealloc_vector(matches, 4, num_matches);
+ 	matches[num_matches] = matched;
+ 	num_matches++;
+-- 
+cgit v0.12
+
