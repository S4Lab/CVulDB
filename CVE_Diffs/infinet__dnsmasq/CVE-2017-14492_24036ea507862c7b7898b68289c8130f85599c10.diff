infinet__dnsmasq
commit 24036ea507862c7b7898b68289c8130f85599c10
Author:     Simon Kelley <simon@thekelleys.org.uk>
AuthorDate: Mon Sep 25 18:47:15 2017 +0100
Commit:     Simon Kelley <simon@thekelleys.org.uk>
CommitDate: Mon Sep 25 19:59:27 2017 +0100

    Security fix, CVE-2017-14492, DHCPv6 RA heap overflow.
    
    Fix heap overflow in IPv6 router advertisement code.
    This is a potentially serious security hole, as a
    crafted RA request can overflow a buffer and crash or
    control dnsmasq. Attacker must be on the local network.

diff --git a/CHANGELOG b/CHANGELOG
index a7c2f35c..df6c157a 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -35,7 +35,15 @@ version 2.78
 	and Kevin Hamacher of the Google Security Team for
 	finding this.
 
-
+	Fix heap overflow in IPv6 router advertisement code.
+	This is a potentially serious security hole, as a
+	crafted RA request can overflow a buffer and crash or
+	control dnsmasq. Attacker must be on the local network.
+	CVE-2017-14492 applies.
+        Credit to Felix Wilhelm, Fermin J. Serna, Gabriel Campana
+	and Kevin Hamacher of the Google Security Team for
+	finding this.
+	
 	
 version 2.77
 	Generate an error when configured with a CNAME loop,
diff --git a/src/radv.c b/src/radv.c
index 10321899..9b7e52c4 100644
--- a/src/radv.c
+++ b/src/radv.c
@@ -198,6 +198,9 @@ void icmp6_packet(time_t now)
       /* look for link-layer address option for logging */
       if (sz >= 16 && packet[8] == ICMP6_OPT_SOURCE_MAC && (packet[9] * 8) + 8 <= sz)
 	{
+	  if ((packet[9] * 8 - 2) * 3 - 1 >= MAXDNAME) {
+	    return;
+	  }
 	  print_mac(daemon->namebuff, &packet[10], (packet[9] * 8) - 2);
 	  mac = daemon->namebuff;
 	}
