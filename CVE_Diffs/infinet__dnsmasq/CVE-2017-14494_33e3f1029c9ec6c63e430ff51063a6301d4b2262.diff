infinet__dnsmasq
commit 33e3f1029c9ec6c63e430ff51063a6301d4b2262
Author:     Simon Kelley <simon@thekelleys.org.uk>
AuthorDate: Mon Sep 25 20:05:11 2017 +0100
Commit:     Simon Kelley <simon@thekelleys.org.uk>
CommitDate: Mon Sep 25 20:05:11 2017 +0100

    Security fix, CVE-2017-14494, Infoleak handling DHCPv6 forwarded requests.
    
    Fix information leak in DHCPv6. A crafted DHCPv6 packet can
    cause dnsmasq to forward memory from outside the packet
    buffer to a DHCPv6 server when acting as a relay.

diff --git a/CHANGELOG b/CHANGELOG
index c48378f9..d1cc074c 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -51,6 +51,14 @@ version 2.78
 	Credit to Felix Wilhelm, Fermin J. Serna, Gabriel Campana
 	and Kevin Hamacher of the Google Security Team for
 	finding this.
+
+	Fix information leak in DHCPv6. A crafted DHCPv6 packet can
+	cause dnsmasq to forward memory from outside the packet
+	buffer to a DHCPv6 server when acting as a relay.
+	CVE-2017-14494 applies.
+	Credit to Felix Wilhelm, Fermin J. Serna, Gabriel Campana
+	and Kevin Hamacher of the Google Security Team for
+	finding this.
 	
 	
 version 2.77
diff --git a/src/rfc3315.c b/src/rfc3315.c
index 920907c7..4ca43e0c 100644
--- a/src/rfc3315.c
+++ b/src/rfc3315.c
@@ -216,6 +216,9 @@ static int dhcp6_maybe_relay(struct state *state, void *inbuff, size_t sz,
   
   for (opt = opts; opt; opt = opt6_next(opt, end))
     {
+      if (opt6_ptr(opt, 0) + opt6_len(opt) >= end) {
+        return 0;
+      }
       int o = new_opt6(opt6_type(opt));
       if (opt6_type(opt) == OPTION6_RELAY_MSG)
 	{
