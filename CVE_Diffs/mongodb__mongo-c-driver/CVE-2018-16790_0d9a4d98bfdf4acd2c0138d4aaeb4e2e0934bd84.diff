mongodb__mongo-c-driver
commit 0d9a4d98bfdf4acd2c0138d4aaeb4e2e0934bd84
Author:     Scott Gayou <sgayou@redhat.com>
AuthorDate: Fri Sep 14 11:55:11 2018 -0500
Commit:     A. Jesse Jiryu Davis <jesse@emptysquare.net>
CommitDate: Mon Sep 17 13:31:23 2018 -0400

    Fix for CVE-2018-16790 -- Verify bounds before binary length read.
    
    As reported here: https://jira.mongodb.org/browse/CDRIVER-2819,
    a heap overread occurs due a failure to correctly verify data
    bounds.
    
    In the original check, len - o returns the data left including the
    sizeof(l) we just read. Instead, the comparison should check
    against the data left NOT including the binary int32, i.e. just
    subtype (byte*) instead of int32 subtype (byte*).
    
    Added in test for corrupted BSON example.

diff --git a/src/libbson/src/bson/bson-iter.c b/src/libbson/src/bson/bson-iter.c
index 5b6dad1c5..820134ea8 100644
--- a/src/libbson/src/bson/bson-iter.c
+++ b/src/libbson/src/bson/bson-iter.c
@@ -618,7 +618,7 @@ fill_data_fields:
       memcpy (&l, iter->raw + iter->d1, sizeof (l));
       l = BSON_UINT32_FROM_LE (l);
 
-      if (l >= (len - o)) {
+      if (l >= (len - o - 4)) {
          iter->err_off = o;
          goto mark_invalid;
       }
diff --git a/src/libbson/tests/binary/test59.bson b/src/libbson/tests/binary/test59.bson
new file mode 100644
index 000000000..5fd8be074
Binary files /dev/null and b/src/libbson/tests/binary/test59.bson differ
diff --git a/src/libbson/tests/test-bson.c b/src/libbson/tests/test-bson.c
index b6e74c67c..6ac94f3ae 100644
--- a/src/libbson/tests/test-bson.c
+++ b/src/libbson/tests/test-bson.c
@@ -1249,6 +1249,11 @@ test_bson_validate (void)
                   12,
                   BSON_VALIDATE_NONE,
                   "corrupt BSON");
+   VALIDATE_TEST ("test59.bson",
+                  BSON_VALIDATE_NONE,
+                  9,
+                  BSON_VALIDATE_NONE,
+                  "corrupt BSON");
 
    /* DBRef validation */
    b = BCON_NEW ("my_dbref",
