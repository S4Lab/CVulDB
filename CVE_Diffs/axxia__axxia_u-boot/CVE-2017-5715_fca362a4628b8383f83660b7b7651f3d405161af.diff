axxia__axxia_u-boot
commit fca362a4628b8383f83660b7b7651f3d405161af
Author:     John Jacques <john.jacques@intel.com>
AuthorDate: Thu Mar 1 15:19:34 2018 -0600
Commit:     John Jacques <john.jacques@intel.com>
CommitDate: Thu Mar 1 15:19:34 2018 -0600

    Updates to the CVE-2017-5715 Patch
    
    Set the 'enable invalidates of BTB' bit in the
    ACTLR.  Without this, only the instruction cache
    gets invalidated on A15.
    
    Add a compile time define in include/configs/axxia-arm.h
    to allow the work around to be disabled.  Just comment
    out '#define CVE_2017_5715'.
    
    Signed-off-by: John Jacques <john.jacques@intel.com>

diff --git a/board/lsi/axxia-arm/axxia.c b/board/lsi/axxia-arm/axxia.c
index 9fb6704576..59e8d530f0 100644
--- a/board/lsi/axxia-arm/axxia.c
+++ b/board/lsi/axxia-arm/axxia.c
@@ -741,6 +741,13 @@ arch_early_init_r(void)
 	printf("Axxia Version: UNKNOWN\n");
 #endif
 
+	{
+		unsigned int actlr_value;
+
+		asm ("mrc p15, 0, %0, c1, c0, 1" : "=r" (actlr_value));
+		printf("actlr: 0x%x\n", actlr_value);
+	}
+
 	/*
 	  System Memory Size
 	*/
diff --git a/board/lsi/axxia-arm/lowlevel.S b/board/lsi/axxia-arm/lowlevel.S
index 5dfe2a713a..76418d5b6c 100644
--- a/board/lsi/axxia-arm/lowlevel.S
+++ b/board/lsi/axxia-arm/lowlevel.S
@@ -505,6 +505,19 @@ wa_811981_stuck:
 
 wa_811981_okay:
 
+	@@
+	@ Iniitalize the ACTLR register (all cores).
+
+#ifdef CVE_2017_5715
+set_actlr:
+
+	mrc 	p15, 0, r0, c1, c0, 1
+	@ Enable invalidation of the BTB when invalidating
+	@ the instruction cache.
+	orr 	r0, r0, #(1 << 0)
+	mcr 	p15, 0, r0, c1, c0, 1
+#endif /* CVE_2017_5715 */
+
 	@@
 	@ Iniitalize the ACTLR2 register (all cores).
 
diff --git a/board/lsi/axxia-arm/monitor.S b/board/lsi/axxia-arm/monitor.S
index eb82bf8d41..10532ce130 100644
--- a/board/lsi/axxia-arm/monitor.S
+++ b/board/lsi/axxia-arm/monitor.S
@@ -54,19 +54,25 @@ mon_vectors:
  * NS-SVC.
  */
 2:
+#ifdef CVE_2017_5715
 	/*
 	 * Before beginning, invalidate the instruction cache and branch
 	 * predictor array.
+	 *
+	 * Note that on A15, bit 0 of the ACTLR must be set for the
+	 * following to work.
 	 */
+
 	mov	r1, #0
-	/* Invalidate instruction cache to POU. */
+	/* Invalidate instruction cache to POU. (only needed on A15) */
 	mcr	p15, 0, r1, c7, c5, 0
-	/* Invalidate brach prediction array. */
+	/* Invalidate brach prediction array. (nop on A15) */
 	mcr	p15, 0, r1, c7, c5, 6
 	/* Full system DSB to make sure invalidation is complete. */
 	mcr	p15, 0, r1, c7, c10, 4
 	/* ISB to make sure the instruction stream sees it. */
 	mcr	p15, 0, r1, c7, c5, 4
+#endif /* CVE_2017_5715 */
 
 	/*
 	 * Set SCR.NS=1 (needed for setting HVBAR and also returning to NS
diff --git a/include/configs/axxia-arm.h b/include/configs/axxia-arm.h
index 31dc05f3b9..6a99aeb6f6 100755
--- a/include/configs/axxia-arm.h
+++ b/include/configs/axxia-arm.h
@@ -1213,6 +1213,15 @@ extern unsigned *phyRegs;
 
 #define CCN_QOS_RNI6_SO_DEFAULT 0x00cc000c
 
+/*
+  Invalidate the instruction cache and BTB when switching to the
+  secure monitor.  This is the suggested work around for variant 2 of
+  the Spectre/Meltdown defect.  See
+  ARM-Trusted-Firmware-Security-Advisory-TFV-6 for details.
+*/
+
+#define CVE_2017_5715
+
 /*
   ==============================================================================
   ==============================================================================
