01org__Igvtg-qemu
commit dd38952c4bc298ea934fc5df5a22d78b4c886186
Author:     Gerd Hoffmann <kraxel@redhat.com>
AuthorDate: Mon Aug 28 14:33:07 2017 +0200
Commit:     Tina Zhang <tina.zhang@intel.com>
CommitDate: Thu Jan 4 13:55:42 2018 +0800

    vga: fix display update region calculation (split screen)
    
    vga display update mis-calculated the region for the dirty bitmap
    snapshot in case split screen mode is used.  This can trigger an
    assert in cpu_physical_memory_snapshot_get_dirty().
    
    Impact:  DoS for privileged guest users.
    
    Fixes: CVE-2017-13673
    Fixes: fec5e8c92becad223df9d972770522f64aafdb72
    Cc: P J P <ppandit@redhat.com>
    Reported-by: David Buchanan <d@vidbuchanan.co.uk>
    Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>
    Message-id: 20170828123307.15392-1-kraxel@redhat.com

diff --git a/hw/display/vga.c b/hw/display/vga.c
index 9292537dc6..19993039f5 100644
--- a/hw/display/vga.c
+++ b/hw/display/vga.c
@@ -1635,9 +1635,15 @@ static void vga_draw_graphic(VGACommonState *s, int full_update)
     y1 = 0;
 
     if (!full_update) {
+        ram_addr_t region_start = addr1;
+        ram_addr_t region_end = addr1 + line_offset * height;
         vga_sync_dirty_bitmap(s);
-        snap = memory_region_snapshot_and_clear_dirty(&s->vram, addr1,
-                                                      line_offset * height,
+        if (s->line_compare < height) {
+            /* split screen mode */
+            region_start = 0;
+        }
+        snap = memory_region_snapshot_and_clear_dirty(&s->vram, region_start,
+                                                      region_end - region_start,
                                                       DIRTY_MEMORY_VGA);
     }
 
