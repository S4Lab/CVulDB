cloudbase__qemu
commit fc8e94c3e5e74437c4e73a5582f17cfd4cae5ccf
Author:     Gerd Hoffmann <kraxel@redhat.com>
AuthorDate: Wed Feb 8 11:18:36 2017 +0100
Commit:     Michael Roth <mdroth@linux.vnet.ibm.com>
CommitDate: Thu Mar 16 12:10:41 2017 -0500

    cirrus: add blit_is_unsafe call to cirrus_bitblt_cputovideo (CVE-2017-2620)
    
    CIRRUS_BLTMODE_MEMSYSSRC blits do NOT check blit destination
    and blit width, at all.  Oops.  Fix it.
    
    Security impact: high.
    
    The missing blit destination check allows to write to host memory.
    Basically same as CVE-2014-8106 for the other blit variants.
    
    Cc: qemu-stable@nongnu.org
    Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>
    (cherry picked from commit 92f2b88cea48c6aeba8de568a45f2ed958f3c298)
    Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

diff --git a/hw/display/cirrus_vga.c b/hw/display/cirrus_vga.c
index 629a5c8b4c..67663490cf 100644
--- a/hw/display/cirrus_vga.c
+++ b/hw/display/cirrus_vga.c
@@ -873,6 +873,10 @@ static int cirrus_bitblt_cputovideo(CirrusVGAState * s)
 {
     int w;
 
+    if (blit_is_unsafe(s, true)) {
+        return 0;
+    }
+
     s->cirrus_blt_mode &= ~CIRRUS_BLTMODE_MEMSYSSRC;
     s->cirrus_srcptr = &s->cirrus_bltbuf[0];
     s->cirrus_srcptr_end = &s->cirrus_bltbuf[0];
@@ -898,6 +902,10 @@ static int cirrus_bitblt_cputovideo(CirrusVGAState * s)
 	}
         s->cirrus_srccounter = s->cirrus_blt_srcpitch * s->cirrus_blt_height;
     }
+
+    /* the blit_is_unsafe call above should catch this */
+    assert(s->cirrus_blt_srcpitch <= CIRRUS_BLTBUFSIZE);
+
     s->cirrus_srcptr = s->cirrus_bltbuf;
     s->cirrus_srcptr_end = s->cirrus_bltbuf + s->cirrus_blt_srcpitch;
     cirrus_update_memory_access(s);
