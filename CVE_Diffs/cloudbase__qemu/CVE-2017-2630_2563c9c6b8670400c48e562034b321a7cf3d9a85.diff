cloudbase__qemu
commit 2563c9c6b8670400c48e562034b321a7cf3d9a85
Author:     Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
AuthorDate: Tue Mar 7 09:16:27 2017 -0600
Commit:     Paolo Bonzini <pbonzini@redhat.com>
CommitDate: Tue Mar 14 14:41:19 2017 +0100

    nbd/client: fix drop_sync [CVE-2017-2630]
    
    Comparison symbol is misused. It may lead to memory corruption.
    Introduced in commit 7d3123e.
    
    Signed-off-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
    Message-Id: <20170203154757.36140-6-vsementsov@virtuozzo.com>
    [eblake: add CVE details, update conditional]
    Signed-off-by: Eric Blake <eblake@redhat.com>
    Reviewed-by: Marc-AndrÃ© Lureau <marcandre.lureau@redhat.com>
    Message-Id: <20170307151627.27212-1-eblake@redhat.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

diff --git a/nbd/client.c b/nbd/client.c
index 5c9dee37fa..3dc2564cd0 100644
--- a/nbd/client.c
+++ b/nbd/client.c
@@ -94,7 +94,7 @@ static ssize_t drop_sync(QIOChannel *ioc, size_t size)
     char small[1024];
     char *buffer;
 
-    buffer = sizeof(small) < size ? small : g_malloc(MIN(65536, size));
+    buffer = sizeof(small) >= size ? small : g_malloc(MIN(65536, size));
     while (size > 0) {
         ssize_t count = read_sync(ioc, buffer, MIN(65536, size));
 
