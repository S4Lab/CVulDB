cloudbase__qemu
commit d3c54bf9e7f079e43f37bb0d7c2657e8976d3e1d
Author:     Greg Kurz <groug@kaod.org>
AuthorDate: Sun Feb 26 23:43:25 2017 +0100
Commit:     Michael Roth <mdroth@linux.vnet.ibm.com>
CommitDate: Thu Mar 16 12:07:37 2017 -0500

    9pfs: local: statfs: don't follow symlinks
    
    The local_statfs() callback is vulnerable to symlink attacks because it
    calls statfs() which follows symbolic links in all path elements.
    
    This patch converts local_statfs() to rely on open_nofollow() and fstatfs()
    instead.
    
    This partly fixes CVE-2016-9602.
    
    Signed-off-by: Greg Kurz <groug@kaod.org>
    Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
    (cherry picked from commit 31e51d1c15b35dc98b88a301812914b70a2b55dc)
    Signed-off-by: Greg Kurz <gkurz@linux.vnet.ibm.com>
    Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

diff --git a/hw/9pfs/9p-local.c b/hw/9pfs/9p-local.c
index fa1477f6f1..80b3964a59 100644
--- a/hw/9pfs/9p-local.c
+++ b/hw/9pfs/9p-local.c
@@ -1078,13 +1078,11 @@ static int local_fsync(FsContext *ctx, int fid_type,
 
 static int local_statfs(FsContext *s, V9fsPath *fs_path, struct statfs *stbuf)
 {
-    char *buffer;
-    int ret;
-    char *path = fs_path->data;
+    int fd, ret;
 
-    buffer = rpath(s, path);
-    ret = statfs(buffer, stbuf);
-    g_free(buffer);
+    fd = local_open_nofollow(s, fs_path->data, O_RDONLY, 0);
+    ret = fstatfs(fd, stbuf);
+    close_preserve_errno(fd);
     return ret;
 }
 
