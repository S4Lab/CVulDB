liblouis__liblouis
commit 98eebd7564595b2403a8573c0725a38519546445
Author:     Christian Egli <christian.egli@sbs.ch>
AuthorDate: Fri Sep 1 15:12:30 2017 +0200
Commit:     Christian Egli <christian.egli@sbs.ch>
CommitDate: Fri Sep 1 15:12:30 2017 +0200

    Guard against buffer overflow in _lou_showString
    
    I believe this fixes #397 and hence CVE-2017-13743

diff --git a/liblouis/utils.c b/liblouis/utils.c
index 59ea6d39..2eb3958b 100644
--- a/liblouis/utils.c
+++ b/liblouis/utils.c
@@ -145,7 +145,7 @@ _lou_showString (widechar const *chars, int length)
   int bufPos = 0;
   static char scratchBuf[MAXSTRING];
   scratchBuf[bufPos++] = '\'';
-  for (charPos = 0; charPos < length; charPos++)
+  for (charPos = 0; charPos < length && bufPos < (MAXSTRING-2); charPos++)
     {
       if (chars[charPos] >= 32 && chars[charPos] < 127)
 	scratchBuf[bufPos++] = (char) chars[charPos];
@@ -182,14 +182,14 @@ _lou_showString (widechar const *chars, int length)
 	      leadingZeros = 0;
 	      break;
 	    }
-	  if ((bufPos + leadingZeros + hexLength + 4) >= sizeof (scratchBuf))
-	    break;
-	  scratchBuf[bufPos++] = '\\';
-	  scratchBuf[bufPos++] = escapeLetter;
-	  for (hexPos = 0; hexPos < leadingZeros; hexPos++)
-	    scratchBuf[bufPos++] = '0';
-	  for (hexPos = 0; hexPos < hexLength; hexPos++)
-	    scratchBuf[bufPos++] = hexbuf[hexPos];
+	  if ((bufPos + leadingZeros + hexLength + 4) < (MAXSTRING-2)) {
+	    scratchBuf[bufPos++] = '\\';
+	    scratchBuf[bufPos++] = escapeLetter;
+	    for (hexPos = 0; hexPos < leadingZeros; hexPos++)
+	      scratchBuf[bufPos++] = '0';
+	    for (hexPos = 0; hexPos < hexLength; hexPos++)
+	      scratchBuf[bufPos++] = hexbuf[hexPos];
+	  }
 	}
     }
   scratchBuf[bufPos++] = '\'';
