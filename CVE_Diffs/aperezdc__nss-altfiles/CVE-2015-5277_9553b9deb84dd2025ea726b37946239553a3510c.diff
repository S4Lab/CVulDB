aperezdc__nss-altfiles
commit 9553b9deb84dd2025ea726b37946239553a3510c
Author:     Marcus Sundberg <marcus.sundberg@aptilo.com>
AuthorDate: Fri Sep 2 17:19:01 2016 +0200
Commit:     Marcus Sundberg <marcus.sundberg@aptilo.com>
CommitDate: Fri Sep 2 17:20:18 2016 +0200

    Don't ignore too long lines in nss_files (BZ #17079)
    
    Fix from upstream glibc commit
    ac60763eac3d43b7234dd21286ad3ec3f17957fc by Andreas Schwab.
    
    This fixes CVE-2015-5277.

diff --git a/src/nss_altfiles/files-XXX.c b/src/nss_altfiles/files-XXX.c
index d4a5033..1e18e08 100644
--- a/src/nss_altfiles/files-XXX.c
+++ b/src/nss_altfiles/files-XXX.c
@@ -196,10 +196,12 @@ get_contents (char *linebuf, size_t len, FILE *stream)
     {
       int curlen = ((remaining_len > (size_t) INT_MAX) ? INT_MAX
 		    : remaining_len);
-      char *p = fgets_unlocked (curbuf, curlen, stream);
 
+      /* Terminate the line so that we can test for overflow.  */
       ((unsigned char *) curbuf)[curlen - 1] = 0xff;
 
+      char *p = fgets_unlocked (curbuf, curlen, stream);
+
       /* EOF or read error.  */
       if (p == NULL)
         return gcr_error;
