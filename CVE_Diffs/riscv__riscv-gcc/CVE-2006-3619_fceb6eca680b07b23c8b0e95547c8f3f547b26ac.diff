riscv__riscv-gcc
commit fceb6eca680b07b23c8b0e95547c8f3f547b26ac
Author:     doko <doko@138bc75d-0d04-0410-961f-82ee72b054a4>
AuthorDate: Sat Aug 5 09:43:02 2006 +0000
Commit:     doko <doko@138bc75d-0d04-0410-961f-82ee72b054a4>
CommitDate: Sat Aug 5 09:43:02 2006 +0000

            PR fastjar/28359 / CVE-2006-3619
    
            2006-07-17  Richard Guenther  <rguenther@suse.de>
            * jartool.c (extract_jar): Do not allow directory traversal
            to parents of the extraction root.
    
    
    git-svn-id: svn+ssh://gcc.gnu.org/svn/gcc/branches/gcc-4_0-branch@115946 138bc75d-0d04-0410-961f-82ee72b054a4

diff --git a/fastjar/ChangeLog b/fastjar/ChangeLog
index 87f6a39d3dd..14b52a0f29e 100644
--- a/fastjar/ChangeLog
+++ b/fastjar/ChangeLog
@@ -1,3 +1,11 @@
+2006-08-04  Matthias Klose  <doko@debian.org>
+
+        PR fastjar/28359 / CVE-2006-3619
+
+	2006-07-17  Richard Guenther  <rguenther@suse.de>
+	* jartool.c (extract_jar): Do not allow directory traversal
+	to parents of the extraction root.
+
 2006-03-09  Release Manager
 
 	* GCC 4.0.3 released.
diff --git a/fastjar/jartool.c b/fastjar/jartool.c
index a3b059740cc..a6f3c615f94 100644
--- a/fastjar/jartool.c
+++ b/fastjar/jartool.c
@@ -1724,6 +1724,7 @@ int extract_jar(int fd, char **files, int file_num){
       const ub1 *start = filename;
       char *tmp_buff;
       struct stat sbuf;
+      int depth = 0;
 
       tmp_buff = malloc(sizeof(char) * strlen((const char *)filename));
 
@@ -1744,7 +1745,14 @@ int extract_jar(int fd, char **files, int file_num){
 #ifdef DEBUG    
         printf("checking the existance of %s\n", tmp_buff);
 #endif
-
+	if(strcmp(tmp_buff, "..") == 0){
+	  --depth;
+	  if (depth < 0){
+	    fprintf(stderr, "Traversal to parent directories during unpacking!\n");
+	    exit(1);
+	  }
+	} else if (strcmp(tmp_buff, ".") != 0)
+	  ++depth;
         if(stat(tmp_buff, &sbuf) < 0){
           if(errno != ENOENT){
             perror("stat");
