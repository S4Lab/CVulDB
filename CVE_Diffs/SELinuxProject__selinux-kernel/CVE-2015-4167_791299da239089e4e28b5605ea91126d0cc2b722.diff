SELinuxProject__selinux-kernel
commit 791299da239089e4e28b5605ea91126d0cc2b722
Author:     Jan Kara <jack@suse.cz>
AuthorDate: Wed Jan 7 13:49:08 2015 +0100
Commit:     Willy Tarreau <w@1wt.eu>
CommitDate: Fri Sep 18 13:51:57 2015 +0200

    udf: Check length of extended attributes and allocation descriptors
    
    commit 23b133bdc452aa441fcb9b82cbf6dd05cfd342d0 upstream.
    
    Check length of extended attributes and allocation descriptors when
    loading inodes from disk. Otherwise corrupted filesystems could confuse
    the code and make the kernel oops.
    
    Reported-by: Carl Henrik Lunde <chlunde@ping.uio.no>
    Signed-off-by: Jan Kara <jack@suse.cz>
    [bwh: Backported to 2.6.32: use make_bad_inode() instead of returning error]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    
    CVE-2015-4167
    
    Signed-off-by: Willy Tarreau <w@1wt.eu>

diff --git a/fs/udf/inode.c b/fs/udf/inode.c
index 26b7f31dc623..b8d7a0e3aece 100644
--- a/fs/udf/inode.c
+++ b/fs/udf/inode.c
@@ -1284,6 +1284,19 @@ static void udf_fill_inode(struct inode *inode, struct buffer_head *bh)
 							iinfo->i_lenEAttr;
 	}
 
+	/*
+	 * Sanity check length of allocation descriptors and extended attrs to
+	 * avoid integer overflows
+	 */
+	if (iinfo->i_lenEAttr > bs || iinfo->i_lenAlloc > bs) {
+		make_bad_inode(inode);
+		return;
+	}
+	/* Now do exact checks */
+	if (udf_file_entry_alloc_offset(inode) + iinfo->i_lenAlloc > bs) {
+		make_bad_inode(inode);
+		return;
+	}
 	/* Sanity checks for files in ICB so that we don't get confused later */
 	if (iinfo->i_alloc_type == ICBTAG_FLAG_AD_IN_ICB) {
 		/*
