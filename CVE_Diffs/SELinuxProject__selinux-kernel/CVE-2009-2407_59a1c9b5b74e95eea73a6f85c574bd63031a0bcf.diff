SELinuxProject__selinux-kernel
commit 59a1c9b5b74e95eea73a6f85c574bd63031a0bcf
Author:     Ramon de Carvalho Valle <ramon@risesecurity.org>
AuthorDate: Tue Jul 28 13:58:22 2009 -0500
Commit:     Greg Kroah-Hartman <gregkh@suse.de>
CommitDate: Thu Jul 30 14:40:36 2009 -0700

    eCryptfs: parse_tag_3_packet check tag 3 packet encrypted key size (CVE-2009-2407)
    
    commit f151cd2c54ddc7714e2f740681350476cda03a28 upstream.
    
    The parse_tag_3_packet function does not check if the tag 3 packet contains a
    encrypted key size larger than ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES.
    
    Signed-off-by: Ramon de Carvalho Valle <ramon@risesecurity.org>
    [tyhicks@linux.vnet.ibm.com: Added printk newline and changed goto to out_free]
    Signed-off-by: Tyler Hicks <tyhicks@linux.vnet.ibm.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

diff --git a/fs/ecryptfs/keystore.c b/fs/ecryptfs/keystore.c
index 5414253d4c97..259525c9abb8 100644
--- a/fs/ecryptfs/keystore.c
+++ b/fs/ecryptfs/keystore.c
@@ -1303,6 +1303,13 @@ parse_tag_3_packet(struct ecryptfs_crypt_stat *crypt_stat,
 	}
 	(*new_auth_tok)->session_key.encrypted_key_size =
 		(body_size - (ECRYPTFS_SALT_SIZE + 5));
+	if ((*new_auth_tok)->session_key.encrypted_key_size
+	    > ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES) {
+		printk(KERN_WARNING "Tag 3 packet contains key larger "
+		       "than ECRYPTFS_MAX_ENCRYPTED_KEY_BYTES\n");
+		rc = -EINVAL;
+		goto out_free;
+	}
 	if (unlikely(data[(*packet_size)++] != 0x04)) {
 		printk(KERN_WARNING "Unknown version number [%d]\n",
 		       data[(*packet_size) - 1]);
