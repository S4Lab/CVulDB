openssh__openssh-portable
commit 85bdcd7c92fe7ff133bbc4e10a65c91810f88755
Author:     Damien Miller <djm@mindrot.org>
AuthorDate: Wed Apr 13 10:39:57 2016 +1000
Commit:     Damien Miller <djm@mindrot.org>
CommitDate: Wed Apr 13 10:44:42 2016 +1000

    ignore PAM environment vars when UseLogin=yes
    
    If PAM is configured to read user-specified environment variables
    and UseLogin=yes in sshd_config, then a hostile local user may
    attack /bin/login via LD_PRELOAD or similar environment variables
    set via PAM.
    
    CVE-2015-8325, found by Shayan Sadigh, via Colin Watson

diff --git a/session.c b/session.c
index 48592457..4653b09f 100644
--- a/session.c
+++ b/session.c
@@ -1322,7 +1322,7 @@ do_setup_env(Session *s, const char *shell)
 	 * Pull in any environment variables that may have
 	 * been set by PAM.
 	 */
-	if (options.use_pam) {
+	if (options.use_pam && !options.use_login) {
 		char **p;
 
 		p = fetch_pam_child_environment();
