google__boringssl
commit 3c9746a6d7ccff7d206d110feebba474aaa20f05
Author:     David Benjamin <davidben@chromium.org>
AuthorDate: Thu Mar 19 15:00:10 2015 -0400
Commit:     Adam Langley <agl@google.com>
CommitDate: Thu Mar 19 19:52:59 2015 +0000

    Regression test for CVE-2015-0291.
    
    This is really just scar tissue with https://crbug.com/468889 being the real
    underlying problem. But the test is pretty easy.
    
    Change-Id: I5eca18fdcbde8665c0e6c3ac419a28152647d66f
    Reviewed-on: https://boringssl-review.googlesource.com/4052
    Reviewed-by: Adam Langley <agl@google.com>

diff --git a/ssl/test/runner/common.go b/ssl/test/runner/common.go
index a33ad19b9..5cad28932 100644
--- a/ssl/test/runner/common.go
+++ b/ssl/test/runner/common.go
@@ -667,6 +667,10 @@ type ProtocolBugs struct {
 	// NeverResumeOnRenego, if true, causes renegotiations to always be full
 	// handshakes.
 	NeverResumeOnRenego bool
+
+	// NoSignatureAlgorithmsOnRenego, if true, causes renegotiations to omit
+	// the signature_algorithms extension.
+	NoSignatureAlgorithmsOnRenego bool
 }
 
 func (c *Config) serverInit() {
diff --git a/ssl/test/runner/handshake_client.go b/ssl/test/runner/handshake_client.go
index 4ed9025ac..066975036 100644
--- a/ssl/test/runner/handshake_client.go
+++ b/ssl/test/runner/handshake_client.go
@@ -130,7 +130,7 @@ NextCipherSuite:
 		return errors.New("tls: short read from Rand: " + err.Error())
 	}
 
-	if hello.vers >= VersionTLS12 && !c.config.Bugs.NoSignatureAndHashes {
+	if hello.vers >= VersionTLS12 && !c.config.Bugs.NoSignatureAndHashes && (c.cipherSuite == 0 || !c.config.Bugs.NoSignatureAlgorithmsOnRenego) {
 		hello.signatureAndHashes = c.config.signatureAndHashesForClient()
 	}
 
diff --git a/ssl/test/runner/runner.go b/ssl/test/runner/runner.go
index 3ea033299..c9362148d 100644
--- a/ssl/test/runner/runner.go
+++ b/ssl/test/runner/runner.go
@@ -2682,6 +2682,19 @@ func addRenegotiationTests() {
 		},
 		flags: []string{"-allow-unsafe-legacy-renegotiation"},
 	})
+	// Regression test for CVE-2015-0291.
+	testCases = append(testCases, testCase{
+		testType: serverTest,
+		name:     "Renegotiate-Server-NoSignatureAlgorithms",
+		config: Config{
+			Bugs: ProtocolBugs{
+				NeverResumeOnRenego:           true,
+				NoSignatureAlgorithmsOnRenego: true,
+			},
+		},
+		flags:           []string{"-renegotiate"},
+		shimWritesFirst: true,
+	})
 	// TODO(agl): test the renegotiation info SCSV.
 	testCases = append(testCases, testCase{
 		name:        "Renegotiate-Client",
