google__boringssl
commit c3d79605ab06cffa87877bcfe0792f767bde8b90
Author:     Emilia KÃ¤sper <emilia@openssl.org>
AuthorDate: Thu Jul 24 22:15:29 2014 +0200
Commit:     Adam Langley <agl@google.com>
CommitDate: Thu Aug 7 21:13:45 2014 +0000

    Fix DTLS anonymous EC(DH) denial of service
    
    (This change originally applied to 1.0.1. In the switch to 1.0.2, the
    DTLS specific client processing was removed and now the s3_clnt.c
    functions are used. This caused most of the patch to be moot. What
    remains is still useful however. For the original patch, see the change
    against 1.0.1: 88ae012c8092852f03c50f6461175271104b4c8a)
    
    CVE-2014-3510
    
    Reviewed-by: Dr. Stephen Henson <steve@openssl.org>
    
    (Imported from upstream's 1d7d0ed9c21403d79d602b6c7d76fdecf5e737da)
    
    Change-Id: I666f9c48d603f2366cab821ae446a57360c3026b
    Reviewed-on: https://boringssl-review.googlesource.com/1439
    Reviewed-by: Adam Langley <agl@google.com>

diff --git a/ssl/s3_clnt.c b/ssl/s3_clnt.c
index fc1567fbd..89a151aad 100644
--- a/ssl/s3_clnt.c
+++ b/ssl/s3_clnt.c
@@ -2082,6 +2082,13 @@ int ssl3_send_client_key_exchange(SSL *s)
 			RSA *rsa;
 			unsigned char tmp_buf[SSL_MAX_MASTER_KEY_LENGTH];
 
+			if (s->session->sess_cert == NULL)
+				{
+				/* We should always have a server certificate with SSL_kRSA. */
+				OPENSSL_PUT_ERROR(SSL, ssl3_send_client_key_exchange, ERR_R_INTERNAL_ERROR);
+				goto err;
+				}
+
 			if (s->session->sess_cert->peer_rsa_tmp != NULL)
 				rsa=s->session->sess_cert->peer_rsa_tmp;
 			else
