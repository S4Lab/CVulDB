gluster__glusterfs
commit acb208221bfe3ac897d8eb4fbe18fa6c8aa9286e
Author:     Amar Tumballi <amarts@redhat.com>
AuthorDate: Thu Nov 1 07:21:41 2018 +0530
Commit:     Shyamsundar Ranganathan <srangana@redhat.com>
CommitDate: Mon Nov 5 18:49:51 2018 +0000

    io-stats: prevent taking file dump on server side
    
    By allowing clients taking dump in a file on brick process, we are
    allowing compromised clients to create io-stats dumps on server,
    which can exhaust all the available inodes.
    
    Fixes: CVE-2018-14659
    
    Fixes: bz#1644757
    Change-Id: I32bfde9d4fe646d819a45e627805b928cae2e1ca
    Signed-off-by: Amar Tumballi <amarts@redhat.com>

diff --git a/xlators/debug/io-stats/src/io-stats.c b/xlators/debug/io-stats/src/io-stats.c
index 3b370f20e..06a16c8f3 100644
--- a/xlators/debug/io-stats/src/io-stats.c
+++ b/xlators/debug/io-stats/src/io-stats.c
@@ -2930,6 +2930,15 @@ conditional_dump(dict_t *dict, char *key, data_t *value, void *data)
     this = stub->this;
     conf = this->private;
 
+    /* Don't do this on 'brick-side', only do this on client side */
+    /* Addresses CVE-2018-14659 */
+    if (this->ctx->process_mode != GF_CLIENT_PROCESS) {
+        gf_log(this->name, GF_LOG_DEBUG,
+               "taking io-stats dump using setxattr not permitted on brick."
+               " Use 'gluster profile' instead");
+        return -1;
+    }
+
     /* Create a file name that is appended with the io-stats instance
     name as well. This helps when there is more than a single io-stats
     instance in the graph, or the client and server processes are running
