MotorolaMobilityLLC__kernel-msm
commit ab41ba4e420b490b0689e1233fc1e0f9d1f0c6da
Author:     Cong Wang <xiyou.wangcong@gmail.com>
AuthorDate: Tue Dec 13 10:33:34 2016 -0800
Commit:     Fan Hang <hangfan1@lenovo.com>
CommitDate: Tue Oct 17 09:27:22 2017 +0800

    FROMLIST: 9p: fix a potential acl leak
    
    (https://lkml.org/lkml/2016/12/13/579)
    
    posix_acl_update_mode() could possibly clear 'acl', if so
    we leak the memory pointed by 'acl'. Save this pointer
    before calling posix_acl_update_mode() and release the memory
    if 'acl' really gets cleared.
    
    Mot-CRs-fixed:(CR)
    CVE-Fixed:CVE-2016-7097
    Bug: 32458736
    
    Reported-by: Mark Salyzyn <salyzyn@android.com>
    Reviewed-by: Jan Kara <jack@suse.cz>
    Reviewed-by: Greg Kurz <groug@kaod.org>
    Cc: Eric Van Hensbergen <ericvh@gmail.com>
    Cc: Ron Minnich <rminnich@sandia.gov>
    Cc: Latchesar Ionkov <lucho@ionkov.net>
    Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
    Signed-off-by: Amarendra Reddy <amarenr@motorola.com>
    Change-Id: Ia78da401e6fd1bfd569653bd2cd0ebd3f9c737a0
    Reviewed-on: https://gerrit.mot.com/961863
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    (cherry picked from commit 4a1d1d9f2efca7df8459b4b00850622b6c7ee8ae)
    Reviewed-on: https://gerrit.mot.com/991660
    Reviewed-by: Qiang Nie <nieqiang2@mt.com>
    SLTApproved: Qiang Nie <nieqiang2@mt.com>
    Submit-Approved: Qiang Nie <nieqiang2@mt.com>

diff --git a/fs/9p/acl.c b/fs/9p/acl.c
index d3f5d487ae46..cc6747746440 100644
--- a/fs/9p/acl.c
+++ b/fs/9p/acl.c
@@ -321,6 +321,7 @@ static int v9fs_xattr_set_acl(struct dentry *dentry, const char *name,
 		name = POSIX_ACL_XATTR_ACCESS;
 		if (acl) {
 			struct iattr iattr;
+			struct posix_acl *old_acl = acl;
 
 			retval = posix_acl_update_mode(inode, &iattr.ia_mode, &acl);
 			if (retval)
@@ -331,6 +332,7 @@ static int v9fs_xattr_set_acl(struct dentry *dentry, const char *name,
 				 * by the mode bits. So don't
 				 * update ACL.
 				 */
+				posix_acl_release(old_acl);
 				value = NULL;
 				size = 0;
 			}
