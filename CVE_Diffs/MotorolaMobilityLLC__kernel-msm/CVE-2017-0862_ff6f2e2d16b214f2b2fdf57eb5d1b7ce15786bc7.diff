MotorolaMobilityLLC__kernel-msm
commit ff6f2e2d16b214f2b2fdf57eb5d1b7ce15786bc7
Author:     Jianqiang Zhao <zhaojianqiang1@gmail.com>
AuthorDate: Thu Oct 12 17:30:24 2017 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Wed Oct 31 12:00:33 2018 -0500

    ANDROID: input: keychord: fix race condition Bug
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0862
    Bug: 36006779
    
    Change-Id: I9c7c759c99e21cad9a7f9a09128122bf6ae11302
    Signed-off-by: Jianqiang Zhao <zhaojianqiang1@gmail.com>
    Signed-off-by: Amarendra Reddy <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1073300
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Varun Shrivastava <varunshrivastava@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/input/misc/keychord.c b/drivers/input/misc/keychord.c
index 82fefdff366a..57f758a2bc13 100644
--- a/drivers/input/misc/keychord.c
+++ b/drivers/input/misc/keychord.c
@@ -370,8 +370,10 @@ static ssize_t keychord_write(struct file *file, const char __user *buffer,
 
 	ret = input_register_handler(&kdev->input_handler);
 	if (ret) {
+		spin_lock_irqsave(&kdev->lock, flags);
 		kfree(keychords);
 		kdev->keychords = 0;
+		spin_unlock_irqrestore(&kdev->lock, flags);
 		keychord_write_unlock(kdev);
 		return ret;
 	}
