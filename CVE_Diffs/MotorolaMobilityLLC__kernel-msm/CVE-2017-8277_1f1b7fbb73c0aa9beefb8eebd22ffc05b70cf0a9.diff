MotorolaMobilityLLC__kernel-msm
commit 1f1b7fbb73c0aa9beefb8eebd22ffc05b70cf0a9
Author:     Sandeep Panda <spanda@codeaurora.org>
AuthorDate: Fri May 12 10:56:32 2017 +0530
Commit:     Charles Barros <charlesb@motorola.com>
CommitDate: Tue Jan 23 14:57:57 2018 -0200

    msm: mdss: remove client from device list if failed to register
    
    If there is any failure while registering a DBA client with MDSS
    driver, then remove the client from device client list first and
    then free the client. Otherwise driver might crash when
    traversing the device client list in later stage, because of an
    uninitialized entry in the list.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-8277
    
    Change-Id: I60666f4c3dea5c7ea7b7c77bcb14b080ee25b54d
    Signed-off-by: Sandeep Panda <spanda@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1044674
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 563762512f33b9bffb739ab077182d1c7a1558b0)

diff --git a/drivers/video/msm/msm_dba/msm_dba.c b/drivers/video/msm/msm_dba/msm_dba.c
index 7a5c9d9d873a..cc6512a4af9b 100644
--- a/drivers/video/msm/msm_dba/msm_dba.c
+++ b/drivers/video/msm/msm_dba/msm_dba.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2015, The Linux Foundation. All rights reserved.
+ * Copyright (c) 2015,2017, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -80,6 +80,11 @@ void *msm_dba_register_client(struct msm_dba_reg_info *info,
 		if (rc) {
 			pr_err("%s: Client register failed (%s, %d)\n",
 			       __func__, info->chip_name, info->instance_id);
+			/* remove the client from list before freeing */
+			mutex_lock_nested(&device->dev_mutex,
+						SINGLE_DEPTH_NESTING);
+			list_del(&client->list);
+			mutex_unlock(&device->dev_mutex);
 			kfree(client);
 			mutex_unlock(&register_mutex);
 			return ERR_PTR(rc);
