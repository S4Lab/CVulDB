MotorolaMobilityLLC__kernel-msm
commit 802e8c41d03b4fe0c5c136b762cb2a42af09cd22
Author:     Sreelakshmi Gownipalli <sgownipa@codeaurora.org>
AuthorDate: Mon Oct 9 12:59:56 2017 -0700
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Mar 22 06:01:37 2018 -0500

    diag: Add mutex protection while reading dci debug statistics
    
    Unserialized access to diag_dbgfs_dci_data_index can lead to
    heap overflow. Add mutex protection while updating the
    diag_dbgfs_dci_data_index.
    
    CVE-fixed: CVE-2017-15834
    Mot-CRs-fixed: (CR)
    CRs-fixed: 2111858
    
    Change-Id: Iee9d0447494e3576e6293afcd4d7611bc429aa8a
    Signed-off-by: Sreelakshmi Gownipalli <sgownipa@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1123027
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/char/diag/diag_debugfs.c b/drivers/char/diag/diag_debugfs.c
index 98c26600f131..8e4727f4888f 100644
--- a/drivers/char/diag/diag_debugfs.c
+++ b/drivers/char/diag/diag_debugfs.c
@@ -50,7 +50,7 @@ static int diag_dbgfs_bridgeinfo_index;
 static int diag_dbgfs_finished;
 static int diag_dbgfs_dci_data_index;
 static int diag_dbgfs_dci_finished;
-
+static struct mutex diag_dci_dbgfs_mutex;
 static ssize_t diag_dbgfs_read_status(struct file *file, char __user *ubuf,
 				      size_t count, loff_t *ppos)
 {
@@ -151,6 +151,7 @@ static ssize_t diag_dbgfs_read_dcistats(struct file *file,
 	buf_size = ksize(buf);
 	bytes_remaining = buf_size;
 
+	mutex_lock(&diag_dci_dbgfs_mutex);
 	if (diag_dbgfs_dci_data_index == 0) {
 		bytes_written =
 			scnprintf(buf, buf_size,
@@ -206,8 +207,8 @@ static ssize_t diag_dbgfs_read_dcistats(struct file *file,
 		}
 		temp_data++;
 	}
-
 	diag_dbgfs_dci_data_index = (i >= DIAG_DCI_DEBUG_CNT) ? 0 : i + 1;
+	mutex_unlock(&diag_dci_dbgfs_mutex);
 	bytes_written = simple_read_from_buffer(ubuf, count, ppos, buf,
 								bytes_in_buf);
 	kfree(buf);
@@ -1067,6 +1068,7 @@ int diag_debugfs_init(void)
 		pr_warn("diag: could not allocate memory for dci debug info\n");
 
 	mutex_init(&dci_stat_mutex);
+	mutex_init(&diag_dci_dbgfs_mutex);
 	return 0;
 err:
 	kfree(dci_traffic);
@@ -1083,6 +1085,7 @@ void diag_debugfs_cleanup(void)
 
 	kfree(dci_traffic);
 	mutex_destroy(&dci_stat_mutex);
+	mutex_destroy(&diag_dci_dbgfs_mutex);
 }
 #else
 int diag_debugfs_init(void) { return 0; }
