MotorolaMobilityLLC__kernel-msm
commit f1f521fcdf073d82d65322c905472ac9e982b48b
Author:     Xiaoyu Ye <benyxy@codeaurora.org>
AuthorDate: Mon Jan 23 16:38:25 2017 +0530
Commit:     Neeraj Kumar <neerajk@motorola.com>
CommitDate: Wed Jan 25 03:02:01 2017 -0600

    drivers: soc: qcom: Add error handling in function avtimer_ioctl
    
    Error handling is added to prevent garbage value being passed to
    user space by the uninitialized local variable avtimer_tick.
    
    CVE-fixed: CVE-2016-5346
    Mot-CRs-fixed: (CR)
    CRs-Fixed: 1097878
    Change-Id: I3f895deaae3acf329088cf8135859cc41e781763
    Signed-off-by: Xiaoyu Ye <benyxy@codeaurora.org>
    
    Signed-off-by: Neeraj Kumar <neerajk@motorola.com>
    ----
    Change-Id: I90c277cfc745430f8c252eefe67bf95ca2561894
    Reviewed-on: https://gerrit.mot.com/944273
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Kiran Kumar Krishna <kiran@motorola.com>
    Reviewed-by: Ravikumar Vembu <raviv@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/platform/msm/avtimer.c b/drivers/platform/msm/avtimer.c
index b685c450e410..3aa4b3a1b709 100644
--- a/drivers/platform/msm/avtimer.c
+++ b/drivers/platform/msm/avtimer.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2012-2015, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2012-2016, The Linux Foundation. All rights reserved.
 
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 and
@@ -331,9 +331,17 @@ static long avtimer_ioctl(struct file *file, unsigned int ioctl_num,
 	switch (ioctl_num) {
 	case IOCTL_GET_AVTIMER_TICK:
 	{
-		uint64_t avtimer_tick;
+		uint64_t avtimer_tick = 0;
+		int rc;
+
+		rc = avcs_core_query_timer(&avtimer_tick);
+
+		if (rc) {
+			pr_err("%s: Error: Invalid AV Timer tick, rc = %d\n",
+				__func__, rc);
+			return rc;
+		}
 
-		avcs_core_query_timer(&avtimer_tick);
 		pr_debug_ratelimited("%s: AV Timer tick: time %llx\n",
 		__func__, avtimer_tick);
 		if (copy_to_user((void *) ioctl_param, &avtimer_tick,
