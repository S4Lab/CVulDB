MotorolaMobilityLLC__kernel-msm
commit 3f1196622ff58596e36c3a482a7ee041bdd1ebad
Author:     Takashi Iwai <tiwai@suse.de>
AuthorDate: Thu Oct 6 13:53:35 2016 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Mon Nov 21 09:47:22 2016 -0600

    ALSA: usb-audio: Fix double-free in error paths after snd_usb_add_audio_stream() call
    
    create_fixed_stream_quirk(), snd_usb_parse_audio_interface() and
    create_uaxx_quirk() functions allocate the audioformat object by themselves
    and free it upon error before returning. However, once the object is linked
    to a stream, it's freed again in snd_usb_audio_pcm_free(), thus it'll be
    double-freed, eventually resulting in a memory corruption.
    
    This patch fixes these failures in the error paths by unlinking the audioformat
    object before freeing it.
    
    Based on a patch by Takashi Iwai <tiwai@suse.de>
    
    [Note for stable backports:
     this patch requires the commit 902eb7fd1e4a ('ALSA: usb-audio: Minor
     code cleanup in create_fixed_stream_quirk()')]
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2016-2184
    
    Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1283358
    Reported-by: Ralf Spenneberg <ralf@spenneberg.net>
    Cc: <stable@vger.kernel.org> # see the note above
    Signed-off-by: Vladis Dronov <vdronov@redhat.com>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    --------------------
    
    Change-Id: Iad7614b6820ce30e4aa182a38e68beaaeada9da7
    Reviewed-on: https://gerrit.mot.com/910257
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/sound/usb/stream.c b/sound/usb/stream.c
index a0392e7c5784..9abc3f10695e 100644
--- a/sound/usb/stream.c
+++ b/sound/usb/stream.c
@@ -646,6 +646,7 @@ int snd_usb_parse_audio_interface(struct snd_usb_audio *chip, int iface_no)
 		fp->clock = clock;
 		INIT_LIST_HEAD(&fp->list);
 		fp->chmap = convert_chmap(num_channels, chconfig, protocol);
+		INIT_LIST_HEAD(&fp->list);
 
 		/* some quirks for attributes here */
 
