MotorolaMobilityLLC__kernel-msm
commit 784eb21feabed3545161931772985d97b6e6e43f
Author:     Jerry Zhang <zhangjerry@google.com>
AuthorDate: Wed Nov 15 15:26:33 2017 +0530
Commit:     nieqiang <nieqiang@motorola.com>
CommitDate: Tue Aug 13 11:52:21 2019 +0800

    usb: gadget: f_mtp: Return error if count is negative
    
    If the user passes in a negative file size in a int64,
    this will compare to be smaller than buffer length,
    and it will get truncated to form a read length that
    is larger than the buffer length.
    
    To fix, return -EINVAL if the count argument is negative,
    so the loop will never happen.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-13163
    Bug: 37429972
    
    Test: Test with PoC
    Change-Id: I5Montanae38e6fbe2c17eb8c493f9eb81df6cfd780a4
    Signed-off-by: Jerry Zhang <zhangjerry@google.com>
    Signed-off-by: Amarendra Reddy <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1090092
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    Reviewed-on: https://gerrit.mot.com/1167331
    Reviewed-by: Jianqi Yang <yangj@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1262843
    Reviewed-on: https://gerrit.mot.com/1338862
    Reviewed-by: Huosheng Liao <liaohs@motorola.com>

diff --git a/drivers/usb/gadget/function/f_mtp.c b/drivers/usb/gadget/function/f_mtp.c
index 25ce7be2ad59..f73d36fcb308 100644
--- a/drivers/usb/gadget/function/f_mtp.c
+++ b/drivers/usb/gadget/function/f_mtp.c
@@ -829,6 +829,11 @@ static void send_file_work(struct work_struct *data)
 	offset = dev->xfer_file_offset;
 	count = dev->xfer_file_length;
 
+	if (count < 0) {
+		dev->xfer_result = -EINVAL;
+		return;
+	}
+
 	mtp_log("(%lld %lld)\n", offset, count);
 
 	if (dev->xfer_send_header) {
@@ -943,6 +948,11 @@ static void receive_file_work(struct work_struct *data)
 	offset = dev->xfer_file_offset;
 	count = dev->xfer_file_length;
 
+	if (count < 0) {
+		dev->xfer_result = -EINVAL;
+		return;
+	}
+
 	mtp_log("(%lld)\n", count);
 	if (!IS_ALIGNED(count, dev->ep_out->maxpacket))
 		mtp_log("- count(%lld) not multiple of mtu(%d)\n",
