MotorolaMobilityLLC__kernel-msm
commit d794e54bda61c17e0775905177465606a112644d
Author:     Jianqiang Zhao <zhaojianqiang1@gmail.com>
AuthorDate: Thu Oct 12 17:53:13 2017 +0530
Commit:     lulu2 <lulu2@lenovo.com>
CommitDate: Wed May 16 12:58:13 2018 +0800

    ANDROID: input: keychord: fix race condition bug
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0862
    Bug: 36006779
    
    Change-Id: I9c7c759c99e21cad9a7f9a09128122bf6ae11302
    Signed-off-by: Jianqiang Zhao <zhaojianqiang1@gmail.com>
    Signed-off-by: Amarendra Reddy <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1073297
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/input/misc/keychord.c b/drivers/input/misc/keychord.c
index fdcc14653b64..ebf8201c5e1d 100644
--- a/drivers/input/misc/keychord.c
+++ b/drivers/input/misc/keychord.c
@@ -370,8 +370,10 @@ static ssize_t keychord_write(struct file *file, const char __user *buffer,
 
 	ret = input_register_handler(&kdev->input_handler);
 	if (ret) {
+		spin_lock_irqsave(&kdev->lock, flags);
 		kfree(keychords);
 		kdev->keychords = 0;
+		spin_unlock_irqrestore(&kdev->lock, flags);
 		keychord_write_unlock(kdev);
 		return ret;
 	}
