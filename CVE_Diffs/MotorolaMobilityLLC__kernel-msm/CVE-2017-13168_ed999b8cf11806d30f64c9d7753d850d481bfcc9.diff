MotorolaMobilityLLC__kernel-msm
commit ed999b8cf11806d30f64c9d7753d850d481bfcc9
Author:     Roberto Pereira <rpere@google.com>
AuthorDate: Wed Nov 15 16:00:09 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Dec 14 23:31:08 2017 -0600

    ANDROID: scsi: Add segment checking in sg_read
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-13168
    Bug: 65023233
    
    Signed-off-by: Roberto Pereira <rpere@google.com>
    Change-Id: I91b6b5dbcea7c39643beffdc12a23ee3d8f8775d
    Reviewed-on: https://gerrit.mot.com/1090131
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 343e81b4e12800abf7d41e311eee79ec35e64766)

diff --git a/drivers/scsi/sg.c b/drivers/scsi/sg.c
index c8b1ce2f86b4..e2adb378bbf4 100644
--- a/drivers/scsi/sg.c
+++ b/drivers/scsi/sg.c
@@ -406,6 +406,9 @@ sg_read(struct file *filp, char __user *buf, size_t count, loff_t * ppos)
 	struct sg_header *old_hdr = NULL;
 	int retval = 0;
 
+	if (unlikely(segment_eq(get_fs(), KERNEL_DS)))
+		return -EINVAL;
+
 	if ((!(sfp = (Sg_fd *) filp->private_data)) || (!(sdp = sfp->parentdp)))
 		return -ENXIO;
 	SCSI_LOG_TIMEOUT(3, sg_printk(KERN_INFO, sdp,
