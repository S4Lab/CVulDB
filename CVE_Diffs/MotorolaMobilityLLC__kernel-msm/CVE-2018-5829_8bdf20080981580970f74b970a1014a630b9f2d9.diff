MotorolaMobilityLLC__kernel-msm
commit 8bdf20080981580970f74b970a1014a630b9f2d9
Author:     Meera Gande <mgande@codeaurora.org>
AuthorDate: Mon Jan 22 18:15:02 2018 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Tue Dec 3 10:02:04 2019 +0800

    mm-camera2:isp2: Handle use after free buffer
    
    In the code, start_fetch can try to access the
    buffer pointer variable after free, as the
    same pointer can be freed at RELEASE_BUF call
    at the same time.
    
    Bug-id: A-69065862
    CRs-fixed: 2149998
    CVE-fixed: CVE-2018-5829 CVE-2018-5832
    Mot-CRs-fixed: (CR)
    
    Change-Id: Ic83f22336504cf67afe12131f791eee25477f011
    Signed-off-by: Meera Gande <mgande@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motrola.com>
    Reviewed-on: https://gerrit.mot.com/1177752
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Ravikumar Vembu <Raviv@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit ce704767d3d781cac98a5fc9f04ea05d8262727e)

diff --git a/drivers/media/platform/msm/camera_v2/isp/msm_isp47.c b/drivers/media/platform/msm/camera_v2/isp/msm_isp47.c
index b36247616203..503c21d9adfb 100644
--- a/drivers/media/platform/msm/camera_v2/isp/msm_isp47.c
+++ b/drivers/media/platform/msm/camera_v2/isp/msm_isp47.c
@@ -1095,8 +1095,10 @@ int msm_vfe47_start_fetch_engine(struct vfe_device *vfe_dev,
 			fe_cfg->stream_id);
 		vfe_dev->fetch_engine_info.bufq_handle = bufq_handle;
 
+		mutex_lock(&vfe_dev->buf_mgr->lock);
 		rc = vfe_dev->buf_mgr->ops->get_buf_by_index(
 			vfe_dev->buf_mgr, bufq_handle, fe_cfg->buf_idx, &buf);
+		mutex_unlock(&vfe_dev->buf_mgr->lock);
 		if (rc < 0 || !buf) {
 			pr_err("%s: No fetch buffer rc= %d buf= %pK\n",
 				__func__, rc, buf);
