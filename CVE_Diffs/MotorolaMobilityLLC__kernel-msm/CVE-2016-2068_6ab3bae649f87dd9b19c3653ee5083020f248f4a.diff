MotorolaMobilityLLC__kernel-msm
commit 6ab3bae649f87dd9b19c3653ee5083020f248f4a
Author:     Weiyin Jiang <wjiang@codeaurora.org>
AuthorDate: Tue Apr 26 14:35:38 2016 +0800
Commit:     Eric1 Lin <Eric1_Lin@asus.com>
CommitDate: Sat Jun 18 13:20:18 2016 +0800

    Sparrow: audio: security patch for CVE-2016-2068
    
    [CVE-2016-2068] apply the part of the patch for integer overflow
    check in asm drive
    
    ASoC: msm: audio-effects: misc fixes in h/w accelerated effect
    
    Adding memory copy size check and integer overflow check in h/w
    accelerated effect driver.
    
    Change-Id: I17d4cc0a38770f0c5067fa8047cd63e7bf085e48
    CRs-Fixed: 1006609
    Signed-off-by: Weiyin Jiang <wjiang@codeaurora.org>
    
    Conflicts:
            drivers/misc/qcom/qdsp6v2/audio_hwacc_effects.c
            sound/soc/msm/qdsp6v2/q6asm.c
    Change-Id: Ie578639adcd6b24613639cdb854d9a3e18c00038
    Reviewed-on: http://mcrd1-22-pc.corpnet.asus/code-review/master/237117
    Reviewed-by: jay_chuang <jay_chuang@asus.com>
    Tested-by: jay_chuang <jay_chuang@asus.com>
    Reviewed-by: Yu-Hao Lin <yu-hao_lin@asus.com>
    Reviewed-by: Eric1 Lin <Eric1_Lin@asus.com>

diff --git a/sound/soc/msm/qdsp6v2/q6asm.c b/sound/soc/msm/qdsp6v2/q6asm.c
index 3e38e69d5efd..da6190c38984 100644
--- a/sound/soc/msm/qdsp6v2/q6asm.c
+++ b/sound/soc/msm/qdsp6v2/q6asm.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2012-2014, The Linux Foundation. All rights reserved.
+ * Copyright (c) 2012-2016, The Linux Foundation. All rights reserved.
  * Author: Brian Swetland <swetland@google.com>
  *
  * This software is licensed under the terms of the GNU General Public
@@ -1141,6 +1141,12 @@ int q6asm_audio_client_buf_alloc_contiguous(unsigned int dir,
 
 	ac->port[dir].buf = buf;
 
+	/* check for integer overflow */
+	if ((bufcnt > 0) && ((INT_MAX / bufcnt) < bufsz)) {
+		pr_err("%s: integer overflow\n", __func__);
+		mutex_unlock(&ac->cmd_lock);
+		goto fail;
+	}
 	bytes_to_alloc = bufsz * bufcnt;
 
 	/* The size to allocate should be multiple of 4K bytes */
