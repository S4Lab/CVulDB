MotorolaMobilityLLC__kernel-msm
commit e3a0813890a22137aec0203fb5107bf5f153bd12
Author:     Theodore Ts'o <tytso@mit.edu>
AuthorDate: Thu Feb 14 12:05:56 2019 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Wed Apr 3 04:13:44 2019 -0500

    ext4: add corruption check in ext4_xattr_set_entry()
    
    In theory this should have been caught earlier when the xattr list was
    verified, but in case it got missed, it's simple enough to add check
    to make sure we don't overrun the xattr buffer.
    
    This addresses CVE-2018-10879.
    
    https://bugzilla.kernel.org/show_bug.cgi?id=200001
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-10879
    BUG: 116406063
    
    Signed-off-by: Theodore Ts'o <tytso@mit.edu>
    Reviewed-by: Andreas Dilger <adilger@dilger.ca>
    Cc: stable@vger.kernel.org
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    
    Change-Id: I8b15a4a88d0d1635bc4c85e85a95e9efeb88c377
    Reviewed-on: https://gerrit.mot.com/1308686
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Shi-Yong Li <a22381@motorola.com>
    Reviewed-by: Ling Jin <lingjin@motorola.com>
    Submit-Approved: Jira Key

diff --git a/fs/ext4/xattr.c b/fs/ext4/xattr.c
index 8c8ffbb35a12..e29936b7c3a7 100644
--- a/fs/ext4/xattr.c
+++ b/fs/ext4/xattr.c
@@ -645,12 +645,16 @@ static size_t ext4_xattr_free_space(struct ext4_xattr_entry *last,
 static int
 ext4_xattr_set_entry(struct ext4_xattr_info *i, struct ext4_xattr_search *s)
 {
-	struct ext4_xattr_entry *last;
+	struct ext4_xattr_entry *last, *next;
 	size_t free, min_offs = s->end - s->base, name_len = strlen(i->name);
 
 	/* Compute min_offs and last. */
 	last = s->first;
-	for (; !IS_LAST_ENTRY(last); last = EXT4_XATTR_NEXT(last)) {
+	for (; !IS_LAST_ENTRY(last); last = next) {
+		next = EXT4_XATTR_NEXT(last);
+		if ((void *)next >= s->end) {
+			return -EFSCORRUPTED;
+		}
 		if (last->e_value_size) {
 			size_t offs = le16_to_cpu(last->e_value_offs);
 			if (offs < min_offs)
