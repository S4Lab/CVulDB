MotorolaMobilityLLC__kernel-msm
commit d6ed11e9885cc4bbe39e3f4f1083d1f1029e038f
Author:     Mohit Aggarwal <maggarwa@codeaurora.org>
AuthorDate: Mon Feb 12 12:27:21 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Mar 22 06:01:04 2018 -0500

    diag: Add protection while de-initializing clients
    
    Currently, while de-initializing clients, there is
    a possibility of using already freed memory. The
    patch adds proper protection to fix the issue.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-3561
    CRs-Fixed: 2068569
    BUG: 68870904
    
    Change-Id: I4b397a82e03fa2f1c84cfa8ca912cdb6a51ba08b
    Signed-off-by: Mohit Aggarwal <maggarwa@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1135379
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/char/diag/diagchar_core.c b/drivers/char/diag/diagchar_core.c
index 7d7347e5d246..f96c6ce5d80f 100644
--- a/drivers/char/diag/diagchar_core.c
+++ b/drivers/char/diag/diagchar_core.c
@@ -1697,14 +1697,18 @@ static int diag_ioctl_lsm_deinit(void)
 {
 	int i;
 
+	mutex_lock(&driver->diagchar_mutex);
 	for (i = 0; i < driver->num_clients; i++)
 		if (driver->client_map[i].pid == current->tgid)
 			break;
 
-	if (i == driver->num_clients)
+	if (i == driver->num_clients) {
+		mutex_unlock(&driver->diagchar_mutex);
 		return -EINVAL;
+	}
 
 	driver->data_ready[i] |= DEINIT_TYPE;
+	mutex_unlock(&driver->diagchar_mutex);
 	wake_up_interruptible(&driver->wait_q);
 
 	return 1;
