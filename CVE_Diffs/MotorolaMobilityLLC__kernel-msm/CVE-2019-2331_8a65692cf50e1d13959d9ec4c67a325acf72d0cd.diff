MotorolaMobilityLLC__kernel-msm
commit 8a65692cf50e1d13959d9ec4c67a325acf72d0cd
Author:     Vatsal Bucha <vbucha@codeaurora.org>
AuthorDate: Fri Mar 1 13:16:39 2019 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Dec 9 16:57:15 2019 +0800

    qdsp6v2: apr: check for packet size to header size comparison
    
    Check if packet size is large enough to hold the header.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2019-2331
    CRs-Fixed: 2380697
    
    Change-Id: I7261f8111d8b5f4f7c181e469de248a732242d64
    Signed-off-by: Vatsal Bucha <vbucha@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1355536
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Ravikumar Vembu <Raviv@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/soc/qcom/qdsp6v2/apr.c b/drivers/soc/qcom/qdsp6v2/apr.c
index bacf3133f89b..8a217ec23a2c 100644
--- a/drivers/soc/qcom/qdsp6v2/apr.c
+++ b/drivers/soc/qcom/qdsp6v2/apr.c
@@ -531,6 +531,12 @@ void apr_cb_func(void *buf, int len, void *priv)
 		pr_err("APR: Wrong paket size\n");
 		return;
 	}
+
+	if (hdr->pkt_size < hdr_size) {
+		pr_err("APR: Packet size less than header size\n");
+		return;
+	}
+
 	msg_type = hdr->hdr_field;
 	msg_type = (msg_type >> 0x08) & 0x0003;
 	if (msg_type >= APR_MSG_TYPE_MAX && msg_type != APR_BASIC_RSP_RESULT) {
