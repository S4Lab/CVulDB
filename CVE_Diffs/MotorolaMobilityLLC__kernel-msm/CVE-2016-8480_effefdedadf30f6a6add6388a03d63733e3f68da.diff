MotorolaMobilityLLC__kernel-msm
commit effefdedadf30f6a6add6388a03d63733e3f68da
Author:     Mallikarjuna Reddy Amireddy <mamire@codeaurora.org>
AuthorDate: Tue Nov 22 17:24:46 2016 +0530
Commit:     Amarendra Reddy <amarenr@motorola.com>
CommitDate: Fri Jan 13 01:35:29 2017 -0600

    qseecom: remove entry from qseecom_registered_app_list
    
    In an error handling case, the QSEECOM_IOCTL_LOAD_APP_REQ ioctl
    freed the entry for new TA, but didn't removed it from
    qseecom_registered_app_list. Make change to remove it.
    
    Mot-CRs-fixed:(CR)
    CVE-Fixed:CVE-2016-8480
    
    Change-Id: Id681fbf3c923027d3db875d506cbe3f971919a8d
    Signed-off-by: Zhen Kong <zkong@codeaurora.org>
    Signed-off-by: Mallikarjuna Reddy Amireddy <mamire@codeaurora.org>
    Signed-off-by: amarenr <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/939737
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index a80be8db9b73..c543216f1b2b 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -1329,6 +1329,7 @@ static int qseecom_load_app(struct qseecom_dev_handle *data, void __user *argp)
 	struct qseecom_command_scm_resp resp;
 	struct qseecom_check_app_ireq req;
 	struct qseecom_load_app_ireq load_req;
+	bool first_time = false;
 
 	/* Copy the relevant information needed for loading the image */
 	if (copy_from_user(&load_img_req,
@@ -1375,6 +1376,7 @@ static int qseecom_load_app(struct qseecom_dev_handle *data, void __user *argp)
 		&qseecom.registered_app_list_lock, flags);
 		ret = 0;
 	} else {
+		first_time = true;
 		pr_warn("App (%s) does'nt exist, loading apps for first time\n",
 			(char *)(load_img_req.img_name));
 		/* Get the handle of the shared fd */
@@ -1475,8 +1477,15 @@ static int qseecom_load_app(struct qseecom_dev_handle *data, void __user *argp)
 	load_img_req.app_id = app_id;
 	if (copy_to_user(argp, &load_img_req, sizeof(load_img_req))) {
 		pr_err("copy_to_user failed\n");
-		kzfree(entry);
 		ret = -EFAULT;
+		if (first_time == true) {
+			spin_lock_irqsave(
+				&qseecom.registered_app_list_lock, flags);
+			list_del(&entry->list);
+			spin_unlock_irqrestore(
+				&qseecom.registered_app_list_lock, flags);
+			kzfree(entry);
+		}
 	}
 
 loadapp_err:
