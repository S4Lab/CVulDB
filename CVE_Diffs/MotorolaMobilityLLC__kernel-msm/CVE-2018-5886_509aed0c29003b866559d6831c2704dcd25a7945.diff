MotorolaMobilityLLC__kernel-msm
commit 509aed0c29003b866559d6831c2704dcd25a7945
Author:     Sathish Ambley <sathishambley@codeaurora.org>
AuthorDate: Mon Jun 4 18:11:35 2018 +0530
Commit:     Jignesh Patel <jignesh@motorola.com>
CommitDate: Thu Jun 7 00:05:50 2018 -0500

    msm: ADSPRPC: use access_ok to validate pointers
    
    Check the validity of the pointer in user space that you intend to
    access. access_ok function simply checks that the address is likely
    in user space, not in the kernel.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-5886
    CRs-Fixed: 2123661
    
    Change-Id: I936f73a2c2029f9e7ca12cc8fc06d0698e6710c0
    Signed-off-by: Tharun Kumar Merugu <mtharu@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1185819
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/char/adsprpc.c b/drivers/char/adsprpc.c
index 7dd4016b65df..fe1d4b4e7078 100644
--- a/drivers/char/adsprpc.c
+++ b/drivers/char/adsprpc.c
@@ -1208,12 +1208,18 @@ static int fastrpc_init_process(struct fastrpc_file *fl,
 		inbuf.namelen = strlen(current->comm);
 		inbuf.filelen = init->filelen;
 
+		if (!access_ok(0, (void const __user *)init->file,
+				init->filelen))
+			goto bail;
 		if (init->filelen) {
 			VERIFY(err, !fastrpc_mmap_create(fl, init->filefd,
 				init->file, init->filelen, mflags, &file));
 			if (err)
 				goto bail;
 		}
+		if (!access_ok(1, (void const __user *)init->mem,
+				init->memlen))
+			goto bail;
 		inbuf.pageslen = 1;
 		VERIFY(err, !fastrpc_mmap_create(fl, init->memfd, init->mem,
 						 init->memlen, mflags, &mem));
