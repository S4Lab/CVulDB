MotorolaMobilityLLC__kernel-msm
commit fc7360c75b9fbf1f063ae07eb4383b30b7c39a9c
Author:     Michael S. Tsirkin <mst@redhat.com>
AuthorDate: Sat May 12 00:33:10 2018 +0300
Commit:     Alistair Strachan <astrachan@google.com>
CommitDate: Tue Jan 15 17:08:38 2019 -0800

    UPSTREAM: vhost: fix info leak due to uninitialized memory
    
    commit 670ae9caaca467ea1bfd325cb2a5c98ba87f94ad upstream.
    
    struct vhost_msg within struct vhost_msg_node is copied to userspace.
    Unfortunately it turns out on 64 bit systems vhost_msg has padding after
    type which gcc doesn't initialize, leaking 4 uninitialized bytes to
    userspace.
    
    This padding also unfortunately means 32 bit users of this interface are
    broken on a 64 bit kernel which will need to be fixed separately.
    
    Fixes: CVE-2018-1118
    Cc: stable@vger.kernel.org
    Reported-by: Kevin Easton <kevin@guarana.org>
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
    Reported-by: syzbot+87cfa083e727a224754b@syzkaller.appspotmail.com
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    (cherry picked from commit 9681c3bdb098f6c87a0422b6b63912c1b90ad197)
    Bug: 121166534
    Test: Ran cuttlefish with android-4.4 + VSOCKETS, VMWARE_VMCI_VSOCKETS
    Signed-off-by: Alistair Strachan <astrachan@google.com>
    
    Change-Id: Ie5a29c3946792ae0f20e04015ba28c89fd90becb

diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.c
index 12a01bc51cd5..fb94b311f498 100644
--- a/drivers/vhost/vhost.c
+++ b/drivers/vhost/vhost.c
@@ -2296,6 +2296,9 @@ struct vhost_msg_node *vhost_new_msg(struct vhost_virtqueue *vq, int type)
 	struct vhost_msg_node *node = kmalloc(sizeof *node, GFP_KERNEL);
 	if (!node)
 		return NULL;
+
+	/* Make sure all padding within the structure is initialized. */
+	memset(&node->msg, 0, sizeof node->msg);
 	node->vq = vq;
 	node->msg.type = type;
 	return node;
