MotorolaMobilityLLC__kernel-msm
commit 15d35aab6cdb75ed89ec56d15c46b96afa690149
Author:     Varun Shrivastava <varunshrivastava@motorola.com>
AuthorDate: Wed May 10 08:49:13 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Jul 27 02:45:34 2017 -0500

    qseecom: add mutex around qseecom_set_client_mem_param
    
    Add mutex around qseecom_set_client_mem_param to prevent an
    ioctl thread modifying and corrupting data which is being
    processed by another ioctl in the other thread
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-8242
    
    Signed-off-by: Varun Shrivastava <varunshrivastava@motorola.com>
    Change-Id: Ie9d5d76f73bb9999bade169f01b57c857fceb86a
    Reviewed-on: https://gerrit.mot.com/992044
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index 149d9ee1b84f..e48c1f705106 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -6684,7 +6684,11 @@ long qseecom_ioctl(struct file *file, unsigned cmd, unsigned long arg)
 			break;
 		}
 		pr_debug("SET_MEM_PARAM: qseecom addr = 0x%pK\n", data);
+		mutex_lock(&app_access_lock);
+		atomic_inc(&data->ioctl_count);
 		ret = qseecom_set_client_mem_param(data, argp);
+		atomic_dec(&data->ioctl_count);
+		mutex_unlock(&app_access_lock);
 		if (ret)
 			pr_err("failed Qqseecom_set_mem_param request: %d\n",
 								ret);
