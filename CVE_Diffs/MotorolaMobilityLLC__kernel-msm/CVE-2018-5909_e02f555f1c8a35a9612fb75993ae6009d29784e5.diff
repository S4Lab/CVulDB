MotorolaMobilityLLC__kernel-msm
commit e02f555f1c8a35a9612fb75993ae6009d29784e5
Author:     Harsh Sahu <hsahu@codeaurora.org>
AuthorDate: Fri Mar 23 00:29:30 2018 -0700
Commit:     Jignesh Patel <jignesh@motorola.com>
CommitDate: Wed Jun 6 23:42:07 2018 -0500

    msm: sde: check buffer size before writing to user buffer
    
    Check the number of bytes to copy against the size of the
    user buffer before copy to user to avoid buffer overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-5909
    CRs-Fixed: 2174716
    
    Change-Id: I95083227cfefaf1a81815296145b0c370127e061
    Signed-off-by: Harsh Sahu <hsahu@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1185446
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/media/platform/msm/sde/rotator/sde_rotator_debug.c b/drivers/media/platform/msm/sde/rotator/sde_rotator_debug.c
index 1966fa9805c0..a2381557070d 100644
--- a/drivers/media/platform/msm/sde/rotator/sde_rotator_debug.c
+++ b/drivers/media/platform/msm/sde/rotator/sde_rotator_debug.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2015-2017, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -482,6 +482,11 @@ static ssize_t sde_rot_evtlog_dump_read(struct file *file, char __user *buff,
 	if (__sde_rot_evtlog_dump_calc_range()) {
 		len = sde_rot_evtlog_dump_entry(evtlog_buf,
 				SDE_ROT_EVTLOG_BUF_MAX);
+		if (len < 0 || len > count) {
+			pr_err("len is more than the user buffer size\n");
+			return 0;
+		}
+
 		if (copy_to_user(buff, evtlog_buf, len))
 			return -EFAULT;
 		*ppos += len;
