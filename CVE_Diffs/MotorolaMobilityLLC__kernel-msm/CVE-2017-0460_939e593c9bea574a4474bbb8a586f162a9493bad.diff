MotorolaMobilityLLC__kernel-msm
commit 939e593c9bea574a4474bbb8a586f162a9493bad
Author:     Subash Abhinov Kasiviswanathan <subashab@codeaurora.org>
AuthorDate: Thu Jan 12 22:09:16 2017 -0700
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Mar 30 22:56:47 2017 -0500

    net: rmnet_data: Fix incorrect netlink handling
    
    rmnet_data netlink handler currently does not check for the
    incoming process pid and instead just loops back the pid.
    A malicious root user could potentially send a message with
    source pid 0 and this could cause rmnet_data to loop the message
    back till an out of memory situation occurs.
    
    rmnet_data also does not check for the message length of the
    incoming netlink messages and instead casts the netlink message
    without checking for the boundary.
    
    Fix these two scenarios by adding the pid and message length checks
    respectively.
    
    Mot-CRs-fixed:IKSIMP-1814
    CVE-Fixed:CVE-2017-0460
    
    Bug: 31252965
    CRs-Fixed: 1098801
    Change-Id: I172c1a7112e67e82959b397af7ddfd963d819bdc
    Signed-off-by: Subash Abhinov Kasiviswanathan <subashab@codeaurora.org>
    Signed-off-by: Vineet Angadi V <vineetv@motorola.com>
    Reviewed-on: https://gerrit.mot.com/948917
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/net/rmnet_data/rmnet_data_config.c b/net/rmnet_data/rmnet_data_config.c
index b11a93da632d..02f1387533c0 100644
--- a/net/rmnet_data/rmnet_data_config.c
+++ b/net/rmnet_data/rmnet_data_config.c
@@ -531,6 +531,11 @@ void rmnet_config_netlink_msg_handler(struct sk_buff *skb)
 	nlmsg_header = (struct nlmsghdr *) skb->data;
 	rmnet_header = (struct rmnet_nl_msg_s *) nlmsg_data(nlmsg_header);
 
+	if (!nlmsg_header->nlmsg_pid ||
+	    (nlmsg_header->nlmsg_len < sizeof(struct nlmsghdr) +
+				       sizeof(struct rmnet_nl_msg_s)))
+		return;
+
 	LOGL("Netlink message pid=%d, seq=%d, length=%d, rmnet_type=%d",
 		nlmsg_header->nlmsg_pid,
 		nlmsg_header->nlmsg_seq,
