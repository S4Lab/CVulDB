MotorolaMobilityLLC__kernel-msm
commit 8fd4e8e39be19ebea2791c33b5d9c50850d50081
Author:     Pratap Nirujogi <pratapn@codeaurora.org>
AuthorDate: Mon Feb 20 17:29:33 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Jun 6 03:06:25 2017 -0500

    msm: camera: cpp: Fixing Heap overflow in output buffer
    
    Issue:
    Missing bound check when writing into the output array
    buffer, which can lead to out-of-bound heap write.
    
    Fix:
    Addding hardcoded constant 8 in the MSM_OUTPUT_BUF_CNT
    macro and size check to the place where the array is
    accessed. Returning '0' if exceeds MSM_OUTPUT_BUF_CNT.
    Caller will return -EINVAL for '0'.
    
    CRs-Fixed: 2004036
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-8233
    
    Change-Id: I46cbf4f05851f359710bdadf0c1c62dd3bbc54c8
    Signed-off-by: Pratap Nirujogi <pratapn@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/993196
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c b/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c
index 544013435e3e..ca63e3439e8d 100644
--- a/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c
+++ b/drivers/media/platform/msm/camera_v2/pproc/cpp/msm_cpp.c
@@ -1857,6 +1857,8 @@ static int msm_cpp_check_buf_type(struct msm_buf_mngr_info *buff_mgr_info,
 			/* More or equal bufs as Input buffer */
 			num_output_bufs = new_frame->batch_info.batch_size;
 		}
+		if (num_output_bufs > MSM_OUTPUT_BUF_CNT)
+			return 0;
 		for (i = 0; i < num_output_bufs; i++) {
 			new_frame->output_buffer_info[i].index =
 				buff_mgr_info->user_buf.buf_idx[i];
diff --git a/include/media/msmb_pproc.h b/include/media/msmb_pproc.h
index 0e3cb8705688..c6e24bd6d630 100644
--- a/include/media/msmb_pproc.h
+++ b/include/media/msmb_pproc.h
@@ -22,6 +22,7 @@
 #define MSM_CPP_MAX_FRAME_LENGTH 4096
 #define MSM_CPP_MAX_FW_NAME_LEN 32
 #define MAX_FREQ_TBL 10
+#define MSM_OUTPUT_BUF_CNT 8
 
 enum msm_cpp_frame_type {
 	MSM_CPP_OFFLINE_FRAME,
@@ -407,7 +408,7 @@ struct msm_cpp_frame_info32_t {
 	uint32_t feature_mask;
 	uint8_t we_disable;
 	struct msm_cpp_buffer_info_t input_buffer_info;
-	struct msm_cpp_buffer_info_t output_buffer_info[8];
+	struct msm_cpp_buffer_info_t output_buffer_info[MSM_OUTPUT_BUF_CNT];
 	struct msm_cpp_buffer_info_t duplicate_buffer_info;
 	struct msm_cpp_buffer_info_t tnr_scratch_buffer_info[2];
 	uint32_t reserved;
