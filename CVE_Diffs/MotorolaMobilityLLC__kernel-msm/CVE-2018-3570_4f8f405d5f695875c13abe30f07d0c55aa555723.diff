MotorolaMobilityLLC__kernel-msm
commit 4f8f405d5f695875c13abe30f07d0c55aa555723
Author:     Mahesh Sivasubramanian <msivasub@codeaurora.org>
AuthorDate: Tue Nov 28 10:06:17 2017 -0700
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Jul 30 02:33:30 2018 -0500

    drivers: cpuidle: lpm-levels: Fix untrusted pointer dereference.
    
    The list_for_each macro was not used correctly, where the intermediate
    variable would be LIST_POISON, resulting in a untrusted pointer
    dereference. Switch to using list_for_each_entry_safe to for safe
    removal of a list entry.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2018-3570
    CRs-fixed: 2149165
    Bug: 72956998
    
    Change-Id: I0e0fd5dd9f251b5093d6e9d6335387512ec59249
    Signed-off-by: Mahesh Sivasubramanian <msivasub@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1191216
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/cpuidle/lpm-levels-of.c b/drivers/cpuidle/lpm-levels-of.c
index 94462340a4dd..25499aefc478 100644
--- a/drivers/cpuidle/lpm-levels-of.c
+++ b/drivers/cpuidle/lpm-levels-of.c
@@ -821,14 +821,12 @@ failed:
 
 void free_cluster_node(struct lpm_cluster *cluster)
 {
-	struct list_head *list;
 	int i;
+	struct lpm_cluster *cl, *m;
 
-	list_for_each(list, &cluster->child) {
-		struct lpm_cluster *n;
-		n = list_entry(list, typeof(*n), list);
-		list_del(list);
-		free_cluster_node(n);
+	list_for_each_entry_safe(cl, m, &cluster->child, list) {
+		list_del(&cl->list);
+		free_cluster_node(cl);
 	};
 
 	if (cluster->cpu) {
