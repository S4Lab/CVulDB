MotorolaMobilityLLC__kernel-msm
commit 9d53424ae4dd89e5bc5aeb9b9aa32122118064b1
Author:     Mohit Aggarwal <maggarwa@codeaurora.org>
AuthorDate: Mon Feb 12 12:33:44 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Feb 26 01:13:31 2018 -0600

    diag: Add protection while de-initializing clients
    
    Currently, while de-initializing clients, there is
    a possibility of using already freed memory. The
    patch adds proper protection to fix the issue.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-3561
    CRs-Fixed: 2068569
    BUG: 68870904
    
    Change-Id: I4b397a82e03fa2f1c84cfa8ca912cdb6a51ba08b
    Signed-off-by: Mohit Aggarwal <maggarwa@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1135416
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 2d27281f7990862ac9a1ad5d0a1b53ff1b32468e)

diff --git a/drivers/char/diag/diagchar_core.c b/drivers/char/diag/diagchar_core.c
index 4e77e37a4326..98401774d201 100644
--- a/drivers/char/diag/diagchar_core.c
+++ b/drivers/char/diag/diagchar_core.c
@@ -1349,14 +1349,18 @@ static int diag_ioctl_lsm_deinit(void)
 {
 	int i;
 
+	mutex_lock(&driver->diagchar_mutex);
 	for (i = 0; i < driver->num_clients; i++)
 		if (driver->client_map[i].pid == current->tgid)
 			break;
 
-	if (i == driver->num_clients)
+	if (i == driver->num_clients) {
+		mutex_unlock(&driver->diagchar_mutex);
 		return -EINVAL;
+	}
 
 	driver->data_ready[i] |= DEINIT_TYPE;
+	mutex_unlock(&driver->diagchar_mutex);
 	wake_up_interruptible(&driver->wait_q);
 
 	return 1;
