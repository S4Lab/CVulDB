MotorolaMobilityLLC__kernel-msm
commit 1e91b65ca67cbe0e886315a02c43f18bb4f833c5
Author:     David S. Miller <davem@davemloft.net>
AuthorDate: Fri May 1 22:02:47 2015 -0400
Commit:     Wendy Yan <wendy2@motorola.com>
CommitDate: Tue May 5 09:58:13 2015 -0500

    ipv4: Missing sk_nulls_node_init() in ping_unhash().
    
    ANDROID-20770158 (CVE-2015-3636)
    
    If we don't do that, then the poison value is left in the ->pprev
    backlink.
    
    This can cause crashes if we do a disconnect, followed by a connect().
    
    Tested-by: Linus Torvalds <torvalds@linux-foundation.org>
    Reported-by: Wen Xu <hotdog3645@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Andy Seah <dntc46@motorola.com>
    Change-Id: I582fdd3973ed85872d4af2622ef546fb29c63651
    Reviewed-on: http://gerrit.mot.com/744363
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Submit-Approved: Jira Key <jirakey@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Jeffrey Carlyle <jeff.carlyle@motorola.com>
    (cherry picked from commit 05eb72b5c35e41e78399166b80d923d2519b51c4)

diff --git a/net/ipv4/ping.c b/net/ipv4/ping.c
index b1ac867b5e21..1838b3accbfd 100644
--- a/net/ipv4/ping.c
+++ b/net/ipv4/ping.c
@@ -153,6 +153,7 @@ void ping_unhash(struct sock *sk)
 	if (sk_hashed(sk)) {
 		write_lock_bh(&ping_table.lock);
 		hlist_nulls_del(&sk->sk_nulls_node);
+		sk_nulls_node_init(&sk->sk_nulls_node);
 		sock_put(sk);
 		isk->inet_num = 0;
 		isk->inet_sport = 0;
