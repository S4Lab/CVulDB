MotorolaMobilityLLC__kernel-msm
commit d56aadb1d6640a06f5b66dd7121811172312c3e7
Author:     Walter Yang <yandongy@codeaurora.org>
AuthorDate: Thu May 11 14:13:26 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Aug 8 06:11:27 2017 -0500

    IKSIMP-4680: ASoC: Add backend user count checking
    
    Add backend user count checking to protect the index
    boundary.
    
    Mot-CRs-fixed: IKSIMP-4680
    CVE-fixed: CVE-2017-7369
    Bug-Id: A-33751424
    Change-Id: Ic1b61d1f7130252cc54da0b16553858714988dbd
    CRs-Fixed: 2009216
    Signed-off-by: Walter Yang <yandongy@codeaurora.org>
    Signed-off-by: Neeraj Kumar <neerajk@motorola.com>
    Reviewed-on: https://gerrit.mot.com/993014
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Varun Shrivastava <varunshrivastava@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    SME-Granted: Raja Phani K <a16821@motorola.com>
    Submit-Approved: Raja Phani K <a16821@motorola.com>

diff --git a/sound/soc/soc-compress.c b/sound/soc/soc-compress.c
index 026e51b5ed12..bec8016937a2 100644
--- a/sound/soc/soc-compress.c
+++ b/sound/soc/soc-compress.c
@@ -573,6 +573,11 @@ static int soc_compr_set_params_fe(struct snd_compr_stream *cstream,
 				cstream, &async_domain);
 			} else {
 				be_list[j++] = be;
+				if (j == DPCM_MAX_BE_USERS) {
+					dev_dbg(fe->dev,
+						"ASoC: MAX backend users!\n");
+					break;
+				}
 			}
 		}
 		for (i = 0; i < j; i++) {
diff --git a/sound/soc/soc-pcm.c b/sound/soc/soc-pcm.c
index 425250cc4a64..712ef982c271 100644
--- a/sound/soc/soc-pcm.c
+++ b/sound/soc/soc-pcm.c
@@ -1872,6 +1872,10 @@ void dpcm_be_dai_prepare_async(struct snd_soc_pcm_runtime *fe, int stream,
 							    dpcm, domain);
 		} else {
 			dpcm_async[i++] = dpcm;
+			if (i == DPCM_MAX_BE_USERS) {
+				dev_dbg(fe->dev, "ASoC: MAX backend users!\n");
+				break;
+			}
 		}
 	}
 
