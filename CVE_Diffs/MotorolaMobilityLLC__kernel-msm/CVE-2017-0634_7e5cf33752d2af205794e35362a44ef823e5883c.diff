MotorolaMobilityLLC__kernel-msm
commit 7e5cf33752d2af205794e35362a44ef823e5883c
Author:     Konstantin Makariev <kmakariev@motorola.com>
AuthorDate: Mon Apr 10 10:15:10 2017 -0500
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Tue Dec 5 10:44:21 2017 -0600

    input: synaptics_dsx: modify the attribute of rmidev
    
    1. Remove the read permission of rmidev attributes instead of calling
       synaptics_rmi4_show_error() which is only used to print warning logs.
    2. Correct the data structure that used in synaptics_rmi4_show_error()
       while printing the warning logs.
    
    MOT-CRs-Fixed: (CR)
    CVE-Fixed: CVE-2017-0634
    ANDROID-32511682
    
    Change-Id: I0e596ee29795c2e352b162c41f28973965d6300c
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/977619
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/input/touchscreen/synaptics_dsx_i2c.h b/drivers/input/touchscreen/synaptics_dsx_i2c.h
index ac9ad628ec1f..c52dc1b81d49 100644
--- a/drivers/input/touchscreen/synaptics_dsx_i2c.h
+++ b/drivers/input/touchscreen/synaptics_dsx_i2c.h
@@ -375,22 +375,6 @@ enum exp_fn {
 	RMI_LAST,
 };
 
-static inline ssize_t synaptics_rmi4_show_error(struct device *dev,
-		struct device_attribute *attr, char *buf)
-{
-	dev_warn(dev, "%s Attempted to read from write-only attribute %s\n",
-			__func__, attr->attr.name);
-	return -EPERM;
-}
-
-static inline ssize_t synaptics_rmi4_store_error(struct device *dev,
-		struct device_attribute *attr, const char *buf, size_t count)
-{
-	dev_warn(dev, "%s Attempted to write to read-only attribute %s\n",
-			__func__, attr->attr.name);
-	return -EPERM;
-}
-
 static inline void batohs(unsigned short *dest, unsigned char *src)
 {
 	*dest = src[1] * 0x100 + src[0];
@@ -602,6 +586,28 @@ struct synaptics_rmi4_data {
 #endif
 };
 
+static inline ssize_t synaptics_rmi4_show_error(struct device *dev,
+		struct device_attribute *attr, char *buf)
+{
+	struct synaptics_rmi4_data *rmi4_data = dev_get_drvdata(dev);
+
+	dev_warn(&rmi4_data->i2c_client->dev,
+			"%s Attempted to read from write-only attribute %s\n",
+			__func__, attr->attr.name);
+	return -EPERM;
+}
+
+static inline ssize_t synaptics_rmi4_store_error(struct device *dev,
+		struct device_attribute *attr, const char *buf, size_t count)
+{
+	struct synaptics_rmi4_data *rmi4_data = dev_get_drvdata(dev);
+
+	dev_warn(&rmi4_data->i2c_client->dev,
+			"%s Attempted to write to read-only attribute %s\n",
+			__func__, attr->attr.name);
+	return -EPERM;
+}
+
 struct time_keeping {
 	int id;
 	unsigned long long duration;
diff --git a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
index 9a222f919f2f..6088dca332fe 100644
--- a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
+++ b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
@@ -89,20 +89,20 @@ static struct bin_attribute attr_data = {
 
 static struct device_attribute attrs[] = {
 	__ATTR(open, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_open_store),
 	__ATTR(release, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_release_store),
 	__ATTR(address, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_address_store),
 	__ATTR(length, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_length_store),
 	__ATTR(attn_state, S_IRUSR | S_IRGRP,
 			rmidev_sysfs_attn_state_show,
-			synaptics_rmi4_store_error),
+			NULL),
 };
 
 static int rmidev_major_num;
