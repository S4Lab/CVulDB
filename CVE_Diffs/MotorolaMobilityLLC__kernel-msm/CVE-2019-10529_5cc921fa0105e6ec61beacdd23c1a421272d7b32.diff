MotorolaMobilityLLC__kernel-msm
commit 5cc921fa0105e6ec61beacdd23c1a421272d7b32
Author:     Rajesh Kemisetti <rajeshk@codeaurora.org>
AuthorDate: Tue Apr 30 19:04:30 2019 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Fri Sep 20 12:45:04 2019 -0500

    msm: kgsl: Fix race condition while making page as dirty
    
    set_page_dirty() is racy if the caller has no
    reference against page->mapping->host, and if
    the page is unlocked. This is because another
    CPU could truncate the page off the mapping and
    then free the mapping.
    
    Use set_page_dirty_lock() to avoid this race condition.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2019-10529
    CRs-Fixed: 2442261
    
    Signed-off-by: Rajesh Kemisetti <rajeshk@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Change-Id: I517fb9aee66560618c7676b311368f7a7498011f
    Reviewed-on: https://gerrit.mot.com/1367698
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Ling Jin <lingjin@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/gpu/msm/kgsl.c b/drivers/gpu/msm/kgsl.c
index eb4c29d535d5..596d17381799 100644
--- a/drivers/gpu/msm/kgsl.c
+++ b/drivers/gpu/msm/kgsl.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2008-2018, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2008-2019, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -327,7 +327,7 @@ kgsl_mem_entry_destroy(struct kref *kref)
 			    entry->memdesc.sgt->nents, i) {
 			page = sg_page(sg);
 			for (j = 0; j < (sg->length >> PAGE_SHIFT); j++)
-				set_page_dirty(nth_page(page, j));
+				set_page_dirty_lock(nth_page(page, j));
 		}
 	}
 
