MotorolaMobilityLLC__kernel-msm
commit 4c173642cfc7a45544a282e8a6cc579b094d88f9
Author:     Jianqiang Zhao <zhaojianqiang1@gmail.com>
AuthorDate: Thu Oct 12 17:30:24 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Wed Dec 13 23:38:15 2017 -0600

    ANDROID: input: keychord: fix race condition bug
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0862
    Bug: 36006779
    
    Change-Id: I9c7c759c99e21cad9a7f9a09128122bf6ae11302
    Signed-off-by: Jianqiang Zhao <zhaojianqiang1@gmail.com>
    Signed-off-by: Amarendra Reddy <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1073296
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 8cd6221a879bc88c2bd883f7b1a9e8aa6fb12575)

diff --git a/drivers/input/misc/keychord.c b/drivers/input/misc/keychord.c
index a5ea27ad0e16..22ba94703776 100644
--- a/drivers/input/misc/keychord.c
+++ b/drivers/input/misc/keychord.c
@@ -300,8 +300,10 @@ static ssize_t keychord_write(struct file *file, const char __user *buffer,
 
 	ret = input_register_handler(&kdev->input_handler);
 	if (ret) {
+		spin_lock_irqsave(&kdev->lock, flags);
 		kfree(keychords);
 		kdev->keychords = 0;
+		spin_unlock_irqrestore(&kdev->lock, flags);
 		return ret;
 	}
 	kdev->registered = 1;
