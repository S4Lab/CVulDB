MotorolaMobilityLLC__kernel-msm
commit a74e65c6b6d009aee5122c510a2018e842079e43
Author:     Tharun Kumar Merugu <mtharu@codeaurora.org>
AuthorDate: Tue Apr 17 17:53:40 2018 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Fri Aug 23 17:24:48 2019 +0800

    msm: adsprpc: destroy mutex before file free
    
    Destroy mutex before file free, to avoid use after free of mutex.
    
    Bug-id: A-119052960
    CRs-fixed: 2277735
    CVE-fixed: CVE-2018-11967
    Mot-CRs-fixed: (CR), (CR)
    
    Change-Id: I4ff73dc17b15043eacbb299219a379bfd1a8efa6
    Acked-by: Himateja Reddy <hmreddy@qti.qualcomm.com>
    Signed-off-by: Tharun Kumar Merugu <mtharu@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    (cherry picked from commit 1e74efda1df55e33ed966155668caed20fbc4b39)
    Reviewed-on: https://gerrit.mot.com/1335471
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Varun Shrivastava <varunshrivastava@motorola.com>
    Reviewed-by: Sindhu C <a12924@motorola.com>
    SLTApproved: Sindhu C <a12924@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/char/adsprpc.c b/drivers/char/adsprpc.c
index 66174f821b39..b158b5385826 100644
--- a/drivers/char/adsprpc.c
+++ b/drivers/char/adsprpc.c
@@ -1850,6 +1850,7 @@ static int fastrpc_file_free(struct fastrpc_file *fl)
 	if (fl->ssrcount == fl->apps->channel[cid].ssrcount)
 		kref_put_mutex(&fl->apps->channel[cid].kref,
 				fastrpc_channel_close, &fl->apps->smd_mutex);
+	mutex_destroy(&fl->map_mutex);
 	kfree(fl);
 	return 0;
 }
@@ -2003,7 +2004,6 @@ static int fastrpc_device_release(struct inode *inode, struct file *file)
 		}
 		me->pending_free++;
 		mutex_unlock(&me->flfree_mutex);
-		mutex_destroy(&fl->map_mutex);
 		file->private_data = NULL;
 	}
 bail:
