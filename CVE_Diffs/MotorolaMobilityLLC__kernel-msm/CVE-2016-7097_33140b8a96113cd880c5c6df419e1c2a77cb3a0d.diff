MotorolaMobilityLLC__kernel-msm
commit 33140b8a96113cd880c5c6df419e1c2a77cb3a0d
Author:     Cong Wang <xiyou.wangcong@gmail.com>
AuthorDate: Fri Mar 17 16:50:39 2017 +0530
Commit:     Amarendra Reddy <amarenr@motorola.com>
CommitDate: Tue Mar 21 23:56:52 2017 -0500

    FROMLIST: 9p: fix a potential acl leak
    
    (https://lkml.org/lkml/2016/12/13/579)
    
    posix_acl_update_mode() could possibly clear 'acl', if so
    we leak the memory pointed by 'acl'. Save this pointer
    before calling posix_acl_update_mode() and release the memory
    if 'acl' really gets cleared.
    
    Mot-CRs-fixed:(CR)
    CVE-Fixed:CVE-2016-7097
    Bug: 32458736
    
    Change-Id: Iea89236015b9688889a0d1bc812a60644bacd9d7
    Reported-by: Mark Salyzyn <salyzyn@android.com>
    Reviewed-by: Jan Kara <jack@suse.cz>
    Reviewed-by: Greg Kurz <groug@kaod.org>
    Cc: Eric Van Hensbergen <ericvh@gmail.com>
    Cc: Ron Minnich <rminnich@sandia.gov>
    Cc: Latchesar Ionkov <lucho@ionkov.net>
    Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
    Signed-off-by: Kanagarathina Kalathi <kalathik@motorola.com>
    Reviewed-on: https://gerrit.mot.com/964754
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/fs/9p/acl.c b/fs/9p/acl.c
index 9686c1f17653..c19a66472d2e 100644
--- a/fs/9p/acl.c
+++ b/fs/9p/acl.c
@@ -321,6 +321,7 @@ static int v9fs_xattr_set_acl(struct dentry *dentry, const char *name,
 		name = POSIX_ACL_XATTR_ACCESS;
 		if (acl) {
 			struct iattr iattr;
+			struct posix_acl *old_acl = acl;
 
 			retval = posix_acl_update_mode(inode, &iattr.ia_mode, &acl);
 			if (retval)
@@ -331,6 +332,7 @@ static int v9fs_xattr_set_acl(struct dentry *dentry, const char *name,
 				 * by the mode bits. So don't
 				 * update ACL.
 				 */
+				posix_acl_release(old_acl);
 				value = NULL;
 				size = 0;
 			}
