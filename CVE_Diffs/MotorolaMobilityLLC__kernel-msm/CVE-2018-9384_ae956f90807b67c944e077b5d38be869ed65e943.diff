MotorolaMobilityLLC__kernel-msm
commit ae956f90807b67c944e077b5d38be869ed65e943
Author:     Mark Rutland <mark.rutland@arm.com>
AuthorDate: Thu May 24 19:07:42 2018 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Wed Mar 13 21:26:07 2019 -0500

    UPSTREAM: arm64: smp: prepare for smp_processor_id() rework
    
    Subsequent patches will make smp_processor_id() use a percpu variable.
    This will make smp_processor_id() dependent on the percpu offset, and
    thus we cannot use smp_processor_id() to figure out what to initialise
    the offset to.
    
    Prepare for this by initialising the percpu offset based on
    current::cpu, which will work regardless of how smp_processor_id() is
    implemented. Also, make this relationship obvious by placing this code
    together at the start of secondary_start_kernel().
    
    CVE-fixed: CVE-2018-9384
    Bug: 74356909
    
    Signed-off-by: Mark Rutland <mark.rutland@arm.com>
    Tested-by: Laura Abbott <labbott@redhat.com>
    Cc: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    
    Bug: 66351489
    Change-Id: I203491669b8b42c46a89eeb251cbc5b00001afab
    (cherry picked from commit 580efaa7ccfb8c0790dce4396434f0e5ac8d86ee)
    Signed-off-by: Zubin Mithra <zsm@google.com>
    Reviewed-on: https://gerrit.mot.com/1232707
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/arch/arm64/kernel/smp.c b/arch/arm64/kernel/smp.c
index 45014bcebc62..944faf5031b2 100644
--- a/arch/arm64/kernel/smp.c
+++ b/arch/arm64/kernel/smp.c
@@ -137,7 +137,10 @@ static void smp_store_cpu_info(unsigned int cpuid)
 asmlinkage notrace void secondary_start_kernel(void)
 {
 	struct mm_struct *mm = &init_mm;
-	unsigned int cpu = smp_processor_id();
+	unsigned int cpu;
+
+	cpu = task_cpu(current);
+	set_my_cpu_offset(per_cpu_offset(cpu));
 
 	/*
 	 * All kernel threads share the same mm context; grab a
@@ -146,9 +149,6 @@ asmlinkage notrace void secondary_start_kernel(void)
 	atomic_inc(&mm->mm_count);
 	current->active_mm = mm;
 
-	set_my_cpu_offset(per_cpu_offset(smp_processor_id()));
-	pr_debug("CPU%u: Booted secondary processor\n", cpu);
-
 	/*
 	 * TTBR0 is only used for the identity mapping at this stage. Make it
 	 * point to zero page to avoid speculatively fetching new entries.
