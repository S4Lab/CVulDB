MotorolaMobilityLLC__kernel-msm
commit be67e2ba2aac7da992887f129c619d509cf4800e
Author:     Benjamin Chan <bkchan@codeaurora.org>
AuthorDate: Thu Dec 15 13:46:42 2016 -0500
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Aug 8 06:11:48 2017 -0500

    msm: mdss: Fix invalid dma attachment during fb shutdown
    
    If DMA attachment fail during fb_mmap, all ION memory will get free. It
    is necessary to reset the fbmem and fb_attachemnt pointer to NULL,
    otherwise during shutdown will perform another free and causing issue.
    
    Mot-CRs-fixed: IKSIMP-4775
    CVE-Fixed: CVE-2017-7373
    CRs-Fixed: 1090244
    Change-Id: I92affcf2ce039eecfc72b7c191e058f37815c726
    Signed-off-by: Benjamin Chan <bkchan@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/997381
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/video/msm/mdss/mdss_fb.c b/drivers/video/msm/mdss/mdss_fb.c
index 57e00e6561bf..f0627d5d437a 100644
--- a/drivers/video/msm/mdss/mdss_fb.c
+++ b/drivers/video/msm/mdss/mdss_fb.c
@@ -2119,6 +2119,8 @@ int mdss_fb_alloc_fb_ion_memory(struct msm_fb_data_type *mfd, size_t fb_size)
 
 fb_mmap_failed:
 	ion_free(mfd->fb_ion_client, mfd->fb_ion_handle);
+	mfd->fb_ion_handle = NULL;
+	mfd->fbmem_buf = NULL;
 	return rc;
 }
 
