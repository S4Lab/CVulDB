MotorolaMobilityLLC__kernel-msm
commit 6a1d3051c33256bf6d708658406c34ac17710c83
Author:     Siqi Lin <siqilin@google.com>
AuthorDate: Thu Dec 8 09:53:26 2016 +0530
Commit:     Neeraj Kumar <neerajk@motorola.com>
CommitDate: Thu Dec 22 23:06:36 2016 -0600

    ALSA: info: Check for integer overflow in snd_info_entry_write()
    
    snd_info_entry_write() resizes the buffer with an unsigned long
    size argument that gets truncated because resize_info_buffer()
    takes the size parameter as an unsigned int. On 64-bit kernels,
    this causes the following copy_to_user() to write out-of-bounds
    if (pos + count) can't be represented by an unsigned int.
    
    Bug: 32510733
    Mot-CRs-fixed: (CR), (CR)
    CVE-fixed: CVE-2017-0404
    Change-Id: I9e8b55f93f2bd606b4a73b5a4525b71ee88c7c23
    Signed-off-by: Siqi Lin <siqilin@google.com>
    ---
    
    Change-Id: Ie2517e1221178f440fb3b4f91a2e868310eb68c5
    Signed-off-by: Neeraj Kumar <neerajk@motorola.com>
    Reviewed-on: https://gerrit.mot.com/928914
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/sound/core/info.c b/sound/core/info.c
index 08070e1eefeb..332c9a1ef173 100644
--- a/sound/core/info.c
+++ b/sound/core/info.c
@@ -253,6 +253,7 @@ static ssize_t snd_info_entry_write(struct file *file, const char __user *buffer
 	struct snd_info_buffer *buf;
 	ssize_t size = 0;
 	loff_t pos;
+	unsigned long realloc_size;
 
 	data = file->private_data;
 	if (snd_BUG_ON(!data))
@@ -261,7 +262,8 @@ static ssize_t snd_info_entry_write(struct file *file, const char __user *buffer
 	pos = *offset;
 	if (pos < 0 || (long) pos != pos || (ssize_t) count < 0)
 		return -EIO;
-	if ((unsigned long) pos + (unsigned long) count < (unsigned long) pos)
+	realloc_size = (unsigned long) pos + (unsigned long) count;
+	if (realloc_size < (unsigned long) pos || realloc_size > UINT_MAX)
 		return -EIO;
 	switch (entry->content) {
 	case SNDRV_INFO_CONTENT_TEXT:
