MotorolaMobilityLLC__kernel-msm
commit 18d64bd83ab2a65da54758b8a0773607932a3033
Author:     Krishna Manikandan <mkrishn@codeaurora.org>
AuthorDate: Fri Jun 30 11:49:47 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Fri Dec 22 01:25:05 2017 -0600

    msm: mdss: Add check for fence count
    
    Add a check to ensure that the acquire fence count
    does not exceed the maximum possible value.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-11049
    Change-Id: I7198899be2d720214152d49fdbb6b6a69750fb3a
    Signed-off-by: Krishna Manikandan <mkrishn@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1093939
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Shi-Yong Li <a22381@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit b8a79e190af25490a5d7ebf4a069dca8fa692ddd)
    (cherry picked from commit c513535c68509aa4418adb88b5c929184e624170)

diff --git a/drivers/video/msm/mdss/mdss_mdp_layer.c b/drivers/video/msm/mdss/mdss_mdp_layer.c
index f2f10e944cfc..c9ca71c5d45a 100644
--- a/drivers/video/msm/mdss/mdss_mdp_layer.c
+++ b/drivers/video/msm/mdss/mdss_mdp_layer.c
@@ -2191,6 +2191,14 @@ int mdss_mdp_layer_pre_commit_wfd(struct msm_fb_data_type *mfd,
 		sync_pt_data = &mfd->mdp_sync_pt_data;
 		mutex_lock(&sync_pt_data->sync_mutex);
 		count = sync_pt_data->acq_fen_cnt;
+
+		if (count >= MDP_MAX_FENCE_FD) {
+			pr_err("Reached maximum possible value for fence count\n");
+			mutex_unlock(&sync_pt_data->sync_mutex);
+			rc = -EINVAL;
+			goto input_layer_err;
+		}
+
 		sync_pt_data->acq_fen[count] = fence;
 		sync_pt_data->acq_fen_cnt++;
 		mutex_unlock(&sync_pt_data->sync_mutex);
