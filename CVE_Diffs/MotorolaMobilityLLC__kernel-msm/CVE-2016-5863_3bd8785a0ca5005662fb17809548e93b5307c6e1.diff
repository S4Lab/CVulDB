MotorolaMobilityLLC__kernel-msm
commit 3bd8785a0ca5005662fb17809548e93b5307c6e1
Author:     Sriharsha Allenki <sallenki@codeaurora.org>
AuthorDate: Thu Dec 22 14:57:44 2016 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Sep 4 23:26:14 2017 -0500

    hid: usbhid: Changes to prevent buffer overflow
    
    Moved some value checks to right positions to prevent
    buffer flow, which may be possible before. Previously
    these value checks are in an else statement which may
    not be executed.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2016-5863
    Bug : 36251182
    
    Change-Id: I02dbecd074183581a6bdae6377097bc004bd3d3c
    CRs-fixed: 1102936
    Signed-off-by: Sriharsha Allenki <sallenki@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1017065
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit c99ffe4c2694ac83a3bb5cbcbbbd0d68b673e544)

diff --git a/drivers/hid/usbhid/hiddev.c b/drivers/hid/usbhid/hiddev.c
index 2f1ddca6f2e0..602f16373179 100644
--- a/drivers/hid/usbhid/hiddev.c
+++ b/drivers/hid/usbhid/hiddev.c
@@ -510,18 +510,19 @@ static noinline int hiddev_ioctl_usage(struct hiddev *hiddev, unsigned int cmd,
 				goto inval;
 
 			field = report->field[uref->field_index];
+		}
 
-			if (cmd == HIDIOCGCOLLECTIONINDEX) {
-				if (uref->usage_index >= field->maxusage)
-					goto inval;
-			} else if (uref->usage_index >= field->report_count)
+		if (cmd == HIDIOCGCOLLECTIONINDEX) {
+			if (uref->usage_index >= field->maxusage)
 				goto inval;
+		} else if (uref->usage_index >= field->report_count)
+			goto inval;
 
-			else if ((cmd == HIDIOCGUSAGES || cmd == HIDIOCSUSAGES) &&
-				 (uref_multi->num_values > HID_MAX_MULTI_USAGES ||
-				  uref->usage_index + uref_multi->num_values > field->report_count))
-				goto inval;
-		}
+		else if ((cmd == HIDIOCGUSAGES || cmd == HIDIOCSUSAGES) &&
+			 (uref_multi->num_values > HID_MAX_MULTI_USAGES ||
+			uref->usage_index + uref_multi->num_values >
+			field->report_count))
+			goto inval;
 
 		switch (cmd) {
 		case HIDIOCGUSAGE:
