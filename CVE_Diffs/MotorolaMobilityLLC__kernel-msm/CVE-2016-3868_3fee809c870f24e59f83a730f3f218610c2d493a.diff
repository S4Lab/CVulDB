MotorolaMobilityLLC__kernel-msm
commit 3fee809c870f24e59f83a730f3f218610c2d493a
Author:     Venkat Arcot <venkat@motorola.com>
AuthorDate: Tue Aug 23 10:11:46 2016 -0500
Commit:     Venkat Arcot <venkat@motorola.com>
CommitDate: Wed Aug 31 16:00:00 2016 +0000

    Android Secutiry September 2016 bulletin
    
    CVE-2016-3868 - Elevation of privilege vulnerability in Qualcomm powerdriver
    (cherry picked from commit 6752c52730361069f73b62d3ffcd72d911c498f1)
    
    Change-Id: I6b5ad08e596b2ee8de59b0bb4a2ea7dd4f63ea18

diff --git a/drivers/power/qcom/debug_core.c b/drivers/power/qcom/debug_core.c
index bee8a5994359..af839030183b 100644
--- a/drivers/power/qcom/debug_core.c
+++ b/drivers/power/qcom/debug_core.c
@@ -21,6 +21,8 @@
 #include <linux/cpu.h>
 
 #define MAX_PSTATES 20
+#define NUM_OF_PENTRY 3 /* number of variables for ptable node */
+#define NUM_OF_EENTRY 2 /* number of variables for enable node */
 
 enum arg_offset {
 	CPU_OFFSET,
@@ -130,13 +132,15 @@ static void add_to_ptable(uint64_t *arg)
 		node->ptr->len = node->len;
 }
 
-static int split_ptable_args(char *line, uint64_t *arg)
+static int split_ptable_args(char *line, uint64_t *arg, uint32_t n)
 {
 	char *args;
 	int i;
 	int ret = 0;
 
-	for (i = 0; line; i++) {
+	for (i = 0; i < n; i++) {
+		if (!line)
+			break;
 		args = strsep(&line, " ");
 		ret = kstrtoull(args, 10, &arg[i]);
 	}
@@ -162,7 +166,7 @@ static ssize_t msm_core_ptable_write(struct file *file,
 		goto done;
 	}
 	kbuf[len] = '\0';
-	ret = split_ptable_args(kbuf, arg);
+	ret = split_ptable_args(kbuf, arg, NUM_OF_PENTRY);
 	if (!ret) {
 		add_to_ptable(arg);
 		ret = len;
@@ -225,7 +229,7 @@ static ssize_t msm_core_enable_write(struct file *file,
 		goto done;
 	}
 	kbuf[len] = '\0';
-	ret = split_ptable_args(kbuf, arg);
+	ret = split_ptable_args(kbuf, arg, NUM_OF_EENTRY);
 	if (ret)
 		goto done;
 	cpu = arg[CPU_OFFSET];
