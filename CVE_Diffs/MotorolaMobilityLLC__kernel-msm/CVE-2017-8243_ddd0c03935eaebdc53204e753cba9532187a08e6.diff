MotorolaMobilityLLC__kernel-msm
commit ddd0c03935eaebdc53204e753cba9532187a08e6
Author:     Kishor PK <kpbhat@codeaurora.org>
AuthorDate: Thu Mar 30 14:23:37 2017 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Mar 12 16:31:38 2018 +0800

    soc: qcom: pil: Avoid possible buffer overflow during Modem boot
    
    Buffer overflow can occur if MBA firmware size exceeds 1MB.
    So validate size before copying the firmware.
    
    Mot-CRs-fixed:(CR)
    CVE-Fixed:CVE-2017-8243
    CRs-Fixed: 2001803
    
    Change-Id: I070ddf85fbc47df072e7258369272366262ebf46
    Signed-off-by: Kishor PK <kpbhat@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1004445
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    (cherry picked from commit 8b5078c4329d9e71bd36cc818003262b5d4f8aae)

diff --git a/drivers/soc/qcom/pil-msa.c b/drivers/soc/qcom/pil-msa.c
index ad57f634fd9a..a800adbe7de4 100644
--- a/drivers/soc/qcom/pil-msa.c
+++ b/drivers/soc/qcom/pil-msa.c
@@ -597,7 +597,15 @@ int pil_mss_reset_load_mba(struct pil_desc *pil)
 
 	/* Load the MBA image into memory */
 	count = fw->size;
-	memcpy(mba_dp_virt, data, count);
+	if (count <= SZ_1M) {
+		/* Ensures memcpy is done for max 1MB fw size */
+		memcpy(mba_dp_virt, data, count);
+	} else {
+		dev_err(pil->dev, "%s fw image loading into memory is failed due to fw size overflow\n",
+			__func__);
+		 ret = -EINVAL;
+		 goto err_mba_data;
+	}
 	/* Ensure memcpy of the MBA memory is done before loading the DP */
 	wmb();
 
