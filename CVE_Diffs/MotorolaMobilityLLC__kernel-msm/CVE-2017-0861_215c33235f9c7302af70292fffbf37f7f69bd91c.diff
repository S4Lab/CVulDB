MotorolaMobilityLLC__kernel-msm
commit 215c33235f9c7302af70292fffbf37f7f69bd91c
Author:     Robb Glasser <rglasser@google.com>
AuthorDate: Fri Aug 11 11:33:31 2017 -0700
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Sun Apr 15 23:23:37 2018 -0500

    ALSA: pcm: prevent UAF in snd_pcm_info
    
    When the device descriptor is closed, the `substream->runtime` pointer
    is freed. But another thread may be in the ioctl handler, case
    SNDRV_CTL_IOCTL_PCM_INFO. This case calls snd_pcm_info_user() which
    calls snd_pcm_info() which accesses the now freed `substream->runtime`.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed:  CVE-2017-0861
    Bug: 36006981
    Signed-off-by: Robb Glasser <rglasser@google.com>
    Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
    Change-Id: I445d24bc21dc0af6d9522a8daabe64969042236a
    Reviewed-on: https://gerrit.mot.com/1073270
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Guobin Zhang <zhanggb@motorola.com>
    Submit-Approved: Jira Key

diff --git a/sound/core/pcm.c b/sound/core/pcm.c
index 9c2b7bdafdb8..9c3d5c522248 100644
--- a/sound/core/pcm.c
+++ b/sound/core/pcm.c
@@ -150,7 +150,9 @@ static int snd_pcm_control_ioctl(struct snd_card *card,
 				err = -ENXIO;
 				goto _error;
 			}
+			mutex_lock(&pcm->open_mutex);
 			err = snd_pcm_info_user(substream, info);
+			mutex_unlock(&pcm->open_mutex);
 		_error:
 			mutex_unlock(&register_mutex);
 			return err;
@@ -158,7 +160,6 @@ static int snd_pcm_control_ioctl(struct snd_card *card,
 	case SNDRV_CTL_IOCTL_PCM_PREFER_SUBDEVICE:
 		{
 			int val;
-			
 			if (get_user(val, (int __user *)arg))
 				return -EFAULT;
 			control->prefer_pcm_subdevice = val;
