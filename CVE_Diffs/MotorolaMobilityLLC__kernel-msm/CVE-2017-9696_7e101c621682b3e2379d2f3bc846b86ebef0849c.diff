MotorolaMobilityLLC__kernel-msm
commit 7e101c621682b3e2379d2f3bc846b86ebef0849c
Author:     Gaoxiang Chen <gaochen@codeaurora.org>
AuthorDate: Wed May 17 16:14:20 2017 +0800
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Nov 21 07:09:10 2017 -0600

    msm: camera: validate num_streams in stream_cfg_cmd before using it
    
    stream_cfg_cmd->num_streams is from userspace,
    need to check it against MSM_ISP_STATS_MAX before using it.
    
    CRs-Fixed: 2029867
    CVE-fixed: CVE-2017-9696
    Mot-CRs-fixed: (CR)
    
    Change-Id: I2ab892b7d406fc56de94c261a396866269e91d1a
    Signed-off-by: Gaoxiang Chen <gaochen@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1029214
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c b/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c
index 8d2d8e7808c8..055bf75ef27b 100644
--- a/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c
+++ b/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c
@@ -857,6 +857,12 @@ int msm_isp_cfg_stats_stream(struct vfe_device *vfe_dev, void *arg)
 	if (vfe_dev->stats_data.num_active_stream == 0)
 		vfe_dev->hw_info->vfe_ops.stats_ops.cfg_ub(vfe_dev);
 
+	if (stream_cfg_cmd->num_streams > MSM_ISP_STATS_MAX) {
+		pr_err("%s invalid num_streams %d\n", __func__,
+			stream_cfg_cmd->num_streams);
+		return -EINVAL;
+	}
+
 	if (stream_cfg_cmd->enable) {
 		msm_isp_stats_update_cgc_override(vfe_dev, stream_cfg_cmd);
 
diff --git a/drivers/media/platform/msm/camera_v2_2016/isp/msm_isp_stats_util.c b/drivers/media/platform/msm/camera_v2_2016/isp/msm_isp_stats_util.c
index a56d8613b961..f89a26952ab1 100644
--- a/drivers/media/platform/msm/camera_v2_2016/isp/msm_isp_stats_util.c
+++ b/drivers/media/platform/msm/camera_v2_2016/isp/msm_isp_stats_util.c
@@ -856,6 +856,12 @@ int msm_isp_cfg_stats_stream(struct vfe_device *vfe_dev, void *arg)
 	if (vfe_dev->stats_data.num_active_stream == 0)
 		vfe_dev->hw_info->vfe_ops.stats_ops.cfg_ub(vfe_dev);
 
+	if (stream_cfg_cmd->num_streams > MSM_ISP_STATS_MAX) {
+		pr_err("%s invalid num_streams %d\n", __func__,
+			stream_cfg_cmd->num_streams);
+		return -EINVAL;
+	}
+
 	if (stream_cfg_cmd->enable) {
 		msm_isp_stats_update_cgc_override(vfe_dev, stream_cfg_cmd);
 
