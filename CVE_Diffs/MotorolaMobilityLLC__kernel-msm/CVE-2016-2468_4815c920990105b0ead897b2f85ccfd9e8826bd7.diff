MotorolaMobilityLLC__kernel-msm
commit 4815c920990105b0ead897b2f85ccfd9e8826bd7
Author:     Zhao Xuewen <zhaoxuewen@huawei.com>
AuthorDate: Tue Jun 7 19:34:02 2016 +0800
Commit:     Zhao Xuewen <zhaoxuewen@huawei.com>
CommitDate: Tue Jun 7 19:34:02 2016 +0800

    msm: kgsl: Add missing check for alloc size
    
    In _kgsl_sharedmem_page_alloc(), check for boundary limits
    of requested alloc size before honoring.
    
    CVE:CVE-2016-2468 Bug:ANDROID-27475454
    
    Change-Id: I8b9e225e515a0f31593df6f4cad253236475d0ae
    Signed-off-by: Rajesh Kemisetti <rajeshk@codeaurora.org>

diff --git a/drivers/gpu/msm/kgsl_sharedmem.c b/drivers/gpu/msm/kgsl_sharedmem.c
index b62c3a39b6a1..13006f9c7ac1 100644
--- a/drivers/gpu/msm/kgsl_sharedmem.c
+++ b/drivers/gpu/msm/kgsl_sharedmem.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2002,2007-2014, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2002,2007-2014,2016, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -576,6 +576,10 @@ _kgsl_sharedmem_page_alloc(struct kgsl_memdesc *memdesc,
 	unsigned int align;
 	int step = ((VMALLOC_END - VMALLOC_START)/8) >> PAGE_SHIFT;
 
+	size = PAGE_ALIGN(size);
+	if (size == 0 || size > UINT_MAX)
+		return -EINVAL;
+
 	align = (memdesc->flags & KGSL_MEMALIGN_MASK) >> KGSL_MEMALIGN_SHIFT;
 
 	page_size = get_page_size(size, align);
