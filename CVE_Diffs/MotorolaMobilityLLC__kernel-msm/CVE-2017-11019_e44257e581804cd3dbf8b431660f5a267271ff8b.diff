MotorolaMobilityLLC__kernel-msm
commit e44257e581804cd3dbf8b431660f5a267271ff8b
Author:     Krishna Manikandan <mkrishn@codeaurora.org>
AuthorDate: Wed Jun 28 13:53:04 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Fri Dec 22 00:17:08 2017 -0600

    fbdev: msm: Allocate fd with O_CLOEXEC flag
    
    When fd is requested during get_metadata call, create fd
    using O_CLOEXEC flag.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-11019
    
    CRs-Fixed: 2030638
    Change-Id: I1c874f713a3ebada63ba2c85f021aa78b04af44b
    Signed-off-by: Krishna Manikandan <mkrishn@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1093935
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Shi-Yong Li <a22381@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 7a9d9c36cc3fb293dde322991f3e165d74a48bc7)
    (cherry picked from commit a627699db81f73fbebc1a2dfeeac780d293f3889)

diff --git a/drivers/video/msm/mdss/mdss_mdp_overlay.c b/drivers/video/msm/mdss/mdss_mdp_overlay.c
index d9f8e2f15770..fcf81753cdc0 100644
--- a/drivers/video/msm/mdss/mdss_mdp_overlay.c
+++ b/drivers/video/msm/mdss/mdss_mdp_overlay.c
@@ -4499,10 +4499,11 @@ static int mdss_fb_get_metadata(struct msm_fb_data_type *mfd,
 		ret = mdss_fb_get_hw_caps(mfd, &metadata->data.caps);
 		break;
 	case metadata_op_get_ion_fd:
-		if (mfd->fb_ion_handle) {
+		if (mfd->fb_ion_handle && mfd->fb_ion_client) {
 			get_dma_buf(mfd->fbmem_buf);
 			metadata->data.fbmem_ionfd =
-				dma_buf_fd(mfd->fbmem_buf, 0);
+				ion_share_dma_buf_fd(mfd->fb_ion_client,
+					mfd->fb_ion_handle);
 			if (metadata->data.fbmem_ionfd < 0) {
 				dma_buf_put(mfd->fbmem_buf);
 				pr_err("fd allocation failed. fd = %d\n",
