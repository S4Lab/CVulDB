MotorolaMobilityLLC__kernel-msm
commit b2cca2826b97e2bf88469348536e908550a78567
Author:     Trishansh Bhardwaj <tbhardwa@codeaurora.org>
AuthorDate: Fri Apr 7 11:16:29 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Oct 31 00:41:44 2017 -0500

    msm: camera: Allow driver file to be opend only once.
    
    Use proper synchronization to ensure driver file is opened
    only once.
    
    CRs-Fixed: 2023513
    CVE-fixed: CVE-2017-8247
    Mot-CRs-fixed: (CR)
    
    Change-Id: I71e55e2d487fe561d3f596590b3e8102c5e921b5
    Signed-off-by: Trishansh Bhardwaj <tbhardwa@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1014307
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Robert Kubicki <w17311@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit f56e4beca305e8a17174b8c2d4326710c9ca2439)

diff --git a/drivers/media/platform/msm/camera_v2/msm.c b/drivers/media/platform/msm/camera_v2/msm.c
index 25f0c98c1e83..bdc7b7b23f13 100644
--- a/drivers/media/platform/msm/camera_v2/msm.c
+++ b/drivers/media/platform/msm/camera_v2/msm.c
@@ -896,11 +896,9 @@ static int msm_open(struct file *filep)
 	BUG_ON(!pvdev);
 
 	/* !!! only ONE open is allowed !!! */
-	if (atomic_read(&pvdev->opened))
+	if (atomic_cmpxchg(&pvdev->opened, 0, 1))
 		return -EBUSY;
 
-	atomic_set(&pvdev->opened, 1);
-
 	spin_lock_irqsave(&msm_pid_lock, flags);
 	msm_pid = get_pid(task_pid(current));
 	spin_unlock_irqrestore(&msm_pid_lock, flags);
