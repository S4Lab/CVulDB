MotorolaMobilityLLC__kernel-msm
commit 2fc8fd58890179abcaa1a8f7ec9391cd4b5195c4
Author:     Kasin Li <donglil@codeaurora.org>
AuthorDate: Wed Feb 22 18:25:36 2017 +0800
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Mar 12 16:31:53 2018 +0800

    drm/msm: Fix potential buffer overflow issue
    
    In function submit_create, if nr_cmds or nr_bos is assigned with
    negative value, the allocated buffer may be small than intended.
    Using this buffer will lead to buffer overflow issue.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-8250
    
    Change-Id: I0b61cccffd836e2dd3c859446470af4b6451b9ed
    Signed-off-by: Kasin Li <donglil@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1044676
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/gpu/drm/msm/msm_gem_submit.c b/drivers/gpu/drm/msm/msm_gem_submit.c
index 3240b12df544..4a9fce747932 100644
--- a/drivers/gpu/drm/msm/msm_gem_submit.c
+++ b/drivers/gpu/drm/msm/msm_gem_submit.c
@@ -34,12 +34,15 @@ static inline void __user *to_user_ptr(u64 address)
 }
 
 static struct msm_gem_submit *submit_create(struct drm_device *dev,
-		struct msm_gpu *gpu, int nr_cmds, int nr_bos)
+		struct msm_gpu *gpu, uint32_t nr_cmds, uint32_t nr_bos)
 {
 	struct msm_gem_submit *submit;
-	int sz = sizeof(*submit) + (nr_bos * sizeof(submit->bos[0])) +
+	uint64_t sz = sizeof(*submit) + (nr_bos * sizeof(submit->bos[0])) +
 		(nr_cmds * sizeof(submit->cmd[0]));
 
+	if (sz > SIZE_MAX)
+		return NULL;
+
 	submit = kmalloc(sz, GFP_TEMPORARY | __GFP_NOWARN | __GFP_NORETRY);
 	if (submit) {
 		submit->dev = dev;
