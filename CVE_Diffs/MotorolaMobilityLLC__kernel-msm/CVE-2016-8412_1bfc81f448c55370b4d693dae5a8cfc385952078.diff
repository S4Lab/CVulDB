MotorolaMobilityLLC__kernel-msm
commit 1bfc81f448c55370b4d693dae5a8cfc385952078
Author:     VijayaKumar T M <vtmuni@codeaurora.org>
AuthorDate: Mon Nov 7 15:19:06 2016 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Feb 13 02:44:41 2017 -0600

    msm: sensor: Adding mutex for actuator power down operations
    
    Protecting operations performed during actuator power down
    from race condition by adding mutex
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2016-8412.
    
    CRs-Fixed: 1071891
    Change-Id: I7d6b2e8878788615c02678a4a28d31dca0ed6bca
    Signed-off-by: Sureshnaidu Laveti <lsuresh@codeaurora.org>
    Signed-off-by: VijayaKumar T M <vtmuni@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    (cherry picked from commit 38f5f7c86a545024c9106ede2cad119c646e85c8)
    Reviewed-on: https://gerrit.mot.com/929167
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    (cherry picked from commit 5a0df646aa12742ee6c61e9dded7689d3ea26229)

diff --git a/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c b/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
index 58f6ea3ba56f..2a6c819d2c1e 100644
--- a/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
+++ b/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
@@ -1618,11 +1618,13 @@ static long msm_actuator_subdev_ioctl(struct v4l2_subdev *sd,
 			pr_err("a_ctrl->i2c_client.i2c_func_tbl NULL\n");
 			return -EINVAL;
 		} else {
+			mutex_lock(a_ctrl->actuator_mutex);
 			rc = msm_actuator_power_down(a_ctrl);
 			if (rc < 0) {
 				pr_err("%s:%d Actuator Power down failed\n",
 					__func__, __LINE__);
 			}
+			mutex_unlock(a_ctrl->actuator_mutex);
 			return msm_actuator_close(sd, NULL);
 		}
 	default:
