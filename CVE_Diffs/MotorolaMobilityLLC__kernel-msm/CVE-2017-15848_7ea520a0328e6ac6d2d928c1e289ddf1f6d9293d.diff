MotorolaMobilityLLC__kernel-msm
commit 7ea520a0328e6ac6d2d928c1e289ddf1f6d9293d
Author:     Tharun Kumar Merugu <mtharu@codeaurora.org>
AuthorDate: Fri Dec 22 01:27:36 2017 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Sun Apr 15 23:23:38 2018 -0500

    msm: ADSPRPC: validate user buffers after copying from user
    
    validate user buffers before accessing in kernel driver.
    
    CVE-fixed: CVE-2017-15848
    Mot-CRs-fixed: (CR)
    Bug-Id: A-67713083
    CRs-Fixed: 2073777
    Change-Id: I7997d069d0549de03f1467c63bdb81b20fcf3d6c
    Acked-by: Chenna Kesava Raju <chennak@qti.qualcomm.com>
    Signed-off-by: Tharun Kumar Merugu <mtharu@codeaurora.org>
    
    Signed-off-by: Neeraj Kumar <neerajk@motorola.com>
    Change-Id: I8933700e8d68205fdcc7e39f2edb921e21c82027
    Reviewed-on: https://gerrit.mot.com/1108040
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Yuesheng Huang <huangys@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/char/adsprpc.c b/drivers/char/adsprpc.c
index cbed3c2d795f..0628506fa4d3 100644
--- a/drivers/char/adsprpc.c
+++ b/drivers/char/adsprpc.c
@@ -1763,6 +1763,10 @@ static long fastrpc_device_ioctl(struct file *file, unsigned int ioctl_num,
 		break;
 	case FASTRPC_IOCTL_INIT:
 		K_COPY_FROM_USER(err, 0, &p.init, param, sizeof(p.init));
+		if (err)
+			goto bail;
+		VERIFY(err, p.init.filelen >= 0 &&
+			p.init.memlen >= 0);
 		if (err)
 			goto bail;
 		VERIFY(err, 0 == fastrpc_init_process(fl, &p.init));
