MotorolaMobilityLLC__kernel-msm
commit fec29d766d29e03cc37c5404c72286bd4e60edb2
Author:     Trishansh Bhardwaj <tbhardwa@codeaurora.org>
AuthorDate: Fri Apr 7 11:16:29 2017 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Mar 12 16:32:00 2018 +0800

    msm: camera: Allow driver file to be opend only once.
    
    Use proper synchronization to ensure driver file is opened
    only once.
    
    CRs-Fixed: 2023513
    CVE-fixed: CVE-2017-8247
    Mot-CRs-fixed: (CR)
    
    Change-Id: I71e55e2d487fe561d3f596590b3e8102c5e921b5
    Signed-off-by: Trishansh Bhardwaj <tbhardwa@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1014302
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Robert Kubicki <w17311@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 2a6c8ec0c737e60085d2cdaf230afa5b2261e43a)

diff --git a/drivers/media/platform/msm/camera_v2/msm.c b/drivers/media/platform/msm/camera_v2/msm.c
index a140afc599d4..0219efd6bd39 100644
--- a/drivers/media/platform/msm/camera_v2/msm.c
+++ b/drivers/media/platform/msm/camera_v2/msm.c
@@ -997,11 +997,9 @@ static int msm_open(struct file *filep)
 	BUG_ON(!pvdev);
 
 	/* !!! only ONE open is allowed !!! */
-	if (atomic_read(&pvdev->opened))
+	if (atomic_cmpxchg(&pvdev->opened, 0, 1))
 		return -EBUSY;
 
-	atomic_set(&pvdev->opened, 1);
-
 	spin_lock_irqsave(&msm_pid_lock, flags);
 	msm_pid = get_pid(task_pid(current));
 	spin_unlock_irqrestore(&msm_pid_lock, flags);
diff --git a/drivers/media/platform/msm/camera_v2_2016/msm.c b/drivers/media/platform/msm/camera_v2_2016/msm.c
index 6bd178c32c99..3b97739c4f72 100644
--- a/drivers/media/platform/msm/camera_v2_2016/msm.c
+++ b/drivers/media/platform/msm/camera_v2_2016/msm.c
@@ -997,11 +997,9 @@ static int msm_open(struct file *filep)
 	BUG_ON(!pvdev);
 
 	/* !!! only ONE open is allowed !!! */
-	if (atomic_read(&pvdev->opened))
+	if (atomic_cmpxchg(&pvdev->opened, 0, 1))
 		return -EBUSY;
 
-	atomic_set(&pvdev->opened, 1);
-
 	spin_lock_irqsave(&msm_pid_lock, flags);
 	msm_pid = get_pid(task_pid(current));
 	spin_unlock_irqrestore(&msm_pid_lock, flags);
