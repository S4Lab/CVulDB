MotorolaMobilityLLC__kernel-msm
commit 1796339249915720975b6424088b20b696d4581a
Author:     Vidyakumar Athota <vathota@codeaurora.org>
AuthorDate: Thu Sep 14 15:16:52 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Nov 2 04:33:35 2017 -0500

    ASoC: msm: qdsp6v2: add size check to fix out of bounds issue
    
    Before calling audio calibration ioctl functions, compare the
    allocated buffer size to the size of the header and cal type header
    to ensure the buffer is big enough.
    
    CVE-fixed: CVE-2017-11046
    Mot-CRs-fixed: (CR)
    Bug-Id: A-37623773
    CRs-Fixed: 2059656
    Change-Id: I601bb37ddcc34d459c207cf579f29744fe912d7b
    Signed-off-by: Vidyakumar Athota <vathota@codeaurora.org>
    ---
    Reviewed-on: https://gerrit.mot.com/1058337
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    
    (cherry picked from commit 5b468cb2d84d36bef0356a8af8cd2227536d1452)

diff --git a/sound/soc/msm/qdsp6v2/audio_calibration.c b/sound/soc/msm/qdsp6v2/audio_calibration.c
index c8806481ed03..8daf47be1715 100644
--- a/sound/soc/msm/qdsp6v2/audio_calibration.c
+++ b/sound/soc/msm/qdsp6v2/audio_calibration.c
@@ -457,6 +457,12 @@ static long audio_cal_shared_ioctl(struct file *file, unsigned int cmd,
 			data->cal_type.cal_hdr.buffer_number);
 		ret = -EINVAL;
 		goto done;
+	} else if ((data->hdr.cal_type_size + sizeof(data->hdr)) > size) {
+		pr_err("%s: cal type hdr size %zd + cal type size %d is greater than user buffer size %d\n",
+			__func__, sizeof(data->hdr), data->hdr.cal_type_size,
+			size);
+		ret = -EFAULT;
+		goto done;
 	}
 
 
@@ -494,13 +500,7 @@ static long audio_cal_shared_ioctl(struct file *file, unsigned int cmd,
 			goto unlock;
 		if (data == NULL)
 			goto unlock;
-		if ((sizeof(data->hdr) + data->hdr.cal_type_size) > size) {
-			pr_err("%s: header size %zd plus cal type size %d are greater than data buffer size %d\n",
-				__func__, sizeof(data->hdr),
-				data->hdr.cal_type_size, size);
-			ret = -EFAULT;
-			goto unlock;
-		} else if (copy_to_user((void *)arg, data,
+		if (copy_to_user(arg, data,
 			sizeof(data->hdr) + data->hdr.cal_type_size)) {
 			pr_err("%s: Could not copy cal type to user\n",
 				__func__);
