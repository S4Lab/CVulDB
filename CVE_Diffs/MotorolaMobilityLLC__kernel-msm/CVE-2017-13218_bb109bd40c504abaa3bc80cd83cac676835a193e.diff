MotorolaMobilityLLC__kernel-msm
commit bb109bd40c504abaa3bc80cd83cac676835a193e
Author:     Greg Hackmann <ghackmann@google.com>
AuthorDate: Wed Oct 4 09:31:34 2017 -0700
Commit:     Amarendra Reddy <amarenr@motorola.com>
CommitDate: Wed Dec 13 03:09:30 2017 -0600

    arm64: issue isb when trapping CNTVCT_EL0 access
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-13218
    Bug: 68266545
    
    Change-Id: I6005a6e944494257bfc2243fde2f7a09c3fd76c6
    Signed-off-by: amarenr <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1102065
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/arch/arm64/kernel/traps.c b/arch/arm64/kernel/traps.c
index 062bd5f0f9d4..0d9beb809fd5 100644
--- a/arch/arm64/kernel/traps.c
+++ b/arch/arm64/kernel/traps.c
@@ -33,6 +33,7 @@
 #include <linux/syscalls.h>
 
 #include <asm/atomic.h>
+#include <asm/barrier.h>
 #include <asm/bug.h>
 #include <asm/debug-monitors.h>
 #include <asm/esr.h>
@@ -443,6 +444,7 @@ static void cntvct_read_handler(unsigned int esr, struct pt_regs *regs)
 {
 	int rt = (esr & ESR_ELx_SYS64_ISS_RT_MASK) >> ESR_ELx_SYS64_ISS_RT_SHIFT;
 
+	isb();
 	if (rt != 31)
 		regs->regs[rt] = arch_counter_get_cntvct();
 	regs->pc += 4;
