MotorolaMobilityLLC__kernel-msm
commit 99daf5037ae78e41cf14d24995adeab17d054291
Author:     Eric Dumazet <edumazet@google.com>
AuthorDate: Mon May 21 19:48:56 2018 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Thu Nov 28 17:31:28 2019 +0800

    ipv6: fix possible mem leaks in ipv6_make_skb()
    
    [ Upstream commit 862c03ee1deb7e19e0f9931682e0294ecd1fcaf9 ]
    
    ip6_setup_cork() might return an error, while memory allocations have
    been done and must be rolled back.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2018-9389
    Bug: 65023306
    
    Fixes: 6422398c2ab0 ("ipv6: introduce ipv6_make_skb")
    Bug: 65023306
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Reported-by: Mike Maloney <maloney@google.com>
    Acked-by:  Mike Maloney <maloney@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Change-Id: I871e0c9018bc05f187724a863feaec23d8b15773
    Reviewed-on: https://gerrit.mot.com/1181377
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/net/ipv6/ip6_output.c b/net/ipv6/ip6_output.c
index a8737305748a..6cf6a6987dfd 100644
--- a/net/ipv6/ip6_output.c
+++ b/net/ipv6/ip6_output.c
@@ -1781,8 +1781,10 @@ struct sk_buff *ip6_make_skb(struct sock *sk,
 	cork.base.opt = NULL;
 	v6_cork.opt = NULL;
 	err = ip6_setup_cork(sk, &cork, &v6_cork, hlimit, tclass, opt, rt, fl6);
-	if (err)
+	if (err) {
+		ip6_cork_release(&cork, &v6_cork);
 		return ERR_PTR(err);
+	}
 
 	if (dontfrag < 0)
 		dontfrag = inet6_sk(sk)->dontfrag;
