MotorolaMobilityLLC__kernel-msm
commit c9684e1ef708d91a42a8e08e7b521d8683e0c2ff
Author:     Sanjay Singh <sisanj@codeaurora.org>
AuthorDate: Mon Sep 17 10:36:26 2018 +0530
Commit:     Carlos Pinho <cpinho@motorola.com>
CommitDate: Fri Oct 11 21:33:02 2019 -0300

    msm: vidc: ignore processing responses in invalid state
    
    No need to process response messages from video hardware
    after device went into invalid state. Processing responses
    may result in use-after-free memory fault because client
    might free all the resources after error.
    
    Bug-id: A-119053086
    CRs-fixed: 2295915
    CVE-fixed: CVE-2018-13899
    Mot-CRs-fixed: (CR)
    
    Change-Id: I08537728b9f743b3d2d0c2b9c5a45924074f02fb
    
    Signed-off-by: Maheshwar Ajja <majja@codeaurora.org>
    Signed-off-by: Sanjay Singh <sisanj@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Change-Id: I08537728b9f743b3d2d0c2b9c5a45924074f02fb
    Reviewed-on: https://gerrit.mot.com/1308767
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Ravikumar Vembu <raviv@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/media/platform/msm/vidc/venus_hfi.c b/drivers/media/platform/msm/vidc/venus_hfi.c
index 90b1e664d661..527864daa56a 100644
--- a/drivers/media/platform/msm/vidc/venus_hfi.c
+++ b/drivers/media/platform/msm/vidc/venus_hfi.c
@@ -3742,13 +3742,13 @@ err_no_work:
 	for (i = 0; !IS_ERR_OR_NULL(device->response_pkt) &&
 		i < num_responses; ++i) {
 		struct msm_vidc_cb_info *r = &device->response_pkt[i];
-		 if (!__core_in_valid_state(device)) {
+
+		if (!__core_in_valid_state(device)) {
 			dprintk(VIDC_ERR,
 				"Ignore responses from %d to %d as device is in invalid state",
 				(i + 1), num_responses);
 			break;
 		}
-		}
 		device->callback(r->response_type, &r->response);
 	}
 
