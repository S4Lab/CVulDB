MotorolaMobilityLLC__kernel-msm
commit ddcbe9266359e8d44be10444ba6927d2de433b60
Author:     peter chang <dpf@google.com>
AuthorDate: Wed Feb 15 14:11:54 2017 -0800
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Mar 12 16:31:54 2018 +0800

    scsi: sg: check length passed to SG_NEXT_CMD_LEN
    
    The user can control the size of the next command passed along, but the
    value passed to the ioctl isn't checked against the usable max command
    size.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-7187
    Bug: 63666227
    
    Change-Id: I48ba8dfbe895e66cc2c8e66c136f022b09b61bd0
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Peter Chang <dpf@google.com>
    Acked-by: Douglas Gilbert <dgilbert@interlog.com>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Reviewed-on: https://gerrit.mot.com/1057178
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/scsi/sg.c b/drivers/scsi/sg.c
index b739d83a26db..c8b1ce2f86b4 100644
--- a/drivers/scsi/sg.c
+++ b/drivers/scsi/sg.c
@@ -1026,6 +1026,8 @@ sg_ioctl(struct file *filp, unsigned int cmd_in, unsigned long arg)
 		result = get_user(val, ip);
 		if (result)
 			return result;
+		if (val > SG_MAX_CDB_SIZE)
+			return -ENOMEM;
 		sfp->next_cmd_len = (val > 0) ? val : 0;
 		return 0;
 	case SG_GET_VERSION_NUM:
