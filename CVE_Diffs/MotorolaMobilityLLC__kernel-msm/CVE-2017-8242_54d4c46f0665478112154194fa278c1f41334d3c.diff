MotorolaMobilityLLC__kernel-msm
commit 54d4c46f0665478112154194fa278c1f41334d3c
Author:     Varun Shrivastava <varunshrivastava@motorola.com>
AuthorDate: Wed May 10 08:59:54 2017 +0530
Commit:     Varun Shrivastava <varunshrivastava@motorola.com>
CommitDate: Wed May 17 00:03:40 2017 -0500

    qseecom: add mutex around qseecom_set_client_mem_param
    
    Add mutex around qseecom_set_client_mem_param to prevent an
    ioctl thread modifying and corrupting data which is being
    processed by another ioctl in the other thread
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-8242
    
    Signed-off-by: Varun Shrivastava <varunshrivastava@motorola.com>
    Change-Id: Id794941dc55b36c607ff5a69efa844851e7fb908
    Reviewed-on: https://gerrit.mot.com/992050
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index 7adcf441d43f..9143aefc4be5 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -4830,7 +4830,11 @@ long qseecom_ioctl(struct file *file, unsigned cmd, unsigned long arg)
 			break;
 		}
 		pr_debug("SET_MEM_PARAM: qseecom addr = 0x%pK\n", data);
+		mutex_lock(&app_access_lock);
+		atomic_inc(&data->ioctl_count);
 		ret = qseecom_set_client_mem_param(data, argp);
+		atomic_dec(&data->ioctl_count);
+		mutex_unlock(&app_access_lock);
 		if (ret)
 			pr_err("failed Qqseecom_set_mem_param request: %d\n",
 								ret);
