MotorolaMobilityLLC__kernel-msm
commit 110ac2ce40080086c0bd19b6a32d7d2d33f037fa
Author:     Haibin Liu <haibinl@codeaurora.org>
AuthorDate: Tue Oct 24 20:32:48 2017 +0800
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Wed Jun 27 03:24:11 2018 -0500

    msm: sensor: actuator: avoid accessing out of bound memory
    
    Issue:
    When total_steps is updated, after that, copy_from_user
    fails with an error, then, i2c_reg_tbl is not allocated.
    In this case, when calling msm_actuator_parse_i2c_params,
    it lead to out-of-bound memory write.
    
    Fix:
    1) Assign total_steps to zero when error from copying.
    2) Add NULL pointer check for i2c tbl.
    
    Bug-id: A-65122765
    CRs-Fixed: 2111672
    CVE-fixed: CVE-2017-15857
    Mot-CRs-fixed: (CR)
    
    Change-Id: Ib9dcb182356e2df8078c131edfd0791fa95a35e0
    Signed-off-by: Haibin Liu <haibinl@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1161534
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 6d1cf3cf1b22ddccc3aff16196f8a36b21641a36)
    (cherry picked from commit b15f9f28ed6464f3e0b9ce1ed8a09a3abbf9a359)

diff --git a/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c b/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c
index 8f1cf498546e..0f3074812056 100644
--- a/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c
+++ b/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c
@@ -100,6 +100,11 @@ static void msm_actuator_parse_i2c_params(struct msm_actuator_ctrl_t *a_ctrl,
 		return;
 	}
 
+	if (a_ctrl->i2c_reg_tbl == NULL) {
+		pr_err("failed. i2c reg tabl is NULL");
+		return;
+	}
+
 	size = a_ctrl->reg_tbl_size;
 	write_arr = a_ctrl->reg_tbl;
 	i2c_tbl = a_ctrl->i2c_reg_tbl;
@@ -1286,9 +1291,11 @@ static int32_t msm_actuator_set_param(struct msm_actuator_ctrl_t *a_ctrl,
 
 	if (copy_from_user(&a_ctrl->region_params,
 		(void *)set_info->af_tuning_params.region_params,
-		a_ctrl->region_size * sizeof(struct region_params_t)))
+		a_ctrl->region_size * sizeof(struct region_params_t))) {
+		a_ctrl->total_steps = 0;
+		pr_err("Error copying region_params\n");
 		return -EFAULT;
-
+	}
 	if (a_ctrl->act_device_type == MSM_CAMERA_PLATFORM_DEVICE) {
 		cci_client = a_ctrl->i2c_client.cci_client;
 		cci_client->sid =
