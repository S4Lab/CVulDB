MotorolaMobilityLLC__kernel-msm
commit 2c381d79151765f5cc945e317f24db834cc900ff
Author:     kunleiz <kunleiz@codeaurora.org>
AuthorDate: Mon Jul 17 15:02:59 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Aug 21 05:18:11 2017 -0500

    ASoC: msm: qdspv2: add result check when audio process fail
    
    A audio_process_event_req is not always to success. Therefore,
    check the return value for audio_process_event_req, and
    initializ usr_evt before using it.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-0748
    Bug-Id: A-35764875
    CRs-Fixed: 2029798
    Signed-off-by: kunleiz <kunleiz@codeaurora.org>
    --
    
    Change-Id: I37157d7323561ac2167ef4342bf5697b0186dd3a
    Signed-off-by: Neeraj Kumar <neerajk@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1027542
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c b/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c
index 5a82527aa8d2..bbedd4c747ba 100644
--- a/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c
+++ b/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c
@@ -842,6 +842,7 @@ static long audio_aio_process_event_req_compat(struct q6audio_aio *audio,
 	long rc;
 	struct msm_audio_event32 usr_evt_32;
 	struct msm_audio_event usr_evt;
+	memset(&usr_evt, 0, sizeof(struct msm_audio_event));
 
 	if (copy_from_user(&usr_evt_32, arg,
 				sizeof(struct msm_audio_event32))) {
@@ -851,6 +852,11 @@ static long audio_aio_process_event_req_compat(struct q6audio_aio *audio,
 	usr_evt.timeout_ms = usr_evt_32.timeout_ms;
 
 	rc = audio_aio_process_event_req_common(audio, &usr_evt);
+	if (rc < 0) {
+		pr_err("%s: audio process event failed, rc = %ld",
+			__func__, rc);
+		return rc;
+	}
 
 	usr_evt_32.event_type = usr_evt.event_type;
 	switch (usr_evt_32.event_type) {
