MotorolaMobilityLLC__kernel-msm
commit 904a6e7cbd3af3c17ae504855cd98b1a519ddbea
Author:     Sreelakshmi Gownipalli <sgownipa@codeaurora.org>
AuthorDate: Wed May 16 10:23:15 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Jun 11 04:20:35 2018 -0500

    diag: Add conditional check for len in dci_process_ctrl_status()
    
    Add correct conditional check for len in dci_process_ctrl_status() to
    prevent buffer overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2018-5898
    Bug: 70528036
    CRs-fixed: 2172685
    
    Change-Id: Id73ed1c8b104428eceef0544ce2858160cc08fd2
    Signed-off-by: Sreelakshmi Gownipalli <sgownipa@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1175975
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit b9c7441033ddbb163ee2fe12ac7d029f3c2eeea6)

diff --git a/drivers/char/diag/diag_dci.c b/drivers/char/diag/diag_dci.c
index b30b4848be88..23da52f9b0cf 100644
--- a/drivers/char/diag/diag_dci.c
+++ b/drivers/char/diag/diag_dci.c
@@ -828,7 +828,7 @@ static void dci_process_ctrl_status(unsigned char *buf, int len, int token)
 	read_len += sizeof(struct diag_ctrl_dci_status);
 
 	for (i = 0; i < header->count; i++) {
-		if (read_len > len) {
+		if (read_len > (len - 2)) {
 			pr_err("diag: In %s, Invalid length len: %d\n",
 			       __func__, len);
 			return;
