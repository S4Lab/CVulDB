MotorolaMobilityLLC__kernel-msm
commit 2ac88f630de6eaa27e1b73ee08bca9bb548a6336
Author:     Jin Qian <jinqian@google.com>
AuthorDate: Mon Apr 24 18:20:52 2017 -0700
Commit:     yunma <yunma@motorola.com>
CommitDate: Tue Aug 1 22:19:33 2017 -0500

    BACKPORT: f2fs: sanity check log_blocks_per_seg
    
    f2fs currently only supports 4KB block size and 2MB segment size.
    Sanity check log_blocks_per_seg == 9, i.e. 2MB/4KB = (1 << 9)
    
    Partially
    (cherry-picked from commit 9a59b62fd88196844cee5fff851bee2cfd7afb6e)
    
    f2fs: do more integrity verification for superblock
    
    Do more sanity check for superblock during ->mount.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0750
    Bug: 36817013
    
    Signed-off-by: Chao Yu <chao2.yu@samsung.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    
    Signed-off-by: Jin Qian <jinqian@google.com>
    Change-Id: I0be52e54fba82083068337ceb9f7ad985a87319f
    Reviewed-on: https://gerrit.mot.com/1024907
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/fs/f2fs/super.c b/fs/f2fs/super.c
index 106dda1e743d..92ac61c3ccf7 100644
--- a/fs/f2fs/super.c
+++ b/fs/f2fs/super.c
@@ -947,6 +947,14 @@ static int sanity_check_raw_super(struct super_block *sb,
 		return 1;
 	}
 
+	/* check log blocks per segment */
+	if (le32_to_cpu(raw_super->log_blocks_per_seg) != 9) {
+		f2fs_msg(sb, KERN_INFO,
+			"Invalid log blocks per segment (%u)\n",
+			le32_to_cpu(raw_super->log_blocks_per_seg));
+		return 1;
+	}
+
 	/* Currently, support 512/1024/2048/4096 bytes sector size */
 	if (le32_to_cpu(raw_super->log_sectorsize) >
 				F2FS_MAX_LOG_SECTOR_SIZE ||
