MotorolaMobilityLLC__kernel-msm
commit 5165263f9674535cca454d22b584516df5faef79
Author:     Rainer Weikusat <rweikusat@mobileactivedefense.com>
AuthorDate: Wed Oct 5 17:11:09 2016 +0530
Commit:     chenll4 <chenll4@motorola.com>
CommitDate: Fri Oct 21 08:51:12 2016 +0800

    af_unix: Guard against other == sk in unix_dgram_sendmsg
    
    The unix_dgram_sendmsg routine use the following test
    
    if (unlikely(unix_peer(other) != sk && unix_recvq_full(other))) {
    
    to determine if sk and other are in an n:1 association (either
    established via connect or by using sendto to send messages to an
    unrelated socket identified by address). This isn't correct as the
    specified address could have been bound to the sending socket itself or
    because this socket could have been connected to itself by the time of
    the unix_peer_get but disconnected before the unix_state_lock(other). In
    both cases, the if-block would be entered despite other == sk which
    might either block the sender unintentionally or lead to trying to unlock
    the same spin lock twice for a non-blocking send. Add a other != sk
    check to guard against this.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed:CVE-2013-7446
    
    Fixes: 7d267278a9ec ("unix: avoid use-after-free in ep_remove_wait_queue")
    Reported-By: Philipp Hahn <pmhahn@pmhahn.de>
    Signed-off-by: Rainer Weikusat <rweikusat@mobileactivedefense.com>
    Tested-by: Philipp Hahn <pmhahn@pmhahn.de>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    
    
    Change-Id: Ic9e31647b74b8b47a45e64549841a3b132e32fb8
    Reviewed-on: https://gerrit.mot.com/906358
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Vijayakumar Gn <vijaygn@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    (cherry picked from commit fa3c4dd6797df420761ebc1cfeea981cb216ae8a)
    Reviewed-on: https://gerrit.mot.com/908984

diff --git a/net/unix/af_unix.c b/net/unix/af_unix.c
index a21b1a7ec477..231b8167c655 100644
--- a/net/unix/af_unix.c
+++ b/net/unix/af_unix.c
@@ -1700,7 +1700,12 @@ restart_locked:
 			goto out_unlock;
 	}
 
-	if (unlikely(unix_peer(other) != sk && unix_recvq_full(other))) {
+	/* other == sk && unix_peer(other) != sk if
+	 * - unix_peer(sk) == NULL, destination address bound to sk
+	 * - unix_peer(sk) == sk by time of get but disconnected before lock
+	 */
+	if (other != sk &&
+	    unlikely(unix_peer(other) != sk && unix_recvq_full(other))) {
 		if (timeo) {
 			timeo = unix_wait_for_peer(other, timeo);
 
