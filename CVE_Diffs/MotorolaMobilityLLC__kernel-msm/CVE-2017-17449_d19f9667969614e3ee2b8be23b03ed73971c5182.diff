MotorolaMobilityLLC__kernel-msm
commit d19f9667969614e3ee2b8be23b03ed73971c5182
Author:     Kevin Cernekee <cernekee@chromium.org>
AuthorDate: Thu Mar 8 16:23:10 2018 +0530
Commit:     lulu2 <lulu2@lenovo.com>
CommitDate: Wed Jun 6 13:59:47 2018 +0800

    netlink: Add netns check on taps
    
    Currently, a nlmon link inside a child namespace can observe systemwide
    netlink activity.  Filter the traffic so that in a non-init netns,
    nlmon can only sniff netlink messages from its own netns.
    
    Test case:
    
        vpnns -- bash -c "ip link add nlmon0 type nlmon; \
                          ip link set nlmon0 up; \
                          tcpdump -i nlmon0 -q -w /tmp/nlmon.pcap -U" &
        sudo ip xfrm state add src 10.1.1.1 dst 10.1.1.2 proto esp \
            spi 0x1 mode transport \
            auth sha1 0x6162633132330000000000000000000000000000 \
            enc aes 0x00000000000000000000000000000000
        grep abc123 /tmp/nlmon.pcap
    
    CVE-fixed: CVE-2017-17449
    Mot-CRs-fixed: (CR)
    CRs-fixed: 70980949
    
    Change-Id: I578fef8928ee759e322bcbe5ba4ced560e91daba
    Signed-off-by: Kevin Cernekee <cernekee@chromium.org>
    Reviewed-on: https://gerrit.mot.com/1146212
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/net/netlink/af_netlink.c b/net/netlink/af_netlink.c
index 4f802a56c50b..1a11683e1fa6 100644
--- a/net/netlink/af_netlink.c
+++ b/net/netlink/af_netlink.c
@@ -232,6 +232,11 @@ static int __netlink_deliver_tap_skb(struct sk_buff *skb,
 	struct sock *sk = skb->sk;
 	int ret = -ENOMEM;
 
+	if (!net_eq(dev_net(dev), sock_net(sk)) &&
+	    !net_eq(dev_net(dev), &init_net)) {
+		return 0;
+	}
+
 	dev_hold(dev);
 
 	if (is_vmalloc_addr(skb->head))
