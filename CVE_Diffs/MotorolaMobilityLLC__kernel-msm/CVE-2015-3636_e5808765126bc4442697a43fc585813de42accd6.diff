MotorolaMobilityLLC__kernel-msm
commit e5808765126bc4442697a43fc585813de42accd6
Author:     David S. Miller <davem@davemloft.net>
AuthorDate: Fri May 1 22:02:47 2015 -0400
Commit:     Choon Lee Seah <andyseah@motorola.com>
CommitDate: Mon May 4 20:01:47 2015 -0500

    ipv4: Missing sk_nulls_node_init() in ping_unhash().
    
    ANDROID-20770158 (CVE-2015-3636)
    
    If we don't do that, then the poison value is left in the ->pprev
    backlink.
    
    This can cause crashes if we do a disconnect, followed by a connect().
    
    Tested-by: Linus Torvalds <torvalds@linux-foundation.org>
    Reported-by: Wen Xu <hotdog3645@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Andy Seah <dntc46@motorola.com>
    Change-Id: I582fdd3973ed85872d4af2622ef546fb29c63651
    Reviewed-on: http://gerrit.mot.com/744363
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Submit-Approved: Jira Key <jirakey@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Jeffrey Carlyle <jeff.carlyle@motorola.com>

diff --git a/net/ipv4/ping.c b/net/ipv4/ping.c
index bef18d074ca5..21285f511049 100644
--- a/net/ipv4/ping.c
+++ b/net/ipv4/ping.c
@@ -153,6 +153,7 @@ void ping_unhash(struct sock *sk)
 	if (sk_hashed(sk)) {
 		write_lock_bh(&ping_table.lock);
 		hlist_nulls_del(&sk->sk_nulls_node);
+		sk_nulls_node_init(&sk->sk_nulls_node);
 		sock_put(sk);
 		isk->inet_num = 0;
 		isk->inet_sport = 0;
