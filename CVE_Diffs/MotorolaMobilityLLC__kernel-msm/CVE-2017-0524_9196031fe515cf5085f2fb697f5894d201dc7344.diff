MotorolaMobilityLLC__kernel-msm
commit 9196031fe515cf5085f2fb697f5894d201dc7344
Author:     Ashwin Pathmudi <jfxr63@motorola.com>
AuthorDate: Thu Feb 16 16:05:54 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Mar 30 22:56:48 2017 -0500

    input: synaptics_dsx: Place file offset validity checks under mutex
    
    Mot-CRs-fixed: IKSIMP-1828, IKSIMP-1664
    CVE-Fixed: CVE-2017-0524, CVE-2017-0536
    
    Change-Id: Iad1bd74c3f98c3dc7f9f98888805d4e4944ad13f
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/951706
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    Reviewed-by: Konstantin Makariev <kmakariev@motorola.com>

diff --git a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
index d230f63a4b76..9a222f919f2f 100644
--- a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
+++ b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
@@ -335,14 +335,22 @@ static ssize_t rmidev_read(struct file *filp, char __user *buf,
 		return -EBADF;
 	}
 
-	if (count == 0)
-		return 0;
+	mutex_lock(&(dev_data->file_mutex));
 
 	if (count > (REG_ADDR_LIMIT - *f_pos))
 		count = REG_ADDR_LIMIT - *f_pos;
 
+	if (count == 0) {
+		retval = 0;
+		goto clean_up;
+	}
+
+	if (*f_pos > REG_ADDR_LIMIT) {
+		retval = -EFAULT;
+		goto clean_up;
+	}
+
 	tb = &dev_data->data_buf;
-	mutex_lock(&(dev_data->file_mutex));
 
 	if (tb->buf_size < count && alloc_buffer(tb, count) != 0) {
 		retval = -ENOMEM;
@@ -386,14 +394,22 @@ static ssize_t rmidev_write(struct file *filp, const char __user *buf,
 		return -EBADF;
 	}
 
-	if (count == 0)
-		return 0;
+	mutex_lock(&(dev_data->file_mutex));
 
 	if (count > (REG_ADDR_LIMIT - *f_pos))
 		count = REG_ADDR_LIMIT - *f_pos;
 
+	if (count == 0) {
+		retval = 0;
+		goto clean_up;
+	}
+
+	if (*f_pos > REG_ADDR_LIMIT) {
+		retval = -EFAULT;
+		goto clean_up;
+	}
+
 	tb = &dev_data->data_buf;
-	mutex_lock(&(dev_data->file_mutex));
 
 	if (tb->buf_size < count && alloc_buffer(tb, count) != 0) {
 		retval = -ENOMEM;
