MotorolaMobilityLLC__kernel-msm
commit 92059583f9c7064fb885d044e68a21f119ebb15f
Author:     Trishansh Bhardwaj <tbhardwa@codeaurora.org>
AuthorDate: Fri Apr 7 11:16:29 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Sep 26 04:35:51 2017 -0500

    msm: camera: Allow driver file to be opend only once.
    
    Use proper synchronization to ensure driver file is opened
    only once.
    
    CRs-Fixed: 2023513
    CVE-fixed: CVE-2017-8247
    Mot-CRs-fixed: (CR)
    
    Change-Id: I71e55e2d487fe561d3f596590b3e8102c5e921b5
    Signed-off-by: Trishansh Bhardwaj <tbhardwa@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1014315
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Robert Kubicki <w17311@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit edf956d2f43deb6de6268628ce873b0c2b4e5a20)

diff --git a/drivers/media/platform/msm/camera_v2/msm.c b/drivers/media/platform/msm/camera_v2/msm.c
index 7da792551bfc..d08242592f2a 100644
--- a/drivers/media/platform/msm/camera_v2/msm.c
+++ b/drivers/media/platform/msm/camera_v2/msm.c
@@ -883,11 +883,9 @@ static int msm_open(struct file *filep)
 	BUG_ON(!pvdev);
 
 	/* !!! only ONE open is allowed !!! */
-	if (atomic_read(&pvdev->opened))
+	if (atomic_cmpxchg(&pvdev->opened, 0, 1))
 		return -EBUSY;
 
-	atomic_set(&pvdev->opened, 1);
-
 	spin_lock_irqsave(&msm_pid_lock, flags);
 	msm_pid = get_pid(task_pid(current));
 	spin_unlock_irqrestore(&msm_pid_lock, flags);
