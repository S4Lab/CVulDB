MotorolaMobilityLLC__kernel-msm
commit 9148f00fee70e03efdbbeb6f0f3e2a8400695897
Author:     Ashwin Pathmudi <jfxr63@motorola.com>
AuthorDate: Thu Feb 1 20:56:28 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Wed Feb 14 23:12:45 2018 -0600

    input: synaptics_dsx: Free buffer before releasing rmidev
    
    CVE-fixed: CVE-2017-9723
    
    Change-Id: I34b38e7f5d39ea7ff3a7a03f3a55d31e2dbac930
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    (cherry picked from commit 72a7c3849ad068beaddef233951215f052451eeb)
    Reviewed-on: https://gerrit.mot.com/1131156
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Konstantin Makariev <kmakariev@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 8b3ffb10a003ae51aa8f179fc3f6736bbcc84e33)

diff --git a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
index b43c00783ebd..7a12e6099707 100644
--- a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
+++ b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
@@ -475,12 +475,20 @@ static int rmidev_release(struct inode *inp, struct file *filp)
 {
 	struct rmidev_data *dev_data =
 			container_of(inp->i_cdev, struct rmidev_data, main_dev);
+	struct temp_buffer *tb;
 
 	if (!dev_data)
 		return -EACCES;
 
 	mutex_lock(&(dev_data->file_mutex));
 
+	tb = &dev_data->data_buf;
+	if (tb->buf_size != 0) {
+		kfree(tb->buf);
+		tb->buf = NULL;
+		tb->buf_size = 0;
+	}
+
 	dev_data->ref_count--;
 	if (dev_data->ref_count < 0)
 		dev_data->ref_count = 0;
