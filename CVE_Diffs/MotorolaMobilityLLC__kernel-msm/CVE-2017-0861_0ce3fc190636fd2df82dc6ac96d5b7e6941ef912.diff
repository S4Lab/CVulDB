MotorolaMobilityLLC__kernel-msm
commit 0ce3fc190636fd2df82dc6ac96d5b7e6941ef912
Author:     Robb Glasser <rglasser@google.com>
AuthorDate: Fri Aug 11 11:33:31 2017 -0700
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Thu Feb 22 22:01:35 2018 -0600

    ALSA: pcm: prevent UAF in snd_pcm_info
    
    When the device descriptor is closed, the `substream->runtime` pointer
    is freed. But another thread may be in the ioctl handler, case
    SNDRV_CTL_IOCTL_PCM_INFO. This case calls snd_pcm_info_user() which
    calls snd_pcm_info() which accesses the now freed `substream->runtime`.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed:  CVE-2017-0861
    Bug: 36006981
    Signed-off-by: Robb Glasser <rglasser@google.com>
    Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
    Change-Id: I445d24bc21dc0af6d9522a8daabe64969042236a
    ---
    Reviewed-on: https://gerrit.mot.com/1074333
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Reviewed-by: Coverity Analysis <coverity@motorola.com>
    Tested-by: Jira Key
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Guobin Zhang <zhanggb@motorola.com>
    Submit-Approved: Jira Key

diff --git a/sound/core/pcm.c b/sound/core/pcm.c
index 4fc68b126169..48f6aee3680d 100644
--- a/sound/core/pcm.c
+++ b/sound/core/pcm.c
@@ -149,7 +149,9 @@ static int snd_pcm_control_ioctl(struct snd_card *card,
 				err = -ENXIO;
 				goto _error;
 			}
+			mutex_lock(&pcm->open_mutex);
 			err = snd_pcm_info_user(substream, info);
+			mutex_unlock(&pcm->open_mutex);
 		_error:
 			mutex_unlock(&register_mutex);
 			return err;
