MotorolaMobilityLLC__kernel-msm
commit f57a8fddb442d56cc296f5fb36611544d3bbe01a
Author:     Harsh Sahu <hsahu@codeaurora.org>
AuthorDate: Fri Apr 21 16:12:22 2017 -0700
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Sat Sep 9 04:52:53 2017 -0500

    msm: mdss: fix memcpy source and dest memory buffer size mismatch
    
    Currently memcpy is copying from a bigger memory size to a smaller
    memory size. This change corrects this issue by performing the
    memcopy restricted to the smaller of the src or dest memory buffer.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-9678
    
    Change-Id: Ibbe5665083799a4262d3cfbb06f94f3e35e03748
    Signed-off-by: Harsh Sahu <hsahu@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1025662
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Bang Nguyen <bangnguyen@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/video/msm/mdss/mdss_compat_utils.c b/drivers/video/msm/mdss/mdss_compat_utils.c
index e86c087d13a5..f599bb5b445f 100644
--- a/drivers/video/msm/mdss/mdss_compat_utils.c
+++ b/drivers/video/msm/mdss/mdss_compat_utils.c
@@ -119,6 +119,9 @@ static unsigned int __do_compat_ioctl_nr(unsigned int cmd32)
 static void  __copy_atomic_commit_struct(struct mdp_layer_commit  *commit,
 	struct mdp_layer_commit32 *commit32)
 {
+	unsigned int destsize = sizeof(commit->commit_v1.reserved);
+	unsigned int srcsize = sizeof(commit32->commit_v1.reserved);
+	unsigned int count = (destsize <= srcsize ? destsize : srcsize);
 	commit->version = commit32->version;
 	commit->commit_v1.flags = commit32->commit_v1.flags;
 	commit->commit_v1.input_layer_cnt =
@@ -126,7 +129,7 @@ static void  __copy_atomic_commit_struct(struct mdp_layer_commit  *commit,
 	commit->commit_v1.left_roi = commit32->commit_v1.left_roi;
 	commit->commit_v1.right_roi = commit32->commit_v1.right_roi;
 	memcpy(&commit->commit_v1.reserved, &commit32->commit_v1.reserved,
-		sizeof(commit32->commit_v1.reserved));
+		count);
 }
 
 static struct mdp_input_layer32 *__create_layer_list32(
