MotorolaMobilityLLC__kernel-msm
commit 573d144320465a90c4aac88bc95a81ac0bbebfa2
Author:     Dan Carpenter <dan.carpenter@oracle.com>
AuthorDate: Tue May 2 13:58:53 2017 +0300
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Sep 4 23:56:12 2017 -0500

    ipx: call ipxitf_put() in ioctl error path
    
    We should call ipxitf_put() if the copy_to_user() fails.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-7487
    Bug: 62070688
    
    Change-Id: I867e62a3ebf869774cb0d8eef0fe33b3cb81ee83
    Reported-by: 李强 <liqiang6-s@360.cn>
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Reviewed-on: https://gerrit.mot.com/1042064
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 28bf8bd22fb8b7904d6c16b408426edbf9bcc128)

diff --git a/net/ipx/af_ipx.c b/net/ipx/af_ipx.c
index 2665bf4b8d05..f86f096aa16a 100644
--- a/net/ipx/af_ipx.c
+++ b/net/ipx/af_ipx.c
@@ -1183,11 +1183,10 @@ static int ipxitf_ioctl(unsigned int cmd, void __user *arg)
 		sipx->sipx_network	= ipxif->if_netnum;
 		memcpy(sipx->sipx_node, ipxif->if_node,
 			sizeof(sipx->sipx_node));
-		rc = -EFAULT;
+		rc = 0;
 		if (copy_to_user(arg, &ifr, sizeof(ifr)))
-			break;
+			rc = -EFAULT;
 		ipxitf_put(ipxif);
-		rc = 0;
 		break;
 	}
 	case SIOCAIPXITFCRT:
