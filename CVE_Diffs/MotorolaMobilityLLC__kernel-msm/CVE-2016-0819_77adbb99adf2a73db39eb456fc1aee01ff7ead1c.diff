MotorolaMobilityLLC__kernel-msm
commit 77adbb99adf2a73db39eb456fc1aee01ff7ead1c
Author:     hyeonsu9.lee <hyeonsu9.lee@samsung.com>
AuthorDate: Wed Mar 23 14:35:25 2016 +0900
Commit:     Chenjie Luo <cjluo@google.com>
CommitDate: Tue Mar 29 23:43:49 2016 +0000

    msm: null pointer dereferencing
    
    BUG= 27455813
    
    Prevent unintended kernel NULL pointer dereferencing.
    
    Add this patch for CVE-2016-0819
    
    Change-Id: I2461cabfd44bdb5c548eaf6db80c93121f922201
    Signed-off-by: hyeonsu9.lee <hyeonsu9.lee@samsung.com>

diff --git a/kernel/events/core.c b/kernel/events/core.c
index 51b4c6a12273..a8ab21a118c1 100644
--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@ -5343,7 +5343,8 @@ static int perf_swevent_add(struct perf_event *event, int flags)
 
 static void perf_swevent_del(struct perf_event *event, int flags)
 {
-	hlist_del_rcu(&event->hlist_entry);
+	if(!hlist_unhashed(&event->hlist_entry))
+		hlist_del_rcu(&event->hlist_entry);
 }
 
 static void perf_swevent_start(struct perf_event *event, int flags)
@@ -6620,6 +6621,9 @@ SYSCALL_DEFINE5(perf_event_open,
 	if (err)
 		return err;
 
+	if (attr.constraint_duplicate || attr.__reserved_1)
+		return -EINVAL;
+
 	if (!attr.exclude_kernel) {
 		if (perf_paranoid_kernel() && !capable(CAP_SYS_ADMIN))
 			return -EACCES;
diff --git a/kernel/trace/trace_event_perf.c b/kernel/trace/trace_event_perf.c
index 8354dc81ae64..249a9704dd23 100644
--- a/kernel/trace/trace_event_perf.c
+++ b/kernel/trace/trace_event_perf.c
@@ -222,7 +222,12 @@ int perf_trace_add(struct perf_event *p_event, int flags)
 void perf_trace_del(struct perf_event *p_event, int flags)
 {
 	struct ftrace_event_call *tp_event = p_event->tp_event;
-	hlist_del_rcu(&p_event->hlist_entry);
+
+	if(!hlist_unhashed(&p_event->hlist_entry))
+		hlist_del_rcu(&p_event->hlist_entry);
+	else
+		return;
+
 	tp_event->class->reg(tp_event, TRACE_REG_PERF_DEL, p_event);
 }
 
