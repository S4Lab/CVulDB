MotorolaMobilityLLC__kernel-msm
commit 80c8fbf20f59b5e635d60b604ca308729e7d4d42
Author:     Varun Shrivastava <varunshrivastava@motorola.com>
AuthorDate: Wed May 10 08:59:54 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Jun 6 03:06:39 2017 -0500

    qseecom: add mutex around qseecom_set_client_mem_param
    
    Add mutex around qseecom_set_client_mem_param to prevent an
    ioctl thread modifying and corrupting data which is being
    processed by another ioctl in the other thread
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-8242
    
    Change-Id: Icdd8a44bf2789c96be9cc4889b6b5b8e06cd36ed
    Signed-off-by: Varun Shrivastava <varunshrivastava@motorola.com>
    Reviewed-on: https://gerrit.mot.com/992054
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index 4883ee8e07f0..21b7f5d7d072 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -5146,7 +5146,11 @@ long qseecom_ioctl(struct file *file, unsigned cmd, unsigned long arg)
 			break;
 		}
 		pr_debug("SET_MEM_PARAM: qseecom addr = 0x%pK\n", data);
+		mutex_lock(&app_access_lock);
+		atomic_inc(&data->ioctl_count);
 		ret = qseecom_set_client_mem_param(data, argp);
+		atomic_dec(&data->ioctl_count);
+		mutex_unlock(&app_access_lock);
 		if (ret)
 			pr_err("failed Qqseecom_set_mem_param request: %d\n",
 								ret);
