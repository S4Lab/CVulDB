MotorolaMobilityLLC__kernel-msm
commit 0fa9b1dab092bceca00659ed53c98ad7161df1c7
Author:     Sriraj Hebbar <srirajh@qti.qualcomm.com>
AuthorDate: Fri Jun 30 13:14:28 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Nov 14 01:34:06 2017 -0600

    msm: camera: isp: Handle array out of bound access
    
    The pointer req_frm is coming from userspace, it may overflow stream_info.
    Adding a bound check to prevent the same.
    
    CRs-fixed: 2008683
    CVE-fixed: CVE-2017-11028
    Mot-Crs-fixed: (CR)
    
    Change-Id: I8682e09ff2ab7ba490bbbd9e20db978493c5f3e4
    Signed-off-by: Senthil Kumar Rajagopal <skrajago@codeaurora.org>
    Signed-off-by: Perry Sun <bins@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1055867
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/media/platform/msm/camera_v2/isp/msm_isp_axi_util.c b/drivers/media/platform/msm/camera_v2/isp/msm_isp_axi_util.c
index eaca01847471..3ed8c28732db 100644
--- a/drivers/media/platform/msm/camera_v2/isp/msm_isp_axi_util.c
+++ b/drivers/media/platform/msm/camera_v2/isp/msm_isp_axi_util.c
@@ -3692,6 +3692,12 @@ int msm_isp_update_axi_stream(struct vfe_device *vfe_dev, void *arg)
 	case UPDATE_STREAM_REQUEST_FRAMES_VER2: {
 		struct msm_vfe_axi_stream_cfg_update_info_req_frm *req_frm =
 			&update_cmd->req_frm_ver2;
+		if (HANDLE_TO_IDX(req_frm->stream_handle) >= VFE_AXI_SRC_MAX) {
+			pr_err("%s: Invalid stream handle\n", __func__);
+			rc = -EINVAL;
+			break;
+		}
+
 		stream_info = &axi_data->stream_info[HANDLE_TO_IDX(
 				req_frm->stream_handle)];
 		rc = msm_isp_request_frame(vfe_dev, stream_info,
