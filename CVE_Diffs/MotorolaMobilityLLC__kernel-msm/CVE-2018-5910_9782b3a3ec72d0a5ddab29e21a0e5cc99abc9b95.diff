MotorolaMobilityLLC__kernel-msm
commit 9782b3a3ec72d0a5ddab29e21a0e5cc99abc9b95
Author:     Harsh Sahu <hsahu@codeaurora.org>
AuthorDate: Fri Jun 1 17:42:03 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Aug 28 00:30:06 2018 -0500

    msm: mdss: check buffer size before writing to user buffer
    
    Check the number of bytes to copy against the size of the
    user buffer before copy to user to avoid buffer overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-5910
    CRs-Fixed: 2175499
    
    Change-Id: Icdd3d4e755deca19fa431e903620bd9e4c701c89
    Signed-off-by: Harsh Sahu <hsahu@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1184771
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Bang Nguyen <bangnguyen@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit fbdfb757153aeb72344f5bc2f136f2aadafe9aa6)

diff --git a/drivers/video/msm/mdss/mdss_debug_xlog.c b/drivers/video/msm/mdss/mdss_debug_xlog.c
index ab4fe9c0b6f2..38c667018fc7 100644
--- a/drivers/video/msm/mdss/mdss_debug_xlog.c
+++ b/drivers/video/msm/mdss/mdss_debug_xlog.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2014-2016, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2014-2016, 2018, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -979,6 +979,11 @@ static ssize_t mdss_xlog_dump_read(struct file *file, char __user *buff,
 	mutex_lock(&mdss_dbg_xlog.xlog_lock);
 	if (__mdss_xlog_dump_calc_range()) {
 		len = mdss_xlog_dump_entry(xlog_buf, MDSS_XLOG_BUF_MAX);
+		if (len < 0 || len > count) {
+			pr_err("len is more than the size of user buffer\n");
+			return 0;
+		}
+
 		if (copy_to_user(buff, xlog_buf, len)){
 			mutex_unlock(&mdss_dbg_xlog.xlog_lock);
 			return -EFAULT;
