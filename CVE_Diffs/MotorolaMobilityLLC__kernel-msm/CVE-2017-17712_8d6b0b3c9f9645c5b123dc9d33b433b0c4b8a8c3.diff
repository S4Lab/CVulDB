MotorolaMobilityLLC__kernel-msm
commit 8d6b0b3c9f9645c5b123dc9d33b433b0c4b8a8c3
Author:     Mohamed Ghannam <simo.ghannam@gmail.com>
AuthorDate: Fri Mar 9 12:44:15 2018 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Sat Dec 8 06:46:40 2018 -0600

    net: ipv4: fix for a race condition in raw_sendmsg
    
    inet->hdrincl is racy, and could lead to uninitialized stack pointer
    usage, so its value should be read only once.
    
    CVE-fixed: CVE-2017-17712
    Mot-CRs-fixed: (CR)
    CRs-fixed: 71500434
    
    Change-Id: I7724edcd749e2acf2d176e975bcbd9f1cd63e495
    Fixes: c008ba5bdc9f ("ipv4: Avoid reading user iov twice after raw_probe_proto_opt")
    Signed-off-by: Mohamed Ghannam <simo.ghannam@gmail.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Reviewed-on: https://gerrit.mot.com/1146308
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/net/ipv4/raw.c b/net/ipv4/raw.c
index 7541427537d0..b857562b1513 100644
--- a/net/ipv4/raw.c
+++ b/net/ipv4/raw.c
@@ -518,6 +518,10 @@ static int raw_sendmsg(struct sock *sk, struct msghdr *msg, size_t len)
 	if (msg->msg_flags & MSG_OOB)	/* Mirror BSD error message */
 		goto out;               /* compatibility */
 
+	/* hdrincl should be READ_ONCE(inet->hdrincl)
+	 * but READ_ONCE() doesn't work with bit fields
+	 */
+	hdrincl = inet->hdrincl;
 	/*
 	 *	Get and verify the address.
 	 */
