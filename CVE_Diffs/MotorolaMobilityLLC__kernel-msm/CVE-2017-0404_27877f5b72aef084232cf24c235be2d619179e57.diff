MotorolaMobilityLLC__kernel-msm
commit 27877f5b72aef084232cf24c235be2d619179e57
Author:     Srikanth A R <arsrikan@motorola.com>
AuthorDate: Thu Dec 8 10:24:19 2016 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Jan 31 02:21:02 2017 -0600

    ALSA: info: Check for integer overflow in snd_info_entry_write()
    
    snd_info_entry_write() resizes the buffer with an unsigned long
    size argument that gets truncated because resize_info_buffer()
    takes the size parameter as an unsigned int. On 64-bit kernels,
    this causes the following copy_to_user() to write out-of-bounds
    if (pos + count) can't be represented by an unsigned int.
    
    Bug: 32510733
    Mot-CRs-fixed: IKSIMP-234, IKSIMP-448
    CVE-fixed: CVE-2017-0404
    Change-Id: I9e8b55f93f2bd606b4a73b5a4525b71ee88c7c23
    Signed-off-by: Siqi Lin <siqilin@google.com>
    ---
    
    Change-Id: I893a2f5fe45865f67c21f908545289dee473d8f0
    Signed-off-by: Neeraj Kumar <neerajk@motorola.com>
    Reviewed-on: https://gerrit.mot.com/928918
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    (cherry picked from commit 5280224e9a2d9d5547235e56ffce2540a4a6b669)

diff --git a/sound/core/info.c b/sound/core/info.c
index 418b4ec43cad..a4af0ba92d30 100644
--- a/sound/core/info.c
+++ b/sound/core/info.c
@@ -253,6 +253,7 @@ static ssize_t snd_info_entry_write(struct file *file, const char __user *buffer
 	struct snd_info_buffer *buf;
 	ssize_t size = 0;
 	loff_t pos;
+	unsigned long realloc_size;
 
 	data = file->private_data;
 	if (snd_BUG_ON(!data))
@@ -261,7 +262,8 @@ static ssize_t snd_info_entry_write(struct file *file, const char __user *buffer
 	pos = *offset;
 	if (pos < 0 || (long) pos != pos || (ssize_t) count < 0)
 		return -EIO;
-	if ((unsigned long) pos + (unsigned long) count < (unsigned long) pos)
+	realloc_size = (unsigned long) pos + (unsigned long) count;
+	if (realloc_size < (unsigned long) pos || realloc_size > UINT_MAX)
 		return -EIO;
 	switch (entry->content) {
 	case SNDRV_INFO_CONTENT_TEXT:
