MotorolaMobilityLLC__kernel-msm
commit 8ffd3d5a5bcce5a672535a924be5ef28c73045b0
Author:     Ashwin Pathmudi <jfxr63@motorola.com>
AuthorDate: Tue Apr 11 19:53:41 2017 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Sat Dec 8 06:33:06 2018 -0600

    input: synaptics_dsx: modify the attribute of rmidev
    
    1. Remove the read permission of rmidev attributes instead of calling
       synaptics_rmi4_show_error() which is only used to print warning logs.
    2. Correct the data structure that used in synaptics_rmi4_show_error()
       while printing the warning logs.
    
    MOT-CRs-Fixed: (CR)
    CVE-Fixed: CVE-2017-0634
    ANDROID-32511682
    
    Change-Id: I6297767b7f4011d3279420238e0d7fe23d53f344
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/978201
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Reviewed-by: Konstantin Makariev <kmakariev@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_i2c.h b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_i2c.h
index 1f9c5394c631..4c7c9f383552 100644
--- a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_i2c.h
+++ b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_i2c.h
@@ -347,22 +347,6 @@ enum exp_fn {
 	RMI_LAST,
 };
 
-static inline ssize_t synaptics_rmi4_show_error(struct device *dev,
-		struct device_attribute *attr, char *buf)
-{
-	dev_warn(dev, "%s Attempted to read from write-only attribute %s\n",
-			__func__, attr->attr.name);
-	return -EPERM;
-}
-
-static inline ssize_t synaptics_rmi4_store_error(struct device *dev,
-		struct device_attribute *attr, const char *buf, size_t count)
-{
-	dev_warn(dev, "%s Attempted to write to read-only attribute %s\n",
-			__func__, attr->attr.name);
-	return -EPERM;
-}
-
 static inline void batohs(unsigned short *dest, unsigned char *src)
 {
 	*dest = src[1] * 0x100 + src[0];
@@ -578,6 +562,28 @@ struct synaptics_rmi4_data {
 #endif
 };
 
+static inline ssize_t synaptics_rmi4_show_error(struct device *dev,
+		struct device_attribute *attr, char *buf)
+{
+	struct synaptics_rmi4_data *rmi4_data = dev_get_drvdata(dev);
+
+	dev_warn(&rmi4_data->i2c_client->dev,
+			"%s Attempted to read from write-only attribute %s\n",
+			__func__, attr->attr.name);
+	return -EPERM;
+}
+
+static inline ssize_t synaptics_rmi4_store_error(struct device *dev,
+		struct device_attribute *attr, const char *buf, size_t count)
+{
+	struct synaptics_rmi4_data *rmi4_data = dev_get_drvdata(dev);
+
+	dev_warn(&rmi4_data->i2c_client->dev,
+			"%s Attempted to write to read-only attribute %s\n",
+			__func__, attr->attr.name);
+	return -EPERM;
+}
+
 struct time_keeping {
 	int id;
 	unsigned long long duration;
diff --git a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
index 889df401d73c..b938716835c0 100644
--- a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
+++ b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
@@ -90,20 +90,20 @@ static struct bin_attribute attr_data = {
 
 static struct device_attribute attrs[] = {
 	__ATTR(open, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_open_store),
 	__ATTR(release, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_release_store),
 	__ATTR(address, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_address_store),
 	__ATTR(length, S_IWUSR | S_IWGRP,
-			synaptics_rmi4_show_error,
+			NULL,
 			rmidev_sysfs_length_store),
 	__ATTR(attn_state, S_IRUSR | S_IRGRP,
 			rmidev_sysfs_attn_state_show,
-			synaptics_rmi4_store_error),
+			NULL),
 };
 
 static int rmidev_major_num;
