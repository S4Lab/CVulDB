MotorolaMobilityLLC__kernel-msm
commit f2e03f5a87d2cc9f2374b94d9164a920c9046e9e
Author:     Puja Gupta <pujag@codeaurora.org>
AuthorDate: Mon Mar 6 15:04:11 2017 -0800
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Sep 4 03:24:25 2017 -0500

    soc: qcom: Avoid possible buffer overflow in service-locator
    
    Fix possible buffer overflow by reading 'resp->total_domains' from the
    qmi response message since 'resp->total_domains' indicate total number
    of matching domains found by servreg.
    'resp->domain_list_len' indicates the domains that could be sent in one
    response which should not be greater than 'resp->total_domains'.
    
    Mot-CRs-fixed: (CR)
    Bug: 34359487
    CVE-fixed: CVE-2017-8259
    CRs-Fixed: 2009016
    Change-Id: I614561c5f9bc996689129bc098baaffc9b59c377
    Signed-off-by: Puja Gupta <pujag@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1009979
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/soc/qcom/service-locator.c b/drivers/soc/qcom/service-locator.c
index f6e7486bebf7..8b05605c2858 100644
--- a/drivers/soc/qcom/service-locator.c
+++ b/drivers/soc/qcom/service-locator.c
@@ -300,10 +300,9 @@ static int service_locator_send_msg(struct pd_qmi_client_data *pd)
 		if (!domains_read) {
 			db_rev_count = pd->db_rev_count = resp->db_rev_count;
 			pd->total_domains = resp->total_domains;
-			if (!pd->total_domains && resp->domain_list_len) {
-				pr_err("total domains not set\n");
-				pd->total_domains = resp->domain_list_len;
-			}
+			if (!resp->total_domains)
+				pr_info("No matching domains found\n");
+
 			pd->domain_list = kmalloc(
 					sizeof(struct servreg_loc_entry_v01) *
 					resp->total_domains, GFP_KERNEL);
@@ -320,6 +319,10 @@ static int service_locator_send_msg(struct pd_qmi_client_data *pd)
 			rc = -EAGAIN;
 			goto out;
 		}
+		if (resp->domain_list_len >  resp->total_domains) {
+			/* Always read total_domains from the response msg */
+			resp->domain_list_len = resp->total_domains;
+		}
 		/* Copy the response*/
 		store_get_domain_list_response(pd, resp, domains_read);
 		domains_read += resp->domain_list_len;
