MotorolaMobilityLLC__kernel-msm
commit bd81a4e1a7acefd5514f3b678d624526105e4b4f
Author:     Hamad Kadmany <hkadmany@codeaurora.org>
AuthorDate: Sun Dec 18 15:03:11 2016 +0200
Commit:     Fan Hang <hangfan1@lenovo.com>
CommitDate: Tue Oct 17 09:27:06 2017 +0800

    wil6210: Block write ioctl to the card by default
    
    The ability to write to the card is used for debug purposes.
    The ability is disabled by default to prevent misuse of
    this functionality.
    
    Mot-CRs-fixed:(CR)
    CVE-Fixed:CVE-2017-0523
    
    CRs-Fixed: 1096945
    Change-Id: I8fc3f646a0127ec705239be6a7de858a4f805acc
    Signed-off-by: Hamad Kadmany <hkadmany@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/966116
    SME-Granted: SME Approvals Granted
    Submit-Approved: Jira Key <jirakey@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: jinyou liu <liujy7@motorola.com>
    SLTApproved: jinyou liu <liujy7@motorola.com>
    Submit-Approved: jinyou liu <liujy7@motorola.com>
    (cherry picked from commit 579565825dacaf451da0ddec148c845dacf0025f)
    Reviewed-on: https://gerrit.mot.com/971713

diff --git a/drivers/net/wireless/ath/wil6210/Kconfig b/drivers/net/wireless/ath/wil6210/Kconfig
index 5d0e03694e51..4507003862a6 100644
--- a/drivers/net/wireless/ath/wil6210/Kconfig
+++ b/drivers/net/wireless/ath/wil6210/Kconfig
@@ -41,6 +41,17 @@ config WIL6210_TRACING
 
 	  If unsure, say Y to make it easier to debug problems.
 
+config WIL6210_WRITE_IOCTL
+	bool "wil6210 write ioctl to the device"
+	depends on WIL6210
+	default n
+	---help---
+	  Say Y here to allow write-access from user-space to
+	  the device memory through ioctl. This is useful for
+	  debugging purposes only.
+
+	  If unsure, say N.
+
 config WIL6210_PLATFORM_MSM
 	bool "wil6210 MSM platform specific support"
 	depends on WIL6210
diff --git a/drivers/net/wireless/ath/wil6210/ioctl.c b/drivers/net/wireless/ath/wil6210/ioctl.c
index 47058ccccb5b..bbdd232df3b7 100644
--- a/drivers/net/wireless/ath/wil6210/ioctl.c
+++ b/drivers/net/wireless/ath/wil6210/ioctl.c
@@ -87,10 +87,12 @@ static int wil_ioc_memio_dword(struct wil6210_priv *wil, void __user *data)
 		io.val = readl(a);
 		need_copy = true;
 		break;
+#if defined(CONFIG_WIL6210_WRITE_IOCTL)
 	case wil_mmio_write:
 		writel(io.val, a);
 		wmb(); /* make sure write propagated to HW */
 		break;
+#endif
 	default:
 		wil_err(wil, "Unsupported operation, op = 0x%08x\n", io.op);
 		return -EINVAL;
@@ -147,6 +149,7 @@ static int wil_ioc_memio_block(struct wil6210_priv *wil, void __user *data)
 			goto out_free;
 		}
 		break;
+#if defined(CONFIG_WIL6210_WRITE_IOCTL)
 	case wil_mmio_write:
 		if (copy_from_user(block, io.block, io.size)) {
 			rc = -EFAULT;
@@ -156,6 +159,7 @@ static int wil_ioc_memio_block(struct wil6210_priv *wil, void __user *data)
 		wmb(); /* make sure write propagated to HW */
 		wil_hex_dump_ioctl("Write ", block, io.size);
 		break;
+#endif
 	default:
 		wil_err(wil, "Unsupported operation, op = 0x%08x\n", io.op);
 		rc = -EINVAL;
