MotorolaMobilityLLC__kernel-msm
commit fa546d90bb0d985405651f1ee5157b46a228d499
Author:     Varun Shrivastava <varunshrivastava@motorola.com>
AuthorDate: Wed May 10 08:59:54 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Aug 8 06:11:37 2017 -0500

    qseecom: add mutex around qseecom_set_client_mem_param
    
    Add mutex around qseecom_set_client_mem_param to prevent an
    ioctl thread modifying and corrupting data which is being
    processed by another ioctl in the other thread
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-8242
    
    Change-Id: I7a25abc2a2702e81730826a7613e833c06bdfe7e
    Signed-off-by: Varun Shrivastava <varunshrivastava@motorola.com>
    Reviewed-on: https://gerrit.mot.com/992051
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index a0cce24a7360..0a15d7872ec9 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -6559,7 +6559,11 @@ long qseecom_ioctl(struct file *file, unsigned cmd, unsigned long arg)
 			break;
 		}
 		pr_debug("SET_MEM_PARAM: qseecom addr = 0x%pK\n", data);
+		mutex_lock(&app_access_lock);
+		atomic_inc(&data->ioctl_count);
 		ret = qseecom_set_client_mem_param(data, argp);
+		atomic_dec(&data->ioctl_count);
+		mutex_unlock(&app_access_lock);
 		if (ret)
 			pr_err("failed Qqseecom_set_mem_param request: %d\n",
 								ret);
