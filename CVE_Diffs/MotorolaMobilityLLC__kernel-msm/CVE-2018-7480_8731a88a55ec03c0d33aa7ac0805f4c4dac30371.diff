MotorolaMobilityLLC__kernel-msm
commit 8731a88a55ec03c0d33aa7ac0805f4c4dac30371
Author:     Hou Tao <houtao1@huawei.com>
AuthorDate: Fri Feb 3 17:19:07 2017 +0800
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Jun 11 23:43:33 2018 -0500

    blkcg: fix double free of new_blkg in blkcg_init_queue
    
    If blkg_create fails, new_blkg passed as an argument will
    be freed by blkg_create, so there is no need to free it again.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2018-7480
    
    Change-Id: I30094282d8e04b470bda0f54e61672bd18af98ec
    Signed-off-by: Hou Tao <houtao1@huawei.com>
    Signed-off-by: Jens Axboe <axboe@fb.com>
    Reviewed-on: https://gerrit.mot.com/1181371
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit b58b4c8adfbd5182355009f16e294602cf7abd63)

diff --git a/block/blk-cgroup.c b/block/blk-cgroup.c
index 37ade035c956..9075f08b392a 100644
--- a/block/blk-cgroup.c
+++ b/block/blk-cgroup.c
@@ -1078,10 +1078,8 @@ int blkcg_init_queue(struct request_queue *q)
 	if (preloaded)
 		radix_tree_preload_end();
 
-	if (IS_ERR(blkg)) {
-		blkg_free(new_blkg);
+	if (IS_ERR(blkg))
 		return PTR_ERR(blkg);
-	}
 
 	q->root_blkg = blkg;
 	q->root_rl.blkg = blkg;
