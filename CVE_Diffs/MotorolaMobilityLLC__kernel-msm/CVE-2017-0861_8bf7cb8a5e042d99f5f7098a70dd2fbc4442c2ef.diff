MotorolaMobilityLLC__kernel-msm
commit 8bf7cb8a5e042d99f5f7098a70dd2fbc4442c2ef
Author:     Robb Glasser <rglasser@google.com>
AuthorDate: Mon Sep 17 00:00:00 2001 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Dec 4 07:23:29 2017 -0600

    ALSA: pcm: prevent UAF in snd_pcm_info
    
    When the device descriptor is closed, the `substream->runtime` pointer
    is freed. But another thread may be in the ioctl handler, case
    SNDRV_CTL_IOCTL_PCM_INFO. This case calls snd_pcm_info_user() which
    calls snd_pcm_info() which accesses the now freed `substream->runtime`.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed:  CVE-2017-0861
    Bug: 36006981
    Signed-off-by: Robb Glasser <rglasser@google.com>
    Signed-off-by: Nick Desaulniers <ndesaulniers@google.com>
    Change-Id: I445d24bc21dc0af6d9522a8daabe64969042236a
    ---
    Reviewed-on: https://gerrit.mot.com/1073204
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Guobin Zhang <zhanggb@motorola.com>
    Submit-Approved: Jira Key

diff --git a/sound/core/pcm.c b/sound/core/pcm.c
index 2a456f2d8bd5..900f270b3e73 100644
--- a/sound/core/pcm.c
+++ b/sound/core/pcm.c
@@ -150,7 +150,9 @@ static int snd_pcm_control_ioctl(struct snd_card *card,
 				err = -ENXIO;
 				goto _error;
 			}
+			mutex_lock(&pcm->open_mutex);
 			err = snd_pcm_info_user(substream, info);
+			mutex_unlock(&pcm->open_mutex);
 		_error:
 			mutex_unlock(&register_mutex);
 			return err;
@@ -158,7 +160,6 @@ static int snd_pcm_control_ioctl(struct snd_card *card,
 	case SNDRV_CTL_IOCTL_PCM_PREFER_SUBDEVICE:
 		{
 			int val;
-			
 			if (get_user(val, (int __user *)arg))
 				return -EFAULT;
 			control->prefer_pcm_subdevice = val;
