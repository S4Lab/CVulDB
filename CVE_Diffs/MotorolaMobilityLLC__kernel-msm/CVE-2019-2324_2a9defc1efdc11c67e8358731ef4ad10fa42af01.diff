MotorolaMobilityLLC__kernel-msm
commit 2a9defc1efdc11c67e8358731ef4ad10fa42af01
Author:     Xiaoyu Ye <benyxy@codeaurora.org>
AuthorDate: Tue Jan 15 15:49:59 2019 -0800
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Sun Sep 15 17:27:37 2019 -0500

    ASoC: msm: qdsp6v2: add range check for audio port index
    
    Add range check to make sure the received audio port index
    from ADSP is within the valid range.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2019-2324
    CRs-Fixed: 2372292
    
    Change-Id: Ief647df1659f7f349a843f666d8f92f34a9a43be
    Signed-off-by: Xiaoyu Ye <benyxy@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1354036
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Ravikumar Vembu <raviv@motorola.com>
    Submit-Approved: Jira Key

diff --git a/sound/soc/msm/qdsp6v2/q6asm.c b/sound/soc/msm/qdsp6v2/q6asm.c
index 78a22c5b98b4..783e7495c791 100644
--- a/sound/soc/msm/qdsp6v2/q6asm.c
+++ b/sound/soc/msm/qdsp6v2/q6asm.c
@@ -1524,6 +1524,13 @@ static int32_t q6asm_srvc_callback(struct apr_client_data *data, void *priv)
 	}
 
 	dir = (data->token & 0x0F);
+	if (dir != IN && dir != OUT) {
+		pr_err("%s: Invalid audio port index: %d\n", __func__, dir);
+		if ((sid > 0 && sid <= SESSION_MAX))
+			spin_unlock_irqrestore(
+				&(session[sid].session_lock), flags);
+		return 0;
+	}
 	port = &ac->port[dir];
 
 	switch (data->opcode) {
