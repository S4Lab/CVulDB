MotorolaMobilityLLC__kernel-msm
commit 2dbb78ba781f95571d9ed0f4d707d7e74ad367a7
Author:     Theodore Ts'o <tytso@mit.edu>
AuthorDate: Thu Jun 14 19:44:54 2018 -0400
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Wed Mar 13 21:28:12 2019 -0500

    ext4: verify the depth of extent tree in ext4_find_extent()
    
    If there is a corupted file system where the claimed depth of the
    extent tree is -1, this can cause a massive buffer overrun leading to
    sadness.
    
    https://bugzilla.kernel.org/show_bug.cgi?id=199417
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-10877
    BUG: 116406625
    
    Change-Id: I4b5d2ddd0e408a2a6004374c2e5c6f444b9f5727
    Signed-off-by: Theodore Ts'o <tytso@mit.edu>
    Reviewed-on: https://gerrit.mot.com/1286963
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/fs/ext4/ext4_extents.h b/fs/ext4/ext4_extents.h
index 3c9381547094..2d8e73793512 100644
--- a/fs/ext4/ext4_extents.h
+++ b/fs/ext4/ext4_extents.h
@@ -103,6 +103,7 @@ struct ext4_extent_header {
 };
 
 #define EXT4_EXT_MAGIC		cpu_to_le16(0xf30a)
+#define EXT4_MAX_EXTENT_DEPTH 5
 
 #define EXT4_EXTENT_TAIL_OFFSET(hdr) \
 	(sizeof(struct ext4_extent_header) + \
diff --git a/fs/ext4/extents.c b/fs/ext4/extents.c
index fa43f27f4c45..33a38830413f 100644
--- a/fs/ext4/extents.c
+++ b/fs/ext4/extents.c
@@ -870,6 +870,12 @@ ext4_find_extent(struct inode *inode, ext4_lblk_t block,
 
 	eh = ext_inode_hdr(inode);
 	depth = ext_depth(inode);
+	if (depth < 0 || depth > EXT4_MAX_EXTENT_DEPTH) {
+		EXT4_ERROR_INODE(inode, "inode has invalid extent depth: %d",
+				 depth);
+		ret = -EIO;
+		goto err;
+	}
 
 	if (path) {
 		ext4_ext_drop_refs(path);
