MotorolaMobilityLLC__kernel-msm
commit ca86356db7f4e1e58c3f0d597526a5bb12f1dc59
Author:     Mohammed Javid <mjavid@codeaurora.org>
AuthorDate: Wed Jan 10 11:14:10 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Feb 26 01:01:22 2018 -0600

    msm:ipa: Fix to kasan use-after-free issue
    
    Added mutex lock to query rt table function also to sync
    with other ioctl calls in ipa.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-14877
    CRs-Fixed: 2057803
    BUG: 68992473
    
    Change-Id: I65d46c0ef28b5e6260c92473fd15e9763de20146
    Acked-by: Ashok Vuyyuru <avuyyuru@qti.qualcomm.com>
    Signed-off-by: Mohammed Javid <mjavid@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1115593
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit e2d0dce35e1eb0c3420a7b918964189415f37cc7)

diff --git a/drivers/platform/msm/ipa/ipa_rt.c b/drivers/platform/msm/ipa/ipa_rt.c
index 19c9f871c3b6..b6086cd4be9c 100644
--- a/drivers/platform/msm/ipa/ipa_rt.c
+++ b/drivers/platform/msm/ipa/ipa_rt.c
@@ -828,12 +828,16 @@ int ipa_query_rt_index(struct ipa_ioc_get_rt_tbl_indx *in)
 		return -EINVAL;
 	}
 
+	mutex_lock(&ipa_ctx->lock);
 	/* check if this table exists */
 	entry = __ipa_find_rt_tbl(in->ip, in->name);
-	if (!entry)
+	if (!entry) {
+		mutex_unlock(&ipa_ctx->lock);
 		return -EFAULT;
+	}
 
 	in->idx  = entry->idx;
+	mutex_unlock(&ipa_ctx->lock);
 	return 0;
 }
 
