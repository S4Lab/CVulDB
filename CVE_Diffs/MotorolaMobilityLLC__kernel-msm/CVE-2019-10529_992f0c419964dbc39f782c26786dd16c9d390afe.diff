MotorolaMobilityLLC__kernel-msm
commit 992f0c419964dbc39f782c26786dd16c9d390afe
Author:     Rajesh Kemisetti <rajeshk@codeaurora.org>
AuthorDate: Tue Apr 30 19:04:30 2019 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Dec 9 16:57:15 2019 +0800

    msm: kgsl: Fix race condition while making page as dirty
    
    set_page_dirty() is racy if the caller has no
    reference against page->mapping->host, and if
    the page is unlocked. This is because another
    CPU could truncate the page off the mapping and
    then free the mapping.
    
    Use set_page_dirty_lock() to avoid this race condition.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2019-10529
    CRs-Fixed: 2442261
    
    Change-Id: I517fb9aee66560618c7676b311368f7a7498011f
    Signed-off-by: Rajesh Kemisetti <rajeshk@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1367690
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Ling Jin <lingjin@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/gpu/msm/kgsl.c b/drivers/gpu/msm/kgsl.c
index db33d5d49b3a..86a77373187d 100644
--- a/drivers/gpu/msm/kgsl.c
+++ b/drivers/gpu/msm/kgsl.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2008-2018, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2008-2019, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -318,7 +318,7 @@ kgsl_mem_entry_destroy(struct kref *kref)
 			    entry->memdesc.sgt->nents, i) {
 			page = sg_page(sg);
 			for (j = 0; j < (sg->length >> PAGE_SHIFT); j++)
-				set_page_dirty(nth_page(page, j));
+				set_page_dirty_lock(nth_page(page, j));
 		}
 	}
 
