MotorolaMobilityLLC__kernel-msm
commit d4749427c3d2d3759a0b8daccbea8b74cf120139
Author:     VijayaKumar T M <vtmuni@codeaurora.org>
AuthorDate: Tue Jan 23 18:24:27 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Feb 26 01:02:31 2018 -0600

    msm: camera: isp: Handle array out of bounds
    
    The pointer qbuf_buf comes from userspace.
    qbuf_buf->num_planes is used with no bound check,
    which if set to a large value, it will overflow
    buf_info->mapped_info and qbuf_buf->planes
    
    Bug-id: A-38196031
    CRs-Fixed: 2003798
    CVE-fixed: CVE-2017-17771
    Mot-CRs-fixed: (CR)
    
    Change-Id: I2065a9f282e68fffacfc6ffe3118a572ec395893
    Signed-off-by: Senthil Kumar Rajagopal <skrajago@codeaurora.org>
    Signed-off-by: VijayaKumar T M <vtmuni@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1125721
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 518f05dd56b7c2feba6fd13ab71550ed42246311)

diff --git a/drivers/media/platform/msm/camera_v2/isp/msm_buf_mgr.c b/drivers/media/platform/msm/camera_v2/isp/msm_buf_mgr.c
index 64450454def3..25a45034d45d 100644
--- a/drivers/media/platform/msm/camera_v2/isp/msm_buf_mgr.c
+++ b/drivers/media/platform/msm/camera_v2/isp/msm_buf_mgr.c
@@ -242,6 +242,12 @@ static void msm_isp_unprepare_v4l2_buf(
 	else
 		iommu_hdl = buf_mgr->sec_iommu_hdl;
 
+	if (buf_info->num_planes > VIDEO_MAX_PLANES) {
+		pr_err("%s: Invalid num_planes %d \n",
+			__func__, buf_info->num_planes);
+		return;
+	}
+
 	for (i = 0; i < buf_info->num_planes; i++) {
 		mapped_info = &buf_info->mapped_info[i];
 		if (mapped_info != NULL)
@@ -328,6 +334,12 @@ static int msm_isp_buf_prepare(struct msm_isp_buf_mgr *buf_mgr,
 		return rc;
 	}
 
+	if (buf_info->num_planes > VIDEO_MAX_PLANES) {
+		pr_err("%s: Invalid num_planes %d \n",
+			__func__, buf_info->num_planes);
+		return rc;
+	}
+
 	bufq = msm_isp_get_bufq(buf_mgr, buf_info->bufq_handle);
 	if (!bufq) {
 		pr_err("%s: Invalid bufq\n",
