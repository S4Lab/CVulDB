MotorolaMobilityLLC__kernel-msm
commit be1807254c52f21578cfd5d876d8574f0fd248f8
Author:     Haibin Liu <haibinl@codeaurora.org>
AuthorDate: Thu Dec 28 20:42:37 2017 +0800
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Jun 26 02:23:56 2018 -0500

    msm: sensor: actuator: fix out of bound read for region params
    
    Issue:
    the region index is not validated against the region size.
    this cause out-of-bound read on the KASAN kernel.
    
    Fix:
    Add restriction that region index smaller than region size.
    
    Bug-id: A-65122765
    CRs-Fixed: 2153841
    CVE-fixed: CVE-2017-15857
    Mot-CRs-fixed: (CR)
    
    Change-Id: I141bba45662769f0661c947fb642c2671578f32e
    Signed-off-by: Haibin Liu <haibinl@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1161537
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 834dc73f670a76e8237a80f9d11ffac3c675e272)

diff --git a/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c b/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
index feea7cea443d..af287f15461f 100644
--- a/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
+++ b/drivers/media/platform/msm/camera_v2/sensor/actuator/msm_actuator.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2011-2017, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2011-2018, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -638,6 +638,8 @@ static int32_t msm_actuator_move_focus(
 		a_ctrl->curr_step_pos, dest_step_pos, curr_lens_pos);
 
 	while (a_ctrl->curr_step_pos != dest_step_pos) {
+		if (a_ctrl->curr_region_index >= a_ctrl->region_size)
+			break;
 		step_boundary =
 			a_ctrl->region_params[a_ctrl->curr_region_index].
 			step_bound[dir];
@@ -758,6 +760,8 @@ static int32_t msm_actuator_bivcm_move_focus(
 		a_ctrl->curr_step_pos, dest_step_pos, curr_lens_pos);
 
 	while (a_ctrl->curr_step_pos != dest_step_pos) {
+		if (a_ctrl->curr_region_index >= a_ctrl->region_size)
+			break;
 		step_boundary =
 			a_ctrl->region_params[a_ctrl->curr_region_index].
 			step_bound[dir];
diff --git a/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c b/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c
index 2eba02ca6e80..8f1cf498546e 100644
--- a/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c
+++ b/drivers/media/platform/msm/camera_v2_2016/sensor/actuator/msm_actuator.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2011-2016, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2011-2018, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -623,6 +623,8 @@ static int32_t msm_actuator_move_focus(
 		a_ctrl->curr_step_pos, dest_step_pos, curr_lens_pos);
 
 	while (a_ctrl->curr_step_pos != dest_step_pos) {
+		if (a_ctrl->curr_region_index >= a_ctrl->region_size)
+			break;
 		step_boundary =
 			a_ctrl->region_params[a_ctrl->curr_region_index].
 			step_bound[dir];
@@ -743,6 +745,8 @@ static int32_t msm_actuator_bivcm_move_focus(
 		a_ctrl->curr_step_pos, dest_step_pos, curr_lens_pos);
 
 	while (a_ctrl->curr_step_pos != dest_step_pos) {
+		if (a_ctrl->curr_region_index >= a_ctrl->region_size)
+			break;
 		step_boundary =
 			a_ctrl->region_params[a_ctrl->curr_region_index].
 			step_bound[dir];
