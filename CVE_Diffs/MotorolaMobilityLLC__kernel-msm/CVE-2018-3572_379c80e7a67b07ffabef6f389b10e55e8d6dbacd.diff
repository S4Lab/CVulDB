MotorolaMobilityLLC__kernel-msm
commit 379c80e7a67b07ffabef6f389b10e55e8d6dbacd
Author:     Vignesh Kulothungan <vigneshk@codeaurora.org>
AuthorDate: Fri Mar 30 10:48:49 2018 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Wed Mar 13 21:28:26 2019 -0500

    msm: Array bounds check for buffer index
    
    PROPAGATED_from (CR)
    
    Check the ASM buffer index boundary before using it
    to access the buffer to avoid out of array bounds error.
    
    CVE-Fixed: CVE-2018-3572
    CRs-Fixed: 2145996
    
    Change-Id: I97ad482dec0803debd01f19a9aeb531090fc1644
    Signed-off-by: vigneshk <vigneshk@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1156442
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    Signed-off-by: Eduardo Ferreira <edufb@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1288865

diff --git a/sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c b/sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c
index b64b3720f13e..12fda4723ba3 100644
--- a/sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c
+++ b/sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c
@@ -187,6 +187,11 @@ static void event_handler(uint32_t opcode,
 		break;
 	case ASM_DATA_EVENT_READ_DONE_V2: {
 		pr_debug("ASM_DATA_EVENT_READ_DONE_V2\n");
+		if (token >= CAPTURE_MAX_NUM_PERIODS) {
+			pr_err("%s: token %u is out of range.\n",
+				__func__, token);
+			return;
+		}
 		pr_debug("token = 0x%08x\n", token);
 		prtd->in_frame_info[token].size = payload[4];
 		prtd->in_frame_info[token].offset = payload[5];
