MotorolaMobilityLLC__kernel-msm
commit e9eedd25aeb017c70d4ad1d437ae9c58ad8809e2
Author:     hyeonsu9.lee <hyeonsu9.lee@samsung.com>
AuthorDate: Wed Mar 23 17:08:39 2016 +0900
Commit:     Chenjie Luo <cjluo@google.com>
CommitDate: Tue Mar 29 23:44:10 2016 +0000

    msm: vidc: Do sanity check for different IOCTL cmd
    
    BUG=27634656
    
    Wrong buffer length or buffer type sent by V4L2 client
    is not handled properly in V4L2 framework, which results
    in page fault situation in different IOCTL functions
    like prepare buf. Do a sanity check for the same.
    
    Add this patch for CVE-2016-2410
    
    Change-Id: I9d7a11cab988c9cbb2a587e3d2bc461dc521a38f
    Signed-off-by: hyeonsu9.lee <hyeonsu9.lee@samsung.com>

diff --git a/drivers/media/platform/msm/vidc/msm_vidc.c b/drivers/media/platform/msm/vidc/msm_vidc.c
index 3122c876f4fa..7470b7731288 100644
--- a/drivers/media/platform/msm/vidc/msm_vidc.c
+++ b/drivers/media/platform/msm/vidc/msm_vidc.c
@@ -721,6 +721,13 @@ int msm_vidc_prepare_buf(void *instance, struct v4l2_buffer *b)
 	if (!inst || !b)
 		return -EINVAL;
 
+	if (!V4L2_TYPE_IS_MULTIPLANAR(b->type) || !b->length ||
+		(b->length > VIDEO_MAX_PLANES)) {
+		dprintk(VIDC_ERR, "%s: wrong input params\n",
+				__func__);
+		return -EINVAL;
+	}
+
 	if (is_dynamic_output_buffer_mode(b, inst)) {
 		dprintk(VIDC_ERR, "%s: not supported in dynamic buffer mode\n",
 				__func__);
@@ -875,9 +882,10 @@ int msm_vidc_qbuf(void *instance, struct v4l2_buffer *b)
 	if (!inst || !b)
 		return -EINVAL;
 
-	if (b->length > VIDEO_MAX_PLANES) {
-		dprintk(VIDC_ERR, "num planes exceeds max: %d\n",
-			b->length);
+	if (!V4L2_TYPE_IS_MULTIPLANAR(b->type) || !b->length ||
+		(b->length > VIDEO_MAX_PLANES)) {
+		dprintk(VIDC_ERR, "%s: wrong input params\n",
+				__func__);
 		return -EINVAL;
 	}
 
@@ -958,9 +966,10 @@ int msm_vidc_dqbuf(void *instance, struct v4l2_buffer *b)
 	if (!inst || !b)
 		return -EINVAL;
 
-	if (b->length > VIDEO_MAX_PLANES) {
-		dprintk(VIDC_ERR, "num planes exceed maximum: %d\n",
-			b->length);
+	if (!V4L2_TYPE_IS_MULTIPLANAR(b->type) || !b->length ||
+		(b->length > VIDEO_MAX_PLANES)) {
+		dprintk(VIDC_ERR, "%s: wrong input params\n",
+				__func__);
 		return -EINVAL;
 	}
 
