MotorolaMobilityLLC__kernel-msm
commit 2080787ddf223fe59a096571762aa747f7ab5bb7
Author:     VijayaKumar T M <vtmuni@codeaurora.org>
AuthorDate: Mon Aug 7 15:21:31 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Dec 14 23:30:43 2017 -0600

    msm: sensor: Add mutex lock during ois power down operations
    
    Protecting operations performed during ois powerdown
    from race condition by adding mutex locks.
    
    CRs-Fixed: 2081806
    CVE-fixed: CVE-2017-9708
    Bug-ID: A-62674846
    Mot-CRs-fixed: (CR), (CR)
    
    Change-Id: I27a735fd69d3e98fdd2ed48456336c560b6f3adc
    Signed-off-by: VijayaKumar T M <vtmuni@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1089233
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 6349aec580690d4c335f7b0a20b5168632975e44)

diff --git a/drivers/media/platform/msm/camera_v2/sensor/ois/msm_ois.c b/drivers/media/platform/msm/camera_v2/sensor/ois/msm_ois.c
index c190a697b443..96605ba5dfb0 100644
--- a/drivers/media/platform/msm/camera_v2/sensor/ois/msm_ois.c
+++ b/drivers/media/platform/msm/camera_v2/sensor/ois/msm_ois.c
@@ -670,11 +670,13 @@ static long msm_ois_subdev_ioctl(struct v4l2_subdev *sd,
 			pr_err("o_ctrl->i2c_client.i2c_func_tbl NULL\n");
 			return -EINVAL;
 		}
+		mutex_lock(o_ctrl->ois_mutex);
 		rc = msm_ois_power_down(o_ctrl);
 		if (rc < 0) {
 			pr_err("%s:%d OIS Power down failed\n",
 				__func__, __LINE__);
 		}
+		mutex_unlock(o_ctrl->ois_mutex);
 		return msm_ois_close(sd, NULL);
 	default:
 		return -ENOIOCTLCMD;
diff --git a/drivers/media/platform/msm/camera_v2_2016/sensor/ois/msm_ois.c b/drivers/media/platform/msm/camera_v2_2016/sensor/ois/msm_ois.c
index c190a697b443..96605ba5dfb0 100644
--- a/drivers/media/platform/msm/camera_v2_2016/sensor/ois/msm_ois.c
+++ b/drivers/media/platform/msm/camera_v2_2016/sensor/ois/msm_ois.c
@@ -670,11 +670,13 @@ static long msm_ois_subdev_ioctl(struct v4l2_subdev *sd,
 			pr_err("o_ctrl->i2c_client.i2c_func_tbl NULL\n");
 			return -EINVAL;
 		}
+		mutex_lock(o_ctrl->ois_mutex);
 		rc = msm_ois_power_down(o_ctrl);
 		if (rc < 0) {
 			pr_err("%s:%d OIS Power down failed\n",
 				__func__, __LINE__);
 		}
+		mutex_unlock(o_ctrl->ois_mutex);
 		return msm_ois_close(sd, NULL);
 	default:
 		return -ENOIOCTLCMD;
