MotorolaMobilityLLC__kernel-msm
commit 56b4ea4b054f6a450cb3f9656f34ecbb3cfd36d8
Author:     Naseer Ahmed <naseer@codeaurora.org>
AuthorDate: Wed Jan 11 12:00:14 2017 -0500
Commit:     Ashwin Kumar Pathmudi <jfxr63@motorola.com>
CommitDate: Mon Mar 20 04:50:48 2017 -0500

    mdss: Validate cursor image size
    
    Check size of cursor image provided by userspace to avoid buffer
    overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0579
    
    Bug: 34125463
    Change-Id: I31aee3c9219921cf5c4306b36f8708582b838c38
    Signed-off-by: Naseer Ahmed <naseer@codeaurora.org>
    Signed-off-by: Steve Pfetsch <spfetsch@google.com>
    Reviewed-on: https://gerrit.mot.com/964019
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Shi-Yong Li <a22381@motorola.com>
    Reviewed-by: Bang Nguyen <bangnguyen@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/video/msm/mdss/mdss_mdp_overlay.c b/drivers/video/msm/mdss/mdss_mdp_overlay.c
index bfd2e71c1321..880f466ecca1 100644
--- a/drivers/video/msm/mdss/mdss_mdp_overlay.c
+++ b/drivers/video/msm/mdss/mdss_mdp_overlay.c
@@ -4062,6 +4062,12 @@ static int mdss_mdp_hw_cursor_pipe_update(struct msm_fb_data_type *mfd,
 	req->transp_mask = img->bg_color & ~(0xff << var->transp.offset);
 
 	if (mfd->cursor_buf && (cursor->set & FB_CUR_SETIMAGE)) {
+		if (img->width * img->height * 4 > cursor_frame_size) {
+			pr_err("cursor image size is too large\n");
+			ret = -EINVAL;
+			goto done;
+		}
+
 		ret = copy_from_user(mfd->cursor_buf, img->data,
 				     img->width * img->height * 4);
 		if (ret) {
