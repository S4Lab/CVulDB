MotorolaMobilityLLC__kernel-msm
commit 7a5c2f8a8de9b96ccb5453cb8c57bc98590b8451
Author:     Mark Rutland <mark.rutland@arm.com>
AuthorDate: Wed Oct 19 19:28:13 2016 +0100
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Jun 12 04:11:23 2018 -0500

    UPSTREAM: thread_info: include <current.h> for THREAD_INFO_IN_TASK
    
    When CONFIG_THREAD_INFO_IN_TASK is selected, the current_thread_info()
    macro relies on current having been defined prior to its use. However,
    not all users of current_thread_info() include <asm/current.h>, and thus
    current is not guaranteed to be defined.
    
    When CONFIG_THREAD_INFO_IN_TASK is not selected, it's possible that
    get_current() / current are based upon current_thread_info(), and
    <asm/current.h> includes <asm/thread_info.h>. Thus always including
    <asm/current.h> would result in circular dependences on some platforms.
    
    To ensure both cases work, this patch includes <asm/current.h>, but only
    when CONFIG_THREAD_INFO_IN_TASK is selected.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2018-9384
    Bug: 74356909
    
    Signed-off-by: Mark Rutland <mark.rutland@arm.com>
    Acked-by: Heiko Carstens <heiko.carstens@de.ibm.com>
    Reviewed-by: Perry Lutomirski <luto@kernel.org>
    Cc: Andrew Morton <akpm@linux-foundation.org>
    Cc: Kees Cook <keescook@chromium.org>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    
    Bug: 66351489
    Change-Id: I6cf6a30a83167e77508f6a0632961dadd4070766
    (cherry picked from commit dc3d2a679cd8631b8a570fc8ca5f4712d7d25698)
    Signed-off-by: Zubin Mithra <zsm@google.com>
    Reviewed-on: https://gerrit.mot.com/1182390
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 39515938081c1ef50b22590750ae8da6b3318768)

diff --git a/include/linux/thread_info.h b/include/linux/thread_info.h
index e8369b0d71e1..8933ecc2bc9f 100644
--- a/include/linux/thread_info.h
+++ b/include/linux/thread_info.h
@@ -12,17 +12,12 @@
 #include <linux/restart_block.h>
 
 #ifdef CONFIG_THREAD_INFO_IN_TASK
-struct thread_info {
-	u32			flags;		/* low level flags */
-};
-
-#define INIT_THREAD_INFO(tsk)			\
-{						\
-	.flags		= 0,			\
-}
-#endif
-
-#ifdef CONFIG_THREAD_INFO_IN_TASK
+/*
+ * For CONFIG_THREAD_INFO_IN_TASK kernels we need <asm/current.h> for the
+ * definition of current, but for !CONFIG_THREAD_INFO_IN_TASK kernels,
+ * including <asm/current.h> can cause a circular dependency on some platforms.
+ */
+#include <asm/current.h>
 #define current_thread_info() ((struct thread_info *)current)
 #endif
 
