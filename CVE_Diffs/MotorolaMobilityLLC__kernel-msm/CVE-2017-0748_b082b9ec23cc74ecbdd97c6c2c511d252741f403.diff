MotorolaMobilityLLC__kernel-msm
commit b082b9ec23cc74ecbdd97c6c2c511d252741f403
Author:     kunleiz <kunleiz@codeaurora.org>
AuthorDate: Mon Jul 17 12:10:28 2017 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Mar 12 16:30:33 2018 +0800

    ASoC: msm: qdspv2: add result check when audio process fail
    
    A audio_process_event_req is not always to success. Therefore,
    check the return value for audio_process_event_req, and
    initializ usr_evt before using it.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-0748
    Bug-Id: A-35764875
    CRs-Fixed: 2029798
    Signed-off-by: kunleiz <kunleiz@codeaurora.org>
    --
    
    Change-Id: Ia5fdee88474d66fb6d5d306a730c10a6ccfbe055
    Signed-off-by: Neeraj Kumar <neerajk@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1027480
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c b/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c
index c12f791a1739..1633383991ef 100644
--- a/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c
+++ b/drivers/misc/qcom/qdsp6v2/audio_utils_aio.c
@@ -851,6 +851,7 @@ static long audio_aio_process_event_req_compat(struct q6audio_aio *audio,
 	long rc;
 	struct msm_audio_event32 usr_evt_32;
 	struct msm_audio_event usr_evt;
+	memset(&usr_evt, 0, sizeof(struct msm_audio_event));
 
 	if (copy_from_user(&usr_evt_32, arg,
 				sizeof(struct msm_audio_event32))) {
@@ -860,6 +861,11 @@ static long audio_aio_process_event_req_compat(struct q6audio_aio *audio,
 	usr_evt.timeout_ms = usr_evt_32.timeout_ms;
 
 	rc = audio_aio_process_event_req_common(audio, &usr_evt);
+	if (rc < 0) {
+		pr_err("%s: audio process event failed, rc = %ld",
+			__func__, rc);
+		return rc;
+	}
 
 	usr_evt_32.event_type = usr_evt.event_type;
 	switch (usr_evt_32.event_type) {
