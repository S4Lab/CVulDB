MotorolaMobilityLLC__kernel-msm
commit 909eef63cb47a781ce6abf74864c0b6cd26af20f
Author:     Neeraj Soni <neersoni@codeaurora.org>
AuthorDate: Wed Jan 2 20:55:34 2019 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Sun Sep 15 17:26:57 2019 -0500

    msm: ice: check for crypto engine availability
    
    There can be many ice instances present in dtsi file but
    not all of them will be initialized by storage driver.
    Check if crypto instance is initialized before setting
    it up for data encryption/decryption usage.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2019-2323
    CRs-Fixed: 2370589
    
    Change-Id: I7c9227007474052513b277dec5963a973781c524
    Signed-off-by: Neeraj Soni <neersoni@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1354573
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/crypto/msm/ice.c b/drivers/crypto/msm/ice.c
index 22027d3baf5e..372c5099dbb9 100644
--- a/drivers/crypto/msm/ice.c
+++ b/drivers/crypto/msm/ice.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2014-2017, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2014-2019, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -1667,7 +1667,7 @@ int qcom_ice_setup_ice_hw(const char *storage_type, int enable)
 	if (ice_dev == ERR_PTR(-EPROBE_DEFER))
 		return -EPROBE_DEFER;
 
-	if (!ice_dev)
+	if (!ice_dev || (ice_dev->is_ice_enabled == false))
 		return ret;
 
 	if (enable)
