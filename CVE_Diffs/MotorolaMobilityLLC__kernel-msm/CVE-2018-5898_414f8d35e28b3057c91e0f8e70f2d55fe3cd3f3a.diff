MotorolaMobilityLLC__kernel-msm
commit 414f8d35e28b3057c91e0f8e70f2d55fe3cd3f3a
Author:     Sreelakshmi Gownipalli <sgownipa@codeaurora.org>
AuthorDate: Wed May 16 10:23:15 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Wed Jul 4 05:00:23 2018 -0500

    diag: Add conditional check for len in dci_process_ctrl_status()
    
    Add correct conditional check for len in dci_process_ctrl_status() to
    prevent buffer overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2018-5898
    Bug: 70528036
    CRs-fixed: 2172685
    
    Change-Id: Id73ed1c8b104428eceef0544ce2858160cc08fd2
    Signed-off-by: Sreelakshmi Gownipalli <sgownipa@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1175977
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/char/diag/diag_dci.c b/drivers/char/diag/diag_dci.c
index 37cc6c777421..e42bb2cead1f 100644
--- a/drivers/char/diag/diag_dci.c
+++ b/drivers/char/diag/diag_dci.c
@@ -831,7 +831,7 @@ static void dci_process_ctrl_status(unsigned char *buf, int len, int token)
 	read_len += sizeof(struct diag_ctrl_dci_status);
 
 	for (i = 0; i < header->count; i++) {
-		if (read_len > len) {
+		if (read_len > (len - 2)) {
 			pr_err("diag: In %s, Invalid length len: %d\n",
 			       __func__, len);
 			return;
