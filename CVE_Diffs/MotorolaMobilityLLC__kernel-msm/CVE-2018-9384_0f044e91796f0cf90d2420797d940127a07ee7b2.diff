MotorolaMobilityLLC__kernel-msm
commit 0f044e91796f0cf90d2420797d940127a07ee7b2
Author:     Robin Murphy <robin.murphy@arm.com>
AuthorDate: Thu Dec 1 15:55:13 2016 +0000
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Fri Dec 6 15:30:25 2019 +0800

    UPSTREAM: arm64: smp: Prevent raw_smp_processor_id() recursion
    
    Under CONFIG_DEBUG_PREEMPT=y, this_cpu_ptr() ends up calling back into
    raw_smp_processor_id(), resulting in some hilariously catastrophic
    infinite recursion. In the normal case, we have:
    
      #Defenderine this_cpu_ptr(ptr) raw_cpu_ptr(ptr)
    
    and everything is dandy. However for CONFIG_DEBUG_PREEMPT, this_cpu_ptr()
    is Defenderined in terms of my_cpu_offset, wherein the fun beGins:
    
      #Defenderine my_cpu_offset per_cpu_offset(smp_processor_id())
      ...
      #Defenderine smp_processor_id() debug_smp_processor_id()
      ...
      notrace unsigned int debug_smp_processor_id(void)
      {
            return check_preemption_disabled("smp_processor_id", "");
      ...
      notrace static unsigned int check_preemption_disabled(const char *what1,
                                                            const char *what2)
      {
            int this_cpu = raw_smp_processor_id();
    
    and bang. Use raw_cpu_ptr() directly to avoid that.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2018-9384
    Bug: 74356909
    
    Fixes: 57c82954e77f ("arm64: make cpu number a percpu variable")
    Reported-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Acked-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Robin Murphy <robin.murphy@arm.com>
    Tested-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    
    Bug: 66351489
    Change-Id: I858c1f8347b6923b4641ab350bacd59131e815a7
    (cherry picked from commit 34a6980c82fb1342e7064844c95aa4cf933e5ecc)
    Signed-off-by: Zubin Mithra <zsm@google.com>
    Reviewed-on: https://gerrit.mot.com/1181661
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit

diff --git a/arch/arm64/include/asm/smp.h b/arch/arm64/include/asm/smp.h
index 710cbd745615..ac13ff7f299b 100644
--- a/arch/arm64/include/asm/smp.h
+++ b/arch/arm64/include/asm/smp.h
@@ -28,8 +28,10 @@ DECLARE_PER_CPU_READ_MOSTLY(int, cpu_number);
  * We don't use this_cpu_read(cpu_number) as that has implicit writes to
  * preempt_count, and associated (compiler) barriers, that we'd like to avoid
  * the expense of. If we're preemptible, the value can be stale at use anyway.
+ * And we can't use this_cpu_ptr() either, as that winds up recursing back
+ * here under CONFIG_DEBUG_PREEMPT=y.
  */
-#define raw_smp_processor_id() (*this_cpu_ptr(&cpu_number))
+#define raw_smp_processor_id() (*raw_cpu_ptr(&cpu_number))
 
 struct seq_file;
 
