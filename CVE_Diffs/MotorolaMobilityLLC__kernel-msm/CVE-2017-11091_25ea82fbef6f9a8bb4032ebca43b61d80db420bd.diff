MotorolaMobilityLLC__kernel-msm
commit 25ea82fbef6f9a8bb4032ebca43b61d80db420bd
Author:     Harsh Sahu <hsahu@codeaurora.org>
AuthorDate: Thu Jun 29 18:50:20 2017 -0700
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Dec 4 07:23:13 2017 -0600

    msm: mdss: fix the use after free problem in rotator ioctl
    
    Currently the fence fd is installed too early. This can cause a
    use after free problem if the fence fd is closed in some other thread.
    This change will install the fence fd where it is required and
    eliminates the problem.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-11091
    
    Change-Id: I5cf585ea87ef75fccae06da6cb5a6c16fc74eff3
    Signed-off-by: Harsh Sahu <hsahu@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1078657
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/video/msm/mdss/mdss_rotator.c b/drivers/video/msm/mdss/mdss_rotator.c
index 019621b67b3a..d5db31f86478 100644
--- a/drivers/video/msm/mdss/mdss_rotator.c
+++ b/drivers/video/msm/mdss/mdss_rotator.c
@@ -373,6 +373,15 @@ static bool mdss_rotator_is_work_pending(struct mdss_rot_mgr *mgr,
 	return false;
 }
 
+static void mdss_rotator_install_fence_fd(struct mdss_rot_entry_container *req)
+{
+	int i = 0;
+
+	for (i = 0; i < req->count; i++)
+		sync_fence_install(req->entries[i].output_fence,
+				req->entries[i].output_fence_fd);
+}
+
 static int mdss_rotator_create_fence(struct mdss_rot_entry *entry)
 {
 	int ret = 0, fd;
@@ -411,7 +420,6 @@ static int mdss_rotator_create_fence(struct mdss_rot_entry *entry)
 		goto get_fd_err;
 	}
 
-	sync_fence_install(fence, fd);
 	rot_timeline->next_value++;
 	mutex_unlock(&rot_timeline->lock);
 
@@ -2234,6 +2242,7 @@ static int mdss_rotator_handle_request(struct mdss_rot_mgr *mgr,
 		goto handle_request_err1;
 	}
 
+	mdss_rotator_install_fence_fd(req);
 	mdss_rotator_queue_request(mgr, private, req);
 
 	mutex_unlock(&mgr->lock);
@@ -2394,6 +2403,7 @@ static int mdss_rotator_handle_request32(struct mdss_rot_mgr *mgr,
 		goto handle_request32_err1;
 	}
 
+	mdss_rotator_install_fence_fd(req);
 	mdss_rotator_queue_request(mgr, private, req);
 
 	mutex_unlock(&mgr->lock);
