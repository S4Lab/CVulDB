MotorolaMobilityLLC__kernel-msm
commit 42befac698590556edbba9fb168139a6c71e8274
Author:     Marc Zyngier <marc.zyng...@arm.com>
AuthorDate: Thu Dec 28 15:57:25 2017 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Sun Apr 15 23:23:38 2018 -0500

    ARM: Handle trapping of CNTFRQ from userspace
    
    As we're about to enable trapping of some of the userspace-visible
    timer registers, let's add a handler for CNTFRQ.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-13218
    Bug: 68266545
    
    Change-Id: I819db456806c51c69527a584553fa7fc43062c9a
    Signed-off-by: Marc Zyngier <marc.zyng...@arm.com>
    Signed-off-by: amarenr <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1110292
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/arch/arm/kernel/traps.c b/arch/arm/kernel/traps.c
index 7dc2fec29eb8..58eace948609 100644
--- a/arch/arm/kernel/traps.c
+++ b/arch/arm/kernel/traps.c
@@ -781,6 +781,22 @@ void __bad_xchg(volatile void *ptr, int size)
 EXPORT_SYMBOL(__bad_xchg);
 
 #ifdef CONFIG_ARM_ARCH_TIMER
+static int read_cntfrq_trap(struct pt_regs *regs, unsigned int instr)
+{
+	int reg = (instr >> 12) & 15;
+	if (reg == 15)
+		return 1;
+	regs->uregs[reg] = arch_timer_get_rate();
+	regs->ARM_pc += 4;
+	return 0;
+}
+
+static struct undef_hook cntfrq_hook = {
+	.instr_mask     = 0x0fff0fff,
+	.instr_val      = 0x0e1e0f10,
+	.fn             = read_cntfrq_trap,
+};
+
 static int read_cntvct_trap(struct pt_regs *regs, unsigned int instr)
 {
 	int rt  = (instr >> 12) & 15;
@@ -802,6 +818,7 @@ static struct undef_hook cntvct_hook = {
 static int __init arch_timer_hook_init(void)
 {
 	register_undef_hook(&cntvct_hook);
+	register_undef_hook(&cntfrq_hook);
 	return 0;
 }
 
