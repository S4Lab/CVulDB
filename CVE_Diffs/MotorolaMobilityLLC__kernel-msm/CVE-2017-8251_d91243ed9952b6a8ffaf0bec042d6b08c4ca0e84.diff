MotorolaMobilityLLC__kernel-msm
commit d91243ed9952b6a8ffaf0bec042d6b08c4ca0e84
Author:     Senthil Kumar Rajagopal <skrajago@codeaurora.org>
AuthorDate: Sat Mar 4 12:05:44 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Sep 26 04:33:53 2017 -0500

    msm: camera: isp: fix for out of bound access array
    
    There is no bound check in stream_cfg_cmd->num_streams,
    in functions msm_isp_check_stream_cfg_cmd and
    msm_isp_stats_update_cgc_override num_streams is used as
    the index for stream_cfg_cmd->stream_handle array which
    has a size of 15. Current code did not check the num_streams
    to make sure that did not exceed the array size
    
    CRs-Fixed: 2006015
    CVE-fixed: CVE-2017-8251
    Mot-CRs-fixed: (CR)
    
    Change-Id: I7f195c764a4e6c12e4f7c680bc3c9aa7b078e625
    Signed-off-by: Senthil Kumar Rajagopal <skrajago@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1014294
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Robert Kubicki <w17311@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit dd608baea9897775ec37979d3cf53e81d4f5e281)

diff --git a/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c b/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c
index e48664acdce7..98d3a5995e64 100644
--- a/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c
+++ b/drivers/media/platform/msm/camera_v2/isp/msm_isp_stats_util.c
@@ -433,6 +433,12 @@ static int msm_isp_stats_update_cgc_override(struct vfe_device *vfe_dev,
 	int i;
 	uint32_t stats_mask = 0, idx;
 
+	if (stream_cfg_cmd->num_streams > MSM_ISP_STATS_MAX) {
+		pr_err("%s invalid num_streams %d\n", __func__,
+			stream_cfg_cmd->num_streams);
+		return -EINVAL;
+	}
+
 	for (i = 0; i < stream_cfg_cmd->num_streams; i++) {
 		idx = STATS_IDX(stream_cfg_cmd->stream_handle[i]);
 
@@ -460,6 +466,11 @@ static int msm_isp_start_stats_stream(struct vfe_device *vfe_dev,
 	struct msm_vfe_stats_stream *stream_info;
 	struct msm_vfe_stats_shared_data *stats_data = &vfe_dev->stats_data;
 
+       if (stream_cfg_cmd->num_streams > MSM_ISP_STATS_MAX) {
+               pr_err("%s invalid num_streams %d\n", __func__,
+                       stream_cfg_cmd->num_streams);
+               return -EINVAL;
+       }
 	num_stats_comp_mask =
 		vfe_dev->hw_info->stats_hw_info->num_stats_comp_mask;
 	rc = vfe_dev->hw_info->vfe_ops.stats_ops.check_streams(
