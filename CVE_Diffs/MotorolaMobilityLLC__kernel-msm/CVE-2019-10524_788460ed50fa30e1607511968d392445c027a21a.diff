MotorolaMobilityLLC__kernel-msm
commit 788460ed50fa30e1607511968d392445c027a21a
Author:     Sumalatha Malothu <smalot@codeaurora.org>
AuthorDate: Mon Apr 29 18:05:53 2019 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Sep 24 02:37:43 2019 -0500

    msm: camera_v2: handle the error value returned during get clock
    
    currently only NULL pointer check is used to validate the return
    value from clk_get, this change to handle all the failures.
    This snapshot is taken from msm-4.9
    Ported it from 4.9 to 3.18
    
    CRs-fixed: 2422233
    CVE-fixed: CVE-2019-10524
    Mot-CRs-fixed: (CR)
    
    Change-Id: Id218023f580a6a37ca91245afae70c67102e42ae
    Signed-off-by: Sumalatha Malothu <smalot@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1380932
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Ravikumar Vembu <raviv@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit e8c85f95b54dcf25216115208e1029dc1f04a4c0)

diff --git a/drivers/media/platform/msm/camera_v2/common/msm_camera_io_util.c b/drivers/media/platform/msm/camera_v2/common/msm_camera_io_util.c
index 0f2648ab0464..a1f3409d57e8 100644
--- a/drivers/media/platform/msm/camera_v2/common/msm_camera_io_util.c
+++ b/drivers/media/platform/msm/camera_v2/common/msm_camera_io_util.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2011-2014, 2017-2018, The Linux Foundation.
+/* Copyright (c) 2011-2014, 2017-2019, The Linux Foundation.
  * All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
@@ -367,12 +367,13 @@ int msm_cam_clk_enable(struct device *dev, struct msm_cam_clk_info *clk_info,
 		}
 	} else {
 		for (i = num_clk - 1; i >= 0; i--) {
-			if (clk_ptr[i] != NULL) {
+			if (!IS_ERR_OR_NULL(clk_ptr[i])) {
 				CDBG("%s disable %s\n", __func__,
 					clk_info[i].clk_name);
 				clk_disable(clk_ptr[i]);
 				clk_unprepare(clk_ptr[i]);
 				clk_put(clk_ptr[i]);
+				clk_ptr[i] = NULL;
 			}
 		}
 	}
@@ -386,10 +387,11 @@ cam_clk_set_err:
 	clk_put(clk_ptr[i]);
 cam_clk_get_err:
 	for (i--; i >= 0; i--) {
-		if (clk_ptr[i] != NULL) {
+		if (!IS_ERR_OR_NULL(clk_ptr[i])) {
 			clk_disable(clk_ptr[i]);
 			clk_unprepare(clk_ptr[i]);
 			clk_put(clk_ptr[i]);
+			clk_ptr[i] = NULL;
 		}
 	}
 	return rc;
