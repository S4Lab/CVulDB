MotorolaMobilityLLC__kernel-msm
commit 73898b9d6688ff63b3a7ed0c15db7b5b0033d40e
Author:     Benjamin Chan <bkchan@codeaurora.org>
AuthorDate: Mon Mar 6 11:48:27 2017 -0500
Commit:     Ashwin Kumar Pathmudi <jfxr63@motorola.com>
CommitDate: Tue May 23 05:28:45 2017 -0500

    msm: mdss: Add lock to avoid release of active session in rotator
    
    Add mutex lock to protect an active rotator session from being closed.
    Without the lock, this can happen if a rotator closing IOCTL is
    called from a separate thread.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-7370
    CRs-Fixed: 2006159
    Change-Id: I927a0c626bdae5ef149e12979ec4befdbac1b7f7
    Signed-off-by: Benjamin Chan <bkchan@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/997388
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/video/msm/mdss/mdss_rotator.c b/drivers/video/msm/mdss/mdss_rotator.c
index ea7bc7bbec3f..055c5d22b2d2 100644
--- a/drivers/video/msm/mdss/mdss_rotator.c
+++ b/drivers/video/msm/mdss/mdss_rotator.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2014-2016, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2014-2017, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -2059,10 +2059,12 @@ static int mdss_rotator_config_session(struct mdss_rot_mgr *mgr,
 		return ret;
 	}
 
+	mutex_lock(&mgr->lock);
 	perf = mdss_rotator_find_session(private, config.session_id);
 	if (!perf) {
 		pr_err("No session with id=%u could be found\n",
 			config.session_id);
+		mutex_unlock(&mgr->lock);
 		return -EINVAL;
 	}
 
@@ -2085,6 +2087,7 @@ static int mdss_rotator_config_session(struct mdss_rot_mgr *mgr,
 		config.output.format);
 done:
 	ATRACE_END(__func__);
+	mutex_unlock(&mgr->lock);
 	return ret;
 }
 
