MotorolaMobilityLLC__kernel-msm
commit 381d63d76239c6a4c698bad2bd1028d0743ef53d
Author:     Neeraj Soni <neersoni@codeaurora.org>
AuthorDate: Wed Jan 2 20:55:34 2019 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Dec 9 16:57:15 2019 +0800

    msm: ice: check for crypto enGine availability
    
    There can be many ice instances present in dtsi file but
    not all of them will be initialized by storage driver.
    Check if crypto instance is initialized before setting
    it up for data encryption/decryption usage.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2019-2323
    CRs-Fixed: 2370589
    
    Change-Id: I7c9227007474052513b277dec5963a973781c524
    Signed-off-by: Neeraj Soni <neersoni@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1354561
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/crypto/msm/ice.c b/drivers/crypto/msm/ice.c
index bdce8aaedf52..74bc36837031 100644
--- a/drivers/crypto/msm/ice.c
+++ b/drivers/crypto/msm/ice.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2014-2017, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2014-2019, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -1666,7 +1666,7 @@ int qcom_ice_setup_ice_hw(const char *storage_type, int enable)
 	if (ice_dev == ERR_PTR(-EPROBE_DEFER))
 		return -EPROBE_DEFER;
 
-	if (!ice_dev)
+	if (!ice_dev || (ice_dev->is_ice_enabled == false))
 		return ret;
 
 	if (enable)
