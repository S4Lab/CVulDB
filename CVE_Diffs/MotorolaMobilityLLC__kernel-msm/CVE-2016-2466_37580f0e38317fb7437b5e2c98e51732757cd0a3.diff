MotorolaMobilityLLC__kernel-msm
commit 37580f0e38317fb7437b5e2c98e51732757cd0a3
Author:     Neeraj Kumar <neerajk@motorola.com>
AuthorDate: Fri Jun 3 14:03:56 2016 +0530
Commit:     Charles Barros <charlesb@motorola.com>
CommitDate: Thu Jan 26 18:35:37 2017 -0200

    CVE-2016-2466 - Add additional bounds checking
    
    Android Partner Security Bulletin for May 2016.
    
    Elevation of Privilege Vulnerability in Qualcomm Sound Driver.
    ----------------------------------------------
    Add additional bounds checking to ADM get params.
    Validate that all buffer sizes are valid before
    dereferencing.
    
    Change-Id: If7c7a5ae6a56812e9c4a11a38c9bdc78f42d09f3
    Signed-off-by: Ben Romberger <bromberg@codeaurora.org>
    ----------------------------------------------
    Reviewed-on: http://gerrit.mot.com/863812
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Vrushali Prakash Bhosale <wkvq37@motorola.com>
    Reviewed-by: Christopher Fries <cfries@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/sound/soc/msm/qdsp6v2/q6adm.c b/sound/soc/msm/qdsp6v2/q6adm.c
index e8d07671d33b..bef03f2504e1 100644
--- a/sound/soc/msm/qdsp6v2/q6adm.c
+++ b/sound/soc/msm/qdsp6v2/q6adm.c
@@ -510,10 +510,16 @@ int adm_get_params(int port_id, uint32_t module_id, uint32_t param_id,
 	}
 	if ((params_data) && (ARRAY_SIZE(adm_get_parameters) >=
 		(1+adm_get_parameters[0])) &&
-		(params_length/sizeof(uint32_t) >=
+		(params_length/sizeof(int) >=
 		adm_get_parameters[0])) {
 		for (i = 0; i < adm_get_parameters[0]; i++)
 			params_data[i] = adm_get_parameters[1+i];
+	} else {
+		pr_err("%s: Get param data not copied! get_param array size %zd, index %d, params array size %zd, index %d\n",
+		__func__, ARRAY_SIZE(adm_get_parameters),
+		(1+adm_get_parameters[0]),
+		params_length/sizeof(int),
+		adm_get_parameters[0]);
 	}
 	rc = 0;
 adm_get_param_return:
@@ -806,12 +812,11 @@ static int32_t adm_callback(struct apr_client_data *data, void *priv)
 			/* is big enough and has a valid param size */
 			if ((payload[0] == 0) && (data->payload_size >
 				(4 * sizeof(*payload))) &&
-				(data->payload_size - 4 >=
+				(data->payload_size/sizeof(*payload)-4 >=
 				payload[3]) &&
 				(ARRAY_SIZE(adm_get_parameters)-1 >=
 				payload[3])) {
-				adm_get_parameters[0] = payload[3] /
-							sizeof(uint32_t);
+				adm_get_parameters[0] = payload[3];
 				/*
 				 * payload[3] is param_size which is
 				 * expressed in number of bytes
@@ -819,8 +824,7 @@ static int32_t adm_callback(struct apr_client_data *data, void *priv)
 				pr_debug("%s: GET_PP PARAM:received parameter length: 0x%x\n",
 					__func__, adm_get_parameters[0]);
 				/* storing param size then params */
-				for (i = 0; i < payload[3] /
-						sizeof(uint32_t); i++)
+				for (i = 0; i < payload[3]; i++)
 					adm_get_parameters[1+i] = payload[4+i];
 			} else {
 				adm_get_parameters[0] = -1;
