MotorolaMobilityLLC__kernel-msm
commit 29c1ce0ddc5058194c190a8f8c7150be739cc173
Author:     Mishra Mahima <mahima@codeaurora.org>
AuthorDate: Tue Jul 11 13:52:07 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Thu Oct 12 02:14:58 2017 -0500

    msm: mdss: Increase fbmem buf ref count before use
    
    The reference count for fbmem buf is not increased before use,
    which means it can be get freed unintentionally when the reference
    count is decreased to "0". In this case, there is possibility of
    use after free. Ensure that fbmem buf refcount is incremented
    before use.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-11048
    
    Change-Id: I525d41e5496a1123e53a438b5f78d4da8bc046bd
    Signed-off-by: Jayant Shekhar <jshekhar@codeaurora.org>
    Signed-off-by: Mishra Mahima <mahima@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1065970
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/video/msm/mdss/mdss_mdp_overlay.c b/drivers/video/msm/mdss/mdss_mdp_overlay.c
index a66e88ec1cc9..195086b3a948 100644
--- a/drivers/video/msm/mdss/mdss_mdp_overlay.c
+++ b/drivers/video/msm/mdss/mdss_mdp_overlay.c
@@ -4538,11 +4538,14 @@ static int mdss_fb_get_metadata(struct msm_fb_data_type *mfd,
 		break;
 	case metadata_op_get_ion_fd:
 		if (mfd->fb_ion_handle) {
+			get_dma_buf(mfd->fbmem_buf);
 			metadata->data.fbmem_ionfd =
 				dma_buf_fd(mfd->fbmem_buf, 0);
-			if (metadata->data.fbmem_ionfd < 0)
+			if (metadata->data.fbmem_ionfd < 0) {
+				dma_buf_put(mfd->fbmem_buf);
 				pr_err("fd allocation failed. fd = %d\n",
 						metadata->data.fbmem_ionfd);
+			}
 		}
 		break;
 	case metadata_op_crc:
