MotorolaMobilityLLC__kernel-msm
commit 54402f7f5bb1c2963981f936c09113528ff734b6
Author:     Mohammed Javid <mjavid@codeaurora.org>
AuthorDate: Mon Aug 26 16:46:31 2019 +0530
Commit:     Anandappan Chakravarthy <pjwt34@motorola.com>
CommitDate: Wed Sep 11 01:11:16 2019 -0500

    msm: ipa: Protect ipa Defenderault routing table
    
    Protect ipa Defenderault routing table from
    addition, deletion and modification once after
    Defenderault rule added by ipa-driver.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-13900
    CRs-Fixed: 2287499
    BUG: 119052051
    
    Signed-off-by: Mohammed Javid <mjavid@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1410262
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit c4a12c399ccebe0940a0e09cd7fec2b6712447c4)
    
    Change-Id: I23dac188a0423bc6af9dcc31a7b191f7e619e775
    Reviewed-on: https://gerrit.mot.com/1418704
    SME-Granted: SME Approvals Granted
    Submit-Approved: Jira Key
    Tested-by: Jira Key
    Reviewed-by: Ling Jin <lingjin@motorola.com>
    SLTApproved: Sindhu C <a12924@motorola.com>

diff --git a/drivers/platform/msm/ipa/ipa_v2/ipa_rt.c b/drivers/platform/msm/ipa/ipa_v2/ipa_rt.c
index 7cc3c380ee71..39a10a218f47 100644
--- a/drivers/platform/msm/ipa/ipa_v2/ipa_rt.c
+++ b/drivers/platform/msm/ipa/ipa_v2/ipa_rt.c
@@ -1061,13 +1061,12 @@ static int __ipa_add_rt_rule(enum ipa_ip_type ip, const char *name,
 		goto error;
 	}
 	/*
-	 * do not allow any rules to be added at end of the "default" routing
+	 * do not allow any rule to be added at "default" routing
 	 * tables
 	 */
 	if (!strncmp(tbl->name, IPA_DFLT_RT_TBL_NAME, IPA_RESOURCE_NAME_MAX) &&
-	    (tbl->rule_cnt > 0) && (at_rear != 0)) {
-		IPAERR("cannot add rule at end of tbl rule_cnt=%d at_rear=%d\n",
-		       tbl->rule_cnt, at_rear);
+	    (tbl->rule_cnt > 0)) {
+		IPAERR("cannot add rules to default rt table\n");
 		goto error;
 	}
 
@@ -1537,6 +1536,11 @@ static int __ipa_mdfy_rt_rule(struct ipa_rt_rule_mdfy *rtrule)
 		goto error;
 	}
 
+	if (!strcmp(entry->tbl->name, IPA_DFLT_RT_TBL_NAME)) {
+		IPAERR_RL("Default tbl rule cannot be modified\n");
+		return -EINVAL;
+	}
+
 	/* Adding check to confirm still
 	 * header entry present in header table or not
 	 */
