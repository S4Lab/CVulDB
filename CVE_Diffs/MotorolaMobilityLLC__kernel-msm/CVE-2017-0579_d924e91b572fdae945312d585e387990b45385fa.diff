MotorolaMobilityLLC__kernel-msm
commit d924e91b572fdae945312d585e387990b45385fa
Author:     Naseer Ahmed <naseer@codeaurora.org>
AuthorDate: Wed Jan 11 12:00:14 2017 -0500
Commit:     zhangly19 <zhangly19@lenovo.com>
CommitDate: Mon Apr 15 10:44:44 2019 +0800

    mdss: Validate cursor image size
    
    Check size of cursor image provided by userspace to avoid buffer
    overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0579
    
    Bug: 34125463
    Change-Id: I31aee3c9219921cf5c4306b36f8708582b838c38
    Signed-off-by: Naseer Ahmed <naseer@codeaurora.org>
    Signed-off-by: Steve Pfetsch <spfetsch@google.com>
    Reviewed-on: https://gerrit.mot.com/1165996
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Guobin Zhang <zhanggb@motorola.com>
    Submit-Approved: Shanshan Dai <daiss1@mt.com>

diff --git a/drivers/video/fbdev/msm/mdss_mdp_overlay.c b/drivers/video/fbdev/msm/mdss_mdp_overlay.c
index 4c5da2d8f6bd..ff181497249a 100644
--- a/drivers/video/fbdev/msm/mdss_mdp_overlay.c
+++ b/drivers/video/fbdev/msm/mdss_mdp_overlay.c
@@ -4906,6 +4906,12 @@ static int mdss_mdp_hw_cursor_pipe_update(struct msm_fb_data_type *mfd,
 	req->transp_mask = img->bg_color & ~(0xff << var->transp.offset);
 
 	if (mfd->cursor_buf && (cursor->set & FB_CUR_SETIMAGE)) {
+		if (img->width * img->height * 4 > cursor_frame_size) {
+			pr_err("cursor image size is too large\n");
+			ret = -EINVAL;
+			goto done;
+		}
+
 		ret = copy_from_user(mfd->cursor_buf, img->data,
 				     img->width * img->height * 4);
 		if (ret) {
