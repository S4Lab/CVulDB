MotorolaMobilityLLC__kernel-msm
commit c176074eff149e97bc18ada6a5feaeb9d177b910
Author:     Johan Hovold <johan@kernel.org>
AuthorDate: Tue Feb 20 11:26:07 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Mar 20 22:25:47 2018 -0500

    USB: serial: console: fix use-after-free after failed setup
    
    Make sure to reset the USB-console port pointer when console setup fails
    in order to avoid having the struct usb_serial be prematurely freed by
    the console code when the device is later disconnected.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-16525
    BUG: 69050921
    
    Change-Id: I77a1596f1596a800dc96d48ecb1c1372398e3c2c
    Fixes: 73e487f ("[PATCH] USB console: fix disconnection issues")
    Cc: stable <stable@vger.kernel.org>     # 2.6.18
    Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Reviewed-on: https://gerrit.mot.com/1137508
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 80732f3e5b6fd3a426fe5b72aabcd8f4452e4c85)

diff --git a/drivers/usb/serial/console.c b/drivers/usb/serial/console.c
index 3806e7014199..2938153fe7b1 100644
--- a/drivers/usb/serial/console.c
+++ b/drivers/usb/serial/console.c
@@ -189,6 +189,7 @@ static int usb_console_setup(struct console *co, char *options)
 	tty_kref_put(tty);
  reset_open_count:
 	port->port.count = 0;
+	info->port = NULL;
 	usb_autopm_put_interface(serial->interface);
  error_get_interface:
 	usb_serial_put(serial);
