MotorolaMobilityLLC__kernel-msm
commit 8585917cf593930e35852a00505d0dabd9fad53f
Author:     Ashwin Pathmudi <jfxr63@motorola.com>
AuthorDate: Thu Feb 1 20:56:28 2018 +0530
Commit:     Vijayakumar Gn <vijaygn@motorola.com>
CommitDate: Mon Feb 5 23:51:30 2018 -0600

    input: synaptics_dsx: Free buffer before releasing rmidev
    
    CVE-fixed: CVE-2017-9723
    
    Change-Id: I34b38e7f5d39ea7ff3a7a03f3a55d31e2dbac930
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1128523
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Konstantin Makariev <kmakariev@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
index 3d7fc706f89d..c8552e66d498 100644
--- a/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
+++ b/drivers/input/touchscreen/synaptics_dsx_rmi_dev.c
@@ -475,12 +475,20 @@ static int rmidev_release(struct inode *inp, struct file *filp)
 {
 	struct rmidev_data *dev_data =
 			container_of(inp->i_cdev, struct rmidev_data, main_dev);
+	struct temp_buffer *tb;
 
 	if (!dev_data)
 		return -EACCES;
 
 	mutex_lock(&(dev_data->file_mutex));
 
+	tb = &dev_data->data_buf;
+	if (tb->buf_size != 0) {
+		kfree(tb->buf);
+		tb->buf = NULL;
+		tb->buf_size = 0;
+	}
+
 	dev_data->ref_count--;
 	if (dev_data->ref_count < 0)
 		dev_data->ref_count = 0;
