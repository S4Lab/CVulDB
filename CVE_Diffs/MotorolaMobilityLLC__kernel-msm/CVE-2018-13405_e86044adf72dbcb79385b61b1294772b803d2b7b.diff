MotorolaMobilityLLC__kernel-msm
commit e86044adf72dbcb79385b61b1294772b803d2b7b
Author:     Linus Torvalds <torvalds@linux-foundation.org>
AuthorDate: Tue Jul 3 17:10:19 2018 -0700
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Feb 11 01:10:19 2019 -0600

    Fix up non-directory creation in SGID directories
    
    sgid directories have special semantics, making newly created files in
    the directory belong to the group of the directory, and newly created
    subdirectories will also become sgid.  This is historically used for
    group-shared directories.
    
    But group directories writable by non-group members should not imply
    that such non-group members can magically join the group, so make sure
    to clear the sgid bit on non-directories for non-members (but remember
    that sgid without group execute means "mandatory locking", just to
    confuse things even more).
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-13405
    BUG: 113452403
    
    Change-Id: I1f650173a7f8a184a9baf5ef8dda3ead0bff19f6
    Reported-by: Jann Horn <jannh@google.com>
    Cc: Perry Lutomirski <luto@kernel.org>
    Cc: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Reviewed-on: https://gerrit.mot.com/1286959
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/fs/inode.c b/fs/inode.c
index 3844c3122f1a..1d1a9573ca70 100644
--- a/fs/inode.c
+++ b/fs/inode.c
@@ -2003,8 +2003,14 @@ void inode_init_owner(struct inode *inode, const struct inode *dir,
 	inode->i_uid = current_fsuid();
 	if (dir && dir->i_mode & S_ISGID) {
 		inode->i_gid = dir->i_gid;
+
+		/* Directories are special, and always inherit S_ISGID */
 		if (S_ISDIR(mode))
 			mode |= S_ISGID;
+		else if ((mode & (S_ISGID | S_IXGRP)) == (S_ISGID | S_IXGRP) &&
+			 !in_group_p(inode->i_gid) &&
+			 !capable_wrt_inode_uidgid(dir, CAP_FSETID))
+			mode &= ~S_ISGID;
 	} else
 		inode->i_gid = current_fsgid();
 	inode->i_mode = mode;
