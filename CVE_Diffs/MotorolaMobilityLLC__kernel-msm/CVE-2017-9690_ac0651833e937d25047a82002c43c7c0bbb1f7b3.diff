MotorolaMobilityLLC__kernel-msm
commit ac0651833e937d25047a82002c43c7c0bbb1f7b3
Author:     Abir Ghosh <abirg@codeaurora.org>
AuthorDate: Fri May 12 09:16:34 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Tue Dec 19 20:32:12 2017 -0600

    qbt1000: Fix for incorrect buffer size check and integer overflow
    
    Fix an incorrect buffer size check which might have caused integer
    overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-9690
    CRs-Fixed: 2045285
    
    Change-Id: I3b5b996c7405f51b488d6cbda31c81a9a9905f23
    Signed-off-by: Abir Ghosh <abirg@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1028732
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    Reviewed-on: https://gerrit.mot.com/1104553
    Tested-by: Jira Key
    Reviewed-by: Amarendra Reddy <amarenr@motorola.com>
    Reviewed-by: Sindhu C <a12924@motorola.com>
    SLTApproved: Sindhu C <a12924@motorola.com>

diff --git a/drivers/soc/qcom/qbt1000.c b/drivers/soc/qcom/qbt1000.c
index 2739b573252e..43acd86735fe 100644
--- a/drivers/soc/qcom/qbt1000.c
+++ b/drivers/soc/qcom/qbt1000.c
@@ -107,14 +107,16 @@ static int get_cmd_rsp_buffers(struct qseecom_handle *hdl,
 	uint32_t *rsp_len)
 {
 	/* 64 bytes alignment for QSEECOM */
-	*cmd_len = ALIGN(*cmd_len, 64);
-	*rsp_len = ALIGN(*rsp_len, 64);
+	uint64_t aligned_cmd_len = ALIGN((uint64_t)*cmd_len, 64);
+	uint64_t aligned_rsp_len = ALIGN((uint64_t)*rsp_len, 64);
 
-	if ((*rsp_len + *cmd_len) > g_app_buf_size)
+	if ((aligned_rsp_len + aligned_cmd_len) > (uint64_t)g_app_buf_size)
 		return -ENOMEM;
 
 	*cmd = hdl->sbuf;
+	*cmd_len = aligned_cmd_len;
 	*rsp = hdl->sbuf + *cmd_len;
+	*rsp_len = aligned_rsp_len;
 
 	return 0;
 }
