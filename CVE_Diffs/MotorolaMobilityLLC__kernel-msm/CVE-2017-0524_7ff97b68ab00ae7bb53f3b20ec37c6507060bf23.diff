MotorolaMobilityLLC__kernel-msm
commit 7ff97b68ab00ae7bb53f3b20ec37c6507060bf23
Author:     Ashwin Pathmudi <jfxr63@motorola.com>
AuthorDate: Mon Mar 6 17:18:36 2017 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Tue Feb 19 15:00:34 2019 -0600

    input: synaptics_dsx: Place file offset validity checks under mutex
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0524, CVE-2017-0536
    
    Change-Id: Idba9da177dbc543f98acf713c031171fdb391d48
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/961116
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Konstantin Makariev <kmakariev@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
index 1912461c9a37..889df401d73c 100644
--- a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
+++ b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
@@ -336,14 +336,23 @@ static ssize_t rmidev_read(struct file *filp, char __user *buf,
 		return -EBADF;
 	}
 
-	if (count == 0)
-		return 0;
+	mutex_lock(&(dev_data->file_mutex));
+
 
 	if (count > (REG_ADDR_LIMIT - *f_pos))
 		count = REG_ADDR_LIMIT - *f_pos;
 
+	if (count == 0) {
+		retval = 0;
+		goto clean_up;
+	}
+
+	if (*f_pos > REG_ADDR_LIMIT) {
+		retval = -EFAULT;
+		goto clean_up;
+	}
+
 	tb = &dev_data->data_buf;
-	mutex_lock(&(dev_data->file_mutex));
 
 	if (tb->buf_size < count && alloc_buffer(tb, count) != 0) {
 		retval = -ENOMEM;
@@ -388,14 +397,22 @@ static ssize_t rmidev_write(struct file *filp, const char __user *buf,
 		return -EBADF;
 	}
 
-	if (count == 0)
-		return 0;
+	mutex_lock(&(dev_data->file_mutex));
+
+	if (*f_pos > REG_ADDR_LIMIT) {
+		retval = -EFAULT;
+		goto clean_up;
+	}
 
 	if (count > (REG_ADDR_LIMIT - *f_pos))
 		count = REG_ADDR_LIMIT - *f_pos;
 
+	if (count == 0) {
+		retval = 0;
+		goto clean_up;
+	}
+
 	tb = &dev_data->data_buf;
-	mutex_lock(&(dev_data->file_mutex));
 
 	if (tb->buf_size < count && alloc_buffer(tb, count) != 0) {
 		retval = -ENOMEM;
