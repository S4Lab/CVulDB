MotorolaMobilityLLC__kernel-msm
commit e4d8e8fd65fbd3b36afc6dc1402fd1b4776e6c48
Author:     Sunil Khatri <sunilkh@codeaurora.org>
AuthorDate: Thu Apr 6 18:28:31 2017 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Sep 4 23:39:10 2017 -0500

    msm: kgsl: Fix the race between context create and destroy
    
    Hold the context lock before updating the context id in
    param->drawctxt_id to avoid race condition between context
    creation and context destroy.
    
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-9682
    
    Change-Id: Ic26d3e5b68078c02d15c38080b1a262ea4b1f7fe
    Signed-off-by: Sunil Khatri <sunilkh@codeaurora.org>
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1026295
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 89fa90a0912797d2439bbc2f0baba3cfcc42293b)

diff --git a/drivers/gpu/msm/kgsl.c b/drivers/gpu/msm/kgsl.c
index 4eea94077643..274b09800f1c 100644
--- a/drivers/gpu/msm/kgsl.c
+++ b/drivers/gpu/msm/kgsl.c
@@ -2586,9 +2586,9 @@ long kgsl_ioctl_drawctxt_create(struct kgsl_device_private *dev_priv,
 	/* Commit the pointer to the context in context_idr */
 	write_lock(&device->context_lock);
 	idr_replace(&device->context_idr, context, context->id);
+	param->drawctxt_id = context->id;
 	write_unlock(&device->context_lock);
 
-	param->drawctxt_id = context->id;
 done:
 	mutex_unlock(&device->mutex);
 	return result;
