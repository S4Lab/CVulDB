MotorolaMobilityLLC__kernel-msm
commit 950cacddcdaf1fa3650f0631a7d4ea088ba04d94
Author:     Srikanth A R <arsrikan@motorola.com>
AuthorDate: Wed Oct 5 18:45:34 2016 +0530
Commit:     chenll4 <chenll4@motorola.com>
CommitDate: Fri Oct 21 08:51:15 2016 +0800

    ion: Fix is to disable ION heap type
    
    A malicious application can take advantage of the ION kmalloc heap to
    create a specific memory chunk size to exercise a rowhammer attack on
    the physical hardware.The fix is designed to disable ION heap type.
    
    Mot-CRs-fixed: (CR), (CR)
    CVE-Fixed : CVE-2016-6728, CVE-2016-6737
    
    Change-Id: I9410135dc98cff3a9a62c3cdbb650d4a99e06654
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/906546
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Robert Kubicki <w17311@motorola.com>
    Reviewed-by: Christopher Fries <cfries@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    (cherry picked from commit 0e19b616f6b5311c89068e783292155a29199cdd)
    Reviewed-on: https://gerrit.mot.com/910735
    Reviewed-by: Igor Kovalenko <igork@motorola.com>

diff --git a/drivers/staging/android/ion/ion_heap.c b/drivers/staging/android/ion/ion_heap.c
index cb2622e3312d..e39fad1a44c9 100644
--- a/drivers/staging/android/ion/ion_heap.c
+++ b/drivers/staging/android/ion/ion_heap.c
@@ -302,8 +302,9 @@ struct ion_heap *ion_heap_create(struct ion_platform_heap *heap_data)
 
 	switch (heap_data->type) {
 	case ION_HEAP_TYPE_SYSTEM_CONTIG:
-		heap = ion_system_contig_heap_create(heap_data);
-		break;
+		pr_err("%s: Heap type is disabled: %d\n", __func__,
+		       heap_data->type);
+		return ERR_PTR(-EINVAL);
 	case ION_HEAP_TYPE_SYSTEM:
 		heap = ion_system_heap_create(heap_data);
 		break;
@@ -342,7 +343,8 @@ void ion_heap_destroy(struct ion_heap *heap)
 
 	switch (heap->type) {
 	case ION_HEAP_TYPE_SYSTEM_CONTIG:
-		ion_system_contig_heap_destroy(heap);
+		pr_err("%s: Heap type is disabled: %d\n", __func__,
+		       heap->type);
 		break;
 	case ION_HEAP_TYPE_SYSTEM:
 		ion_system_heap_destroy(heap);
