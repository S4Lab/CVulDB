MotorolaMobilityLLC__kernel-msm
commit 553c71ec2e9b01286ad0ed4c1b8968f8bf3683d7
Author:     Naseer Ahmed <naseer@codeaurora.org>
AuthorDate: Wed Jan 11 12:00:14 2017 -0500
Commit:     Fan Hang <hangfan1@lenovo.com>
CommitDate: Tue Oct 17 09:27:18 2017 +0800

    mdss: Validate cursor image size
    
    Check size of cursor image provided by userspace to avoid buffer
    overflow.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-0579
    
    Bug: 34125463
    Change-Id: I31aee3c9219921cf5c4306b36f8708582b838c38
    Signed-off-by: Naseer Ahmed <naseer@codeaurora.org>
    Signed-off-by: Steve Pfetsch <spfetsch@google.com>
    Reviewed-on: https://gerrit.mot.com/964019
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Shi-Yong Li <a22381@motorola.com>
    Reviewed-by: Bang Nguyen <bangnguyen@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    (cherry picked from commit bdf00fc5bdda0e4d0d9a9cd5b7c3fbcee33d5f13)
    Reviewed-on: https://gerrit.mot.com/991650
    Reviewed-by: Qiang Nie <nieqiang2@mt.com>
    SLTApproved: Qiang Nie <nieqiang2@mt.com>
    Submit-Approved: Qiang Nie <nieqiang2@mt.com>

diff --git a/drivers/video/msm/mdss/mdss_mdp_overlay.c b/drivers/video/msm/mdss/mdss_mdp_overlay.c
index 37f5b98384ab..e8cb61520352 100644
--- a/drivers/video/msm/mdss/mdss_mdp_overlay.c
+++ b/drivers/video/msm/mdss/mdss_mdp_overlay.c
@@ -4024,6 +4024,12 @@ static int mdss_mdp_hw_cursor_pipe_update(struct msm_fb_data_type *mfd,
 	req->transp_mask = img->bg_color & ~(0xff << var->transp.offset);
 
 	if (mfd->cursor_buf && (cursor->set & FB_CUR_SETIMAGE)) {
+		if (img->width * img->height * 4 > cursor_frame_size) {
+			pr_err("cursor image size is too large\n");
+			ret = -EINVAL;
+			goto done;
+		}
+
 		ret = copy_from_user(mfd->cursor_buf, img->data,
 				     img->width * img->height * 4);
 		if (ret) {
