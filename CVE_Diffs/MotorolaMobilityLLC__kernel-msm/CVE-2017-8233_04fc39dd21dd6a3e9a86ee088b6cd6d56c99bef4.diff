MotorolaMobilityLLC__kernel-msm
commit 04fc39dd21dd6a3e9a86ee088b6cd6d56c99bef4
Author:     Pratap Nirujogi <pratapn@codeaurora.org>
AuthorDate: Mon Feb 20 17:29:33 2017 +0530
Commit:     Srikanth A R <arsrikan@motorola.com>
CommitDate: Tue May 16 01:15:14 2017 -0500

    msm: camera: cpp: Fixing Heap overflow in output buffer
    
    Issue:
    Missing bound check when writing into the output array
    buffer, which can lead to out-of-bound heap write.
    
    Fix:
    Addding hardcoded constant 8 in the MSM_OUTPUT_BUF_CNT
    macro and size check to the place where the array is
    accessed. Returning '0' if exceeds MSM_OUTPUT_BUF_CNT.
    Caller will return -EINVAL for '0'.
    
    CRs-Fixed: 2004036
    Mot-CRs-fixed: (CR)
    CVE-fixed: CVE-2017-8233
    
    Change-Id: I021cad1e11c5e7c2d2f5bf3f3425d8ca7a458e91
    Signed-off-by: Pratap Nirujogi <pratapn@codeaurora.org>
    Signed-off-by: Srikanth A R <arsrikan@motorola.com>
    Reviewed-on: https://gerrit.mot.com/993191
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/media/platform/msm/camera_v2_2016/pproc/cpp/msm_cpp.c b/drivers/media/platform/msm/camera_v2_2016/pproc/cpp/msm_cpp.c
index 29cb00bec897..d7b451009ad6 100644
--- a/drivers/media/platform/msm/camera_v2_2016/pproc/cpp/msm_cpp.c
+++ b/drivers/media/platform/msm/camera_v2_2016/pproc/cpp/msm_cpp.c
@@ -1865,6 +1865,8 @@ static int msm_cpp_check_buf_type(struct msm_buf_mngr_info *buff_mgr_info,
 			/* More or equal bufs as Input buffer */
 			num_output_bufs = new_frame->batch_info.batch_size;
 		}
+		if (num_output_bufs > MSM_OUTPUT_BUF_CNT)
+			return 0;
 		for (i = 0; i < num_output_bufs; i++) {
 			new_frame->output_buffer_info[i].index =
 				buff_mgr_info->user_buf.buf_idx[i];
