MotorolaMobilityLLC__kernel-msm
commit 8539e135d3f2d4373d1483abfd0b672453124102
Author:     Mahesh Sivasubramanian <msivasub@codeaurora.org>
AuthorDate: Wed Mar 7 16:00:07 2018 -0700
Commit:     lulu2 <lulu2@lenovo.com>
CommitDate: Mon Jun 11 16:49:56 2018 +0800

    drivers: qcom: lpm-stats: Fix undefined access error
    
    In cleanup_stats(), a freed memory pointer pos might be accessed for
    list traversal. Switch to using _safe() variant of the list API to
    prevent undefined accesses.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-5904
    CRs-Fixed: 2184702
    
    Change-Id: I7d068cb7813ccb9bfdbcab4646b4ec890145828a
    Signed-off-by: Mahesh Sivasubramanian <msivasub@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1186441
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/power/qcom/lpm-stats.c b/drivers/power/qcom/lpm-stats.c
index 7f1967d432b7..195d1601a06b 100644
--- a/drivers/power/qcom/lpm-stats.c
+++ b/drivers/power/qcom/lpm-stats.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2012-2016, The Linux Foundation. All rights reserved.
+/* Copyright (c) 2012-2016, 2018, The Linux Foundation. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 and
@@ -682,11 +682,14 @@ static void cleanup_stats(struct lpm_stats *stats)
 {
 	struct list_head *centry = NULL;
 	struct lpm_stats *pos = NULL;
+	struct lpm_stats *n = NULL;
 
 	centry = &stats->child;
-	list_for_each_entry_reverse(pos, centry, sibling) {
-		if (!list_empty(&pos->child))
+	list_for_each_entry_safe_reverse(pos, n, centry, sibling) {
+		if (!list_empty(&pos->child)) {
 			cleanup_stats(pos);
+			continue;
+		}
 
 		list_del_init(&pos->child);
 
