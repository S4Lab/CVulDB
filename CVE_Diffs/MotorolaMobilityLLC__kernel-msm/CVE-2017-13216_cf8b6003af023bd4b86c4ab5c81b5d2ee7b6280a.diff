MotorolaMobilityLLC__kernel-msm
commit cf8b6003af023bd4b86c4ab5c81b5d2ee7b6280a
Author:     Viktor Slavkovic <viktors@google.com>
AuthorDate: Fri Dec 22 11:58:11 2017 +0530
Commit:     a7301c <a7301c@motorola.com>
CommitDate: Sun Apr 15 23:23:38 2018 -0500

    staging: android: ashmem: fix a race condition in ASHMEM_SET_SIZE ioctl
    
    A lock-unlock is missing in ASHMEM_SET_SIZE ioctl which can result in a
    race condition when mmap is called. After the !asma->file check, before
    setting asma->size, asma->file can be set in mmap. That would result in
    having different asma->size than the mapped memory size. Combined with
    ASHMEM_UNPIN ioctl and shrinker invocation, this can result in memory
    corruption.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-13216
    Bug: 66954097
    Signed-off-by: Viktor Slavkovic <viktors@google.com>
    Change-Id: I268225133f96fde0fadd1ec621aafef27d392d65
    Signed-off-by: amarenr <amarenr@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1108297
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/staging/android/ashmem.c b/drivers/staging/android/ashmem.c
index f13aab21da4a..f39983c87c29 100644
--- a/drivers/staging/android/ashmem.c
+++ b/drivers/staging/android/ashmem.c
@@ -672,10 +672,12 @@ static long ashmem_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
 		break;
 	case ASHMEM_SET_SIZE:
 		ret = -EINVAL;
+		mutex_lock(&ashmem_mutex);
 		if (!asma->file) {
 			ret = 0;
 			asma->size = (size_t) arg;
 		}
+		mutex_unlock(&ashmem_mutex);
 		break;
 	case ASHMEM_GET_SIZE:
 		ret = asma->size;
