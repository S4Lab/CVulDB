MotorolaMobilityLLC__kernel-msm
commit 69e2839fde1b0ac589bca7bffdfa111fb4ec9dce
Author:     Manu Gautam <mgautam@codeaurora.org>
AuthorDate: Tue Apr 5 15:20:47 2016 +0530
Commit:     Chenjie Luo <cjluo@google.com>
CommitDate: Thu Jul 7 17:22:07 2016 +0000

    usb: f_serial: Check for SMD data length in GSER_IOCTL
    
    If user tries to send SMD data more than the driver
    buffer can handle then fail the same and print
    error message. This smd_write is exposed to userspace
    through ioctl using a misc device.
    
    CVE:CVE-2016-2502 Bug:ANDROID-27657963
    
    Change-Id: Ie8a1c1c0799cd10cef512ad6b1e1e95001dd43b2
    Signed-off-by: Manu Gautam <mgautam@codeaurora.org>

diff --git a/drivers/usb/gadget/f_serial.c b/drivers/usb/gadget/f_serial.c
index 7190194adf01..c51c5b8eb09f 100644
--- a/drivers/usb/gadget/f_serial.c
+++ b/drivers/usb/gadget/f_serial.c
@@ -1358,6 +1358,13 @@ static long gser_ioctl(struct file *fp, unsigned cmd, unsigned long arg)
 		smd_port_num =
 			gserial_ports[gser->port_num].client_port_num;
 
+		if (smd_write_arg.size > GSERIAL_BUF_LEN) {
+			pr_err("%s: Invalid size:%u, max: %u", __func__,
+				smd_write_arg.size, GSERIAL_BUF_LEN);
+			ret = -EINVAL;
+			break;
+		}
+
 		pr_debug("%s: Copying %d bytes from user buffer to local\n",
 			__func__, smd_write_arg.size);
 
