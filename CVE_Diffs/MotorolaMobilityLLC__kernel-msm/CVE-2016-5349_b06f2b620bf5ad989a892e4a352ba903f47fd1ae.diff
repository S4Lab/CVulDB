MotorolaMobilityLLC__kernel-msm
commit b06f2b620bf5ad989a892e4a352ba903f47fd1ae
Author:     Zhen Kong <zkong@codeaurora.org>
AuthorDate: Wed Sep 7 16:22:11 2016 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon May 8 00:50:28 2017 -0500

    qseecom: Change whitelist_support flag to false if TZ failed to check
    
    The whitelist status is set default as true though TZ failed to check,
    which in turn causing the send_command fail by passing whitelist commnd id.
    So updating the support status flag to false when TZ fails to check.
    
    Mot-CRs-fixed:(CR)
    CVE-Fixed:CVE-2016-5349
    CRs-fixed:1021945
    Bug:29083830
    
    Change-Id: I41b3a977c743b88319f377b0e9c3661fb9ab1b47
    Signed-off-by: Mallikarjuna Reddy Amireddy <mamire@codeaurora.org>
    Signed-off-by: Zhen Kong <zkong@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/980051
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/drivers/misc/qseecom.c b/drivers/misc/qseecom.c
index 21348eb7cd70..21cbc44ba4e5 100644
--- a/drivers/misc/qseecom.c
+++ b/drivers/misc/qseecom.c
@@ -5520,8 +5520,10 @@ static int qseecom_open(struct inode *inode, struct file *file)
 	atomic_set(&data->ioctl_count, 0);
 
 	data->sglistinfo_ptr = kzalloc(SGLISTINFO_TABLE_SIZE, GFP_KERNEL);
-	if (!(data->sglistinfo_ptr))
+	if (!(data->sglistinfo_ptr)) {
+		kzfree(data);
 		return -ENOMEM;
+	}
 	return ret;
 }
 
@@ -5789,8 +5791,10 @@ static int qseecom_check_whitelist_feature(void)
 		qseecom.whitelist_support = true;
 		ret = 0;
 	} else {
-		pr_err("Failed to check whitelist: ret = %d, result = 0x%x\n",
+		pr_info("Check whitelist with ret = %d, result = 0x%x\n",
 			ret, resp.result);
+		qseecom.whitelist_support = false;
+		ret = 0;
 	}
 	kfree(buf);
 	return ret;
