MotorolaMobilityLLC__kernel-msm
commit d2af18d22add76d24f76bb7c6e82e8992cf207e5
Author:     Mohammed Javid <mjavid@codeaurora.org>
AuthorDate: Thu Jan 11 16:59:50 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Mon Feb 26 01:01:32 2018 -0600

    msm: ipa: Fix to use after free issue
    
    Added to code changes to ref_cnt variable will decrement only
    when add_ref_hdr variable is true.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2017-14881
    CRs-Fixed: 2087492
    BUG: 68992478
    
    Change-Id: I0bcc3909669f4843c43135e5f047ac28fa62bb63
    Acked-by: Ashok Vuyyuru <avuyyuru@qti.qualcomm.com>
    Signed-off-by: Mohammed Javid <mjavid@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1116449
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit b987babbe36a3dab0295f44ab5403a4bea4d284b)

diff --git a/drivers/platform/msm/ipa/ipa_hdr.c b/drivers/platform/msm/ipa/ipa_hdr.c
index f0614e323c2d..ebe0df79695c 100644
--- a/drivers/platform/msm/ipa/ipa_hdr.c
+++ b/drivers/platform/msm/ipa/ipa_hdr.c
@@ -580,7 +580,8 @@ ipa_insert_failed:
 	list_del(&entry->link);
 	htbl->proc_ctx_cnt--;
 bad_len:
-	hdr_entry->ref_cnt--;
+	if (add_ref_hdr)
+		hdr_entry->ref_cnt--;
 	entry->cookie = 0;
 	kmem_cache_free(ipa_ctx->hdr_proc_ctx_cache, entry);
 	return -EPERM;
