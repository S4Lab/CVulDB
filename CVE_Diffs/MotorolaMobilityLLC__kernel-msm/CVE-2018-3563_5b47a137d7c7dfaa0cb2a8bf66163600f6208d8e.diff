MotorolaMobilityLLC__kernel-msm
commit 5b47a137d7c7dfaa0cb2a8bf66163600f6208d8e
Author:     Aditya Bavanari <abavanar@codeaurora.org>
AuthorDate: Wed Mar 14 10:55:25 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Wed Apr 4 07:58:08 2018 -0500

    ASoC: apr: Add validity check to APR port
    
    Add boundary checks for APR port received from ADSP.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-3563
    CRs-Fixed: 2143207
    BUG: 72956842
    
    Change-Id: I9a7fa39ee223e1859323caa6eb74c1c8a26a041d
    Signed-off-by: Aditya Bavanari <abavanar@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1148194
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit d15cd86251de89e2dcef09cbd5d7378af9b06b5f)

diff --git a/drivers/soc/qcom/qdsp6v2/apr.c b/drivers/soc/qcom/qdsp6v2/apr.c
index 3791169ec0ac..c07c0a750a89 100644
--- a/drivers/soc/qcom/qdsp6v2/apr.c
+++ b/drivers/soc/qcom/qdsp6v2/apr.c
@@ -680,7 +680,8 @@ void apr_cb_func(void *buf, int len, void *priv)
 
 	temp_port = ((data.dest_port >> 8) * 8) + (data.dest_port & 0xFF);
 	pr_debug("port = %d t_port = %d\n", data.src_port, temp_port);
-	if (c_svc->port_cnt && c_svc->port_fn[temp_port])
+	if (((temp_port >= 0) && (temp_port < APR_MAX_PORTS))
+		&& (c_svc->port_cnt && c_svc->port_fn[temp_port]))
 		c_svc->port_fn[temp_port](&data,  c_svc->port_priv[temp_port]);
 	else if (c_svc->fn)
 		c_svc->fn(&data, c_svc->priv);
