MotorolaMobilityLLC__kernel-msm
commit cde7ac5f0616cc7b6d2ce4942dd336ce44fddedb
Author:     Vatsal Bucha <vbucha@codeaurora.org>
AuthorDate: Tue Mar 5 16:00:21 2019 +0530
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Dec 9 16:57:15 2019 +0800

    dsp: q6voice: Check size of shared memory buffer before access
    
    Check buffer size in qdsp_cvs_callback before access in
    ul_pkt.
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2019-10491
    CRs-Fixed: 2380709
    
    Change-Id: Ic19994b46086709231656ec747d2df988b7a512f
    Signed-off-by: Vatsal Bucha <vbucha@codeaurora.org>
    Signed-off-by: Jignesh Patel <jignesh@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1353991
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Ravikumar Vembu <Raviv@motorola.com>
    Submit-Approved: Jira Key

diff --git a/sound/soc/msm/qdsp6v2/q6voice.c b/sound/soc/msm/qdsp6v2/q6voice.c
index 8292f474a357..990fb7bb1815 100644
--- a/sound/soc/msm/qdsp6v2/q6voice.c
+++ b/sound/soc/msm/qdsp6v2/q6voice.c
@@ -6611,6 +6611,11 @@ static int32_t qdsp_cvs_callback(struct apr_client_data *data, void *priv)
 
 		cvs_voc_pkt = v->shmem_info.sh_buf.buf[1].data;
 		if (cvs_voc_pkt != NULL &&  common.mvs_info.ul_cb != NULL) {
+			if (v->shmem_info.sh_buf.buf[1].size <
+			    ((3 * sizeof(uint32_t)) + cvs_voc_pkt[2])) {
+				pr_err("%s: invalid voc pkt size\n", __func__);
+				return -EINVAL;
+			}
 			/* cvs_voc_pkt[0] contains tx timestamp */
 			common.mvs_info.ul_cb((uint8_t *)&cvs_voc_pkt[3],
 					      cvs_voc_pkt[2],
