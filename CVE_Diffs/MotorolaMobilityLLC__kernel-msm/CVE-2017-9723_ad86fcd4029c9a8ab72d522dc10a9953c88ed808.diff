MotorolaMobilityLLC__kernel-msm
commit ad86fcd4029c9a8ab72d522dc10a9953c88ed808
Author:     Ashwin Pathmudi <jfxr63@motorola.com>
AuthorDate: Fri Feb 2 15:49:08 2018 +0530
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Wed Feb 28 04:49:17 2018 -0600

    input: synaptics_dsx: Free buffer before releasing rmidev
    
    CVE-fixed: CVE-2017-9723
    
    Change-Id: I17c902351b7236af069cb3ac531e85c2500f5009
    Signed-off-by: Ashwin Pathmudi <jfxr63@motorola.com>
    Reviewed-on: https://gerrit.mot.com/1129209
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Konstantin Makariev <kmakariev@motorola.com>
    Submit-Approved: Jira Key
    (cherry picked from commit 968ab65f5ee259bdaedfb1c8e3ce6f1259893f07)

diff --git a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
index 2c34526f1e08..08303473e5d6 100644
--- a/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
+++ b/drivers/input/touchscreen/synaptics_mmi/synaptics_dsx_rmi_dev.c
@@ -479,12 +479,20 @@ static int rmidev_release(struct inode *inp, struct file *filp)
 {
 	struct rmidev_data *dev_data =
 			container_of(inp->i_cdev, struct rmidev_data, main_dev);
+	struct temp_buffer *tb;
 
 	if (!dev_data)
 		return -EACCES;
 
 	mutex_lock(&(dev_data->file_mutex));
 
+	tb = &dev_data->data_buf;
+	if (tb->buf_size != 0) {
+	  kfree(tb->buf);
+	  tb->buf = NULL;
+	  tb->buf_size = 0;
+	}
+
 	dev_data->ref_count--;
 	if (dev_data->ref_count < 0)
 		dev_data->ref_count = 0;
