MotorolaMobilityLLC__kernel-msm
commit 3b57e468acd86ede7d376388b49d308c7ebdb5c7
Author:     Shubhraprakash Das <sadas@codeaurora.org>
AuthorDate: Wed Dec 7 15:25:27 2016 -0800
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Sat Oct 13 11:01:32 2018 +0800

    msm: camera: isp: Check userspace parameters
    
    Check the user parameters passed to prevent buffer overflow.
    
    Bug-id: A-71501698
    CRs-Fixed: 1097390
    CVE-fixed: CVE-2018-3598
    Mot-CRs-fixed: (CR)
    
    Change-Id: Ia8adc88d993db9e4314f3aa85ff5bbb6d7cef31e
    Signed-off-by: Shubhraprakash Das <sadas@codeaurora.org>
    Signed-off-by: Meera Gande <mgande@codeaurora.org>
    Reviewed-on: https://gerrit.mot.com/1154662
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key

diff --git a/drivers/media/platform/msm/camera_v2_2016/ispif/msm_ispif.c b/drivers/media/platform/msm/camera_v2_2016/ispif/msm_ispif.c
index 37a2b3248838..7b6cdbd078c1 100644
--- a/drivers/media/platform/msm/camera_v2_2016/ispif/msm_ispif.c
+++ b/drivers/media/platform/msm/camera_v2_2016/ispif/msm_ispif.c
@@ -132,7 +132,7 @@ static void msm_ispif_get_pack_mask_from_cfg(
 			pack_mask[0] |= temp;
 		CDBG("%s:num %d cid %d mode %d pack_mask %x %x\n",
 			__func__, entry->num_cids, entry->cids[i],
-			pack_cfg[i].pack_mode,
+			pack_cfg[entry->cids[i]].pack_mode,
 			pack_mask[0], pack_mask[1]);
 
 	}
@@ -164,6 +164,16 @@ static int msm_ispif_config2(struct ispif_device *ispif,
 		return rc;
 	}
 
+	for (i = 0; i < params->num; i++) {
+		int j;
+
+		if (params->entries[i].num_cids > MAX_CID_CH_v2)
+			return -EINVAL;
+		for (j = 0; j < params->entries[i].num_cids; j++)
+			if (params->entries[i].cids[j] >= CID_MAX)
+				return -EINVAL;
+	}
+
 	for (i = 0; i < params->num; i++) {
 		intftype = params->entries[i].intftype;
 		vfe_intf = params->entries[i].vfe_intf;
