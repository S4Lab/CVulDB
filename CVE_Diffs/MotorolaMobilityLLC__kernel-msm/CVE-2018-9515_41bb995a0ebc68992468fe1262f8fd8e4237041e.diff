MotorolaMobilityLLC__kernel-msm
commit 41bb995a0ebc68992468fe1262f8fd8e4237041e
Author:     Daniel Rosenberg <drosen@google.com>
AuthorDate: Fri Jul 20 16:11:40 2018 -0700
Commit:     PDO SCM Team <hudsoncm@motorola.com>
CommitDate: Fri Dec 7 06:02:18 2018 -0600

    ANDROID: sdcardfs: Change current->fs under lock
    
    Mot-CRs-fixed: (CR)
    CVE-Fixed: CVE-2018-9515
    bug: 111641492
    
    Change-Id: I79e9894f94880048edaf0f7cfa2d180f65cbcf3b
    Reported-by: Jann Horn <jannh@google.com>
    Signed-off-by: Daniel Rosenberg <drosen@google.com>
    Reviewed-on: https://gerrit.mot.com/1280258
    SLTApproved: Slta Waiver
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key
    Reviewed-by: Xiaojun Ji <jixj@motorola.com>
    Reviewed-by: Zhangqing Huang <huangzq2@motorola.com>
    Reviewed-by: Zhenxin Xi <xizx@motorola.com>
    Submit-Approved: Jira Key

diff --git a/fs/sdcardfs/inode.c b/fs/sdcardfs/inode.c
index 24dfa689b54c..1219a89378da 100644
--- a/fs/sdcardfs/inode.c
+++ b/fs/sdcardfs/inode.c
@@ -105,8 +105,11 @@ static int sdcardfs_create(struct inode *dir, struct dentry *dentry,
 		err = -ENOMEM;
 		goto out_unlock;
 	}
+	copied_fs->umask = 0;
+	task_lock(current);
 	current->fs = copied_fs;
-	current->fs->umask = 0;
+	task_unlock(current);
+
 	err = vfs_create2(lower_dentry_mnt, d_inode(lower_parent_dentry), lower_dentry, mode, want_excl);
 	if (err)
 		goto out;
@@ -120,7 +123,9 @@ static int sdcardfs_create(struct inode *dir, struct dentry *dentry,
 	fixup_lower_ownership(dentry, dentry->d_name.name);
 
 out:
+	task_lock(current);
 	current->fs = saved_fs;
+	task_unlock(current);
 	free_fs_struct(copied_fs);
 out_unlock:
 	unlock_dir(lower_parent_dentry);
@@ -329,8 +334,11 @@ static int sdcardfs_mkdir(struct inode *dir, struct dentry *dentry, umode_t mode
 		unlock_dir(lower_parent_dentry);
 		goto out_unlock;
 	}
+	copied_fs->umask = 0;
+	task_lock(current);
 	current->fs = copied_fs;
-	current->fs->umask = 0;
+	task_unlock(current);
+
 	err = vfs_mkdir2(lower_mnt, d_inode(lower_parent_dentry), lower_dentry, mode);
 
 	if (err) {
@@ -394,8 +402,10 @@ static int sdcardfs_mkdir(struct inode *dir, struct dentry *dentry, umode_t mode
 		sdcardfs_update_xattr_dirwriter(lower_dentry, writer_uid);
 #endif
 out:
+        task_lock(current);
 	current->fs = saved_fs;
-	free_fs_struct(copied_fs);
+	task_unlock(current);
+        free_fs_struct(copied_fs);
 out_unlock:
 	sdcardfs_put_lower_path(dentry, &lower_path);
 out_revert:
