apple__cups
commit 02476c59f1562dd6b2b1c5dff085f80f58674ab5
Author:     mike <mike@7a7537e8-13f0-0310-91df-b6672ffda945>
AuthorDate: Tue Apr 1 20:32:00 2008 +0000
Commit:     mike <mike@7a7537e8-13f0-0310-91df-b6672ffda945>
CommitDate: Tue Apr 1 20:32:00 2008 +0000

    CVE-2008-0047: cgiCompileSearch buffer overflow (STR #2729)
    CVE-2008-1373: CUPS GIF image filter overflow (STR #2765)
    
    
    
    git-svn-id: svn+ssh://src.apple.com/svn/cups/cups.org/trunk@7420 7a7537e8-13f0-0310-91df-b6672ffda945

diff --git a/CHANGES-1.3.txt b/CHANGES-1.3.txt
index 8aacab502..2332b5505 100644
--- a/CHANGES-1.3.txt
+++ b/CHANGES-1.3.txt
@@ -3,6 +3,8 @@ CHANGES-1.3.txt
 
 CHANGES IN CUPS V1.3.7
 
+	- CVE-2008-0047: cgiCompileSearch buffer overflow (STR #2729)
+	- CVE-2008-1373: CUPS GIF image filter overflow (STR #2765)
 	- Updated the "make check" tests to do a more thorough
 	  automated test.
 	- cups-driverd complained about missing directories (STR
diff --git a/cgi-bin/search.c b/cgi-bin/search.c
index f1105fb60..a23adb602 100644
--- a/cgi-bin/search.c
+++ b/cgi-bin/search.c
@@ -167,7 +167,9 @@ cgiCompileSearch(const char *query)	/* I - Query string */
       * string + RE overhead...
       */
 
-      wlen = (sptr - s) + 4 * wlen + 2 * strlen(prefix) + 4;
+      wlen = (sptr - s) + 2 * 4 * wlen + 2 * strlen(prefix) + 11;
+      if (lword)
+        wlen += strlen(lword);
 
       if (wlen > slen)
       {
diff --git a/filter/image-gif.c b/filter/image-gif.c
index 78c8ac372..556d09e7e 100644
--- a/filter/image-gif.c
+++ b/filter/image-gif.c
@@ -37,6 +37,7 @@
 
 #define GIF_INTERLACE	0x40
 #define GIF_COLORMAP	0x80
+#define GIF_MAX_BITS	12
 
 typedef cups_ib_t	gif_cmap_t[256][4];
 typedef short		gif_table_t[4096];
@@ -462,7 +463,7 @@ gif_read_image(FILE         *fp,	/* I - Input file */
   pass      = 0;
   code_size = getc(fp);
 
-  if (!pixels)
+  if (code_size > GIF_MAX_BITS || !pixels)
     return (-1);
 
   if (gif_read_lzw(fp, 1, code_size) < 0)
