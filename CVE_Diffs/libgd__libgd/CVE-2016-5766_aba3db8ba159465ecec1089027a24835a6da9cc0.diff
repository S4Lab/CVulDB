libgd__libgd
commit aba3db8ba159465ecec1089027a24835a6da9cc0
Author:     Pierre Joye <pierre.php@gmail.com>
AuthorDate: Tue Jun 28 16:23:42 2016 +0700
Commit:     Pierre Joye <pierre.php@gmail.com>
CommitDate: Tue Jun 28 16:23:42 2016 +0700

    fix php bug 72339 (CVE-2016-5766), Integer Overflow in _gd2GetHeader() resulting in heap overflow

diff --git a/src/gd_gd2.c b/src/gd_gd2.c
index fd1e0c9..bdbbecf 100644
--- a/src/gd_gd2.c
+++ b/src/gd_gd2.c
@@ -154,8 +154,11 @@ _gd2GetHeader (gdIOCtxPtr in, int *sx, int *sy,
 		nc = (*ncx) * (*ncy);
 		GD2_DBG (printf ("Reading %d chunk index entries\n", nc));
 		sidx = sizeof (t_chunk_info) * nc;
+		if (overflow2(sidx, nc)) {
+			goto fail1;
+		}
 		cidx = gdCalloc (sidx, 1);
-		if (!cidx) {
+		if (cidx == NULL) {
 			goto fail1;
 		}
 		for (i = 0; i < nc; i++) {
diff --git a/tests/gd2/CMakeLists.txt b/tests/gd2/CMakeLists.txt
index 558d2f7..b13489a 100644
--- a/tests/gd2/CMakeLists.txt
+++ b/tests/gd2/CMakeLists.txt
@@ -2,6 +2,7 @@ LIST(APPEND TESTS_FILES
 	gd2_empty_file
 	gd2_im2im
 	gd2_null
+	php_bug_72339
 )
 
 ADD_GD_TESTS()
diff --git a/tests/gd2/Makemodule.am b/tests/gd2/Makemodule.am
index 3db2d59..a8b6981 100644
--- a/tests/gd2/Makemodule.am
+++ b/tests/gd2/Makemodule.am
@@ -3,7 +3,8 @@ libgd_helper_programs += \
 	gd2/gd2_read_corrupt
 
 libgd_test_programs += \
-	gd2/gd2_empty_file
+	gd2/gd2_empty_file \
+	gd2/php_bug_72339
 TESTS += \
 	gd2/invalid_header.sh
 
@@ -32,4 +33,5 @@ EXTRA_DIST += \
 	gd2/invalid_header.gd2 \
 	gd2/invalid_header.sh \
 	gd2/invalid_neg_size.gd2 \
-	gd2/invalid_neg_size.sh
+	gd2/invalid_neg_size.sh \
+	gd2/php_bug_72339_exp.gd2
diff --git a/tests/gd2/php_bug_72339.c b/tests/gd2/php_bug_72339.c
new file mode 100644
index 0000000..d128654
--- /dev/null
+++ b/tests/gd2/php_bug_72339.c
@@ -0,0 +1,21 @@
+#include <stdio.h>
+#include <stdlib.h>
+#include "gd.h"
+
+#include "gdtest.h"
+
+int main()
+{
+	gdImagePtr im;
+	FILE *fp;
+
+	fp = gdTestFileOpen("gdimagerotate/php_bug_64898.png");
+	im = gdImageCreateFromGd2(fp);
+	if (im == NULL) {
+		return 0;
+	} else {
+		gdTestErrorMsg("Image should have failed to be loaded");
+		return 0;
+	}
+
+}
diff --git a/tests/gd2/php_bug_72339_exp.gd2 b/tests/gd2/php_bug_72339_exp.gd2
new file mode 100644
index 0000000..39ed227
Binary files /dev/null and b/tests/gd2/php_bug_72339_exp.gd2 differ
