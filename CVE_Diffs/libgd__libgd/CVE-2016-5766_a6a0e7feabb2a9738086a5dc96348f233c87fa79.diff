libgd__libgd
commit a6a0e7feabb2a9738086a5dc96348f233c87fa79
Author:     Pierre Joye <pierre.php@gmail.com>
AuthorDate: Wed Jun 29 09:36:26 2016 +0700
Commit:     Pierre Joye <pierre.php@gmail.com>
CommitDate: Wed Jun 29 09:36:26 2016 +0700

    fix php bug 72339 (CVE-2016-5766), Integer Overflow in _gd2GetHeader() resulting in heap overflow. Sync with php's sync

diff --git a/src/gd_gd2.c b/src/gd_gd2.c
index bdbbecf..2837456 100644
--- a/src/gd_gd2.c
+++ b/src/gd_gd2.c
@@ -152,11 +152,16 @@ _gd2GetHeader (gdIOCtxPtr in, int *sx, int *sy,
 
 	if (gd2_compressed (*fmt)) {
 		nc = (*ncx) * (*ncy);
+
 		GD2_DBG (printf ("Reading %d chunk index entries\n", nc));
+		if (overflow2(sizeof(t_chunk_info), nc)) {
+			goto fail1;
+		}
 		sidx = sizeof (t_chunk_info) * nc;
-		if (overflow2(sidx, nc)) {
+		if (sidx <= 0) {
 			goto fail1;
 		}
+
 		cidx = gdCalloc (sidx, 1);
 		if (cidx == NULL) {
 			goto fail1;
diff --git a/tests/gd2/php_bug_72339.c b/tests/gd2/php_bug_72339.c
index d128654..f421e72 100644
--- a/tests/gd2/php_bug_72339.c
+++ b/tests/gd2/php_bug_72339.c
@@ -15,7 +15,7 @@ int main()
 		return 0;
 	} else {
 		gdTestErrorMsg("Image should have failed to be loaded");
-		return 0;
+		return 1;
 	}
 
 }
