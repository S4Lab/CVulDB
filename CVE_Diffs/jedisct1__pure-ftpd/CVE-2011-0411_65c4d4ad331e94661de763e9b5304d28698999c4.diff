jedisct1__pure-ftpd
commit 65c4d4ad331e94661de763e9b5304d28698999c4
Author:     Frank DENIS <github@pureftpd.org>
AuthorDate: Mon Mar 7 23:50:46 2011 +0100
Commit:     Frank DENIS <github@pureftpd.org>
CommitDate: Mon Mar 7 23:50:46 2011 +0100

    Flush the command buffer after switching to TLS.
    Fixes a flaw similar to CVE-2011-0411.

diff --git a/src/ftp_parser.c b/src/ftp_parser.c
index 37553a6..69a42a3 100644
--- a/src/ftp_parser.c
+++ b/src/ftp_parser.c
@@ -57,14 +57,20 @@ static void randomdelay(void)
  * -Frank.
  */
 
+static size_t scanned;
+static size_t readnbd;
+
+static void flush_cmd(void)
+{
+    scanned = readnbd = (size_t) 0U;
+}
+
 int sfgets(void)
 {
     struct pollfd pfd;
     int pollret;
     ssize_t readnb;
     signed char seen_r = 0;
-    static size_t scanned;
-    static size_t readnbd;
     
     if (scanned > (size_t) 0U) {       /* support pipelining */
         readnbd -= scanned;        
@@ -362,6 +368,7 @@ void parser(void)
             addreply_noformat(234, "AUTH TLS OK.");
             doreply();
             if (tls_cnx == NULL) {
+                flush_cmd();
                 (void) tls_init_new_session();
             }
             goto wayout;
