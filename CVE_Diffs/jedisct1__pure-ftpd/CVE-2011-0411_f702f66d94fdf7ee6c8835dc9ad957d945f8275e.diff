jedisct1__pure-ftpd
commit f702f66d94fdf7ee6c8835dc9ad957d945f8275e
Author:     Frank DENIS <github@pureftpd.org>
AuthorDate: Mon Mar 7 23:50:46 2011 +0100
Commit:     Frank DENIS <github@pureftpd.org>
CommitDate: Tue Apr 19 19:26:55 2011 +0200

    Flush the command buffer after switching to TLS.
    Fixes a flaw similar to CVE-2011-0411.

diff --git a/src/ftp_parser.c b/src/ftp_parser.c
index 23bdeeb..ce5eee2 100644
--- a/src/ftp_parser.c
+++ b/src/ftp_parser.c
@@ -57,6 +57,14 @@ static void randomdelay(void)
  * -Frank.
  */
 
+static size_t scanned;
+static size_t readnbd;
+
+static void flush_cmd(void)
+{
+    scanned = readnbd = (size_t) 0U;
+}
+
 int sfgets(void)
 {
     struct pollfd pfd;
@@ -364,6 +372,7 @@ void parser(void)
             addreply_noformat(234, "AUTH TLS OK.");
             doreply();
             if (LOCAL_tls_cnx == NULL) {
+                flush_cmd();
                 (void) tls_init_new_session();
             }
             goto wayout;
