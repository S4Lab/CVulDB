mirror__wget
commit 1fc9c95ec144499e69dc8ec76dbe07799d7d82cd
Author:     Tim Rühsen <tim.ruehsen@gmx.de>
AuthorDate: Fri Apr 27 10:41:56 2018 +0200
Commit:     Tim Rühsen <tim.ruehsen@gmx.de>
CommitDate: Sun May 6 18:24:58 2018 +0200

    Fix cookie injection (CVE-2018-0494)
    
    * src/http.c (resp_new): Replace \r\n by space in continuation lines
    
    Fixes #53763
     "Malicious website can write arbitrary cookie entries to cookie jar"
    
    HTTP header parsing left the \r\n from continuation line intact.
    The Set-Cookie code didn't check and could be tricked to write
    \r\n into the cookie jar, allowing a server to generate cookies at will.

diff --git a/src/http.c b/src/http.c
index c8960f111..77bdbbed3 100644
--- a/src/http.c
+++ b/src/http.c
@@ -613,9 +613,9 @@ struct response {
    resp_header_*.  */
 
 static struct response *
-resp_new (const char *head)
+resp_new (char *head)
 {
-  const char *hdr;
+  char *hdr;
   int count, size;
 
   struct response *resp = xnew0 (struct response);
@@ -644,15 +644,23 @@ resp_new (const char *head)
         break;
 
       /* Find the end of HDR, including continuations. */
-      do
+      for (;;)
         {
-          const char *end = strchr (hdr, '\n');
+          char *end = strchr (hdr, '\n');
+
           if (end)
             hdr = end + 1;
           else
             hdr += strlen (hdr);
+
+          if (*hdr != ' ' && *hdr != '\t')
+            break;
+
+          // continuation, transform \r and \n into spaces
+          *end = ' ';
+          if (end > head && end[-1] == '\r')
+            end[-1] = ' ';
         }
-      while (*hdr == ' ' || *hdr == '\t');
     }
   DO_REALLOC (resp->headers, size, count + 1, const char *);
   resp->headers[count] = NULL;
