mohamed-anwar__os
commit ea4cec2e15627b226e7f4f40e2537fa5d05384ba
Author:     simon <simon@FreeBSD.org>
AuthorDate: Sun Aug 23 14:15:28 2009 +0000
Commit:     simon <simon@FreeBSD.org>
CommitDate: Sun Aug 23 14:15:28 2009 +0000

    Import DTLS fix from upstream OpenSSL 0.9.8 branch:
    
    Do not access freed data structure.
    
    Note that this will not get FreeBSD Security Advisory as DTLS is
    experimental in OpenSSL.
    
    Security:       CVE-2009-1379
    Obtained from:  OpenSSL CVS
                    http://cvs.openssl.org/chngview?cn=18156

diff --git a/ssl/d1_both.c b/ssl/d1_both.c
index 0c863179bc8..967d8c542dd 100644
--- a/ssl/d1_both.c
+++ b/ssl/d1_both.c
@@ -519,6 +519,7 @@ dtls1_retrieve_buffered_fragment(SSL *s, long max, int *ok)
 
 	if ( s->d1->handshake_read_seq == frag->msg_header.seq)
 		{
+		unsigned long frag_len = frag->msg_header.frag_len;
 		pqueue_pop(s->d1->buffered_messages);
 
 		al=dtls1_preprocess_fragment(s,&frag->msg_header,max);
@@ -536,7 +537,7 @@ dtls1_retrieve_buffered_fragment(SSL *s, long max, int *ok)
 		if (al==0)
 			{
 			*ok = 1;
-			return frag->msg_header.frag_len;
+			return frag_len;
 			}
 
 		ssl3_send_alert(s,SSL3_AL_FATAL,al);
