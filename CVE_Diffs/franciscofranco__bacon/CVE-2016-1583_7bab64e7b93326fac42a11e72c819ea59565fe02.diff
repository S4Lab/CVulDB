franciscofranco__bacon
commit 7bab64e7b93326fac42a11e72c819ea59565fe02
Author:     Jeff Mahoney <jeffm@suse.com>
AuthorDate: Tue Jul 5 21:32:30 2016 +0000
Commit:     Joey Rizzoli <joey@lineageos.org>
CommitDate: Tue May 23 21:09:12 2017 +0200

    ecryptfs: don't allow mmap when the lower fs doesn't support it
    
    There are legitimate reasons to disallow mmap on certain files, notably
    in sysfs or procfs.  We shouldn't emulate mmap support on file systems
    that don't offer support natively.
    
    CVE-2016-1583
    
    Signed-off-by: Jeff Mahoney <jeffm@suse.com>
    Cc: stable@vger.kernel.org
    [tyhicks: clean up f_op check by using ecryptfs_file_to_lower()]
    Signed-off-by: Tyler Hicks <tyhicks@canonical.com>
    (adapted from commit f0fe970df3838c202ef6c07a4c2b36838ef0a88b)
    
    Change-Id: I3eb979e9476847834eeea0ecbaf07a53329a7219

diff --git a/fs/ecryptfs/file.c b/fs/ecryptfs/file.c
index 805be43324a..ef830491326 100644
--- a/fs/ecryptfs/file.c
+++ b/fs/ecryptfs/file.c
@@ -146,6 +146,15 @@ static int read_or_initialize_metadata(struct dentry *dentry)
 	struct ecryptfs_mount_crypt_stat *mount_crypt_stat;
 	struct ecryptfs_crypt_stat *crypt_stat;
 	int rc;
+	struct file *lower_file = ecryptfs_file_to_lower(file);
+
+	/*
+	 * Don't allow mmap on top of file systems that don't support it
+	 * natively.  If FILESYSTEM_MAX_STACK_DEPTH > 2 or ecryptfs
+	 * allows recursive mounting, this will need to be extended.
+	 */
+	if (!lower_file->f_op->mmap)
+		return -ENODEV;
 
 	crypt_stat = &ecryptfs_inode_to_private(inode)->crypt_stat;
 	mount_crypt_stat = &ecryptfs_superblock_to_private(
