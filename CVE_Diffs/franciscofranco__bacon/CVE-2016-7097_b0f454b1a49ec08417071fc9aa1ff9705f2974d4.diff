franciscofranco__bacon
commit b0f454b1a49ec08417071fc9aa1ff9705f2974d4
Author:     Gu Zheng <guzheng1@huawei.com>
AuthorDate: Mon Jan 9 09:34:48 2017 +0800
Commit:     Joey Rizzoli <joey@lineageos.org>
CommitDate: Wed Jun 14 23:00:19 2017 +0200

    tmpfs: clear S_ISGID when setting posix ACLs
    
    This change was missed the tmpfs modification in In CVE-2016-7097
    commit 073931017b49 ("posix_acl: Clear SGID bit when setting
    file permissions")
    It can test by xfstest generic/375, which failed to clear
    setgid bit in the following test case on tmpfs:
    
      touch $testfile
      chown 100:100 $testfile
      chmod 2755 $testfile
      _runas -u 100 -g 101 -- setfacl -m u::rwx,g::rwx,o::rwx $testfile
    
    Change-Id: I639fb4221e65b8c1ab3cc26ba735521e25967faa
    Signed-off-by: Gu Zheng <guzheng1@huawei.com>
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    [gmrt: Backport to 3.4]

diff --git a/fs/posix_acl.c b/fs/posix_acl.c
index 1c61b8d58f9..9607a1df282 100644
--- a/fs/posix_acl.c
+++ b/fs/posix_acl.c
@@ -359,11 +359,9 @@ int posix_acl_update_mode(struct inode *inode, umode_t *mode_p,
 	umode_t mode = inode->i_mode;
 	int error;
 
-	error = posix_acl_equiv_mode(*acl, &mode);
-	if (error < 0)
+	error = posix_acl_update_mode(inode, &inode->i_mode, acl);
+	if (error)
 		return error;
-	if (error == 0)
-		*acl = NULL;
 	if (!in_group_p(inode->i_gid) &&
 	    !capable(CAP_FSETID))
 		mode &= ~S_ISGID;
