leo-yuriev__ReOpenLDAP
commit 6c8630f521fc9daa67d109de1d3934e168501062
Author:     Leo Yuriev <leo@yuriev.ru>
AuthorDate: Sun Aug 7 18:48:28 2016 +0300
Commit:     Leo Yuriev <leo@yuriev.ru>
CommitDate: Sun Aug 7 21:27:24 2016 +0300

    libreldap: MozNSS fix CVE-2015-3276.
    
    Import from http://sisyphus.ru/en/srpm/Sisyphus/openldap/patches/0
    
    This also fixes https://bugzilla.redhat.com/show_bug.cgi?id=1238322
    
    Change-Id: I21d916f9b349be601f74f758a4f6df5f4da22828

diff --git a/libraries/libreldap/tls_m.c b/libraries/libreldap/tls_m.c
index 7b86a302..bf7cc761 100644
--- a/libraries/libreldap/tls_m.c
+++ b/libraries/libreldap/tls_m.c
@@ -709,18 +709,23 @@ nss_parse_ciphers(const char *cipherstr, int cipher_list[ciphernum])
 			 */
 			if (mask || strength || protocol) {
 				for (i=0; i<ciphernum; i++) {
-					if (((ciphers_def[i].attr & mask) ||
-						 (ciphers_def[i].strength & strength) ||
-						 (ciphers_def[i].version & protocol)) &&
-						(cipher_list[i] != -1)) {
-						/* Enable the NULL ciphers only if explicity
-						 * requested */
-						if (ciphers_def[i].attr & SSL_eNULL) {
-							if (mask & SSL_eNULL)
-								cipher_list[i] = action;
-						} else
+					/* if more than one mask is provided
+					 * then AND logic applies (to match openssl)
+					 */
+					if ( cipher_list[i] == -1 )
+						continue;
+					if ( mask && ! (ciphers_def[i].attr & mask) )
+						continue;
+					if ( strength && ! (ciphers_def[i].strength & strength) )
+						continue;
+					if ( protocol && ! (ciphers_def[i].version & protocol) )
+						continue;
+					/* Enable the NULL ciphers only if explicity requested */
+					if (ciphers_def[i].attr & SSL_eNULL) {
+						if (mask & SSL_eNULL)
 							cipher_list[i] = action;
-					}
+					} else
+						cipher_list[i] = action;
 				}
 			} else {
 				for (i=0; i<ciphernum; i++) {
