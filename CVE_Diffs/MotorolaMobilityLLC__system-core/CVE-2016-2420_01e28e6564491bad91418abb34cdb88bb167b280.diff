MotorolaMobilityLLC__system-core
commit 01e28e6564491bad91418abb34cdb88bb167b280
Author:     Josh Gao <jmgao@google.com>
AuthorDate: Tue Feb 16 15:01:43 2016 -0800
Commit:     Choon Lee Seah <andyseah@motorola.com>
CommitDate: Wed Mar 16 12:09:48 2016 -0500

    ANDROID-26403620: Elevation of Privilege Vulnerability in Debuggerd Component
    
    CVE-2016-2420
    
    Don't create tombstone directory.
    
    Partial backport of cf79748.
    
    Bug: http://b/26403620
    Change-Id: Ib877ab6cfab6aef079830c5a50ba81141ead35ee
    (cherry picked from commit cb9625cbe54f009c216a1f50fcaee15ee3478357)
    
    Signed-off-by: Andy Seah <dntc46@motorola.com>
    Change-Id: Ib02f0a0444dd54549ac7869a876c466b7f398de1
    Reviewed-on: http://gerrit.mot.com/830879
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Choon Lee Seah <andyseah@motorola.com>
    Reviewed-by: Christopher Fries <cfries@motorola.com>

diff --git a/debuggerd/tombstone.cpp b/debuggerd/tombstone.cpp
index 6bb518c94..8cf52d884 100644
--- a/debuggerd/tombstone.cpp
+++ b/debuggerd/tombstone.cpp
@@ -790,25 +790,8 @@ char* engrave_tombstone(pid_t pid, pid_t tid, int signal, int original_si_code,
   log.current_tid = tid;
   log.crashed_tid = tid;
 
-  /* BEGIN Motorola, wcg763, 02/01/10, JIRA IKMAP-4768; qa6317, 02/10/10, IKMAP-5931 */
-  if ((mkdir(TOMBSTONE_DIR, 02755) == -1) && (errno != EEXIST)) {
-    _LOG(&log, logtype::ERROR, "failed to create %s: %s\n", TOMBSTONE_DIR, strerror(errno));
-  }
-  /* 02775 instead of 0775 forces all created files in this dir to have gid of dir's gid */
-  if (chmod(TOMBSTONE_DIR, 02775) == -1) {
-    _LOG(&log, logtype::ERROR, "failed to change mode of %s: %s\n", TOMBSTONE_DIR, strerror(errno));
-  }
-  if (chown(TOMBSTONE_DIR, AID_SYSTEM, AID_MOT_TOMBSTONE) == -1) {
-    _LOG(&log, logtype::ERROR, "failed to change ownership of %s: %s\n", TOMBSTONE_DIR, strerror(errno));
-  }
-  /* END IKMAP-4768; IKMAP-5931 */
   int fd = -1;
-  char* path = NULL;
-  if (selinux_android_restorecon(TOMBSTONE_DIR, 0) == 0) {
-    path = find_and_open_tombstone(&fd);
-  } else {
-    _LOG(&log, logtype::ERROR, "Failed to restore security context, not writing tombstone.\n");
-  }
+  char* path = find_and_open_tombstone(&fd);
 
   if (fd < 0) {
     _LOG(&log, logtype::ERROR, "Skipping tombstone write, nothing to do.\n");
diff --git a/rootdir/init.rc b/rootdir/init.rc
index 4555af147..98f784640 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -364,7 +364,7 @@ on post-fs-data
     mkdir /data/app-lib 0771 system system
     mkdir /data/app 0771 system system
     mkdir /data/property 0700 root root
-    mkdir /data/tombstones 0771 system system
+    mkdir /data/tombstones 02775 system mot_tombstone
 
     # create dalvik-cache, so as to enforce our permissions
     mkdir /data/dalvik-cache 0771 root root
