MotorolaMobilityLLC__system-core
commit 7db0166e5b4806237a9c4d0dc7cb7de41334df48
Author:     Josh Gao <jmgao@google.com>
AuthorDate: Tue Aug 9 15:29:58 2016 -0700
Commit:     Charles Barros <charlesb@motorola.com>
CommitDate: Mon Jan 23 16:48:55 2017 -0200

    debuggerd: fix missed use of ptrace(PTRACE_ATTACH).
    
    ANDROID-29555636: Elevation of privilege vulnerability in Debuggerd
    CVE-2016-3885
    
    Mot-CRs-fixed: (CR)
    
    Bug: http://b/29555636
    Change-Id: Ibd8a2e2b619b74aac667555b7085d6f28e367c07
    (cherry picked from commit 8b6b654a5f24a481831828ff4e87fa2fe0309c1a)
    
    Signed-off-by: Andy Seah <dntc46@motorola.com>
    Change-Id: Ia86e0265132686653f513a3411768da557a38551
    Reviewed-on: https://gerrit.mot.com/887631
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Choon Lee Seah <andyseah@motorola.com>
    (cherry picked from commit e0c2121370ddd27917da9fcb60e3344864b59c55)
    Reviewed-on: https://gerrit.mot.com/898137
    Submit-Approved: Jira Key <jirakey@motorola.com>
    Reviewed-by: Chao-Wei Zhang <e12892@motorola.com>
    SLTApproved: Chao-Wei Zhang <e12892@motorola.com>

diff --git a/debuggerd/tombstone.cpp b/debuggerd/tombstone.cpp
index 8cf52d884..3c7e13217 100644
--- a/debuggerd/tombstone.cpp
+++ b/debuggerd/tombstone.cpp
@@ -447,7 +447,7 @@ static bool dump_sibling_thread_report(
     }
 
     // Skip this thread if cannot ptrace it
-    if (ptrace(PTRACE_ATTACH, new_tid, 0, 0) < 0) {
+    if (!ptrace_attach_thread(pid, new_tid)) {
       _LOG(log, logtype::ERROR, "ptrace attach to %d failed: %s\n", new_tid, strerror(errno));
       continue;
     }
