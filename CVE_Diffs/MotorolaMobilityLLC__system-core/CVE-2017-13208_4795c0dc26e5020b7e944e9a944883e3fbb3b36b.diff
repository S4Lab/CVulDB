MotorolaMobilityLLC__system-core
commit 4795c0dc26e5020b7e944e9a944883e3fbb3b36b
Author:     tintin <tintinweb@oststrom.com>
AuthorDate: Fri Oct 13 11:11:48 2017 -0700
Commit:     Hareesh Mittapalli <hareeshm@motorola.com>
CommitDate: Wed Dec 20 03:47:39 2017 -0600

    libnetutil: Check dhcp respose packet length
    
    CVE-2017-13208 : (AOSP) RCE Vulnerability in System / Libnetutils
    A-67474440
    Mot-CRs-fixed: (CR)
    
    Bug: 67474440
    Test: Manual
    
    Change-Id: I84b533f0101a56ec01e64c7591f3c7e82f513b2e
    Signed-off-by: Dmitry Shmidt <dimitrysh@google.com>
    (cherry picked from commit 61f25d4a3657e79659963d12005afa8c30883015)
    Reviewed-on: https://gerrit.mot.com/1100251
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver
    Tested-by: Jira Key
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Reviewed-by: Coverity Analysis <coverity@motorola.com>
    Submit-Approved: Jira Key

diff --git a/libnetutils/packet.c b/libnetutils/packet.c
index e53a4c84f..9ecdd4f4e 100644
--- a/libnetutils/packet.c
+++ b/libnetutils/packet.c
@@ -218,6 +218,20 @@ int receive_packet(int s, struct dhcp_msg *msg)
      * to construct the pseudo header used in the checksum calculation.
      */
     dhcp_size = ntohs(packet.udp.len) - sizeof(packet.udp);
+    /*
+     * check validity of dhcp_size.
+     * 1) cannot be negative or zero.
+     * 2) src buffer contains enough bytes to copy
+     * 3) cannot exceed destination buffer
+     */
+    if ((dhcp_size <= 0) ||
+        ((int)(nread - sizeof(struct iphdr) - sizeof(struct udphdr)) < dhcp_size) ||
+        ((int)sizeof(struct dhcp_msg) < dhcp_size)) {
+#if VERBOSE
+        ALOGD("Malformed Packet");
+#endif
+        return -1;
+    }
     saddr = packet.ip.saddr;
     daddr = packet.ip.daddr;
     nread = ntohs(packet.ip.tot_len);
