MotorolaMobilityLLC__system-core
commit fd34b581325230433a06cdcf833f09fe5ba77daf
Author:     yangqh5 <yangqh5@lenovo.com>
AuthorDate: Fri Nov 3 14:28:01 2017 +0800
Commit:     Fan Hang <hangfan1@lenovo.com>
CommitDate: Tue Dec 19 17:39:03 2017 +0800

    MANNING-968: [MTK Patch][SECURITY-664]For_mt6797_6m_n_alps-mp-n1.mp9-V1_P149
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03584350
    Severity:
    
    Description:
      [Patch Request] [PMS] mt, Project: mt6797_6M_N, SW Version: alps-mp-n1.mp9-V1N/A
    
    Associated Files:
      device/mt/mt6797_6m_n/ProjectConfig.mk
      vendor/mt/libs/libmtk-art-runtimed/arm/libmtk-art-runtimed.a
      vendor/mt/libs/libmtk-art-runtimed/arm64/libmtk-art-runtimed.a
      vendor/mt/libs/libmtk-art-runtimed/x86/libmtk-art-runtimed.a
      vendor/mt/libs/libmtk-art-runtimed/x86_64/libmtk-art-runtimed.a
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558008
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0834]RCE Vulnerability in Libmpe***
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0834]RCE Vulnerability in Libmpe***
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0834]RCE Vulnerability in Libmpe***
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0834]RCE Vulnerability in Libmpe***
      [[問題現象]]
      [Google Security P***h][CVE-2017-0834]RCE Vulnerability in Libmpe***
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      external/libmpeg2/decoder/impeg2d_pnb_pic.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558010
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0835]RCE Vulnerability in Libmpe***
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0835]RCE Vulnerability in Libmpe***
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0835]RCE Vulnerability in Libmpe***
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0835]RCE Vulnerability in Libmpe***
      [[問題現象]]
      [Google Security P***h][CVE-2017-0835]RCE Vulnerability in Libmpe***
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      external/libmpeg2/decoder/impeg2d_dec_hdr.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558016
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0836]RCE Vulnerability in Libhevc
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0836]RCE Vulnerability in Libhevc
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0836]RCE Vulnerability in Libhevc
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0836]RCE Vulnerability in Libhevc
      [[問題現象]]
      [Google Security P***h][CVE-2017-0836]RCE Vulnerability in Libhevc
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      external/libhevc/decoder/ihevcd_api.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558020
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0838]EoP Vulnerability in Libstagefright
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0838]EoP Vulnerability in Libstagefright
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0838]EoP Vulnerability in Libstagefright
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0838]EoP Vulnerability in Libstagefright
      [[問題現象]]
      [Google Security P***h][CVE-2017-0838]EoP Vulnerability in Libstagefright
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      frameworks/av/media/libstagefright/omx/OMXNodeInstance.cpp
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558023
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0839]ID Vulnerability in Libeffe***s
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0839]ID Vulnerability in Libeffe***s
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0839]ID Vulnerability in Libeffe***s
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0839]ID Vulnerability in Libeffe***s
      [[問題現象]]
      [Google Security P***h][CVE-2017-0839]ID Vulnerability in Libeffe***s
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      frameworks/av/media/libeffects/lvm/wrapper/Bundle/EffectBundle.cpp
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558025
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0840]ID Vulnerability in  Libstagefright
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0840]ID Vulnerability in  Libstagefright
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0840]ID Vulnerability in  Libstagefright
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0840]ID Vulnerability in  Libstagefright
      [[問題現象]]
      [Google Security P***h][CVE-2017-0840]ID Vulnerability in  Libstagefright
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      frameworks/av/media/libstagefright/include/OMXNodeInstance.h
      frameworks/av/media/libstagefright/omx/OMXNodeInstance.cpp
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558027
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0842]EoP Vulnerability i***luetooth
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0842]EoP Vulnerability i***luetooth
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0842]EoP Vulnerability i***luetooth
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0842]EoP Vulnerability i***luetooth
      [[問題現象]]
      [Google Security P***h][CVE-2017-0842]EoP Vulnerability i***luetooth
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      system/bt/btif/src/btif_sdp_server.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558028
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0841]RCE Vulnerability in Libutils
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0841]RCE Vulnerability in Libutils
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0841]RCE Vulnerability in Libutils
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0841]RCE Vulnerability in Libutils
      [[問題現象]]
      [Google Security P***h][CVE-2017-0841]RCE Vulnerability in Libutils
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      system/core/libutils/Unicode.cpp
      vendor/mt/libs/emdlogger1/arm64/emdlogger1
      vendor/mt/libs/emdlogger2/arm64/emdlogger2
      vendor/mt/libs/emdlogger3/arm64/emdlogger3
      vendor/mt/libs/emdlogger5/arm64/emdlogger5
      vendor/mt/libs/ged_srv/arm64/ged_srv
      vendor/mt/libs/libaal/mt6797/arm64/libaal.so
      vendor/mt/libs/libc2kutils/arm64/libc2kutils.so
      vendor/mt/libs/libdpframework/mt6797/arm64/libdpframework.so
      vendor/mt/libs/libgpu_aux/arm64/libgpu_aux.so
      vendor/mt/libs/libnvramagentclient/arm64/libnvramagentclient.so
      vendor/mt/libs/libratconfig/arm64/libratconfig.so
      vendor/mt/libs/md_monitor/arm64/md_monitor
      vendor/mt/libs/md_monitor_ctrl/arm64/md_monitor_ctrl
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03558036
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0845]DoS Vulnerability in SyncSt***geEngine
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0845]DoS Vulnerability in SyncSt***geEngine
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0845]DoS Vulnerability in SyncSt***geEngine
      [[Potential Impa*** of the solution]]
      None
      [[Modules to be verified after taking p***h]]
      None
      [[問題標題]]
      [Google Security P***h][CVE-2017-0845]DoS Vulnerability in SyncSt***geEngine
      [[問題現象]]
      [Google Security P***h][CVE-2017-0845]DoS Vulnerability in SyncSt***geEngine
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      None
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      NoneN/A
    
    Associated Files:
      frameworks/base/services/core/java/com/android/server/content/SyncStorageEngine.java
    
    Change-Id: If8112dad6f85c9592bb69113d05f6d79ec37dafe
    Signed-off-by: yangqh5 <yangqh5@mt.com>

diff --git a/libutils/Unicode.cpp b/libutils/Unicode.cpp
index ba084f6ce..bfacf1ed7 100644
--- a/libutils/Unicode.cpp
+++ b/libutils/Unicode.cpp
@@ -18,6 +18,7 @@
 #include <utils/Unicode.h>
 
 #include <stddef.h>
+#include <limits.h>
 
 #if defined(_WIN32)
 # undef  nhtol
@@ -178,7 +179,15 @@ ssize_t utf32_to_utf8_length(const char32_t *src, size_t src_len)
     size_t ret = 0;
     const char32_t *end = src + src_len;
     while (src < end) {
-        ret += utf32_codepoint_utf8_length(*src++);
+        size_t char_len = utf32_codepoint_utf8_length(*src++);
+        if (SSIZE_MAX - char_len < ret) {
+            // If this happens, we would overflow the ssize_t type when
+            // returning from this function, so we cannot express how
+            // long this string is in an ssize_t.
+            android_errorWriteLog(0x534e4554, "37723026");
+            return -1;
+        }
+        ret += char_len;
     }
     return ret;
 }
@@ -438,14 +447,23 @@ ssize_t utf16_to_utf8_length(const char16_t *src, size_t src_len)
     size_t ret = 0;
     const char16_t* const end = src + src_len;
     while (src < end) {
+        size_t char_len;
         if ((*src & 0xFC00) == 0xD800 && (src + 1) < end
                 && (*(src + 1) & 0xFC00) == 0xDC00) {
             // surrogate pairs are always 4 bytes.
-            ret += 4;
+            char_len = 4;
             src += 2;
         } else {
-            ret += utf32_codepoint_utf8_length((char32_t) *src++);
+            char_len = utf32_codepoint_utf8_length((char32_t)*src++);
+        }
+        if (SSIZE_MAX - char_len < ret) {
+            // If this happens, we would overflow the ssize_t type when
+            // returning from this function, so we cannot express how
+            // long this string is in an ssize_t.
+            android_errorWriteLog(0x534e4554, "37723026");
+            return -1;
         }
+        ret += char_len;
     }
     return ret;
 }
