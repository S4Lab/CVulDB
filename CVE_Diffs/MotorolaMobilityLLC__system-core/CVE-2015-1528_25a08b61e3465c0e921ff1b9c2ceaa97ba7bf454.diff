MotorolaMobilityLLC__system-core
commit 25a08b61e3465c0e921ff1b9c2ceaa97ba7bf454
Author:     Adam Lesinski <adamlesinski@google.com>
AuthorDate: Mon Apr 27 12:13:33 2015 -0700
Commit:     Sergio Vilela <wsv008@motorola.com>
CommitDate: Thu Jul 30 12:07:51 2015 -0500

    ANDROIDB-19334482: CVE-2015-1528: Integer Overflow in libcutils
    
    Prevent integer overflow when allocating native_handle_t
    
    User specified values of numInts and numFds can overflow
    and cause malloc to allocate less than we expect, causing
    heap corruption in subsequent operations on the allocation.
    
    Bug: 19334482
    Change-Id: I43c75f536ea4c08f14ca12ca6288660fd2d1ec55
    (cherry picked from commit 07edc3b3b3caef7829850633f928ae05f6d49f3a)
    
    Signed-off-by: Andy Seah <dntc46@motorola.com>
    Change-Id: I64ced412cf0a5cf05dd781374f66de275b11f414
    Reviewed-on: http://gerrit.mot.com/769582
    SME-Granted: SME Approvals Granted
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Christopher Fries <cfries@motorola.com>
    (cherry picked from commit 36f2c27ef5cb34cd843ca80d9f05f0edb8b6c8e2)
    (cherry picked from commit 7f719c5a3e3a5f6ebccccefe01875c895e968f60)

diff --git a/libcutils/native_handle.c b/libcutils/native_handle.c
index 9a4a5bb38..61fa38ed4 100644
--- a/libcutils/native_handle.c
+++ b/libcutils/native_handle.c
@@ -25,11 +25,17 @@
 #include <cutils/log.h>
 #include <cutils/native_handle.h>
 
+static const int kMaxNativeFds = 1024;
+static const int kMaxNativeInts = 1024;
+
 native_handle_t* native_handle_create(int numFds, int numInts)
 {
-    native_handle_t* h = malloc(
-            sizeof(native_handle_t) + sizeof(int)*(numFds+numInts));
+    if (numFds < 0 || numInts < 0 || numFds > kMaxNativeFds || numInts > kMaxNativeInts) {
+        return NULL;
+    }
 
+    size_t mallocSize = sizeof(native_handle_t) + (sizeof(int) * (numFds + numInts));
+    native_handle_t* h = malloc(mallocSize);
     if (h) {
         h->version = sizeof(native_handle_t);
         h->numFds = numFds;
