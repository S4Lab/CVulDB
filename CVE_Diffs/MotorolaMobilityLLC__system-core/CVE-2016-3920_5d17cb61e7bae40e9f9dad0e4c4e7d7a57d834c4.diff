MotorolaMobilityLLC__system-core
commit 5d17cb61e7bae40e9f9dad0e4c4e7d7a57d834c4
Author:     yangqh5 <yangqh5@lenovo.com>
AuthorDate: Sat Oct 8 14:23:08 2016 +0800
Commit:     zhangly19 <zhangly19@lenovo.com>
CommitDate: Fri Nov 25 11:57:27 2016 +0800

    [MTK Patch](CR)For_mt6755_66_m_alps-mp-m0.mp7-V2.3_P161
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS02958266
    Severity:
    
    Description:
      [Patch Request] [PMS] mt, Project: mt6755_66_M, SW Version: alps-mp-m0.mp7-V2.3N/A
    
    Associated Files:
      device/mt/mt6755_66_m/ProjectConfig.mk
      device/mt/mt6755_66c_m/ProjectConfig.mk
      device/mt/mt6755_66t_m/ProjectConfig.mk
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS02909020
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-3920]Denial of service vulnerability in Mediaserver
      [[問題標題]]
      [Google Security P***h][CVE-2016-3920]Denial of service vulnerability in Mediaserver
      [[問題現象]]
      [Google Security P***h][CVE-2016-3920]Denial of service vulnerability in Mediaserver
      [[問題影響]]
      N/A
      [[問題復現步驟]]
      N/A
      [[建議驗證模塊]]
      N/A
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-3920]Denial of service vulnerability in Mediaserver
      [[Problem Description]]
      [Google Security P***h][CVE-2016-3920]Denial of service vulnerability in Mediaserver
      [[Impa***]]
      N/A
      [[Reproduced Steps]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/AN/A
    
    Associated Files:
      frameworks/av/media/libstagefright/id3/ID3.cpp
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS02909022
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-3921]Elevation of privilege vulnerability i***ramework Listener
      [[問題標題]]
      [Google Security P***h][CVE-2016-3921]Elevation of privilege vulnerability i***ramework Listener
      [[問題現象]]
      [Google Security P***h][CVE-2016-3921]Elevation of privilege vulnerability i***ramework Listener
      [[問題影響]]
      N/A
      [[問題復現步驟]]
      N/A
      [[建議驗證模塊]]
      N/A
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-3921]Elevation of privilege vulnerability i***ramework Listener
      [[Problem Description]]
      [Google Security P***h][CVE-2016-3921]Elevation of privilege vulnerability i***ramework Listener
      [[Impa***]]
      N/A
      [[Reproduced Steps]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/AN/A
    
    Associated Files:
      system/core/include/sysutils/FrameworkListener.h
      system/core/libsysutils/src/FrameworkListener.cpp
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS02909023
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-3922]Elevation of privilege vulnerability ***elephony
      [[問題標題]]
      [Google Security P***h][CVE-2016-3922]Elevation of privilege vulnerability ***elephony
      [[問題現象]]
      [Google Security P***h][CVE-2016-3922]Elevation of privilege vulnerability ***elephony
      [[問題影響]]
      N/A
      [[問題復現步驟]]
      N/A
      [[建議驗證模塊]]
      BTSAP
    
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-3922]Elevation of privilege vulnerability ***elephony
      [[Problem Description]]
      [Google Security P***h][CVE-2016-3922]Elevation of privilege vulnerability ***elephony
      [[Impa***]]
      N/A
      [[Reproduced Steps]]
      N/A
      [[Modules to be verified after taking p***h]]
      BTSAPN/A
    
    Associated Files:
      hardware/ril/libril/RilSapSocket.cpp
      vendor/mediatek/proprietary/hardware/ril/c2k/libc2kril/RilSapSocket.cpp
      vendor/mediatek/proprietary/hardware/ril/gsm/librilmtk/RilSapSocket.cpp
      vendor/mediatek/proprietary/hardware/ril/rilproxy/libril/RilSapSocket.cpp
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS02909030
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-3924]I***o***ation disclosure vulnerability in Mediaserver
      [[問題標題]]
      [Google Security P***h][CVE-2016-3924]I***o***ation disclosure vulnerability in Mediaserver
      [[問題現象]]
      [Google Security P***h][CVE-2016-3924]I***o***ation disclosure vulnerability in Mediaserver
      [[問題影響]]
      N/A
      [[問題復現步驟]]
      N/A
      [[建議驗證模塊]]
      N/A
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-3924]I***o***ation disclosure vulnerability in Mediaserver
      [[Problem Description]]
      [Google Security P***h][CVE-2016-3924]I***o***ation disclosure vulnerability in Mediaserver
      [[Impa***]]
      N/A
      [[Reproduced Steps]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
    
      [[問題現象]]
    
      [[問題影響]]
      (請填寫於此行下方，並描述如果沒有合入這個p***h會造成的影響)
    
      [[問題復現步驟]]
      (請填寫於此行下方，並清楚填寫)
    
      [[建議驗證模塊]]
    
      [[注意: 請勿刪除此行]]
    
      Notice: Following i***o***ation added by you will be provided to customer dire***ly. Please input in English.
      [[Title for Customer]]
    
      [[Problem Description]]
    
      [[Impa***]]
    
      [[Reproduced Steps]]
    
      [[Modules to be verified after taking p***h]]
    
      [[Notice: Please don't dele***his line]]N/A
    
    Associated Files:
      frameworks/av/services/audioflinger/Effects.cpp
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS02909033
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-3925]Denial of service vulnerability in Wi-FI
      [[問題標題]]
      [Google Security P***h][CVE-2016-3925]Denial of service vulnerability in Wi-FI
      [[問題現象]]
      reboot
      [Google Security P***h][CVE-2016-3925]Denial of service vulnerability in Wi-FI
      [[問題影響]]
      The ANQP Element parsing code that parses untrusted data broadcasted
      ***Ps is currently un***ed, and might contain errors that will
      trigger exceptions th******rash the sys*** service (e.g. null po***er
      exceptions).
    
      To conta***his risk, c***h all possible exceptions from the invoking
      ANQP element parsing code from ANQPFa***ory, and throw them again
      as ProtocolExceptions, which users of ANQPFa***ory already c***h.
      [[問題復現步驟]]
      send illegal ANQP element to device
      [[建議驗證模塊]]
      Wi-Fi
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-3925]Denial of service vulnerability in Wi-FI
      [[Problem Description]]
      [Google Security P***h][CVE-2016-3925]Denial of service vulnerability in Wi-FI
      reboot
      [[Impa***]]
      The ANQP Element parsing code that parses untrusted data broadcasted
      ***Ps is currently un***ed, and might contain errors that will
      trigger exceptions th******rash the sys*** service (e.g. null po***er
      exceptions).
    
      To conta***his risk, c***h all possible exceptions from the invoking
      ANQP element parsing code from ANQPFa***ory, and throw them again
      as ProtocolExceptions, which users of ANQPFa***ory already c***h.
      [[Reproduced Steps]]
      send illegal ANQP element to device
      [[Modules to be verified after taking p***h]]
      Wi-FiN/A
    
    Associated Files:
      frameworks/opt/net/wifi/service/java/com/android/server/wifi/anqp/ANQPFactory.java
    
    Change-Id: Ia6f4eedd17f1f65ca72913e39de77a56875b9ed9

diff --git a/include/sysutils/FrameworkListener.h b/include/sysutils/FrameworkListener.h
index 18049cd41..2137069fb 100644
--- a/include/sysutils/FrameworkListener.h
+++ b/include/sysutils/FrameworkListener.h
@@ -32,6 +32,7 @@ private:
     int mCommandCount;
     bool mWithSeq;
     FrameworkCommandCollection *mCommands;
+    bool mSkipToNextNullByte;
 
 public:
     FrameworkListener(const char *socketName);
diff --git a/libsysutils/src/FrameworkListener.cpp b/libsysutils/src/FrameworkListener.cpp
index fd67aeaff..3706f2f59 100644
--- a/libsysutils/src/FrameworkListener.cpp
+++ b/libsysutils/src/FrameworkListener.cpp
@@ -54,6 +54,7 @@ void FrameworkListener::init(const char *socketName UNUSED, bool withSeq) {
     errorRate = 0;
     mCommandCount = 0;
     mWithSeq = withSeq;
+    mSkipToNextNullByte = false;
 }
 
 bool FrameworkListener::onDataAvailable(SocketClient *c) {
@@ -64,10 +65,15 @@ bool FrameworkListener::onDataAvailable(SocketClient *c) {
     if (len < 0) {
         SLOGE("read() failed (%s)", strerror(errno));
         return false;
-    } else if (!len)
+    } else if (!len) {
         return false;
-   if(buffer[len-1] != '\0')
+    } else if (buffer[len-1] != '\0') {
         SLOGW("String is not zero-terminated");
+        android_errorWriteLog(0x534e4554, "29831647");
+        c->sendMsg(500, "Command too large for buffer", false);
+        mSkipToNextNullByte = true;
+        return false;
+    }
 
     int offset = 0;
     int i;
@@ -75,11 +81,16 @@ bool FrameworkListener::onDataAvailable(SocketClient *c) {
     for (i = 0; i < len; i++) {
         if (buffer[i] == '\0') {
             /* IMPORTANT: dispatchCommand() expects a zero-terminated string */
-            dispatchCommand(c, buffer + offset);
+            if (mSkipToNextNullByte) {
+                mSkipToNextNullByte = false;
+            } else {
+                dispatchCommand(c, buffer + offset);
+            }
             offset = i + 1;
         }
     }
 
+    mSkipToNextNullByte = false;
     return true;
 }
 
