MotorolaMobilityLLC__system-core
commit e3c8fe4253fbcbcc3593dd48d33720940bc95325
Author:     Tianjie Xu <xunchang@google.com>
AuthorDate: Wed Apr 5 14:46:27 2017 -0700
Commit:     chenyt9 <chenyt9@lenovo.com>
CommitDate: Mon Mar 12 16:30:57 2018 +0800

    Fix out of bound read in libziparchive
    
    CVE-2017-0647 : Information disclosure vulnerability in libziparchive
    A-36392138
    Mot-CRs-fixed: (CR)
    
    We should check the boundary of central directory before checking its
    signature. Swap the order of these two checks.
    
    Bug: 36392138
    Test: libziparchive doesn't read the signature after boundary check fails.
    Change-Id: Ie89f709bb2d1ccb647116fb7ccb1e23c943e5ab8
    (cherry picked from commit 74464a1361562d4042a67c5d66bfcf396ee7e59c)
    (cherry picked from commit d9fd1863f46d5185eaaebc0803ee9c5da3ef110b)
    Reviewed-on: https://gerrit.mot.com/989020
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Jira Key <jirakey@motorola.com>

diff --git a/libziparchive/zip_archive.cc b/libziparchive/zip_archive.cc
index 986ee7208..49097ce9b 100644
--- a/libziparchive/zip_archive.cc
+++ b/libziparchive/zip_archive.cc
@@ -386,6 +386,14 @@ static int32_t ParseZipArchive(ZipArchive* archive) {
   const uint8_t* const cd_end = cd_ptr + cd_length;
   const uint8_t* ptr = cd_ptr;
   for (uint16_t i = 0; i < num_entries; i++) {
+    if (ptr > cd_end - sizeof(CentralDirectoryRecord)) {
+      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
+#if defined(__ANDROID__)
+      android_errorWriteLog(0x534e4554, "36392138");
+#endif
+      return -1;
+    }
+
     const CentralDirectoryRecord* cdr =
         reinterpret_cast<const CentralDirectoryRecord*>(ptr);
     if (cdr->record_signature != CentralDirectoryRecord::kSignature) {
@@ -393,11 +401,6 @@ static int32_t ParseZipArchive(ZipArchive* archive) {
       return -1;
     }
 
-    if (ptr + sizeof(CentralDirectoryRecord) > cd_end) {
-      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
-      return -1;
-    }
-
     const off64_t local_header_offset = cdr->local_file_header_offset;
     if (local_header_offset >= archive->directory_offset) {
       ALOGW("Zip: bad LFH offset %" PRId64 " at entry %" PRIu16,
