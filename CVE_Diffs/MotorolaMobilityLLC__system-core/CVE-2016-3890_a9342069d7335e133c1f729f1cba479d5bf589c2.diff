MotorolaMobilityLLC__system-core
commit a9342069d7335e133c1f729f1cba479d5bf589c2
Author:     Josh Gao <jmgao@google.com>
AuthorDate: Wed May 18 10:39:48 2016 -0700
Commit:     Charles Barros <charlesb@motorola.com>
CommitDate: Mon Jan 23 16:48:55 2017 -0200

    adb: use asocket's close function when closing.
    
    ANDROID-28347842: Elevation of privilege vulnerability in Java Debug Wire Protocol
    CVE-2016-3890
    
    Mot-CRs-fixed: (CR)
    
    close_all_sockets was assuming that all registered local sockets used
    local_socket_close as their close function. However, this is not true
    for JDWP sockets.
    
    Bug: http://b/28347842
    Change-Id: I40a1174845cd33f15f30ce70828a7081cd5a087e
    (cherry picked from commit 53eb31d87cb84a4212f4850bf745646e1fb12814)
    (cherry picked from commit 014b01706cc64dc9c2ad94a96f62e07c058d0b5d)
    
    Signed-off-by: Andy Seah <dntc46@motorola.com>
    Change-Id: Ie1ff57acbaf98111f60817b55f217180d82f9246
    Reviewed-on: https://gerrit.mot.com/884847
    SLTApproved: Slta Waiver <sltawvr@motorola.com>
    SME-Granted: SME Approvals Granted
    Tested-by: Jira Key <jirakey@motorola.com>
    Reviewed-by: Igor Kovalenko <igork@motorola.com>
    Submit-Approved: Choon Lee Seah <andyseah@motorola.com>
    (cherry picked from commit 1588ff476e8499bdf3da2e643b40cff8775a29dd)
    Reviewed-on: https://gerrit.mot.com/898136
    Submit-Approved: Jira Key <jirakey@motorola.com>
    Reviewed-by: Chao-Wei Zhang <e12892@motorola.com>
    SLTApproved: Chao-Wei Zhang <e12892@motorola.com>

diff --git a/adb/sockets.cpp b/adb/sockets.cpp
index 31b54431b..3919147a3 100644
--- a/adb/sockets.cpp
+++ b/adb/sockets.cpp
@@ -43,8 +43,6 @@
 using std::recursive_mutex;
 #endif
 
-static void local_socket_close(asocket* s);
-
 static recursive_mutex& local_socket_list_lock = *new recursive_mutex();
 static unsigned local_socket_next_id = 1;
 
@@ -128,7 +126,7 @@ void close_all_sockets(atransport *t)
 restart:
     for (s = local_socket_list.next; s != &local_socket_list; s = s->next) {
         if (s->transport == t || (s->peer && s->peer->transport == t)) {
-            local_socket_close(s);
+            s->close(s);
             goto restart;
         }
     }
