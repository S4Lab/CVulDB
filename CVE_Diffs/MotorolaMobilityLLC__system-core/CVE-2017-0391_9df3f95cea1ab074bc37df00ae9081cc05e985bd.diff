MotorolaMobilityLLC__system-core
commit 9df3f95cea1ab074bc37df00ae9081cc05e985bd
Author:     yangqh5 <yangqh5@lenovo.com>
AuthorDate: Sun May 21 08:38:03 2017 +0800
Commit:     Fan Hang <hangfan1@lenovo.com>
CommitDate: Tue Dec 19 17:39:03 2017 +0800

    [MTK Patch][PIS-9517]For_mt6797_6m_n_alps-mp-n1.mp9-V1_P64
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03303742
    Severity:
    
    Description:
      [Patch Request] [PMS] [SBPM] mt, Project: mt6797_6M_N, SW Version: alps-mp-n1.mp9-V1N/A
    
    Associated Files:
      device/mt/mt6797_6m_n/ProjectConfig.mk
      vendor/mt/libs/libmtk-art-runtime/arm/libmtk-art-runtime.a
      vendor/mt/libs/libmtk-art-runtime/arm64/libmtk-art-runtime.a
      vendor/mt/libs/libmtk-art-runtimed/arm/libmtk-art-runtimed.a
      vendor/mt/libs/libmtk-art-runtimed/arm64/libmtk-art-runtimed.a
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283068
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0637]Remote code execution vulnerability in Mediaserver
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0637]Remote code execution vulnerability in Mediaserver
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0637]Remote code execution vulnerability in Mediaserver
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0637]Remote code execution vulnerability in Mediaserver
      [[問題現象]]
      [Google Security P***h][CVE-2017-0637]Remote code execution vulnerability in Mediaserver
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libhevc/decoder/ihevcd_parse_headers.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283093
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/valid.c
      vendor/mt/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/mt/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/mt/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283096
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/uri.c
      vendor/mt/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/mt/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/mt/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283107
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0391]Denial of service vulnerability in Mediaserver
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0391]Denial of service vulnerability in Mediaserver
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0391]Denial of service vulnerability in Mediaserver
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0391]Denial of service vulnerability in Mediaserver
      [[問題現象]]
      [Google Security P***h][CVE-2017-0391]Denial of service vulnerability in Mediaserver
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libhevc/decoder/ihevcd_parse_slice_header.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283109
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[問題現象]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libavc/decoder/ih264d_api.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283115
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0642]Denial of service vulnerability in Mediaserver
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0642]Denial of service vulnerability in Mediaserver
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0642]Denial of service vulnerability in Mediaserver
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0642]Denial of service vulnerability in Mediaserver
      [[問題現象]]
      [Google Security P***h][CVE-2017-0642]Denial of service vulnerability in Mediaserver
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libhevc/decoder/ihevcd_parse_slice_header.c
      external/libhevc/decoder/ihevcd_ref_list.c
      external/libhevc/decoder/ihevcd_structs.h
      external/libhevc/decoder/ihevcd_utils.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283127
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/xpath.c
      vendor/mt/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/mt/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/mt/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283130
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/parser.c
      vendor/mt/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/mt/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/mt/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283131
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0645]Elevation of privilege vulnerability i***luetooth
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0645]Elevation of privilege vulnerability i***luetooth
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0645]Elevation of privilege vulnerability i***luetooth
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0645]Elevation of privilege vulnerability i***luetooth
      [[問題現象]]
      [Google Security P***h][CVE-2017-0645]Elevation of privilege vulnerability i***luetooth
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppUtility.java
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283137
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[問題現象]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      system/core/libziparchive/zip_archive.cc
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283142
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/parser.c
      vendor/mt/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/mt/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/mt/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03284167
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0636]Elevation of privilege vulnerability in MediaTek command queue driver (device specific)
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0636]Elevation of privilege vulnerability in MediaTek command queue driver (device specific)
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0636]Elevation of privilege vulnerability in MediaTek command queue driver (device specific)
      [[Potential Impa*** of the solution]]
      Camera failure
      [[Modules to be verified after taking p***h]]
      camera
      [[問題標題]]
      [Google Security P***h][CVE-2017-0636]Elevation of privilege vulnerability in MediaTek command queue driver (device specific)
      [[問題現象]]
      [Google Security P***h][CVE-2017-0636]Elevation of privilege vulnerability in MediaTek command queue driver (device specific)
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      Camera 不正常
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      cameraN/A
    
    Associated Files:
      kernel-3.18/drivers/misc/mediatek/cmdq/hv1/Makefile
      kernel-3.18/drivers/misc/mediatek/cmdq/hv1/cmdq_test.c
    
    Change-Id: If4b74f17341da9e727ae199522ea1602bd433094

diff --git a/libziparchive/zip_archive.cc b/libziparchive/zip_archive.cc
index 986ee7208..49097ce9b 100644
--- a/libziparchive/zip_archive.cc
+++ b/libziparchive/zip_archive.cc
@@ -386,6 +386,14 @@ static int32_t ParseZipArchive(ZipArchive* archive) {
   const uint8_t* const cd_end = cd_ptr + cd_length;
   const uint8_t* ptr = cd_ptr;
   for (uint16_t i = 0; i < num_entries; i++) {
+    if (ptr > cd_end - sizeof(CentralDirectoryRecord)) {
+      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
+#if defined(__ANDROID__)
+      android_errorWriteLog(0x534e4554, "36392138");
+#endif
+      return -1;
+    }
+
     const CentralDirectoryRecord* cdr =
         reinterpret_cast<const CentralDirectoryRecord*>(ptr);
     if (cdr->record_signature != CentralDirectoryRecord::kSignature) {
@@ -393,11 +401,6 @@ static int32_t ParseZipArchive(ZipArchive* archive) {
       return -1;
     }
 
-    if (ptr + sizeof(CentralDirectoryRecord) > cd_end) {
-      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
-      return -1;
-    }
-
     const off64_t local_header_offset = cdr->local_file_header_offset;
     if (local_header_offset >= archive->directory_offset) {
       ALOGW("Zip: bad LFH offset %" PRId64 " at entry %" PRIu16,
