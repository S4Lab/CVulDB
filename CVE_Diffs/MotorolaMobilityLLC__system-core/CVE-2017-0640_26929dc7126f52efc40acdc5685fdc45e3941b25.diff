MotorolaMobilityLLC__system-core
commit 26929dc7126f52efc40acdc5685fdc45e3941b25
Author:     xiest1 <xiest1@lenovo.com>
AuthorDate: Mon May 29 11:22:41 2017 +0800
Commit:     xiest1 <xiest1@lenovo.com>
CommitDate: Mon May 29 12:48:19 2017 +0800

    [(CR)][xiest1]ALPS03322171(For_lenovo6757_66_n_n1_alps-mp-n1.mp5-V1.19_P24)
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03322171
    Severity:
    
    Description:
      [Patch Request] [PMS] [SBPM] LENOVO, Project: LENOVO6757_66_N_N1, SW Version: alps-mp-n1.mp5-V1.19N/A
    
    Associated Files:
      device/lenovo/lenovo6757_36_n_n1/ProjectConfig.mk
      device/lenovo/lenovo6757_66_n_n1/ProjectConfig.mk
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283086
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-5131]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-5131]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2016-5131]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2016-5131]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2016-5131]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/test/XPath/xptr/vidbase
      external/libxml2/xpath.c
      external/libxml2/xpointer.c
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283089
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-4658]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-4658]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2016-4658]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2016-4658]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2016-4658]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/xpointer.c
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283093
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-0663]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/valid.c
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283096
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-7376]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/uri.c
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283109
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[問題現象]]
      [Google Security P***h][CVE-2017-0640]Denial of service vulnerability in Mediaserver
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libavc/decoder/ih264d_api.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283127
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-5056]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/xpath.c
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283130
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2017-7375]Remote code execution vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/parser.c
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283135
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0646]I***o***ation disclosure vulnerability i***luetooth
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0646]I***o***ation disclosure vulnerability i***luetooth
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0646]I***o***ation disclosure vulnerability i***luetooth
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0646]I***o***ation disclosure vulnerability i***luetooth
      [[問題現象]]
      [Google Security P***h][CVE-2017-0646]I***o***ation disclosure vulnerability i***luetooth
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      system/bt/stack/btm/btm_ble_gap.c
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283137
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[Title for Customer]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[Problem Description]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[問題現象]]
      [Google Security P***h][CVE-2017-0647]I***o***ation disclosure vulnerability in libziparchive
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      system/core/libziparchive/zip_archive.cc
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03283142
    Severity:
      Critical
    Description:
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[Title for Customer]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[Problem Description]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[問題現象]]
      [Google Security P***h][CVE-2016-1839]Denial of service vulnerability in libxml2
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      external/libxml2/parser.c
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Patch Type:
      Customer Request
    CR ID:
      ALPS03284331
    Severity:
      Critical
    Description:
      [Google Security P***h][AN***D-37204197]Change Security P***h Level in Settings
      [[Title for Customer]]
      [Google Security P***h][AN***D-37204197]Change Security P***h Level in Settings
      [[Problem Description]]
      [Google Security P***h][AN***D-37204197]Change Security P***h Level in Settings
      [[Potential Impa*** of the solution]]
      N/A
      [[Modules to be verified after taking p***h]]
      N/A
      [[問題標題]]
      [Google Security P***h][AN***D-37204197]Change Security P***h Level in Settings
      [[問題現象]]
      [Google Security P***h][AN***D-37204197]Change Security P***h Level in Settings
      [[解法可能帶來的影響]]
      (請填寫於此行下方，並描述如果合入這個p***h可能會有什麼trade off的改變，如perfo******e降低、UI改變等等)
      N/A
      [[建議驗證模塊]]
      (請填寫於此行下方，並建議客戶合了此p***h後要驗證哪些module或feature)
      N/AN/A
    
    Associated Files:
      build/core/version_defaults.mk
      vendor/lenovo/libs/libdrmmtkutil/arm/libdrmmtkutil.so
      vendor/lenovo/libs/libdrmmtkutil/arm64/libdrmmtkutil.so
      vendor/lenovo/libs/mtk_agpsd/arm/mtk_agpsd
    
    Change-Id: I9860853fbda86b0671e44339357a01f165d75fe8

diff --git a/libziparchive/zip_archive.cc b/libziparchive/zip_archive.cc
index 986ee7208..49097ce9b 100644
--- a/libziparchive/zip_archive.cc
+++ b/libziparchive/zip_archive.cc
@@ -386,6 +386,14 @@ static int32_t ParseZipArchive(ZipArchive* archive) {
   const uint8_t* const cd_end = cd_ptr + cd_length;
   const uint8_t* ptr = cd_ptr;
   for (uint16_t i = 0; i < num_entries; i++) {
+    if (ptr > cd_end - sizeof(CentralDirectoryRecord)) {
+      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
+#if defined(__ANDROID__)
+      android_errorWriteLog(0x534e4554, "36392138");
+#endif
+      return -1;
+    }
+
     const CentralDirectoryRecord* cdr =
         reinterpret_cast<const CentralDirectoryRecord*>(ptr);
     if (cdr->record_signature != CentralDirectoryRecord::kSignature) {
@@ -393,11 +401,6 @@ static int32_t ParseZipArchive(ZipArchive* archive) {
       return -1;
     }
 
-    if (ptr + sizeof(CentralDirectoryRecord) > cd_end) {
-      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
-      return -1;
-    }
-
     const off64_t local_header_offset = cdr->local_file_header_offset;
     if (local_header_offset >= archive->directory_offset) {
       ALOGW("Zip: bad LFH offset %" PRId64 " at entry %" PRIu16,
