ValveSoftware__steamos_kernel
commit e0d34fea66c5dbe70116acac6f4d722564810dca
Author:     Chris Wright <chrisw@sous-sol.org>
AuthorDate: Mon Dec 4 19:44:59 2006 +0100
Commit:     Adrian Bunk <bunk@stusta.de>
CommitDate: Mon Dec 4 19:44:59 2006 +0100

    bridge: fix possible overflow in get_fdb_entries (CVE-2006-5751)
    
    Make sure to properly clamp maxnum to avoid overflow (CVE-2006-5751).
    
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>
    Acked-by: Stephen Hemminger <shemminger@osdl.org>
    Acked-by: David Miller <davem@davemloft.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

diff --git a/net/bridge/br_ioctl.c b/net/bridge/br_ioctl.c
index 159fb8409824..0d5b0d1ef25f 100644
--- a/net/bridge/br_ioctl.c
+++ b/net/bridge/br_ioctl.c
@@ -58,12 +58,13 @@ static int get_fdb_entries(struct net_bridge *br, void __user *userbuf,
 {
 	int num;
 	void *buf;
-	size_t size = maxnum * sizeof(struct __fdb_entry);
+	size_t size;
 
-	if (size > PAGE_SIZE) {
-		size = PAGE_SIZE;
+	/* Clamp size to PAGE_SIZE, test maxnum to avoid overflow */
+	if (maxnum > PAGE_SIZE/sizeof(struct __fdb_entry))
 		maxnum = PAGE_SIZE/sizeof(struct __fdb_entry);
-	}
+
+	size = maxnum * sizeof(struct __fdb_entry);
 
 	buf = kmalloc(size, GFP_USER);
 	if (!buf)
