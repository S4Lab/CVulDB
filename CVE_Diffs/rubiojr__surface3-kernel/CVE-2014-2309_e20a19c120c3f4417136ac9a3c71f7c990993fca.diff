rubiojr__surface3-kernel
commit e20a19c120c3f4417136ac9a3c71f7c990993fca
Author:     Sabrina Dubroca <sd@queasysnail.net>
AuthorDate: Thu Mar 6 17:51:57 2014 +0100
Commit:     Tim Gardner <rtg@gomeisa.buildd>
CommitDate: Fri Apr 4 09:24:36 2014 -0400

    ipv6: don't set DST_NOCOUNT for remotely added routes
    
    DST_NOCOUNT should only be used if an authorized user adds routes
    locally. In case of routes which are added on behalf of router
    advertisments this flag must not get used as it allows an unlimited
    number of routes getting added remotely.
    
    Signed-off-by: Sabrina Dubroca <sd@queasysnail.net>
    Acked-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    
    (cherry picked from commit c88507fbad8055297c1d1e21e599f46960cbee39)
    CVE-2014-2309
    Signed-off-by: Andy Whitcroft <apw@canonical.com>

diff --git a/net/ipv6/route.c b/net/ipv6/route.c
index 4b4944c3e4c..40b6e691079 100644
--- a/net/ipv6/route.c
+++ b/net/ipv6/route.c
@@ -1495,7 +1495,7 @@ int ip6_route_add(struct fib6_config *cfg)
 	if (!table)
 		goto out;
 
-	rt = ip6_dst_alloc(net, NULL, DST_NOCOUNT, table);
+	rt = ip6_dst_alloc(net, NULL, (cfg->fc_flags & RTF_ADDRCONF) ? 0 : DST_NOCOUNT, table);
 
 	if (!rt) {
 		err = -ENOMEM;
