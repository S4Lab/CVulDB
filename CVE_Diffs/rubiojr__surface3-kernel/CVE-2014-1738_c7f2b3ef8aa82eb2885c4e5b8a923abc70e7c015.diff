rubiojr__surface3-kernel
commit c7f2b3ef8aa82eb2885c4e5b8a923abc70e7c015
Author:     Matthew Daley <mattd@bugfuzz.com>
AuthorDate: Mon Apr 28 19:05:21 2014 +1200
Commit:     Kamal Mostafa <kamal@canonical.com>
CommitDate: Tue May 6 14:52:59 2014 -0700

    floppy: don't write kernel-only members to FDRAWCMD ioctl output
    
    commit 2145e15e0557a01b9195d1c7199a1b92cb9be81f upstream.
    
    CVE-2014-1738
    
    BugLink: http://bugs.launchpad.net/bugs/1316735
    
    Do not leak kernel-only floppy_raw_cmd structure members to userspace.
    This includes the linked-list pointer and the pointer to the allocated
    DMA space.
    
    Signed-off-by: Matthew Daley <mattd@bugfuzz.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    References: CVE-2014-1738
    Acked-by: Andy Whitcroft <andy.whitcroft@canonical.com>
    Signed-off-by: Kamal Mostafa <kamal@canonical.com>

diff --git a/drivers/block/floppy.c b/drivers/block/floppy.c
index 10fbd3f3a4a..738af94fe1c 100644
--- a/drivers/block/floppy.c
+++ b/drivers/block/floppy.c
@@ -3053,7 +3053,10 @@ static int raw_cmd_copyout(int cmd, void __user *param,
 	int ret;
 
 	while (ptr) {
-		ret = copy_to_user(param, ptr, sizeof(*ptr));
+		struct floppy_raw_cmd cmd = *ptr;
+		cmd.next = NULL;
+		cmd.kernel_data = NULL;
+		ret = copy_to_user(param, &cmd, sizeof(cmd));
 		if (ret)
 			return -EFAULT;
 		param += sizeof(struct floppy_raw_cmd);
