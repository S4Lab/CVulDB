franciscofranco__one_plus_3T
commit e899d81c907039e3dbc59eddd89ce2a007631825
Author:     Gu Zheng <guzheng1@huawei.com>
AuthorDate: Mon Jan 9 09:34:48 2017 +0800
Commit:     dianlujitao <dianlujitao@lineageos.org>
CommitDate: Sun Apr 2 12:58:38 2017 +0800

    tmpfs: clear S_ISGID when setting posix ACLs
    
    This change was missed the tmpfs modification in In CVE-2016-7097
    commit 7f140e00d932b1fdef26c344fa60b3cf7e51bdd5 ("posix_acl: Clear SGID bit when setting
    file permissions")
    It can test by xfstest generic/375, which failed to clear
    setgid bit in the following test case on tmpfs:
    
      touch $testfile
      chown 100:100 $testfile
      chmod 2755 $testfile
      _runas -u 100 -g 101 -- setfacl -m u::rwx,g::rwx,o::rwx $testfile
    
    Change-Id: I6c4fde9a7518363f60b0501f014986f4392755b8
    Signed-off-by: Gu Zheng <guzheng1@huawei.com>
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>

diff --git a/fs/posix_acl.c b/fs/posix_acl.c
index 73aad912314e..94e682609b8f 100644
--- a/fs/posix_acl.c
+++ b/fs/posix_acl.c
@@ -900,11 +900,10 @@ int simple_set_acl(struct inode *inode, struct posix_acl *acl, int type)
 	int error;
 
 	if (type == ACL_TYPE_ACCESS) {
-		error = posix_acl_equiv_mode(acl, &inode->i_mode);
-		if (error < 0)
-			return 0;
-		if (error == 0)
-			acl = NULL;
+		error = posix_acl_update_mode(inode,
+				&inode->i_mode, &acl);
+		if (error)
+			return error;
 	}
 
 	inode->i_ctime = CURRENT_TIME;
