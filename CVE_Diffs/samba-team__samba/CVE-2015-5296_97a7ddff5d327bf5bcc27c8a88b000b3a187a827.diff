samba-team__samba
commit 97a7ddff5d327bf5bcc27c8a88b000b3a187a827
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Thu Nov 3 17:16:43 2016 +0100
Commit:     Stefan Metzmacher <metze@samba.org>
CommitDate: Mon Sep 4 11:27:59 2017 +0200

    CVE-2017-12150: s3:lib: get_cmdline_auth_info_signing_state smb_encrypt SMB_SIGNING_REQUIRED
    
    This is an addition to the fixes for CVE-2015-5296.
    
    It applies to smb2mount -e, smbcacls -e and smbcquotas -e.
    
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=12997
    
    Signed-off-by: Stefan Metzmacher <metze@samba.org>

diff --git a/source3/lib/util_cmdline.c b/source3/lib/util_cmdline.c
index 80142e2f82b..90ee67c4cb7 100644
--- a/source3/lib/util_cmdline.c
+++ b/source3/lib/util_cmdline.c
@@ -265,6 +265,9 @@ void set_cmdline_auth_info_signing_state_raw(struct user_auth_info *auth_info,
 
 int get_cmdline_auth_info_signing_state(const struct user_auth_info *auth_info)
 {
+	if (auth_info->smb_encrypt) {
+		return SMB_SIGNING_REQUIRED;
+	}
 	return auth_info->signing_state;
 }
 
