samba-team__samba
commit 7b711ce91a01dae266e4acaa5ab6487109e1264f
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Thu Mar 15 13:07:47 2012 +0100
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Tue Apr 10 20:35:44 2012 +0200

    pidl/NDR/Parser: use ParseArrayPullGetLength() to get the number of array elements (bug #8815 / CVE-2012-1182)
    
    An anonymous researcher and Brian Gorenc (HP DVLabs) working
    with HP's Zero Day Initiative program have found this and notified us.
    
    metze
    (cherry picked from commit 586c3fab85cde3bd6a5141fbba3bb5fcb6b67ab5)

diff --git a/pidl/lib/Parse/Pidl/Samba4/NDR/Parser.pm b/pidl/lib/Parse/Pidl/Samba4/NDR/Parser.pm
index f2d74013ea5..77223b63916 100644
--- a/pidl/lib/Parse/Pidl/Samba4/NDR/Parser.pm
+++ b/pidl/lib/Parse/Pidl/Samba4/NDR/Parser.pm
@@ -1111,14 +1111,10 @@ sub ParseElementPullLevel
 		}
 	} elsif ($l->{TYPE} eq "ARRAY" and 
 			not has_fast_array($e,$l) and not is_charset_array($e, $l)) {
-		my $length = ParseExpr($l->{LENGTH_IS}, $env, $e->{ORIGINAL});
+		my $length = $self->ParseArrayPullGetLength($e, $l, $ndr, $var_name, $env);
 		my $counter = "cntr_$e->{NAME}_$l->{LEVEL_INDEX}";
 		my $array_name = $var_name;
 
-		if ($l->{IS_VARYING}) {
-			$length = "ndr_get_array_length($ndr, " . get_pointer_to($var_name) .")";
-		}
-
 		if (my $range = has_property($e, "range")) {
 			my ($low, $high) = split(/,/, $range, 2);
 			if ($low < 0) {
