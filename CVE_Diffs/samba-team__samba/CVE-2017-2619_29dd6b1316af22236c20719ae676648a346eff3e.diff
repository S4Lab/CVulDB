samba-team__samba
commit 29dd6b1316af22236c20719ae676648a346eff3e
Author:     Jeremy Allison <jra@samba.org>
AuthorDate: Mon Mar 27 11:48:25 2017 -0700
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Fri Mar 31 08:25:18 2017 +0200

    s3: Test for CVE-2017-2619 regression with "follow symlinks = no".
    
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=12721
    
    Signed-off-by: Jeremy Allison <jra@samba.org>
    Reviewed-by: Uri Simchoni <uri@samba.org>
    
    Back-ported from commit 782172a9bef0040981d20e49519b13dd744df6a0

diff --git a/selftest/target/Samba3.pm b/selftest/target/Samba3.pm
index 938d195726f..1424a539eeb 100755
--- a/selftest/target/Samba3.pm
+++ b/selftest/target/Samba3.pm
@@ -1207,6 +1207,9 @@ sub provision($$$$$$$$)
 	my $shadow_shrdir="$shadow_basedir/share";
 	push(@dirs,$shadow_shrdir);
 
+	my $nosymlinks_shrdir="$shrdir/nosymlinks";
+	push(@dirs,$nosymlinks_shrdir);
+
 	# this gets autocreated by winbindd
 	my $wbsockdir="$prefix_abs/winbindd";
 	my $wbsockprivdir="$lockdir/winbindd_privileged";
@@ -1820,6 +1823,10 @@ sub provision($$$$$$$$)
 	copy = tmp
 	acl_xattr:ignore system acls = yes
 	acl_xattr:default acl style = posix
+[nosymlinks]
+	copy = tmp
+	path = $nosymlinks_shrdir
+	follow symlinks = no
 [acl_xattr_ign_sysacl_windows]
 	copy = tmp
 	acl_xattr:ignore system acls = yes
