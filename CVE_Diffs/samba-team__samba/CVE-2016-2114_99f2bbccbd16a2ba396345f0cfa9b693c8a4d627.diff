samba-team__samba
commit 99f2bbccbd16a2ba396345f0cfa9b693c8a4d627
Author:     Ralph Boehme <slow@samba.org>
AuthorDate: Tue Mar 22 16:30:42 2016 +0100
Commit:     Stefan Metzmacher <metze@samba.org>
CommitDate: Tue Apr 12 19:25:26 2016 +0200

    CVE-2016-2114: s3:smbd: enforce "server signing = mandatory"
    
    This fixes a regression that was introduced by commit
    abb24bf8e874d525382e994af7ae432212775153
    ("s3:smbd: make use of better SMB signing negotiation").
    
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=11687
    
    Pair-Programmed-With: Stefan Metzmacher <metze@samba.org>
    
    Signed-off-by: Ralph Boehme <slow@samba.org>
    Signed-off-by: Stefan Metzmacher <metze@samba.org>
    Reviewed-by: GÃ¼nther Deschner <gd@samba.org>

diff --git a/source3/smbd/sesssetup.c b/source3/smbd/sesssetup.c
index fbc40139663..b7fdd00147e 100644
--- a/source3/smbd/sesssetup.c
+++ b/source3/smbd/sesssetup.c
@@ -32,6 +32,7 @@
 #include "../libcli/security/security.h"
 #include "auth/gensec/gensec.h"
 #include "lib/conn_tdb.h"
+#include "../libcli/smb/smb_signing.h"
 
 /****************************************************************************
  Add the standard 'Samba' signature to the end of the session setup.
@@ -607,7 +608,8 @@ void reply_sesssetup_and_X(struct smb_request *req)
 	struct smbd_server_connection *sconn = req->sconn;
 	bool doencrypt = xconn->smb1.negprot.encrypted_passwords;
 	bool signing_allowed = false;
-	bool signing_mandatory = false;
+	bool signing_mandatory = smb_signing_is_mandatory(
+		xconn->smb1.signing_state);
 
 	START_PROFILE(SMBsesssetupX);
 
