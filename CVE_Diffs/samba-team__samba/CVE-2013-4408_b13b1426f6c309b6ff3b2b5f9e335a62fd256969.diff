samba-team__samba
commit b13b1426f6c309b6ff3b2b5f9e335a62fd256969
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Tue Sep 24 05:03:40 2013 +0200
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Thu Dec 5 11:11:51 2013 +0100

    CVE-2013-4408:librpc: check for invalid frag_len within dcerpc_read_ncacn_packet_next_vector()
    
    We should do this explicit instead of relying on
    tstream_readv_pdu_ask_for_next_vector() to catch the overflow.
    
    Bug: https://bugzilla.samba.org/show_bug.cgi?id=10185
    
    Signed-off-by: Stefan Metzmacher <metze@samba.org>
    Reviewed-by: Jeremy Allison <jra@samba.org>

diff --git a/librpc/rpc/dcerpc_util.c b/librpc/rpc/dcerpc_util.c
index 632d70da7dd..b8bf64d655e 100644
--- a/librpc/rpc/dcerpc_util.c
+++ b/librpc/rpc/dcerpc_util.c
@@ -223,6 +223,15 @@ static int dcerpc_read_ncacn_packet_next_vector(struct tstream_context *stream,
 
 		ofs = state->buffer.length;
 
+		if (frag_len < ofs) {
+			/*
+			 * something is wrong, let the caller deal with it
+			 */
+			*_vector = NULL;
+			*_count = 0;
+			return 0;
+		}
+
 		state->buffer.data = talloc_realloc(state,
 						    state->buffer.data,
 						    uint8_t, frag_len);
