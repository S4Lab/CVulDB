samba-team__samba
commit af839aeb5a809d8eb1ec56d0f27e4716e2cbd24b
Author:     Jeremy Allison <jra@samba.org>
AuthorDate: Mon Dec 19 12:32:07 2016 -0800
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Wed Mar 22 10:45:16 2017 +0100

    CVE-2017-2619: s3: smbd: Move the reference counting and destructor setup to just before retuning success.
    
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=12496
    
    Signed-off-by: Jeremy Allison <jra@samba.org>
    Reviewed-by: Uri Simchoni <uri@samba.org>

diff --git a/source3/smbd/dir.c b/source3/smbd/dir.c
index b8034be1557..6b62f1415cf 100644
--- a/source3/smbd/dir.c
+++ b/source3/smbd/dir.c
@@ -1728,11 +1728,6 @@ static struct smb_Dir *OpenDir_fsp(TALLOC_CTX *mem_ctx, connection_struct *conn,
 		goto fail;
 	}
 
-	if (sconn && !sconn->using_smb2) {
-		sconn->searches.dirhandles_open++;
-	}
-	talloc_set_destructor(dirp, smb_Dir_destructor);
-
 	dirp->dir = SMB_VFS_FDOPENDIR(fsp, mask, attr);
 	if (dirp->dir != NULL) {
 		dirp->fsp = fsp;
@@ -1757,6 +1752,11 @@ static struct smb_Dir *OpenDir_fsp(TALLOC_CTX *mem_ctx, connection_struct *conn,
 		goto fail;
 	}
 
+	if (sconn && !sconn->using_smb2) {
+		sconn->searches.dirhandles_open++;
+	}
+	talloc_set_destructor(dirp, smb_Dir_destructor);
+
 	return dirp;
 
   fail:
