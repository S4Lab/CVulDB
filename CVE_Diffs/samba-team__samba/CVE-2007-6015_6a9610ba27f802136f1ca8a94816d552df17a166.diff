samba-team__samba
commit 6a9610ba27f802136f1ca8a94816d552df17a166
Author:     Gerald (Jerry) Carter <jerry@samba.org>
AuthorDate: Thu Dec 6 14:45:13 2007 -0600
Commit:     Gerald (Jerry) Carter <jerry@samba.org>
CommitDate: Thu Dec 6 14:45:13 2007 -0600

    Fix from Volker for CVE-2007-6015 (send_mailslot() buffer overrun).

diff --git a/source/nmbd/nmbd_packets.c b/source/nmbd/nmbd_packets.c
index bbcc1ecb02a..1460f7d8cd7 100644
--- a/source/nmbd/nmbd_packets.c
+++ b/source/nmbd/nmbd_packets.c
@@ -1892,6 +1892,12 @@ BOOL send_mailslot(BOOL unique, const char *mailslot,char *buf, size_t len,
 	/* Setup the smb part. */
 	ptr -= 4; /* XXX Ugliness because of handling of tcp SMB length. */
 	memcpy(tmp,ptr,4);
+
+	if (smb_size + 17*2 + strlen(mailslot) + 1 + len > MAX_DGRAM_SIZE) {
+		DEBUG(0, ("send_mailslot: Cannot write beyond end of packet\n"));
+		return False;
+	}
+
 	set_message(ptr,17,strlen(mailslot) + 1 + len,True);
 	memcpy(ptr,tmp,4);
 
