samba-team__samba
commit 6173b83e7df39f222771bd71de7a92086387c293
Author:     Jeremy Allison <jra@samba.org>
AuthorDate: Wed Jul 10 17:10:17 2013 -0700
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Mon Aug 5 12:43:37 2013 +0200

    Fix bug #10010 - Missing integer wrap protection in EA list reading can cause server to loop with DOS.
    
    Ensure we never wrap whilst adding client provided input.
    CVE-2013-4124
    
    Signed-off-by: Jeremy Allison <jra@samba.org>
    (cherry picked from commit efdbcabbe97a594572d71d714d258a5854c5d8ce)

diff --git a/source3/smbd/nttrans.c b/source3/smbd/nttrans.c
index ea9d417e743..5fc3a09784d 100644
--- a/source3/smbd/nttrans.c
+++ b/source3/smbd/nttrans.c
@@ -989,7 +989,19 @@ struct ea_list *read_nttrans_ea_list(TALLOC_CTX *ctx, const char *pdata, size_t
 		if (next_offset == 0) {
 			break;
 		}
+
+		/* Integer wrap protection for the increment. */
+		if (offset + next_offset < offset) {
+			break;
+		}
+
 		offset += next_offset;
+
+		/* Integer wrap protection for while loop. */
+		if (offset + 4 < offset) {
+			break;
+		}
+
 	}
 
 	return ea_list_head;
