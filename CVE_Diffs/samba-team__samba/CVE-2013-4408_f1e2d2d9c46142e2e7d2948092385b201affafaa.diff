samba-team__samba
commit f1e2d2d9c46142e2e7d2948092385b201affafaa
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Wed Oct 16 16:26:58 2013 +0200
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Thu Dec 5 10:54:16 2013 +0100

    CVE-2013-4408:s3:ctdb_conn: add some length verification to ctdb_packet_more()
    
    Bug: https://bugzilla.samba.org/show_bug.cgi?id=10185
    
    Signed-off-by: Stefan Metzmacher <metze@samba.org>
    Reviewed-by: Jeremy Allison <jra@samba.org>

diff --git a/source3/lib/ctdb_conn.c b/source3/lib/ctdb_conn.c
index a96615fb6ca..313bd7917a7 100644
--- a/source3/lib/ctdb_conn.c
+++ b/source3/lib/ctdb_conn.c
@@ -220,6 +220,11 @@ static ssize_t ctdb_packet_more(uint8_t *buf, size_t buflen, void *p)
 		return 0;
 	}
 	memcpy(&len, buf, sizeof(len));
+
+	if (len < sizeof(uint32_t)) {
+		return -1;
+	}
+
 	return (len - sizeof(uint32_t));
 }
 
