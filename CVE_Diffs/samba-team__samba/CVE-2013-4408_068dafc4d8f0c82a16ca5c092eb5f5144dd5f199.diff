samba-team__samba
commit 068dafc4d8f0c82a16ca5c092eb5f5144dd5f199
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Wed Oct 16 16:26:58 2013 +0200
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Mon Dec 9 07:05:46 2013 +0100

    CVE-2013-4408:s3:ctdb_conn: add some length verification to ctdb_packet_more()
    
    Bug: https://bugzilla.samba.org/show_bug.cgi?id=10185
    
    Signed-off-by: Stefan Metzmacher <metze@samba.org>
    Reviewed-by: Jeremy Allison <jra@samba.org>

diff --git a/source3/lib/ctdb_conn.c b/source3/lib/ctdb_conn.c
index 90930eb86b0..40071d4e5cb 100644
--- a/source3/lib/ctdb_conn.c
+++ b/source3/lib/ctdb_conn.c
@@ -233,6 +233,11 @@ static ssize_t ctdb_packet_more(uint8_t *buf, size_t buflen, void *p)
 		return 0;
 	}
 	memcpy(&len, buf, sizeof(len));
+
+	if (len < sizeof(uint32_t)) {
+		return -1;
+	}
+
 	return (len - sizeof(uint32_t));
 }
 
