samba-team__samba
commit e2096069e6e775be2d39cfbed009315ad7cbd39a
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Tue Sep 24 05:03:40 2013 +0200
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Thu Dec 5 10:54:15 2013 +0100

    CVE-2013-4408:librpc: check for invalid frag_len within dcerpc_read_ncacn_packet_done()
    
    Bug: https://bugzilla.samba.org/show_bug.cgi?id=10185
    
    Signed-off-by: Stefan Metzmacher <metze@samba.org>
    Reviewed-by: Jeremy Allison <jra@samba.org>

diff --git a/librpc/rpc/dcerpc_util.c b/librpc/rpc/dcerpc_util.c
index de292c83669..458ecc544e5 100644
--- a/librpc/rpc/dcerpc_util.c
+++ b/librpc/rpc/dcerpc_util.c
@@ -292,6 +292,11 @@ static void dcerpc_read_ncacn_packet_done(struct tevent_req *subreq)
 		return;
 	}
 
+	if (state->pkt->frag_length != state->buffer.length) {
+		tevent_req_nterror(req, NT_STATUS_RPC_PROTOCOL_ERROR);
+		return;
+	}
+
 	tevent_req_done(req);
 }
 
