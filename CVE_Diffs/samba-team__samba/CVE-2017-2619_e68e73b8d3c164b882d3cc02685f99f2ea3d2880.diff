samba-team__samba
commit e68e73b8d3c164b882d3cc02685f99f2ea3d2880
Author:     Jeremy Allison <jra@samba.org>
AuthorDate: Mon Dec 19 12:15:59 2016 -0800
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Thu Mar 23 19:10:19 2017 +0100

    CVE-2017-2619: s3: smbd: OpenDir_fsp() - Fix memory leak on error.
    
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=12496
    
    Signed-off-by: Jeremy Allison <jra@samba.org>
    Reviewed-by: Uri Simchoni <uri@samba.org>

diff --git a/source3/smbd/dir.c b/source3/smbd/dir.c
index 12edf80ee02..42e787bed6c 100644
--- a/source3/smbd/dir.c
+++ b/source3/smbd/dir.c
@@ -1797,7 +1797,7 @@ static struct smb_Dir *OpenDir_fsp(TALLOC_CTX *mem_ctx, connection_struct *conn,
 			dirp->dir_smb_fname->base_name,
 			strerror(errno)));
 		if (errno != ENOSYS) {
-			return NULL;
+			goto fail;
 		}
 	}
 
