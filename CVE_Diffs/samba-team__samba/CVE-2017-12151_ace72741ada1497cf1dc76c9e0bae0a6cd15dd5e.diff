samba-team__samba
commit ace72741ada1497cf1dc76c9e0bae0a6cd15dd5e
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Mon Aug 14 12:13:18 2017 +0200
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Wed Sep 20 13:04:10 2017 +0200

    CVE-2017-12151: s3:libsmb: add cli_state_is_encryption_on() helper function
    
    This allows to check if the current cli_state uses encryption
    (either via unix extentions or via SMB3).
    
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=12996
    
    Signed-off-by: Stefan Metzmacher <metze@samba.org>

diff --git a/source3/libsmb/clientgen.c b/source3/libsmb/clientgen.c
index 039176e5cac..44afee1d4a0 100644
--- a/source3/libsmb/clientgen.c
+++ b/source3/libsmb/clientgen.c
@@ -321,6 +321,19 @@ uint32_t cli_getpid(struct cli_state *cli)
 	return cli->smb1.pid;
 }
 
+bool cli_state_is_encryption_on(struct cli_state *cli)
+{
+	if (smbXcli_conn_protocol(cli->conn) < PROTOCOL_SMB2_02) {
+		return smb1cli_conn_encryption_on(cli->conn);
+	}
+
+	if (cli->smb2.tcon == NULL) {
+		return false;
+	}
+
+	return smb2cli_tcon_is_encryption_on(cli->smb2.tcon);
+}
+
 bool cli_state_has_tcon(struct cli_state *cli)
 {
 	uint32_t tid;
diff --git a/source3/libsmb/proto.h b/source3/libsmb/proto.h
index a74433f623e..4ae566cca1c 100644
--- a/source3/libsmb/proto.h
+++ b/source3/libsmb/proto.h
@@ -200,6 +200,7 @@ void cli_shutdown(struct cli_state *cli);
 uint16_t cli_state_get_vc_num(struct cli_state *cli);
 uint32_t cli_setpid(struct cli_state *cli, uint32_t pid);
 uint32_t cli_getpid(struct cli_state *cli);
+bool cli_state_is_encryption_on(struct cli_state *cli);
 bool cli_state_has_tcon(struct cli_state *cli);
 uint32_t cli_state_get_tid(struct cli_state *cli);
 uint32_t cli_state_set_tid(struct cli_state *cli, uint32_t tid);
