samba-team__samba
commit 0be0b755cdd2a74cf364e69c3babeb714244a604
Author:     Jeremy Allison <jra@samba.org>
AuthorDate: Tue Jan 5 11:24:36 2016 -0800
Commit:     Stefan Metzmacher <metze@samba.org>
CommitDate: Thu Mar 10 06:52:23 2016 +0100

    CVE-2015-7560: s3: smbd: Refuse to get a POSIX ACL on a symlink.
    
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=11648
    
    Signed-off-by: Jeremy Allison <jra@samba.org>
    Reviewed-by: Michael Adam <obnox@samba.org>

diff --git a/source3/smbd/trans2.c b/source3/smbd/trans2.c
index d30d0c067b2..252be331fed 100644
--- a/source3/smbd/trans2.c
+++ b/source3/smbd/trans2.c
@@ -5346,6 +5346,13 @@ NTSTATUS smbd_do_qfilepathinfo(connection_struct *conn,
 				uint16_t num_file_acls = 0;
 				uint16_t num_def_acls = 0;
 
+				status = refuse_symlink(conn,
+						fsp,
+						smb_fname->base_name);
+				if (!NT_STATUS_IS_OK(status)) {
+					return status;
+				}
+
 				if (fsp && fsp->fh->fd != -1) {
 					file_acl = SMB_VFS_SYS_ACL_GET_FD(fsp,
 						talloc_tos());
