samba-team__samba
commit 8fed2cc0a96a2ccde675a8f72bb5db31174189e2
Author:     Andrew Bartlett <abartlet@samba.org>
AuthorDate: Mon May 21 15:20:26 2018 +1200
Commit:     Stefan Metzmacher <metze@samba.org>
CommitDate: Tue Aug 14 17:42:11 2018 +0200

    CVE-2018-1140 ldb_tdb: Ensure the dn in distinguishedName= is valid before use
    
    ldb_dn_from_ldb_val() does not validate this untrusted input, so a later
    call to ldb_dn_get_casefold() can fail if the input is not valid.
    
    Signed-off-by: Andrew Bartlett <abartlet@samba.org>
    Reviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>
    BUG: https://bugzilla.samba.org/show_bug.cgi?id=13374

diff --git a/lib/ldb/ldb_tdb/ldb_index.c b/lib/ldb/ldb_tdb/ldb_index.c
index 185da3d91d5..4b5054e81ec 100644
--- a/lib/ldb/ldb_tdb/ldb_index.c
+++ b/lib/ldb/ldb_tdb/ldb_index.c
@@ -1155,6 +1155,7 @@ static int ltdb_index_dn_leaf(struct ldb_module *module,
 	}
 	if (ldb_attr_dn(tree->u.equality.attr) == 0) {
 		enum key_truncation truncation = KEY_NOT_TRUNCATED;
+		bool valid_dn = false;
 		struct ldb_dn *dn
 			= ldb_dn_from_ldb_val(list,
 					      ldb_module_get_ctx(module),
@@ -1166,6 +1167,14 @@ static int ltdb_index_dn_leaf(struct ldb_module *module,
 			return LDB_SUCCESS;
 		}
 
+		valid_dn = ldb_dn_validate(dn);
+		if (valid_dn == false) {
+			/* If we can't parse it, no match */
+			list->dn = NULL;
+			list->count = 0;
+			return LDB_SUCCESS;
+		}
+
 		/*
 		 * Re-use the same code we use for a SCOPE_BASE
 		 * search
