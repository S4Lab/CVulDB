samba-team__samba
commit 06b043c18847d65cec340a757f4a073d31607deb
Author:     Stefan Metzmacher <metze@samba.org>
AuthorDate: Wed Oct 16 14:17:49 2013 +0200
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Thu Dec 5 10:54:16 2013 +0100

    CVE-2013-4408:async_sock: add some overflow detection to read_packet_handler()
    
    Bug: https://bugzilla.samba.org/show_bug.cgi?id=10185
    
    Signed-off-by: Stefan Metzmacher <metze@samba.org>
    Reviewed-by: Jeremy Allison <jra@samba.org>

diff --git a/lib/async_req/async_sock.c b/lib/async_req/async_sock.c
index 9909bc6eb3a..e4fa4f67dc1 100644
--- a/lib/async_req/async_sock.c
+++ b/lib/async_req/async_sock.c
@@ -640,6 +640,11 @@ static void read_packet_handler(struct tevent_context *ev,
 		return;
 	}
 
+	if (total + more < total) {
+		tevent_req_error(req, EMSGSIZE);
+		return;
+	}
+
 	tmp = talloc_realloc(state, state->buf, uint8_t, total+more);
 	if (tevent_req_nomem(tmp, req)) {
 		return;
