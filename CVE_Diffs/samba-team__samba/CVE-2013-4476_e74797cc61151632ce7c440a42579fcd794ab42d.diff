samba-team__samba
commit e74797cc61151632ce7c440a42579fcd794ab42d
Author:     Björn Baumbach <bb@sernet.de>
AuthorDate: Tue Oct 29 17:48:11 2013 +0100
Commit:     Karolin Seeger <kseeger@samba.org>
CommitDate: Fri Nov 8 10:14:31 2013 +0100

    CVE-2013-4476: lib-util: split out file_save_mode() from file_save()
    
    file_save_mode() writes files with specified mode.
    
    Bug: https://bugzilla.samba.org/show_bug.cgi?id=10234
    
    Signed-off-by: Björn Baumbach <bb@sernet.de>
    Reviewed-by: Stefan Metzmacher <metze@samba.org>

diff --git a/lib/util/samba_util.h b/lib/util/samba_util.h
index 677a220d559..311e99de818 100644
--- a/lib/util/samba_util.h
+++ b/lib/util/samba_util.h
@@ -580,6 +580,8 @@ a line
 **/
 _PUBLIC_ void file_lines_slashcont(char **lines);
 
+_PUBLIC_ bool file_save_mode(const char *fname, const void *packet,
+			     size_t length, mode_t mode);
 /**
   save a lump of data into a file. Mostly used for debugging 
 */
diff --git a/lib/util/util_file.c b/lib/util/util_file.c
index e031fc51122..815cc2bf9e6 100644
--- a/lib/util/util_file.c
+++ b/lib/util/util_file.c
@@ -368,13 +368,11 @@ _PUBLIC_ void file_lines_slashcont(char **lines)
 	}
 }
 
-/**
-  save a lump of data into a file. Mostly used for debugging 
-*/
-_PUBLIC_ bool file_save(const char *fname, const void *packet, size_t length)
+_PUBLIC_ bool file_save_mode(const char *fname, const void *packet,
+			     size_t length, mode_t mode)
 {
 	int fd;
-	fd = open(fname, O_WRONLY|O_CREAT|O_TRUNC, 0644);
+	fd = open(fname, O_WRONLY|O_CREAT|O_TRUNC, mode);
 	if (fd == -1) {
 		return false;
 	}
@@ -386,6 +384,14 @@ _PUBLIC_ bool file_save(const char *fname, const void *packet, size_t length)
 	return true;
 }
 
+/**
+  save a lump of data into a file. Mostly used for debugging
+*/
+_PUBLIC_ bool file_save(const char *fname, const void *packet, size_t length)
+{
+	return file_save_mode(fname, packet, length, 0644);
+}
+
 _PUBLIC_ int vfdprintf(int fd, const char *format, va_list ap)
 {
 	char *p;
