TurboVNC__turbovnc
commit e64a43292c1ec8f3bf928bfc2c17fbfd50dc0c7f
Author:     DRC <dcommander@users.sourceforge.net>
AuthorDate: Fri Dec 12 13:39:10 2014 +0000
Commit:     DRC <dcommander@users.sourceforge.net>
CommitDate: Fri Dec 12 13:39:10 2014 +0000

    From bc8e20430b6f6378daf6ce4329029248a88af08b Mon Sep 17 00:00:00 2001
    From: Alan Coopersmith <alan.coopersmith@oracle.com>
    Date: Mon, 6 Jan 2014 23:30:14 -0800
    Subject: dix: integer overflow in GetHosts() [CVE-2014-8092 2/4]
    
    GetHosts() iterates over all the hosts it has in memory, and copies
    them to a buffer. The buffer length is calculated by iterating over
    all the hosts and adding up all of their combined length. There is a
    potential integer overflow, if there are lots and lots of hosts (with
    a combined length of > ~4 gig). This should be possible by repeatedly
    calling ProcChangeHosts() on 64bit machines with enough memory.
    
    This patch caps the list at 1mb, because multi-megabyte hostname
    lists for X access control are insane.
    
    Reported-by: Ilja Van Sprundel <ivansprundel@ioactive.com>
    Signed-off-by: Alan Coopersmith <alan.coopersmith@oracle.com>
    Reviewed-by: Peter Hutterer <peter.hutterer@who-t.net>
    
    From 1559a94395258fd73e369f1a2c98a44bfe21a486 Mon Sep 17 00:00:00 2001
    From: Keith Packard <keithp@keithp.com>
    Date: Tue, 9 Dec 2014 09:31:00 -0800
    Subject: dix: GetHosts bounds check using wrong pointer value [CVE-2014-8092
     pt. 6]
    
    GetHosts saves the pointer to allocated memory in *data, and then
    wants to bounds-check writes to that region, but was mistakenly using
    a bare 'data' instead of '*data'. Also, data is declared as void **,
    so we need a cast to turn it into a byte pointer so we can actually do
    pointer comparisons.
    
    Signed-off-by: Keith Packard <keithp@keithp.com>
    Reviewed-by: Alan Coopersmith <alan.coopersmith@oracle.com>
    Signed-off-by: Alan Coopersmith <alan.coopersmith@oracle.com>
    
    
    git-svn-id: svn+ssh://svn.code.sf.net/p/turbovnc/code/trunk@2921 799e4f7b-5fd2-41f6-823c-2ecc41bc7f0b

diff --git a/unix/Xvnc/programs/Xserver/os/access.c b/unix/Xvnc/programs/Xserver/os/access.c
index cf4ae0d6..bbd4f6d8 100644
--- a/unix/Xvnc/programs/Xserver/os/access.c
+++ b/unix/Xvnc/programs/Xserver/os/access.c
@@ -1331,6 +1331,10 @@ GetHosts(pointer *data, int *pnHosts, int *pLen, BOOL * pEnabled)
     for (host = validhosts; host; host = host->next) {
         nHosts++;
         n += pad_to_int32(host->len) + sizeof(xHostEntry);
+        /* Could check for INT_MAX, but in reality having more than 1mb of
+           hostnames in the access list is ridiculous */
+        if (n >= 1048576)
+            break;
     }
     if (n) {
         *data = ptr = malloc(n);
@@ -1339,6 +1343,8 @@ GetHosts(pointer *data, int *pnHosts, int *pLen, BOOL * pEnabled)
         }
         for (host = validhosts; host; host = host->next) {
             len = host->len;
+            if ((ptr + sizeof(xHostEntry) + len) > ((unsigned char *) *data + n))
+                break;
             ((xHostEntry *) ptr)->family = host->family;
             ((xHostEntry *) ptr)->length = len;
             ptr += sizeof(xHostEntry);
