michaellukashov__Far-NetBox
commit a7345ca4f9530a670ef4e61b979388068a240f34
Author:     Nikita Abdullin <0xABD@users.noreply.github.com>
AuthorDate: Mon Jan 21 01:18:47 2019 +0100
Commit:     Nikita Abdullin <0xABD@users.noreply.github.com>
CommitDate: Mon Jan 21 01:18:47 2019 +0100

    Security fix CVE-2019-6111 backport of https://winscp.net/tracker/1675

diff --git a/src/NetBox/FarPluginStrings.cpp b/src/NetBox/FarPluginStrings.cpp
index f0b487c0c..aa18f583b 100644
--- a/src/NetBox/FarPluginStrings.cpp
+++ b/src/NetBox/FarPluginStrings.cpp
@@ -230,6 +230,7 @@ const TFarPluginStrings FarPluginStrings[] =
   { FILEZILLA_SITE_NOT_EXIST, MSG_FILEZILLA_SITE_NOT_EXIST },
   { SFTP_AS_FTP_ERROR, MSG_SFTP_AS_FTP_ERROR },
   { LOG_FATAL_ERROR, MSG_LOG_FATAL_ERROR },
+  { UNREQUESTED_FILE, MSG_UNREQUESTED_FILE },
 
   { CORE_CONFIRMATION_STRINGS, MSG_CORE_CONFIRMATION_STRINGS },
   { CONFIRM_PROLONG_TIMEOUT3, MSG_CONFIRM_PROLONG_TIMEOUT3 },
diff --git a/src/base/MsgIDs.h b/src/base/MsgIDs.h
index 1fceabfc5..0dfa45a51 100644
--- a/src/base/MsgIDs.h
+++ b/src/base/MsgIDs.h
@@ -1044,6 +1044,7 @@ enum MsgIDs {
     MSG_FILEZILLA_SITE_NOT_EXIST,
     MSG_SFTP_AS_FTP_ERROR,
     MSG_LOG_FATAL_ERROR,
+    MSG_UNREQUESTED_FILE,
 
     MSG_CORE_CONFIRMATION_STRINGS,
     MSG_CONFIRM_PROLONG_TIMEOUT3,
diff --git a/src/core/ScpFileSystem.cpp b/src/core/ScpFileSystem.cpp
index 3572b59e8..7a6ca5d26 100644
--- a/src/core/ScpFileSystem.cpp
+++ b/src/core/ScpFileSystem.cpp
@@ -2648,6 +2648,13 @@ void TSCPFileSystem::SCPSink(const UnicodeString TargetDir,
             FTerminal->LogEvent(FORMAT("Warning: Remote host set a compound pathname '%s'", Line));
           }
 
+          // Security fix: CVE-2019-6111
+          // backport of https://winscp.net/tracker/1675
+          if ((Level == 0) && (OnlyFileName != base::UnixExtractFileName(AFileName)))
+          {
+            SCPError(LoadStr(UNREQUESTED_FILE), False);
+          }
+
           AbsoluteFileName = SourceDir + OnlyFileName;
           OperationProgress->SetFile(AbsoluteFileName);
           OperationProgress->SetTransferSize(TSize);
diff --git a/src/resource/TextsCore.h b/src/resource/TextsCore.h
index fbcb44336..6dcd4dd34 100644
--- a/src/resource/TextsCore.h
+++ b/src/resource/TextsCore.h
@@ -239,6 +239,8 @@
 #define KNOWN_HOSTS_NOT_FOUND   740
 #define KNOWN_HOSTS_NO_SITES    741
 
+#define UNREQUESTED_FILE        749
+
 #define CORE_CONFIRMATION_STRINGS 300
 #define CONFIRM_PROLONG_TIMEOUT3 301
 #define PROMPT_KEY_PASSPHRASE   303
