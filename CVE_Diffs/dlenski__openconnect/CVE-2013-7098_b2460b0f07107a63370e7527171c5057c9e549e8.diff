dlenski__openconnect
commit b2460b0f07107a63370e7527171c5057c9e549e8
Author:     Kevin Cernekee <cernekee@gmail.com>
AuthorDate: Mon Dec 30 17:49:12 2013 -0800
Commit:     David Woodhouse <David.Woodhouse@intel.com>
CommitDate: Wed Jan 1 23:07:10 2014 +0000

    dtls: Fix dtls_pkt heap overflow (CVE-2013-7098)
    
    Each time openconnect (re)establishes a CSTP connection, it reinitializes
    vpninfo->actual_mtu from the X-{CSTP,DTLS}-MTU headers provided by the
    gateway.  dtls_mainloop() uses the CURRENT value of vpninfo->actual_mtu
    as an upper limit when reading a packet, but it used the ORIGINAL value
    of vpninfo->actual_mtu when allocating the dtls_pkt buffer.  So if the
    original value was smaller than the current value, it is possible to
    overwrite a part of the heap with packet data.
    
    This probably would not happen under normal circumstances, but it may
    happen if a malicious person gained administrative access to the VPN
    gateway, or if a user was tricked into connecting to a bogus gateway.
    
    Signed-off-by: Kevin Cernekee <cernekee@gmail.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>

diff --git a/dtls.c b/dtls.c
index 4133ee0f..3e668830 100644
--- a/dtls.c
+++ b/dtls.c
@@ -690,6 +690,7 @@ int setup_dtls(struct openconnect_info *vpninfo)
 }
 
 static struct pkt *dtls_pkt;
+static int dtls_pkt_max;
 
 int dtls_mainloop(struct openconnect_info *vpninfo, int *timeout)
 {
@@ -700,12 +701,13 @@ int dtls_mainloop(struct openconnect_info *vpninfo, int *timeout)
 		int len = vpninfo->actual_mtu;
 		unsigned char *buf;
 
-		if (!dtls_pkt) {
-			dtls_pkt = malloc(sizeof(struct pkt) + len);
+		if (!dtls_pkt || len > dtls_pkt_max) {
+			realloc_inplace(dtls_pkt, sizeof(struct pkt) + len);
 			if (!dtls_pkt) {
 				vpn_progress(vpninfo, PRG_ERR, "Allocation failed\n");
 				break;
 			}
+			dtls_pkt_max = len;
 		}
 
 		buf = dtls_pkt->data - 1;
diff --git a/www/changelog.xml b/www/changelog.xml
index 0941dc7e..50310b9e 100644
--- a/www/changelog.xml
+++ b/www/changelog.xml
@@ -24,6 +24,7 @@
        <li>Fix Solaris build breakage due to missing <tt>&amp;lt;string.h&amp;gt;</tt> includes.</li>
        <li>Include path in <tt>&amp;lt;group-access&amp;gt;</tt> node.</li>
        <li>Include supporting CA certificates from PKCS#11 tokens <i>(with GnuTLS 3.2.7+)</i>.</li>
+       <li>Fix possible heap overflow if MTU is increased on reconnection (CVE-2013-7098).</li>
      </ul><br/>
   </li>
   <li><b><a href="ftp://ftp.infradead.org/pub/openconnect/openconnect-5.01.tar.gz">OpenConnect v5.01</a></b>
