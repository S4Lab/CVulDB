linux-okernel__linux-okernel
commit 8f493d797bc1fe470377adc9d8775845427e240e
Author:     Andi Kleen <ak@suse.de>
AuthorDate: Tue Jan 3 00:07:28 2006 +0100
Commit:     Linus Torvalds <torvalds@g5.osdl.org>
CommitDate: Mon Jan 2 17:01:42 2006 -0800

    [PATCH] Make sure interleave masks have at least one node set
    
    Otherwise a bad mem policy system call can confuse the interleaving
    code into referencing undefined nodes.
    
    Originally reported by Doug Chapman
    
    I was told it's CVE-2005-3358
    (one has to love these security people - they make everything sound important)
    
    Signed-off-by: Andi Kleen <ak@suse.de>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/mm/mempolicy.c b/mm/mempolicy.c
index bec88c81244e..72f402cc9c9a 100644
--- a/mm/mempolicy.c
+++ b/mm/mempolicy.c
@@ -161,6 +161,10 @@ static struct mempolicy *mpol_new(int mode, nodemask_t *nodes)
 	switch (mode) {
 	case MPOL_INTERLEAVE:
 		policy->v.nodes = *nodes;
+		if (nodes_weight(*nodes) == 0) {
+			kmem_cache_free(policy_cache, policy);
+			return ERR_PTR(-EINVAL);
+		}
 		break;
 	case MPOL_PREFERRED:
 		policy->v.preferred_node = first_node(*nodes);
