lttng__lttng-ust
commit cdf50e9e93237343729ecedb49c080c70cd0e507
Author:     Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
AuthorDate: Thu Sep 30 16:49:05 2010 +0200
Commit:     Nils Carlson <nils.carlson@ericsson.com>
CommitDate: Fri Oct 1 14:41:53 2010 +0200

    Fix insecure library loading (Debian Bug #598309, CVE-2010-3386) (v2)
    
    Thanks to Raphael Geissert for spotting this, and to Jon Bernard for forwarding
    the information to us.
    
    Changelog since v1:
    Apply comments from Nils.
    
    Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
    Acked-by: Nils Carlson <nils.carlson@ericsson.com>
    CC: Raphael Geissert <geissert@debian.org>
    CC: Jon Bernard <jbernard@debian.org>

diff --git a/usttrace b/usttrace
index dc159f2c..5fdb52f3 100755
--- a/usttrace
+++ b/usttrace
@@ -132,27 +132,54 @@ fi
 
     if [ "$arg_preload_libust" = "1" ];
     then
-	if [ -n "${LIBUST_PATH%libust.so}" ] ; then
-	    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${LIBUST_PATH%libust.so}"
+	if [ -n "${LIBUST_PATH%libust.so}" ];
+	then
+		if [ -n "$LD_LIBRARY_PATH" ];
+		then
+			export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${LIBUST_PATH%libust.so}"
+		else
+			export LD_LIBRARY_PATH="${LIBUST_PATH%libust.so}"
+		fi
+	fi
+	if [ -n "$LIBUST_PATH" ];
+	then
+		if [ -n "$LD_PRELOAD" ];
+		then
+			export LD_PRELOAD="$LD_PRELOAD:$LIBUST_PATH"
+		else
+			export LD_PRELOAD="$LIBUST_PATH"
+		fi
 	fi
-	export LD_PRELOAD="$LD_PRELOAD:$LIBUST_PATH"
     fi
 
-    if [ "$arg_ld_std_ust" = "1" ];
+    if [ "$arg_ld_std_ust" = "1" ] && [ -n "${LIBUST_PATH%libust.so}" ];
     then
-	if [ -n "$${LIBUST_PATH%libust.so}" ] ; then
-	    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${LIBUST_PATH%libust.so}"
+	if [ -n "$LD_LIBRARY_PATH" ];
+	then
+		export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${LIBUST_PATH%libust.so}"
+	else
+		export LD_LIBRARY_PATH="${LIBUST_PATH%libust.so}"
 	fi
     fi
 
-    if [ "$arg_preload_malloc" = "1" ];
+    if [ "$arg_preload_malloc" = "1" ] && [ -n "$LIBMALLOCWRAP_PATH" ];
     then
-	export LD_PRELOAD="$LD_PRELOAD:$LIBMALLOCWRAP_PATH"
+	if [ -n "$LD_PRELOAD" ];
+	then
+		export LD_PRELOAD="$LD_PRELOAD:$LIBMALLOCWRAP_PATH"
+	else
+		export LD_PRELOAD="$LIBMALLOCWRAP_PATH"
+	fi
     fi
 
-    if [ "$arg_preload_fork" = "1" ];
+    if [ "$arg_preload_fork" = "1" ] && [ -n "$LIBINTERFORK_PATH" ];
     then
-	export LD_PRELOAD="$LD_PRELOAD:$LIBINTERFORK_PATH"
+	if [ -n "$LD_PRELOAD" ];
+	then
+		export LD_PRELOAD="$LD_PRELOAD:$LIBINTERFORK_PATH"
+	else
+		export LD_PRELOAD="$LIBINTERFORK_PATH"
+	fi
     fi
 
 # Execute the command
