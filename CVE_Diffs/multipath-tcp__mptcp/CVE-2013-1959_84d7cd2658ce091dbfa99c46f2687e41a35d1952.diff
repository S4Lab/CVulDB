multipath-tcp__mptcp
commit 84d7cd2658ce091dbfa99c46f2687e41a35d1952
Author:     Andy Lutomirski <luto@amacapital.net>
AuthorDate: Sun Apr 14 16:28:19 2013 -0700
Commit:     Tim Gardner <tim.gardner@canonical.com>
CommitDate: Tue Apr 30 17:59:31 2013 -0600

    userns: Check uid_map's opener's fsuid, not the current fsuid (CVE-2013-1959)
    
    Signed-off-by: Andy Lutomirski <luto@amacapital.net>
    
    (cherry picked from commit e3211c120a85b792978bcb4be7b2886df18d27f0)
    CVE-2013-1959
    BugLink: https://launchpad.net/bugs/1174590
    Signed-off-by: John Johansen <john.johansen@canonical.com>
    Acked-by: Brad Figg <brad.figg@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/kernel/user_namespace.c b/kernel/user_namespace.c
index d259d4a0d729..c5948023990a 100644
--- a/kernel/user_namespace.c
+++ b/kernel/user_namespace.c
@@ -763,12 +763,12 @@ static bool new_idmap_permitted(const struct file *file,
 		u32 id = new_map->extent[0].lower_first;
 		if (cap_setid == CAP_SETUID) {
 			kuid_t uid = make_kuid(ns->parent, id);
-			if (uid_eq(uid, current_fsuid()))
+			if (uid_eq(uid, file->f_cred->fsuid))
 				return true;
 		}
 		else if (cap_setid == CAP_SETGID) {
 			kgid_t gid = make_kgid(ns->parent, id);
-			if (gid_eq(gid, current_fsgid()))
+			if (gid_eq(gid, file->f_cred->fsgid))
 				return true;
 		}
 	}
