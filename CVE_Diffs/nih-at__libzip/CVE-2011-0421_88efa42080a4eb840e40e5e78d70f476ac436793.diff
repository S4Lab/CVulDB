nih-at__libzip
commit 88efa42080a4eb840e40e5e78d70f476ac436793
Author:     Dieter Baron <dillo@nih.at>
AuthorDate: Tue Feb 8 22:04:11 2011 +0100
Commit:     Dieter Baron <dillo@nih.at>
CommitDate: Tue Feb 8 22:04:11 2011 +0100

    Fix CVE-2011-0421, patch from stas (php).
    
    --HG--
    branch : HEAD

diff --git a/lib/zip_name_locate.c b/lib/zip_name_locate.c
index e81fd67..1f7081b 100644
--- a/lib/zip_name_locate.c
+++ b/lib/zip_name_locate.c
@@ -1,6 +1,6 @@
 /*
   zip_name_locate.c -- get index by name
-  Copyright (C) 1999-2007 Dieter Baron and Thomas Klausner
+  Copyright (C) 1999-2011 Dieter Baron and Thomas Klausner
 
   This file is part of libzip, a library to manipulate ZIP archives.
   The authors can be contacted at <libzip@nih.at>
@@ -62,7 +62,12 @@ _zip_name_locate(struct zip *za, const char *fname, int flags,
 	_zip_error_set(error, ZIP_ER_INVAL, 0);
 	return -1;
     }
-    
+
+    if ((flags & ZIP_FL_UNCHANGED)  && za->cdir == NULL) {
+        _zip_error_set(error, ZIP_ER_NOENT, 0);
+        return -1;
+    }
+
     cmp = (flags & ZIP_FL_NOCASE) ? strcasecmp : strcmp;
 
     n = (flags & ZIP_FL_UNCHANGED) ? za->cdir->nentry : za->nentry;
