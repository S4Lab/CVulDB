nih-at__libzip
commit 2402de951cbcf1624fff36d14e99c92b15b9576c
Author:     Thomas Klausner <tk@giga.or.at>
AuthorDate: Wed Apr 22 11:13:52 2015 +0200
Commit:     Thomas Klausner <tk@giga.or.at>
CommitDate: Wed Apr 22 11:13:52 2015 +0200

    Add test for CVE-2015-2331, overflow caused by too many entries in zip.

diff --git a/regress/Makefile.am b/regress/Makefile.am
index d72221d..7dffa86 100644
--- a/regress/Makefile.am
+++ b/regress/Makefile.am
@@ -65,6 +65,7 @@ EXTRA_DIST= \
 	incons-eocd-magic-bad.zip \
 	incons-file-count-high.zip \
 	incons-file-count-low.zip \
+	incons-file-count-overflow.zip \
 	incons-local-compression-method.zip \
 	incons-local-compsize-larger.zip \
 	incons-local-compsize-smaller.zip \
diff --git a/regress/incons-file-count-overflow.zip b/regress/incons-file-count-overflow.zip
new file mode 100644
index 0000000..461722c
Binary files /dev/null and b/regress/incons-file-count-overflow.zip differ
diff --git a/regress/open_file_count.test b/regress/open_file_count.test
new file mode 100644
index 0000000..ef7f01c
--- /dev/null
+++ b/regress/open_file_count.test
@@ -0,0 +1,12 @@
+# zip_open: various inconsistent files
+setenv LANG C
+program tryopen
+file incons-file-count-high.zzip incons-file-count-high.zip incons-file-count-high.zip
+file incons-file-count-low.zzip incons-file-count-low.zip incons-file-count-low.zip
+file incons-file-count-overflow.zzip incons-file-count-overflow.zip incons-file-count-overflow.zip
+args incons-file-count-high.zzip incons-file-count-low.zzip incons-file-count-overflow.zzip
+return 1
+stdout opening 'incons-file-count-high.zzip' returned error 21
+stdout opening 'incons-file-count-low.zzip' succeeded, 2 entries
+stdout opening 'incons-file-count-overflow.zzip' returned error 14
+stderr 2 errors
diff --git a/regress/open_incons.test b/regress/open_incons.test
index 15c9b24..6aecb19 100644
--- a/regress/open_incons.test
+++ b/regress/open_incons.test
@@ -27,6 +27,7 @@ file incons-ef-local-size.zzip incons-ef-local-size.zip incons-ef-local-size.zip
 file incons-eocd-magic-bad.zzip incons-eocd-magic-bad.zip incons-eocd-magic-bad.zip
 file incons-file-count-high.zzip incons-file-count-high.zip incons-file-count-high.zip
 file incons-file-count-low.zzip incons-file-count-low.zip incons-file-count-low.zip
+file incons-file-count-overflow.zzip incons-file-count-overflow.zip incons-file-count-overflow.zip
 file incons-local-compression-method.zzip incons-local-compression-method.zip incons-local-compression-method.zip
 file incons-local-compsize-larger.zzip incons-local-compsize-larger.zip incons-local-compsize-larger.zip
 file incons-local-compsize-smaller.zzip incons-local-compsize-smaller.zip incons-local-compsize-smaller.zip
@@ -37,7 +38,7 @@ file incons-local-filename-short.zzip incons-local-filename-short.zip incons-loc
 file incons-local-filename.zzip incons-local-filename.zip incons-local-filename.zip
 file incons-local-magic-bad.zzip incons-local-magic-bad.zip incons-local-magic-bad.zip
 file incons-local-size-larger.zzip incons-local-size-larger.zip incons-local-size-larger.zip
-args -c incons-archive-comment-longer.zzip incons-archive-comment-shorter.zzip incons-cdoffset.zzip incons-central-compression-method.zzip incons-central-compsize-larger-toolarge.zzip incons-central-compsize-larger.zzip incons-central-compsize-smaller.zzip incons-central-crc.zzip incons-central-date.zzip incons-central-file-comment-longer.zzip incons-central-file-comment-shorter.zzip incons-central-magic-bad.zzip incons-central-magic-bad2.zzip incons-central-size-larger.zzip incons-data.zzip incons-ef-central-size-wrong.zzip incons-ef-local-id-size.zzip incons-ef-local-id.zzip incons-ef-local-incomplete1.zzip incons-ef-local-incomplete2.zzip incons-ef-local-incomplete3.zzip incons-ef-local-incomplete4.zzip incons-ef-local-size.zzip incons-eocd-magic-bad.zzip incons-file-count-high.zzip incons-file-count-low.zzip incons-local-compression-method.zzip incons-local-compsize-larger.zzip incons-local-compsize-smaller.zzip incons-local-crc.zzip incons-local-filename-long.zzip incons-local-filename-missing.zzip incons-local-filename-short.zzip incons-local-filename.zzip incons-local-magic-bad.zzip incons-local-size-larger.zzip
+args -c incons-archive-comment-longer.zzip incons-archive-comment-shorter.zzip incons-cdoffset.zzip incons-central-compression-method.zzip incons-central-compsize-larger-toolarge.zzip incons-central-compsize-larger.zzip incons-central-compsize-smaller.zzip incons-central-crc.zzip incons-central-date.zzip incons-central-file-comment-longer.zzip incons-central-file-comment-shorter.zzip incons-central-magic-bad.zzip incons-central-magic-bad2.zzip incons-central-size-larger.zzip incons-data.zzip incons-ef-central-size-wrong.zzip incons-ef-local-id-size.zzip incons-ef-local-id.zzip incons-ef-local-incomplete1.zzip incons-ef-local-incomplete2.zzip incons-ef-local-incomplete3.zzip incons-ef-local-incomplete4.zzip incons-ef-local-size.zzip incons-eocd-magic-bad.zzip incons-file-count-high.zzip incons-file-count-low.zzip incons-file-count-overflow.zzip incons-local-compression-method.zzip incons-local-compsize-larger.zzip incons-local-compsize-smaller.zzip incons-local-crc.zzip incons-local-filename-long.zzip incons-local-filename-missing.zzip incons-local-filename-short.zzip incons-local-filename.zzip incons-local-magic-bad.zzip incons-local-size-larger.zzip
 return 1
 stdout opening 'incons-archive-comment-longer.zzip' returned error 21
 stdout opening 'incons-archive-comment-shorter.zzip' returned error 21
@@ -68,6 +69,7 @@ stdout opening 'incons-ef-local-size.zzip' returned error 21
 stdout opening 'incons-eocd-magic-bad.zzip' returned error 19
 stdout opening 'incons-file-count-high.zzip' returned error 21
 stdout opening 'incons-file-count-low.zzip' returned error 21
+stdout opening 'incons-file-count-overflow.zzip' returned error 14
 stdout opening 'incons-local-compression-method.zzip' returned error 21
 stdout opening 'incons-local-compsize-larger.zzip' returned error 21
 stdout opening 'incons-local-compsize-smaller.zzip' returned error 21
@@ -78,4 +80,4 @@ stdout opening 'incons-local-filename-short.zzip' returned error 21
 stdout opening 'incons-local-filename.zzip' returned error 21
 stdout opening 'incons-local-magic-bad.zzip' returned error 19
 stdout opening 'incons-local-size-larger.zzip' returned error 21
-stderr 33 errors
+stderr 34 errors
diff --git a/src/zipcmp.c b/src/zipcmp.c
index 4c4cb0d..c29582e 100644
--- a/src/zipcmp.c
+++ b/src/zipcmp.c
@@ -403,7 +403,7 @@ list_zip(const char *name, struct archive *a)
     if (a->nentry == 0)
 	a->entry = NULL;
     else {
-	if ((a->entry=(struct entry *)malloc(sizeof(a->entry[0]) * a->nentry)) == NULL) {
+	if ((a->nentry > SIZE_MAX/sizeof(a->entry[0])) || (a->entry=(struct entry *)malloc(sizeof(a->entry[0]) * a->nentry)) == NULL) {
 	    fprintf(stderr, "%s: malloc failure\n", prg);
 	    exit(1);
 	}
