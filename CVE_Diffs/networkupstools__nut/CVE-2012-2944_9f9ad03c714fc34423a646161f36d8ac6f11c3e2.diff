networkupstools__nut
commit 9f9ad03c714fc34423a646161f36d8ac6f11c3e2
Author:     Frederic Bohe <fbohe-guest@alioth.debian.org>
AuthorDate: Mon Sep 17 09:28:37 2012 +0000
Commit:     Frédéric BOHE <fredericbohe@eaton.com>
CommitDate: Wed Nov 13 11:11:22 2013 +0100

    Fix upssched regression due to CVE-2012-2944
    
    Fossil-ID: SVN r3727

diff --git a/clients/upssched.c b/clients/upssched.c
index a5b09fe3..bd347d22 100644
--- a/clients/upssched.c
+++ b/clients/upssched.c
@@ -795,7 +795,7 @@ static void start_daemon(HANDLE lockfd)
 	}
 	memset(&sinfo,0,sizeof(sinfo));
 	if(!CreateProcess(module, NULL, NULL,NULL,FALSE,0,NULL,NULL,&sinfo,&pinfo)) {
-		fatal_with_errno(EXIT_FAILURE, "Can'tcreate child process");
+		fatal_with_errno(EXIT_FAILURE, "Can't create child process");
 	}
 	pipefd = open_sock();
 
@@ -1110,8 +1110,8 @@ static void sendcmd(const char *cmd, const char *arg1, const char *arg2)
 		}
 
 #else
-		ret = WriteFile(pipefd,buf,strlen(buf),&bytesWritten,NULL);
-		if (ret == 0 || bytesWritten != strlen(buf)) {
+		ret = WriteFile(pipefd,enc,strlen(enc),&bytesWritten,NULL);
+		if (ret == 0 || bytesWritten != strlen(enc)) {
 			upslogx(LOG_ERR, "write failed, trying again");
 			CloseHandle(pipefd);
 			continue;
@@ -1136,6 +1136,7 @@ static void sendcmd(const char *cmd, const char *arg1, const char *arg2)
 
 		if (ret == WAIT_TIMEOUT || ret == WAIT_FAILED) {
 			upslogx(LOG_ERR, "read confirmation failed, trying again");
+			CloseHandle(pipefd);
 			continue;
 		}
 #endif
