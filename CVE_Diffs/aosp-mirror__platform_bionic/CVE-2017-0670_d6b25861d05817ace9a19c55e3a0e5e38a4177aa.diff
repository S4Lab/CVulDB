aosp-mirror__platform_bionic
commit d6b25861d05817ace9a19c55e3a0e5e38a4177aa
Author:     dimitry <dimitry@google.com>
AuthorDate: Mon Jul 17 11:24:54 2017 +0200
Commit:     dimitry <dimitry@google.com>
CommitDate: Mon Jul 17 11:33:51 2017 +0200

    loader: fix dlopen performance regression caused by fix for CVE-2017-0670
    
    Fix for CVE-2017-0670 in lmp-mr1 branch caused significant slowdowns
    on dlopens for libraries with large dependency trees. Modified
    is_recursive check led to unecessary check of already linked libraries.
    
    This change excludes already loaded and linked libraries from this check
    since it is redundant - linker already did it while loading these
    libraries.
    
    Bug: 63658102
    Test: run bionic-unit-tests --gtest_filter=dl*:Dl*
    Test: manually check load times for libraries with large dependency trees.
    Change-Id: Idf25376f4889c4430442ff16a16e1d79ccb77b27

diff --git a/linker/linker.cpp b/linker/linker.cpp
index d200c22fe..5939a4119 100644
--- a/linker/linker.cpp
+++ b/linker/linker.cpp
@@ -883,6 +883,11 @@ static bool is_recursive(soinfo* si, soinfo* parent) {
     return false;
   }
 
+  // Skip linked libraries - we have already checked them before.
+  if ((si->flags & FLAG_LINKED) != 0) {
+    return false;
+  }
+
   if (si == parent) {
     return true;
   }
