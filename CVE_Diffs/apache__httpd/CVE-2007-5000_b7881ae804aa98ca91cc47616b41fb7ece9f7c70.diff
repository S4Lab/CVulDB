apache__httpd
commit b7881ae804aa98ca91cc47616b41fb7ece9f7c70
Author:     Joe Orton <jorton@apache.org>
AuthorDate: Tue Dec 11 16:02:23 2007 +0000
Commit:     Joe Orton <jorton@apache.org>
CommitDate: Tue Dec 11 16:02:23 2007 +0000

    Fix CVE-2007-5000:
    
    * modules/mappers/mod_imagemap.c (menu_header): Fix
      cross-site-scripting issue by escaping the URI, and ensure that a
      charset parameter is sent in the content-type to prevent
      autodetection by broken browsers.
    
    Reported by: JPCERT
    
    
    git-svn-id: https://svn.apache.org/repos/asf/httpd/httpd/trunk@603282 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/modules/mappers/mod_imagemap.c b/modules/mappers/mod_imagemap.c
index f4dce5ff20..f6741d35b4 100644
--- a/modules/mappers/mod_imagemap.c
+++ b/modules/mappers/mod_imagemap.c
@@ -479,13 +479,16 @@ static int imap_reply(request_rec *r, char *redirect)
 
 static void menu_header(request_rec *r, char *menu)
 {
-    ap_set_content_type(r, "text/html");
+    ap_set_content_type(r, "text/html; charset=ISO-8859-1");
 
-    ap_rvputs(r, DOCTYPE_HTML_3_2, "<html><head>\n<title>Menu for ", r->uri,
-           "</title>\n</head><body>\n", NULL);
+    ap_rvputs(r, DOCTYPE_HTML_3_2, "<html><head>\n<title>Menu for ", 
+              ap_escape_html(r->pool, r->uri),
+              "</title>\n</head><body>\n", NULL);
 
     if (!strcasecmp(menu, "formatted")) {
-        ap_rvputs(r, "<h1>Menu for ", r->uri, "</h1>\n<hr />\n\n", NULL);
+        ap_rvputs(r, "<h1>Menu for ", 
+                  ap_escape_html(r->pool, r->uri),
+                  "</h1>\n<hr />\n\n", NULL);
     }
 
     return;
