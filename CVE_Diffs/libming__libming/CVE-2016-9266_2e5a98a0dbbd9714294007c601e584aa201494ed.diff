libming__libming
commit 2e5a98a0dbbd9714294007c601e584aa201494ed
Author:     Balint Reczey <balint@balintreczey.hu>
AuthorDate: Sat Dec 31 01:52:30 2016 +0100
Commit:     Sandro Santilli <strk@kbt.io>
CommitDate: Mon Jan 30 09:54:52 2017 +0100

    Fix using EOF marker -1 value as a valid flag byte
    
    Also known as CVE-2016-9266
    
    Fixes: #53

diff --git a/util/listmp3.c b/util/listmp3.c
index 80947d93..ac6c773c 100644
--- a/util/listmp3.c
+++ b/util/listmp3.c
@@ -74,6 +74,8 @@ void printMP3Headers(FILE *f)
 
   for(;;)
   {
+    int flags_char;
+    int i;
     /* get 4-byte header, bigendian */
     if((flags = fgetc(f)) == EOF)
       break;
@@ -92,9 +94,17 @@ void printMP3Headers(FILE *f)
       break;
 
     flags <<= 24;
-    flags += fgetc(f) << 16;
-    flags += fgetc(f) << 8;
-    flags += fgetc(f);
+    for (i = 2; i >= 0; --i)
+    {
+      if ((flags_char = fgetc(f)) == EOF)
+      {
+        error("truncated file");
+      }
+      else
+      {
+        flags += flags_char << (i * 8);
+      }
+    }
 
     if((flags & MP3_FRAME_SYNC) != MP3_FRAME_SYNC)
       break;
