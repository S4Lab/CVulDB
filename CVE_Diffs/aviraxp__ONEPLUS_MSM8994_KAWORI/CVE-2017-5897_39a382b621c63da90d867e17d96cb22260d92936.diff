aviraxp__ONEPLUS_MSM8994_KAWORI
commit 39a382b621c63da90d867e17d96cb22260d92936
Author:     Eric Dumazet <edumazet@google.com>
AuthorDate: Sat Feb 4 23:18:55 2017 -0800
Commit:     Wang Han <416810799@qq.com>
CommitDate: Sun May 14 00:07:07 2017 -0700

    ip6_gre: fix ip6gre_err() invalid reads(CVE-2017-5897)
    
    Andrey Konovalov reported out of bound accesses in ip6gre_err()
    
    If GRE flags contains GRE_KEY, the following expression
    *(((__be32 *)p) + (grehlen / 4) - 1)
    
    accesses data ~40 bytes after the expected point, since
    grehlen includes the size of IPv6 headers.
    
    Let's use a "struct gre_base_hdr *greh" pointer to make this
    code more readable.
    
    p[1] becomes greh->protocol.
    grhlen is the GRE header length.
    
    Fixes: c12b395a4664 ("gre: Support GRE over IPv6")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    
    # Conflicts:
    #       net/ipv6/ip6_gre.c

diff --git a/net/ipv6/ip6_gre.c b/net/ipv6/ip6_gre.c
index 6391c7d6213..511c0b97b31 100644
--- a/net/ipv6/ip6_gre.c
+++ b/net/ipv6/ip6_gre.c
@@ -395,7 +395,7 @@ static void ip6gre_err(struct sk_buff *skb, struct inet6_skb_parm *opt,
 
 	t = ip6gre_tunnel_lookup(skb->dev, &ipv6h->daddr, &ipv6h->saddr,
 				 key, greh->protocol);
-	if (t == NULL)
+	if (!t)
 		return;
 
 	switch (type) {
