aviraxp__ONEPLUS_MSM8994_KAWORI
commit 8b4225b36033c3a04b49a89c485c2547c7028c26
Author:     Roberto Pereira <rpere@google.com>
AuthorDate: Tue Oct 10 17:14:48 2017 -0700
Commit:     BobZhome <BobZhome@cheerful.com>
CommitDate: Mon Apr 2 17:09:17 2018 -0400

    ANDROID: scsi: Add segment checking in sg_read CVE-2017-13168
    
    Bug: 65023233
    Signed-off-by: Roberto Pereira <rpere@google.com>
    Change-Id: Ib45f402cf304f9b8bf18884738f92b9c3db55573

diff --git a/drivers/scsi/sg.c b/drivers/scsi/sg.c
index 1b0a585303b..d77f6be91ec 100644
--- a/drivers/scsi/sg.c
+++ b/drivers/scsi/sg.c
@@ -400,6 +400,9 @@ sg_read(struct file *filp, char __user *buf, size_t count, loff_t * ppos)
 	struct sg_header *old_hdr = NULL;
 	int retval = 0;
 
+	if (unlikely(segment_eq(get_fs(), KERNEL_DS)))
+		return -EINVAL;
+
 	if ((!(sfp = (Sg_fd *) filp->private_data)) || (!(sdp = sfp->parentdp)))
 		return -ENXIO;
 	SCSI_LOG_TIMEOUT(3, printk("sg_read: %s, count=%d\n",
