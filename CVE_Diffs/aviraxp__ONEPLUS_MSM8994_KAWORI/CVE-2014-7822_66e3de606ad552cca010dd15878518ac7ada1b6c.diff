aviraxp__ONEPLUS_MSM8994_KAWORI
commit 66e3de606ad552cca010dd15878518ac7ada1b6c
Author:     Ben Hutchings <ben@decadent.org.uk>
AuthorDate: Thu Jan 29 02:50:33 2015 +0000
Commit:     Wang Han <416810799@qq.com>
CommitDate: Wed May 24 04:12:19 2017 -0700

    splice: Apply generic position and size checks to each write
    
    We need to check the position and size of file writes against various
    limits, using generic_write_check().  This was not being done for
    the splice write path.  It was fixed upstream by commit 8d0207652cbe
    ("->splice_write() via ->write_iter()") but we can't apply that.
    
    CVE-2014-7822
    
    Change-Id: If7db904333d0dfb576986762e60f1437994a6a1c
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.c
index d0e8c0b1767..c012f684712 100644
--- a/fs/ocfs2/file.c
+++ b/fs/ocfs2/file.c
@@ -2473,6 +2473,12 @@ static ssize_t ocfs2_file_splice_write(struct pipe_inode_info *pipe,
 			out->f_path.dentry->d_name.len,
 			out->f_path.dentry->d_name.name, len);
 
+	ret = generic_write_checks(out, ppos, &len, 0);
+	if (ret)
+		return ret;
+	sd.total_len = len;
+	sd.pos = *ppos;
+
 	pipe_lock(pipe);
 
 	splice_from_pipe_begin(&sd);
