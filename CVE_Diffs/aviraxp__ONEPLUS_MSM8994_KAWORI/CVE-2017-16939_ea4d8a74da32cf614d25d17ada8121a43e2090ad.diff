aviraxp__ONEPLUS_MSM8994_KAWORI
commit ea4d8a74da32cf614d25d17ada8121a43e2090ad
Author:     Ben Hutchings <ben@decadent.org.uk>
AuthorDate: Sat Dec 9 19:24:58 2017 +0000
Commit:     OzzysCmAcc <oskarkratochvil86@yahoo.com>
CommitDate: Mon Mar 26 20:53:33 2018 +0200

    ipsec: Fix aborted xfrm policy dump crash
    
    commit 1137b5e2529a8f5ca8ee709288ecba3e68044df2 upstream.
    
    This is a fix for CVE-2017-16939 suitable for older stable branches.
    The upstream fix is commit 1137b5e2529a8f5ca8ee709288ecba3e68044df2,
    from which the following explanation is taken:
    
        An independent security researcher, Mohamed Ghannam, has reported
        this vulnerability to Beyond Security's SecuriTeam Secure Disclosure
        program.
    
        The xfrm_dump_policy_done function expects xfrm_dump_policy to
        have been called at least once or it will crash.  This can be
        triggered if a dump fails because the target socket's receive
        buffer is full.
    
    It was not possible to define a 'start' callback for netlink dumps
    until Linux 4.5, so instead add a check for the initialisation flag in
    the 'done' callback.
    
    Change-Id: Id8a129889b11800178c37374ff9fee5af68ccff9
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

diff --git a/net/xfrm/xfrm_user.c b/net/xfrm/xfrm_user.c
index 54f1c94b31f..a6c3be2c56f 100644
--- a/net/xfrm/xfrm_user.c
+++ b/net/xfrm/xfrm_user.c
@@ -1562,7 +1562,8 @@ static int xfrm_dump_policy_done(struct netlink_callback *cb)
 {
 	struct xfrm_policy_walk *walk = (struct xfrm_policy_walk *)cb->args;
 
-	xfrm_policy_walk_done(walk);
+	if (cb->args[0])
+		xfrm_policy_walk_done(walk);
 	return 0;
 }
 
