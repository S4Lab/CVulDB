aviraxp__ONEPLUS_MSM8994_KAWORI
commit 2664158880741b1727f096d78a04c432fab84fae
Author:     BobZhome <BobZhome@cheerful.com>
AuthorDate: Sun Apr 1 10:38:21 2018 -0400
Commit:     BobZhome <BobZhome@cheerful.com>
CommitDate: Sun Apr 1 10:38:21 2018 -0400

    [PATCH] floppy: Do not copy a kernel pointer to user memory in FDGETPRM ioctl CVE-2018-7755
    
    FromBrian Belleville
    Date Wed, 7 Mar 2018 16:02:45 -0800
    
    The final field of a floppy_struct is the field name, which is a
    pointer to a string in kernel memory. The kernel pointer should not be
    copied to user memory. The FDGETPRM ioctl copies a floppy_struct to
    user memory, including the name field. This pointer cannot be used
    by the user, and it will leak a kernel address to user-space, which
    will reveal the location of kernel code and data and undermine KASLR
    protection. Instead, copy the floppy_struct except for the name
    field.
    
    Signed-off-by: Brian Belleville <bbellevi@uci.edu>

diff --git a/drivers/block/floppy.c b/drivers/block/floppy.c
index eb3575b3fbf..08a8f1217c2 100644
--- a/drivers/block/floppy.c
+++ b/drivers/block/floppy.c
@@ -3445,6 +3445,7 @@ static int fd_locked_ioctl(struct block_device *bdev, fmode_t mode, unsigned int
 					  (struct floppy_struct **)&outparam);
 		if (ret)
 			return ret;
+		size = offsetof(struct floppy_struct, name);
 		break;
 	case FDMSGON:
 		UDP->flags |= FTD_MSG;
