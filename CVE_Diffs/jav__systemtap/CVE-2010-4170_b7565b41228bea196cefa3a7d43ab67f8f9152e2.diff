jav__systemtap
commit b7565b41228bea196cefa3a7d43ab67f8f9152e2
Author:     Frank Ch. Eigler <fche@elastic.org>
AuthorDate: Wed Nov 17 09:57:23 2010 -0500
Commit:     Frank Ch. Eigler <fche@elastic.org>
CommitDate: Wed Nov 17 09:57:23 2010 -0500

    CVE-2010-4170, CVE-2010-4171: staprun module loading/unloading security fixes
    
    We would like to thank Tavis Ormandy for reporting this issue.
    
    * runtime/staprun/staprun.c (enable_uprobes): Don't run /sbin/modprobe
      directly, since it takes more inputs than we have tried to sanitize.
      (remove_module): Call init_ctl_channel on putative stap module name,
      to check that it's our own stap module.
      (init_staprun): Do remove/retry via remove_module rather than
      underchecked delete_module(2).
    * runtime/staprun/ctl.c (init_ctl_channel): Check ownership of
      .ctl files, to preclude manipulation of some other stapusr member's modules.
    * runtime/staprun/Makefile.am, systemtap.spec: Install staprun as
      mode 04110, group stapusr.
    * README.security, runtime/staprun/staprun.8: Note new stapdev/stapusr
      joint requirements.

diff --git a/README.security b/README.security
index 124ad8de..998bf3d0 100644
--- a/README.security
+++ b/README.security
@@ -15,7 +15,7 @@ following:
 
  * the root user;
 
- * a member of the 'stapdev' group; or
+ * a member of both 'stapdev' and 'stapusr' groups; or
 
  * a member of the 'stapusr' group.  Members of the stapusr group can
    only use modules located in the /lib/modules/VERSION/systemtap
@@ -23,8 +23,8 @@ following:
    directory must be owned by root and not be world writable.
 
 So, there are two classes of users: systemtap developers (the root user
-and members of the stapdev group) and systemtap users (members of the
-stapusr group).  Systemtap developers can compile and run any
+and members of the stapdev/stapusr groups) and systemtap users (members of
+only the stapusr group).  Systemtap developers can compile and run any
 systemtap script.  Systemtap users can only run "approved"
 pre-compiled modules located in /lib/modules/VERSION/systemtap.
 
diff --git a/runtime/staprun/Makefile.am b/runtime/staprun/Makefile.am
index d89252da..95952725 100644
--- a/runtime/staprun/Makefile.am
+++ b/runtime/staprun/Makefile.am
@@ -36,4 +36,7 @@ stap_merge_LDADD =
 # Why the "id -u" condition?  This way, an unprivileged user can run
 # make install, and have "sudo stap ...." or "sudo staprun ...." work later.
 install-exec-hook:
-	[ `id -u` -ne 0 ] || chmod 04111 "$(DESTDIR)$(bindir)/staprun"
+	if [ `id -u` -eq 0 ]; then \
+		getent group stapusr >/dev/null && chgrp stapusr "$(DESTDIR)$(bindir)/staprun"; \
+		chmod 04110 "$(DESTDIR)$(bindir)/staprun"; \
+	fi
diff --git a/runtime/staprun/Makefile.in b/runtime/staprun/Makefile.in
index 5a814982..3ba5cb59 100644
--- a/runtime/staprun/Makefile.in
+++ b/runtime/staprun/Makefile.in
@@ -219,9 +219,8 @@ top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 AM_CPPFLAGS = -D_GNU_SOURCE -I$(srcdir)/../../includes \
-	-I$(builddir)/../../includes/sys \
-	-DBINDIR='"$(bindir)"' -DSYSCONFDIR='"$(sysconfdir)"' \
-	-DPKGDATADIR='"${pkgdatadir}"' \
+	-I$(builddir)/../../includes/sys -DBINDIR='"$(bindir)"' \
+	-DSYSCONFDIR='"$(sysconfdir)"' -DPKGDATADIR='"${pkgdatadir}"' \
 	-DPKGLIBDIR='"$(pkglibexecdir)"'
 AM_CFLAGS = -Wall -Werror -Wunused -W -Wformat=2 \
 	-Wno-format-nonliteral @PIECFLAGS@
@@ -746,7 +745,10 @@ uninstall-man: uninstall-man8
 # Why the "id -u" condition?  This way, an unprivileged user can run
 # make install, and have "sudo stap ...." or "sudo staprun ...." work later.
 install-exec-hook:
-	[ `id -u` -ne 0 ] || chmod 04111 "$(DESTDIR)$(bindir)/staprun"
+	if [ `id -u` -eq 0 ]; then \
+		getent group stapusr >/dev/null && chgrp stapusr "$(DESTDIR)$(bindir)/staprun"; \
+		chmod 04110 "$(DESTDIR)$(bindir)/staprun"; \
+	fi
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
 # Otherwise a system limit (for SysV at least) may be exceeded.
diff --git a/runtime/staprun/ctl.c b/runtime/staprun/ctl.c
index 335006ec..8baf0dbc 100644
--- a/runtime/staprun/ctl.c
+++ b/runtime/staprun/ctl.c
@@ -27,6 +27,9 @@ int init_ctl_channel(const char *name, int verb)
 			return -2;
 	}
 
+	if (access(buf, R_OK|W_OK) != 0)
+		return -5;
+
 	control_channel = open(buf, O_RDWR);
 	dbug(2, "Opened %s (%d)\n", buf, control_channel);
 	if (control_channel < 0) {
diff --git a/runtime/staprun/staprun.8 b/runtime/staprun/staprun.8
index f4a5a083..7523031f 100644
--- a/runtime/staprun/staprun.8
+++ b/runtime/staprun/staprun.8
@@ -205,14 +205,14 @@ structures and potentially private user information.  See the
 .IR stap (1)
 manual page for additional information on safety and security.
 .PP
-To increase system security, only the root user and members of the
-.I stapdev
-group can use
+To increase system security, only the root user and members of both
+.I stapdev " and " staprun
+groups can use
 .I staprun
 to insert systemtap modules (or attach to existing ones).
 Members of the
 .I stapusr
-group can use
+group only can use
 .I staprun
 to insert or remove systemtap modules (or attach to existing systemtap modules)
 under the following conditions:
diff --git a/runtime/staprun/staprun.c b/runtime/staprun/staprun.c
index d72e3358..ca245e35 100644
--- a/runtime/staprun/staprun.c
+++ b/runtime/staprun/staprun.c
@@ -119,19 +119,7 @@ static int enable_uprobes(void)
 	if (run_as(0, uid, gid, argv[0], argv) == 0)
 		return 0;
 
-	/*
-	 * TODO: If user can't setresuid to root here, staprun will exit.
-	 * Is there a situation where that would fail but the subsequent
-	 * attempt to insert_module() would succeed?
-	 */
-	dbug(2, "Inserting uprobes module from /lib/modules, if any.\n");
-	i = 0;
-	argv[i++] = "/sbin/modprobe";
-	argv[i++] = "-q";
-	argv[i++] = "uprobes";
-	argv[i] = NULL;
-	if (run_as(0, 0, 0, argv[0], argv) == 0)
-		return 0;
+        /* NB: don't use /sbin/modprobe, without more env. sanitation. */
 
 	/* This module may be signed, so use insert_module to load it.  */
 	snprintf (runtimeko, sizeof(runtimeko), "%s/uprobes/uprobes.ko",
@@ -190,9 +178,16 @@ static int remove_module(const char *name, int verb)
 		return 0;
 	}
 
-        /* We could call init_ctl_channel / close_ctl_channel here, as a heuristic
-           to determine whether the module is being used by some other stapio process.
-           However, delete_module() does basically the same thing. */
+        /* We call init_ctl_channel/close_ctl_channel to check whether
+           the module is a systemtap-built one (having the right files),
+           and that it's already unattached (because otherwise it'd EBUSY
+           the opens. */
+        ret = init_ctl_channel (name, 0);
+        if (ret < 0) {
+                err("Error, '%s' is not a zombie systemtap module.\n", name);
+                return ret;
+        }
+        close_ctl_channel ();
 
 	dbug(2, "removing module %s\n", name);
 	STAP_PROBE1(staprun, remove__module, name);
@@ -227,7 +222,7 @@ int init_staprun(void)
                      without first removing the kernel module.  This would block
                      a subsequent rerun attempt.  So here we gingerly try to
                      unload it first. */
-		  int ret = delete_module (modname, O_NONBLOCK);
+                  int ret = remove_module (modname, 0);
 		  err("Retrying, after attempted removal of module %s (rc %d)\n", modname, ret);
 		  /* Then we try an insert a second time.  */
 		  if (insert_stap_module() < 0)
diff --git a/systemtap.spec b/systemtap.spec
index a9892d35..22cc246e 100644
--- a/systemtap.spec
+++ b/systemtap.spec
@@ -266,10 +266,10 @@ mv $RPM_BUILD_ROOT%{_datadir}/doc/systemtap/examples examples
 # Fix paths in the example & testsuite scripts
 find examples testsuite -type f -name '*.stp' -print0 | xargs -0 sed -i -r -e '1s@^#!.+stap@#!%{_bindir}/stap@'
 
-# Because "make install" may install staprun with mode 04111, the
+# Because "make install" may install staprun with whatever mode, the
 # post-processing programs rpmbuild runs won't be able to read it.
 # So, we change permissions so that they can read it.  We'll set the
-# permissions back to 04111 in the %files section below.
+# permissions back to 04110 in the %files section below.
 chmod 755 $RPM_BUILD_ROOT%{_bindir}/staprun
 
 #install the useful stap-prep script
@@ -428,7 +428,7 @@ exit 0
 
 %files runtime
 %defattr(-,root,root)
-%attr(4111,root,root) %{_bindir}/staprun
+%attr(4110,root,stapusr) %{_bindir}/staprun
 %{_bindir}/stap-merge
 %{_bindir}/stap-report
 %{_bindir}/stap-authorize-signing-cert
