k-takata__Onigmo
commit ee5f2e2e89362cce91f7ab337683a0d658c644d7
Author:     K.Takata <kentkt@csc.jp>
AuthorDate: Wed Jul 12 22:48:31 2017 +0900
Commit:     K.Takata <kentkt@csc.jp>
CommitDate: Wed Jul 12 22:48:31 2017 +0900

    Fix access to invalid address by reg->dmax value
    
    CVE-2017-9229
    https://github.com/kkos/oniguruma/issues/59

diff --git a/regexec.c b/regexec.c
index ef28af2..05d6924 100644
--- a/regexec.c
+++ b/regexec.c
@@ -3997,18 +3997,25 @@ forward_search_range(regex_t* reg, const UChar* str, const UChar* end, UChar* s,
     }
     else {
       if (reg->dmax != ONIG_INFINITE_DISTANCE) {
-	*low = p - reg->dmax;
-	if (*low > s) {
-	  *low = onigenc_get_right_adjust_char_head_with_prev(reg->enc, s,
-							      *low, end, (const UChar** )low_prev);
-	  if (low_prev && IS_NULL(*low_prev))
-	    *low_prev = onigenc_get_prev_char_head(reg->enc,
-						   (pprev ? pprev : s), *low, end);
+	if (p - str < reg->dmax) {
+	  *low = (UChar* )str;
+	  if (low_prev)
+	    *low_prev = onigenc_get_prev_char_head(reg->enc, str, *low, end);
 	}
 	else {
-	  if (low_prev)
-	    *low_prev = onigenc_get_prev_char_head(reg->enc,
-					       (pprev ? pprev : str), *low, end);
+	  *low = p - reg->dmax;
+	  if (*low > s) {
+	    *low = onigenc_get_right_adjust_char_head_with_prev(reg->enc, s,
+								*low, end, (const UChar** )low_prev);
+	    if (low_prev && IS_NULL(*low_prev))
+	      *low_prev = onigenc_get_prev_char_head(reg->enc,
+						     (pprev ? pprev : s), *low, end);
+	  }
+	  else {
+	    if (low_prev)
+	      *low_prev = onigenc_get_prev_char_head(reg->enc,
+						 (pprev ? pprev : str), *low, end);
+	  }
 	}
       }
     }
