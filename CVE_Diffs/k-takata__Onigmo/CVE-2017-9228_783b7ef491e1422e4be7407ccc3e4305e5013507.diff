k-takata__Onigmo
commit 783b7ef491e1422e4be7407ccc3e4305e5013507
Author:     K.Takata <kentkt@csc.jp>
AuthorDate: Wed Jul 12 22:48:37 2017 +0900
Commit:     K.Takata <kentkt@csc.jp>
CommitDate: Wed Jul 12 22:48:37 2017 +0900

    Fix invalid state(CCS_VALUE) in parse_char_class()
    
    CVE-2017-9228
    https://github.com/kkos/oniguruma/issues/60

diff --git a/regparse.c b/regparse.c
index 653a52f..89f8c79 100644
--- a/regparse.c
+++ b/regparse.c
@@ -4767,6 +4767,12 @@ parse_char_class(Node** np, Node** asc_np, OnigToken* tok, UChar** src, UChar* e
 	  CC_ESC_WARN(env, (UChar* )"-");
 	  goto range_end_val;
 	}
+
+	if (val_type == CCV_CLASS) {
+	  r = ONIGERR_UNMATCHED_RANGE_SPECIFIER_IN_CHAR_CLASS;
+	  goto err;
+	}
+
 	state = CCS_RANGE;
       }
       else if (state == CCS_START) {
