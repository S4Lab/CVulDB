FFmpeg__FFmpeg
commit 6ae95a0b93e8df15fe5f364535a7214be0817736
Author:     Alex Converse <alex.converse@gmail.com>
AuthorDate: Wed Jan 25 13:39:24 2012 -0800
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Sun Apr 1 18:33:29 2012 +0200

    mjpegbdec: Fix overflow in SOS.
    
    Based in part by a fix from Michael Niedermayer <michaelni@gmx.at>
    
    Fixes CVE-2011-3947
    
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    (cherry picked from commit b57d262412204e54a7ef8fa1b23ff4dcede622e5)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>
    (cherry picked from commit 083a8a00373b12dc06b8ae4c49eec61fb5e55f4b)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/mjpegbdec.c b/libavcodec/mjpegbdec.c
index 454ba6ffc9..6455b19846 100644
--- a/libavcodec/mjpegbdec.c
+++ b/libavcodec/mjpegbdec.c
@@ -59,6 +59,9 @@ read_header:
     s->restart_count = 0;
     s->mjpb_skiptosod = 0;
 
+    if (buf_end - buf_ptr >= 1 << 28)
+        return AVERROR_INVALIDDATA;
+
     init_get_bits(&hgb, buf_ptr, /*buf_size*/(buf_end - buf_ptr)*8);
 
     skip_bits(&hgb, 32); /* reserved zeros */
@@ -109,8 +112,8 @@ read_header:
     av_log(avctx, AV_LOG_DEBUG, "sod offs: 0x%x\n", sod_offs);
     if (sos_offs)
     {
-//        init_get_bits(&s->gb, buf+sos_offs, (buf_end - (buf+sos_offs))*8);
-        init_get_bits(&s->gb, buf_ptr+sos_offs, field_size*8);
+        init_get_bits(&s->gb, buf_ptr + sos_offs,
+                      8 * FFMIN(field_size, buf_end - buf_ptr - sos_offs));
         s->mjpb_skiptosod = (sod_offs - sos_offs - show_bits(&s->gb, 16));
         s->start_code = SOS;
         ff_mjpeg_decode_sos(s, NULL, NULL);
