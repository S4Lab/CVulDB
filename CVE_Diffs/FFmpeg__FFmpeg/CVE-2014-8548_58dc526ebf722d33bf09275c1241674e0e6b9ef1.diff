FFmpeg__FFmpeg
commit 58dc526ebf722d33bf09275c1241674e0e6b9ef1
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Fri Oct 3 22:50:45 2014 +0200
Commit:     Anton Khirnov <anton@khirnov.net>
CommitDate: Sat Dec 20 10:51:41 2014 +0100

    smc: fix the bounds check
    
    Fixes invalid writes when there are more blocks in a run than total
    remaining blocks.
    
    CC: libav-stable@libav.org
    Bug-ID: CVE-2014-8548
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit d423dd72be451462c6fb1cbbe313bed0194001ab)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>

diff --git a/libavcodec/smc.c b/libavcodec/smc.c
index 46903ab2af..c6541da843 100644
--- a/libavcodec/smc.c
+++ b/libavcodec/smc.c
@@ -70,7 +70,7 @@ typedef struct SmcContext {
         row_ptr += stride * 4; \
     } \
     total_blocks--; \
-    if (total_blocks < 0) \
+    if (total_blocks < !!n_blocks) \
     { \
         av_log(s->avctx, AV_LOG_INFO, "warning: block counter just went negative (this should not happen)\n"); \
         return; \
