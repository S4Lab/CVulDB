FFmpeg__FFmpeg
commit d04194db45711f82e3e87fab62c9224ac03998c3
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Fri Jan 25 06:11:59 2013 +0100
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Sat Feb 1 14:03:28 2014 -0500

    vqavideo: check chunk sizes before reading chunks
    
    Fixes out of array writes
    
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
    (cherry picked from commit ab6c9332bfa1e20127a16392a0b85a4aa4840889)
    
    Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
    (cherry picked from commit 13093f9767b922661132a3c1f4b5ba2c7338b660)
    
    CC: libav-stable@libav.org
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>
    (cherry picked from commit f7d18deb73d1dd1b27b2c7062c9a10d168a6c62a)
    
    Addresses: CVE-2013-0865
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>
    (cherry picked from commit ab434bf0d051008a329d49d0256faa5d64e2bf4d)
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/vqavideo.c b/libavcodec/vqavideo.c
index 110d8b17d5..7870f0e3c7 100644
--- a/libavcodec/vqavideo.c
+++ b/libavcodec/vqavideo.c
@@ -533,6 +533,12 @@ static int vqa_decode_chunk(VqaContext *s)
         bytestream2_seek(&s->gb, cbp0_chunk, SEEK_SET);
         chunk_size = bytestream2_get_be32(&s->gb);
 
+        if (chunk_size > MAX_CODEBOOK_SIZE - s->next_codebook_buffer_index) {
+            av_log(s->avctx, AV_LOG_ERROR, "cbp0 chunk too large (%u bytes)\n",
+                   chunk_size);
+            return AVERROR_INVALIDDATA;
+        }
+
         /* accumulate partial codebook */
         bytestream2_get_buffer(&s->gb, &s->next_codebook_buffer[s->next_codebook_buffer_index],
                                chunk_size);
@@ -556,6 +562,12 @@ static int vqa_decode_chunk(VqaContext *s)
         bytestream2_seek(&s->gb, cbpz_chunk, SEEK_SET);
         chunk_size = bytestream2_get_be32(&s->gb);
 
+        if (chunk_size > MAX_CODEBOOK_SIZE - s->next_codebook_buffer_index) {
+            av_log(s->avctx, AV_LOG_ERROR, "cbpz chunk too large (%u bytes)\n",
+                   chunk_size);
+            return AVERROR_INVALIDDATA;
+        }
+
         /* accumulate partial codebook */
         bytestream2_get_buffer(&s->gb, &s->next_codebook_buffer[s->next_codebook_buffer_index],
                                chunk_size);
