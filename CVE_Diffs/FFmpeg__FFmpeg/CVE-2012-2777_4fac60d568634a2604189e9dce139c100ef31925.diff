FFmpeg__FFmpeg
commit 4fac60d568634a2604189e9dce139c100ef31925
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Sat Mar 24 02:40:24 2012 +0100
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Sun Feb 10 18:01:15 2013 +0100

    cavsdec: check for changing w/h.
    
    Our decoder does not support changing w/h.
    
    Fixes CVE-2012-2777 and CVE-2012-2784.
    
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit c20a69630619d14ae92c5541d52c579d7c8f3e94)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/cavsdec.c b/libavcodec/cavsdec.c
index 8d30040d74..abfad66259 100644
--- a/libavcodec/cavsdec.c
+++ b/libavcodec/cavsdec.c
@@ -599,12 +599,21 @@ static int decode_pic(AVSContext *h) {
 static int decode_seq_header(AVSContext *h) {
     MpegEncContext *s = &h->s;
     int frame_rate_code;
+    int width, height;
 
     h->profile =         get_bits(&s->gb,8);
     h->level =           get_bits(&s->gb,8);
     skip_bits1(&s->gb); //progressive sequence
-    s->width =           get_bits(&s->gb,14);
-    s->height =          get_bits(&s->gb,14);
+
+    width  = get_bits(&s->gb, 14);
+    height = get_bits(&s->gb, 14);
+    if ((s->width || s->height) && (s->width != width || s->height != height)) {
+        av_log(s, AV_LOG_ERROR, "Width/height changing in CAVS is unsupported");
+        return AVERROR_PATCHWELCOME;
+    }
+    s->width  = width;
+    s->height = height;
+
     skip_bits(&s->gb,2); //chroma format
     skip_bits(&s->gb,3); //sample_precision
     h->aspect_ratio =    get_bits(&s->gb,4);
