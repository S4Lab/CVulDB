FFmpeg__FFmpeg
commit cb5d0ea0bec119ecbe327bd7d3834987ab42ec1a
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Tue Aug 20 23:18:48 2013 +0200
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Sat Feb 1 14:06:24 2014 -0500

    flashsv: Check diff_start diff_height values
    
    Fix out of array accesses.
    
    Found-by: ami_stuff
    Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
    
    Adresses: CVE-2013-7015
    (cherry picked from commit 57070b1468edc6ac8cb3696c817f3c943975d4c1)
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>
    (cherry picked from commit 10d48fe6d3963842319b1d8d738a318020836e72)
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/flashsv.c b/libavcodec/flashsv.c
index 4a231ce899..686a696099 100644
--- a/libavcodec/flashsv.c
+++ b/libavcodec/flashsv.c
@@ -377,6 +377,12 @@ static int flashsv_decode_frame(AVCodecContext *avctx, void *data,
                     }
                     s->diff_start  = get_bits(&gb, 8);
                     s->diff_height = get_bits(&gb, 8);
+                    if (s->diff_start + s->diff_height > cur_blk_height) {
+                        av_log(avctx, AV_LOG_ERROR,
+                               "Block parameters invalid: %d + %d > %d\n",
+                               s->diff_start, s->diff_height, cur_blk_height);
+                        return AVERROR_INVALIDDATA;
+                    }
                     av_log(avctx, AV_LOG_DEBUG,
                            "%dx%d diff start %d height %d\n",
                            i, j, s->diff_start, s->diff_height);
