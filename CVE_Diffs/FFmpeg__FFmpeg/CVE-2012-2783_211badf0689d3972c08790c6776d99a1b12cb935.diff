FFmpeg__FFmpeg
commit 211badf0689d3972c08790c6776d99a1b12cb935
Author:     Luca Barbato <lu_zero@gentoo.org>
AuthorDate: Fri Dec 14 09:55:04 2012 +0100
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Wed Jan 2 20:28:18 2013 +0100

    vp56: release frames on error
    
    Fixes CVE-2012-2783
    
    CC: libav-stable@libav.org
    
    (cherry picked from commit f33b5ba63eee96c9d1c7f0e568169cb0c3694238)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/vp56.c b/libavcodec/vp56.c
index 0ad468cd0d..7767461843 100644
--- a/libavcodec/vp56.c
+++ b/libavcodec/vp56.c
@@ -513,8 +513,14 @@ int ff_vp56_decode_frame(AVCodecContext *avctx, void *data, int *data_size,
         s->modelp = &s->models[is_alpha];
 
         res = s->parse_header(s, buf, remaining_buf_size, &golden_frame);
-        if (res < 0)
+        if (res < 0) {
+            int i;
+            for (i = 0; i < 4; i++) {
+                if (s->frames[i].data[0])
+                    avctx->release_buffer(avctx, &s->frames[i]);
+            }
             return res;
+        }
 
         if (res == VP56_SIZE_CHANGE) {
             int i;
