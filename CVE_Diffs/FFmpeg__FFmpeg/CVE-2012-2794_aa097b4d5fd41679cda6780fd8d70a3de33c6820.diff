FFmpeg__FFmpeg
commit aa097b4d5fd41679cda6780fd8d70a3de33c6820
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Sun Apr 15 14:11:50 2012 +0200
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Fri Jan 4 07:43:37 2013 +0100

    indeo5: check tile size in decode_mb_info().
    
    This prevents writing into a too small array if some parameters changed
    without the tile being reallocated.
    
    Fixes CVE-2012-2794
    
    CC:libav-stable@libav.org
    
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit 2d09cdbaf2f449ba23d54e97e94bd97ca22208c6)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/indeo5.c b/libavcodec/indeo5.c
index c3f73ea1f5..e12cd61419 100644
--- a/libavcodec/indeo5.c
+++ b/libavcodec/indeo5.c
@@ -457,6 +457,12 @@ static int decode_mb_info(IVI5DecContext *ctx, IVIBandDesc *band,
         ((band->qdelta_present && band->inherit_qdelta) || band->inherit_mv))
         return AVERROR_INVALIDDATA;
 
+    if (tile->num_MBs != IVI_MBs_PER_TILE(tile->width, tile->height, band->mb_size)) {
+        av_log(avctx, AV_LOG_ERROR, "Allocated tile size %d mismatches parameters %d\n",
+               tile->num_MBs, IVI_MBs_PER_TILE(tile->width, tile->height, band->mb_size));
+        return AVERROR_INVALIDDATA;
+    }
+
     /* scale factor for motion vectors */
     mv_scale = (ctx->planes[0].bands[0].mb_size >> 3) - (band->mb_size >> 3);
     mv_x = mv_y = 0;
