FFmpeg__FFmpeg
commit b581580bd1cc8506befa65b0a5c9ae429240f21f
Author:     Janne Grunau <janne-libav@jannau.net>
AuthorDate: Thu Jan 5 20:50:55 2012 +0100
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Wed May 23 15:05:27 2012 +0200

    adpcm: ADPCM Electronic Arts has always two channels
    
    Fixes half of http://ffmpeg.org/trac/ffmpeg/ticket/794
    Adresses CVE-2012-0852
    
    (cherry picked from commit bb5b3940b08d8dad5b7e948e8f3b02cd2eb70716)
    
    Conflicts:
    
            libavcodec/adpcm.c
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/adpcm.c b/libavcodec/adpcm.c
index 069690a64a..4384e1dcee 100644
--- a/libavcodec/adpcm.c
+++ b/libavcodec/adpcm.c
@@ -744,9 +744,13 @@ static int adpcm_encode_frame(AVCodecContext *avctx,
 static av_cold int adpcm_decode_init(AVCodecContext * avctx)
 {
     ADPCMContext *c = avctx->priv_data;
+    unsigned int min_channels = 1;
     unsigned int max_channels = 2;
 
     switch(avctx->codec->id) {
+    case CODEC_ID_ADPCM_EA:
+        min_channels = 2;
+        break;
     case CODEC_ID_ADPCM_EA_R1:
     case CODEC_ID_ADPCM_EA_R2:
     case CODEC_ID_ADPCM_EA_R3:
@@ -754,8 +758,10 @@ static av_cold int adpcm_decode_init(AVCodecContext * avctx)
         max_channels = 6;
         break;
     }
-    if(avctx->channels > max_channels){
-        return -1;
+
+    if (avctx->channels < min_channels || avctx->channels > max_channels) {
+        av_log(avctx, AV_LOG_ERROR, "Invalid number of channels\n");
+        return AVERROR(EINVAL);
     }
 
     switch(avctx->codec->id) {
