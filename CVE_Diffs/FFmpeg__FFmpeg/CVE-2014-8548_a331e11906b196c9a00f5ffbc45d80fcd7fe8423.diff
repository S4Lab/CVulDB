FFmpeg__FFmpeg
commit a331e11906b196c9a00f5ffbc45d80fcd7fe8423
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Fri Oct 3 22:50:45 2014 +0200
Commit:     Anton Khirnov <anton@khirnov.net>
CommitDate: Sat Dec 20 11:16:34 2014 +0100

    smc: fix the bounds check
    
    Fixes invalid writes when there are more blocks in a run than total
    remaining blocks.
    
    CC: libav-stable@libav.org
    Bug-ID: CVE-2014-8548
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit d423dd72be451462c6fb1cbbe313bed0194001ab)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit 58dc526ebf722d33bf09275c1241674e0e6b9ef1)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit f249e9889155599ee3ad0172832d38f68b0c625d)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit 306ee95088243fefa2dfcb5c355d439db75e2d2a)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>

diff --git a/libavcodec/smc.c b/libavcodec/smc.c
index 2bd3176f8e..257d5dae5f 100644
--- a/libavcodec/smc.c
+++ b/libavcodec/smc.c
@@ -69,7 +69,7 @@ typedef struct SmcContext {
         row_ptr += stride * 4; \
     } \
     total_blocks--; \
-    if (total_blocks < 0) \
+    if (total_blocks < !!n_blocks) \
     { \
         av_log(s->avctx, AV_LOG_INFO, "warning: block counter just went negative (this should not happen)\n"); \
         return; \
