aosp-mirror__platform_external_libxml2
commit 72a46a519ce7326d9a00f0b6a7f2a8e958cd1675
Author:     Daniel Veillard <veillard@redhat.com>
AuthorDate: Thu Oct 23 11:35:36 2014 +0800
Commit:     Daniel Veillard <veillard@redhat.com>
CommitDate: Thu Oct 23 11:35:36 2014 +0800

    Fix missing entities after CVE-2014-3660 fix
    
    For https://bugzilla.gnome.org/show_bug.cgi?id=738805
    
    The fix for CVE-2014-3660 introduced a regression in some case
    where entity substitution is required and the entity is used
    first in anotther entity referenced from an attribute value

diff --git a/parser.c b/parser.c
index 67c9dfd9..a8d1b673 100644
--- a/parser.c
+++ b/parser.c
@@ -7235,7 +7235,8 @@ xmlParseReference(xmlParserCtxtPtr ctxt) {
      * far more secure as the parser will only process data coming from
      * the document entity by default.
      */
-    if ((ent->checked == 0) &&
+    if (((ent->checked == 0) ||
+         ((ent->children == NULL) && (ctxt->options & XML_PARSE_NOENT))) &&
         ((ent->etype != XML_EXTERNAL_GENERAL_PARSED_ENTITY) ||
          (ctxt->options & (XML_PARSE_NOENT | XML_PARSE_DTDVALID)))) {
 	unsigned long oldnbent = ctxt->nbentities;
