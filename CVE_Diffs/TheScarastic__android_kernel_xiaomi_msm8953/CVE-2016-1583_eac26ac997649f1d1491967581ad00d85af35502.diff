TheScarastic__android_kernel_xiaomi_msm8953
commit eac26ac997649f1d1491967581ad00d85af35502
Author:     Jeff Mahoney <jeffm@suse.com>
AuthorDate: Tue Jul 5 17:32:30 2016 -0400
Commit:     Gerrit - the friendly Code Review server <code-review@localhost>
CommitDate: Sun Dec 11 23:54:59 2016 -0800

    ecryptfs: don't allow mmap when the lower fs doesn't support it
    
    There are legitimate reasons to disallow mmap on certain files, notably
    in sysfs or procfs.  We shouldn't emulate mmap support on file systems
    that don't offer support natively.
    
    CVE-2016-1583
    
    Change-Id: I4087f557641756192a33749e9f14afe685b5d660
    Signed-off-by: Jeff Mahoney <jeffm@suse.com>
    Cc: stable@vger.kernel.org
    [tyhicks: clean up f_op check by using ecryptfs_file_to_lower()]
    Signed-off-by: Tyler Hicks <tyhicks@canonical.com>
    Git-repo: https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git
    Git-commit: f0fe970df3838c202ef6c07a4c2b36838ef0a88b
    Signed-off-by: Dennis Cagle <d-cagle@codeaurora.org>

diff --git a/fs/ecryptfs/file.c b/fs/ecryptfs/file.c
index d68eb1b838c0..e83d404df6d1 100644
--- a/fs/ecryptfs/file.c
+++ b/fs/ecryptfs/file.c
@@ -178,6 +178,19 @@ out:
 	return rc;
 }
 
+static int ecryptfs_mmap(struct file *file, struct vm_area_struct *vma)
+{
+	struct file *lower_file = ecryptfs_file_to_lower(file);
+	/*
+	 * Don't allow mmap on top of file systems that don't support it
+	 * natively.  If FILESYSTEM_MAX_STACK_DEPTH > 2 or ecryptfs
+	 * allows recursive mounting, this will need to be extended.
+	 */
+	if (!lower_file->f_op->mmap)
+		return -ENODEV;
+	return generic_file_mmap(file, vma);
+}
+
 /**
  * ecryptfs_open
  * @inode: inode speciying file to open
@@ -398,7 +411,7 @@ const struct file_operations ecryptfs_main_fops = {
 #ifdef CONFIG_COMPAT
 	.compat_ioctl = ecryptfs_compat_ioctl,
 #endif
-	.mmap = generic_file_mmap,
+	.mmap = ecryptfs_mmap,
 	.open = ecryptfs_open,
 	.flush = ecryptfs_flush,
 	.release = ecryptfs_release,
