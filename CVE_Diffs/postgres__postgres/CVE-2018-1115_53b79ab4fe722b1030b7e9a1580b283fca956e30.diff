postgres__postgres
commit 53b79ab4fe722b1030b7e9a1580b283fca956e30
Author:     Stephen Frost <sfrost@snowman.net>
AuthorDate: Mon May 7 10:10:45 2018 -0400
Commit:     Stephen Frost <sfrost@snowman.net>
CommitDate: Mon May 7 10:10:45 2018 -0400

    adminpack: Revoke EXECUTE on pg_logfile_rotate()
    
    In 9.6, we moved a number of functions over to using the GRANT system to
    control access instead of having hard-coded superuser checks.
    
    As it turns out, adminpack was creating another function in the catalog
    for one of those backend functions where the superuser check was
    removed, specifically pg_rotate_logfile(), but it didn't get the memo
    about having to REVOKE EXECUTE on the alternative-name function
    (pg_logfile_rotate()), meaning that in any installations with adminpack
    on 9.6 and higher, any user is able to run the pg_logfile_rotate()
    function, which then calls pg_rotate_logfile() and rotates the logfile.
    
    Fix by adding a new version of adminpack (1.1) which handles the REVOKE.
    As this function should have only been available to the superuser, this
    is a security issue, albeit a minor one.
    
    Security: CVE-2018-1115

diff --git a/contrib/adminpack/Makefile b/contrib/adminpack/Makefile
index f065f84bfb..07d8be36b1 100644
--- a/contrib/adminpack/Makefile
+++ b/contrib/adminpack/Makefile
@@ -5,7 +5,7 @@ OBJS = adminpack.o $(WIN32RES)
 PG_CPPFLAGS = -I$(libpq_srcdir)
 
 EXTENSION = adminpack
-DATA = adminpack--1.0.sql
+DATA = adminpack--1.0.sql adminpack--1.1.sql adminpack--1.0--1.1.sql
 PGFILEDESC = "adminpack - support functions for pgAdmin"
 
 ifdef USE_PGXS
diff --git a/contrib/adminpack/adminpack--1.0--1.1.sql b/contrib/adminpack/adminpack--1.0--1.1.sql
new file mode 100644
index 0000000000..bb581653e0
--- /dev/null
+++ b/contrib/adminpack/adminpack--1.0--1.1.sql
@@ -0,0 +1,6 @@
+/* contrib/adminpack/adminpack--1.0--1.1.sql */
+
+-- complain if script is sourced in psql, rather than via ALTER EXTENSION
+\echo Use "ALTER EXTENSION adminpack UPDATE TO '1.1'" to load this file. \quit
+
+REVOKE EXECUTE ON FUNCTION pg_catalog.pg_logfile_rotate() FROM PUBLIC;
diff --git a/contrib/adminpack/adminpack--1.1.sql b/contrib/adminpack/adminpack--1.1.sql
new file mode 100644
index 0000000000..bfea5326fb
--- /dev/null
+++ b/contrib/adminpack/adminpack--1.1.sql
@@ -0,0 +1,55 @@
+/* contrib/adminpack/adminpack--1.1.sql */
+
+-- complain if script is sourced in psql, rather than via CREATE EXTENSION
+\echo Use "CREATE EXTENSION adminpack" to load this file. \quit
+
+/* ***********************************************
+ * Administrative functions for PostgreSQL
+ * *********************************************** */
+
+/* generic file access functions */
+
+CREATE FUNCTION pg_catalog.pg_file_write(text, text, bool)
+RETURNS bigint
+AS 'MODULE_PATHNAME', 'pg_file_write'
+LANGUAGE C VOLATILE STRICT;
+
+CREATE FUNCTION pg_catalog.pg_file_rename(text, text, text)
+RETURNS bool
+AS 'MODULE_PATHNAME', 'pg_file_rename'
+LANGUAGE C VOLATILE;
+
+CREATE FUNCTION pg_catalog.pg_file_rename(text, text)
+RETURNS bool
+AS 'SELECT pg_catalog.pg_file_rename($1, $2, NULL::pg_catalog.text);'
+LANGUAGE SQL VOLATILE STRICT;
+
+CREATE FUNCTION pg_catalog.pg_file_unlink(text)
+RETURNS bool
+AS 'MODULE_PATHNAME', 'pg_file_unlink'
+LANGUAGE C VOLATILE STRICT;
+
+CREATE FUNCTION pg_catalog.pg_logdir_ls()
+RETURNS setof record
+AS 'MODULE_PATHNAME', 'pg_logdir_ls'
+LANGUAGE C VOLATILE STRICT;
+
+
+/* Renaming of existing backend functions for pgAdmin compatibility */
+
+CREATE FUNCTION pg_catalog.pg_file_read(text, bigint, bigint)
+RETURNS text
+AS 'pg_read_file'
+LANGUAGE INTERNAL VOLATILE STRICT;
+
+CREATE FUNCTION pg_catalog.pg_file_length(text)
+RETURNS bigint
+AS 'SELECT size FROM pg_catalog.pg_stat_file($1)'
+LANGUAGE SQL VOLATILE STRICT;
+
+CREATE FUNCTION pg_catalog.pg_logfile_rotate()
+RETURNS int4
+AS 'pg_rotate_logfile'
+LANGUAGE INTERNAL VOLATILE STRICT;
+
+REVOKE EXECUTE ON FUNCTION pg_catalog.pg_logfile_rotate() FROM PUBLIC;
diff --git a/contrib/adminpack/adminpack.control b/contrib/adminpack/adminpack.control
index c79413f378..71f6ad5ddf 100644
--- a/contrib/adminpack/adminpack.control
+++ b/contrib/adminpack/adminpack.control
@@ -1,6 +1,6 @@
 # adminpack extension
 comment = 'administrative functions for PostgreSQL'
-default_version = '1.0'
+default_version = '1.1'
 module_pathname = '$libdir/adminpack'
 relocatable = false
 schema = pg_catalog
