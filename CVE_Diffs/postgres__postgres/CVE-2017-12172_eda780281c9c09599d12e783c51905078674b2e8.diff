postgres__postgres
commit eda780281c9c09599d12e783c51905078674b2e8
Author:     Noah Misch <noah@leadboat.com>
AuthorDate: Mon Nov 6 07:11:10 2017 -0800
Commit:     Noah Misch <noah@leadboat.com>
CommitDate: Mon Nov 6 07:11:13 2017 -0800

    start-scripts: switch to $PGUSER before opening $PGLOG.
    
    By default, $PGUSER has permission to unlink $PGLOG.  If $PGUSER
    replaces $PGLOG with a symbolic link, the server will corrupt the
    link-targeted file by appending log messages.  Since these scripts open
    $PGLOG as root, the attack works regardless of target file ownership.
    
    "make install" does not install these scripts anywhere.  Users having
    manually installed them in the past should repeat that process to
    acquire this fix.  Most script users have $PGLOG writable to root only,
    located in $PGDATA.  Just before updating one of these scripts, such
    users should rename $PGLOG to $PGLOG.old.  The script will then recreate
    $PGLOG with proper ownership.
    
    Reviewed by Peter Eisentraut.  Reported by Antoine Scemama.
    
    Security: CVE-2017-12172

diff --git a/contrib/start-scripts/freebsd b/contrib/start-scripts/freebsd
index 758574b427..e37421253d 100644
--- a/contrib/start-scripts/freebsd
+++ b/contrib/start-scripts/freebsd
@@ -44,7 +44,7 @@ test -x $DAEMON ||
 
 case $1 in
     start)
-	su -l $PGUSER -c "$DAEMON -D '$PGDATA' &" >>$PGLOG 2>&1
+	su -l $PGUSER -c "$DAEMON -D '$PGDATA' >>$PGLOG 2>&1 &"
 	echo -n ' postgresql'
 	;;
     stop)
@@ -52,7 +52,7 @@ case $1 in
 	;;
     restart)
 	su -l $PGUSER -c "$PGCTL stop -D '$PGDATA' -s -m fast -w"
-	su -l $PGUSER -c "$DAEMON -D '$PGDATA' &" >>$PGLOG 2>&1
+	su -l $PGUSER -c "$DAEMON -D '$PGDATA' >>$PGLOG 2>&1 &"
 	;;
     status)
 	su -l $PGUSER -c "$PGCTL status -D '$PGDATA'"
diff --git a/contrib/start-scripts/linux b/contrib/start-scripts/linux
index b950cf512c..023a4ca1e6 100644
--- a/contrib/start-scripts/linux
+++ b/contrib/start-scripts/linux
@@ -84,7 +84,7 @@ case $1 in
 	echo -n "Starting PostgreSQL: "
 	test x"$OOM_SCORE_ADJ" != x && echo "$OOM_SCORE_ADJ" > /proc/self/oom_score_adj
 	test x"$OOM_ADJ" != x && echo "$OOM_ADJ" > /proc/self/oom_adj
-	su - $PGUSER -c "$DAEMON -D '$PGDATA' &" >>$PGLOG 2>&1
+	su - $PGUSER -c "$DAEMON -D '$PGDATA' >>$PGLOG 2>&1 &"
 	echo "ok"
 	;;
   stop)
@@ -97,7 +97,7 @@ case $1 in
 	su - $PGUSER -c "$PGCTL stop -D '$PGDATA' -s -m fast -w"
 	test x"$OOM_SCORE_ADJ" != x && echo "$OOM_SCORE_ADJ" > /proc/self/oom_score_adj
 	test x"$OOM_ADJ" != x && echo "$OOM_ADJ" > /proc/self/oom_adj
-	su - $PGUSER -c "$DAEMON -D '$PGDATA' &" >>$PGLOG 2>&1
+	su - $PGUSER -c "$DAEMON -D '$PGDATA' >>$PGLOG 2>&1 &"
 	echo "ok"
 	;;
   reload)
diff --git a/contrib/start-scripts/osx/PostgreSQL b/contrib/start-scripts/osx/PostgreSQL
index e7e6aa1493..a2a4c0f00c 100755
--- a/contrib/start-scripts/osx/PostgreSQL
+++ b/contrib/start-scripts/osx/PostgreSQL
@@ -85,9 +85,9 @@ StartService () {
     if [ "${POSTGRESQL:=-NO-}" = "-YES-" ]; then
         ConsoleMessage "Starting PostgreSQL database server"
         if [ "${ROTATELOGS}" = "1" ]; then
-            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' &" 2>&1 | ${LOGUTIL} "${PGLOG}" ${ROTATESEC} &
+            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' 2>&1 | ${LOGUTIL} \"${PGLOG}\" ${ROTATESEC} &"
         else
-            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' &" >>"$PGLOG" 2>&1
+            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' >>\"$PGLOG\" 2>&1 &"
         fi
     fi
 }
@@ -104,9 +104,9 @@ RestartService () {
 	sudo -u $PGUSER sh -c "$PGCTL stop -D '${PGDATA}' -s -m fast"
 	# should match StartService:
         if [ "${ROTATELOGS}" = "1" ]; then
-            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' &" 2>&1 | ${LOGUTIL} "${PGLOG}" ${ROTATESEC} &
+            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' 2>&1 | ${LOGUTIL} \"${PGLOG}\" ${ROTATESEC} &"
         else
-            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' &" >>"$PGLOG" 2>&1
+            sudo -u $PGUSER sh -c "${DAEMON} -D '${PGDATA}' >>\"$PGLOG\" 2>&1 &"
         fi
     else
         StopService
