postgres__postgres
commit 20f01fc45996238f7f1007ba704d30663955150a
Author:     Stephen Frost <sfrost@snowman.net>
AuthorDate: Mon May 7 10:10:41 2018 -0400
Commit:     Stephen Frost <sfrost@snowman.net>
CommitDate: Mon May 7 10:10:41 2018 -0400

    adminpack: Revoke EXECUTE on pg_logfile_rotate()
    
    In 9.6, we moved a number of functions over to using the GRANT system to
    control access instead of having hard-coded superuser checks.
    
    As it turns out, adminpack was creating another function in the catalog
    for one of those backend functions where the superuser check was
    removed, specifically pg_rotate_logfile(), but it didn't get the memo
    about having to REVOKE EXECUTE on the alternative-name function
    (pg_logfile_rotate()), meaning that in any installations with adminpack
    on 9.6 and higher, any user is able to run the pg_logfile_rotate()
    function, which then calls pg_rotate_logfile() and rotates the logfile.
    
    Fix by adding a new version of adminpack (1.1) which handles the REVOKE.
    As this function should have only been available to the superuser, this
    is a security issue, albeit a minor one.
    
    Security: CVE-2018-1115

diff --git a/contrib/adminpack/Makefile b/contrib/adminpack/Makefile
index f065f84bfb..0f7902f206 100644
--- a/contrib/adminpack/Makefile
+++ b/contrib/adminpack/Makefile
@@ -5,7 +5,7 @@ OBJS = adminpack.o $(WIN32RES)
 PG_CPPFLAGS = -I$(libpq_srcdir)
 
 EXTENSION = adminpack
-DATA = adminpack--1.0.sql
+DATA = adminpack--1.0.sql adminpack--1.0--1.1.sql
 PGFILEDESC = "adminpack - support functions for pgAdmin"
 
 ifdef USE_PGXS
diff --git a/contrib/adminpack/adminpack--1.0--1.1.sql b/contrib/adminpack/adminpack--1.0--1.1.sql
new file mode 100644
index 0000000000..bb581653e0
--- /dev/null
+++ b/contrib/adminpack/adminpack--1.0--1.1.sql
@@ -0,0 +1,6 @@
+/* contrib/adminpack/adminpack--1.0--1.1.sql */
+
+-- complain if script is sourced in psql, rather than via ALTER EXTENSION
+\echo Use "ALTER EXTENSION adminpack UPDATE TO '1.1'" to load this file. \quit
+
+REVOKE EXECUTE ON FUNCTION pg_catalog.pg_logfile_rotate() FROM PUBLIC;
diff --git a/contrib/adminpack/adminpack.control b/contrib/adminpack/adminpack.control
index c79413f378..71f6ad5ddf 100644
--- a/contrib/adminpack/adminpack.control
+++ b/contrib/adminpack/adminpack.control
@@ -1,6 +1,6 @@
 # adminpack extension
 comment = 'administrative functions for PostgreSQL'
-default_version = '1.0'
+default_version = '1.1'
 module_pathname = '$libdir/adminpack'
 relocatable = false
 schema = pg_catalog
