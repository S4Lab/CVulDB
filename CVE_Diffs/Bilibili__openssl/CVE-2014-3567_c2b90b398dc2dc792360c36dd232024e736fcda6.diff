Bilibili__openssl
commit c2b90b398dc2dc792360c36dd232024e736fcda6
Author:     Dr. Stephen Henson <steve@openssl.org>
AuthorDate: Wed Oct 15 01:53:55 2014 +0100
Commit:     Geoff Thorpe <geoff@openssl.org>
CommitDate: Wed Oct 15 08:54:26 2014 -0400

    Fix for session tickets memory leak.
    
    CVE-2014-3567
    
    Reviewed-by: Rich Salz <rsalz@openssl.org>
    Reviewed-by: Matt Caswell <matt@openssl.org>
    (cherry picked from commit 5dc6070a03779cd524f0e67f76c945cb0ac38320)

diff --git a/ssl/t1_lib.c b/ssl/t1_lib.c
index c747b3092f..2986432697 100644
--- a/ssl/t1_lib.c
+++ b/ssl/t1_lib.c
@@ -3344,7 +3344,10 @@ static int tls_decrypt_ticket(SSL *s, const unsigned char *etick, int eticklen,
 	HMAC_Final(&hctx, tick_hmac, NULL);
 	HMAC_CTX_cleanup(&hctx);
 	if (CRYPTO_memcmp(tick_hmac, etick + eticklen, mlen))
+		{
+		EVP_CIPHER_CTX_cleanup(&ctx);
 		return 2;
+		}
 	/* Attempt to decrypt session data */
 	/* Move p after IV to start of encrypted ticket, update length */
 	p = etick + 16 + EVP_CIPHER_CTX_iv_length(&ctx);
