Bilibili__openssl
commit f338c2e0c2ce1e89cf8eba2d38878081f46b9dce
Author:     Dr. Stephen Henson <steve@openssl.org>
AuthorDate: Fri Jul 25 00:50:06 2014 +0100
Commit:     Matt Caswell <matt@openssl.org>
CommitDate: Wed Aug 6 20:41:24 2014 +0100

    Fix SRP ciphersuite DoS vulnerability.
    
    If a client attempted to use an SRP ciphersuite and it had not been
    set up correctly it would crash with a null pointer read. A malicious
    server could exploit this in a DoS attack.
    
    Thanks to Joonas Kuorilehto and Riku Hietam√§ki from Codenomicon
    for reporting this issue.
    
    CVE-2014-2970
    Reviewed-by: Tim Hudson <tjh@openssl.org>

diff --git a/ssl/t1_lib.c b/ssl/t1_lib.c
index 9e5927f826..ba2d9ae8f0 100644
--- a/ssl/t1_lib.c
+++ b/ssl/t1_lib.c
@@ -1086,6 +1086,13 @@ void ssl_set_client_disabled(SSL *s)
 		c->mask_k |= SSL_kPSK;
 		}
 #endif /* OPENSSL_NO_PSK */
+#ifndef OPENSSL_NO_SRP
+	if (!(s->srp_ctx.srp_Mask & SSL_kSRP))
+		{
+		c->mask_a |= SSL_aSRP;
+		c->mask_k |= SSL_kSRP;
+		}
+#endif
 	c->valid = 1;
 	}
 
