Uninett__mod_auth_mellon
commit 4c3ed69d9fe5632287f6ba896dfed2956734ba20
Author:     Olav Morken <olav.morken@uninett.no>
AuthorDate: Tue Mar 8 15:59:44 2016 +0100
Commit:     Olav Morken <olav.morken@uninett.no>
CommitDate: Tue Mar 8 15:59:44 2016 +0100

    [CVE-2016-2145] Handle ap_get_client_block() error in am_read_post_data()
    
    This is a simplified version of 5f03a632. 5f03a632 adds proper support
    for early EOF. This version of the patch simply makes sure that we abort
    on errors.

diff --git a/auth_mellon_util.c b/auth_mellon_util.c
index 155bb1a..d2922f3 100644
--- a/auth_mellon_util.c
+++ b/auth_mellon_util.c
@@ -482,12 +482,12 @@ int am_read_post_data(request_rec *r, char **data, apr_size_t *length)
     bytes_left = len;
 
     while (bytes_left > 0) {
-        /* Read data from the client. Returns 0 on EOF or error, the
-         * number of bytes otherwise.
+        /* Read data from the client. Returns 0 on EOF and -1 on
+         * error, the number of bytes otherwise.
          */
         read_length = ap_get_client_block(r, &(*data)[bytes_read],
                                           bytes_left);
-        if (read_length == 0) {
+        if (read_length <= 0) {
             ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r,
                           "Failed to read POST data from client.");
             return HTTP_INTERNAL_SERVER_ERROR;
