XQuartz__xorg-server
commit 69b173c6997954277dbd23eecc2cbf74e74ab228
Author:     Matthieu Herrb <matthieu.herrb@laas.fr>
AuthorDate: Tue Jun 10 12:21:26 2008 -0600
Commit:     Adam Jackson <ajax@redhat.com>
CommitDate: Wed Jun 11 11:27:00 2008 -0400

    CVE-2008-2360 - RENDER Extension heap buffer overflow
    
    An integer overflow may occur in the computation of the size of the
    glyph to be allocated by the AllocateGlyph() function which will cause
    less memory to be allocated than expected, leading to later heap
    overflow.
    (cherry picked from commit c5f69b297b1227cb802394fa90efdbe1de607f3c)

diff --git a/render/render.c b/render/render.c
index 40b8439c6..638aa46a3 100644
--- a/render/render.c
+++ b/render/render.c
@@ -1117,9 +1117,16 @@ ProcRenderAddGlyphs (ClientPtr client)
     remain -= (sizeof (CARD32) + sizeof (xGlyphInfo)) * nglyphs;
     for (i = 0; i < nglyphs; i++)
     {
+	size_t padded_width;
 	glyph_new = &glyphs[i];
-	size = gi[i].height * PixmapBytePad (gi[i].width,
-					     glyphSet->format->depth);
+
+	padded_width = PixmapBytePad (gi[i].width,
+				      glyphSet->format->depth);
+
+	if (gi[i].height && padded_width > (UINT32_MAX - sizeof(GlyphRec))/gi[i].height)
+	    break;
+	
+	size = gi[i].height * padded_width;
 	if (remain < size)
 	    break;
 
