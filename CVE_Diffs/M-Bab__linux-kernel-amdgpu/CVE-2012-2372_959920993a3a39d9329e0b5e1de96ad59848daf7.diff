M-Bab__linux-kernel-amdgpu
commit 959920993a3a39d9329e0b5e1de96ad59848daf7
Author:     Andy Whitcroft <apw@canonical.com>
AuthorDate: Thu Jul 26 11:25:52 2012 +0100
Commit:     Seth Forshee <seth.forshee@canonical.com>
CommitDate: Tue Sep 5 07:32:45 2017 -0500

    UBUNTU: SAUCE: (no-up) rds_ib_send() -- prevent local pings triggering BUG_ON()
    
    Pining localhost on an infiniband connection can trigger a BUG_ON()
    and cause a denial of service.
    
    Fix identified by comparison of the RHEL source rpms.
    
    CVE-2012-2372
    BugLink: http://bugs.launchpad.net/bugs/1016299
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/net/rds/ib_send.c b/net/rds/ib_send.c
index 6ab39dbcca01..e87a4449a5a8 100644
--- a/net/rds/ib_send.c
+++ b/net/rds/ib_send.c
@@ -506,7 +506,7 @@ int rds_ib_xmit(struct rds_connection *conn, struct rds_message *rm,
 	int flow_controlled = 0;
 	int nr_sig = 0;
 
-	BUG_ON(off % RDS_FRAG_SIZE);
+	BUG_ON(!conn->c_loopback && off % RDS_FRAG_SIZE);
 	BUG_ON(hdr_off != 0 && hdr_off != sizeof(struct rds_header));
 
 	/* Do not send cong updates to IB loopback */
