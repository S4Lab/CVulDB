M-Bab__linux-kernel-amdgpu
commit 69cf0fac6052c5bd3fb3469a41d4216e926028f8
Author:     Hugh Dickins <hugh@veritas.com>
AuthorDate: Mon Apr 17 22:46:32 2006 +0100
Commit:     Linus Torvalds <torvalds@g5.osdl.org>
CommitDate: Mon Apr 17 18:22:18 2006 -0700

    [PATCH] Fix MADV_REMOVE protection checking
    
    madvise_remove needs to respect file and mmap protections.
    
    Signed-off-by: Hugh Dickins <hugh@veritas.com>
    [ Will the real CVE-2006-1524 stand up, please.. ]
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

diff --git a/mm/madvise.c b/mm/madvise.c
index af3d573b0141..4e196155a0c3 100644
--- a/mm/madvise.c
+++ b/mm/madvise.c
@@ -168,6 +168,9 @@ static long madvise_remove(struct vm_area_struct *vma,
 			return -EINVAL;
 	}
 
+	if ((vma->vm_flags & (VM_SHARED|VM_WRITE)) != (VM_SHARED|VM_WRITE))
+		return -EACCES;
+
 	mapping = vma->vm_file->f_mapping;
 
 	offset = (loff_t)(start - vma->vm_start)
