openssl__openssl
commit 21376d8ae310cf0455ca2b73c8e9f77cafeb28dd
Author:     Matt Caswell <matt@openssl.org>
AuthorDate: Wed Jun 24 15:55:36 2015 +0100
Commit:     Matt Caswell <matt@openssl.org>
CommitDate: Tue Jul 7 21:48:55 2015 +0100

    Fix alternate chains certificate forgery issue
    
    During certificate verfification, OpenSSL will attempt to find an
    alternative certificate chain if the first attempt to build such a chain
    fails. An error in the implementation of this logic can mean that an
    attacker could cause certain checks on untrusted certificates to be
    bypassed, such as the CA flag, enabling them to use a valid leaf
    certificate to act as a CA and "issue" an invalid certificate.
    
    This occurs where at least one cert is added to the first chain from the
    trust store, but that chain still ends up being untrusted. In that case
    ctx->last_untrusted is decremented in error.
    
    Patch provided by the BoringSSL project.
    
    CVE-2015-1793
    
    Reviewed-by: Stephen Henson <steve@openssl.org>

diff --git a/crypto/x509/x509_vfy.c b/crypto/x509/x509_vfy.c
index 8ce41f9c9a..33896fbc64 100644
--- a/crypto/x509/x509_vfy.c
+++ b/crypto/x509/x509_vfy.c
@@ -389,8 +389,8 @@ int X509_verify_cert(X509_STORE_CTX *ctx)
                         xtmp = sk_X509_pop(ctx->chain);
                         X509_free(xtmp);
                         num--;
-                        ctx->last_untrusted--;
                     }
+                    ctx->last_untrusted = sk_X509_num(ctx->chain);
                     retry = 1;
                     break;
                 }
