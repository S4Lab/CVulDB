openssl__openssl
commit 25128a11fba414b06ba4b48f6b9186c1641ca410
Author:     Dr. Stephen Henson <steve@openssl.org>
AuthorDate: Thu Feb 16 15:21:46 2012 +0000
Commit:     Dr. Stephen Henson <steve@openssl.org>
CommitDate: Thu Feb 16 15:21:46 2012 +0000

    Fix bug in CVE-2011-4619: check we have really received a client hello
    before rejecting multiple SGC restarts.

diff --git a/CHANGES b/CHANGES
index 08449ffd14..0ee54e3f2f 100644
--- a/CHANGES
+++ b/CHANGES
@@ -4,7 +4,10 @@
 
  Changes between 1.0.0g and 1.0.0h [xx XXX xxxx]
 
-  *)
+  *) Fix CVE-2011-4619: make sure we really are receiving a 
+     client hello before rejecting multiple SGC restarts. Thanks to
+     Ivan Nestlerode <inestlerode@us.ibm.com> for discovering this bug.
+     [Steve Henson]
 
  Changes between 1.0.0f and 1.0.0g [18 Jan 2012]
 
diff --git a/ssl/s3_srvr.c b/ssl/s3_srvr.c
index d734c359fb..a79c986da3 100644
--- a/ssl/s3_srvr.c
+++ b/ssl/s3_srvr.c
@@ -756,14 +756,6 @@ int ssl3_check_client_hello(SSL *s)
 	int ok;
 	long n;
 
-	/* We only allow the client to restart the handshake once per
-	 * negotiation. */
-	if (s->s3->flags & SSL3_FLAGS_SGC_RESTART_DONE)
-		{
-		SSLerr(SSL_F_SSL3_CHECK_CLIENT_HELLO, SSL_R_MULTIPLE_SGC_RESTARTS);
-		return -1;
-		}
-
 	/* this function is called when we really expect a Certificate message,
 	 * so permit appropriate message length */
 	n=s->method->ssl_get_message(s,
@@ -776,6 +768,13 @@ int ssl3_check_client_hello(SSL *s)
 	s->s3->tmp.reuse_message = 1;
 	if (s->s3->tmp.message_type == SSL3_MT_CLIENT_HELLO)
 		{
+		/* We only allow the client to restart the handshake once per
+		 * negotiation. */
+		if (s->s3->flags & SSL3_FLAGS_SGC_RESTART_DONE)
+			{
+			SSLerr(SSL_F_SSL3_CHECK_CLIENT_HELLO, SSL_R_MULTIPLE_SGC_RESTARTS);
+			return -1;
+			}
 		/* Throw away what we have done so far in the current handshake,
 		 * which will now be aborted. (A full SSL_clear would be too much.) */
 #ifndef OPENSSL_NO_DH
