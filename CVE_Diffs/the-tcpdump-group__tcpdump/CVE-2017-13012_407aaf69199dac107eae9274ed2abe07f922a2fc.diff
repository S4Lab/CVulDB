the-tcpdump-group__tcpdump
commit 407aaf69199dac107eae9274ed2abe07f922a2fc
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Wed Mar 15 23:45:38 2017 -0700
Commit:     Denis Ovsienko <denis@ovsienko.info>
CommitDate: Mon Sep 4 00:08:58 2017 +0100

    CVE-2017-13012/ICMP: Add a missing bounds check.
    
    Check before fetching the length from the included packet's IPv4 header.
    
    This fixes a buffer over-read discovered by Bhargava Shastry,
    SecT/TU Berlin.
    
    Add a test using the capture file supplied by the reporter(s), modified
    so the capture file won't be rejected as an invalid capture.

diff --git a/print-icmp.c b/print-icmp.c
index 53392212..c33f83a6 100644
--- a/print-icmp.c
+++ b/print-icmp.c
@@ -582,6 +582,7 @@ icmp_print(netdissect_options *ndo, const u_char *bp, u_int plen, const u_char *
 		ip = (const struct ip *)bp;
 		ndo->ndo_snaplen = ndo->ndo_snapend - bp;
                 snapend_save = ndo->ndo_snapend;
+		ND_TCHECK_16BITS(&ip->ip_len);
 		ip_print(ndo, bp, EXTRACT_16BITS(&ip->ip_len));
                 ndo->ndo_snapend = snapend_save;
 	}
diff --git a/tests/TESTLIST b/tests/TESTLIST
index ad353615..252fe99a 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -506,6 +506,7 @@ pktap-heap-overflow	pktap-heap-overflow.pcap	pktap-heap-overflow.out	-v
 
 # bad packets from Bhargava Shastry
 lldp_asan		lldp_asan.pcap			lldp_asan.out	-v
+extract_read2_asan	extract_read2_asan.pcap		extract_read2_asan.out	-v
 
 # RTP tests
 # fuzzed pcap
diff --git a/tests/extract_read2_asan.out b/tests/extract_read2_asan.out
new file mode 100644
index 00000000..d0b72ed0
--- /dev/null
+++ b/tests/extract_read2_asan.out
@@ -0,0 +1,3 @@
+IP (tos 0x14, id 1, offset 0, flags [none], proto ICMP (1), length 512, options (unknown 3,unknown 3,unknown 3 [bad length 3]), bad cksum 3ff (->b4bd)!)
+    240.25.0.0 > 3.3.3.3: ICMP source quench, length 484
+	[|icmp]
diff --git a/tests/extract_read2_asan.pcap b/tests/extract_read2_asan.pcap
new file mode 100644
index 00000000..d30ee16d
Binary files /dev/null and b/tests/extract_read2_asan.pcap differ
