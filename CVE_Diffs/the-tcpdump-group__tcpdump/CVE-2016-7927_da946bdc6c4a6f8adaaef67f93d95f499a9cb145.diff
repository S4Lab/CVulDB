the-tcpdump-group__tcpdump
commit da946bdc6c4a6f8adaaef67f93d95f499a9cb145
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 16:01:36 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:36 2017 +0100

    CVE-2016-7927/Do bounds checking on last_presentp before dereferencing it.
    
    Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.

diff --git a/print-802_11.c b/print-802_11.c
index 78a57b18..1bbe47ac 100644
--- a/print-802_11.c
+++ b/print-802_11.c
@@ -3115,6 +3115,9 @@ ieee802_11_radio_print(netdissect_options *ndo,
 
 	len = EXTRACT_LE_16BITS(&hdr->it_len);
 
+	/*
+	 * If we don't have the entire radiotap header, just give up.
+	 */
 	if (caplen < len) {
 		ND_PRINT((ndo, "%s", tstr));
 		return caplen;
@@ -3122,13 +3125,13 @@ ieee802_11_radio_print(netdissect_options *ndo,
 	cpack_init(&cpacker, (const uint8_t *)hdr, len); /* align against header start */
 	cpack_advance(&cpacker, sizeof(*hdr)); /* includes the 1st bitmap */
 	for (last_presentp = &hdr->it_present;
-	     IS_EXTENDED(last_presentp) &&
-	     (const u_char*)(last_presentp + 1) <= p + len;
+	     (const u_char*)(last_presentp + 1) <= p + len &&
+	     IS_EXTENDED(last_presentp);
 	     last_presentp++)
 	  cpack_advance(&cpacker, sizeof(hdr->it_present)); /* more bitmaps */
 
 	/* are there more bitmap extensions than bytes in header? */
-	if (IS_EXTENDED(last_presentp)) {
+	if ((const u_char*)(last_presentp + 1) > p + len) {
 		ND_PRINT((ndo, "%s", tstr));
 		return caplen;
 	}
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 96d0312d..1bcd7b3c 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -381,3 +381,4 @@ gre-heapoverflow-1	gre-heapoverflow-1.pcap	gre-heapoverflow-1.out	-t -v -n
 gre-heapoverflow-2	gre-heapoverflow-2.pcap	gre-heapoverflow-2.out	-t -v -n
 calm-fast-mac-lookup-heapoverflow	calm-fast-mac-lookup-heapoverflow.pcap	calm-fast-mac-lookup-heapoverflow.out	-t -v -n
 geonet-mac-lookup-heapoverflow	geonet-mac-lookup-heapoverflow.pcap	geonet-mac-lookup-heapoverflow.out	-t -v -n
+radiotap-heapoverflow	radiotap-heapoverflow.pcap	radiotap-heapoverflow.out -t -v -n
diff --git a/tests/radiotap-heapoverflow.out b/tests/radiotap-heapoverflow.out
new file mode 100644
index 00000000..a81d1840
--- /dev/null
+++ b/tests/radiotap-heapoverflow.out
@@ -0,0 +1 @@
+[|802.11]
diff --git a/tests/radiotap-heapoverflow.pcap b/tests/radiotap-heapoverflow.pcap
new file mode 100644
index 00000000..af182b2b
Binary files /dev/null and b/tests/radiotap-heapoverflow.pcap differ
