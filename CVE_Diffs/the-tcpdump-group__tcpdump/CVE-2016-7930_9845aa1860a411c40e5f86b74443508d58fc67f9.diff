the-tcpdump-group__tcpdump
commit 9845aa1860a411c40e5f86b74443508d58fc67f9
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 17:25:39 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:36 2017 +0100

    CVE-2016-7930/Add a bounds check.
    
    Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.

diff --git a/print-llc.c b/print-llc.c
index bca9b502..7f316c2e 100644
--- a/print-llc.c
+++ b/print-llc.c
@@ -358,6 +358,12 @@ llc_print(netdissect_options *ndo, const u_char *p, u_int length, u_int caplen,
                        length + hdrlen));
 
 		if ((control & ~LLC_U_POLL) == LLC_XID) {
+			if (caplen < 2 || length < 2) {
+				ND_PRINT((ndo, "[|llc]"));
+				if (caplen > 0)
+					ND_DEFAULTPRINT((const u_char *)p, caplen);
+				return (hdrlen);
+			}
 			if (*p == LLC_XID_FI) {
 				ND_PRINT((ndo, ": %02x %02x", p[1], p[2]));
 				return (hdrlen);
diff --git a/tests/TESTLIST b/tests/TESTLIST
index c137e8d5..6e4219e8 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -387,3 +387,4 @@ tcp-auth-heapoverflow	tcp-auth-heapoverflow.pcap	tcp-auth-heapoverflow.out	-t -v
 atm-oam-heapoverflow	atm-oam-heapoverflow.pcap	atm-oam-heapoverflow.out	-t -v -n
 tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out	-t -v -n
 ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
+llc-xid-heapoverflow	llc-xid-heapoverflow.pcap	llc-xid-heapoverflow.out	-t -v -n
diff --git a/tests/llc-xid-heapoverflow.out b/tests/llc-xid-heapoverflow.out
new file mode 100644
index 00000000..4fcad704
--- /dev/null
+++ b/tests/llc-xid-heapoverflow.out
@@ -0,0 +1 @@
+Unknown DSAP 0x30 Unnumbered, xid, Flags [Poll], length 808464412[|llc]
diff --git a/tests/llc-xid-heapoverflow.pcap b/tests/llc-xid-heapoverflow.pcap
new file mode 100644
index 00000000..0574501e
Binary files /dev/null and b/tests/llc-xid-heapoverflow.pcap differ
