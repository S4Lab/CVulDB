the-tcpdump-group__tcpdump
commit 5356a9ea6903b835185eda83e8a17d6e4e990fb5
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 11:43:30 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:35 2017 +0100

    CVE-2016-7973/Add some bounds checks.
    
    Fixes a heap overflow found with American Fuzzy Lop by Hanno Böck.

diff --git a/print-atalk.c b/print-atalk.c
index 2a674990..59de3a67 100644
--- a/print-atalk.c
+++ b/print-atalk.c
@@ -77,7 +77,14 @@ u_int
 ltalk_if_print(netdissect_options *ndo,
                const struct pcap_pkthdr *h, const u_char *p)
 {
-	return (llap_print(ndo, p, h->caplen));
+	u_int hdrlen;
+
+	hdrlen = llap_print(ndo, p, h->caplen);
+	if (hdrlen == 0) {
+		/* Cut short by the snapshot length. */
+		return (h->caplen);
+	}
+	return (hdrlen);
 }
 
 /*
@@ -93,6 +100,10 @@ llap_print(netdissect_options *ndo,
 	u_short snet;
 	u_int hdrlen;
 
+	if (!ND_TTEST2(*bp, sizeof(*lp))) {
+		ND_PRINT((ndo, " [|llap]"));
+		return (0);	/* cut short by the snapshot length */
+	}
 	if (length < sizeof(*lp)) {
 		ND_PRINT((ndo, " [|llap %u]", length));
 		return (length);
@@ -104,6 +115,10 @@ llap_print(netdissect_options *ndo,
 	switch (lp->type) {
 
 	case lapShortDDP:
+		if (!ND_TTEST2(*bp, ddpSSize)) {
+			ND_PRINT((ndo, " [|sddp]"));
+			return (0);	/* cut short by the snapshot length */
+		}
 		if (length < ddpSSize) {
 			ND_PRINT((ndo, " [|sddp %u]", length));
 			return (length);
@@ -120,6 +135,10 @@ llap_print(netdissect_options *ndo,
 		break;
 
 	case lapDDP:
+		if (!ND_TTEST2(*bp, ddpSize)) {
+			ND_PRINT((ndo, " [|ddp]"));
+			return (0);	/* cut short by the snapshot length */
+		}
 		if (length < ddpSize) {
 			ND_PRINT((ndo, " [|ddp %u]", length));
 			return (length);
@@ -166,6 +185,10 @@ atalk_print(netdissect_options *ndo,
         if(!ndo->ndo_eflag)
             ND_PRINT((ndo, "AT "));
 
+	if (!ND_TTEST2(*bp, ddpSize)) {
+		ND_PRINT((ndo, " [|ddp]"));
+		return;
+	}
 	if (length < ddpSize) {
 		ND_PRINT((ndo, " [|ddp %u]", length));
 		return;
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 3eb0b563..b5f00e6c 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -370,3 +370,4 @@ bfd-raw-auth-sha1-v bfd-raw-auth-sha1.pcap bfd-raw-auth-sha1-v.out -t -v
 # bad packets from Hanno Böck
 heap-overflow-1	heap-overflow-1.pcap		heap-overflow-1.out	-t -v -n
 heap-overflow-2	heap-overflow-2.pcap		heap-overflow-2.out	-t -v -n
+heapoverflow-atalk_print	heapoverflow-atalk_print.pcap	heapoverflow-atalk_print.out	-t -v -n
diff --git a/tests/heapoverflow-atalk_print.out b/tests/heapoverflow-atalk_print.out
new file mode 100644
index 00000000..0ddc6417
--- /dev/null
+++ b/tests/heapoverflow-atalk_print.out
@@ -0,0 +1 @@
+et1 AT  [|ddp]
diff --git a/tests/heapoverflow-atalk_print.pcap b/tests/heapoverflow-atalk_print.pcap
new file mode 100644
index 00000000..f9035274
Binary files /dev/null and b/tests/heapoverflow-atalk_print.pcap differ
