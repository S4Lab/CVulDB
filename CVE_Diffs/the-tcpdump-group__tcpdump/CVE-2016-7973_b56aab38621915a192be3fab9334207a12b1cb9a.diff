the-tcpdump-group__tcpdump
commit b56aab38621915a192be3fab9334207a12b1cb9a
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 17:45:06 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:36 2017 +0100

    CVE-2016-7973/Add bounds and length checks.
    
    Fixes heap overflows found with American Fuzzy Lop by Hanno BÃ¶ck.

diff --git a/print-atalk.c b/print-atalk.c
index 8460a4fd..a5ce58a4 100644
--- a/print-atalk.c
+++ b/print-atalk.c
@@ -216,6 +216,15 @@ aarp_print(netdissect_options *ndo,
 
 	ND_PRINT((ndo, "aarp "));
 	ap = (const struct aarp *)bp;
+	if (!ND_TTEST(*ap)) {
+		/* Just bail if we don't have the whole chunk. */
+		ND_PRINT((ndo, " [|aarp]"));
+		return;
+	}
+	if (length < sizeof(*ap)) {	
+		ND_PRINT((ndo, " [|aarp %u]", length));
+		return;
+	}
 	if (EXTRACT_16BITS(&ap->htype) == 1 &&
 	    EXTRACT_16BITS(&ap->ptype) == ETHERTYPE_ATALK &&
 	    ap->halen == 6 && ap->palen == 4 )
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 0442e230..e601f59a 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -389,3 +389,5 @@ tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out
 ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
 llc-xid-heapoverflow	llc-xid-heapoverflow.pcap	llc-xid-heapoverflow.out	-t -v -n
 udp-length-heapoverflow	udp-length-heapoverflow.pcap	udp-length-heapoverflow.out	-t -v -n
+aarp-heapoverflow-1	aarp-heapoverflow-1.pcap	aarp-heapoverflow-1.out	-t -v -n
+aarp-heapoverflow-2	aarp-heapoverflow-2.pcap	aarp-heapoverflow-2.out	-t -v -n
diff --git a/tests/aarp-heapoverflow-1.out b/tests/aarp-heapoverflow-1.out
new file mode 100644
index 00000000..a562223a
--- /dev/null
+++ b/tests/aarp-heapoverflow-1.out
@@ -0,0 +1 @@
+aarp  [|aarp]
diff --git a/tests/aarp-heapoverflow-1.pcap b/tests/aarp-heapoverflow-1.pcap
new file mode 100644
index 00000000..2524efac
Binary files /dev/null and b/tests/aarp-heapoverflow-1.pcap differ
diff --git a/tests/aarp-heapoverflow-2.out b/tests/aarp-heapoverflow-2.out
new file mode 100644
index 00000000..a562223a
--- /dev/null
+++ b/tests/aarp-heapoverflow-2.out
@@ -0,0 +1 @@
+aarp  [|aarp]
diff --git a/tests/aarp-heapoverflow-2.pcap b/tests/aarp-heapoverflow-2.pcap
new file mode 100644
index 00000000..d1b26790
Binary files /dev/null and b/tests/aarp-heapoverflow-2.pcap differ
