the-tcpdump-group__tcpdump
commit cb696b8e91d9860dd30ec3b7dcb16424cd6e18ac
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 17:32:38 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:36 2017 +0100

    CVE-2016-7936/Add a bounds check.
    
    Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.

diff --git a/print-udp.c b/print-udp.c
index 4b5cd7c2..768f4bed 100644
--- a/print-udp.c
+++ b/print-udp.c
@@ -365,6 +365,11 @@ udp_print(netdissect_options *ndo, register const u_char *bp, u_int length,
 	sport = EXTRACT_16BITS(&up->uh_sport);
 	dport = EXTRACT_16BITS(&up->uh_dport);
 
+	if (!ND_TTEST(up->uh_ulen)) {
+		udpipaddr_print(ndo, ip, sport, dport);
+		ND_PRINT((ndo, "[|udp]"));
+		return;
+	}
 	if (length < sizeof(struct udphdr)) {
 		udpipaddr_print(ndo, ip, sport, dport);
 		ND_PRINT((ndo, "truncated-udp %d", length));
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 6e4219e8..0442e230 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -388,3 +388,4 @@ atm-oam-heapoverflow	atm-oam-heapoverflow.pcap	atm-oam-heapoverflow.out	-t -v -n
 tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out	-t -v -n
 ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
 llc-xid-heapoverflow	llc-xid-heapoverflow.pcap	llc-xid-heapoverflow.out	-t -v -n
+udp-length-heapoverflow	udp-length-heapoverflow.pcap	udp-length-heapoverflow.out	-t -v -n
diff --git a/tests/udp-length-heapoverflow.out b/tests/udp-length-heapoverflow.out
new file mode 100644
index 00000000..16dbdc94
--- /dev/null
+++ b/tests/udp-length-heapoverflow.out
@@ -0,0 +1,2 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [none], proto UDP (17), length 12336, bad cksum 3030 (->699d)!)
+    48.48.48.48.12336 > 48.48.48.48.12336: [|udp]
diff --git a/tests/udp-length-heapoverflow.pcap b/tests/udp-length-heapoverflow.pcap
new file mode 100644
index 00000000..5d4be386
Binary files /dev/null and b/tests/udp-length-heapoverflow.pcap differ
