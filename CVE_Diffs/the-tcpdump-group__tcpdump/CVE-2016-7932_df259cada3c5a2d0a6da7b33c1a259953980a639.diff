the-tcpdump-group__tcpdump
commit df259cada3c5a2d0a6da7b33c1a259953980a639
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 12:31:50 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:35 2017 +0100

    CVE-2016-7932/Add some bounds checking.
    
    Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.

diff --git a/print-pim.c b/print-pim.c
index 5ec9c0f7..092c41fe 100644
--- a/print-pim.c
+++ b/print-pim.c
@@ -622,11 +622,16 @@ enum checksum_status {
 };
 
 static enum checksum_status
-pimv2_check_checksum(netdissect_options *ndo, const u_char *bp, const u_char *bp2, u_int len)
+pimv2_check_checksum(netdissect_options *ndo, const u_char *bp,
+		     const u_char *bp2, u_int len)
 {
 	const struct ip *ip;
 	u_int cksum;
 
+	if (!ND_TTEST2(bp[0], len)) {
+		/* We don't have all the data. */
+		return (UNVERIFIED);
+	}
 	ip = (const struct ip *)bp2;
 	if (IP_V(ip) == 4) {
 		struct cksum_vec vec[1];
diff --git a/tests/TESTLIST b/tests/TESTLIST
index d4f4bac1..170b1df5 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -375,3 +375,4 @@ heapoverflow-EXTRACT_16BITS	heapoverflow-EXTRACT_16BITS.pcap	heapoverflow-EXTRAC
 heapoverflow-ppp_hdlc_if_print	heapoverflow-ppp_hdlc_if_print.pcap	heapoverflow-ppp_hdlc_if_print.out	-t -v -n
 heapoverflow-sl_if_print	heapoverflow-sl_if_print.pcap	heapoverflow-sl_if_print.out	-t -v -n
 heapoverflow-ip_print_demux	heapoverflow-ip_print_demux.pcap	heapoverflow-ip_print_demux.out	-t -v -n
+heapoverflow-in_checksum	heapoverflow-in_checksum.pcap	heapoverflow-in_checksum.out	-t -v -n
diff --git a/tests/heapoverflow-in_checksum.out b/tests/heapoverflow-in_checksum.out
new file mode 100644
index 00000000..fffc6920
--- /dev/null
+++ b/tests/heapoverflow-in_checksum.out
@@ -0,0 +1,3 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [DF], proto PIM (103), length 12336, bad cksum 3030 (->2947)!)
+    48.48.48.48 > 48.48.48.48: PIMv2, length 12316
+	Hello, RFC2117-encoding, cksum 0x3030 (unverified)[|pim]
diff --git a/tests/heapoverflow-in_checksum.pcap b/tests/heapoverflow-in_checksum.pcap
new file mode 100644
index 00000000..82a55005
Binary files /dev/null and b/tests/heapoverflow-in_checksum.pcap differ
