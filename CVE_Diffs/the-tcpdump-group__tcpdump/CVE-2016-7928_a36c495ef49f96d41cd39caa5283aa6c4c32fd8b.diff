the-tcpdump-group__tcpdump
commit a36c495ef49f96d41cd39caa5283aa6c4c32fd8b
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 17:14:58 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:36 2017 +0100

    CVE-2016-7928/Check whether we have the CPI before we fetch it.
    
    Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.

diff --git a/print-ipcomp.c b/print-ipcomp.c
index 82469b3f..354eef35 100644
--- a/print-ipcomp.c
+++ b/print-ipcomp.c
@@ -44,22 +44,15 @@ int
 ipcomp_print(netdissect_options *ndo, register const u_char *bp, int *nhdr _U_)
 {
 	register const struct ipcomp *ipcomp;
-	register const u_char *ep;
 	uint16_t cpi;
 #if defined(HAVE_LIBZ) && defined(HAVE_ZLIB_H)
 	int advance;
 #endif
 
 	ipcomp = (const struct ipcomp *)bp;
+	ND_TCHECK(ipcomp->comp_cpi);
 	cpi = EXTRACT_16BITS(&ipcomp->comp_cpi);
 
-	/* 'ep' points to the end of available data. */
-	ep = ndo->ndo_snapend;
-
-	if ((const u_char *)(ipcomp + 1) >= ep - sizeof(struct ipcomp)) {
-		ND_PRINT((ndo, "[|IPCOMP]"));
-		goto fail;
-	}
 	ND_PRINT((ndo, "IPComp(cpi=0x%04x)", cpi));
 
 #if defined(HAVE_LIBZ) && defined(HAVE_ZLIB_H)
@@ -79,6 +72,10 @@ ipcomp_print(netdissect_options *ndo, register const u_char *bp, int *nhdr _U_)
 	return advance;
 
 #endif
+trunc:
+	ND_PRINT((ndo, "[|IPCOMP]"));
+#if defined(HAVE_LIBZ) && defined(HAVE_ZLIB_H)
 fail:
+#endif
 	return -1;
 }
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 15c50104..c137e8d5 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -386,3 +386,4 @@ isoclns-heapoverflow	isoclns-heapoverflow.pcap	isoclns-heapoverflow.out	-t -v -n
 tcp-auth-heapoverflow	tcp-auth-heapoverflow.pcap	tcp-auth-heapoverflow.out	-t -v -n
 atm-oam-heapoverflow	atm-oam-heapoverflow.pcap	atm-oam-heapoverflow.out	-t -v -n
 tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out	-t -v -n
+ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
diff --git a/tests/ipcomp-heapoverflow.out b/tests/ipcomp-heapoverflow.out
new file mode 100644
index 00000000..c158cdf5
--- /dev/null
+++ b/tests/ipcomp-heapoverflow.out
@@ -0,0 +1,2 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [none], proto Compressed IP (108), length 12336, bad cksum 3030 (->6942)!)
+    48.48.48.48 > 48.48.48.48: [|IPCOMP]
diff --git a/tests/ipcomp-heapoverflow.pcap b/tests/ipcomp-heapoverflow.pcap
new file mode 100644
index 00000000..dc2d17d1
Binary files /dev/null and b/tests/ipcomp-heapoverflow.pcap differ
