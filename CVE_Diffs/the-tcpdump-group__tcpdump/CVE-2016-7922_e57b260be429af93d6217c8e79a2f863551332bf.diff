the-tcpdump-group__tcpdump
commit e57b260be429af93d6217c8e79a2f863551332bf
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 13:20:28 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:36 2017 +0100

    CVE-2016-7922/Report to our caller that dissection failed if a bounds check fails.
    
    That way, our caller doesn't keep dissecting.

diff --git a/print-ah.c b/print-ah.c
index 26bc43ec..a23abb49 100644
--- a/print-ah.c
+++ b/print-ah.c
@@ -54,8 +54,10 @@ ah_print(netdissect_options *ndo, register const u_char *bp)
 	if (ndo->ndo_vflag)
 		ND_PRINT((ndo, ",sumlen=%d", sumlen));
 	ND_PRINT((ndo, ",seq=0x%x", EXTRACT_32BITS(ah + 1)));
-	if (bp + sizeof(struct ah) + sumlen > ep)
-		ND_PRINT((ndo, "[truncated]"));
+	if (!ND_TTEST2(*bp, sizeof(struct ah) + sumlen)) {
+		ND_PRINT((ndo, "[truncated]):"));
+		return -1;
+	}
 	ND_PRINT((ndo, "): "));
 
 	return sizeof(struct ah) + sumlen;
