the-tcpdump-group__tcpdump
commit e8a77162825188bd31eb96c99dc8e4432a2c6531
Author:     Guy Harris <guy@alum.mit.edu>
AuthorDate: Fri Jul 3 19:08:59 2015 -0700
Commit:     Francois-Xavier Le Bail <fx.lebail@yahoo.com>
CommitDate: Wed Jan 18 09:16:37 2017 +0100

    CVE-2016-7974/Don't try to dissect something with other than 4 as the IP version.
    
    Bad Things could happen, e.g. the dissector we call thinking it's been
    handed an IPv6 header when we haven't handed it anything that large.
    
    Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
    
    Update some .out files to correspond to that change.

diff --git a/print-ip.c b/print-ip.c
index cbcdab85..38cc2315 100644
--- a/print-ip.c
+++ b/print-ip.c
@@ -530,13 +530,14 @@ ip_print(netdissect_options *ndo,
 
 	ipds->ip = (const struct ip *)bp;
 	ND_TCHECK(ipds->ip->ip_vhl);
-	if (IP_V(ipds->ip) != 4) { /* print version if != 4 */
+	if (IP_V(ipds->ip) != 4) { /* print version and fail if != 4 */
 	    if (IP_V(ipds->ip) == 6)
 	      ND_PRINT((ndo, "IP6, wrong link-layer encapsulation "));
 	    else
 	      ND_PRINT((ndo, "IP%u ", IP_V(ipds->ip)));
+	    return;
 	}
-	else if (!ndo->ndo_eflag)
+	if (!ndo->ndo_eflag)
 		ND_PRINT((ndo, "IP "));
 
 	ND_TCHECK(*ipds->ip);
diff --git a/tests/TESTLIST b/tests/TESTLIST
index d9751c90..2d8ecdf9 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -392,3 +392,4 @@ udp-length-heapoverflow	udp-length-heapoverflow.pcap	udp-length-heapoverflow.out
 aarp-heapoverflow-1	aarp-heapoverflow-1.pcap	aarp-heapoverflow-1.out	-t -v -n
 aarp-heapoverflow-2	aarp-heapoverflow-2.pcap	aarp-heapoverflow-2.out	-t -v -n
 mpls-label-heapoverflow	mpls-label-heapoverflow.pcap	mpls-label-heapoverflow.out	-t -v -n
+bad-ipv4-version-pgm-heapoverflow	bad-ipv4-version-pgm-heapoverflow.pcap	bad-ipv4-version-pgm-heapoverflow.out	-t -v -n
diff --git a/tests/bad-ipv4-version-pgm-heapoverflow.out b/tests/bad-ipv4-version-pgm-heapoverflow.out
new file mode 100644
index 00000000..7655a51f
--- /dev/null
+++ b/tests/bad-ipv4-version-pgm-heapoverflow.out
@@ -0,0 +1 @@
+IP6, wrong link-layer encapsulation 
diff --git a/tests/bad-ipv4-version-pgm-heapoverflow.pcap b/tests/bad-ipv4-version-pgm-heapoverflow.pcap
new file mode 100644
index 00000000..43323473
Binary files /dev/null and b/tests/bad-ipv4-version-pgm-heapoverflow.pcap differ
diff --git a/tests/gre-heapoverflow-1.out b/tests/gre-heapoverflow-1.out
index a9b7fd3c..322c329a 100644
--- a/tests/gre-heapoverflow-1.out
+++ b/tests/gre-heapoverflow-1.out
@@ -5,5 +5,4 @@
 	0x0030:  3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
 	0x0040:  3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
 	0x0050:  3030 3030                                0000
-IP0 (tos 0x30, ttl 48, id 12336, offset 0, flags [none], proto GRE (47), length 12336, options (unknown 48 [bad length 48]), bad cksum 3030 (->855e)!)
-    48.48.48.48 > 48.48.48.48: GREv0, Flags [checksum present, routing present, sequence# present, source routing present][|gre]
+IP0 
diff --git a/tests/heap-overflow-2.out b/tests/heap-overflow-2.out
index d2fd93f2..1e7e21b2 100644
--- a/tests/heap-overflow-2.out
+++ b/tests/heap-overflow-2.out
@@ -1 +1 @@
-IP3 [|ip]
+IP3 
diff --git a/tests/kday1.out b/tests/kday1.out
index eaaacaa5..9cb884d4 100644
--- a/tests/kday1.out
+++ b/tests/kday1.out
@@ -1,15 +1,2 @@
-IP6, wrong link-layer encapsulation (tos 0x10, ttl 192, id 63177, offset 0, flags [DF], proto SCTP (132), length 168, options (security [bad length 110]), bad cksum a291 (->9204)!)
-    c084:a291:b8aa:42aa:3e38:9ac7:826e:b930.33943 > 8497:1a30:7cd4:d4d4:d4d4:d428:13:68.6704: sctp[ForCES HP] (1) [DATA] (B)(E) [TSN: 1934917887] [SID: 256] [SSEQ 15360] [PPID 0x3c00] 
-	ForCES Config 
-	ForCES Version 14 len 88B flags 0x0a040604 
-	SrcID 0xff000200(AllMulticast) DstID 0xb59cbe(FE) Correlator 0x30480805f4010800
-		Messy oper TLV header, type (0x600)
-		excess of -240 Bytes 
-	[0x0000:  e803 0016 ff00 0200 00b5 9cbe 3048 0805
-	[0x0010:  f401 0800 0a04 0604 0010 003c 0000 3ce8
-	[0x0020:  0300 3c00 000e 0016 0604 0010 003c 0000
-	[0x0030:  0000 ff00 ffff a69c be30 4808 0600 0108
-	[0x0040:  0006 0400 0184 b59c be30 84b5 0010 0000
-	[0x0050:  cc05 367e 0003 0000
-	][|sctp]
+IP6, wrong link-layer encapsulation 
 EXIT CODE 00000100
diff --git a/tests/kday3.out b/tests/kday3.out
index 61578d5f..95909e06 100644
--- a/tests/kday3.out
+++ b/tests/kday3.out
@@ -1,7 +1,6 @@
 IP (tos 0x10, ttl 64, id 63177, offset 0, flags [DF], proto TCP (6), length 168)
     204.9.54.80.22 > 204.9.51.132.50079: Flags [P.], cksum 0x0282 (incorrect -> 0x3217), seq 1819218606:1819218722, ack 1238485076, win 1039, options [nop,nop,TS val 1340592078 ecr 941371882], length 116
-IP6, wrong link-layer encapsulation (tos 0x10, ttl 62, id 64806, offset 0, flags [DF], proto TCP (6), length 52, options (unknown 195 [bad length 159]), bad cksum 3da6 (->45ca)!)
-    27759 > 4782:  tcp 24 [bad hdr length 0 - too short, < 20]
+IP6, wrong link-layer encapsulation 
 IP (tos 0x10, ttl 62, id 62920, offset 0, flags [DF], proto TCP (6), length 52, bad cksum 4504 (->451a)!)
     204.9.51.132.50079 > 204.243.53.80.22: Flags [.], cksum 0x858b (incorrect -> 0x85a1), ack 1819218722, win 4092, options [nop,nop,TS val 941371913 ecr 1340592084], length 0
 IP (tos 0x0, ttl 64, id 63178, offset 0, flags [DF], proto TCP (6), length 52, bad cksum 3e8c (->438c)!)
