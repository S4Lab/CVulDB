tigeli__bind-utils
commit 12df718c23e29b16fcb5c12eace4b4a924de104d
Author:     Evan Hunt <each@isc.org>
AuthorDate: Tue Feb 3 18:32:05 2015 -0800
Commit:     Evan Hunt <each@isc.org>
CommitDate: Tue Feb 3 18:32:05 2015 -0800

    [v9_10_1_patch] avoid crash due to managed-key rollover
    
    4053.   [security]      Revoking a managed trust anchor and supplying
                            an untrusted replacement could cause named
                            to crash with an assertion failure.
                            (CVE-2015-1349) [RT #38344]

diff --git a/CHANGES b/CHANGES
index 1234469419..fc58de76f5 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,3 +1,10 @@
+	--- 9.10.1-P2 released ---
+
+4053.	[security]	Revoking a managed trust anchor and supplying
+			an untrusted replacement could cause named
+			to crash with an assertion failure.
+			(CVE-2015-1349) [RT #38344]
+
 	--- 9.10.1-P1 released ---
 
 4006.	[security]	A flaw in delegation handling could be exploited
diff --git a/lib/dns/zone.c b/lib/dns/zone.c
index ef604542ad..2c4558ee07 100644
--- a/lib/dns/zone.c
+++ b/lib/dns/zone.c
@@ -8946,6 +8946,12 @@ keyfetch_done(isc_task_t *task, isc_event_t *event) {
 					     namebuf, tag);
 				trustkey = ISC_TRUE;
 			}
+		} else {
+			/*
+			 * No previously known key, and the key is not
+			 * secure, so skip it.
+			 */
+			continue;
 		}
 
 		/* Delete old version */
@@ -8994,7 +9000,7 @@ keyfetch_done(isc_task_t *task, isc_event_t *event) {
 			trust_key(zone, keyname, &dnskey, mctx);
 		}
 
-		if (!deletekey) {
+		if (secure && !deletekey) {
 			INSIST(newkey || updatekey);
 			set_refreshkeytimer(zone, &keydata, now);
 		}
