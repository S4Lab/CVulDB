riscv__riscv-qemu
commit e6908bfe8e07f2b452e78e677da1b45b1c0f6829
Author:     Petr Matousek <pmatouse@redhat.com>
AuthorDate: Mon Oct 27 12:41:44 2014 +0100
Commit:     Gerd Hoffmann <kraxel@redhat.com>
CommitDate: Tue Oct 28 11:51:04 2014 +0100

    vnc: sanitize bits_per_pixel from the client
    
    bits_per_pixel that are less than 8 could result in accessing
    non-initialized buffers later in the code due to the expectation
    that bytes_per_pixel value that is used to initialize these buffers is
    never zero.
    
    To fix this check that bits_per_pixel from the client is one of the
    values that the rfb protocol specification allows.
    
    This is CVE-2014-7815.
    
    Signed-off-by: Petr Matousek <pmatouse@redhat.com>
    
    [ kraxel: apply codestyle fix ]
    
    Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>

diff --git a/ui/vnc.c b/ui/vnc.c
index 0fe6eff1b8..8bca59798c 100644
--- a/ui/vnc.c
+++ b/ui/vnc.c
@@ -2026,6 +2026,16 @@ static void set_pixel_format(VncState *vs,
         return;
     }
 
+    switch (bits_per_pixel) {
+    case 8:
+    case 16:
+    case 32:
+        break;
+    default:
+        vnc_client_error(vs);
+        return;
+    }
+
     vs->client_pf.rmax = red_max;
     vs->client_pf.rbits = hweight_long(red_max);
     vs->client_pf.rshift = red_shift;
