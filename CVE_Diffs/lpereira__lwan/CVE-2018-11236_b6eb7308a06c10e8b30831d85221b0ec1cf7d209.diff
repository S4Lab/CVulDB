lpereira__lwan
commit b6eb7308a06c10e8b30831d85221b0ec1cf7d209
Author:     Leandro Pereira <leandro@hardinfo.org>
AuthorDate: Sun Aug 26 10:58:59 2018 -0700
Commit:     Leandro Pereira <leandro@hardinfo.org>
CommitDate: Sun Aug 26 11:01:41 2018 -0700

    Fix integer addition overflow in realpathat()
    
    This mirrors the change made by Paul Pluzhnikov
    <ppluzhnikov@google.com> to glibc in upstream commit 5460617d (bugzilla
    22786[1]), fixing CVE-2018-11236[2].
    
    [1] https://sourceware.org/bugzilla/show_bug.cgi?id=22786
    [2] https://nvd.nist.gov/vuln/detail/CVE-2018-11236

diff --git a/src/lib/realpathat.c b/src/lib/realpathat.c
index 8984fce..6c08ca8 100644
--- a/src/lib/realpathat.c
+++ b/src/lib/realpathat.c
@@ -160,7 +160,7 @@ realpathat2(int dirfd, char *dirfdpath, const char *name, char *resolved,
                 buf[n] = '\0';
 
                 len = strlen(end);
-                if (UNLIKELY((long int) (n + (long int)len) >= PATH_MAX)) {
+                if (UNLIKELY(PATH_MAX - n <= len)) {
                     errno = ENAMETOOLONG;
                     goto error;
                 }
