gnif__mod_rpaf
commit e71e4fe7675c73c198b1e0a51315bf9416d481f6
Author:     Phillipp Röll <phillipp.roell@trafficplex.de>
AuthorDate: Sat Aug 16 18:54:06 2014 +0200
Commit:     Phillipp Röll <phillipp.roell@trafficplex.de>
CommitDate: Sat Aug 16 18:54:06 2014 +0200

    applies an extract of debian 030_ipv6.patch
    
    this fixed the CVE-2012-3526. 030_ipv6.patch was not applying cleanly.
    original bug from http://zecrazytux.net/troubleshooting/apache2-segfault-debugging-tutorial

diff --git a/mod_rpaf.c b/mod_rpaf.c
index 037b386..360d8e9 100644
--- a/mod_rpaf.c
+++ b/mod_rpaf.c
@@ -219,9 +219,10 @@ static int change_remote_ip(request_rec *r) {
 
             tmppool = r->connection->remote_addr->pool;
             tmpport = r->connection->remote_addr->port;
-            memset(r->connection->remote_addr, '\0', sizeof(apr_sockaddr_t));
-            r->connection->remote_addr = NULL;
-            apr_sockaddr_info_get(&(r->connection->remote_addr), r->connection->remote_ip, APR_UNSPEC, tmpport, 0, tmppool);
+            apr_sockaddr_t *tmpsa;
+            int ret = apr_sockaddr_info_get(&tmpsa, r->connection->remote_ip, APR_UNSPEC, tmpport, 0, tmppool);
+            if (ret == APR_SUCCESS)
+                memcpy(r->connection->remote_addr, tmpsa, sizeof(apr_sockaddr_t));
             if (cfg->sethostname) {
                 const char *hostvalue;
                 if ((hostvalue = apr_table_get(r->headers_in, "X-Forwarded-Host")) ||
