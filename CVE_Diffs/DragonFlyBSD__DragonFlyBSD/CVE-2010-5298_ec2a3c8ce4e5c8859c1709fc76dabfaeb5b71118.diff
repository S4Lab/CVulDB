DragonFlyBSD__DragonFlyBSD
commit ec2a3c8ce4e5c8859c1709fc76dabfaeb5b71118
Author:     Sascha Wildner <saw@online.de>
AuthorDate: Wed Apr 30 10:58:52 2014 +0200
Commit:     Sascha Wildner <saw@online.de>
CommitDate: Wed Apr 30 11:08:07 2014 +0200

    OpenSSL: Add fix for CVE-2010-5298.

diff --git a/crypto/openssl/ssl/s3_pkt.c b/crypto/openssl/ssl/s3_pkt.c
index 96ba63262e..180ec217ca 100644
--- a/crypto/openssl/ssl/s3_pkt.c
+++ b/crypto/openssl/ssl/s3_pkt.c
@@ -1055,7 +1055,8 @@ int ssl3_read_bytes(SSL *s, int type, unsigned char *buf, int len, int peek)
 				{
 				s->rstate=SSL_ST_READ_HEADER;
 				rr->off=0;
-				if (s->mode & SSL_MODE_RELEASE_BUFFERS)
+				if (s->mode & SSL_MODE_RELEASE_BUFFERS &&
+				    s->s3->rbuf.left == 0)
 					ssl3_release_read_buffer(s);
 				}
 			}
