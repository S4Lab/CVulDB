DragonFlyBSD__DragonFlyBSD
commit fd17ab246da5e83c006c3dcc23bee06babb9b6e2
Author:     Antonio Huete Jimenez <tuxillo@quantumachine.net>
AuthorDate: Wed Jan 29 17:52:50 2020 +0100
Commit:     Antonio Huete Jimenez <tuxillo@quantumachine.net>
CommitDate: Wed Jan 29 18:09:20 2020 +0100

    libfetch: Fix buffer overflow (CVE-2020-7450)
    
      - A remote attacker, who can supply a malicious URL to the application
        that uses libfetch(3), can trigger memory corruption and execute arbitrary
        code on the target system.
      - FreeBSD-SA-20:01.libfetch
    
    Submitted-by: bapt, emaste

diff --git a/lib/libfetch/fetch.c b/lib/libfetch/fetch.c
index f1605ed9bc..b78776ef7d 100644
--- a/lib/libfetch/fetch.c
+++ b/lib/libfetch/fetch.c
@@ -331,6 +331,8 @@ fetch_pctdecode(char *dst, const char *src, size_t dlen)
 		}
 		if (dlen-- > 0)
 			*dst++ = c;
+		else
+			return (NULL);
 	}
 	return (s);
 }
@@ -380,11 +382,15 @@ fetchParseURL(const char *URL)
 	if (p && *p == '@') {
 		/* username */
 		q = fetch_pctdecode(u->user, URL, URL_USERLEN);
+		if (q == NULL)
+			goto ouch;
 
 		/* password */
-		if (*q == ':')
+		if (*q == ':') {
 			q = fetch_pctdecode(u->pwd, q + 1, URL_PWDLEN);
-
+			if (q == NULL)
+				goto ouch;
+		}
 		p++;
 	} else {
 		p = URL;
