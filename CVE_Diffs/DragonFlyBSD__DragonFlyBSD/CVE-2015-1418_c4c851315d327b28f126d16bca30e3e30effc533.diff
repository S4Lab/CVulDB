DragonFlyBSD__DragonFlyBSD
commit c4c851315d327b28f126d16bca30e3e30effc533
Author:     Matthew Dillon <dillon@apollo.backplane.com>
AuthorDate: Fri Aug 14 20:29:32 2015 -0700
Commit:     Matthew Dillon <dillon@apollo.backplane.com>
CommitDate: Fri Aug 14 20:31:36 2015 -0700

    patch - Fix shell injection vulnerability
    
    * Fix shell injection vulnerability in patch(1) via ed(1) by
      tightening sanity check of the input. [1]
    
    * While I'm there also replace ed(1) with red(1) because we do
      not need the unrestricted functionality.
    
    Obtained from: Bitrig [1], and discussions w/ FreeBSD
    Security: CVE-2015-1418 [1]

diff --git a/usr.bin/patch/pathnames.h b/usr.bin/patch/pathnames.h
index 247142abf4..c9e5f7f7ee 100644
--- a/usr.bin/patch/pathnames.h
+++ b/usr.bin/patch/pathnames.h
@@ -10,4 +10,4 @@
 
 #include <paths.h>
 
-#define	_PATH_ED		"/bin/ed"
+#define	_PATH_RED		"/bin/red"
diff --git a/usr.bin/patch/pch.c b/usr.bin/patch/pch.c
index 20f771dfcc..97d43bd184 100644
--- a/usr.bin/patch/pch.c
+++ b/usr.bin/patch/pch.c
@@ -1417,13 +1417,14 @@ do_ed_script(void)
 	char	*t;
 	long	beginning_of_this_line;
 	FILE	*pipefp = NULL;
+	int	continuation;
 
 	if (!skip_rest_of_patch) {
 		if (copy_file(filearg[0], TMPOUTNAME) < 0) {
 			unlink(TMPOUTNAME);
 			fatal("can't create temp file %s", TMPOUTNAME);
 		}
-		snprintf(buf, buf_size, "%s%s%s", _PATH_ED,
+		snprintf(buf, buf_size, "%s%s%s", _PATH_RED,
 		    verbose ? " " : " -s ", TMPOUTNAME);
 		pipefp = popen(buf, "w");
 	}
@@ -1441,7 +1442,18 @@ do_ed_script(void)
 		    *t == 'd' || *t == 'i' || *t == 's')) {
 			if (pipefp != NULL)
 				fputs(buf, pipefp);
-			if (*t != 'd') {
+			if (*t == 's') {
+				for (;;) {
+					continuation = 0;
+					t = strchr(buf, '\0') - 1;
+					while (--t >= buf && *t == '\\')
+						continuation = !continuation;
+					if (!continuation || !pgets(true))
+						break;
+					if (pipefp != NULL)
+						fputs(buf, pipefp);
+				}
+			} else if (*t != 'd') {
 				while (pgets(true)) {
 					p_input_line++;
 					if (pipefp != NULL)
