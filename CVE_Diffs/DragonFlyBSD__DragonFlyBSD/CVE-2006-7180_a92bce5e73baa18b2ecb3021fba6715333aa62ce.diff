DragonFlyBSD__DragonFlyBSD
commit a92bce5e73baa18b2ecb3021fba6715333aa62ce
Author:     Sepherosa Ziehau <sephe@dragonflybsd.org>
AuthorDate: Wed Aug 22 13:41:10 2007 +0000
Commit:     Sepherosa Ziehau <sephe@dragonflybsd.org>
CommitDate: Wed Aug 22 13:41:10 2007 +0000

    Fix for CVE-2006-7180
    
    Obtained-from: MadWifi via Sam Leffler

diff --git a/sys/netproto/802_11/wlan/ieee80211_output.c b/sys/netproto/802_11/wlan/ieee80211_output.c
index b5644e0587..44990366de 100644
--- a/sys/netproto/802_11/wlan/ieee80211_output.c
+++ b/sys/netproto/802_11/wlan/ieee80211_output.c
@@ -30,7 +30,7 @@
  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
  * $FreeBSD: src/sys/net80211/ieee80211_output.c,v 1.26.2.8 2006/09/02 15:06:04 sam Exp $
- * $DragonFly: src/sys/netproto/802_11/wlan/ieee80211_output.c,v 1.22 2007/08/22 13:24:44 sephe Exp $
+ * $DragonFly: src/sys/netproto/802_11/wlan/ieee80211_output.c,v 1.23 2007/08/22 13:41:10 sephe Exp $
  */
 
 #include "opt_inet.h"
@@ -528,6 +528,7 @@ ieee80211_encap(struct ieee80211com *ic, struct mbuf *m,
 			    eh.ether_dhost, ":", __func__,
 			    ic->ic_def_txkey);
 			ic->ic_stats.is_tx_nodefkey++;
+			goto bad;
 		}
 	} else
 		key = NULL;
