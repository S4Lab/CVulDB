DragonFlyBSD__DragonFlyBSD
commit 20a687ecf7164743c5436281e1e16ddd591026ba
Author:     Peter Avalos <pavalos@dragonflybsd.org>
AuthorDate: Sat Apr 19 15:02:20 2008 +0000
Commit:     Peter Avalos <pavalos@dragonflybsd.org>
CommitDate: Sat Apr 19 15:02:20 2008 +0000

    Fix for CVE-2008-1657:
    
    "OpenSSH before 4.9 allows remote authenticated users to bypass the
    sshd_config ForceCommand directive by modifying the .ssh/rc session file."
    
    Obtained-from: OpenBSD

diff --git a/crypto/openssh-4/session.c b/crypto/openssh-4/session.c
index 4c97c4a7dd..ce9590b3e2 100644
--- a/crypto/openssh-4/session.c
+++ b/crypto/openssh-4/session.c
@@ -1201,8 +1201,9 @@ do_rc_files(Session *s, const char *shell)
 	do_xauth =
 	    s->display != NULL && s->auth_proto != NULL && s->auth_data != NULL;
 
-	/* ignore _PATH_SSH_USER_RC for subsystems */
-	if (!s->is_subsystem && (stat(_PATH_SSH_USER_RC, &st) >= 0)) {
+	/* ignore _PATH_SSH_USER_RC for subsystems and admin forced commands */
+	if (!s->is_subsystem && options.adm_forced_command == NULL &&
+	    (stat(_PATH_SSH_USER_RC, &st) >= 0)) {
 		snprintf(cmd, sizeof cmd, "%s -c '%s %s'",
 		    shell, _PATH_BSHELL, _PATH_SSH_USER_RC);
 		if (debug_flag)
