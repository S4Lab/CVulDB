DragonFlyBSD__DragonFlyBSD
commit e0bc5ce42961c11e469c9d889c930ea32cd27c7b
Author:     Simon Schubert <corecode@dragonflybsd.org>
AuthorDate: Wed Sep 6 13:28:00 2006 +0000
Commit:     Simon Schubert <corecode@dragonflybsd.org>
CommitDate: Wed Sep 6 13:28:00 2006 +0000

    Fix OpenSSL RSA Signature Forgery (CVE-2006-4339)
    
    Reported-by: cghene on #dragonflybsd

diff --git a/secure/lib/libcrypto/Makefile b/secure/lib/libcrypto/Makefile
index 1c6afbe7cc..d3046398ad 100644
--- a/secure/lib/libcrypto/Makefile
+++ b/secure/lib/libcrypto/Makefile
@@ -1,5 +1,5 @@
 # $FreeBSD: src/secure/lib/libcrypto/Makefile,v 1.15.2.14 2003/02/14 22:38:14 nectar Exp $
-# $DragonFly: src/secure/lib/libcrypto/Makefile,v 1.8 2005/12/03 14:06:13 corecode Exp $
+# $DragonFly: src/secure/lib/libcrypto/Makefile,v 1.8.2.1 2006/09/06 13:28:00 corecode Exp $
 
 LIB=		crypto
 SHLIB_MAJOR=	4
@@ -12,6 +12,8 @@ NOLINT=		true
 
 .include "Makefile.inc"
 
+CONTRIBDIR= ${LCRYPTO_SRC}
+
 # base sources
 SRCS+=	cpt_err.c cryptlib.c cversion.c ebcdic.c ex_data.c mem.c mem_clr.c \
 	mem_dbg.c o_dir.c o_time.c tmdiff.c uid.c
@@ -184,7 +186,7 @@ SRCS+=	rmd_dgst.c rmd_one.c
 # rsa
 SRCS+=	rsa_asn1.c rsa_chk.c rsa_depr.c rsa_eay.c rsa_err.c rsa_gen.c \
 	rsa_lib.c rsa_none.c rsa_null.c rsa_oaep.c rsa_pk1.c rsa_pss.c \
-	rsa_saos.c rsa_sign.c rsa_ssl.c rsa_x931.c
+	rsa_saos.c crypto,rsa,rsa_sign.c.patch rsa_ssl.c rsa_x931.c
 
 # sha
 SRCS+=	sha1_one.c sha1dgst.c sha256.c sha512.c sha_dgst.c sha_one.c
diff --git a/secure/lib/libcrypto/crypto,rsa,rsa_sign.c.patch b/secure/lib/libcrypto/crypto,rsa,rsa_sign.c.patch
new file mode 100644
index 0000000000..7d2a8871c4
--- /dev/null
+++ b/secure/lib/libcrypto/crypto,rsa,rsa_sign.c.patch
@@ -0,0 +1,54 @@
+$DragonFly: src/secure/lib/libcrypto/Attic/crypto,rsa,rsa_sign.c.patch,v 1.1.4.2 2006/09/06 13:28:00 corecode Exp $
+-----BEGIN PGP SIGNED MESSAGE-----
+Hash: SHA1
+
+
+http://www.openssl.org/news/secadv_20060905.txt
+
+(This patch was updated Tue Sep  5 15:54:30 UTC 2006 to also work
+against 0.9.6)
+
+(This patch was updated Wed Sep 6 08:37:55 UTC 2006 to remove the
+changes to rsa_eay.c/rsa.h/rsa_err.c which were not necessary to
+correct this vulnerability)
+
+Index: crypto/rsa/rsa_sign.c
+===================================================================
+RCS file: /e/openssl/cvs/openssl/crypto/rsa/rsa_sign.c,v
+retrieving revision 1.21
+diff -u -r1.21 rsa_sign.c
+- - - --- crypto/rsa/rsa_sign.c	26 Apr 2005 22:07:17 -0000	1.21
++++ crypto/rsa/rsa_sign.c	4 Sep 2006 15:16:57 -0000
+@@ -185,6 +185,23 @@
+ 		sig=d2i_X509_SIG(NULL,&p,(long)i);
+ 
+ 		if (sig == NULL) goto err;
++
++		/* Excess data can be used to create forgeries */
++		if(p != s+i)
++			{
++			RSAerr(RSA_F_RSA_VERIFY,RSA_R_BAD_SIGNATURE);
++			goto err;
++			}
++
++		/* Parameters to the signature algorithm can also be used to
++		   create forgeries */
++		if(sig->algor->parameter
++		   && sig->algor->parameter->type != V_ASN1_NULL)
++			{
++			RSAerr(RSA_F_RSA_VERIFY,RSA_R_BAD_SIGNATURE);
++			goto err;
++			}
++
+ 		sigtype=OBJ_obj2nid(sig->algor->algorithm);
+ 
+
+-----BEGIN PGP SIGNATURE-----
+Version: GnuPG v1.4.2.2 (GNU/Linux)
+
+iQCVAwUBRP6JWe6tTP1JpWPZAQLssAP+LZH3morviQ2DEN7yWRpVuCsP31850Ma7
+9OjH1wEkAbA3rX2XmDxYFd6dJBanksgdXUqLHlm8w8Q9aA+FKPmyFSaQ74N7nHgE
+iDGws5w1PE1U/sigQvz9FoY5DgCU0l/L+MOoj+UaIiueafLCgO4VpwB1EftXymsS
+eCQDyyI37rE=
+=MXpR
+-----END PGP SIGNATURE-----
