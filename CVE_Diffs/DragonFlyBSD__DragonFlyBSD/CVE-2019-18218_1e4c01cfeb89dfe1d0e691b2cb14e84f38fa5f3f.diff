DragonFlyBSD__DragonFlyBSD
commit 1e4c01cfeb89dfe1d0e691b2cb14e84f38fa5f3f
Author:     Sascha Wildner <saw@online.de>
AuthorDate: Sun Nov 3 13:31:12 2019 +0100
Commit:     Sascha Wildner <saw@online.de>
CommitDate: Sun Nov 3 13:32:35 2019 +0100

    file(1): Fix CVE-2019-18218.
    
    For further details see:
    
    https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-18218
    https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=16780
    
    Reported-by: zrj

diff --git a/contrib/file/src/cdf.c b/contrib/file/src/cdf.c
index accfb325b9..7b18ac085d 100644
--- a/contrib/file/src/cdf.c
+++ b/contrib/file/src/cdf.c
@@ -1000,8 +1000,9 @@ cdf_read_property_info(const cdf_stream_t *sst, const cdf_header_t *h,
 				goto out;
 			}
 			nelements = CDF_GETUINT32(q, 1);
-			if (nelements == 0) {
-				DPRINTF(("CDF_VECTOR with nelements == 0\n"));
+			if (nelements > CDF_ELEMENT_LIMIT || nelements == 0) {
+				DPRINTF(("CDF_VECTOR with nelements == %"
+				    SIZE_T_FORMAT "u\n", nelements));
 				goto out;
 			}
 			slen = 2;
@@ -1043,8 +1044,6 @@ cdf_read_property_info(const cdf_stream_t *sst, const cdf_header_t *h,
 					goto out;
 				inp += nelem;
 			}
-			DPRINTF(("nelements = %" SIZE_T_FORMAT "u\n",
-			    nelements));
 			for (j = 0; j < nelements && i < sh.sh_properties;
 			    j++, i++)
 			{
diff --git a/contrib/file/src/cdf.h b/contrib/file/src/cdf.h
index f2df8306b1..3ff555b1f7 100644
--- a/contrib/file/src/cdf.h
+++ b/contrib/file/src/cdf.h
@@ -48,6 +48,7 @@
 typedef int32_t cdf_secid_t;
 
 #define CDF_LOOP_LIMIT					10000
+#define CDF_ELEMENT_LIMIT				100000
 
 #define CDF_SECID_NULL					0
 #define CDF_SECID_FREE					-1
