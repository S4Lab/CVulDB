DragonFlyBSD__DragonFlyBSD
commit 4aea093ab000a69c4b50678bf207d046dfdb8428
Author:     Aggelos Economopoulos <aoiko@cc.ece.ntua.gr>
AuthorDate: Wed May 30 16:03:21 2012 +0200
Commit:     Sascha Wildner <saw@online.de>
CommitDate: Thu May 31 18:31:06 2012 +0200

    Fix for password truncation when using crypt(3) with DES
    
    Passwords containing a 0x80 byte (UTF-8 encoded ones, ASCII and
    ISO-8859-* not affected) would get truncated as if a '\0' byte
    had been encountered. This could result in some very weak passwords.
    
    Reported-by: Rubin Xu, Joseph Bonneau, Donting Yu (CVE-2012-2143)

diff --git a/secure/lib/libcrypt/crypt-des.c b/secure/lib/libcrypt/crypt-des.c
index 93877514da..a1e93d3442 100644
--- a/secure/lib/libcrypt/crypt-des.c
+++ b/secure/lib/libcrypt/crypt-des.c
@@ -602,7 +602,8 @@ crypt_des(const char *key, const char *setting)
 	 */
 	q = (u_char *) keybuf;
 	while (q - (u_char *) keybuf - 8) {
-		if ((*q++ = *key << 1))
+		*q++ = *key << 1;
+		if (*key != '\0')
 			key++;
 	}
 	if (des_setkey((u_char *) keybuf))
