DragonFlyBSD__DragonFlyBSD
commit 75df574506ea14695f2e86f863d312d284086d6d
Author:     Peter Avalos <pavalos@dragonflybsd.org>
AuthorDate: Fri Dec 23 10:16:31 2011 -0800
Commit:     Peter Avalos <pavalos@dragonflybsd.org>
CommitDate: Fri Dec 23 10:24:17 2011 -0800

    telnetd:  Validate key length prior to copying into a fixed buffer.
    
    It's possible for a remote attacker to execute arbitrary code with the
    privileges of the telnetd daemon (normally root) prior to this fix.
    CVE-2011-4862
    
    Obtained-from:   FreeBSD-SA-11:08.telnetd

diff --git a/lib/libtelnet/encrypt.c b/lib/libtelnet/encrypt.c
index 8b5666d956..49f513be82 100644
--- a/lib/libtelnet/encrypt.c
+++ b/lib/libtelnet/encrypt.c
@@ -714,6 +714,9 @@ encrypt_keyid(struct key_info *kp, unsigned char *keyid, int len)
 	int dir = kp->dir;
 	int ret = 0;
 
+	if (len > MAXKEYLEN)
+		len = MAXKEYLEN;
+
 	if (!(ep = (*kp->getcrypt)(*kp->modep))) {
 		if (len == 0)
 			return;
