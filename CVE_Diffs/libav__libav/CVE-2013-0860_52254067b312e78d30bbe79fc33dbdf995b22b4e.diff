libav__libav
commit 52254067b312e78d30bbe79fc33dbdf995b22b4e
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Wed Aug 6 18:19:57 2014 +0100
Commit:     Anton Khirnov <anton@khirnov.net>
CommitDate: Wed Aug 6 19:25:56 2014 +0000

    error_concealment: avoid using the picture if not fully setup
    
    Fixes state becoming inconsistent and a null pointer dereference.
    
    CC: libav-stable@libav.org
    Bug-Id: CVE-2013-0860
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Vittorio Giovara <vittorio.giovara@gmail.com>
    Signed-off-by: Anton Khirnov <anton@khirnov.net>

diff --git a/libavcodec/error_resilience.c b/libavcodec/error_resilience.c
index ae9ef6861..73b69aff7 100644
--- a/libavcodec/error_resilience.c
+++ b/libavcodec/error_resilience.c
@@ -896,6 +896,12 @@ void ff_er_frame_end(MpegEncContext *s)
         return;
     };
 
+    if (s->picture_structure == PICT_FRAME &&
+        s->current_picture.f.linesize[0] != s->current_picture_ptr->f.linesize[0]) {
+        av_log(s->avctx, AV_LOG_ERROR, "Error concealment not possible, frame not fully initialized\n");
+        return;
+    }
+
     if (s->current_picture.f.motion_val[0] == NULL) {
         av_log(s->avctx, AV_LOG_ERROR, "Warning MVs not available\n");
 
