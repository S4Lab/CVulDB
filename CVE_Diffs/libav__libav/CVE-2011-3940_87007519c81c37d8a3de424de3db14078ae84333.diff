libav__libav
commit 87007519c81c37d8a3de424de3db14078ae84333
Author:     Alex Converse <alex.converse@gmail.com>
AuthorDate: Thu Jan 26 17:21:46 2012 -0800
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Sun Apr 8 11:23:19 2012 +0200

    nsvdec: Be more careful with av_malloc().
    
    Check results for av_malloc() and fix an overflow in one call.
    
    Related to CVE-2011-3940.
    
    Based in part on work from Michael Niedermayer.
    
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    (cherry picked from commit 8fd8a48263ff1437f9d02d7e78dc63efb9b5ed3a)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>
    (cherry picked from commit be524c186b50337db64d34a5726dfe3e8ea94f09)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavformat/nsvdec.c b/libavformat/nsvdec.c
index 3a14cfa22..beeb73911 100644
--- a/libavformat/nsvdec.c
+++ b/libavformat/nsvdec.c
@@ -319,7 +319,9 @@ static int nsv_parse_NSVf_header(AVFormatContext *s, AVFormatParameters *ap)
         char *token, *value;
         char quote;
 
-        p = strings = av_mallocz(strings_size + 1);
+        p = strings = av_mallocz((size_t)strings_size + 1);
+        if (!p)
+            return AVERROR(ENOMEM);
         endp = strings + strings_size;
         get_buffer(pb, strings, strings_size);
         while (p < endp) {
@@ -354,6 +356,8 @@ static int nsv_parse_NSVf_header(AVFormatContext *s, AVFormatParameters *ap)
         if((unsigned)table_entries_used >= UINT_MAX / sizeof(uint32_t))
             return -1;
         nsv->nsvs_file_offset = av_malloc((unsigned)table_entries_used * sizeof(uint32_t));
+        if (!nsv->nsvs_file_offset)
+            return AVERROR(ENOMEM);
 
         for(i=0;i<table_entries_used;i++)
             nsv->nsvs_file_offset[i] = get_le32(pb) + size;
@@ -361,6 +365,8 @@ static int nsv_parse_NSVf_header(AVFormatContext *s, AVFormatParameters *ap)
         if(table_entries > table_entries_used &&
            get_le32(pb) == MKTAG('T','O','C','2')) {
             nsv->nsvs_timestamps = av_malloc((unsigned)table_entries_used*sizeof(uint32_t));
+            if (!nsv->nsvs_timestamps)
+                return AVERROR(ENOMEM);
             for(i=0;i<table_entries_used;i++) {
                 nsv->nsvs_timestamps[i] = get_le32(pb);
             }
