libav__libav
commit fc159ba88ea2dd1fa11e4ab6af8b574fc80db454
Author:     Anton Khirnov <anton@khirnov.net>
AuthorDate: Sun Dec 14 21:01:59 2014 +0100
Commit:     Anton Khirnov <anton@khirnov.net>
CommitDate: Sat Dec 20 11:16:27 2014 +0100

    mmvideo: check frame dimensions
    
    The frame size must be set by the caller and each dimension must be a
    multiple of 2.
    
    CC: libav-stable@libav.org
    Bug-ID: CVE-2014-8543
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    (cherry picked from commit 17ba719d9ba30c970f65747f42d5fbb1e447ca28)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit 69a930b988ff4f88ae27e4fc24ff6ed116840b5e)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    (cherry picked from commit 3f10a779b465fd22d3aec1b744ca8544bc2da970)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>
    
    Conflicts:
            libavcodec/mmvideo.c
    
    (cherry picked from commit 03dba25a4001495226651068232b4c6b1e75fd02)
    Signed-off-by: Anton Khirnov <anton@khirnov.net>

diff --git a/libavcodec/mmvideo.c b/libavcodec/mmvideo.c
index 660cebc58..269813214 100644
--- a/libavcodec/mmvideo.c
+++ b/libavcodec/mmvideo.c
@@ -60,6 +60,13 @@ static av_cold int mm_decode_init(AVCodecContext *avctx)
 
     avctx->pix_fmt = PIX_FMT_PAL8;
 
+    if (!avctx->width || !avctx->height ||
+        (avctx->width & 1) || (avctx->height & 1)) {
+        av_log(avctx, AV_LOG_ERROR, "Invalid video dimensions: %dx%d\n",
+               avctx->width, avctx->height);
+        return AVERROR(EINVAL);
+    }
+
     s->frame.reference = 1;
 
     return 0;
