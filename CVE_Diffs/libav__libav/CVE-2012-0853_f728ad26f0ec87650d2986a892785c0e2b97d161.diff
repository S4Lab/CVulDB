libav__libav
commit f728ad26f0ec87650d2986a892785c0e2b97d161
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Sat Dec 17 03:18:58 2011 +0100
Commit:     Reinhard Tartler <siretart@tauware.de>
CommitDate: Sun Apr 1 18:33:29 2012 +0200

    atrac3: Fix crash in tonal component decoding.
    
    Add a check to avoid writing past the end of the channel_unit.components[]
    array.
    
    Bug Found by: cosminamironesei
    Fixes CVE-2012-0853
    CC: libav-stable@libav.org
    
    Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
    Signed-off-by: Justin Ruggles <justin.ruggles@gmail.com>
    (cherry picked from commit c509f4f74713b035a06f79cb4d00e708f5226bc5)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>
    (cherry picked from commit f43b6e2b1ed47a1254a5d44c700a7fad5e9784be)
    
    Signed-off-by: Reinhard Tartler <siretart@tauware.de>

diff --git a/libavcodec/atrac3.c b/libavcodec/atrac3.c
index accaae3d6..914998e7d 100644
--- a/libavcodec/atrac3.c
+++ b/libavcodec/atrac3.c
@@ -395,6 +395,8 @@ static int decodeTonalComponents (GetBitContext *gb, tonal_component *pComponent
 
             for (k=0; k<coded_components; k++) {
                 sfIndx = get_bits(gb,6);
+                if (component_count >= 64)
+                    return AVERROR_INVALIDDATA;
                 pComponent[component_count].pos = j * 64 + (get_bits(gb,6));
                 max_coded_values = 1024 - pComponent[component_count].pos;
                 coded_values = coded_values_per_component + 1;
