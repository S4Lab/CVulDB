libav__libav
commit a13ad11dc5cd0e93f830d6c9c6531542ca24e812
Author:     Michael Niedermayer <michaelni@gmx.at>
AuthorDate: Wed Feb 4 20:48:30 2015 +0100
Commit:     Diego Biurrun <diego@biurrun.de>
CommitDate: Tue Jul 26 18:20:06 2016 +0200

    mjpegdec: Check number of components for JPEG-LS
    
    Fixes out of array accesses.
    Fixes: asan_heap-oob_1c1a4ea_1242_cov_2274415971_TESTcmyk.jpg
    
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
    
    Bug-Id: CVE-2015-1872
    (cherry picked from commit fabbfaa095660982cc0bc63242c459561fa37037)
    Signed-off-by: Diego Biurrun <diego@biurrun.de>

diff --git a/libavcodec/mjpegdec.c b/libavcodec/mjpegdec.c
index a1a67893b..0266bc1ce 100644
--- a/libavcodec/mjpegdec.c
+++ b/libavcodec/mjpegdec.c
@@ -359,9 +359,12 @@ int ff_mjpeg_decode_sof(MJpegDecodeContext *s)
         return -1;
     }
     if (s->ls) {
-        if (s->nb_components > 1)
+        if (s->nb_components == 3) {
             s->avctx->pix_fmt = PIX_FMT_RGB24;
-        else if (s->bits <= 8)
+        } else if (s->nb_components != 1) {
+            av_log(s->avctx, AV_LOG_ERROR, "Unsupported number of components %d\n", s->nb_components);
+            return AVERROR_PATCHWELCOME;
+        } else if (s->bits <= 8)
             s->avctx->pix_fmt = PIX_FMT_GRAY8;
         else
             s->avctx->pix_fmt = PIX_FMT_GRAY16;
