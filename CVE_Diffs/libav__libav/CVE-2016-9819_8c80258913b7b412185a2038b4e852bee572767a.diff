libav__libav
commit 8c80258913b7b412185a2038b4e852bee572767a
Author:     Luca Barbato <lu_zero@gentoo.org>
AuthorDate: Wed Mar 2 18:52:23 2016 -0500
Commit:     Diego Biurrun <diego@biurrun.de>
CommitDate: Thu Jan 12 15:23:52 2017 +0100

    mpegvideo: Fix undefined negative shifts in ff_init_block_index
    
    Bug-Id: 980
    Bug-Id: CVE-2016-9819
    Found-by: gcc5-ubsan.
    
    Signed-off-by: Vittorio Giovara <vittorio.giovara@gmail.com>
    (cherry picked from commit 7d4a1ff344cbf969ac648642a0fd8484fd5b8637)
    Signed-off-by: Sean McGovern <gseanmcg@gmail.com>
    (cherry picked from commit f106f74206e69e9056130da8bddffc39f3878ac3)
    Signed-off-by: Diego Biurrun <diego@biurrun.de>

diff --git a/libavcodec/mpegvideo.c b/libavcodec/mpegvideo.c
index b867be2bf..c9bbc0b75 100644
--- a/libavcodec/mpegvideo.c
+++ b/libavcodec/mpegvideo.c
@@ -2618,9 +2618,9 @@ void ff_init_block_index(MpegEncContext *s){ //FIXME maybe rename
     s->block_index[5]= s->mb_stride*(s->mb_y + s->mb_height + 2) + s->b8_stride*s->mb_height*2 + s->mb_x - 1;
     //block_index is not used by mpeg2, so it is not affected by chroma_format
 
-    s->dest[0] = s->current_picture.f.data[0] + ((s->mb_x - 1) <<  mb_size);
-    s->dest[1] = s->current_picture.f.data[1] + ((s->mb_x - 1) << (mb_size - s->chroma_x_shift));
-    s->dest[2] = s->current_picture.f.data[2] + ((s->mb_x - 1) << (mb_size - s->chroma_x_shift));
+    s->dest[0] = s->current_picture.f.data[0] + (s->mb_x - 1) * (1 << mb_size);
+    s->dest[1] = s->current_picture.f.data[1] + (s->mb_x - 1) * (1 << (mb_size - s->chroma_x_shift));
+    s->dest[2] = s->current_picture.f.data[2] + (s->mb_x - 1) * (1 << (mb_size - s->chroma_x_shift));
 
     if(!(s->pict_type==AV_PICTURE_TYPE_B && s->avctx->draw_horiz_band && s->picture_structure==PICT_FRAME))
     {
