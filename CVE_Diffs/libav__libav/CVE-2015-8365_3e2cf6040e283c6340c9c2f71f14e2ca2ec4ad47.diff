libav__libav
commit 3e2cf6040e283c6340c9c2f71f14e2ca2ec4ad47
Author:     Michael Niedermayer <michael@niedermayer.cc>
AuthorDate: Sun Nov 15 14:52:08 2015 +0100
Commit:     Diego Biurrun <diego@biurrun.de>
CommitDate: Thu Jun 1 15:37:28 2017 +0200

    smacker: Check that the data size is a multiple of a sample vector
    
    Fixes out of array access
    Fixes: ce19e41f0ef1e52a23edc488faecdb58/asan_heap-oob_2504e97_4202_ffa0df1baed14022b9bfd4f8ac23d0cb.smk
    
    Bug-Id: CVE-2015-8365
    CC: libav-stable@libav.org
    
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>
    (cherry picked from commit 4a9af07a49295e014b059c1ab624c40345af5892)
    Signed-off-by: Diego Biurrun <diego@biurrun.de>
    (cherry picked from commit b98f082d8ddc0a0d8317114d8414ab51de60ef02)
    Signed-off-by: Diego Biurrun <diego@biurrun.de>

diff --git a/libavcodec/smacker.c b/libavcodec/smacker.c
index e3e54752a..be0a195d4 100644
--- a/libavcodec/smacker.c
+++ b/libavcodec/smacker.c
@@ -628,6 +628,11 @@ static int smka_decode_frame(AVCodecContext *avctx, void *data,
         av_log(avctx, AV_LOG_ERROR, "sample format mismatch\n");
         return AVERROR(EINVAL);
     }
+    if (unp_size % (avctx->channels * (bits + 1))) {
+        av_log(avctx, AV_LOG_ERROR,
+               "The buffer does not contain an integer number of samples\n");
+        return AVERROR(EINVAL);
+    }
 
     /* get output buffer */
     frame->nb_samples = unp_size / (avctx->channels * (bits + 1));
