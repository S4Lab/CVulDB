libav__libav
commit af1f7fa642b8ec1236e39d0e715bed156a601cba
Author:     Luca Barbato <lu_zero@gentoo.org>
AuthorDate: Tue Mar 8 11:57:16 2016 +0100
Commit:     Diego Biurrun <diego@biurrun.de>
CommitDate: Fri Oct 7 00:42:35 2016 +0200

    mov: Check the entries value when parsing dref boxes
    
    And properly reset the entries count when resetting the entries.
    
    CC: libav-stable@libav.org
    
    Bug-Id: 929
    Bug-Id: CVE-2016-3062
    (cherry picked from commit 7e01d48cfd168c3dfc663f03a3b6a98e0ecba328)
    Signed-off-by: Diego Biurrun <diego@biurrun.de>

diff --git a/libavformat/mov.c b/libavformat/mov.c
index a1de6526a..4e636e7b1 100644
--- a/libavformat/mov.c
+++ b/libavformat/mov.c
@@ -387,8 +387,10 @@ static int mov_read_dref(MOVContext *c, AVIOContext *pb, MOVAtom atom)
 
     avio_rb32(pb); // version + flags
     entries = avio_rb32(pb);
-    if (entries >= UINT_MAX / sizeof(*sc->drefs))
+    if (!entries ||
+        entries >= UINT_MAX / sizeof(*sc->drefs))
         return AVERROR_INVALIDDATA;
+    sc->drefs_count = 0;
     sc->drefs = av_mallocz(entries * sizeof(*sc->drefs));
     if (!sc->drefs)
         return AVERROR(ENOMEM);
