embest-tech__linux-imx
commit a0209f336a1dff0363b558a972eb71eef74e0084
Author:     Eric Paris <eparis@redhat.com>
AuthorDate: Wed Dec 19 13:59:32 2007 +0100
Commit:     Greg Kroah-Hartman <gregkh@suse.de>
CommitDate: Fri Feb 8 12:01:43 2008 -0800

    VM/Security: add security hook to do_brk (CVE-2007-6434)
    
    patch ecaf18c15aac8bb9bed7b7aa0e382fe252e275d5 in mainline.
    
    VM/Security: add security hook to do_brk
    
    Given a specifically crafted binary do_brk() can be used to get low pages
    available in userspace virtual memory and can thus be used to circumvent
    the mmap_min_addr low memory protection.  Add security checks in do_brk().
    
    Signed-off-by: Eric Paris <eparis@redhat.com>
    Acked-by: Alan Cox <alan@redhat.com>
    Cc: Stephen Smalley <sds@tycho.nsa.gov>
    Cc: James Morris <jmorris@namei.org>
    Cc: Chris Wright <chrisw@sous-sol.org>
    Cc: maximilian attems <max@stro.at>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

diff --git a/mm/mmap.c b/mm/mmap.c
index 0d40e66c841b..5c214334d89e 100644
--- a/mm/mmap.c
+++ b/mm/mmap.c
@@ -1938,6 +1938,10 @@ unsigned long do_brk(unsigned long addr, unsigned long len)
 	if (is_hugepage_only_range(mm, addr, len))
 		return -EINVAL;
 
+	error = security_file_mmap(0, 0, 0, 0, addr, 1);
+	if (error)
+		return error;
+
 	flags = VM_DATA_DEFAULT_FLAGS | VM_ACCOUNT | mm->def_flags;
 
 	error = arch_mmap_check(addr, len, flags);
