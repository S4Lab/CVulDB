libvirt__libvirt
commit 0a744e15517d727c7f473fabe32ca6b0dbb7b7d1
Author:     Ján Tomko <jtomko@redhat.com>
AuthorDate: Fri Jun 14 09:14:53 2019 +0200
Commit:     Ján Tomko <jtomko@redhat.com>
CommitDate: Mon Jun 24 09:54:57 2019 +0200

    api: disallow virDomainManagedSaveDefineXML on read-only connections
    
    The virDomainManagedSaveDefineXML can be used to alter the domain's
    config used for managedsave or even execute arbitrary emulator binaries.
    Forbid it on read-only connections.
    
    Fixes: CVE-2019-10166
    Reported-by: Matthias Gerstner <mgerstner@suse.de>
    Signed-off-by: Ján Tomko <jtomko@redhat.com>
    Reviewed-by: Daniel P. Berrangé <berrange@redhat.com>
    (cherry picked from commit db0b78457f183e4c7ac45bc94de86044a1e2056a)
    Signed-off-by: Ján Tomko <jtomko@redhat.com>

diff --git a/src/libvirt-domain.c b/src/libvirt-domain.c
index c188239191..d8b64c02a9 100644
--- a/src/libvirt-domain.c
+++ b/src/libvirt-domain.c
@@ -9490,6 +9490,7 @@ virDomainManagedSaveDefineXML(virDomainPtr domain, const char *dxml,
 
     virCheckDomainReturn(domain, -1);
     conn = domain->conn;
+    virCheckReadOnlyGoto(conn->flags, error);
 
     if (conn->driver->domainManagedSaveDefineXML) {
         int ret;
