libvirt__libvirt
commit 38a16f786794887cb2fd8e82d4b52e07a77d9f50
Author:     Ján Tomko <jtomko@redhat.com>
AuthorDate: Fri Jun 14 09:16:14 2019 +0200
Commit:     Ján Tomko <jtomko@redhat.com>
CommitDate: Mon Jun 24 09:55:38 2019 +0200

    api: disallow virConnectGetDomainCapabilities on read-only connections
    
    This API can be used to execute arbitrary emulators.
    Forbid it on read-only connections.
    
    Fixes: CVE-2019-10167
    Signed-off-by: Ján Tomko <jtomko@redhat.com>
    Reviewed-by: Daniel P. Berrangé <berrange@redhat.com>
    (cherry picked from commit 8afa68bac0cf99d1f8aaa6566685c43c22622f26)
    Signed-off-by: Ján Tomko <jtomko@redhat.com>

diff --git a/src/libvirt-domain.c b/src/libvirt-domain.c
index d8b64c02a9..1e1c4e33a2 100644
--- a/src/libvirt-domain.c
+++ b/src/libvirt-domain.c
@@ -11282,6 +11282,7 @@ virConnectGetDomainCapabilities(virConnectPtr conn,
     virResetLastError();
 
     virCheckConnectReturn(conn, NULL);
+    virCheckReadOnlyGoto(conn->flags, error);
 
     if (conn->driver->connectGetDomainCapabilities) {
         char *ret;
