libvirt__libvirt
commit 7195a5fa4718d915b28bb6e3380255eb1fbf994a
Author:     Peter Krempa <pkrempa@redhat.com>
AuthorDate: Tue Jan 20 17:01:01 2015 +0100
Commit:     Eric Blake <eblake@redhat.com>
CommitDate: Thu Jan 22 09:16:37 2015 -0700

    CVE-2015-0236: qemu: Check ACLs when dumping security info from snapshots
    
    The ACL check didn't check the VIR_DOMAIN_XML_SECURE flag and the
    appropriate permission for it. Found via code inspection while fixing
    permissions for save images.
    
    (cherry picked from commit b347c0c2a321ec5c20aae214927949832a288c5a)

diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index 17b9f4abfb..7abcf799c8 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -14404,7 +14404,7 @@ qemuDomainSnapshotGetXMLDesc(virDomainSnapshotPtr snapshot,
     if (!(vm = qemuDomObjFromSnapshot(snapshot)))
         return NULL;
 
-    if (virDomainSnapshotGetXMLDescEnsureACL(snapshot->domain->conn, vm->def) < 0)
+    if (virDomainSnapshotGetXMLDescEnsureACL(snapshot->domain->conn, vm->def, flags) < 0)
         goto cleanup;
 
     if (!(snap = qemuSnapObjFromSnapshot(vm, snapshot)))
diff --git a/src/remote/remote_protocol.x b/src/remote/remote_protocol.x
index f9b3199f06..59d35edaa0 100644
--- a/src/remote/remote_protocol.x
+++ b/src/remote/remote_protocol.x
@@ -4480,6 +4480,7 @@ enum remote_procedure {
      * @generate: both
      * @priority: high
      * @acl: domain:read
+     * @acl: domain:read_secure:VIR_DOMAIN_XML_SECURE
      */
     REMOTE_PROC_DOMAIN_SNAPSHOT_GET_XML_DESC = 186,
 
