libvirt__libvirt
commit 95836cb26b1d91b8e9eba0c4764bc24cccc78684
Author:     Jiri Denemark <jdenemar@redhat.com>
AuthorDate: Fri Dec 20 15:04:09 2013 +0100
Commit:     Eric Blake <eblake@redhat.com>
CommitDate: Wed Jan 15 12:27:23 2014 -0700

    qemu: Fix job usage in qemuDomainBlockJobImpl
    
    CVE-2013-6458
    
    Every API that is going to begin a job should do that before fetching
    data from vm->def.
    
    (cherry picked from commit f93d2caa070f6197ab50d372d286018b0ba6bbd8)
    
    Conflicts:
            src/qemu/qemu_driver.c - older style BeginJobWithDriver, context

diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index 25ceee061e..ac728fcab8 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -12619,11 +12619,6 @@ qemuDomainBlockJobImpl(virDomainPtr dom, const char *path, const char *base,
         goto cleanup;
     }
 
-    device = qemuDiskPathToAlias(vm, path, &idx);
-    if (!device)
-        goto cleanup;
-    disk = vm->def->disks[idx];
-
     if (qemuDomainObjBeginJobWithDriver(driver, vm, QEMU_JOB_MODIFY) < 0)
         goto cleanup;
 
@@ -12633,6 +12628,11 @@ qemuDomainBlockJobImpl(virDomainPtr dom, const char *path, const char *base,
         goto endjob;
     }
 
+    device = qemuDiskPathToAlias(vm, path, &idx);
+    if (!device)
+        goto endjob;
+    disk = vm->def->disks[idx];
+
     qemuDomainObjEnterMonitorWithDriver(driver, vm);
     /* XXX - libvirt should really be tracking the backing file chain
      * itself, and validating that base is on the chain, rather than
