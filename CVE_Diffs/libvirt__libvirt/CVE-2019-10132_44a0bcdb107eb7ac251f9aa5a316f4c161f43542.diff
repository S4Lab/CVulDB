libvirt__libvirt
commit 44a0bcdb107eb7ac251f9aa5a316f4c161f43542
Author:     Daniel P. Berrangé <berrange@redhat.com>
AuthorDate: Tue Apr 30 17:26:13 2019 +0100
Commit:     Daniel P. Berrangé <berrange@redhat.com>
CommitDate: Tue May 21 13:25:54 2019 +0100

    admin: reject clients unless their UID matches the current UID
    
    The admin protocol RPC messages are only intended for use by the user
    running the daemon. As such they should not be allowed for any client
    UID that does not match the server UID.
    
    Fixes CVE-2019-10132
    
    Reviewed-by: Ján Tomko <jtomko@redhat.com>
    Signed-off-by: Daniel P. Berrangé <berrange@redhat.com>
    (cherry picked from commit 96f41cd765c9e525fe28ee5abbfbf4a79b3720c7)

diff --git a/src/admin/admin_server_dispatch.c b/src/admin/admin_server_dispatch.c
index 85e693d76c..6e3b99f97d 100644
--- a/src/admin/admin_server_dispatch.c
+++ b/src/admin/admin_server_dispatch.c
@@ -64,6 +64,28 @@ remoteAdmClientNew(virNetServerClientPtr client ATTRIBUTE_UNUSED,
                    void *opaque)
 {
     struct daemonAdmClientPrivate *priv;
+    uid_t clientuid;
+    gid_t clientgid;
+    pid_t clientpid;
+    unsigned long long timestamp;
+
+    if (virNetServerClientGetUNIXIdentity(client,
+                                          &clientuid,
+                                          &clientgid,
+                                          &clientpid,
+                                          &timestamp) < 0)
+        return NULL;
+
+    VIR_DEBUG("New client pid %lld uid %lld",
+              (long long)clientpid,
+              (long long)clientuid);
+
+    if (geteuid() != clientuid) {
+        virReportRestrictedError(_("Disallowing client %lld with uid %lld"),
+                                 (long long)clientpid,
+                                 (long long)clientuid);
+        return NULL;
+    }
 
     if (VIR_ALLOC(priv) < 0)
         return NULL;
