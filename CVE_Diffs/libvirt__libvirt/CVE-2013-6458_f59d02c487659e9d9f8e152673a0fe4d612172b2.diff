libvirt__libvirt
commit f59d02c487659e9d9f8e152673a0fe4d612172b2
Author:     Jiri Denemark <jdenemar@redhat.com>
AuthorDate: Fri Dec 20 15:41:04 2013 +0100
Commit:     Eric Blake <eblake@redhat.com>
CommitDate: Wed Jan 15 12:39:45 2014 -0700

    qemu: Fix job usage in virDomainGetBlockIoTune
    
    CVE-2013-6458
    
    Every API that is going to begin a job should do that before fetching
    data from vm->def.
    
    (cherry picked from commit 3b56425938e2f97208d5918263efa0d6439e4ecd)
    
    Conflicts:
            src/qemu/qemu_driver.c - older BeginJobWithDriver

diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index ac728fcab8..9d58d1a191 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -13027,12 +13027,6 @@ qemuDomainGetBlockIoTune(virDomainPtr dom,
         goto cleanup;
     }
 
-    device = qemuDiskPathToAlias(vm, disk, NULL);
-
-    if (!device) {
-        goto cleanup;
-    }
-
     if (qemuDomainObjBeginJobWithDriver(driver, vm, QEMU_JOB_MODIFY) < 0)
         goto cleanup;
 
@@ -13040,6 +13034,11 @@ qemuDomainGetBlockIoTune(virDomainPtr dom,
                                         &persistentDef) < 0)
         goto endjob;
 
+    device = qemuDiskPathToAlias(vm, disk, NULL);
+    if (!device) {
+        goto endjob;
+    }
+
     if (flags & VIR_DOMAIN_AFFECT_LIVE) {
         priv = vm->privateData;
         qemuDomainObjEnterMonitorWithDriver(driver, vm);
