php__php-src
commit 23102e230e81c7c4f082c1759661e2914dec56fe
Author:     Stanislav Malyshev <stas@php.net>
AuthorDate: Tue May 22 18:16:38 2007 +0000
Commit:     Stanislav Malyshev <stas@php.net>
CommitDate: Tue May 22 18:16:38 2007 +0000

    fix for  CVE-2007-1285 - crash on deep input variable nesting

diff --git a/main/main.c b/main/main.c
index 3dd77464f9..bba551f75d 100644
--- a/main/main.c
+++ b/main/main.c
@@ -338,6 +338,7 @@ PHP_INI_BEGIN()
 	STD_PHP_INI_ENTRY("upload_max_filesize",	"2M",		PHP_INI_SYSTEM|PHP_INI_PERDIR,		OnUpdateInt,			upload_max_filesize,	php_core_globals,	core_globals)
 	STD_PHP_INI_ENTRY("post_max_size",			"8M",		PHP_INI_SYSTEM|PHP_INI_PERDIR,		OnUpdateInt,			post_max_size,			sapi_globals_struct,sapi_globals)
 	STD_PHP_INI_ENTRY("upload_tmp_dir",			NULL,		PHP_INI_SYSTEM,		OnUpdateStringUnempty,	upload_tmp_dir,			php_core_globals,	core_globals)
+	STD_PHP_INI_ENTRY("max_input_nesting_level", "500",      PHP_INI_SYSTEM|PHP_INI_PERDIR,      OnUpdateLongGEZero, max_input_nesting_level,            php_core_globals,   core_globals)
 
 	STD_PHP_INI_ENTRY("user_dir",				NULL,		PHP_INI_SYSTEM,		OnUpdateString,			user_dir,				php_core_globals,	core_globals)
 	STD_PHP_INI_ENTRY("variables_order",		NULL,		PHP_INI_ALL,		OnUpdateStringUnempty,	variables_order,		php_core_globals,	core_globals)
diff --git a/main/php_globals.h b/main/php_globals.h
index 6e33fe21d4..ab0c44a8ce 100644
--- a/main/php_globals.h
+++ b/main/php_globals.h
@@ -141,6 +141,7 @@ struct _php_core_globals {
 	zend_bool always_populate_raw_post_data;
 	
 	long serialize_precision;
+	long max_input_nesting_level;
 };
 
 
diff --git a/main/php_variables.c b/main/php_variables.c
index 281fa7e0fa..3fd0fe5067 100644
--- a/main/php_variables.c
+++ b/main/php_variables.c
@@ -66,6 +66,7 @@ PHPAPI void php_register_variable_ex(char *var, zval *val, pval *track_vars_arra
 	zval *gpc_element, **gpc_element_p;
 	zend_bool is_array;
 	HashTable *symtable1=NULL;
+	int nest_level = 0;
 
 	assert(var != NULL);
 	
@@ -128,6 +129,10 @@ PHPAPI void php_register_variable_ex(char *var, zval *val, pval *track_vars_arra
 			char *escaped_index = NULL, *index_s;
 			int new_idx_len = 0;
 
+			if(++nest_level > PG(max_input_nesting_level)) {
+				/* too many levels of nesting */
+				php_error_docref(NULL TSRMLS_CC, E_ERROR, "Input variable nesting level more than allowed %d (change max_input_nesting_level in php.ini to increase the limit)", PG(max_input_nesting_level));	
+			}
 			ip++;
 			index_s = ip;
 			if (isspace(*ip)) {
