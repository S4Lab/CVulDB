FreeRDP__FreeRDP
commit f777230e15c5a466d96a3a476b16ebff54e86939
Author:     Bernhard Miklautz <bernhard.miklautz@thincast.com>
AuthorDate: Thu May 9 11:28:29 2019 +0200
Commit:     Bernhard Miklautz <bernhard.miklautz@thincast.com>
CommitDate: Thu May 9 11:28:29 2019 +0200

    fix: CVE-2018-8787
    
    Backport of 09b9d4f1994a674c4ec85b4947aa656eda1aed8a

diff --git a/libfreerdp/gdi/graphics.c b/libfreerdp/gdi/graphics.c
index 3bd5f2801..57310a522 100644
--- a/libfreerdp/gdi/graphics.c
+++ b/libfreerdp/gdi/graphics.c
@@ -23,6 +23,7 @@
 
 #include <winpr/crt.h>
 
+#include <stdint.h>
 #include <freerdp/gdi/dc.h>
 #include <freerdp/gdi/brush.h>
 #include <freerdp/gdi/shape.h>
@@ -98,7 +99,7 @@ void gdi_Bitmap_Decompress(rdpContext* context, rdpBitmap* bitmap,
 		BYTE* data, int width, int height, int bpp, int length,
 		BOOL compressed, int codec_id)
 {
-	UINT16 size;
+	UINT32 size;
 	RFX_MESSAGE* msg;
 	BYTE* src;
 	BYTE* dst;
@@ -107,7 +108,16 @@ void gdi_Bitmap_Decompress(rdpContext* context, rdpBitmap* bitmap,
 	rdpGdi* gdi;
 	BOOL status;
 
-	size = width * height * ((bpp + 7) / 8);
+	size = width * height;
+
+       if (bpp <= 0 || width <= 0 || height <= 0 ||
+	   width > (UINT32_MAX / height) ||
+	   size > (UINT32_MAX / (bpp + 7) / 8))
+       {
+		printf("Invalid parameters, unable to decompress bitmap\n");
+		return;
+       }
+	size *= (bpp + 7) / 8;
 
 	if (bitmap->data == NULL)
 		bitmap->data = (BYTE*) malloc(size);
