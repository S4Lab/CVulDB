FreeRDP__FreeRDP
commit 6fa64006a1b29593102cb15e9f1de40b00c9ae66
Author:     Bernhard Miklautz <bernhard.miklautz@thincast.com>
AuthorDate: Thu May 9 11:30:56 2019 +0200
Commit:     Bernhard Miklautz <bernhard.miklautz@thincast.com>
CommitDate: Thu May 9 11:30:56 2019 +0200

    fix: CVE-2018-8789
    
    Backport of 2ee663f39dc8dac3d9988e847db19b2d7e3ac8c6

diff --git a/winpr/libwinpr/sspi/NTLM/ntlm_message.c b/winpr/libwinpr/sspi/NTLM/ntlm_message.c
index 8b17d6990..779469aa2 100644
--- a/winpr/libwinpr/sspi/NTLM/ntlm_message.c
+++ b/winpr/libwinpr/sspi/NTLM/ntlm_message.c
@@ -146,6 +146,10 @@ void ntlm_read_message_fields_buffer(wStream* s, NTLM_MESSAGE_FIELDS* fields)
 {
 	if (fields->Len > 0)
 	{
+		const UINT64 offset = (UINT64)fields->BufferOffset + (UINT64)fields->Len;
+
+		if (offset > Stream_Length(s))
+			return;
 		fields->Buffer = malloc(fields->Len);
 		Stream_SetPosition(s, fields->BufferOffset);
 		Stream_Read(s, fields->Buffer, fields->Len);
