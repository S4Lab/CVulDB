Canonical-kernel__Ubuntu-kernel
commit 663295c77d96d5bcabb5faa791ef351fa2e5f103
Author:     J. Bruce Fields <bfields@citi.umich.edu>
AuthorDate: Mon Mar 16 18:34:20 2009 -0400
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Mon Jun 15 16:32:35 2009 +0200

    nfsd: nfsd should drop CAP_MKNOD for non-root
    
    CVE-2009-1072
    
    commit 76a67ec6fb79ff3570dcb5342142c16098299911 upstream
    
    Since creating a device node is normally an operation requiring special
    privilege, Igor Zhbanov points out that it is surprising (to say the
    least) that a client can, for example, create a device node on a
    filesystem exported with root_squash.
    
    So, make sure CAP_MKNOD is among the capabilities dropped when an nfsd
    thread handles a request from a non-root user.
    
    Reported-by: Igor Zhbanov <izh1979@gmail.com>
    Cc: stable@kernel.org
    Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/include/linux/capability.h b/include/linux/capability.h
index bb017edffd56..99cd8368a07b 100644
--- a/include/linux/capability.h
+++ b/include/linux/capability.h
@@ -121,7 +121,12 @@ typedef __u32 kernel_cap_t;
 
 /* Used to decide between falling back on the old suser() or fsuser(). */
 
-#define CAP_FS_MASK          0x1f
+#define CAP_FS_MASK          (CAP_TO_MASK(CAP_CHOWN)             \
+			     | CAP_TO_MASK(CAP_MKNOD)            \
+			     | CAP_TO_MASK(CAP_DAC_OVERRIDE)     \
+			     | CAP_TO_MASK(CAP_DAC_READ_SEARCH)  \
+			     | CAP_TO_MASK(CAP_FOWNER)           \
+			     | CAP_TO_MASK(CAP_FSETID))
 
 /* Overrides the restriction that the real or effective user ID of a
    process sending a signal must match the real or effective user ID
