Canonical-kernel__Ubuntu-kernel
commit 62269f188defddedfe05873b9871d8113fda9d48
Author:     Miklos Szeredi <mszeredi@suse.cz>
AuthorDate: Tue Jan 3 13:14:39 2012 +0000
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Mon Jan 23 18:39:28 2012 -0800

    fuse: check size of FUSE_NOTIFY_INVAL_ENTRY message, CVE-2011-3353
    
    FUSE_NOTIFY_INVAL_ENTRY didn't check the length of the write so the
    message processing could overrun and result in a "kernel BUG at
    fs/fuse/dev.c:629!"
    
    Reported-by: Han-Wen Nienhuys <hanwenn@gmail.com>
    Signed-off-by: Miklos Szeredi <mszeredi@suse.cz>
    CC: stable@kernel.org
    
    (cherry picked from commit c2183d1e9b3f313dd8ba2b1b0197c8d9fb86a7ae)
    CVE-2011-3353
    BugLink: http://bugs.launchpad.net/bugs/905058
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Seth Forshee <seth.forshee@canonical.com>
    Acked-by: Herton Krzesinski <herton.krzesinski@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    
    Signed-off-by: Brad Figg <brad.figg@canonical.com>

diff --git a/fs/fuse/dev.c b/fs/fuse/dev.c
index cf8d28d1fbad..bd486bbd2655 100644
--- a/fs/fuse/dev.c
+++ b/fs/fuse/dev.c
@@ -1360,6 +1360,10 @@ static int fuse_notify_inval_entry(struct fuse_conn *fc, unsigned int size,
 	if (outarg.namelen > FUSE_NAME_MAX)
 		goto err;
 
+	err = -EINVAL;
+	if (size != sizeof(outarg) + outarg.namelen + 1)
+		goto err;
+
 	name.name = buf;
 	name.len = outarg.namelen;
 	err = fuse_copy_one(cs, buf, outarg.namelen + 1);
