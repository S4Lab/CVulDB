Canonical-kernel__Ubuntu-kernel
commit 2eabe1d0760650e12544a5a3342dbed729bea6b5
Author:     Al Viro <viro@zeniv.linux.org.uk>
AuthorDate: Tue Dec 22 23:45:11 2009 -0500
Commit:     Luis Henriques <luis.henriques@canonical.com>
CommitDate: Thu Jul 17 11:35:50 2014 +0100

    fix autofs/afs/etc. magic mountpoint breakage
    
    CVE-2014-0203
    
    We end up trying to kfree() nd.last.name on open("/mnt/tmp", O_CREAT)
    if /mnt/tmp is an autofs direct mount.  The reason is that nd.last_type
    is bogus here; we want LAST_BIND for everything of that kind and we
    get LAST_NORM left over from finding parent directory.
    
    So make sure that it *is* set properly; set to LAST_BIND before
    doing ->follow_link() - for normal symlinks it will be changed
    by __vfs_follow_link() and everything else needs it set that way.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    (cherry picked from commit 86acdca1b63e6890540fa19495cfc708beff3d8b)
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    Signed-off-by: Maarten Lankhorst <maarten.lankhorst@canonical.com>

diff --git a/fs/namei.c b/fs/namei.c
index 42e952609cd5..3faeb3c86194 100644
--- a/fs/namei.c
+++ b/fs/namei.c
@@ -636,6 +636,7 @@ static __always_inline int __do_follow_link(struct path *path, struct nameidata
 		dget(dentry);
 	}
 	mntget(path->mnt);
+	nd->last_type = LAST_BIND;
 	cookie = dentry->d_inode->i_op->follow_link(dentry, nd);
 	error = PTR_ERR(cookie);
 	if (!IS_ERR(cookie)) {
diff --git a/fs/proc/base.c b/fs/proc/base.c
index b1d020e40512..689af596bc54 100644
--- a/fs/proc/base.c
+++ b/fs/proc/base.c
@@ -1381,7 +1381,6 @@ static void *proc_pid_follow_link(struct dentry *dentry, struct nameidata *nd)
 		goto out;
 
 	error = PROC_I(inode)->op.proc_get_link(inode, &nd->path);
-	nd->last_type = LAST_BIND;
 out:
 	return ERR_PTR(error);
 }
