Canonical-kernel__Ubuntu-kernel
commit cbd482d344cbeced6ca5d4c71c80f0f2a437fe6b
Author:     Avi Kivity <avi@redhat.com>
AuthorDate: Sun Oct 4 16:45:13 2009 +0200
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Tue Dec 1 19:58:52 2009 +0100

    KVM: Prevent overflow in KVM_GET_SUPPORTED_CPUID
    
    CVE-2009-3638
    
    The number of entries is multiplied by the entry size, which can
    overflow on 32-bit hosts.  Bound the entry count instead.
    
    Reported-by: David Wagner <daw@cs.berkeley.edu>
    Cc: stable@kernel.org
    Signed-off-by: Avi Kivity <avi@redhat.com>
    (cherry picked from commit 6a54435560efdab1a08f429a954df4d6c740bddf)
    
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 2732d1b0d9d5..f88b64099d6e 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -1132,6 +1132,8 @@ static int kvm_dev_ioctl_get_supported_cpuid(struct kvm_cpuid2 *cpuid,
 
 	if (cpuid->nent < 1)
 		goto out;
+	if (cpuid->nent > KVM_MAX_CPUID_ENTRIES)
+		cpuid->nent = KVM_MAX_CPUID_ENTRIES;
 	r = -ENOMEM;
 	cpuid_entries = vmalloc(sizeof(struct kvm_cpuid_entry2) * cpuid->nent);
 	if (!cpuid_entries)
