Canonical-kernel__Ubuntu-kernel
commit aca19f5173340af4bf9b469b17844df21f483360
Author:     Stefan Bader <stefan.bader@canonical.com>
AuthorDate: Mon Mar 23 20:10:03 2009 +0100
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Mon Mar 23 20:10:03 2009 +0100

    UBUNTU: rt: Fix FTBS caused by shm changes
    
    A rt patch would not apply anymore after this security change:
    
    commit d05ee756e40f3dbf1bb0bac8d2a06a00e0d5e6c9
    Author: Tony Battersby <tonyb@cybernetics.com>
    Date:   Wed Feb 4 15:12:04 2009 -0800
    
    shm: fix shmctl(SHM_INFO) lockup with !CONFIG_SHMEM
    
    CVE-2009-0859
    
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/debian/binary-custom.d/rt/patchset/0294-mapping_nrpages.patch b/debian/binary-custom.d/rt/patchset/0294-mapping_nrpages.patch
index 0954f7a7ccee..d739cf18a246 100644
--- a/debian/binary-custom.d/rt/patchset/0294-mapping_nrpages.patch
+++ b/debian/binary-custom.d/rt/patchset/0294-mapping_nrpages.patch
@@ -334,20 +334,21 @@ Index: linux-2.6.24.7-rt21/ipc/shm.c
 ===================================================================
 --- linux-2.6.24.7-rt21.orig/ipc/shm.c	2008-10-08 22:22:25.000000000 -0400
 +++ linux-2.6.24.7-rt21/ipc/shm.c	2008-10-08 22:24:14.000000000 -0400
-@@ -628,11 +628,11 @@ static void shm_get_stat(struct ipc_name
+@@ -628,12 +628,12 @@ static void shm_get_stat(struct ipc_name
  
  		if (is_file_hugepages(shp->shm_file)) {
  			struct address_space *mapping = inode->i_mapping;
 -			*rss += (HPAGE_SIZE/PAGE_SIZE)*mapping->nrpages;
 +			*rss += (HPAGE_SIZE/PAGE_SIZE)*mapping_nrpages(mapping);
  		} else {
+ #ifdef CONFIG_SHMEM
  			struct shmem_inode_info *info = SHMEM_I(inode);
  			spin_lock(&info->lock);
 -			*rss += inode->i_mapping->nrpages;
 +			*rss += mapping_nrpages(inode->i_mapping);
  			*swp += info->swapped;
  			spin_unlock(&info->lock);
- 		}
+ #else
 Index: linux-2.6.24.7-rt21/mm/filemap.c
 ===================================================================
 --- linux-2.6.24.7-rt21.orig/mm/filemap.c	2008-10-08 22:24:13.000000000 -0400
