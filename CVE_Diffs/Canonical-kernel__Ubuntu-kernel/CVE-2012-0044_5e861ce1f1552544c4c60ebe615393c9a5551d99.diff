Canonical-kernel__Ubuntu-kernel
commit 5e861ce1f1552544c4c60ebe615393c9a5551d99
Author:     Xi Wang <xi.wang@gmail.com>
AuthorDate: Wed Jan 18 12:54:14 2012 +0000
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Mon Jan 23 18:39:31 2012 -0800

    drm: integer overflow in drm_mode_dirtyfb_ioctl()
    
    There is a potential integer overflow in drm_mode_dirtyfb_ioctl()
    if userspace passes in a large num_clips.  The call to kmalloc would
    allocate a small buffer, and the call to fb->funcs->dirty may result
    in a memory corruption.
    
    Reported-by: Haogang Chen <haogangchen@gmail.com>
    Signed-off-by: Xi Wang <xi.wang@gmail.com>
    Cc: stable@kernel.org
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    
    (cherry picked from commit a5cd335165e31db9dbab636fd29895d41da55dd2)
    CVE-2012-0044
    BugLink: http://bugs.launchpad.net/bugs/917838
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Acked-by: Herton Krzesinski <herton.krzesinski@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    
    Signed-off-by: Brad Figg <brad.figg@canonical.com>

diff --git a/drivers/gpu/drm/drm_crtc.c b/drivers/gpu/drm/drm_crtc.c
index 6a5371b8fe9a..9dfb87ec2dec 100644
--- a/drivers/gpu/drm/drm_crtc.c
+++ b/drivers/gpu/drm/drm_crtc.c
@@ -1869,6 +1869,10 @@ int drm_mode_dirtyfb_ioctl(struct drm_device *dev,
 	}
 
 	if (num_clips && clips_ptr) {
+		if (num_clips < 0 || num_clips > DRM_MODE_FB_DIRTY_MAX_CLIPS) {
+			ret = -EINVAL;
+			goto out_err1;
+		}
 		clips = kzalloc(num_clips * sizeof(*clips), GFP_KERNEL);
 		if (!clips) {
 			ret = -ENOMEM;
diff --git a/include/drm/drm_mode.h b/include/drm/drm_mode.h
index 0fc7397c8f1f..73ce56f238b5 100644
--- a/include/drm/drm_mode.h
+++ b/include/drm/drm_mode.h
@@ -233,6 +233,8 @@ struct drm_mode_fb_cmd {
 #define DRM_MODE_FB_DIRTY_ANNOTATE_FILL 0x02
 #define DRM_MODE_FB_DIRTY_FLAGS         0x03
 
+#define DRM_MODE_FB_DIRTY_MAX_CLIPS     256
+
 /*
  * Mark a region of a framebuffer as dirty.
  *
