Canonical-kernel__Ubuntu-kernel
commit 6d6e9267c970b9e27b0f13e6b0ced0d1911c29bc
Author:     Ben Hutchings <ben@decadent.org.uk>
AuthorDate: Mon Jan 23 16:47:17 2012 +0000
Commit:     Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
CommitDate: Mon Feb 13 17:48:06 2012 -0200

    igmp: Avoid zero delay when receiving odd mixture of IGMP queries
    
    Commit 5b7c84066733c5dfb0e4016d939757b38de189e4 ('ipv4: correct IGMP
    behavior on v3 query during v2-compatibility mode') added yet another
    case for query parsing, which can result in max_delay = 0.  Substitute
    a value of 1, as in the usual v3 case.
    
    Reported-by: Simon McVittie <smcv@debian.org>
    References: http://bugs.debian.org/654876
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    
    (cherry picked from commit a8c1f65c79cbbb2f7da782d4c9d15639a9b94b27)
    CVE-2012-0207
    BugLink: http://bugs.launchpad.net/bugs/917848
    Acked-by: Tim Gardner <tim.gardner@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Andy Whitcroft <apw@canonical.com>

diff --git a/net/ipv4/igmp.c b/net/ipv4/igmp.c
index d9d5130a9122..f574cf63ae4f 100644
--- a/net/ipv4/igmp.c
+++ b/net/ipv4/igmp.c
@@ -892,6 +892,8 @@ static void igmp_heard_query(struct in_device *in_dev, struct sk_buff *skb,
 		 * to be intended in a v3 query.
 		 */
 		max_delay = IGMPV3_MRC(ih3->code)*(HZ/IGMP_TIMER_SCALE);
+		if (!max_delay)
+			max_delay = 1;	/* can't mod w/ 0 */
 	} else { /* v3 */
 		if (!pskb_may_pull(skb, sizeof(struct igmpv3_query)))
 			return;
