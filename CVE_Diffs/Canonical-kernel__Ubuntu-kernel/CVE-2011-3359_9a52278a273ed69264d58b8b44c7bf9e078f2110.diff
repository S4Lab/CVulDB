Canonical-kernel__Ubuntu-kernel
commit 9a52278a273ed69264d58b8b44c7bf9e078f2110
Author:     John W. Linville <linville@tuxdriver.com>
AuthorDate: Thu Dec 22 16:06:00 2011 +0100
Commit:     Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
CommitDate: Mon Jan 2 14:07:38 2012 -0200

    b43: allocate receive buffers big enough for max frame len + offset
    
    Otherwise, skb_put inside of dma_rx can fail...
    
            https://bugzilla.kernel.org/show_bug.cgi?id=32042
    
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    Acked-by: Larry Finger <Larry.Finger@lwfinger.net>
    Cc: stable@kernel.org
    
    (backported from commit c85ce65ecac078ab1a1835c87c4a6319cf74660a)
    CVE-2011-3359
    BugLink: http://bugs.launchpad.net/bugs/905060
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Tim Gardner <tim.gardner@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/drivers/net/wireless/b43/dma.c b/drivers/net/wireless/b43/dma.c
index ddcc0c49a7df..12b07599de9d 100644
--- a/drivers/net/wireless/b43/dma.c
+++ b/drivers/net/wireless/b43/dma.c
@@ -1425,7 +1425,7 @@ static void dma_rx(struct b43_dmaring *ring, int *slot)
 			goto drop;
 		}
 	}
-	if (unlikely(len > ring->rx_buffersize)) {
+	if (unlikely(len + ring->frameoffset > ring->rx_buffersize)) {
 		/* The data did not fit into one descriptor buffer
 		 * and is split over multiple buffers.
 		 * This should never happen, as we try to allocate buffers
diff --git a/drivers/net/wireless/b43/dma.h b/drivers/net/wireless/b43/dma.h
index 3eed185be725..5bd2324bf205 100644
--- a/drivers/net/wireless/b43/dma.h
+++ b/drivers/net/wireless/b43/dma.h
@@ -167,7 +167,7 @@ struct b43_dmadesc_generic {
 /* DMA engine tuning knobs */
 #define B43_TXRING_SLOTS		128
 #define B43_RXRING_SLOTS		64
-#define B43_DMA0_RX_BUFFERSIZE	(2304 + 100)
+#define B43_DMA0_RX_BUFFERSIZE		(B43_DMA0_RX_FRAMEOFFSET + IEEE80211_MAX_FRAME_LEN)
 #define B43_DMA3_RX_BUFFERSIZE	16
 
 #ifdef CONFIG_B43_DMA
