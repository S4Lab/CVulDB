Canonical-kernel__Ubuntu-kernel
commit bb842d3b4bf2f1bdd5bf2d0c24e606d252e5ed70
Author:     Oleg Nesterov <oleg@redhat.com>
AuthorDate: Tue Feb 16 15:02:13 2010 +0100
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Sun Mar 7 19:41:59 2010 +0100

    x86: set_personality_ia32() misses force_personality32
    
    CVE-2010-0307
    
    05d43ed8a "x86: get rid of the insane TIF_ABI_PENDING bit" forgot about
    force_personality32.  Fix.
    
    Signed-off-by: Oleg Nesterov <oleg@redhat.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry-picked from commit 1252f238db48ec419f40c1bdf30fda649860eed9 upstream)
    Signed-off-by: Surbhi Palande <surbhi.palande@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/arch/x86/kernel/process_64.c b/arch/x86/kernel/process_64.c
index 4304e892f609..63105700de47 100644
--- a/arch/x86/kernel/process_64.c
+++ b/arch/x86/kernel/process_64.c
@@ -531,6 +531,7 @@ void set_personality_ia32(void)
 
 	/* Make sure to be in 32bit mode */
 	set_thread_flag(TIF_IA32);
+	current->personality |= force_personality32;
 
 	/* Prepare the first "return" to user space */
 	current_thread_info()->status |= TS_COMPAT;
