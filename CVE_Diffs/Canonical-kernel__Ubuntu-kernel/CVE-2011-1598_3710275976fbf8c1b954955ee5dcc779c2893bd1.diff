Canonical-kernel__Ubuntu-kernel
commit 3710275976fbf8c1b954955ee5dcc779c2893bd1
Author:     Dave Jones <davej@redhat.com>
AuthorDate: Mon Jun 13 11:58:05 2011 +0100
Commit:     Steve Conklin <sconklin@canonical.com>
CommitDate: Fri Jun 24 13:25:43 2011 -0500

    can: Add missing socket check in can/bcm release.
    
    We can get here with a NULL socket argument passed from userspace,
    so we need to handle it accordingly.
    
    Signed-off-by: Dave Jones <davej@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    
    (cherry picked from commit c6914a6f261aca0c9f715f883a353ae7ff51fe83)
    CVE-2011-1598
    BugLink: http://bugs.launchpad.net/bugs/796502
    Acked-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Andy Whitcroft <apw@canonical.com>

diff --git a/net/can/bcm.c b/net/can/bcm.c
index 9d5e8accfab1..56d20a29a7e9 100644
--- a/net/can/bcm.c
+++ b/net/can/bcm.c
@@ -1424,9 +1424,14 @@ static int bcm_init(struct sock *sk)
 static int bcm_release(struct socket *sock)
 {
 	struct sock *sk = sock->sk;
-	struct bcm_sock *bo = bcm_sk(sk);
+	struct bcm_sock *bo;
 	struct bcm_op *op, *next;
 
+	if (sk == NULL)
+		return 0;
+
+	bo = bcm_sk(sk);
+
 	/* remove bcm_ops, timer, rx_unregister(), etc. */
 
 	unregister_netdevice_notifier(&bo->notifier);
