Canonical-kernel__Ubuntu-kernel
commit 7a1a0b66f4c8cd6ea01e048fdc65aba3e9729066
Author:     Alan Cox <alan@lxorguk.ukuu.org.uk>
AuthorDate: Fri Mar 27 00:28:21 2009 -0700
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Jun 24 20:56:23 2009 +0200

    af_rose/x25: Sanity check the maximum user frame size
    
    CVE-2009-1265
    
    commit 83e0bbcbe2145f160fbaa109b0439dae7f4a38a9 upstream
    
    Otherwise we can wrap the sizes and end up sending garbage.
    
    Closes #10423
    
    Signed-off-by: Alan Cox <alan@lxorguk.ukuu.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/net/netrom/af_netrom.c b/net/netrom/af_netrom.c
index 972250c974f1..529c676fe9a1 100644
--- a/net/netrom/af_netrom.c
+++ b/net/netrom/af_netrom.c
@@ -1074,7 +1074,13 @@ static int nr_sendmsg(struct kiocb *iocb, struct socket *sock,
 
 	SOCK_DEBUG(sk, "NET/ROM: sendto: Addresses built.\n");
 
-	/* Build a packet */
+	/* Build a packet - the conventional user limit is 236 bytes. We can
+	   do ludicrously large NetROM frames but must not overflow */
+	if (len > 65536) {
+		err = -EMSGSIZE;
+		goto out;
+	}
+
 	SOCK_DEBUG(sk, "NET/ROM: sendto: building packet.\n");
 	size = len + NR_NETWORK_LEN + NR_TRANSPORT_LEN;
 
diff --git a/net/rose/af_rose.c b/net/rose/af_rose.c
index ed2d65cd8010..ec428256f011 100644
--- a/net/rose/af_rose.c
+++ b/net/rose/af_rose.c
@@ -1100,6 +1100,10 @@ static int rose_sendmsg(struct kiocb *iocb, struct socket *sock,
 
 	/* Build a packet */
 	SOCK_DEBUG(sk, "ROSE: sendto: building packet.\n");
+	/* Sanity check the packet size */
+	if (len > 65535)
+		return -EMSGSIZE;
+
 	size = len + AX25_BPQ_HEADER_LEN + AX25_MAX_HEADER_LEN + ROSE_MIN_LEN;
 
 	if ((skb = sock_alloc_send_skb(sk, size, msg->msg_flags & MSG_DONTWAIT, &err)) == NULL)
diff --git a/net/x25/af_x25.c b/net/x25/af_x25.c
index 92cfe8e3e0b8..6e40c32dba88 100644
--- a/net/x25/af_x25.c
+++ b/net/x25/af_x25.c
@@ -1042,6 +1042,12 @@ static int x25_sendmsg(struct kiocb *iocb, struct socket *sock,
 		sx25.sx25_addr   = x25->dest_addr;
 	}
 
+	/* Sanity check the packet size */
+	if (len > 65535) {
+		rc = -EMSGSIZE;
+		goto out;
+	}
+
 	SOCK_DEBUG(sk, "x25_sendmsg: sendto: Addresses built.\n");
 
 	/* Build a packet */
