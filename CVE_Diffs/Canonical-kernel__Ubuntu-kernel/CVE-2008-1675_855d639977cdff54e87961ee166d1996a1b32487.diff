Canonical-kernel__Ubuntu-kernel
commit 855d639977cdff54e87961ee166d1996a1b32487
Author:     Jeff Garzik <jeff@garzik.org>
AuthorDate: Fri Apr 25 03:11:31 2008 -0400
Commit:     Kees Cook <kees@outflux.net>
CommitDate: Wed May 7 15:36:23 2008 -0700

    tehuti: move ioctl perm check closer to function start (CVE-2008-1675)
    
    [linux-2.6.24.y: f1b6098616f329d26199f278f228a7b27d36558d]
    
    Commit f946dffed6334f08da065a89ed65026ebf8b33b4 upstream
    
    Noticed by davem.
    
    Signed-off-by: Jeff Garzik <jgarzik@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Kees Cook <kees.cook@canonical.com>

diff --git a/drivers/net/tehuti.c b/drivers/net/tehuti.c
index 3349e072545d..fe5be1b94460 100644
--- a/drivers/net/tehuti.c
+++ b/drivers/net/tehuti.c
@@ -649,6 +649,9 @@ static int bdx_ioctl_priv(struct net_device *ndev, struct ifreq *ifr, int cmd)
 		DBG("%d 0x%x 0x%x\n", data[0], data[1], data[2]);
 	}
 
+	if (!capable(CAP_NET_ADMIN))
+		return -EPERM;
+
 	switch (data[0]) {
 
 	case BDX_OP_READ:
@@ -664,8 +667,6 @@ static int bdx_ioctl_priv(struct net_device *ndev, struct ifreq *ifr, int cmd)
 		break;
 
 	case BDX_OP_WRITE:
-		if (!capable(CAP_NET_ADMIN))
-			return -EPERM;
 		error = bdx_range_check(priv, data[1]);
 		if (error < 0)
 			return error;
