Canonical-kernel__Ubuntu-kernel
commit 1c33373c6d4c21c5de8f0da8c2c6a27f09a9897a
Author:     Christoph Hellwig <hch@infradead.org>
AuthorDate: Wed Jan 18 11:28:29 2012 +0000
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Mon Jan 23 13:43:45 2012 -0800

    xfs: validate acl count
    
    This prevents in-memory corruption and possible panics if the on-disk
    ACL is badly corrupted.
    
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Ben Myers <bpm@sgi.com>
    
    (cherry-picked from commit fa8b18edd752a8b4e9d1ee2cd615b82c93cf8bba)
    CVE-2012-0038
    BugLink: http://bugs.launchpad.net/bugs/917706
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Acked-by: Herton Krzesinski <herton.krzesinski@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    
    Signed-off-by: Brad Figg <brad.figg@canonical.com>

diff --git a/fs/xfs/linux-2.6/xfs_acl.c b/fs/xfs/linux-2.6/xfs_acl.c
index 9f769b5b38fc..46556ee5b0d5 100644
--- a/fs/xfs/linux-2.6/xfs_acl.c
+++ b/fs/xfs/linux-2.6/xfs_acl.c
@@ -42,6 +42,8 @@ xfs_acl_from_disk(struct xfs_acl *aclp)
 	int count, i;
 
 	count = be32_to_cpu(aclp->acl_cnt);
+	if (count > XFS_ACL_MAX_ENTRIES)
+		return ERR_PTR(-EFSCORRUPTED);
 
 	acl = posix_acl_alloc(count, GFP_KERNEL);
 	if (!acl)
