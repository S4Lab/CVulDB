Canonical-kernel__Ubuntu-kernel
commit fa351d2bc1eb8c7aab8bd6319fa3b03130cb88fe
Author:     Linus Torvalds <torvalds@linux-foundation.org>
AuthorDate: Fri Aug 13 09:24:04 2010 -0700
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Tue Aug 17 15:44:22 2010 +0200

    mm: fix missing page table unmap for stack guard page failure case
    
    CVE-2010-2240
    
    .. which didn't show up in my tests because it's a no-op on x86-64 and
    most other architectures.  But we enter the function with the last-level
    page table mapped, and should unmap it at exit.
    
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry-picked from commit 5528f9132cf65d4d892bcbc5684c61e7822b21e9 upstream)
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/mm/memory.c b/mm/memory.c
index 99a83c3427f4..101ec5ce2479 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -2652,8 +2652,10 @@ static int do_anonymous_page(struct mm_struct *mm, struct vm_area_struct *vma,
 	spinlock_t *ptl;
 	pte_t entry;
 
-	if (check_stack_guard_page(vma, address) < 0)
+	if (check_stack_guard_page(vma, address) < 0) {
+		pte_unmap(page_table);
 		return VM_FAULT_SIGBUS;
+	}
 
 	if (!(flags & FAULT_FLAG_WRITE)) {
 		entry = pte_mkspecial(pfn_pte(my_zero_pfn(address),
