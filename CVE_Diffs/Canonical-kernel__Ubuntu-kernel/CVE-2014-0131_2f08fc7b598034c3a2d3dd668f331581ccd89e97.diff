Canonical-kernel__Ubuntu-kernel
commit 2f08fc7b598034c3a2d3dd668f331581ccd89e97
Author:     Michael S. Tsirkin <mst@redhat.com>
AuthorDate: Fri Jun 13 12:12:28 2014 +0100
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Wed Jun 25 08:52:40 2014 -0700

    skbuff: skb_segment: orphan frags before copying
    
    skb_segment copies frags around, so we need
    to copy them carefully to avoid accessing
    user memory after reporting completion to userspace
    through a callback.
    
    skb_segment doesn't normally happen on datapath:
    TSO needs to be disabled - so disabling zero copy
    in this case does not look like a big deal.
    
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
    Acked-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (back ported from commit 1fd819ecb90cc9b822cd84d3056ddba315d3340f)
    CVE-2014-0131
    BugLink: http://bugs.launchpad.net/bugs/1298119
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Acked-by: Andy Whitcroft <andy.whitcroft@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/net/core/skbuff.c b/net/core/skbuff.c
index 66e03b1dec72..99a65b4e4adc 100644
--- a/net/core/skbuff.c
+++ b/net/core/skbuff.c
@@ -2739,6 +2739,9 @@ struct sk_buff *skb_segment(struct sk_buff *skb, netdev_features_t features)
 						 skb_put(nskb, hsize), hsize);
 
 		while (pos < offset + len && i < nfrags) {
+			if (unlikely(skb_orphan_frags(skb, GFP_ATOMIC)))
+				goto err;
+
 			*frag = skb_shinfo(skb)->frags[i];
 			__skb_frag_ref(frag);
 			size = skb_frag_size(frag);
