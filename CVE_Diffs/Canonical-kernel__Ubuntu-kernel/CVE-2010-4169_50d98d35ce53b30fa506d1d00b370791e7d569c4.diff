Canonical-kernel__Ubuntu-kernel
commit 50d98d35ce53b30fa506d1d00b370791e7d569c4
Author:     Pekka Enberg <penberg@kernel.org>
AuthorDate: Mon Nov 8 21:29:07 2010 +0200
Commit:     Tim Gardner <tim.gardner@canonical.com>
CommitDate: Wed Jun 22 09:02:48 2011 -0600

    perf_events: Fix perf_counter_mmap() hook in mprotect() - CVE-2010-4169
    
    BugLink: http://bugs.launchpad.net/bugs/690730
    
    commit 63bfd7384b119409685a17d5c58f0b56e5dc03da upstream.
    
    As pointed out by Linus, commit dab5855 ("perf_counter: Add mmap event hooks to
    mprotect()") is fundamentally wrong as mprotect_fixup() can free 'vma' due to
    merging. Fix the problem by moving perf_event_mmap() hook to
    mprotect_fixup().
    
    Note: there's another successful return path from mprotect_fixup() if old
    flags equal to new flags. We don't, however, need to call
    perf_event_mmap() there because 'perf' already knows the VMA is
    executable.
    
    CVE-2010-4169
    
    Reported-by: Dave Jones <davej@redhat.com>
    Signed-off-by: Andi Kleen <ak@linux.intel.com>
    Analyzed-by: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Ingo Molnar <mingo@elte.hu>
    Reviewed-by: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Signed-off-by: Pekka Enberg <penberg@kernel.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Brad Figg <brad.figg@canonical.com>
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/mm/mprotect.c b/mm/mprotect.c
index 4ea460ed538b..5c487ef0ab2f 100644
--- a/mm/mprotect.c
+++ b/mm/mprotect.c
@@ -219,6 +219,7 @@ success:
 	mmu_notifier_invalidate_range_end(mm, start, end);
 	vm_stat_account(mm, oldflags, vma->vm_file, -nrpages);
 	vm_stat_account(mm, newflags, vma->vm_file, nrpages);
+	perf_event_mmap(vma);
 	return 0;
 
 fail:
@@ -307,7 +308,6 @@ SYSCALL_DEFINE3(mprotect, unsigned long, start, size_t, len,
 		error = mprotect_fixup(vma, &prev, nstart, tmp, newflags);
 		if (error)
 			goto out;
-		perf_event_mmap(vma);
 		nstart = tmp;
 
 		if (nstart < prev->vm_end)
