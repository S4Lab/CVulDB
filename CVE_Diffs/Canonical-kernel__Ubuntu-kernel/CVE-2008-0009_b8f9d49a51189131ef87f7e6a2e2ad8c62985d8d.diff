Canonical-kernel__Ubuntu-kernel
commit b8f9d49a51189131ef87f7e6a2e2ad8c62985d8d
Author:     Jens Axboe <jens.axboe@oracle.com>
AuthorDate: Fri Feb 8 08:49:14 2008 -0800
Commit:     Amit Kucheria <amit.kucheria@ubuntu.com>
CommitDate: Mon Feb 11 17:58:47 2008 +0200

    splice: missing user pointer access verification (CVE-2008-0009/10)
    
    patch 8811930dc74a503415b35c4a79d14fb0b408a361 in mainline.
    
    vmsplice_to_user() must always check the user pointer and length
    with access_ok() before copying. Likewise, for the slow path of
    copy_from_user_mmap_sem() we need to check that we may read from
    the user region.
    
    Signed-off-by: Jens Axboe <jens.axboe@oracle.com>
    Cc: Wojciech Purczynski <cliph@research.coseinc.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Amit Kucheria <amit.kucheria@ubuntu.com>

diff --git a/fs/splice.c b/fs/splice.c
index 18263dea36e0..57b91e9d4691 100644
--- a/fs/splice.c
+++ b/fs/splice.c
@@ -1186,6 +1186,9 @@ static int copy_from_user_mmap_sem(void *dst, const void __user *src, size_t n)
 {
 	int partial;
 
+	if (!access_ok(VERIFY_READ, src, n))
+		return -EFAULT;
+
 	pagefault_disable();
 	partial = __copy_from_user_inatomic(dst, src, n);
 	pagefault_enable();
@@ -1394,6 +1397,11 @@ static long vmsplice_to_user(struct file *file, const struct iovec __user *iov,
 			break;
 		}
 
+		if (unlikely(!access_ok(VERIFY_WRITE, base, len))) {
+			error = -EFAULT;
+			break;
+		}
+
 		sd.len = 0;
 		sd.total_len = len;
 		sd.flags = flags;
