Canonical-kernel__Ubuntu-kernel
commit 8cd81ffe959821a4c33b338668ba5a02c01b13e8
Author:     Michael S. Tsirkin <mst@redhat.com>
AuthorDate: Thu Mar 27 12:53:37 2014 +0200
Commit:     Joseph Salisbury <joseph.salisbury@canonical.com>
CommitDate: Tue Apr 22 12:19:42 2014 -0400

    vhost: validate vhost_get_vq_desc return value
    
    BugLink: http://bugs.launchpad.net/bugs/1311196
    
    commit a39ee449f96a2cd44ce056d8a0a112211a9b1a1f upstream.
    
    vhost fails to validate negative error code
    from vhost_get_vq_desc causing
    a crash: we are using -EFAULT which is 0xfffffff2
    as vector size, which exceeds the allocated size.
    
    The code in question was introduced in commit
    8dd014adfea6f173c1ef6378f7e5e7924866c923
        vhost-net: mergeable buffers support
    
    CVE-2014-0055
    
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Signed-off-by: Joseph Salisbury <joseph.salisbury@canonical.com>

diff --git a/drivers/vhost/net.c b/drivers/vhost/net.c
index 1284e7a8ef05..786b86d46ff7 100644
--- a/drivers/vhost/net.c
+++ b/drivers/vhost/net.c
@@ -510,9 +510,13 @@ static int get_rx_bufs(struct vhost_virtqueue *vq,
 			r = -ENOBUFS;
 			goto err;
 		}
-		d = vhost_get_vq_desc(vq->dev, vq, vq->iov + seg,
+		r = vhost_get_vq_desc(vq->dev, vq, vq->iov + seg,
 				      ARRAY_SIZE(vq->iov) - seg, &out,
 				      &in, log, log_num);
+		if (unlikely(r < 0))
+			goto err;
+
+		d = r;
 		if (d == vq->num) {
 			r = 0;
 			goto err;
