Canonical-kernel__Ubuntu-kernel
commit 0057fd5b191da3712a2fb4db23d7016c1d16d9e5
Author:     Linus Torvalds <torvalds@linux-foundation.org>
AuthorDate: Tue Oct 11 17:39:20 2011 +0200
Commit:     Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
CommitDate: Tue Nov 8 17:16:14 2011 -0200

    vm: fix vm_pgoff wrap in stack expansion - CVE-2011-2496
    
    vm: fix vm_pgoff wrap in stack expansion
    
    Commit 982134ba6261 ("mm: avoid wrapping vm_pgoff in mremap()") fixed
    the case of a expanding mapping causing vm_pgoff wrapping when you used
    mremap.  But there was another case where we expand mappings hiding in
    plain sight: the automatic stack expansion.
    
    This fixes that case too.
    
    This one also found by Robert ÅwiÄcki, using his nasty system call
    fuzzer tool.  Good job.
    
    Reported-and-tested-by: Robert ÅwiÄcki <robert@swiecki.net>
    Cc: stable@kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    
    CVE-2011-2496
    
    BugLink: http://bugs.launchpad.net/bugs/869243
    
    Backported from a626ca6a656450e9f4df91d0dda238fff23285f4
    
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>
    Acked-by: Seth Forshee <seth.forshee@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/mm/mmap.c b/mm/mmap.c
index 0f54503a80ce..6aa3f806030d 100644
--- a/mm/mmap.c
+++ b/mm/mmap.c
@@ -1781,10 +1781,13 @@ static int expand_downwards(struct vm_area_struct *vma,
 		size = vma->vm_end - address;
 		grow = (vma->vm_start - address) >> PAGE_SHIFT;
 
-		error = acct_stack_growth(vma, size, grow);
-		if (!error) {
-			vma->vm_start = address;
-			vma->vm_pgoff -= grow;
+		error = -ENOMEM;
+		if (grow <= vma->vm_pgoff) {
+			error = acct_stack_growth(vma, size, grow);
+			if (!error) {
+				vma->vm_start = address;
+				vma->vm_pgoff -= grow;
+			}
 		}
 	}
 	anon_vma_unlock(vma);
