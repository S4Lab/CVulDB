Canonical-kernel__Ubuntu-kernel
commit 70b62ba42064aa0da5036feba431084041250abb
Author:     David Howells <dhowells@redhat.com>
AuthorDate: Fri Oct 30 13:13:26 2009 +0000
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Dec 2 10:54:21 2009 +0100

    NOMMU: Don't pass NULL pointers to fput() in do_mmap_pgoff()
    
    CVE-2009-3888
    
    Don't pass NULL pointers to fput() in the error handling paths of the NOMMU
    do_mmap_pgoff() as it can't handle it.
    
    The following can be used as a test program:
    
            int main() { static long long a[1024 * 1024 * 20] = { 0 }; return a;}
    
    Without the patch, the code oopses in atomic_long_dec_and_test() as called by
    fput() after the kernel complains that it can't allocate that big a chunk of
    memory.  With the patch, the kernel just complains about the allocation size
    and then the program segfaults during execve() as execve() can't complete the
    allocation of all the new ELF program segments.
    
    Reported-by: Robin Getz <rgetz@blackfin.uclinux.org>
    Signed-off-by: David Howells <dhowells@redhat.com>
    Acked-by: Robin Getz <rgetz@blackfin.uclinux.org>
    Cc: stable@kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry picked from commit 89a8640279f8bb78aaf778d1fc5c4a6778f18064)
    
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/mm/nommu.c b/mm/nommu.c
index 82fedca84577..be69e4dd011c 100644
--- a/mm/nommu.c
+++ b/mm/nommu.c
@@ -1318,7 +1318,8 @@ unsigned long do_mmap_pgoff(struct file *file,
 					goto error_just_free;
 				}
 			}
-			fput(region->vm_file);
+			if (region->vm_file)
+				fput(region->vm_file);
 			kmem_cache_free(vm_region_jar, region);
 			region = pregion;
 			result = start;
@@ -1384,9 +1385,11 @@ share:
 error_just_free:
 	up_write(&nommu_region_sem);
 error:
-	fput(region->vm_file);
+	if (region->vm_file)
+		fput(region->vm_file);
 	kmem_cache_free(vm_region_jar, region);
-	fput(vma->vm_file);
+	if (vma->vm_file)
+		fput(vma->vm_file);
 	if (vma->vm_flags & VM_EXECUTABLE)
 		removed_exe_file_vma(vma->vm_mm);
 	kmem_cache_free(vm_area_cachep, vma);
