Canonical-kernel__Ubuntu-kernel
commit c8657e029343ed36cca487773b6be44e86462e5a
Author:     Sachin Prabhu <sprabhu@redhat.com>
AuthorDate: Thu Mar 11 12:24:45 2010 -0500
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Tue May 25 13:57:32 2010 +0200

    GFS2: Skip check for mandatory locks when unlocking
    
    CVE-2010-0727
    
    gfs2_lock() will skip locks on file which have mode set to 02666. This is a problem in cases where the mode of the file is changed after a process has obtained a lock on the file. Such a lock will be skipped and will result in a BUG in locks_remove_flock().
    
    gfs2_lock() should skip the check for mandatory locks when unlocking a file.
    
    Signed-off-by: Sachin Prabhu <sprabhu@redhat.com>
    Signed-off-by: Steven Whitehouse <swhiteho@redhat.com>
    (cherry picked from commit 720e7749279bde0d08684b1bb4e7a2eedeec6394 upstream)
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/gfs2/file.c b/fs/gfs2/file.c
index 73318a3ce6f1..52d8785ba054 100644
--- a/fs/gfs2/file.c
+++ b/fs/gfs2/file.c
@@ -607,7 +607,7 @@ static int gfs2_lock(struct file *file, int cmd, struct file_lock *fl)
 
 	if (!(fl->fl_flags & FL_POSIX))
 		return -ENOLCK;
-	if (__mandatory_lock(&ip->i_inode))
+	if (__mandatory_lock(&ip->i_inode) && fl->fl_type != F_UNLCK)
 		return -ENOLCK;
 
 	if (cmd == F_CANCELLK) {
