Canonical-kernel__Ubuntu-kernel
commit c677329b3cb1643fe558bdcce06a65160cbbabbd
Author:     Matthew Daley <mattd@bugfuzz.com>
AuthorDate: Mon Apr 28 19:05:20 2014 +1200
Commit:     Kamal Mostafa <kamal@canonical.com>
CommitDate: Wed May 7 11:26:44 2014 -0700

    floppy: ignore kernel-only members in FDRAWCMD ioctl input
    
    CVE-2014-1737
    
    BugLink: http://bugs.launchpad.net/bugs/1316729
    
    Always clear out these floppy_raw_cmd struct members after copying the
    entire structure from userspace so that the in-kernel version is always
    valid and never left in an interdeterminate state.
    
    Signed-off-by: Matthew Daley <mattd@bugfuzz.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry picked from commit ef87dbe7614341c2e7bfe8d32fcb7028cc97442c)
    Acked-by: Andy Whitcroft <andy.whitcroft@canonical.com>
    Signed-off-by: Kamal Mostafa <kamal@canonical.com>

diff --git a/drivers/block/floppy.c b/drivers/block/floppy.c
index 059315b7d75e..c6a957085905 100644
--- a/drivers/block/floppy.c
+++ b/drivers/block/floppy.c
@@ -3108,10 +3108,11 @@ loop:
 		return -ENOMEM;
 	*rcmd = ptr;
 	ret = copy_from_user(ptr, param, sizeof(*ptr));
-	if (ret)
-		return -EFAULT;
 	ptr->next = NULL;
 	ptr->buffer_length = 0;
+	ptr->kernel_data = NULL;
+	if (ret)
+		return -EFAULT;
 	param += sizeof(struct floppy_raw_cmd);
 	if (ptr->cmd_count > 33)
 			/* the command may now also take up the space
@@ -3127,7 +3128,6 @@ loop:
 	for (i = 0; i < 16; i++)
 		ptr->reply[i] = 0;
 	ptr->resultcode = 0;
-	ptr->kernel_data = NULL;
 
 	if (ptr->flags & (FD_RAW_READ | FD_RAW_WRITE)) {
 		if (ptr->length <= 0)
