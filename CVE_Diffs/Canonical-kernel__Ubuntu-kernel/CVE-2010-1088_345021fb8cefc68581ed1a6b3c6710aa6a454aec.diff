Canonical-kernel__Ubuntu-kernel
commit 345021fb8cefc68581ed1a6b3c6710aa6a454aec
Author:     Stefan Bader <stefan.bader@canonical.com>
AuthorDate: Thu May 20 10:34:52 2010 +0200
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Tue May 25 14:08:58 2010 +0200

    UBUNTU: OPENVZ: Fix patch failure on fs/namei.c
    
    CVE-2010-1088
    
    Upstream changes to fs/namei.c by
    
    commit ac278a9c505092dd82077a2446af8f9fc0d9c095 upstream
        fix LOOKUP_FOLLOW on automount "symlinks"
    
    caused a patch of openvz not to apply anymore. Adapted patch
    accordingly.
    
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/debian/binary-custom.d/openvz/patchset/0001-2.6.24-ovz002.patch b/debian/binary-custom.d/openvz/patchset/0001-2.6.24-ovz002.patch
index 7a146eee0443..2001ac2616e8 100644
--- a/debian/binary-custom.d/openvz/patchset/0001-2.6.24-ovz002.patch
+++ b/debian/binary-custom.d/openvz/patchset/0001-2.6.24-ovz002.patch
@@ -10838,14 +10838,16 @@ Index: kernel/fs/namei.c
  			err = do_follow_link(&next, nd);
  			if (err)
  				goto return_err;
-@@ -972,6 +1005,7 @@
+@@ -972,7 +1005,8 @@
+ 		if (err)
  			break;
  		inode = next.dentry->d_inode;
- 		if ((lookup_flags & LOOKUP_FOLLOW)
-+		    && !(lookup_flags & LOOKUP_STRICT)
- 		    && inode && inode->i_op && inode->i_op->follow_link) {
+-		if (follow_on_final(inode, lookup_flags)) {
++		if (follow_on_final(inode, lookup_flags)
++		    && !(lookup_flags & LOOKUP_STRICT)) {
  			err = do_follow_link(&next, nd);
  			if (err)
+ 				goto return_err
 @@ -993,26 +1027,40 @@
  		nd->last_type = LAST_NORM;
  		if (this.name[0] != '.')
