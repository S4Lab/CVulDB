Canonical-kernel__Ubuntu-kernel
commit faddf0cd6c64089b4a0e32e6bd92c7e587d37f51
Author:     Frederic Bohe <frederic.bohe@bull.net>
AuthorDate: Fri Jun 20 11:48:48 2008 -0400
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Mar 18 15:39:15 2009 +0100

    Ext4: Fix online resize block group descriptor corruption
    
    CVE-2009-0745
    
    commit 2856922c158605514ec5974a03097eaec91f4c0d upstream
    
    This is the patch for the group descriptor table corruption during
    online resize pointed out by Theodore Tso.  The problem was caused by
    the fact that the ext4 group descriptor can be either 32 or 64 bytes
    long.  Only the 64 bytes structure was taken into account.
    
    Signed-off-by: Frederic Bohe <frederic.bohe@bull.net>
    Signed-off-by: Mingming Cao <cmm@us.ibm.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/ext4/resize.c b/fs/ext4/resize.c
index bd8a52bb3999..13a40bf18f5b 100644
--- a/fs/ext4/resize.c
+++ b/fs/ext4/resize.c
@@ -857,7 +857,8 @@ int ext4_group_add(struct super_block *sb, struct ext4_new_group_data *input)
 	 */
 
 	/* Update group descriptor block for new group */
-	gdp = (struct ext4_group_desc *)primary->b_data + gdb_off;
+	gdp = (struct ext4_group_desc *)((char *)primary->b_data +
+					 gdb_off * EXT4_DESC_SIZE(sb));
 
 	ext4_block_bitmap_set(sb, gdp, input->block_bitmap); /* LV FIXME */
 	ext4_inode_bitmap_set(sb, gdp, input->inode_bitmap); /* LV FIXME */
