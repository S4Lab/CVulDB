Canonical-kernel__Ubuntu-kernel
commit 04946e9d02d9682225683f9cd3bd0b4f0b4cf311
Author:     Jeff Layton <jlayton@redhat.com>
AuthorDate: Tue Oct 25 17:12:24 2011 +0100
Commit:     Tim Gardner <tim.gardner@canonical.com>
CommitDate: Tue Oct 25 11:31:50 2011 -0600

    cifs: fix NULL pointer dereference in cifs_find_smb_ses, CVE-2011-1585
    
    cifs_find_smb_ses assumes that the vol->password field is a valid
    pointer, but that's only the case if a password was passed in via
    the options string. It's possible that one won't be if there is
    no mount helper on the box.
    
    Reported-by: diabel <gacek-2004@wp.pl>
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <sfrench@us.ibm.com>
    
    (cherry picked from commit fc87a40677bbe0937e2ff0642c7e83c9a4813f3d)
    CVE-2011-1585
    BugLink: http://bugs.launchpad.net/bugs/869208
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/fs/cifs/connect.c b/fs/cifs/connect.c
index 2ea5948c39c1..bbf1c258a7a8 100644
--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@ -1583,7 +1583,8 @@ cifs_find_smb_ses(struct TCP_Server_Info *server, struct smb_vol *vol)
 				    MAX_USERNAME_SIZE))
 				continue;
 			if (strlen(vol->username) != 0 &&
-			    strncmp(ses->password, vol->password,
+			    strncmp(ses->password,
+				    vol->password ? vol->password : "",
 				    MAX_PASSWORD_SIZE))
 				continue;
 		}
