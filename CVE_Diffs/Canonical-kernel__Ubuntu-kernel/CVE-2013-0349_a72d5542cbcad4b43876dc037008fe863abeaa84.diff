Canonical-kernel__Ubuntu-kernel
commit a72d5542cbcad4b43876dc037008fe863abeaa84
Author:     Anderson Lizardo <anderson.lizardo@openbossa.org>
AuthorDate: Tue Apr 9 11:52:31 2013 +0100
Commit:     Andy Whitcroft <apw@canonical.com>
CommitDate: Tue Apr 9 13:05:51 2013 +0100

    Bluetooth: Fix incorrect strncpy() in hidp_setup_hid()
    
    CVE-2013-0349
    
    BugLink: http://bugs.launchpad.net/bugs/1134503
    
    The length parameter should be sizeof(req->name) - 1 because there is no
    guarantee that string provided by userspace will contain the trailing
    '\0'.
    
    Can be easily reproduced by manually setting req->name to 128 non-zero
    bytes prior to ioctl(HIDPCONNADD) and checking the device name setup on
    input subsystem:
    
    $ cat /sys/devices/pnp0/00\:04/tty/ttyS0/hci0/hci0\:1/input8/name
    AAAAAA[...]AAAAAAAAf0:af:f0:af:f0:af
    
    ("f0:af:f0:af:f0:af" is the device bluetooth address, taken from "phys"
    field in struct hid_device due to overflow.)
    
    Cc: stable@vger.kernel.org
    Signed-off-by: Anderson Lizardo <anderson.lizardo@openbossa.org>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Gustavo Padovan <gustavo.padovan@collabora.co.uk>
    (back ported from commit 0a9ab9bdb3e891762553f667066190c1d22ad62b)
    
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Acked-by: Colin King <colin.king@canonical.com>
    Acked-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Andy Whitcroft <apw@canonical.com>

diff --git a/net/bluetooth/hidp/core.c b/net/bluetooth/hidp/core.c
index 49d8495d69be..0c2c59d29d6c 100644
--- a/net/bluetooth/hidp/core.c
+++ b/net/bluetooth/hidp/core.c
@@ -778,7 +778,7 @@ static int hidp_setup_hid(struct hidp_session *session,
 	hid->version = req->version;
 	hid->country = req->country;
 
-	strncpy(hid->name, req->name, 128);
+	strncpy(hid->name, req->name, sizeof(req->name) - 1);
 	strncpy(hid->phys, batostr(&src), 64);
 	strncpy(hid->uniq, batostr(&dst), 64);
 
