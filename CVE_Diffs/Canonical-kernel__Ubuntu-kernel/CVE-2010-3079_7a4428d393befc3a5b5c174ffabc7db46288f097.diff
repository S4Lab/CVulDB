Canonical-kernel__Ubuntu-kernel
commit 7a4428d393befc3a5b5c174ffabc7db46288f097
Author:     Chris Wright <chrisw@sous-sol.org>
AuthorDate: Thu Sep 9 16:34:59 2010 -0700
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Tue Sep 21 13:24:45 2010 -0700

    tracing: t_start: reset FTRACE_ITER_HASH in case of seek/pread
    
    BugLink: http://bugs.launchpad.net/bugs/644694
    
    commit df09162550fbb53354f0c88e85b5d0e6129ee9cc upstream.
    
    Be sure to avoid entering t_show() with FTRACE_ITER_HASH set without
    having properly started the iterator to iterate the hash.  This case is
    degenerate and, as discovered by Robert Swiecki, can cause t_hash_show()
    to misuse a pointer.  This causes a NULL ptr deref with possible security
    implications.  Tracked as CVE-2010-3079.
    
    Cc: Robert Swiecki <swiecki@google.com>
    Cc: Eugene Teo <eugene@redhat.com>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>
    Signed-off-by: Steven Rostedt <rostedt@goodmis.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Acked-by: Brad Figg <brad.figg@canonical.com>
    Acked-by: Steve Conklin <sconklin@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Brad Figg <brad.figg@canonical.com>

diff --git a/kernel/trace/ftrace.c b/kernel/trace/ftrace.c
index e153d7212286..22cf21e9e792 100644
--- a/kernel/trace/ftrace.c
+++ b/kernel/trace/ftrace.c
@@ -1480,6 +1480,8 @@ static void *t_start(struct seq_file *m, loff_t *pos)
 		if (*pos > 0)
 			return t_hash_start(m, pos);
 		iter->flags |= FTRACE_ITER_PRINTALL;
+		/* reset in case of seek/pread */
+		iter->flags &= ~FTRACE_ITER_HASH;
 		return iter;
 	}
 
