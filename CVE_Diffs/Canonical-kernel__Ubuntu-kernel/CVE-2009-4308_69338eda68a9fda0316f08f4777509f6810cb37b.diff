Canonical-kernel__Ubuntu-kernel
commit 69338eda68a9fda0316f08f4777509f6810cb37b
Author:     Theodore Ts'o <tytso@mit.edu>
AuthorDate: Mon Jul 27 23:09:47 2009 -0400
Commit:     Leann Ogasawara <leann.ogasawara@canonical.com>
CommitDate: Sun Jan 24 12:09:57 2010 -0800

    ext4: Avoid null pointer dereference when decoding EROFS w/o a journal
    
    CVE-2009-4308
    
    We need to check to make sure a journal is present before checking the
    journal flags in ext4_decode_error().
    
    Signed-off-by: Eric Sesterhenn <eric.sesterhenn@lsexperts.de>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    (cherry picked from commit 78f1ddbb498283c2445c11b0dfa666424c301803)
    
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>

diff --git a/fs/ext4/super.c b/fs/ext4/super.c
index 1ca0f546c466..f1b5f9119c7f 100644
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@ -256,7 +256,8 @@ static const char *ext4_decode_error(struct super_block * sb, int errno,
 		errstr = "Out of memory";
 		break;
 	case -EROFS:
-		if (!sb || EXT4_SB(sb)->s_journal->j_flags & JBD2_ABORT)
+		if (!sb || (EXT4_SB(sb)->s_journal &&
+			    EXT4_SB(sb)->s_journal->j_flags & JBD2_ABORT))
 			errstr = "Journal has aborted";
 		else
 			errstr = "Readonly filesystem";
