Canonical-kernel__Ubuntu-kernel
commit b8d5b37fde9aa6d5e62ab53a7a8365bdd13b9dbb
Author:     Stefan Bader <stefan.bader@canonical.com>
AuthorDate: Fri Mar 5 18:34:00 2010 +0100
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Mar 10 17:09:36 2010 +0100

    UBUNTU: xen: Remove TIF_ABI_PENDING bit
    
    CVE-2010-0307
    
    As TIF_ABI_PENDING has been removed from the kernel the xen patches need
    to be updated, too.
    
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/debian/binary-custom.d/xen/patchset/001-xen-base.patch b/debian/binary-custom.d/xen/patchset/001-xen-base.patch
index b67f875c8091..1dc439a1cb0a 100644
--- a/debian/binary-custom.d/xen/patchset/001-xen-base.patch
+++ b/debian/binary-custom.d/xen/patchset/001-xen-base.patch
@@ -20888,7 +20888,7 @@ diff -Naur ubuntu-hardy/arch/x86/kernel/process_32-xen.c ubuntu-hardy-xen/arch/x
 diff -Naur ubuntu-hardy/arch/x86/kernel/process_64-xen.c ubuntu-hardy-xen/arch/x86/kernel/process_64-xen.c
 --- ubuntu-hardy/arch/x86/kernel/process_64-xen.c	1970-01-01 01:00:00.000000000 +0100
 +++ ubuntu-hardy-xen/arch/x86/kernel/process_64-xen.c	2008-04-09 13:17:22.000000000 +0100
-@@ -0,0 +1,884 @@
+@@ -0,0 +1,875 @@
 +/*
 + *  Copyright (C) 1995  Linus Torvalds
 + *
@@ -21244,15 +21244,6 @@ diff -Naur ubuntu-hardy/arch/x86/kernel/process_64-xen.c ubuntu-hardy-xen/arch/x
 +{
 +	struct task_struct *tsk = current;
 +
-+	if (test_tsk_thread_flag(tsk, TIF_ABI_PENDING)) {
-+		clear_tsk_thread_flag(tsk, TIF_ABI_PENDING);
-+		if (test_tsk_thread_flag(tsk, TIF_IA32)) {
-+			clear_tsk_thread_flag(tsk, TIF_IA32);
-+		} else {
-+			set_tsk_thread_flag(tsk, TIF_IA32);
-+			current_thread_info()->status |= TS_COMPAT;
-+		}
-+	}
 +	clear_tsk_thread_flag(tsk, TIF_DEBUG);
 +
 +	tsk->thread.debugreg0 = 0;
diff --git a/debian/binary-custom.d/xen/patchset/010-xen-add-personality-ia32.patch b/debian/binary-custom.d/xen/patchset/010-xen-add-personality-ia32.patch
new file mode 100644
index 000000000000..113ba4b63a0c
--- /dev/null
+++ b/debian/binary-custom.d/xen/patchset/010-xen-add-personality-ia32.patch
@@ -0,0 +1,24 @@
+diff -Nurp custom-source-xen/arch/x86/kernel/process_64-xen.c custom-source-xen-new/arch/x86/kernel/process_64-xen.c
+--- custom-source-xen/arch/x86/kernel/process_64-xen.c	2010-03-05 18:37:04.917991247 +0100
++++ custom-source-xen-new/arch/x86/kernel/process_64-xen.c	2010-03-05 18:47:53.665991812 +0100
+@@ -683,6 +683,20 @@ void set_personality_64bit(void)
+ 	current->personality &= ~READ_IMPLIES_EXEC;
+ }
+ 
++extern int force_personality32;
++
++void set_personality_ia32(void)
++{
++	/* inherit personality from parent */
++
++	/* Make sure to be in 32bit mode */
++	set_thread_flag(TIF_IA32);
++	current->personality |= force_personality32;
++
++	/* Prepare the first "return" to user space */
++	current_thread_info()->status |= TS_COMPAT;
++}
++
+ asmlinkage long sys_fork(struct pt_regs *regs)
+ {
+ 	return do_fork(SIGCHLD, regs->rsp, regs, 0, NULL, NULL);
