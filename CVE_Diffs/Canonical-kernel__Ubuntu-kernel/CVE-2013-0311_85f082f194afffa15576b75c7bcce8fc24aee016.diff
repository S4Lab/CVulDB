Canonical-kernel__Ubuntu-kernel
commit 85f082f194afffa15576b75c7bcce8fc24aee016
Author:     Michael S. Tsirkin <mst@redhat.com>
AuthorDate: Thu Feb 21 19:08:00 2013 +0000
Commit:     Luis Henriques <luis.henriques@canonical.com>
CommitDate: Fri Feb 22 17:32:27 2013 +0000

    vhost: fix length for cross region descriptor
    
    CVE-2013-0311
    
    BugLink: http://bugs.launchpad.net/bugs/1130951
    
    If a single descriptor crosses a region, the
    second chunk length should be decremented
    by size translated so far, instead it includes
    the full descriptor length.
    
    Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
    Acked-by: Jason Wang <jasowang@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit bd97120fc3d1a11f3124c7c9ba1d91f51829eb85)
    
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.c
index 61047fe31206..e3fac280e462 100644
--- a/drivers/vhost/vhost.c
+++ b/drivers/vhost/vhost.c
@@ -986,7 +986,7 @@ static int translate_desc(struct vhost_dev *dev, u64 addr, u32 len,
 		}
 		_iov = iov + ret;
 		size = reg->memory_size - addr + reg->guest_phys_addr;
-		_iov->iov_len = min((u64)len, size);
+		_iov->iov_len = min((u64)len - s, size);
 		_iov->iov_base = (void __user *)(unsigned long)
 			(reg->userspace_addr + addr - reg->guest_phys_addr);
 		s += size;
