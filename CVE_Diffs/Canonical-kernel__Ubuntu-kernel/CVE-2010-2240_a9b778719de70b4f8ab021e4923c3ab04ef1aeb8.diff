Canonical-kernel__Ubuntu-kernel
commit a9b778719de70b4f8ab021e4923c3ab04ef1aeb8
Author:     Hugh Dickins <hugh@veritas.com>
AuthorDate: Thu Apr 16 21:58:12 2009 +0100
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Aug 18 11:25:41 2010 +0200

    mm: pass correct mm when growing stack
    
    CVE-2010-2240
    
    Tetsuo Handa reports seeing the WARN_ON(current->mm == NULL) in
    security_vm_enough_memory(), when do_execve() is touching the
    target mm's stack, to set up its args and environment.
    
    Yes, a UMH_NO_WAIT or UMH_WAIT_PROC call_usermodehelper() spawns
    an mm-less kernel thread to do the exec.  And in any case, that
    vm_enough_memory check when growing stack ought to be done on the
    target mm, not on the execer's mm (though apart from the warning,
    it only makes a slight tweak to OVERCOMMIT_NEVER behaviour).
    
    Reported-by: Tetsuo Handa <penguin-kernel@i-love.sakura.ne.jp>
    Signed-off-by: Hugh Dickins <hugh@veritas.com>
    Cc: stable@kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry-picked from commit 05fa199d45c54a9bda7aa3ae6537253d6f097aa9 upstream)
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/mm/mmap.c b/mm/mmap.c
index 0923b5db2a3c..6f9b289fc848 100644
--- a/mm/mmap.c
+++ b/mm/mmap.c
@@ -1545,7 +1545,7 @@ static int acct_stack_growth(struct vm_area_struct * vma, unsigned long size, un
 	 * Overcommit..  This must be the final test, as it will
 	 * update security statistics.
 	 */
-	if (security_vm_enough_memory(grow))
+	if (security_vm_enough_memory_mm(mm, grow))
 		return -ENOMEM;
 
 	/* Ok, everything looks good - let it rip */
