Canonical-kernel__Ubuntu-kernel
commit 1a640d1e5398aa5f4914851e82371a03025e1833
Author:     Leann Ogasawara <leann.ogasawara@canonical.com>
AuthorDate: Thu Mar 17 10:21:25 2011 -0700
Commit:     Paolo Pisati <paolo.pisati@canonical.com>
CommitDate: Thu Jun 9 16:43:42 2011 +0200

    econet: Fix crash in aun_incoming() - CVE-2010-4342
    
    CVE-2010-4342
    
    BugLink: http://bugs.launchpad.net/bugs/736394
    
    Unconditional use of skb->dev won't work here,
    try to fetch the econet device via skb_dst()->dev
    instead.
    
    Suggested by Eric Dumazet.
    
    CVE-2010-4342
    Reported-by: Nelson Elhage <nelhage@ksplice.com>
    Tested-by: Nelson Elhage <nelhage@ksplice.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (backport of upstream commit 4e085e76cbe558b79b54cbab772f61185879bc64)
    
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Acked-by: Brad Figg <brad.figg@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>

diff --git a/net/econet/af_econet.c b/net/econet/af_econet.c
index 690da47810d0..6bc2f6d1b9d2 100644
--- a/net/econet/af_econet.c
+++ b/net/econet/af_econet.c
@@ -844,8 +844,12 @@ static void aun_incoming(struct sk_buff *skb, struct aunhdr *ah, size_t len)
 	struct iphdr *ip = ip_hdr(skb);
 	unsigned char stn = ntohl(ip->saddr) & 0xff;
 	struct sock *sk;
+	struct dst_entry *dst = skb_dst(skb);
+	struct ec_device *edev = NULL;
 	struct sk_buff *newskb;
-	struct ec_device *edev = skb->dev->ec_ptr;
+
+	if (dst)
+		edev = dst->dev->ec_ptr;
 
 	if (! edev)
 		goto bad;
