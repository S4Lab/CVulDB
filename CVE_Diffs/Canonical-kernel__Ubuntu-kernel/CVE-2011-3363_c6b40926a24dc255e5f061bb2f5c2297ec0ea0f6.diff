Canonical-kernel__Ubuntu-kernel
commit c6b40926a24dc255e5f061bb2f5c2297ec0ea0f6
Author:     Jeff Layton <jlayton@redhat.com>
AuthorDate: Tue Oct 4 15:59:50 2011 +0100
Commit:     Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
CommitDate: Mon Oct 10 14:29:41 2011 -0300

    cifs: add fallback in is_path_accessible for old servers, CVE-2011-3363
    
    The is_path_accessible check uses a QPathInfo call, which isn't
    supported by ancient win9x era servers. Fall back to an older
    SMBQueryInfo call if it fails with the magic error codes.
    
    Cc: stable@kernel.org
    Reported-and-Tested-by: Sandro Bonazzola <sandro.bonazzola@gmail.com>
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <sfrench@us.ibm.com>
    
    (cherry picked from commit 221d1d797202984cb874e3ed9f1388593d34ee22)
    CVE-2011-3363
    BugLink: http://bugs.launchpad.net/bugs/866034
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/fs/cifs/connect.c b/fs/cifs/connect.c
index 50d60cc80ce8..aa92c97ae00a 100644
--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@ -2422,6 +2422,11 @@ is_path_accessible(int xid, struct cifsTconInfo *tcon,
 			      0 /* not legacy */, cifs_sb->local_nls,
 			      cifs_sb->mnt_cifs_flags &
 				CIFS_MOUNT_MAP_SPECIAL_CHR);
+
+	if (rc == -EOPNOTSUPP || rc == -EINVAL)
+		rc = SMBQueryInformation(xid, tcon, full_path, pfile_info,
+				cifs_sb->local_nls, cifs_sb->mnt_cifs_flags &
+				  CIFS_MOUNT_MAP_SPECIAL_CHR);
 	kfree(pfile_info);
 	return rc;
 }
