Canonical-kernel__Ubuntu-kernel
commit fe51d3a02d3405f144879166917fe1b9a1e47f99
Author:     Dan Rosenberg <dan.j.rosenberg@gmail.com>
AuthorDate: Sat May 15 11:27:37 2010 -0400
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Tue Jul 20 17:32:45 2010 +0200

    Btrfs: check for read permission on src file in the clone ioctl
    
    CVE-2010-1636
    
    The existing code would have allowed you to clone a file that was
    only open for writing
    
    Signed-off-by: Chris Mason <chris.mason@oracle.com>
    (cherry-picked from commit 5dc6416414fb3ec6e2825fd4d20c8bf1d7fe0395 upstream)
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.c
index bd88f25889f7..582785b13bb0 100644
--- a/fs/btrfs/ioctl.c
+++ b/fs/btrfs/ioctl.c
@@ -907,12 +907,17 @@ static long btrfs_ioctl_clone(struct file *file, unsigned long srcfd,
 		ret = -EBADF;
 		goto out_drop_write;
 	}
+
 	src = src_file->f_dentry->d_inode;
 
 	ret = -EINVAL;
 	if (src == inode)
 		goto out_fput;
 
+	/* the src must be open for reading */
+	if (!(src_file->f_mode & FMODE_READ))
+		goto out_fput;
+
 	ret = -EISDIR;
 	if (S_ISDIR(src->i_mode) || S_ISDIR(inode->i_mode))
 		goto out_fput;
