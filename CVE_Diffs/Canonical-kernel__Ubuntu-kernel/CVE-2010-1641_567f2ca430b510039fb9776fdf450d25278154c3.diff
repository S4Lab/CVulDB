Canonical-kernel__Ubuntu-kernel
commit 567f2ca430b510039fb9776fdf450d25278154c3
Author:     Steven Whitehouse <swhiteho@redhat.com>
AuthorDate: Mon May 24 14:36:48 2010 +0100
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Tue Jul 20 17:36:54 2010 +0200

    GFS2: Fix permissions checking for setflags ioctl()
    
    CVE-2010-1641
    
    We should be checking for the ownership of the file for which
    flags are being set, rather than just for write access.
    
    Reported-by: Dan Rosenberg <dan.j.rosenberg@gmail.com>
    Signed-off-by: Steven Whitehouse <swhiteho@redhat.com>
    (cherry-picked from commit 7df0e0397b9a18358573274db9fdab991941062f upstream)
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/gfs2/ops_file.c b/fs/gfs2/ops_file.c
index 1526188a2329..8dc44b298078 100644
--- a/fs/gfs2/ops_file.c
+++ b/fs/gfs2/ops_file.c
@@ -224,6 +224,10 @@ static int do_gfs2_set_flags(struct file *filp, u32 reqflags, u32 mask)
 	if (error)
 		return error;
 
+	error = -EACCES;
+	if (!is_owner_or_cap(inode))
+		goto out;
+
 	flags = ip->i_di.di_flags;
 	new_flags = (flags & ~mask) | (reqflags & mask);
 	if ((new_flags ^ flags) == 0)
@@ -279,8 +283,10 @@ static int gfs2_set_flags(struct file *filp, u32 __user *ptr)
 {
 	struct inode *inode = filp->f_path.dentry->d_inode;
 	u32 fsflags, gfsflags;
+
 	if (get_user(fsflags, ptr))
 		return -EFAULT;
+
 	gfsflags = fsflags_cvt(fsflags_to_gfs2, fsflags);
 	if (!S_ISDIR(inode->i_mode)) {
 		if (gfsflags & GFS2_DIF_INHERIT_JDATA)
