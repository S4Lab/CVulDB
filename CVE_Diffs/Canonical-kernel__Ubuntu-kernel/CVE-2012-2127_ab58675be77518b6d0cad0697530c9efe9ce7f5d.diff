Canonical-kernel__Ubuntu-kernel
commit ab58675be77518b6d0cad0697530c9efe9ce7f5d
Author:     Al Viro <viro@zeniv.linux.org.uk>
AuthorDate: Thu Dec 8 23:20:45 2011 -0500
Commit:     Luis Henriques <luis.henriques@canonical.com>
CommitDate: Mon Sep 24 18:29:37 2012 +0100

    procfs: fix a vfsmount longterm reference leak
    
    CVE-2012-2127
    
    BugLink: http://bugs.launchpad.net/bugs/990365
    
    kern_mount() doesn't pair with plain mntput()...
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    (cherry picked from commit 905ad269c55fc62bee3da29f7b1d1efeba8aa1e1)
    
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    Acked-by: Seth Forshee <seth.forshee@canonical.com>
    Acked-by: Herton Krzesinski <herton.krzesinski@canonical.com>

diff --git a/fs/proc/root.c b/fs/proc/root.c
index d6c3b416529b..1421d66a695f 100644
--- a/fs/proc/root.c
+++ b/fs/proc/root.c
@@ -91,20 +91,18 @@ static struct file_system_type proc_fs_type = {
 
 void __init proc_root_init(void)
 {
-	struct vfsmount *mnt;
 	int err;
 
 	proc_init_inodecache();
 	err = register_filesystem(&proc_fs_type);
 	if (err)
 		return;
-	mnt = kern_mount_data(&proc_fs_type, &init_pid_ns);
-	if (IS_ERR(mnt)) {
+	err = pid_ns_prepare_proc(&init_pid_ns);
+	if (err) {
 		unregister_filesystem(&proc_fs_type);
 		return;
 	}
 
-	init_pid_ns.proc_mnt = mnt;
 	proc_symlink("mounts", NULL, "self/mounts");
 
 	proc_net_init();
@@ -209,5 +207,5 @@ int pid_ns_prepare_proc(struct pid_namespace *ns)
 
 void pid_ns_release_proc(struct pid_namespace *ns)
 {
-	mntput(ns->proc_mnt);
+	kern_unmount(ns->proc_mnt);
 }
