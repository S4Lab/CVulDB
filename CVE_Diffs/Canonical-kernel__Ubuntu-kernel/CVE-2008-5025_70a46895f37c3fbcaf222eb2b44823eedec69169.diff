Canonical-kernel__Ubuntu-kernel
commit 70a46895f37c3fbcaf222eb2b44823eedec69169
Author:     Eric Sesterhenn <snakebyte@gmx.de>
AuthorDate: Wed Oct 15 22:04:11 2008 -0700
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Thu Nov 20 09:44:14 2008 +0100

    hfs: fix namelength memory corruption
    
    CVE-2008-5025
    
    Fix a stack corruption caused by a corrupted hfs filesystem.  If the
    catalog name length is corrupted the memcpy overwrites the catalog btree
    structure.  Since the field is limited to HFS_NAMELEN bytes in the
    structure and the file format, we throw an error if it is too long.
    
    Cc: Roman Zippel <zippel@linux-m68k.org>
    Signed-off-by: Eric Sesterhenn <snakebyte@gmx.de>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/hfs/catalog.c b/fs/hfs/catalog.c
index ba851576ebb1..6d98f116ca03 100644
--- a/fs/hfs/catalog.c
+++ b/fs/hfs/catalog.c
@@ -190,6 +190,10 @@ int hfs_cat_find_brec(struct super_block *sb, u32 cnid,
 
 	fd->search_key->cat.ParID = rec.thread.ParID;
 	len = fd->search_key->cat.CName.len = rec.thread.CName.len;
+	if (len > HFS_NAMELEN) {
+		printk(KERN_ERR "hfs: bad catalog namelength\n");
+		return -EIO;
+	}
 	memcpy(fd->search_key->cat.CName.name, rec.thread.CName.name, len);
 	return hfs_brec_find(fd);
 }
