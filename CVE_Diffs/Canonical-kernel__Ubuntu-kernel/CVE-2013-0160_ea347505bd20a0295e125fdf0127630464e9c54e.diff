Canonical-kernel__Ubuntu-kernel
commit ea347505bd20a0295e125fdf0127630464e9c54e
Author:     Linus Torvalds <torvalds@linux-foundation.org>
AuthorDate: Fri Jan 24 14:17:25 2014 +0000
Commit:     rtg <tim.gardner@canonical.com>
CommitDate: Mon Jan 27 12:47:24 2014 +0000

    tty: fix up atime/mtime mess, take three
    
    CVE-2013-0160
    
    BugLink: http://bugs.launchpad.net/bugs/1097680
    
    We first tried to avoid updating atime/mtime entirely (commit
    b0de59b5733d: "TTY: do not update atime/mtime on read/write"), and then
    limited it to only update it occasionally (commit 37b7f3c76595: "TTY:
    fix atime/mtime regression"), but it turns out that this was both
    insufficient and overkill.
    
    It was insufficient because we let people attach to the shared ptmx node
    to see activity without even reading atime/mtime, and it was overkill
    because the "only once a minute" means that you can't really tell an
    idle person from an active one with 'w'.
    
    So this tries to fix the problem properly.  It marks the shared ptmx
    node as un-notifiable, and it lowers the "only once a minute" to a few
    seconds instead - still long enough that you can't time individual
    keystrokes, but short enough that you can tell whether somebody is
    active or not.
    
    Reported-by: Simon Kirby <sim@hostway.ca>
    Acked-by: Jiri Slaby <jslaby@suse.cz>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: stable@vger.kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (back ported from commit b0b885657b6c8ef63a46bc9299b2a7715d19acde)
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Acked-by: Andy Whitcroft <andy.whitcroft@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/drivers/char/pty.c b/drivers/char/pty.c
index 62f282e67638..a2899c76c45f 100644
--- a/drivers/char/pty.c
+++ b/drivers/char/pty.c
@@ -639,6 +639,9 @@ static int __ptmx_open(struct inode *inode, struct file *filp)
 
 	nonseekable_open(inode, filp);
 
+	/* We refuse fsnotify events on ptmx, since it's a shared resource */
+	filp->f_mode |= FMODE_NONOTIFY;
+
 	/* find a device that is not in use. */
 	index = devpts_new_index(inode);
 	if (index < 0)
diff --git a/drivers/char/tty_io.c b/drivers/char/tty_io.c
index 3dd0586d305f..ad8c374890ae 100644
--- a/drivers/char/tty_io.c
+++ b/drivers/char/tty_io.c
@@ -856,10 +856,10 @@ void start_tty(struct tty_struct *tty)
 
 EXPORT_SYMBOL(start_tty);
 
+/* We limit tty time update visibility to every 8 seconds or so. */
 static void tty_update_time(struct timespec *time)
 {
-	unsigned long sec = get_seconds();
-	sec -= sec % 60;
+	unsigned long sec = get_seconds() & ~7;
 	if ((long)(sec - time->tv_sec) > 0)
 		time->tv_sec = sec;
 }
