Canonical-kernel__Ubuntu-kernel
commit ad43db5a592e927faed31f7b44cf099d7944b498
Author:     Dave Jones <davej@redhat.com>
AuthorDate: Mon Jun 13 11:58:05 2011 +0100
Commit:     Andy Whitcroft <apw@canonical.com>
CommitDate: Tue Jun 14 09:20:49 2011 +0100

    can: Add missing socket check in can/bcm release.
    
    We can get here with a NULL socket argument passed from userspace,
    so we need to handle it accordingly.
    
    Signed-off-by: Dave Jones <davej@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    
    (cherry picked from commit c6914a6f261aca0c9f715f883a353ae7ff51fe83)
    CVE-2011-1598
    BugLink: http://bugs.launchpad.net/bugs/796502
    Acked-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Andy Whitcroft <apw@canonical.com>

diff --git a/net/can/bcm.c b/net/can/bcm.c
index 9968a4509991..cb39b7ef9732 100644
--- a/net/can/bcm.c
+++ b/net/can/bcm.c
@@ -1433,9 +1433,14 @@ static int bcm_init(struct sock *sk)
 static int bcm_release(struct socket *sock)
 {
 	struct sock *sk = sock->sk;
-	struct bcm_sock *bo = bcm_sk(sk);
+	struct bcm_sock *bo;
 	struct bcm_op *op, *next;
 
+	if (sk == NULL)
+		return 0;
+
+	bo = bcm_sk(sk);
+
 	/* remove bcm_ops, timer, rx_unregister(), etc. */
 
 	unregister_netdevice_notifier(&bo->notifier);
