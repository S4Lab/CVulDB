Canonical-kernel__Ubuntu-kernel
commit 9647e280d9b6ed83d37b6f41fb58d8e33ce39c5e
Author:     Zhu Yi <yi.zhu@intel.com>
AuthorDate: Fri Jul 22 18:42:36 2011 +0100
Commit:     Andy Whitcroft <apw@canonical.com>
CommitDate: Mon Aug 8 12:40:49 2011 +0100

    llc: use limited socket backlog CVE-2010-4251
    
    BugLink: http://bugs.launchpad.net/bugs/807462
    
    Make llc adapt to the limited socket backlog change.
    
    Cc: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
    Signed-off-by: Zhu Yi <yi.zhu@intel.com>
    Acked-by: Eric Dumazet <eric.dumazet@gmail.com>
    Acked-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit 79545b681961d7001c1f4c3eb9ffb87bed4485db)
    
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/net/llc/llc_conn.c b/net/llc/llc_conn.c
index c6bab39b018e..8f97546726b3 100644
--- a/net/llc/llc_conn.c
+++ b/net/llc/llc_conn.c
@@ -756,7 +756,8 @@ void llc_conn_handler(struct llc_sap *sap, struct sk_buff *skb)
 	else {
 		dprintk("%s: adding to backlog...\n", __func__);
 		llc_set_backlog_type(skb, LLC_PACKET);
-		sk_add_backlog(sk, skb);
+		if (sk_add_backlog_limited(sk, skb))
+			goto drop_unlock;
 	}
 out:
 	bh_unlock_sock(sk);
