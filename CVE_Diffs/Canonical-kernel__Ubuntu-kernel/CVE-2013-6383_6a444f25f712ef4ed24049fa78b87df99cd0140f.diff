Canonical-kernel__Ubuntu-kernel
commit 6a444f25f712ef4ed24049fa78b87df99cd0140f
Author:     Dan Carpenter <dan.carpenter@oracle.com>
AuthorDate: Tue Oct 29 22:11:06 2013 +0300
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Thu Jan 2 08:02:25 2014 -0800

    aacraid: missing capable() check in compat ioctl
    
    CVE-2013-6383
    
    BugLink: http://bugs.launchpad.net/bugs/1256094
    
    In commit d496f94d22d1 ('[SCSI] aacraid: fix security weakness') we
    added a check on CAP_SYS_RAWIO to the ioctl.  The compat ioctls need the
    check as well.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Cc: stable@kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry picked from commit f856567b930dfcdbc3323261bf77240ccdde01f5)
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/drivers/scsi/aacraid/linit.c b/drivers/scsi/aacraid/linit.c
index 9b97c3e016fe..387872c98dc5 100644
--- a/drivers/scsi/aacraid/linit.c
+++ b/drivers/scsi/aacraid/linit.c
@@ -754,6 +754,8 @@ static long aac_compat_do_ioctl(struct aac_dev *dev, unsigned cmd, unsigned long
 static int aac_compat_ioctl(struct scsi_device *sdev, int cmd, void __user *arg)
 {
 	struct aac_dev *dev = (struct aac_dev *)sdev->host->hostdata;
+	if (!capable(CAP_SYS_RAWIO))
+		return -EPERM;
 	return aac_compat_do_ioctl(dev, cmd, (unsigned long)arg);
 }
 
