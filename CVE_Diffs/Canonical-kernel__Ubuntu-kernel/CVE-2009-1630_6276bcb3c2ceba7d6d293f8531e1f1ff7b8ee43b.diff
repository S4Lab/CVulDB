Canonical-kernel__Ubuntu-kernel
commit 6276bcb3c2ceba7d6d293f8531e1f1ff7b8ee43b
Author:     Frank Filz <ffilzlnx@us.ibm.com>
AuthorDate: Mon May 18 17:41:40 2009 -0400
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Jun 24 20:56:30 2009 +0200

    nfs: Fix NFS v4 client handling of MAY_EXEC in nfs_permission.
    
    CVE-2009-1630
    
    commit 7ee2cb7f32b299c2b06a31fde155457203e4b7dd upstream
    
    The problem is that permission checking is skipped if atomic open is
    possible, but when exec opens a file, it just opens it O_READONLY which
    means EXEC permission will not be checked at that time.
    
    This problem is observed by the following sequence (executed as root):
    
      mount -t nfs4 server:/ /mnt4
      echo "ls" >/mnt4/foo
      chmod 744 /mnt4/foo
      su guest -c "mnt4/foo"
    
    Signed-off-by: Frank Filz <ffilzlnx@us.ibm.com>
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
    Cc: stable@kernel.org
    Tested-by: Eugene Teo <eugeneteo@kernel.sg>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/nfs/dir.c b/fs/nfs/dir.c
index f697b5c74b7c..8ade9e7880ff 100644
--- a/fs/nfs/dir.c
+++ b/fs/nfs/dir.c
@@ -1913,7 +1913,8 @@ int nfs_permission(struct inode *inode, int mask, struct nameidata *nd)
 			/* NFSv4 has atomic_open... */
 			if (nfs_server_capable(inode, NFS_CAP_ATOMIC_OPEN)
 					&& nd != NULL
-					&& (nd->flags & LOOKUP_OPEN))
+					&& (nd->flags & LOOKUP_OPEN)
+					&& !(mask & MAY_EXEC))
 				goto out;
 			break;
 		case S_IFDIR:
