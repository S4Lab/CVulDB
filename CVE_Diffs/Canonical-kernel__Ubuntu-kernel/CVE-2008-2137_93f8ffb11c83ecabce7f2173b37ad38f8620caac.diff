Canonical-kernel__Ubuntu-kernel
commit 93f8ffb11c83ecabce7f2173b37ad38f8620caac
Author:     David S. Miller <davem@davemloft.net>
AuthorDate: Wed May 7 02:24:28 2008 -0700
Commit:     Kees Cook <kees@outflux.net>
CommitDate: Tue Jun 24 15:12:17 2008 -0700

    (CVE-2008-2137) sparc: Fix mmap VA span checking.
    
    [linux-2.6: 5816339310b2d9623cf413d33e538b45e815da5d]
    
    We should not conditionalize VA range checks on MAP_FIXED.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Kees Cook <kees.cook@canonical.com>

diff --git a/arch/sparc/kernel/sys_sparc.c b/arch/sparc/kernel/sys_sparc.c
index 42bf09db9a81..9f8c8e101e9d 100644
--- a/arch/sparc/kernel/sys_sparc.c
+++ b/arch/sparc/kernel/sys_sparc.c
@@ -224,8 +224,7 @@ int sparc_mmap_check(unsigned long addr, unsigned long len, unsigned long flags)
 {
 	if (ARCH_SUN4C_SUN4 &&
 	    (len > 0x20000000 ||
-	     ((flags & MAP_FIXED) &&
-	      addr < 0xe0000000 && addr + len > 0x20000000)))
+	     (addr < 0xe0000000 && addr + len > 0x20000000)))
 		return -EINVAL;
 
 	/* See asm-sparc/uaccess.h */
diff --git a/arch/sparc64/kernel/sys_sparc.c b/arch/sparc64/kernel/sys_sparc.c
index c56573a10eee..69c766e02bc5 100644
--- a/arch/sparc64/kernel/sys_sparc.c
+++ b/arch/sparc64/kernel/sys_sparc.c
@@ -547,13 +547,13 @@ int sparc64_mmap_check(unsigned long addr, unsigned long len,
 		if (len >= STACK_TOP32)
 			return -EINVAL;
 
-		if ((flags & MAP_FIXED) && addr > STACK_TOP32 - len)
+		if (addr > STACK_TOP32 - len)
 			return -EINVAL;
 	} else {
 		if (len >= VA_EXCLUDE_START)
 			return -EINVAL;
 
-		if ((flags & MAP_FIXED) && invalid_64bit_range(addr, len))
+		if (invalid_64bit_range(addr, len))
 			return -EINVAL;
 	}
 
