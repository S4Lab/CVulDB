Canonical-kernel__Ubuntu-kernel
commit d05ee756e40f3dbf1bb0bac8d2a06a00e0d5e6c9
Author:     Tony Battersby <tonyb@cybernetics.com>
AuthorDate: Wed Feb 4 15:12:04 2009 -0800
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Mar 18 19:00:40 2009 +0100

    shm: fix shmctl(SHM_INFO) lockup with !CONFIG_SHMEM
    
    CVE-2009-0859
    
    commit a68e61e8ff2d46327a37b69056998b47745db6fa upstream
    
    shm_get_stat() assumes that the inode is a "struct shmem_inode_info",
    which is incorrect for !CONFIG_SHMEM (see fs/ramfs/inode.c:
    ramfs_get_inode() vs.  mm/shmem.c: shmem_get_inode()).
    
    This bad assumption can cause shmctl(SHM_INFO) to lockup when
    shm_get_stat() tries to spin_lock(&info->lock).  Users of !CONFIG_SHMEM
    may encounter this lockup simply by invoking the 'ipcs' command.
    
    Reported by Jiri Olsa back in February 2008:
    http://lkml.org/lkml/2008/2/29/74
    
    Signed-off-by: Tony Battersby <tonyb@cybernetics.com>
    Cc: Jiri Kosina <jkosina@suse.cz>
    Reported-by: Jiri Olsa <olsajiri@gmail.com>
    Cc: Hugh Dickins <hugh@veritas.com>
    Cc: <stable@kernel.org>         [2.6.everything]
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/ipc/shm.c b/ipc/shm.c
index 3818fae625c5..ff5c9c8fb2ab 100644
--- a/ipc/shm.c
+++ b/ipc/shm.c
@@ -630,11 +630,15 @@ static void shm_get_stat(struct ipc_namespace *ns, unsigned long *rss,
 			struct address_space *mapping = inode->i_mapping;
 			*rss += (HPAGE_SIZE/PAGE_SIZE)*mapping->nrpages;
 		} else {
+#ifdef CONFIG_SHMEM
 			struct shmem_inode_info *info = SHMEM_I(inode);
 			spin_lock(&info->lock);
 			*rss += inode->i_mapping->nrpages;
 			*swp += info->swapped;
 			spin_unlock(&info->lock);
+#else
+			*rss += inode->i_mapping->nrpages;
+#endif
 		}
 
 		total++;
