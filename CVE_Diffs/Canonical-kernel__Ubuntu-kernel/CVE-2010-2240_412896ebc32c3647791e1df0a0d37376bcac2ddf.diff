Canonical-kernel__Ubuntu-kernel
commit 412896ebc32c3647791e1df0a0d37376bcac2ddf
Author:     Stefan Bader <stefan.bader@canonical.com>
AuthorDate: Tue Aug 24 20:00:42 2010 +0200
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Aug 25 12:54:02 2010 +0000

    UBUNTU: mm: Do not assume ENOMEM when looking at a split stack vma
    
    CVE-2010-2240
    BugLink: http://bugs.launchpad.net/bugs/620994
    
    The test for adding the guard page would try to expand when looking at
    later vmas of a split stack and assume to have hit a vma of different
    type when finding the previous stack vma.
    
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/mm/memory.c b/mm/memory.c
index 7b83de90aa91..c78bad14d6d1 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -2185,11 +2185,16 @@ static inline int check_stack_guard_page(struct vm_area_struct *vma, unsigned lo
 {
 	address &= PAGE_MASK;
 	if ((vma->vm_flags & VM_GROWSDOWN) && address == vma->vm_start) {
+		struct vm_area_struct *prev;
+
 		address -= PAGE_SIZE;
-		if (find_vma(vma->vm_mm, address) != vma)
-			return -ENOMEM;
+		prev = find_vma(vma->vm_mm, address);
 
-		expand_stack(vma, address);
+		if (prev == vma)
+			expand_stack(vma, address);
+		else if (!(prev->vm_flags & VM_GROWSDOWN) ||
+			   prev->vm_end != vma->vm_start)
+				return -ENOMEM;
 	}
 	return 0;
 }
