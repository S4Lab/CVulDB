Canonical-kernel__Ubuntu-kernel
commit eb044dbfe794397cdd1b1722c40b1438e2957d13
Author:     Oleg Nesterov <oleg@redhat.com>
AuthorDate: Tue Feb 16 15:02:13 2010 +0100
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Mar 10 17:09:33 2010 +0100

    x86: set_personality_ia32() misses force_personality32
    
    CVE-2010-0307
    
    05d43ed8a "x86: get rid of the insane TIF_ABI_PENDING bit" forgot about
    force_personality32.  Fix.
    
    Signed-off-by: Oleg Nesterov <oleg@redhat.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry-picked from 1252f238db48ec419f40c1bdf30fda649860eed9 upstream)
    Signed-off-by: Surbhi Palande<surbhi.palande@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/arch/x86/kernel/process_64.c b/arch/x86/kernel/process_64.c
index 9bf94c2eb9d9..c9532f6be2f4 100644
--- a/arch/x86/kernel/process_64.c
+++ b/arch/x86/kernel/process_64.c
@@ -59,6 +59,8 @@ unsigned long kernel_thread_flags = CLONE_VM | CLONE_UNTRACED;
 unsigned long boot_option_idle_override = 0;
 EXPORT_SYMBOL(boot_option_idle_override);
 
+extern int force_personality32;
+
 /*
  * Powermanagement idle function, if any..
  */
@@ -430,6 +432,7 @@ void set_personality_ia32(void)
 
 	/* Make sure to be in 32bit mode */
 	set_thread_flag(TIF_IA32);
+	current->personality |= force_personality32;
 
 	/* Prepare the first "return" to user space */
 	current_thread_info()->status |= TS_COMPAT;
