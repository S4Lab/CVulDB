Canonical-kernel__Ubuntu-kernel
commit 75dedd861610708f70df06b3a3ba201e0d1ad255
Author:     Andy Gospodarek <andy@greyhouse.net>
AuthorDate: Wed Jul 27 16:20:53 2011 +0100
Commit:     Andy Whitcroft <apw@canonical.com>
CommitDate: Mon Aug 8 12:40:58 2011 +0100

    gro: reset skb_iif on reuse, CVE-2011-1478
    
    commit 6d152e23ad1a7a5b40fef1f42e017d66e6115159 upstream.
    
    Like Herbert's change from a few days ago:
    
    66c46d741e2e60f0e8b625b80edb0ab820c46d7a gro: Reset dev pointer on reuse
    
    this may not be necessary at this point, but we should still clean up
    the skb->skb_iif.  If not we may end up with an invalid valid for
    skb->skb_iif when the skb is reused and the check is done in
    __netif_receive_skb.
    
    Signed-off-by: Andy Gospodarek <andy@greyhouse.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Brandon Philips <bphilips@suse.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    
    CVE-2011-1478
    BugLink: http://bugs.launchpad.net/bugs/816549
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/net/core/dev.c b/net/core/dev.c
index bed9dc336934..8b1847c63460 100644
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -2558,6 +2558,7 @@ void napi_reuse_skb(struct napi_struct *napi, struct sk_buff *skb)
 	__skb_pull(skb, skb_headlen(skb));
 	skb_reserve(skb, NET_IP_ALIGN - skb_headroom(skb));
 	skb->dev = napi->dev;
+	skb->iif = 0;
 
 	napi->skb = skb;
 }
