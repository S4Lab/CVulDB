Canonical-kernel__Ubuntu-kernel
commit 04e2879223a23c79a7794b037b18e4754ed5ebb3
Author:     Suresh Jayaraman <sjayaraman@suse.de>
AuthorDate: Mon Apr 20 18:54:36 2009 +0530
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Mon Jun 15 18:11:21 2009 +0200

    cifs: Increase size of tmp_buf in cifs_readdir to avoid potential overflows
    
    CVE-2009-1633
    
    commit 7b0c8fcff47a885743125dd843db64af41af5a61 upstream
    
    Increase size of tmp_buf to possible maximum to avoid potential
    overflows.
    
    Pointed-out-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Suresh Jayaraman <sjayaraman@suse.de>
    Acked-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <sfrench@us.ibm.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/cifs/readdir.c b/fs/cifs/readdir.c
index 0f22def4bdff..0becefaff9d8 100644
--- a/fs/cifs/readdir.c
+++ b/fs/cifs/readdir.c
@@ -1069,7 +1069,7 @@ int cifs_readdir(struct file *file, void *direntry, filldir_t filldir)
 		with the rare long characters alloc more to account for
 		such multibyte target UTF-8 characters. cifs_unicode.c,
 		which actually does the conversion, has the same limit */
-		tmp_buf = kmalloc((2 * NAME_MAX) + 4, GFP_KERNEL);
+		tmp_buf = kmalloc((4 * NAME_MAX) + 2, GFP_KERNEL);
 		for (i = 0; (i < num_to_fill) && (rc == 0); i++) {
 			if (current_entry == NULL) {
 				/* evaluate whether this case is an error */
