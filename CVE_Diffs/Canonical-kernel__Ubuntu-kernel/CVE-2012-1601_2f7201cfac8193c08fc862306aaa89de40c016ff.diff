Canonical-kernel__Ubuntu-kernel
commit 2f7201cfac8193c08fc862306aaa89de40c016ff
Author:     Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
AuthorDate: Wed Jul 11 18:09:00 2012 +0200
Commit:     Luis Henriques <luis.henriques@canonical.com>
CommitDate: Thu Jul 12 10:21:43 2012 +0100

    KVM: fix backport of 3e51570 on hardy
    
    CVE-2012-1601
    
    BugLink: http://bugs.launchpad.net/bugs/971685
    
    John Johansen reported that our backport of 3e51570 ("KVM: Ensure all
    vcpus are consistent with in-kernel irqchip settings") has a bug, and
    suggested possible fixes. We increment kvm->online_vcpus, but not
    decrement it in the case create_vcpu_fd fails, which could cause issues
    if it fails and vm is not destroyed after (counter will be out of sync).
    In the upstream change this is not a problem since the increment is done
    after create_vcpu_fd is called. The solution chosen here is to just
    decrement it on the failure path.
    
    Reported-by: Sasha Levin <sasha.levin@oracle.com>
    Signed-off-by: Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
    Acked-by: Brad Figg <brad.figg@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/debian/binary-custom.d/openvz/src/virt/kvm/kvm_main.c b/debian/binary-custom.d/openvz/src/virt/kvm/kvm_main.c
index d9a8ae0d3cc3..61c18ba5105a 100644
--- a/debian/binary-custom.d/openvz/src/virt/kvm/kvm_main.c
+++ b/debian/binary-custom.d/openvz/src/virt/kvm/kvm_main.c
@@ -823,6 +823,7 @@ static int kvm_vm_ioctl_create_vcpu(struct kvm *kvm, int n)
 unlink:
 	mutex_lock(&kvm->lock);
 	kvm->vcpus[n] = NULL;
+	atomic_dec(&kvm->online_vcpus);
 vcpu_destroy:
 	mutex_unlock(&kvm->lock);
 	kvm_arch_vcpu_destroy(vcpu);
diff --git a/debian/binary-custom.d/xen/src/virt/kvm/kvm_main.c b/debian/binary-custom.d/xen/src/virt/kvm/kvm_main.c
index d9a8ae0d3cc3..61c18ba5105a 100644
--- a/debian/binary-custom.d/xen/src/virt/kvm/kvm_main.c
+++ b/debian/binary-custom.d/xen/src/virt/kvm/kvm_main.c
@@ -823,6 +823,7 @@ static int kvm_vm_ioctl_create_vcpu(struct kvm *kvm, int n)
 unlink:
 	mutex_lock(&kvm->lock);
 	kvm->vcpus[n] = NULL;
+	atomic_dec(&kvm->online_vcpus);
 vcpu_destroy:
 	mutex_unlock(&kvm->lock);
 	kvm_arch_vcpu_destroy(vcpu);
diff --git a/virt/kvm/kvm_main.c b/virt/kvm/kvm_main.c
index d9a8ae0d3cc3..61c18ba5105a 100644
--- a/virt/kvm/kvm_main.c
+++ b/virt/kvm/kvm_main.c
@@ -823,6 +823,7 @@ static int kvm_vm_ioctl_create_vcpu(struct kvm *kvm, int n)
 unlink:
 	mutex_lock(&kvm->lock);
 	kvm->vcpus[n] = NULL;
+	atomic_dec(&kvm->online_vcpus);
 vcpu_destroy:
 	mutex_unlock(&kvm->lock);
 	kvm_arch_vcpu_destroy(vcpu);
