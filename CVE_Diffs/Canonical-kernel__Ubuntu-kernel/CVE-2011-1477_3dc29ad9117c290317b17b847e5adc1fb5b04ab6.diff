Canonical-kernel__Ubuntu-kernel
commit 3dc29ad9117c290317b17b847e5adc1fb5b04ab6
Author:     Dan Rosenberg <drosenberg@vsecurity.com>
AuthorDate: Thu Feb 2 10:17:14 2012 +0000
Commit:     Tim Gardner <tim.gardner@canonical.com>
CommitDate: Mon Feb 13 07:45:57 2012 -0700

    sound/oss/opl3: validate voice and channel indexes
    
    User-controllable indexes for voice and channel values may cause reading
    and writing beyond the bounds of their respective arrays, leading to
    potentially exploitable memory corruption.  Validate these indexes.
    
    Signed-off-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Cc: stable@kernel.org
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    
    (cherry picked from commit 4d00135a680727f6c3be78f8befaac009030e4df)
    CVE-2011-1477
    BugLink: http://bugs.launchpad.net/bugs/925335
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Acked-by: Herton Krzesinski <herton.krzesinski@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/debian/binary-custom.d/openvz/src/sound/oss/opl3.c b/debian/binary-custom.d/openvz/src/sound/oss/opl3.c
index 6b5f54b60077..4e912dd3b35e 100644
--- a/debian/binary-custom.d/openvz/src/sound/oss/opl3.c
+++ b/debian/binary-custom.d/openvz/src/sound/oss/opl3.c
@@ -844,6 +844,10 @@ static int opl3_load_patch(int dev, int format, const char __user *addr,
 
 static void opl3_panning(int dev, int voice, int value)
 {
+
+	if (voice < 0 || voice >= devc->nr_voice)
+		return;
+
 	devc->voc[voice].panning = value;
 }
 
@@ -1061,8 +1065,15 @@ static int opl3_alloc_voice(int dev, int chn, int note, struct voice_alloc_info
 
 static void opl3_setup_voice(int dev, int voice, int chn)
 {
-	struct channel_info *info =
-	&synth_devs[dev]->chn_info[chn];
+	struct channel_info *info;
+
+	if (voice < 0 || voice >= devc->nr_voice)
+		return;
+
+	if (chn < 0 || chn > 15)
+		return;
+
+	info = &synth_devs[dev]->chn_info[chn];
 
 	opl3_set_instr(dev, voice, info->pgm_num);
 
diff --git a/debian/binary-custom.d/xen/src/sound/oss/opl3.c b/debian/binary-custom.d/xen/src/sound/oss/opl3.c
index 6b5f54b60077..4e912dd3b35e 100644
--- a/debian/binary-custom.d/xen/src/sound/oss/opl3.c
+++ b/debian/binary-custom.d/xen/src/sound/oss/opl3.c
@@ -844,6 +844,10 @@ static int opl3_load_patch(int dev, int format, const char __user *addr,
 
 static void opl3_panning(int dev, int voice, int value)
 {
+
+	if (voice < 0 || voice >= devc->nr_voice)
+		return;
+
 	devc->voc[voice].panning = value;
 }
 
@@ -1061,8 +1065,15 @@ static int opl3_alloc_voice(int dev, int chn, int note, struct voice_alloc_info
 
 static void opl3_setup_voice(int dev, int voice, int chn)
 {
-	struct channel_info *info =
-	&synth_devs[dev]->chn_info[chn];
+	struct channel_info *info;
+
+	if (voice < 0 || voice >= devc->nr_voice)
+		return;
+
+	if (chn < 0 || chn > 15)
+		return;
+
+	info = &synth_devs[dev]->chn_info[chn];
 
 	opl3_set_instr(dev, voice, info->pgm_num);
 
diff --git a/sound/oss/opl3.c b/sound/oss/opl3.c
index 6b5f54b60077..4e912dd3b35e 100644
--- a/sound/oss/opl3.c
+++ b/sound/oss/opl3.c
@@ -844,6 +844,10 @@ static int opl3_load_patch(int dev, int format, const char __user *addr,
 
 static void opl3_panning(int dev, int voice, int value)
 {
+
+	if (voice < 0 || voice >= devc->nr_voice)
+		return;
+
 	devc->voc[voice].panning = value;
 }
 
@@ -1061,8 +1065,15 @@ static int opl3_alloc_voice(int dev, int chn, int note, struct voice_alloc_info
 
 static void opl3_setup_voice(int dev, int voice, int chn)
 {
-	struct channel_info *info =
-	&synth_devs[dev]->chn_info[chn];
+	struct channel_info *info;
+
+	if (voice < 0 || voice >= devc->nr_voice)
+		return;
+
+	if (chn < 0 || chn > 15)
+		return;
+
+	info = &synth_devs[dev]->chn_info[chn];
 
 	opl3_set_instr(dev, voice, info->pgm_num);
 
