Canonical-kernel__Ubuntu-kernel
commit ee33aa352c7ce5b5cb1748eeb322be9ea7bb0056
Author:     Takashi Iwai <tiwai@suse.de>
AuthorDate: Mon Sep 6 09:13:45 2010 +0200
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Tue Sep 21 13:24:40 2010 -0700

    ALSA: seq/oss - Fix double-free at error path of snd_seq_oss_open()
    
    BugLink: http://bugs.launchpad.net/bugs/644694
    
    commit 27f7ad53829f79e799a253285318bff79ece15bd upstream.
    
    The error handling in snd_seq_oss_open() has several bad codes that
    do dereferecing released pointers and double-free of kmalloc'ed data.
    The object dp is release in free_devinfo() that is called via
    private_free callback.  The rest shouldn't touch this object any more.
    
    The patch changes delete_port() to call kfree() in any case, and gets
    rid of unnecessary calls of destructors in snd_seq_oss_open().
    
    Fixes CVE-2010-3080.
    
    Reported-and-tested-by: Tavis Ormandy <taviso@cmpxchg8b.com>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Acked-by: Brad Figg <brad.figg@canonical.com>
    Acked-by: Steve Conklin <sconklin@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Brad Figg <brad.figg@canonical.com>

diff --git a/sound/core/seq/oss/seq_oss_init.c b/sound/core/seq/oss/seq_oss_init.c
index d0d721c22eac..1f133fe4228b 100644
--- a/sound/core/seq/oss/seq_oss_init.c
+++ b/sound/core/seq/oss/seq_oss_init.c
@@ -280,13 +280,10 @@ snd_seq_oss_open(struct file *file, int level)
 	return 0;
 
  _error:
-	snd_seq_oss_writeq_delete(dp->writeq);
-	snd_seq_oss_readq_delete(dp->readq);
 	snd_seq_oss_synth_cleanup(dp);
 	snd_seq_oss_midi_cleanup(dp);
-	delete_port(dp);
 	delete_seq_queue(dp->queue);
-	kfree(dp);
+	delete_port(dp);
 
 	return rc;
 }
@@ -349,8 +346,10 @@ create_port(struct seq_oss_devinfo *dp)
 static int
 delete_port(struct seq_oss_devinfo *dp)
 {
-	if (dp->port < 0)
+	if (dp->port < 0) {
+		kfree(dp);
 		return 0;
+	}
 
 	debug_printk(("delete_port %i\n", dp->port));
 	return snd_seq_event_port_detach(dp->cseq, dp->port);
