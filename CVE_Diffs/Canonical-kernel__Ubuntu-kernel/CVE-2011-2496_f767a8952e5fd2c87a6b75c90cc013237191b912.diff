Canonical-kernel__Ubuntu-kernel
commit f767a8952e5fd2c87a6b75c90cc013237191b912
Author:     Hugh Dickins <hughd@google.com>
AuthorDate: Wed Oct 12 13:03:11 2011 +0200
Commit:     Tim Gardner <tim.gardner@canonical.com>
CommitDate: Wed Oct 12 15:37:21 2011 +0100

    vm: fix vm_pgoff wrap in upward expansion
    
    vm: fix vm_pgoff wrap in upward expansion
    
    Commit a626ca6a6564 ("vm: fix vm_pgoff wrap in stack expansion") fixed
    the case of an expanding mapping causing vm_pgoff wrapping when you had
    downward stack expansion.  But there was another case where IA64 and
    PA-RISC expand mappings: upward expansion.
    
    This fixes that case too.
    
    Signed-off-by: Hugh Dickins <hughd@google.com>
    Cc: stable@kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    
    CVE-2011-2496
    
    BugLink: http://bugs.launchpad.net/bugs/869243
    
    (cherry picked from commit 42c36f63ac1366ab0ecc2d5717821362c259f517)
    
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/mm/mmap.c b/mm/mmap.c
index 968c3e026153..e9cc67698246 100644
--- a/mm/mmap.c
+++ b/mm/mmap.c
@@ -1867,10 +1867,13 @@ int expand_upwards(struct vm_area_struct *vma, unsigned long address)
 		size = address - vma->vm_start;
 		grow = (address - vma->vm_end) >> PAGE_SHIFT;
 
-		error = acct_stack_growth(vma, size, grow);
-		if (!error) {
-			vma->vm_end = address;
-			perf_event_mmap(vma);
+		error = -ENOMEM;
+		if (vma->vm_pgoff + (size >> PAGE_SHIFT) >= vma->vm_pgoff) {
+			error = acct_stack_growth(vma, size, grow);
+			if (!error) {
+				vma->vm_end = address;
+				perf_event_mmap(vma);
+			}
 		}
 	}
 	vma_unlock_anon_vma(vma);
