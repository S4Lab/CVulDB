Canonical-kernel__Ubuntu-kernel
commit 43022c48d6df78a50f5bfaf1c1079115c7bd988a
Author:     Tim Gardner <tim.gardner@canonical.com>
AuthorDate: Fri Feb 18 12:49:29 2011 -0700
Commit:     Steve Conklin <sconklin@canonical.com>
CommitDate: Fri Feb 25 11:19:12 2011 -0600

    bio: take care not overflow page count when mapping/copying user data, CVE-2010-4162
    
    BugLink: http://bugs.launchpad.net/bugs/721441
    
    CVE-2010-4162
    
    backported from commit cb4644cac4a2797afc847e6c92736664d4b0ea34 upstream.
    
    If the iovec is being set up in a way that causes uaddr + PAGE_SIZE
    to overflow, we could end up attempting to map a huge number of
    pages. Check for this invalid input type.
    
    Reported-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Acked-by: Brad Figg <brad.figg@canonical.com>
    Acked-by: John Johansen <john.johansen@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/fs/bio.c b/fs/bio.c
index d59ddbf79626..2c8224c053eb 100644
--- a/fs/bio.c
+++ b/fs/bio.c
@@ -609,6 +609,12 @@ static struct bio *__bio_map_user_iov(struct request_queue *q,
 		unsigned long end = (uaddr + len + PAGE_SIZE - 1) >> PAGE_SHIFT;
 		unsigned long start = uaddr >> PAGE_SHIFT;
 
+		/*
+		 * Overflow, abort
+		 */
+		if (end < start)
+			return ERR_PTR(-EINVAL);
+
 		nr_pages += end - start;
 		/*
 		 * buffer must be aligned to at least hardsector size for now
