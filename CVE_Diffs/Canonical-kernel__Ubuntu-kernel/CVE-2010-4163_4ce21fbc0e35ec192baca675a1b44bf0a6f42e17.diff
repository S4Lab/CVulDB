Canonical-kernel__Ubuntu-kernel
commit 4ce21fbc0e35ec192baca675a1b44bf0a6f42e17
Author:     Jens Axboe <jaxboe@fusionio.com>
AuthorDate: Fri Oct 29 08:10:18 2010 -0600
Commit:     Tim Gardner <tim.gardner@canonical.com>
CommitDate: Wed Jun 22 09:02:49 2011 -0600

    block: check for proper length of iov entries in blk_rq_map_user_iov() - CVE-2010-4163
    
    BugLink: http://bugs.launchpad.net/bugs/690730
    
    commit 9284bcf4e335e5f18a8bc7b26461c33ab60d0689 upstream.
    
    Ensure that we pass down properly validated iov segments before
    calling into the mapping or copy functions.
    
    CVE-2010-4163
    
    Reported-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Andi Kleen <ak@linux.intel.com>
    Signed-off-by: Brad Figg <brad.figg@canonical.com>
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/block/blk-map.c b/block/blk-map.c
index 9083cf0180cc..30a7e5158930 100644
--- a/block/blk-map.c
+++ b/block/blk-map.c
@@ -205,6 +205,8 @@ int blk_rq_map_user_iov(struct request_queue *q, struct request *rq,
 			unaligned = 1;
 			break;
 		}
+		if (!iov[i].iov_len)
+			return -EINVAL;
 	}
 
 	if (unaligned || (q->dma_pad_mask & len) || map_data)
