Canonical-kernel__Ubuntu-kernel
commit 35842316304eaa8f101bb66765fcfe99604f96c3
Author:     Matthew Daley <mattd@bugfuzz.com>
AuthorDate: Tue May 6 20:10:33 2014 +0100
Commit:     Andy Whitcroft <apw@canonical.com>
CommitDate: Wed May 7 18:23:04 2014 +0100

    floppy: don't write kernel-only members to FDRAWCMD ioctl output
    
    Do not leak kernel-only floppy_raw_cmd structure members to userspace.
    This includes the linked-list pointer and the pointer to the allocated
    DMA space.
    
    Signed-off-by: Matthew Daley <mattd@bugfuzz.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    
    (backported from commit 2145e15e0557a01b9195d1c7199a1b92cb9be81f upstream)
    CVE-2014-1738
    BugLink: http://bugs.launchpad.net/bugs/1316735
    Signed-off-by: Andy Whitcroft <apw@canonical.com>

diff --git a/drivers/block/floppy.c b/drivers/block/floppy.c
index e0022b1b9879..ca539c62e79c 100644
--- a/drivers/block/floppy.c
+++ b/drivers/block/floppy.c
@@ -3162,7 +3162,10 @@ static inline int raw_cmd_copyout(int cmd, char __user *param,
 	int ret;
 
 	while (ptr) {
-		COPYOUT(*ptr);
+		struct floppy_raw_cmd cmd = *ptr;
+		cmd.next = NULL;
+		cmd.kernel_data = NULL;
+		COPYOUT(cmd);
 		param += sizeof(struct floppy_raw_cmd);
 		if ((ptr->flags & FD_RAW_READ) && ptr->buffer_length) {
 			if (ptr->length >= 0
