Canonical-kernel__Ubuntu-kernel
commit c9e166702c111e7c425618bdc4b53333b06131fe
Author:     Kees Cook <keescook@chromium.org>
AuthorDate: Fri Apr 12 14:14:32 2013 +0100
Commit:     Tim Gardner <tim.gardner@canonical.com>
CommitDate: Fri Apr 12 08:09:53 2013 -0600

    fs/compat_ioctl.c: VIDEO_SET_SPU_PALETTE missing error check
    
    CVE-2013-1928
    
    BugLink: http://bugs.launchpad.net/bugs/1167061
    
    The compat ioctl for VIDEO_SET_SPU_PALETTE was missing an error check
    while converting ioctl arguments.  This could lead to leaking kernel
    stack contents into userspace.
    
    Patch extracted from existing fix in grsecurity.
    
    Signed-off-by: Kees Cook <keescook@chromium.org>
    Cc: David Miller <davem@davemloft.net>
    Cc: Brad Spengler <spender@grsecurity.net>
    Cc: PaX Team <pageexec@freemail.hu>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry picked from commit 12176503366885edd542389eed3aaf94be163fdb)
    
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/fs/compat_ioctl.c b/fs/compat_ioctl.c
index c30134b2ee63..98d3c581a4bc 100644
--- a/fs/compat_ioctl.c
+++ b/fs/compat_ioctl.c
@@ -234,6 +234,8 @@ static int do_video_set_spu_palette(unsigned int fd, unsigned int cmd, unsigned
 	up = (struct compat_video_spu_palette __user *) arg;
 	err  = get_user(palp, &up->palette);
 	err |= get_user(length, &up->length);
+	if (err)
+		return -EFAULT;
 
 	up_native = compat_alloc_user_space(sizeof(struct video_spu_palette));
 	err  = put_user(compat_ptr(palp), &up_native->palette);
