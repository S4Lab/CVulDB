Canonical-kernel__Ubuntu-kernel
commit 1a3d526151295e4aa2bc5b17daad6793fa9b32d6
Author:     Vasiliy Kulikov <segoon@openwall.com>
AuthorDate: Tue Oct 4 18:52:37 2011 +0100
Commit:     Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
CommitDate: Mon Oct 10 12:48:22 2011 -0300

    proc: restrict access to /proc/PID/io, CVE-2011-2495
    
    /proc/PID/io may be used for gathering private information.  E.g.  for
    openssh and vsftpd daemons wchars/rchars may be used to learn the
    precise password length.  Restrict it to processes being able to ptrace
    the target process.
    
    ptrace_may_access() is needed to prevent keeping open file descriptor of
    "io" file, executing setuid binary and gathering io information of the
    setuid'ed process.
    
    Signed-off-by: Vasiliy Kulikov <segoon@openwall.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    
    (backported from commit 1d1221f375c94ef961ba8574ac4f85c8870ddd51)
    CVE-2011-2495
    BugLink: http://bugs.launchpad.net/bugs/866025
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/fs/proc/base.c b/fs/proc/base.c
index a68a4ba0d7ae..7b9485b2fbc3 100644
--- a/fs/proc/base.c
+++ b/fs/proc/base.c
@@ -2256,6 +2256,9 @@ static int proc_base_fill_cache(struct file *filp, void *dirent,
 #ifdef CONFIG_TASK_IO_ACCOUNTING
 static int proc_pid_io_accounting(struct task_struct *task, char *buffer)
 {
+	if (!ptrace_may_attach(task))
+		return -EACCES;
+
 	return sprintf(buffer,
 #ifdef CONFIG_TASK_XACCT
 			"rchar: %llu\n"
@@ -2342,7 +2345,7 @@ static const struct pid_entry tgid_base_stuff[] = {
 	REG("coredump_filter", S_IRUGO|S_IWUSR, coredump_filter),
 #endif
 #ifdef CONFIG_TASK_IO_ACCOUNTING
-	INF("io",	S_IRUGO, pid_io_accounting),
+	INF("io",	S_IRUSR, pid_io_accounting),
 #endif
 };
 
