Canonical-kernel__Ubuntu-kernel
commit c9ce7bc6dbff9d1a00cb46432cbfc4f6e86a37bb
Author:     Theodore Ts'o <tytso@mit.edu>
AuthorDate: Wed Jun 2 22:04:39 2010 -0400
Commit:     Steve Conklin <sconklin@canonical.com>
CommitDate: Wed Oct 6 18:15:42 2010 +0100

    ext4: Make sure the MOVE_EXT ioctl can't overwrite append-only files
    
    CVE-2010-2066
    
    Dan Roseberg has reported a problem with the MOVE_EXT ioctl.  If the
    donor file is an append-only file, we should not allow the operation
    to proceed, lest we end up overwriting the contents of an append-only
    file.
    
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Cc: Dan Rosenberg <dan.j.rosenberg@gmail.com>
    Signed-off-by: Brad Figg <brad.figg@canonical.com>

diff --git a/fs/ext4/move_extent.c b/fs/ext4/move_extent.c
index 9a573a62dd63..9af9efe6e193 100644
--- a/fs/ext4/move_extent.c
+++ b/fs/ext4/move_extent.c
@@ -964,6 +964,9 @@ mext_check_arguments(struct inode *orig_inode,
 		return -EINVAL;
 	}
 
+	if (IS_IMMUTABLE(donor_inode) || IS_APPEND(donor_inode))
+		return -EPERM;
+
 	/* Ext4 move extent does not support swapfile */
 	if (IS_SWAPFILE(orig_inode) || IS_SWAPFILE(donor_inode)) {
 		ext4_debug("ext4 move extent: The argument files should "
