Canonical-kernel__Ubuntu-kernel
commit dd60e9db3d9ae0084491b964bd5a386830e35a31
Author:     Leann Ogasawara <leann.ogasawara@canonical.com>
AuthorDate: Tue Oct 6 22:42:50 2009 -0700
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Oct 14 17:22:42 2009 +0200

    SELinux: call cap_file_mmap in selinux_file_mmap
    
    CVE-2009-2695
    
    commit 8cf948e744e0218af604c32edecde10006dc8e9e upstream
    
    Currently SELinux does not check CAP_SYS_RAWIO in the file_mmap hook. This
    means there is no DAC check on the ability to mmap low addresses in the
    memory space.  This function adds the DAC check for CAP_SYS_RAWIO while
    maintaining the selinux check on mmap_zero.  This means that processes
    which need to mmap low memory will need CAP_SYS_RAWIO and mmap_zero but will
    NOT need the SELinux sys_rawio capability.
    
    Signed-off-by: Eric Paris <eparis@redhat.com>
    Signed-off-by: James Morris <jmorris@namei.org>
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>

diff --git a/security/selinux/hooks.c b/security/selinux/hooks.c
index 9ffe40c19188..cf094f915887 100644
--- a/security/selinux/hooks.c
+++ b/security/selinux/hooks.c
@@ -2601,9 +2601,21 @@ static int selinux_file_mmap(struct file *file, unsigned long reqprot,
 	int rc = 0;
 	u32 sid = ((struct task_security_struct*)(current->security))->sid;
 
-	if (addr < mmap_min_addr)
+	/*
+	 * notice that we are intentionally putting the SELinux check before
+	 * the secondary cap_file_mmap check.  This is such a likely attempt
+	 * at bad behaviour/exploit that we always want to get the AVC, even
+	 * if DAC would have also denied the operation.
+	 */
+	if (addr < mmap_min_addr) {
 		rc = avc_has_perm(sid, sid, SECCLASS_MEMPROTECT,
 				  MEMPROTECT__MMAP_ZERO, NULL);
+		if (rc)
+			return rc;
+	}
+
+	/* do DAC check on address space usage */
+	rc = cap_file_mmap(file, reqprot, prot, flags, addr, addr_only);
 	if (rc || addr_only)
 		return rc;
 
