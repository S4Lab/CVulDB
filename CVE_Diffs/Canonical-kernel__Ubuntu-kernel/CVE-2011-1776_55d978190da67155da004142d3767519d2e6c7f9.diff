Canonical-kernel__Ubuntu-kernel
commit 55d978190da67155da004142d3767519d2e6c7f9
Author:     Timo Warns <Warns@pre-sense.de>
AuthorDate: Wed Sep 14 12:48:19 2011 +0100
Commit:     Herton Ronaldo Krzesinski <herton.krzesinski@canonical.com>
CommitDate: Mon Sep 19 12:20:12 2011 -0300

    Validate size of EFI GUID partition entries, CVE-2011-1776
    
    Otherwise corrupted EFI partition tables can cause total confusion.
    
    Signed-off-by: Timo Warns <warns@pre-sense.de>
    Cc: stable@kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    
    (backported from commit fa039d5f6b126fbd65eefa05db2f67e44df8f121)
    CVE-2011-1776
    BugLink: http://bugs.launchpad.net/bugs/844365
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/fs/partitions/efi.c b/fs/partitions/efi.c
index 46e9f4727550..9e86a3461b8d 100644
--- a/fs/partitions/efi.c
+++ b/fs/partitions/efi.c
@@ -360,6 +360,12 @@ is_gpt_valid(struct block_device *bdev, u64 lba,
 		goto fail;
 	}
 
+	/* Check that sizeof_partition_entry has the correct value */
+	if (le32_to_cpu((*gpt)->sizeof_partition_entry) != sizeof(gpt_entry)) {
+		pr_debug("GUID Partitition Entry Size check failed.\n");
+		goto fail;
+	}
+
 	if (!(*ptes = alloc_read_gpt_entries(bdev, *gpt)))
 		goto fail;
 
