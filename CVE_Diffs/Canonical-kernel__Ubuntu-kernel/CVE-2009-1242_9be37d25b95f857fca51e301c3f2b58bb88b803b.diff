Canonical-kernel__Ubuntu-kernel
commit 9be37d25b95f857fca51e301c3f2b58bb88b803b
Author:     Avi Kivity <avi@redhat.com>
AuthorDate: Mon Mar 23 22:13:44 2009 +0200
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Mon Jun 15 17:01:08 2009 +0200

    KVM: VMX: Don't allow uninhibited access to EFER on i386
    
    CVE-2009-1242
    
    commit 16175a796d061833aacfbd9672235f2d2725df65 upstream
    
    vmx_set_msr() does not allow i386 guests to touch EFER, but they can still
    do so through the default: label in the switch.  If they set EFER_LME, they
    can oops the host.
    
    Fix by having EFER access through the normal channel (which will check for
    EFER_LME) even on i386.
    
    Reported-and-tested-by: Benjamin Gilbert <bgilbert@cs.cmu.edu>
    Cc: stable@kernel.org
    Signed-off-by: Avi Kivity <avi@redhat.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index 92abdf04d519..661b2284f7ae 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -794,7 +794,6 @@ static int vmx_set_msr(struct kvm_vcpu *vcpu, u32 msr_index, u64 data)
 	int ret = 0;
 
 	switch (msr_index) {
-#ifdef CONFIG_X86_64
 	case MSR_EFER:
 		ret = kvm_set_msr_common(vcpu, msr_index, data);
 		if (vmx->host_state.loaded) {
@@ -802,6 +801,7 @@ static int vmx_set_msr(struct kvm_vcpu *vcpu, u32 msr_index, u64 data)
 			load_transition_efer(vmx);
 		}
 		break;
+#ifdef CONFIG_X86_64
 	case MSR_FS_BASE:
 		vmcs_writel(GUEST_FS_BASE, data);
 		break;
