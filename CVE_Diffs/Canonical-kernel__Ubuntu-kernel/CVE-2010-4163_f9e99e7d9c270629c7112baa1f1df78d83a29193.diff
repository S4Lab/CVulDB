Canonical-kernel__Ubuntu-kernel
commit f9e99e7d9c270629c7112baa1f1df78d83a29193
Author:     Tim Gardner <tim.gardner@canonical.com>
AuthorDate: Fri Feb 18 14:15:10 2011 -0700
Commit:     Steve Conklin <sconklin@canonical.com>
CommitDate: Fri Feb 25 11:19:13 2011 -0600

    block: check for proper length of iov entries earlier in blk_rq_map_user_iov(), CVE-2010-4163
    
    BugLink: http://bugs.launchpad.net/bugs/721504
    
    CVE-2010-4163
    
    commit 9284bcf checks for proper length of iov entries in
    blk_rq_map_user_iov(). But if the map is unaligned, kernel
    will break out the loop without checking for the proper length.
    So we need to check the proper length before the unalign check.
    
    Signed-off-by: Xiaotian Feng <dfeng@redhat.com>
    Cc: stable@kernel.org
    Signed-off-by: Jens Axboe <jaxboe@fusionio.com>
    (backported from commit 5478755616ae2ef1ce144dded589b62b2a50d575)
    
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Acked-by: Brad Figg <brad.figg@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/fs/bio.c b/fs/bio.c
index 2c8224c053eb..e382a1d3ef97 100644
--- a/fs/bio.c
+++ b/fs/bio.c
@@ -615,6 +615,9 @@ static struct bio *__bio_map_user_iov(struct request_queue *q,
 		if (end < start)
 			return ERR_PTR(-EINVAL);
 
+		if (!len)
+			return ERR_PTR(-EINVAL);
+
 		nr_pages += end - start;
 		/*
 		 * buffer must be aligned to at least hardsector size for now
