Canonical-kernel__Ubuntu-kernel
commit 2b6129e7d40ad626b9e90b2ddd001e8f775d21ac
Author:     Oleg Nesterov <oleg@redhat.com>
AuthorDate: Fri Apr 2 18:05:12 2010 +0200
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Tue May 25 14:08:56 2010 +0200

    tty: release_one_tty() forgets to put pids
    
    CVE-2010-1162
    
    release_one_tty(tty) can be called when tty still has a reference
    to pgrp/session. In this case we leak the pid.
    
    Signed-off-by: Oleg Nesterov <oleg@redhat.com>
    Reported-by: Catalin Marinas <catalin.marinas@arm.com>
    Reported-and-tested-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
    Acked-by: Linus Torvalds <torvalds@linux-foundation.org>
    Acked-by: Eric W. Biederman <ebiederm@xmission.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry picked from commit 6da8d866d0d39e9509ff826660f6a86a6757c966 upstream)
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/drivers/char/tty_io.c b/drivers/char/tty_io.c
index f36fecd3fd26..23d7cfdec7cd 100644
--- a/drivers/char/tty_io.c
+++ b/drivers/char/tty_io.c
@@ -2271,6 +2271,8 @@ static void release_one_tty(struct tty_struct *tty, int idx)
 	list_del_init(&tty->tty_files);
 	file_list_unlock();
 
+	put_pid(tty->pgrp);
+	put_pid(tty->session);
 	free_tty_struct(tty);
 }
 
