Canonical-kernel__Ubuntu-kernel
commit 2690f4dc54f84ba961c719db32c666e1357fb578
Author:     Theodore Ts'o <tytso@mit.edu>
AuthorDate: Fri Jan 16 11:13:40 2009 -0500
Commit:     Stefan Bader <stefan.bader@canonical.com>
CommitDate: Wed Mar 18 16:14:05 2009 +0100

    ext4: Add sanity check to make_indexed_dir
    
    CVE-2009-0746
    
    commit e6b8bc09ba2075cd91fbffefcd2778b1a00bd76f upstream
    
    Make sure the rec_len field in the '..' entry is sane, lest we overrun
    the directory block and cause a kernel oops on a purposefully
    corrupted filesystem.
    
    Thanks to Sami Liedes for reporting this bug.
    
    http://bugzilla.kernel.org/show_bug.cgi?id=12430
    
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Cc: stable@kernel.org
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>

diff --git a/fs/ext4/namei.c b/fs/ext4/namei.c
index 94ee6f315dc1..87194f45040a 100644
--- a/fs/ext4/namei.c
+++ b/fs/ext4/namei.c
@@ -1378,7 +1378,7 @@ static int make_indexed_dir(handle_t *handle, struct dentry *dentry,
 	struct fake_dirent *fde;
 
 	blocksize =  dir->i_sb->s_blocksize;
-	dxtrace(printk("Creating index\n"));
+	dxtrace(printk(KERN_DEBUG "Creating index: inode %lu\n", dir->i_ino));
 	retval = ext4_journal_get_write_access(handle, bh);
 	if (retval) {
 		ext4_std_error(dir->i_sb, retval);
@@ -1387,6 +1387,20 @@ static int make_indexed_dir(handle_t *handle, struct dentry *dentry,
 	}
 	root = (struct dx_root *) bh->b_data;
 
+	/* The 0th block becomes the root, move the dirents out */
+	fde = &root->dotdot;
+	de = (struct ext4_dir_entry_2 *)((char *)fde +
+		ext4_rec_len_from_disk(fde->rec_len));
+	if ((char *) de >= (((char *) root) + blocksize)) {
+		ext4_error(dir->i_sb, __func__,
+			   "invalid rec_len for '..' in inode %lu",
+			   dir->i_ino);
+		brelse(bh);
+		return -EIO;
+	}
+	len = ((char *) root) + blocksize - (char *) de;
+
+	/* Allocate new block for the 0th block's dirents */
 	bh2 = ext4_append (handle, dir, &block, &retval);
 	if (!(bh2)) {
 		brelse(bh);
@@ -1395,10 +1409,6 @@ static int make_indexed_dir(handle_t *handle, struct dentry *dentry,
 	EXT4_I(dir)->i_flags |= EXT4_INDEX_FL;
 	data1 = bh2->b_data;
 
-	/* The 0th block becomes the root, move the dirents out */
-	fde = &root->dotdot;
-	de = (struct ext4_dir_entry_2 *)((char *)fde + le16_to_cpu(fde->rec_len));
-	len = ((char *) root) + blocksize - (char *) de;
 	memcpy (data1, de, len);
 	de = (struct ext4_dir_entry_2 *) data1;
 	top = data1 + len;
