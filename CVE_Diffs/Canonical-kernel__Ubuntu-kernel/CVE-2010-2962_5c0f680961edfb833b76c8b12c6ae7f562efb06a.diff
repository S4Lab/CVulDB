Canonical-kernel__Ubuntu-kernel
commit 5c0f680961edfb833b76c8b12c6ae7f562efb06a
Author:     Chris Wilson <chris@chris-wilson.co.uk>
AuthorDate: Sun Sep 26 21:19:37 2010 +0100
Commit:     Leann Ogasawara <leann.ogasawara@canonical.com>
CommitDate: Fri Oct 1 11:45:01 2010 -0700

    drm/i915: Skip pread/pwrite if size to copy is 0.
    
    CVE-2010-2962
    
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    (cherry-picked from email)
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index d76f5d82739a..0989c334ed39 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -465,6 +465,11 @@ i915_gem_pread_ioctl(struct drm_device *dev, void *data,
 		return -EINVAL;
 	}
 
+	if (args->size == 0) {
+		drm_gem_object_unreference_unlocked(obj);
+		return 0;
+	}
+
 	if (i915_gem_object_needs_bit17_swizzle(obj)) {
 		ret = i915_gem_shmem_pread_slow(dev, obj, args, file_priv);
 	} else {
@@ -475,7 +480,6 @@ i915_gem_pread_ioctl(struct drm_device *dev, void *data,
 	}
 
 	drm_gem_object_unreference_unlocked(obj);
-
 	return ret;
 }
 
@@ -911,7 +915,7 @@ i915_gem_pwrite_ioctl(struct drm_device *dev, void *data,
 	struct drm_i915_gem_pwrite *args = data;
 	struct drm_gem_object *obj;
 	struct drm_i915_gem_object *obj_priv;
-	int ret = 0;
+	int ret;
 
 	obj = drm_gem_object_lookup(dev, file_priv, args->handle);
 	if (obj == NULL)
@@ -924,6 +928,11 @@ i915_gem_pwrite_ioctl(struct drm_device *dev, void *data,
 		return -EINVAL;
 	}
 
+	if (args->size == 0) {
+		drm_gem_object_unreference_unlocked(obj);
+		return 0;
+	}
+
 	/* We can only do the GTT pwrite on untiled buffers, as otherwise
 	 * it would end up going through the fenced access, and we'll get
 	 * different detiling behavior between reading and writing.
@@ -956,7 +965,6 @@ i915_gem_pwrite_ioctl(struct drm_device *dev, void *data,
 #endif
 
 	drm_gem_object_unreference_unlocked(obj);
-
 	return ret;
 }
 
