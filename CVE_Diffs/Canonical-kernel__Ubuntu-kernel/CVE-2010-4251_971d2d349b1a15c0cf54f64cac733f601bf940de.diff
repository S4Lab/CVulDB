Canonical-kernel__Ubuntu-kernel
commit 971d2d349b1a15c0cf54f64cac733f601bf940de
Author:     Zhu Yi <yi.zhu@intel.com>
AuthorDate: Fri Jul 22 18:42:38 2011 +0100
Commit:     Andy Whitcroft <apw@canonical.com>
CommitDate: Mon Aug 8 12:40:51 2011 +0100

    tipc: use limited socket backlog CVE-2010-4251
    
    BugLink: http://bugs.launchpad.net/bugs/807462
    
    Make tipc adapt to the limited socket backlog change.
    
    Cc: Jon Maloy <jon.maloy@ericsson.com>
    Cc: Allan Stephens <allan.stephens@windriver.com>
    Signed-off-by: Zhu Yi <yi.zhu@intel.com>
    Acked-by: Eric Dumazet <eric.dumazet@gmail.com>
    Acked-by: Allan Stephens <allan.stephens@windriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit 53eecb1be5ae499d399d2923933937a9ea1a284f)
    
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/net/tipc/socket.c b/net/tipc/socket.c
index 71036fb977f3..93c97a0edf85 100644
--- a/net/tipc/socket.c
+++ b/net/tipc/socket.c
@@ -1323,8 +1323,10 @@ static u32 dispatch(struct tipc_port *tport, struct sk_buff *buf)
 	if (!sock_owned_by_user(sk)) {
 		res = filter_rcv(sk, buf);
 	} else {
-		sk_add_backlog(sk, buf);
-		res = TIPC_OK;
+		if (sk_add_backlog_limited(sk, buf))
+			res = TIPC_ERR_OVERLOAD;
+		else
+			res = TIPC_OK;
 	}
 	bh_unlock_sock(sk);
 
