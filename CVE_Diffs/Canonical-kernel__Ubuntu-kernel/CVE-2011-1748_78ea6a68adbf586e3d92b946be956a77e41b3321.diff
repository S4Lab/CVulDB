Canonical-kernel__Ubuntu-kernel
commit 78ea6a68adbf586e3d92b946be956a77e41b3321
Author:     Oliver Hartkopp <socketcan@hartkopp.net>
AuthorDate: Thu May 26 17:07:35 2011 +0100
Commit:     Andy Whitcroft <apw@canonical.com>
CommitDate: Thu Jun 2 14:27:15 2011 +0100

    can: add missing socket check in can/raw release, CVE-2011-1748
    
    v2: added space after 'if' according code style.
    
    We can get here with a NULL socket argument passed from userspace,
    so we need to handle it accordingly.
    
    Thanks to Dave Jones pointing at this issue in net/can/bcm.c
    
    Signed-off-by: Oliver Hartkopp <socketcan@hartkopp.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    
    CVE-2011-1748
    BugLink: http://bugs.launchpad.net/bugs/788694
    (cherry picked from commit 10022a6c66e199d8f61d9044543f38785713cbbd)
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Leann Ogasawara <leann.ogasawara@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    
    Signed-off-by: Paolo Pisati <paolo.pisati@canonical.com>

diff --git a/net/can/raw.c b/net/can/raw.c
index da99cf153b33..9dd45ea45ccb 100644
--- a/net/can/raw.c
+++ b/net/can/raw.c
@@ -281,7 +281,12 @@ static int raw_init(struct sock *sk)
 static int raw_release(struct socket *sock)
 {
 	struct sock *sk = sock->sk;
-	struct raw_sock *ro = raw_sk(sk);
+	struct raw_sock *ro;
+
+	if (!sk)
+		return 0;
+
+	ro = raw_sk(sk);
 
 	unregister_netdevice_notifier(&ro->notifier);
 
