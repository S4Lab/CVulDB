Canonical-kernel__Ubuntu-kernel
commit d98515d366f0ca5bd478843bc6fd9e640e1c58b5
Author:     Chris Wilson <chris@chris-wilson.co.uk>
AuthorDate: Sun Sep 26 21:19:38 2010 +0100
Commit:     Leann Ogasawara <leann.ogasawara@canonical.com>
CommitDate: Mon Oct 4 13:50:45 2010 -0700

    drm/i915: Sanity check pread/pwrite
    
    CVE-2010-2962
    
    Move the access control up from the fast paths which are no longer
    universally taken first up into the caller. This then duplicates some
    sanity checking along the slow paths, but is much simpler.
    
    Reported-by: Kees Cook <kees@ubuntu.com>
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    (cherry-picked from email)
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Leann Ogasawara <leann.ogasawara@canonical.com>

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index 0989c334ed39..8cbcf998c5e0 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -465,6 +465,13 @@ i915_gem_pread_ioctl(struct drm_device *dev, void *data,
 		return -EINVAL;
 	}
 
+	if (!access_ok(VERIFY_WRITE,
+		       (char __user *)(uintptr_t)args->data_ptr,
+		       args->size)) {
+		drm_gem_object_unreference_unlocked(obj);
+		return -EFAULT;
+	}
+
 	if (args->size == 0) {
 		drm_gem_object_unreference_unlocked(obj);
 		return 0;
@@ -568,8 +575,6 @@ i915_gem_gtt_pwrite_fast(struct drm_device *dev, struct drm_gem_object *obj,
 
 	user_data = (char __user *) (uintptr_t) args->data_ptr;
 	remain = args->size;
-	if (!access_ok(VERIFY_READ, user_data, remain))
-		return -EFAULT;
 
 
 	mutex_lock(&dev->struct_mutex);
@@ -933,6 +938,13 @@ i915_gem_pwrite_ioctl(struct drm_device *dev, void *data,
 		return 0;
 	}
 
+	if (!access_ok(VERIFY_READ,
+		       (char __user *)(uintptr_t)args->data_ptr,
+		       args->size)) {
+		drm_gem_object_unreference_unlocked(obj);
+		return -EFAULT;
+	}
+
 	/* We can only do the GTT pwrite on untiled buffers, as otherwise
 	 * it would end up going through the fenced access, and we'll get
 	 * different detiling behavior between reading and writing.
