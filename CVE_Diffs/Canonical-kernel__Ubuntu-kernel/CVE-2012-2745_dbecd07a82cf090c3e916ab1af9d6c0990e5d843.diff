Canonical-kernel__Ubuntu-kernel
commit dbecd07a82cf090c3e916ab1af9d6c0990e5d843
Author:     Oleg Nesterov <oleg@redhat.com>
AuthorDate: Mon Apr 9 21:03:50 2012 +0200
Commit:     Luis Henriques <luis.henriques@canonical.com>
CommitDate: Thu Sep 6 09:29:58 2012 +0100

    cred: copy_process() should clear child->replacement_session_keyring
    
    CVE-2012-2745
    
    BugLink: http://bugs.launchpad.net/bugs/1023535
    
    keyctl_session_to_parent(task) sets ->replacement_session_keyring,
    it should be processed and cleared by key_replace_session_keyring().
    
    However, this task can fork before it notices TIF_NOTIFY_RESUME and
    the new child gets the bogus ->replacement_session_keyring copied by
    dup_task_struct(). This is obviously wrong and, if nothing else, this
    leads to put_cred(already_freed_cred).
    
    change copy_creds() to clear this member. If copy_process() fails
    before this point the wrong ->replacement_session_keyring doesn't
    matter, exit_creds() won't be called.
    
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Oleg Nesterov <oleg@redhat.com>
    Acked-by: David Howells <dhowells@redhat.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    (cherry picked from commit 79549c6dfda0603dba9a70a53467ce62d9335c33)
    
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>
    Acked-by: Brad Figg <brad.figg@canonical.com>

diff --git a/kernel/cred.c b/kernel/cred.c
index 3a9d6dd53a6c..183543fa9f50 100644
--- a/kernel/cred.c
+++ b/kernel/cred.c
@@ -384,6 +384,8 @@ int copy_creds(struct task_struct *p, unsigned long clone_flags)
 	struct cred *new;
 	int ret;
 
+	p->replacement_session_keyring = NULL;
+
 	if (
 #ifdef CONFIG_KEYS
 		!p->cred->thread_keyring &&
