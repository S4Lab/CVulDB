Canonical-kernel__Ubuntu-kernel
commit 26d256d536f1852d0f1221fb6e1abbb4cac2d75b
Author:     Sabrina Dubroca <sd@queasysnail.net>
AuthorDate: Tue Apr 29 14:31:34 2014 +0100
Commit:     Kamal Mostafa <kamal@canonical.com>
CommitDate: Wed May 7 11:19:54 2014 -0700

    ipv6: don't set DST_NOCOUNT for remotely added routes
    
    DST_NOCOUNT should only be used if an authorized user adds routes
    locally. In case of routes which are added on behalf of router
    advertisments this flag must not get used as it allows an unlimited
    number of routes getting added remotely.
    
    Signed-off-by: Sabrina Dubroca <sd@queasysnail.net>
    Acked-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (back ported from commit c88507fbad8055297c1d1e21e599f46960cbee39)
    CVE-2014-2309
    BugLink: http://bugs.launchpad.net/bugs/1293726
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/net/ipv6/route.c b/net/ipv6/route.c
index 5b8eac8a7f45..1f26038b9ac6 100644
--- a/net/ipv6/route.c
+++ b/net/ipv6/route.c
@@ -1302,7 +1302,7 @@ int ip6_route_add(struct fib6_config *cfg)
 	if (!table)
 		goto out;
 
-	rt = ip6_dst_alloc(&net->ipv6.ip6_dst_ops, NULL, DST_NOCOUNT);
+	rt = ip6_dst_alloc(&net->ipv6.ip6_dst_ops, NULL, (cfg->fc_flags & RTF_ADDRCONF) ? 0 : DST_NOCOUNT);
 
 	if (!rt) {
 		err = -ENOMEM;
