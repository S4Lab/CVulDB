Canonical-kernel__Ubuntu-kernel
commit a4513ae831bc458b920f9665d5337d973f2968e4
Author:     Ian Campbell <ian.campbell@citrix.com>
AuthorDate: Fri Feb 8 15:19:01 2013 +0000
Commit:     Brad Figg <brad.figg@canonical.com>
CommitDate: Tue Feb 26 09:58:40 2013 -0800

    UBUNTU: SAUCE: xen/netback: free already allocated memory on failure in xen_netbk_get_requests
    
    BugLink: http://bugs.launchpad.net/bugs/1117331
    
    Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
    
    CVE-2013-0217
    
    Signed-off-by: Stefan Bader <stefan.bader@canonical.com>
    Acked-by: Luis Henriques <luis.henriques@canonical.com>
    Signed-off-by: Tim Gardner <tim.gardner@canonical.com>

diff --git a/drivers/net/xen-netback/netback.c b/drivers/net/xen-netback/netback.c
index 3775fe2b9d94..e4e5724322c5 100644
--- a/drivers/net/xen-netback/netback.c
+++ b/drivers/net/xen-netback/netback.c
@@ -949,7 +949,7 @@ static struct gnttab_copy *xen_netbk_get_requests(struct xen_netbk *netbk,
 		pending_idx = netbk->pending_ring[index];
 		page = xen_netbk_alloc_page(netbk, skb, pending_idx);
 		if (!page)
-			return NULL;
+			goto err;
 
 		gop->source.u.ref = txp->gref;
 		gop->source.domid = vif->domid;
@@ -971,6 +971,20 @@ static struct gnttab_copy *xen_netbk_get_requests(struct xen_netbk *netbk,
 	}
 
 	return gop;
+err:
+	/*
+	 * Unwind, freeing all pages and sending error
+	 * reponses.
+	 */
+	while (i-- > start) {
+		xen_netbk_idx_release(netbk, frag_get_pending_idx(&frags[i]),
+				      XEN_NETIF_RSP_ERROR);
+	}
+	/* The head too, if necessary. */
+	if (start)
+		xen_netbk_idx_release(netbk, pending_idx, XEN_NETIF_RSP_ERROR);
+
+	return NULL;
 }
 
 static int xen_netbk_tx_check_gop(struct xen_netbk *netbk,
