franciscofranco__hammerhead
commit 1959830ad03966f0b0f5f9915a445ce61658c732
Author:     Arun Kumar Neelakantam <aneela@codeaurora.org>
AuthorDate: Wed Sep 21 18:34:01 2016 +0530
Commit:     Francisco Franco <franciscofranco.1990@gmail.com>
CommitDate: Sat Dec 9 04:47:07 2017 +0000

    net: ipc_router: fix NULL pointer de-reference issue
    
    Fail cases of accept() system call on AF_MSM_IPC socket family causes
    NULL pointer de-reference of sock structure variable in release operation.
    
    Validate the sock structure pointer before using it in release operation.
    
    CRs-Fixed: 1068888
    Change-Id: I5637e52be59ea9504ea6ae317394bef0c28c7865
    Signed-off-by: Arun Kumar Neelakantam <aneela@codeaurora.org>
    mh0rst: Backport
    Fixes: CVE-2016-5870
    Signed-off-by: Joel Stanley <joel@jms.id.au>
    Signed-off-by: Francisco Franco <franciscofranco.1990@gmail.com>

diff --git a/arch/arm/mach-msm/ipc_socket.c b/arch/arm/mach-msm/ipc_socket.c
index d199c6a40fb..c8ef1044bb2 100644
--- a/arch/arm/mach-msm/ipc_socket.c
+++ b/arch/arm/mach-msm/ipc_socket.c
@@ -591,11 +591,19 @@ static unsigned int msm_ipc_router_poll(struct file *file,
 static int msm_ipc_router_close(struct socket *sock)
 {
 	struct sock *sk = sock->sk;
-	struct msm_ipc_port *port_ptr = msm_ipc_sk_port(sk);
+	struct msm_ipc_port *port_ptr;
 	void *pil = msm_ipc_sk(sk)->default_pil;
 	int ret;
 
+	if (!sk)
+		return -EINVAL;
+
 	lock_sock(sk);
+	port_ptr = msm_ipc_sk_port(sk);
+	if (!port_ptr) {
+		release_sock(sk);
+		return -EINVAL;
+	}
 	ret = msm_ipc_router_close_port(port_ptr);
 	if (pil)
 		msm_ipc_unload_default_node(pil);
