franciscofranco__hammerhead
commit 241adcf5e42090ae43e3062511076faa88fb14f4
Author:     Neeraj Soni <neersoni@codeaurora.org>
AuthorDate: Mon Nov 28 18:23:33 2016 +0530
Commit:     Francisco Franco <franciscofranco.1990@gmail.com>
CommitDate: Wed Jul 5 17:19:23 2017 +0000

    qcrypto: protect potential integer overflow.
    
    Adding user passed parameters without check might
    lead to Integer overflow and unpredictable system
    behaviour.
    
    CAF-Change-Id: Iaf8259e3c4a157e1790f1447b1b62a646988b7c4
    Signed-off-by: Neeraj Soni <neersoni@codeaurora.org>
    
    CVE-2016-10230
    
    Change-Id: I07a2c7d571b0eaa7abe085eeb0887c2d10ef3a40
    (cherry picked from commit bd9a8fc6d7f6bd1a0b936994630006de450df657)
    Signed-off-by: Francisco Franco <franciscofranco.1990@gmail.com>

diff --git a/drivers/crypto/msm/qce50.c b/drivers/crypto/msm/qce50.c
index 87050f48a5c..46f1b7e1e57 100644
--- a/drivers/crypto/msm/qce50.c
+++ b/drivers/crypto/msm/qce50.c
@@ -2944,7 +2944,6 @@ int qce_aead_req(void *handle, struct qce_req *q_req)
 	ce_burst_size = pce_dev->ce_sps.ce_burst_size;
 	if (q_req->dir == QCE_ENCRYPT) {
 		q_req->cryptlen = areq->cryptlen;
-			totallen_in = q_req->cryptlen + areq->assoclen + ivsize;
 		if (q_req->mode == QCE_MODE_CCM) {
 			out_len = areq->cryptlen + authsize;
 			hw_pad_out = ALIGN(authsize, ce_burst_size) - authsize;
@@ -2953,14 +2952,18 @@ int qce_aead_req(void *handle, struct qce_req *q_req)
 		}
 	} else {
 		q_req->cryptlen = areq->cryptlen - authsize;
-		if (q_req->mode == QCE_MODE_CCM)
-			totallen_in = areq->cryptlen + areq->assoclen;
-		else
-			totallen_in = q_req->cryptlen + areq->assoclen + ivsize;
 		out_len = q_req->cryptlen;
 		hw_pad_out = authsize;
 	}
 
+	if ((q_req->cryptlen > UINT_MAX - areq->assoclen) ||
+		(q_req->cryptlen + areq->assoclen > UINT_MAX - ivsize)) {
+			pr_err("Integer overflow on total aead req length.\n");
+			return -EINVAL;
+	}
+
+	totallen_in = q_req->cryptlen + areq->assoclen + ivsize;
+
 	pce_dev->assoc_nents = count_sg(areq->assoc, areq->assoclen);
 	pce_dev->src_nents = count_sg(areq->src, areq->cryptlen);
 	pce_dev->ivsize = q_req->ivsize;
