franciscofranco__hammerhead
commit c0f5e7464440253885d63f51b0ec1bc287116985
Author:     Dilip Kota <dkota@codeaurora.org>
AuthorDate: Mon Mar 21 11:28:51 2016 +0530
Commit:     Francisco Franco <franciscofranco.1990@gmail.com>
CommitDate: Tue Sep 5 04:30:55 2017 +0000

    slim-msm: Synchronize SSR callbacks
    
    Subsystem will restart within short timeframe.
    Synchronise subsytem up/down callback notifications
    to avoid functionality failures.
    Use mutex locks to achieve synchronization.
    
    Change-Id: I5881c7d468507bb8402a2e9f8178b9c31e57e8a5
    Signed-off-by: Dilip Kota <dkota@codeaurora.org>
    Fixes: CVE-2016-10291
    Signed-off-by: Joel Stanley <joel@jms.id.au>
    Signed-off-by: Francisco Franco <franciscofranco.1990@gmail.com>

diff --git a/drivers/slimbus/slim-msm-ngd.c b/drivers/slimbus/slim-msm-ngd.c
index 7fbe4a9b5ce..fd4fba084a9 100644
--- a/drivers/slimbus/slim-msm-ngd.c
+++ b/drivers/slimbus/slim-msm-ngd.c
@@ -1183,6 +1183,7 @@ static void ngd_adsp_down(struct work_struct *work)
 	struct slim_controller *ctrl = &dev->ctrl;
 	struct slim_device *sbdev;
 
+	mutex_lock(&dev->ssr_lock);
 	ngd_slim_enable(dev, false);
 	/* disconnect BAM pipes */
 	if (dev->use_rx_msgqs == MSM_MSGQ_ENABLED)
@@ -1194,6 +1195,7 @@ static void ngd_adsp_down(struct work_struct *work)
 	list_for_each_entry(sbdev, &ctrl->devs, dev_list)
 		slim_report_absent(sbdev);
 	pr_info("SLIM ADSP SSR (DOWN) done");
+	mutex_unlock(&dev->ssr_lock);
 }
 
 static void ngd_adsp_up(struct work_struct *work)
@@ -1202,7 +1204,9 @@ static void ngd_adsp_up(struct work_struct *work)
 		container_of(work, struct msm_slim_qmi, ssr_up);
 	struct msm_slim_ctrl *dev =
 		container_of(qmi, struct msm_slim_ctrl, qmi);
+	mutex_lock(&dev->ssr_lock);
 	ngd_slim_enable(dev, true);
+	mutex_unlock(&dev->ssr_lock);
 }
 
 static int __devinit ngd_slim_probe(struct platform_device *pdev)
@@ -1309,6 +1313,7 @@ static int __devinit ngd_slim_probe(struct platform_device *pdev)
 	init_completion(&dev->reconf);
 	init_completion(&dev->ctrl_up);
 	mutex_init(&dev->tx_lock);
+	mutex_init(&dev->ssr_lock);
 	spin_lock_init(&dev->rx_lock);
 	dev->ee = 1;
 	dev->irq = irq->start;
diff --git a/drivers/slimbus/slim-msm.h b/drivers/slimbus/slim-msm.h
index fa47af3fd3d..f188db53790 100644
--- a/drivers/slimbus/slim-msm.h
+++ b/drivers/slimbus/slim-msm.h
@@ -252,6 +252,7 @@ struct msm_slim_ctrl {
 	struct clk		*rclk;
 	struct clk		*hclk;
 	struct mutex		tx_lock;
+	struct mutex		ssr_lock;
 	u8			pgdla;
 	enum msm_slim_msgq	use_rx_msgqs;
 	enum msm_slim_msgq	use_tx_msgqs;
