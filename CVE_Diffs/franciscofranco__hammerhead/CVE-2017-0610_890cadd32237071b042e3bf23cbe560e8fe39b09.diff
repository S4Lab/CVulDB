franciscofranco__hammerhead
commit 890cadd32237071b042e3bf23cbe560e8fe39b09
Author:     Siena Richard <sienar@codeaurora.org>
AuthorDate: Mon Dec 5 12:26:52 2016 -0800
Commit:     Francisco Franco <franciscofranco.1990@gmail.com>
CommitDate: Tue Nov 7 05:49:19 2017 +0000

    ASoC: msm: qdsp6v2: return error when copy from userspace fails
    
    A copy_from_user is not always expected to succeed. Therefore, check
    for an error before operating on the buffer post copy.
    
    CAF-Change-Id: Ibba9a47c84e735d30e32eeac5b80d51044b7a9e8
    CRs-Fixed: 1094852
    Signed-off-by: Siena Richard <sienar@codeaurora.org>
    
    CVE-2017-0610
    
    Change-Id: I238dd28d531778104660ff5ac9b8a9733c2fac6a
    (cherry picked from commit 65009746a6e649779f73d665934561ea983892fe)
    Signed-off-by: Francisco Franco <franciscofranco.1990@gmail.com>

diff --git a/sound/soc/msm/msm-pcm-voip.c b/sound/soc/msm/msm-pcm-voip.c
index 22bc9e13adc..8ac657940b8 100644
--- a/sound/soc/msm/msm-pcm-voip.c
+++ b/sound/soc/msm/msm-pcm-voip.c
@@ -693,6 +693,11 @@ static int msm_pcm_playback_copy(struct snd_pcm_substream *substream, int a,
 			} else
 				ret = copy_from_user(&buf_node->frame,
 							buf, count);
+			if (ret) {
+				pr_err("%s: copy from user failed %d\n",
+				       __func__, ret);
+				return -EFAULT;
+			}
 			spin_lock_irqsave(&prtd->dsp_lock, dsp_flags);
 			list_add_tail(&buf_node->list, &prtd->in_queue);
 			spin_unlock_irqrestore(&prtd->dsp_lock, dsp_flags);
diff --git a/sound/soc/msm/qdsp6v2/msm-pcm-voip-v2.c b/sound/soc/msm/qdsp6v2/msm-pcm-voip-v2.c
index 4a829fd20e9..6f3ba620e21 100644
--- a/sound/soc/msm/qdsp6v2/msm-pcm-voip-v2.c
+++ b/sound/soc/msm/qdsp6v2/msm-pcm-voip-v2.c
@@ -563,6 +563,11 @@ static int msm_pcm_playback_copy(struct snd_pcm_substream *substream, int a,
 			} else
 				ret = copy_from_user(&buf_node->frame,
 							buf, count);
+			if (ret) {
+				pr_err("%s: copy from user failed %d\n",
+				       __func__, ret);
+				return -EFAULT;
+			}
 			spin_lock_irqsave(&prtd->dsp_lock, dsp_flags);
 			list_add_tail(&buf_node->list, &prtd->in_queue);
 			spin_unlock_irqrestore(&prtd->dsp_lock, dsp_flags);
