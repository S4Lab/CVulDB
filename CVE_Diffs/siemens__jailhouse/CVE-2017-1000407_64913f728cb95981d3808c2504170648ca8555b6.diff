siemens__jailhouse
commit 64913f728cb95981d3808c2504170648ca8555b6
Author:     Jan Kiszka <jan.kiszka@siemens.com>
AuthorDate: Sat Dec 2 08:20:02 2017 +0100
Commit:     Jan Kiszka <jan.kiszka@siemens.com>
CommitDate: Sat Dec 2 08:36:03 2017 +0100

    x86, configs: Deny direct access to port 80
    
    Apparently, there are systems that can crash or otherwise get badly
    influenced by writing port 80 (see Linux commit 99f85a28a78e and
    CVE-2017-1000407). Intercept those accesses and simply ignore them to be
    safe. All affected configs and the generator template are updated as
    well.
    
    Signed-off-by: Jan Kiszka <jan.kiszka@siemens.com>

diff --git a/configs/f2a88xm-hd3.c b/configs/f2a88xm-hd3.c
index c78f428e..f35f34d7 100644
--- a/configs/f2a88xm-hd3.c
+++ b/configs/f2a88xm-hd3.c
@@ -363,9 +363,7 @@ struct {
 		[  0x60/8 ...   0x67/8] = 0xec, /* HACK: NMI status/control */
 		[  0x68/8 ...   0x6f/8] = -1,
 		[  0x70/8 ...   0x77/8] = 0xfc, /* RTC */
-		[  0x78/8 ...   0x7f/8] = -1,
-		[  0x80/8 ...   0x87/8] = 0xfe, /* Port 80 (delays) */
-		[  0x88/8 ...  0x3af/8] = -1,
+		[  0x78/8 ...  0x3af/8] = -1,
 		[ 0x3b0/8 ...  0x3df/8] = 0x00, /* VGA */
 		[ 0x3e0/8 ...  0xcf7/8] = 0, /* HACK: PCI bus */
 		[ 0xcf8/8 ...  0xcff/8] = -1,
diff --git a/configs/imb-a180.c b/configs/imb-a180.c
index 795cff17..07ea208c 100644
--- a/configs/imb-a180.c
+++ b/configs/imb-a180.c
@@ -393,9 +393,7 @@ struct {
 		[  0x60/8 ...   0x67/8] = 0xec, /* HACK: NMI status/control */
 		[  0x68/8 ...   0x6f/8] = -1,
 		[  0x70/8 ...   0x77/8] = 0xfc, /* RTC */
-		[  0x78/8 ...   0x7f/8] = -1,
-		[  0x80/8 ...   0x87/8] = 0xfe, /* Port 80 (delays) */
-		[  0x88/8 ...  0x3af/8] = -1,
+		[  0x78/8 ...  0x3af/8] = -1,
 		[ 0x3b0/8 ...  0x3df/8] = 0x00, /* VGA */
 		[ 0x3e0/8 ...  0xcf7/8] = 0, /* HACK: PCI bus */
 		[ 0xcf8/8 ...  0xcff/8] = -1,
diff --git a/configs/qemu-x86.c b/configs/qemu-x86.c
index e5a420aa..c2345ba9 100644
--- a/configs/qemu-x86.c
+++ b/configs/qemu-x86.c
@@ -206,9 +206,7 @@ struct {
 		[  0x60/8 ...   0x67/8] = 0xec, /* HACK: NMI status/control */
 		[  0x68/8 ...   0x6f/8] = -1,
 		[  0x70/8 ...   0x77/8] = 0xfc, /* rtc */
-		[  0x78/8 ...   0x7f/8] = -1,
-		[  0x80/8 ...   0x87/8] = 0xfe, /* port 80 (delays) */
-		[  0x88/8 ...  0x1c7/8] = -1,
+		[  0x78/8 ...  0x1c7/8] = -1,
 		[ 0x1c8/8 ...  0x1cf/8] = 0x3f, /* vbe */
 		[ 0x1d0/8 ...  0x1d7/8] = 0xfe, /* vbe */
 		[ 0x1d8/8 ...  0x2f7/8] = -1,
diff --git a/hypervisor/arch/x86/vcpu.c b/hypervisor/arch/x86/vcpu.c
index 43b08067..246ef31b 100644
--- a/hypervisor/arch/x86/vcpu.c
+++ b/hypervisor/arch/x86/vcpu.c
@@ -202,7 +202,8 @@ bool vcpu_handle_io_access(void)
 	if (result == 0)
 		result = i8042_access_handler(io.port, io.in, io.size);
 
-	if (result == 1) {
+	/* Also ignore byte access to port 80, often used for delaying IO. */
+	if (result == 1 || (io.port == 0x80 && io.size == 1)) {
 		vcpu_skip_emulated_instruction(io.inst_len);
 		return true;
 	}
diff --git a/tools/root-cell-config.c.tmpl b/tools/root-cell-config.c.tmpl
index 100429f8..6412768d 100644
--- a/tools/root-cell-config.c.tmpl
+++ b/tools/root-cell-config.c.tmpl
@@ -161,9 +161,7 @@ struct {
 		[  0x60/8 ...   0x67/8] = 0xec, /* HACK: NMI status/control */
 		[  0x68/8 ...   0x6f/8] = -1,
 		[  0x70/8 ...   0x77/8] = 0xfc, /* RTC */
-		[  0x78/8 ...   0x7f/8] = -1,
-		[  0x80/8 ...   0x87/8] = 0xfe, /* Linux: native_io_delay() */
-		[  0x88/8 ...  0x3af/8] = -1,
+		[  0x78/8 ...  0x3af/8] = -1,
 		[ 0x3b0/8 ...  0x3df/8] = 0x00, /* VGA */
 		[ 0x3e0/8 ...  0xcff/8] = -1,
 		[ 0xd00/8 ... 0xffff/8] = 0, /* HACK: PCI bus */
